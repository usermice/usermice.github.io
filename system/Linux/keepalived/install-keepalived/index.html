<!doctype html><html lang=zh-CN data-theme=light><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=UTF-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: light)"><meta name=generator content="Hugo 0.125.4"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_16x16_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_32_32_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="Install Keepalived"><meta itemprop=description content="Install-Keepalived"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="http://localhost:1313/imgs/s2-1.jpg"><meta itemprop=keywords content="Keepalived"><meta property="og:type" content="article"><meta property="og:title" content="Install Keepalived"><meta property="og:description" content="Install-Keepalived"><meta property="og:image" content="/imgs/s2-1.jpg"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="http://localhost:1313/system/linux/keepalived/install-keepalived/"><meta property="og:site_name" content="二哥"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="二哥"><meta property="article:published_time" content="2022-07-14 18:13:51 +0800 CST"><meta property="article:modified_time" content="2022-11-15 18:13:51 +0800 CST"><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.css><link rel=stylesheet href=/css/main.css><style type=text/css>.post-footer,.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":true,"isHome":false,"isPage":true,"path":"install-keepalived","permalink":"http://localhost:1313/system/linux/keepalived/install-keepalived/","title":"Install Keepalived","waline":{"js":[{"alias":"waline","alias_name":"@waline/client","file":"dist/pageview.js","name":"pageview","version":"2.13.0"},{"alias":"waline","alias_name":"@waline/client","file":"dist/comment.js","name":"comment","version":"2.13.0"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>Install Keepalived - 二哥</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>二哥</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>Linux、Kubernetes、Docker、Python、CI/CD、Jenkins、Mysql、Nginx、Gitlab、Ansible、Zabbix</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-Home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-categories"><a href=/categories/ class=hvr-icon-pulse rel=section><i class="fa fa-th hvr-icon"></i>分类</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档
<span class=badge>0</span></a></li><li class="menu-item menu-item-tags"><a href=/tags/ class=hvr-icon-pulse rel=section><i class="fa fa-tags hvr-icon"></i>标签</a></li><li class="menu-item menu-item-tools"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-tools hvr-icon"></i>工具</a></li><li class="menu-item menu-item-flinks"><a href=/flinks.html class=hvr-icon-pulse rel=section><i class="fa fa-thumbs-up hvr-icon"></i>站点示例</a></li><li class="menu-item menu-item-about"><a href=/about.html class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-Commonweal"><a href=/404.html class=hvr-icon-pulse rel=section><i class="fa fa-heartbeat hvr-icon"></i>公益 404</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#keepalivedfont-colorred介绍font><code>Keepalived</code><font color=red>介绍</font></a><ul><li><a href=#keepalived简介><code>Keepalived</code>简介</a></li><li><a href=#keepalived服务的三个重要功能><code>Keepalived</code>服务的三个重要功能</a></li><li><a href=#vrrp原理介绍><code>VRRP</code>原理介绍</a></li><li><a href=#keepalived服务的工作原理><code>Keepalived</code>服务的工作原理</a></li></ul></li><li><a href=#keepalived-vipfont-colorred漂移实战font><code>Keepalived VIP</code><font color=red>漂移实战</font></a><ul><li><a href=#服务器规划>服务器规划</a></li><li><a href=#安装配置keepalived>安装、配置<code>Keepalived</code></a></li><li><a href=#keepalived服务器主备切换以及脑裂排查><code>Keepalived</code>服务器主备切换、以及脑裂排查</a><ul><li><a href=#font-colorred脑裂排查解决font><font color=red>脑裂排查解决</font></a></li><li><a href=#font-colorred进行高可用主备服务器切换实验font><font color=red>进行高可用主备服务器切换实验</font></a></li></ul></li></ul></li><li><a href=#font-colorred单实例主备模式fontkeepalivedfont-colorred配置文件对比font><font color=red>单实例主备模式</font><code>keepalived</code><font color=red>配置文件对比</font></a><ul><li><a href=#keepalived高可用服务器的裂脑问题><code>keepalived</code>高可用服务器的"&ldquo;裂脑问题&rdquo;</a></li><li><a href=#解决脑裂的常见方案>解决脑裂的常见方案</a></li></ul></li><li><a href=#keepalivedfont-colorred双实例双主模式配置font><code>keepalived</code><font color=red>双实例双主模式配置</font></a></li><li><a href=#nginxfont-colorred负载均衡配合fontkeepalivedfont-colorred服务案例实战font><code>nginx</code><font color=red>负载均衡配合</font><code>keepalived</code><font color=red>服务案例实战</font></a><ul><li><a href=#在keepalived-01和keepalived-02上配置nginx负载均衡>在<code>keepalived-01</code>和<code>keepalived-02</code>上配置<code>nginx</code>负载均衡</a></li><li><a href=#解决服务监听的网卡上不存在ip地址问题>解决服务监听的网卡上不存在<code>IP</code>地址问题</a></li><li><a href=#解决高可用服务只针对物理服务器的问题>解决高可用服务只针对物理服务器的问题</a></li><li><a href=#解决多组keepalived服务器在一个局域网的冲突问题>解决多组<code>keepalived</code>服务器在一个局域网的冲突问题</a></li></ul></li><li><a href=#font-colorred配置指定文件接收fontkeepalivedfont-colorred服务日记font><font color=red>配置指定文件接收</font><code>keepalived</code><font color=red>服务日记</font></a></li><li><a href=#font-colorred开发监控fontkeepalivedfont-colorred脑裂脚本font><font color=red>开发监控</font><code>Keepalived</code><font color=red>脑裂脚本</font></a></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=二哥 src=/imgs/img-lazy-loading.gif data-src=/imgs/s2-1.jpg><p class=site-author-name itemprop=name>二哥</p><div class=site-description itemprop=description>The man who has made up his mind to win will never say impossible – Napoleon Bonaparte</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>0</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>52</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>149</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=qq%e5%8f%b7 title="QQ → qq号" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-qq fa-fw hvr-icon"></i>
QQ
</a></span><span class=links-of-social-item><a href=https://www.zhihu.com/people/lisenhui title="知乎 → https://www.zhihu.com/people/lisenhui" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-book fa-fw hvr-icon"></i>
知乎
</a></span><span class=links-of-social-item><a href=qq@qq.com title="E-Mail → qq@qq.com" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-envelope fa-fw hvr-icon"></i>
E-Mail
</a></span><span class=links-of-social-item><a href=https://weibo.com/yourname title="Weibo → https://weibo.com/yourname" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-weibo fa-fw hvr-icon"></i>
Weibo
</a></span><span class=links-of-social-item><a href="https://www.youtube.com/watch?v=RgKAFK5djSk" title="Youtube → https://www.youtube.com/watch?v=RgKAFK5djSk" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-youtube fa-fw hvr-icon"></i>
Youtube
</a></span><span class=links-of-social-item><a href=https://github.com/elkan1788 title="Github → https://github.com/elkan1788" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Github</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=共享知识><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt=共享知识></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://gitee.com/hugo-next/hugo-theme-next title=https://gitee.com/hugo-next/hugo-theme-next target=_blank>Hugo-NexT</a></li><li class=links-of-blogroll-item><a href=https://lisenhui.cn title=https://lisenhui.cn target=_blank>凡梦星尘空间站</a></li></ul></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>网站资讯</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>已运行：</div><div class=item-count id=runTimes data-publishdate></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>总访客数：</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>页面浏览：</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>总字数：</div><div class=item-count id=wordsCount data-count></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>阅读约：</div><div class=item-count id=readTimes data-times></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>最后更新于：</div><div class=item-count id=last-push-date data-lastpushdate></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-comments class="button goto-comments" title=直达评论><i class="fas fa-comments"></i></div><div id=goto-gtranslate class=button title=多语言翻译><i class="fas fa-globe"></i></div><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a><a href=https://github.com/hugo-next rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg>
</a><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script><script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=http://localhost:1313/system/linux/keepalived/install-keepalived/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/s2-1.jpg"><meta itemprop=name content="二哥"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="二哥"><meta itemprop=description content="The man who has made up his mind to win will never say impossible – Napoleon Bonaparte"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="Install Keepalived"><meta itemprop=description content="Install-Keepalived"></span><header class=post-header><h1 class=post-title itemprop="name headline">Install Keepalived
<a href=https://github.com/user-name/repo-name/tree/branch-name/subdirectory-name/System/Linux/Keepalived/Install-Keepalived.md rel="noopener external nofollow noreferrer" target=_blank class="exturl post-edit-link" title=编辑><i class="fa fa-pen-nib"></i></a></h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2022-07-14 18:13:51 +0800 CST" itemprop="dateCreated datePublished" datetime="2022-07-14 18:13:51 +0800 CST">2022-07-14
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar-check"></i>
</span><span class=post-meta-item-text title=更新于>更新于：
</span><time title=修改时间：2022-11-15T18:13:51+08:00 itemprop=dateModified datetime=2022-11-15T18:13:51+08:00>2022-11-15</time>
</span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i>
</span><span class=post-meta-item-text title=分类于>分类于：
</span><span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/keepalived itemprop=url rel=index><span itemprop=name>Keepalived</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="far fa-file-word"></i>
</span><span class=post-meta-item-text>字数：</span>
<span>8297</span>
</span><span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="far fa-clock"></i>
</span><span class=post-meta-item-text>阅读：&ap;</span>
<span>17分钟</span>
</span><span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="far fa-eye"></i>
</span><span class=post-meta-item-text>浏览：
</span><span id=busuanzi_value_page_pv data-path=/system/linux/keepalived/install-keepalived/><i class="fa fa-sync fa-spin"></i>
</span></span><span class=post-meta-item title><span class=post-meta-item-icon><i class="far fa-comments"></i>
</span><span class=post-meta-item-text title=评论>评论：
</span><span id=comments-count class=waline-comment-count data-path=/system/linux/keepalived/install-keepalived/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class="post-body autonumber" itemprop=articleBody><h2 id=keepalivedfont-colorred介绍font><code>Keepalived</code><font color=red>介绍</font>
<a class=header-anchor href=#keepalivedfont-colorred%e4%bb%8b%e7%bb%8dfont></a></h2><blockquote><ul><li><ol><li><font color=red>标签： 高可用</font><code>vrrp</code></li></ol></li></ul></blockquote><h3 id=keepalived简介><code>Keepalived</code>简介
<a class=header-anchor href=#keepalived%e7%ae%80%e4%bb%8b></a></h3><div class="note info"><code>Keepalived</code>啥软件起初是准尉<code>LVS</code>负载软件设计的，用来管理并监控<code>LVS</code>集群系统中各个服务节点的装阿提，后来加入了高可用的<code>VRRP</code>功能。 <code>VRRP</code>是<code>Virtual Router Redundancy Protocol(虚拟路由器冗余协议)</code>的缩写，为解决静态路由器单点故障问题，确保个别节点宕机时，真哥哥网络可以不间断地运行。 <code>Keepalived</code>另一方面具有配置配置管理<code>LVS</code>的功能，同时还具有对<code>LVS</code>下面节进行健康检查的功能。</div><h3 id=keepalived服务的三个重要功能><code>Keepalived</code>服务的三个重要功能
<a class=header-anchor href=#keepalived%e6%9c%8d%e5%8a%a1%e7%9a%84%e4%b8%89%e4%b8%aa%e9%87%8d%e8%a6%81%e5%8a%9f%e8%83%bd></a></h3><div class="note info"><ul><li><ol><li><font color=red>管理</font><code>LVS</code><font color=red>负载均衡软件</font></li></ol></li></ul><blockquote><ul><li>1.1 <code>Keepalived</code>软件起初是为了解决<code>LVS</code>的问题而诞生的。因此，<code>Keepalived</code>和<code>LVS</code>的感情很深，向夫妻一样可以紧密结合，愉快地工作。 <code>Keepalived</code>通过读取配置文件，实现通过更底层的接口直接管理<code>LVS</code>及控制服务器的启动、停止等功能，使得<code>LVS</code>应用更加简单方便。</li></ul></blockquote><ul><li><ol start=2><li><font color=red>实现对</font><code>LVS</code><font color=red>集群健康检查的功能</font></li></ol></li></ul><blockquote><ul><li>2.1 <code>Keepalived</code>可以通过在自身的<code>keepalived.conf</code>文件里配置<code>LVS</code>的节点<code>IP</code>和相关参数实现对<code>LVS</code>的直接管理；当故障的节点服务器被修复以后，<code>Keepalived</code>服务又会自动地把它们加入到正常转发队列中，对客户提供服务。</li></ul></blockquote><ul><li><ol start=3><li><font color=red>作为系统网络服务的高可用</font></li></ol></li></ul><blockquote><ul><li>3.1 <code>Keepalived</code>可以实现任意两台主机之间，例如<code>Master</code>和<code>Backup</code>主机之间的故障转移和自动切换，这个主机可以是普通的不能停机的业务服务器，也可以是<code>LVS</code>负载均衡、<code>Nginx</code>反向代理这样的服务器。</li></ul></blockquote></div><h3 id=vrrp原理介绍><code>VRRP</code>原理介绍
<a class=header-anchor href=#vrrp%e5%8e%9f%e7%90%86%e4%bb%8b%e7%bb%8d></a></h3><div class="note info"><ul><li><ol><li><code>VRRP</code>，全称<code>Virtual Router Redundancy Protocol</code>中文名为虚拟路由冗余协议，<code>VRRP</code>的出现是为了解决静态路由的单</li></ol></li><li><ol start=2><li><code>VRRP</code>是通过一种竞选协议机制来将路由任务交给某台<code>VRRP</code>路由器的。</li></ol></li><li><ol start=3><li><code>VRRP</code>用<code>IP</code>多播的方式（默认多播地址（224.0.0.18））实现高可用对之间通信。</li></ol></li><li><ol start=4><li>工作时主节点发包，备节点接包，当备节点接收不到主节点发的数据包的时候，就启动接管程序接管主节点的资源。备节点可以有多个，通过优先级竞选，但一般<code>Keepalived</code>系统运维工作中都是一对。</li></ol></li><li><ol start=5><li><code>VRRP</code>使用了加密协议加密数据，但<code>Keepalived</code>官方目前还是推荐用明文的方式配置认证类型和密码。</li></ol></li></ul></div><h3 id=keepalived服务的工作原理><code>Keepalived</code>服务的工作原理
<a class=header-anchor href=#keepalived%e6%9c%8d%e5%8a%a1%e7%9a%84%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86></a></h3><div class="note info"><ul><li><ol><li><code>keepalived</code>通过<code>vrrp</code>通信，通过竞选确定主备，主优先级高于备。因此，工作时主会获得所有资源，备节点处于等待状态，当主节点宕机，那么备节点启用接管程序接管主节点资源，顶替主节点提供服务。</li></ol></li><li><ol start=2><li>在<code>Keepalived</code>服务对之间，只有作为主的服务器会一直发送<code>VRRP</code>广播包，告诉备它还活着，此时备不会抢占主，当主不可用时，即监听不到主发送的广播包时，就会启动相关服务接管资源，保证业务的连续性。接管速度最快可以小于1秒。</li></ol></li></ul><blockquote><ul><li>2.1 <code>VRRP</code>报文封装在<code>IP</code>报文中</li><li>2.2 只有一种报文，<code>VRRP</code>通告报文， 只有处于<code>master</code>状态下的路由器会发送，组播地址224.0.0.18</li><li>2.3 <code>VRID</code>虚拟路由器表示，拥有相同<code>VRID</code>的一组路由器构成一个虚拟路由器</li><li>2.4 一个虚拟路由器可以拥有一个或多个虚拟<code>IP</code>地址</li><li>2.5 虚拟<code>MAC</code>地址<code>00-00-5E-00-01（VRID）</code></li><li>2.6 分为抢占和不抢占</li><li>2.7 优先级高的成为<code>master</code>路由器，范围是0-255，0表示路由器放弃<code>master</code>状态，255表示虚拟<code>IP</code>地址实际拥有者。默认为100</li><li>2.8 <code>backup</code>路由器切换到<code>master</code>路由器的时间为<code>skew time=256-backup</code>路由器优先级/256</li><li>2.9 <code>master</code>失效，<code>backup</code>转换成<code>master</code>需要的时间为<code>3*V</code>隔<code>RRP</code>报文间<code>Skew tim</code></li></ul></blockquote></div><h2 id=keepalived-vipfont-colorred漂移实战font><code>Keepalived VIP</code><font color=red>漂移实战</font>
<a class=header-anchor href=#keepalived-vipfont-colorred%e6%bc%82%e7%a7%bb%e5%ae%9e%e6%88%98font></a></h2><h3 id=服务器规划>服务器规划
<a class=header-anchor href=#%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a7%84%e5%88%92></a></h3><div class="note info"><blockquote><table><thead><tr><th style=text-align:left>服务器</th><th style=text-align:left><code>ip</code></th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><code>keepalived-01</code></td><td style=text-align:left>10.0.0.7</td><td style=text-align:left><code>keepalived</code>主服务器</td></tr><tr><td style=text-align:left><code>keepalived-02</code></td><td style=text-align:left>10.0.0.8</td><td style=text-align:left><code>keepalived</code>备服务器</td></tr><tr><td style=text-align:left></td><td style=text-align:left>10.0.0.3</td><td style=text-align:left>VIP</td></tr></tbody></table></blockquote></div><h3 id=安装配置keepalived>安装、配置<code>Keepalived</code>
<a class=header-anchor href=#%e5%ae%89%e8%a3%85%e9%85%8d%e7%bd%aekeepalived></a></h3><div class="note info"><ul><li><ol><li><font color=red>两台服务器都安装</font><code>Keepalived</code></li></ol></li></ul><blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ yum install keepalived -y
</span></span></code></pre></div></blockquote><ul><li><ol start=2><li><font color=red>修改主服务器</font><code>Keepalived</code><font color=red>配置文件</font></li></ol></li></ul><blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ cat &gt;/etc/keepalived/keepalived.conf<span style=color:#e6db74>&lt;&lt;-EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>! Configuration File for keepalived
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>global_defs {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>	# 设置的邮件报警，这部分一般由nagios、zabbix监控软件来负责，这里的内容很鸡肋。
</span></span></span><span style=display:flex><span><span style=color:#e6db74>	notification_email {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>		31333741@qq.com
</span></span></span><span style=display:flex><span><span style=color:#e6db74>	}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>	
</span></span></span><span style=display:flex><span><span style=color:#e6db74>	notification_email_from  31333741@qq.com
</span></span></span><span style=display:flex><span><span style=color:#e6db74>	smtp_server 192.168.200.1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>	smtp_connect_timeout 30
</span></span></span><span style=display:flex><span><span style=color:#e6db74>	router_id LVS_lb01  	# 主节点id 不能和备节点重名
</span></span></span><span style=display:flex><span><span style=color:#e6db74>	vrrp_skip_check_adv_addr
</span></span></span><span style=display:flex><span><span style=color:#e6db74>	# 使用 unicast_src_ip 需要注释 vrrp_strict，也可以使用 ping 进行测试
</span></span></span><span style=display:flex><span><span style=color:#e6db74>	# vrrp_strict
</span></span></span><span style=display:flex><span><span style=color:#e6db74>	vrrp_garp_interval 0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>	vrrp_gna_interval 0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>	script_user root
</span></span></span><span style=display:flex><span><span style=color:#e6db74>	enable_script_security
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># 定义vrrp检测脚本，檢查nginx狀況
</span></span></span><span style=display:flex><span><span style=color:#e6db74>vrrp_script chk_nginx {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # 执行脚本，当nginx服务有问题的時候就停掉keepalived服务
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    script &#34;/opt/script/chk_nginx.sh&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # 间隔1秒
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    interval 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    weight 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># VRRP实例
</span></span></span><span style=display:flex><span><span style=color:#e6db74>vrrp_instance VI_1 {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # 指定keepalived的角色，MASTER表示此主機是主服務器，BACKUP表示主機為備用服務器
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    state MASTER
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # 设置的通信网卡名称 备节点设置一样
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    interface eth0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # 虚拟路由标志，支持一个数字，同一个vrrp实例使用唯一的标志
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # 同一個vrrp_instance底下，MASTER跟BACKUP必须一致
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    virtual_router_id 51
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # 定义优先级，数字越大，优先级越高(0-255)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    priority 150
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # 设定MASTER跟BACKUP之间同步检查的时间间隔，单位是秒。
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    advert_int 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # 如果节点之间禁用了群发的話，则采用vrrp单发通告的方式
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    unicast_src_ip 10.0.0.11
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    unicast_peer {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        10.0.0.12
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # 设置验证类型与密码
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    authentication {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        # 设置验证类型，主要有PASS跟HA两种
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        auth_type PASS
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        # 设置验证密码，在同一個vrrp_instance底下，MASTER跟BACKUP必须使用相同得密码才能正常沟通
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        auth_pass 1111
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # 设置虚拟IP地址，可以设置多個虚拟IP地址，每行设定一个
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    virtual_ipaddress {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        # 虚拟VIP的地址 与网卡标签
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        10.0.0.3/24 dev eth0 label eth0:1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    track_script {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        # 触发检查
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        chk_nginx
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div></blockquote><ul><li><ol start=3><li><font color=red>修改备用服务器</font><code>Keepalived</code><font color=red>配置文件</font></li></ol></li></ul><blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ cat &gt;/etc/keepalived/keepalived.conf<span style=color:#e6db74>&lt;&lt;-EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>! Configuration File for keepalived
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>global_defs {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # 设置的邮件报警，这部分一般由nagios、zabbix监控软件来负责，这里的内容很鸡肋。
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    notification_email {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        31333741@qq.com
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    } 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    notification_email_from  31333741@qq.com
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    smtp_server 192.168.200.1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    smtp_connect_timeout 30
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # 备节点id 不能和备节点重名
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    router_id LVS_lb02
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># VRRP实例
</span></span></span><span style=display:flex><span><span style=color:#e6db74>vrrp_instance VI_1 {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # 设置主服务器
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    state MASTER
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # 设置通信网卡  备节点设置一样
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    interface eth0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # 同组路由器属性
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    virtual_router_id 51
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # 优先级 这里必须比备节点高
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    priority 100
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # 每隔一秒发一次心跳
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    advert_int 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # 授权密码  
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    authentication {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        auth_type PASS
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        auth_pass 1111
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    virtual_ipaddress {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        # 虚拟VIP的地址 与网卡标签
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        10.0.0.3/24 dev eth0 label eth0:1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div></blockquote><ul><li><ol start=4><li><font color=red>启动主节点</font><code>keepalived</code><font color=red>服务并检查</font></li></ol></li></ul><blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ /etc/init.d/keepalived start
</span></span><span style=display:flex><span>正在启动 keepalived：            <span style=color:#f92672>[</span>确定<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@kepalived-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ps -ef|grep keep|grep -v grep</span>
</span></span><span style=display:flex><span>root       <span style=color:#ae81ff>7428</span>      <span style=color:#ae81ff>1</span>  <span style=color:#ae81ff>0</span> 10:54 ?        00:00:00 /usr/sbin/keepalived -D
</span></span><span style=display:flex><span>root       <span style=color:#ae81ff>7430</span>   <span style=color:#ae81ff>7428</span>  <span style=color:#ae81ff>0</span> 10:54 ?        00:00:00 /usr/sbin/keepalived -D
</span></span><span style=display:flex><span>root       <span style=color:#ae81ff>7431</span>   <span style=color:#ae81ff>7428</span>  <span style=color:#ae81ff>0</span> 10:54 ?        00:00:00 /usr/sbin/keepalived -D
</span></span></code></pre></div></blockquote><ul><li><ol start=5><li><font color=red>检查配置后的虚拟</font><code>IP</code></li></ol></li></ul><blockquote><ul><li>5.1 <font color=red>出现带有</font><code>vip：10.0.0.3</code><font color=red>行的结果表示</font><code>kepalived-01</code><font color=red>的</font><code>keepalived</code><font color=red>服务单实例配置成功</font></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ ip add|grep 10.0.0.3
</span></span><span style=display:flex><span>    inet 10.0.0.3/24 scope global secondary eth0:1
</span></span></code></pre></div></blockquote><ul><li><ol start=6><li><font color=red>启动备节点</font><code>keepalived</code><font color=red>服务</font></li></ol></li></ul><blockquote><ul><li>6.1 <font color=red>查看备用服务器是否有</font><code>IP</code><font color=red>没有返回任何结果就对</font></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-02 ~<span style=color:#f92672>]</span><span style=color:#75715e># /etc/init.d/keepalived start</span>
</span></span><span style=display:flex><span>正在启动 keepalived：  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-02 ~<span style=color:#f92672>]</span><span style=color:#75715e># ip add|grep 10.0.0.3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-02 ~<span style=color:#f92672>]</span><span style=color:#75715e># </span>
</span></span></code></pre></div></blockquote></div><h3 id=keepalived服务器主备切换以及脑裂排查><code>Keepalived</code>服务器主备切换、以及脑裂排查
<a class=header-anchor href=#keepalived%e6%9c%8d%e5%8a%a1%e5%99%a8%e4%b8%bb%e5%a4%87%e5%88%87%e6%8d%a2%e4%bb%a5%e5%8f%8a%e8%84%91%e8%a3%82%e6%8e%92%e6%9f%a5></a></h3><h4 id=font-colorred脑裂排查解决font><font color=red>脑裂排查解决</font>
<a class=header-anchor href=#font-colorred%e8%84%91%e8%a3%82%e6%8e%92%e6%9f%a5%e8%a7%a3%e5%86%b3font></a></h4><div class="note info"><ul><li><ol><li>出现上述无任何结果的现象，表示<code>keepalived-02</code>的<code>keepalived</code>服务单实例配置成功。如果<code>keepalived-02</code>配置过滤后出现<code>10.0.0.3</code>的<code>ip</code>。则表示<code>keepalived</code>工作不正常，同一个<code>IP</code>地址同一时刻应该只能出现一台服务器。</li></ol></li><li><ol start=2><li>如果查看<code>backup</code>备节点<code>vip</code>有如下信息，说明高可用脑裂了，裂脑是两台服务器争抢同一资源导致的，例如:两边都配置了同一个<code>ip</code>，一般要先考虑排查两个地方</li></ol></li></ul><blockquote><ul><li>2.1 <font color=red>主备两台服务器之间是否通信正常，如果不正常是否有</font><code>iptables</code><font color=red>防火墙阻挡</font></li><li>2.2 <font color=red>主备两台服务器对应的</font><code>keepalived.conf</code><font color=red>配置文件是否有错误？例如：是否同一实例的</font><code>virtual_router_id</code><font color=red>配置不一致</font></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-02 ~<span style=color:#f92672>]</span><span style=color:#75715e># ip add|grep 10.0.0.3</span>
</span></span><span style=display:flex><span>   inet 10.0.0.3/24 scope global secondary eth0:1
</span></span></code></pre></div></blockquote></div><h4 id=font-colorred进行高可用主备服务器切换实验font><font color=red>进行高可用主备服务器切换实验</font>
<a class=header-anchor href=#font-colorred%e8%bf%9b%e8%a1%8c%e9%ab%98%e5%8f%af%e7%94%a8%e4%b8%bb%e5%a4%87%e6%9c%8d%e5%8a%a1%e5%99%a8%e5%88%87%e6%8d%a2%e5%ae%9e%e9%aa%8cfont></a></h4><div class="note info"><ul><li><ol><li><font color=red>停掉主服务上的</font><code>keepalived</code><font color=red>服务或关闭主服务器，操作及检查步骤</font></li></ol></li></ul><blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ip add|grep 10.0.0.3</span>
</span></span><span style=display:flex><span>    inet 10.0.0.3/24 scope global secondary eth0:1
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># /etc/init.d/keepalived stop</span>
</span></span><span style=display:flex><span>停止 keepalived：                                          <span style=color:#f92672>[</span>确定<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ip add|grep 10.0.0.3  	# 查看vip消失</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-01 ~<span style=color:#f92672>]</span><span style=color:#75715e>#</span>
</span></span></code></pre></div></blockquote><ul><li><ol start=2><li><font color=red>可以看到</font><code>vip10.00.3</code><font color=red>消失了，此时查看</font><code>backup</code><font color=red>备份服务器，看是否会有</font><code>vip10.0.0.3</code><font color=red>出现</font></li></ol></li></ul><blockquote><ul><li>2.1 可以看到备节点<code>keepalived-02</code>已经接管绑定了<code>10.0.0.3</code>这个<code>vip</code>，这期间备节点还会发送<code>ARP</code>广播，让所有的客户端更新本地的<code>ARP</code>表，以便客户端访问新接管<code>vip</code>服务节点。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-02 ~<span style=color:#f92672>]</span><span style=color:#75715e># ip add|grep 10.0.0.3        </span>
</span></span><span style=display:flex><span>    inet 10.0.0.3/24 scope global secondary eth0:1
</span></span></code></pre></div></blockquote><ul><li><ol start=3><li><font color=red>此时如果在启动主服务器的<code>keepalived</code>服务，主服务器就会接管回<code>vip 10.0.0.3</code></li></ol></li></ul><blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ip add|grep 10.0.0.3       </span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># /etc/init.d/keepalived start</span>
</span></span><span style=display:flex><span>正在启动 keepalived：                                      <span style=color:#f92672>[</span>确定<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ip add|grep 10.0.0.3        </span>
</span></span><span style=display:flex><span>    inet 10.0.0.3/24 scope global secondary eth0:1
</span></span></code></pre></div></blockquote><ul><li><ol start=4><li><font color=red>此时备节点上的</font><code>vip 10.0.0.3</code><font color=red>则被释放了，如下</font></li></ol></li></ul><blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-02 ~<span style=color:#f92672>]</span><span style=color:#75715e># ip add|grep 10.0.0.3     </span>
</span></span></code></pre></div></blockquote><ul><li><ol start=5><li><font color=red>这样就实现了单实例</font><code>keepalived</code><font color=red>服务</font><code>IP</code><font color=red>自动漂移接管了，</font><code>vip</code><font color=red>漂移到了新机器新服务上，用户的访问请求自然就会找到新机器新服务了</font></li></ol></li></ul><blockquote><ul><li>5.1 <font color=red>注意：这里仅实现了</font><code>VIP</code><font color=red>自动漂移切换，因此仅适合两台服务器提供的服务均保持开启的应用场景，这也是工作中常用的高可用解决方案</font></li></ul></blockquote></div><h2 id=font-colorred单实例主备模式fontkeepalivedfont-colorred配置文件对比font><font color=red>单实例主备模式</font><code>keepalived</code><font color=red>配置文件对比</font>
<a class=header-anchor href=#font-colorred%e5%8d%95%e5%ae%9e%e4%be%8b%e4%b8%bb%e5%a4%87%e6%a8%a1%e5%bc%8ffontkeepalivedfont-colorred%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e5%af%b9%e6%af%94font></a></h2><div class="note info"><ul><li><ol><li>主备单实例<code>keepalived.conf</code>配置差别项</li></ol></li></ul><blockquote><table><thead><tr><th style=text-align:left><code>Keepalived</code>配置参数</th><th style=text-align:left><code>Master</code>节点特殊参数</th><th style=text-align:left><code>Backup</code>节点特殊参数</th></tr></thead><tbody><tr><td style=text-align:left><code>Router_id</code> (唯一标识)</td><td style=text-align:left><code>router_id lb01</code></td><td style=text-align:left><code>router_id lb02</code></td></tr><tr><td style=text-align:left><code>State</code>（角色状态）</td><td style=text-align:left><code>Stat master</code></td><td style=text-align:left><code>Stat backup</code></td></tr><tr><td style=text-align:left><code>Priority</code> （竞选优先级）</td><td style=text-align:left><code>Priority 150</code></td><td style=text-align:left><code>Priority 100</code></td></tr></tbody></table></blockquote></div><h3 id=keepalived高可用服务器的裂脑问题><code>keepalived</code>高可用服务器的"&ldquo;裂脑问题&rdquo;
<a class=header-anchor href=#keepalived%e9%ab%98%e5%8f%af%e7%94%a8%e6%9c%8d%e5%8a%a1%e5%99%a8%e7%9a%84%e8%a3%82%e8%84%91%e9%97%ae%e9%a2%98></a></h3><div class="note info"><ul><li><ol><li><font color=red>什么是裂脑</font></li></ol></li></ul><blockquote><ul><li>1.1 由于某些原因，导致两台高可用服务器对在指定时间内无法检测到对方的心跳消息。各自取得资源及服务的所有权，而此时的两台高可用服务器对都还活着并在正常运行着，这样就会导致同一个<code>ip</code>或服务在两端同时存在而发生冲突，最严重的是两台主机占用一个VIP地址，当用户写入数据时可能会分别写入到两端，这可能会导致服务器两端数据不一致或造成数据丢失，这种情况称为脑裂</li></ul></blockquote><ul><li><ol start=2><li><font color=red>导致脑裂发生的原因</font></li></ol></li></ul><blockquote><ul><li>2.1 一般来说，脑裂的发生，有以下几种原因： 高可用服务器之间心跳线路发生故障，导致无法正常通信</li></ul><blockquote><ul><li>2.1.1 <font color=red>心跳线坏了(包括断了，老化)</font></li><li>2.1.2 <font color=red>网卡及相关驱动坏了，</font><code>IP</code><font color=red>配置及冲突</font></li><li>2.1.3 <font color=red>心跳线连接的设备故障（网卡及交换机）</font></li><li>2.1.4 <font color=red>仲裁的机器出问题</font></li></ul></blockquote><ul><li>2.2 高可用服务器上开启了<code>iptableable</code>防火墙阻挡了心跳消息传输</li><li>2.3 高可用服务器上心跳网卡地址等信息配置不正确，导致发送心跳失败</li><li>2.4 其他服务器配置不当等原因，心跳广播冲突。软件<code>BUG</code>等</li></ul></blockquote><ul><li><ol start=3><li><font color=red>提示：</font><code>keepalived</code><font color=red>配置里同一</font><code>VRRP</code><font color=red>实例如果</font><code>virtual_router_id</code><font color=red>两端参数配置不一致，也会导致脑裂问题发生</font></li></ol></li></ul></div><h3 id=解决脑裂的常见方案>解决脑裂的常见方案
<a class=header-anchor href=#%e8%a7%a3%e5%86%b3%e8%84%91%e8%a3%82%e7%9a%84%e5%b8%b8%e8%a7%81%e6%96%b9%e6%a1%88></a></h3><div class="note info"><ul><li><ol><li><font color=red>同时使用串行电缆和以太网电缆连接，同时用两条心跳线路，这样一条线路坏了，另一条线路还是好的，依然能够传送心跳信息</font></li></ol></li><li><ol start=2><li><font color=red>当检测到脑裂时强行关闭一个心跳节点（这个功能需要特殊设备支持，如</font><code>Stonith、fence）</code><font color=red>。相当于节点信息接收不到心跳信息，通过单独的线路发送机关命令关闭主节点电源</font></li></ol></li><li><ol start=3><li><font color=red>做好裂脑的监控警报</font></li></ol></li></ul></div><h2 id=keepalivedfont-colorred双实例双主模式配置font><code>keepalived</code><font color=red>双实例双主模式配置</font>
<a class=header-anchor href=#keepalivedfont-colorred%e5%8f%8c%e5%ae%9e%e4%be%8b%e5%8f%8c%e4%b8%bb%e6%a8%a1%e5%bc%8f%e9%85%8d%e7%bd%aefont></a></h2><div class="note info"><ul><li><ol><li><code>keepalived</code><font color=red>双实例双主模式配置实战</font></li></ol></li></ul><blockquote><ul><li>1.1 <code>Keepalived</code>还支持多实例多业务双向主备模式，即<code>A</code>业务在<code>keepalived-01</code>上主模式是主模式，在<code>keepalived-02</code>上是备模式，而<code>B</code>业务在<code>keepalived-02</code>上是备模式，在<code>keepalived-02</code>上是主模式</li></ul></blockquote><ul><li><ol start=2><li><code>Keepalived</code><font color=red>双实例双主模式的</font><code>ip</code><font color=red>及</font><code>VIP</code><font color=red>规划</font></li></ol></li></ul><blockquote><table><thead><tr><th style=text-align:left><code>Hostname</code></th><th style=text-align:left><code>IP</code></th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><code>keepalived-01</code></td><td style=text-align:left>10.0.0.5</td><td style=text-align:left><code>VIP：10.0.0.3</code>（用于绑定<code>A</code>服务www.etiantian.org）</td></tr><tr><td style=text-align:left><code>keepalived-02</code></td><td style=text-align:left>10.0.0.4</td><td style=text-align:left><code>VIP：10.0.0.4</code>（用于绑定<code>B</code>服务<code>blog.etiantian.org</code>）</td></tr></tbody></table></blockquote><ul><li><ol start=3><li><font color=red>首先配置</font><code>keepalived-01</code> <code>10.0.0.5</code><font color=red>的</font><code>keepalived.conf</code><font color=red>，在单实例的基础上增加一个</font><code>VIP_instance VI_2</code><font color=red>步骤及内容如下</font></li></ol></li></ul><blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># cat &gt;/etc/keepalived/keepalived.conf&lt;&lt;-EOF</span>
</span></span><span style=display:flex><span>! Configuration File <span style=color:#66d9ef>for</span> keepalived
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>global_defs <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	notification_email <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		31333741@qq.com
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	notification_email_from  31333741@qq.com
</span></span><span style=display:flex><span>	smtp_server 127.0.0.1
</span></span><span style=display:flex><span>	smtp_connect_timeout <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>	router_id lb01
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># vrrp_script chk_nginx {</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#    script &#34;/root/chk_nginx.sh&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#    interval 1</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#    weight 1</span>
</span></span><span style=display:flex><span><span style=color:#75715e># }</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>vrrp_instance VI_1 <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    state MASTER
</span></span><span style=display:flex><span>    interface eth0
</span></span><span style=display:flex><span>    virtual_router_id <span style=color:#ae81ff>51</span>
</span></span><span style=display:flex><span>    priority <span style=color:#ae81ff>150</span>
</span></span><span style=display:flex><span>    advert_int <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    authentication <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        auth_type PASS
</span></span><span style=display:flex><span>        auth_pass <span style=color:#ae81ff>1111</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    virtual_ipaddress <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        10.0.0.3/24 dev eth0 label eth0:1  
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>vrrp_instance VI_2 <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    state BACKUP
</span></span><span style=display:flex><span>    interface eth0
</span></span><span style=display:flex><span>    virtual_router_id <span style=color:#ae81ff>52</span>
</span></span><span style=display:flex><span>    priority <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>    advert_int <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    authentication <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        auth_type PASS
</span></span><span style=display:flex><span>        auth_pass <span style=color:#ae81ff>1112</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    virtual_ipaddress <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        10.0.0.4/24 dev eth0 label eth0:2
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>EOF
</span></span></code></pre></div></blockquote><ul><li><ol start=4><li><font color=red>提示：以</font><code>vrrp_instance VI_1</code><font color=red>在</font><code>keepalived-01 10.0.0.5</code><font color=red>服务器上的角色为主，</font><code>vrrp_instance VI_2</code><font color=red>在</font><code>keepalived-01 10.0.0.5</code><font color=red>服务器上的角色为备 然后布置</font><code>keepalived-02 10.0.0.6</code><font color=red>的</font><code>keepalived.conf</code><font color=red>，在单实例的基础上增加</font><code>vrrp_instance VI_2</code><font color=red>实例，步骤如下</font></li></ol></li></ul><blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-02 ~<span style=color:#f92672>]</span><span style=color:#75715e># cat &gt;/etc/keepalived/keepalived.conf&lt;&lt;-EOF</span>
</span></span><span style=display:flex><span>! Configuration File <span style=color:#66d9ef>for</span> keepalived
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>global_defs <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>       notification_email <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>           31333741@qq.com
</span></span><span style=display:flex><span>       <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>       notification_email_from  31333741@qq.com
</span></span><span style=display:flex><span>       smtp_server 127.0.0.1
</span></span><span style=display:flex><span>       smtp_connect_timeout <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>       router_id lb02
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>vrrp_instance VI_1 <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    state BACKUP
</span></span><span style=display:flex><span>    interface eth0
</span></span><span style=display:flex><span>    virtual_router_id <span style=color:#ae81ff>51</span>
</span></span><span style=display:flex><span>    priority <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>    advert_int <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    authentication <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        auth_type PASS
</span></span><span style=display:flex><span>        auth_pass <span style=color:#ae81ff>1111</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    virtual_ipaddress <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>     10.0.0.3/24 dev eth0 label eth0:1  
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>vrrp_instance VI_2 <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    state MASTER
</span></span><span style=display:flex><span>    interface eth0
</span></span><span style=display:flex><span>    virtual_router_id <span style=color:#ae81ff>52</span>
</span></span><span style=display:flex><span>    priority <span style=color:#ae81ff>150</span>
</span></span><span style=display:flex><span>    advert_int <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    authentication <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        auth_type PASS
</span></span><span style=display:flex><span>        auth_pass <span style=color:#ae81ff>1112</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    virtual_ipaddress <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>     10.0.0.4/24 dev eth0 label eth0:2
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>EOF
</span></span></code></pre></div></blockquote><ul><li><ol start=5><li><font color=red>提示：以</font><code>vrrp_instance VI_1</code>在<code>keepalived-02 10.0.0.6</code><font color=red>服务器上的角色为备，</font><code>vrrp_instance VI_2</code>在<code>keepalived-02 10.0.0.6</code><font color=red>服务器上的角色为主 接着在</font><code>keepalived-01</code>、<code>keepalived-02</code><font color=red>上分别重启</font><code>keepalived</code><font color=red>服务，观察初始</font><code>VIP</code><font color=red>设置情况</font><code> Lb01</code><font color=red>操作情况如下</font></li></ol></li></ul><blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># /etc/init.d/keepalived restart</span>
</span></span><span style=display:flex><span>停止 keepalived：                                        <span style=color:#f92672>[</span>确定<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>正在启动 keepalived：                                    <span style=color:#f92672>[</span>确定<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ip add|grep -E &#34;10.0.0.3|0.4&#34;</span>
</span></span><span style=display:flex><span>    inet 10.0.0.3/24 scope global secondary eth0:1
</span></span><span style=display:flex><span>    inet 10.0.0.4/24 scope global secondary eth0:2
</span></span></code></pre></div></blockquote><ul><li><ol start=6><li><font color=red>提示：启动</font><code>keepalived-02</code><font color=red>后，初始状态已经启动了</font><code>10.0.0.4VIP</code>，即<code>keepalived-02</code>由<code>VI_2</code><font color=red>实例配置的</font><code>VIP</code><font color=red>对外提供服务，列入可以把</font><code>blog.etiantian.org</code><font color=red>解析到</font><code>10.0.0.4</code><font color=red>上 下面停掉任意一端服务器或者</font><code>keepalived</code><font color=red>服务，然后查看</font><code>vip</code><font color=red>是不是会漂移到另一端。停掉</font><code>keepalived-01</code>的<code>keepalived</code></li></ol></li></ul><blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># /etc/init.d/keepalived stop</span>
</span></span><span style=display:flex><span>停止 keepalived：                                        <span style=color:#f92672>[</span>确定<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ip add|grep -E &#34;10.0.0.3|0.4&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># # 此处无任何信息</span>
</span></span></code></pre></div></blockquote><ul><li><ol start=7><li><font color=red>停掉</font><code>keepalived-01</code><font color=red>后，</font><code>vip 10.0.0.3</code><font color=red>即被释放,检查</font><code>keepalived-02</code>服务器上<code>vip</code><font color=red>的接管情况</font></li></ol></li></ul><blockquote><ul><li>7.1<code>keepalived-02</code>已将接管了<code>keepalived-01</code>的<code>vip 10.0.0.3</code></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-02 ~<span style=color:#f92672>]</span><span style=color:#75715e># ip add|grep -E &#34;10.0.0.3|0.4&#34;</span>
</span></span><span style=display:flex><span>    inet 10.0.0.4/24 scope global secondary eth0:2
</span></span><span style=display:flex><span>    inet 10.0.0.3/24 scope global secondary eth0:1
</span></span></code></pre></div></blockquote></div><h2 id=nginxfont-colorred负载均衡配合fontkeepalivedfont-colorred服务案例实战font><code>nginx</code><font color=red>负载均衡配合</font><code>keepalived</code><font color=red>服务案例实战</font>
<a class=header-anchor href=#nginxfont-colorred%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%e9%85%8d%e5%90%88fontkeepalivedfont-colorred%e6%9c%8d%e5%8a%a1%e6%a1%88%e4%be%8b%e5%ae%9e%e6%88%98font></a></h2><h3 id=在keepalived-01和keepalived-02上配置nginx负载均衡>在<code>keepalived-01</code>和<code>keepalived-02</code>上配置<code>nginx</code>负载均衡
<a class=header-anchor href=#%e5%9c%a8keepalived-01%e5%92%8ckeepalived-02%e4%b8%8a%e9%85%8d%e7%bd%aenginx%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1></a></h3><div class="note info"><ul><li><ol><li>结合<code>nginx</code>负载均衡的环境，两边<code>keepalived-01</code>和<code>keepalived-02</code>的配置环境一样 <strong>这里使用<code>nginx</code>负载均衡的配置如下：</strong></li></ol></li></ul><blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@@keepalived-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># cat &gt;/usr/local/nginx/conf/nginx.conf&lt;&lt;-EOF</span>
</span></span><span style=display:flex><span>worker_processes  1;
</span></span><span style=display:flex><span>events <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    worker_connections  1024;
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>http <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    include       mime.types;
</span></span><span style=display:flex><span>    default_type  application/octet-stream;
</span></span><span style=display:flex><span>    sendfile        on;
</span></span><span style=display:flex><span>    keepalive_timeout  65;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    upstream server_pools <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>         server 10.0.0.7:80  weight<span style=color:#f92672>=</span>1;
</span></span><span style=display:flex><span>         server 10.0.0.8:80  weight<span style=color:#f92672>=</span>1;
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        listen       10.0.0.3:80;
</span></span><span style=display:flex><span>        server_name  www.etiantian.org;
</span></span><span style=display:flex><span>        location / <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            proxy_pass http://server_pools;
</span></span><span style=display:flex><span>        include proxy.conf;
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        listen       10.0.0.3:80;
</span></span><span style=display:flex><span>        server_name  bbs.etiantian.org;
</span></span><span style=display:flex><span>        location / <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            proxy_pass http://server_pools;
</span></span><span style=display:flex><span>         include proxy.conf;
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        listen       10.0.0.4:80;
</span></span><span style=display:flex><span>        server_name  blog.etiantian.org;
</span></span><span style=display:flex><span>        location / <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            proxy_pass http://server_pools;
</span></span><span style=display:flex><span>           include proxy.conf;
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>EOF
</span></span></code></pre></div></blockquote><ul><li><ol start=2><li><code>keepalived-01</code><font color=red>上配置</font><code>keepalived.conf</code><font color=red>配置文件</font></li></ol></li></ul><blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># cat &gt;/etc/keepalived/keepalived.conf&lt;&lt;-EOF</span>
</span></span><span style=display:flex><span>! Configuration File <span style=color:#66d9ef>for</span> keepalived
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>global_defs <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   notification_email <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   31333741@qq.com
</span></span><span style=display:flex><span>   <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>   notification_email_from  31333741@qq.com
</span></span><span style=display:flex><span>   smtp_server 127.0.0.1
</span></span><span style=display:flex><span>   smtp_connect_timeout <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>   router_id lb01
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>vrrp_instance VI_1 <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    state MASTER
</span></span><span style=display:flex><span>    interface eth0
</span></span><span style=display:flex><span>    virtual_router_id <span style=color:#ae81ff>51</span>
</span></span><span style=display:flex><span>    priority <span style=color:#ae81ff>150</span>
</span></span><span style=display:flex><span>    advert_int <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    authentication <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        auth_type PASS
</span></span><span style=display:flex><span>        auth_pass <span style=color:#ae81ff>1111</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    virtual_ipaddress <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>     10.0.0.3/24 dev eth0 label eth0:1  
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>vrrp_instance VI_2 <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    state BACKUP
</span></span><span style=display:flex><span>    interface eth0
</span></span><span style=display:flex><span>    virtual_router_id <span style=color:#ae81ff>52</span>
</span></span><span style=display:flex><span>    priority <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>    advert_int <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    authentication <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        auth_type PASS
</span></span><span style=display:flex><span>        auth_pass <span style=color:#ae81ff>1112</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    virtual_ipaddress <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>     10.0.0.4/24 dev eth0 label eth0:2
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>EOF
</span></span></code></pre></div></blockquote><ul><li><ol start=3><li><code>keepalived-02</code><font color=red>上配置</font><code>keepalived.conf</code><font color=red>配置文件</font></li></ol></li></ul><blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-02 ~<span style=color:#f92672>]</span><span style=color:#75715e># cat &gt;/etc/keepalived/keepalived.conf&lt;&lt;-EOF</span>
</span></span><span style=display:flex><span>! Configuration File <span style=color:#66d9ef>for</span> keepalived
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>global_defs <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   notification_email <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   31333741@qq.com
</span></span><span style=display:flex><span>   <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>   notification_email_from  31333741@qq.com
</span></span><span style=display:flex><span>   smtp_server 127.0.0.1
</span></span><span style=display:flex><span>   smtp_connect_timeout <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>   router_id lb02
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>vrrp_instance VI_1 <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    state BACKUP
</span></span><span style=display:flex><span>    interface eth0
</span></span><span style=display:flex><span>    virtual_router_id <span style=color:#ae81ff>51</span>
</span></span><span style=display:flex><span>    priority <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>    advert_int <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    authentication <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        auth_type PASS
</span></span><span style=display:flex><span>        auth_pass <span style=color:#ae81ff>1111</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    virtual_ipaddress <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>     10.0.0.3/24 dev eth0 label eth0:1  
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>vrrp_instance VI_2 <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    state MASTER
</span></span><span style=display:flex><span>    interface eth0
</span></span><span style=display:flex><span>    virtual_router_id <span style=color:#ae81ff>52</span>
</span></span><span style=display:flex><span>    priority <span style=color:#ae81ff>150</span>
</span></span><span style=display:flex><span>    advert_int <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    authentication <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        auth_type PASS
</span></span><span style=display:flex><span>        auth_pass <span style=color:#ae81ff>1112</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    virtual_ipaddress <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>     10.0.0.4/24 dev eth0 label eth0:2
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>EOF
</span></span></code></pre></div></blockquote></div><h3 id=解决服务监听的网卡上不存在ip地址问题>解决服务监听的网卡上不存在<code>IP</code>地址问题
<a class=header-anchor href=#%e8%a7%a3%e5%86%b3%e6%9c%8d%e5%8a%a1%e7%9b%91%e5%90%ac%e7%9a%84%e7%bd%91%e5%8d%a1%e4%b8%8a%e4%b8%8d%e5%ad%98%e5%9c%a8ip%e5%9c%b0%e5%9d%80%e9%97%ae%e9%a2%98></a></h3><div class="note info"><ul><li><ol><li>如果配置使用<code>listen 10.0.0.3:80</code> 的方式指定<code>IP</code>监听服务，而本地的网卡上没有<code>10.0.0.3</code>这个<code>IP，nginx</code>就会报错，如：出现上述的原因是在物理网卡上没有配置与文件里监听的<code>IP</code>相对应的<code>IP</code>，解决办法是在<code>/etc/sysctl.conf</code>中加入如下参数：</li></ol></li><li><ol start=2><li>此项表示启动<code>nginx</code>而忽视配置中监听的VIP是否存在，它同样适合<code>Haproxy</code></li></ol></li></ul><blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-02 ~<span style=color:#f92672>]</span><span style=color:#75715e># echo &#34;net.ipv4.ip_nonlocal_bind = 1&#34; &gt;&gt;/etc/sysctl.conf</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-02 ~<span style=color:#f92672>]</span><span style=color:#75715e># sysctl -p</span>
</span></span></code></pre></div></blockquote></div><h3 id=解决高可用服务只针对物理服务器的问题>解决高可用服务只针对物理服务器的问题
<a class=header-anchor href=#%e8%a7%a3%e5%86%b3%e9%ab%98%e5%8f%af%e7%94%a8%e6%9c%8d%e5%8a%a1%e5%8f%aa%e9%92%88%e5%af%b9%e7%89%a9%e7%90%86%e6%9c%8d%e5%8a%a1%e5%99%a8%e7%9a%84%e9%97%ae%e9%a2%98></a></h3><div class="note info"><ul><li><ol><li>默认情况下<code>keepalived</code>软件仅仅在对方机器宕机或<code>keepalived</code>停掉的时候才会接管业务，但在实际过程中，有业务服务停止而<code>keepalived</code>服务还在工作的情况，这就会导致用户访问<code>VIP</code>无法找到对应的服务</li></ol></li><li><ol start=2><li><font color=red>方法一：</font>可以写守护进程脚本来处理。当<code>nginx</code>业务有问题时，就停掉本地的<code>keepalived</code>服务，实现<code>IP</code>漂移到对端继续提供服务。实际工作中部署及开发的示例脚本</li></ol></li></ul><blockquote><ul><li>2.1 <font color=red>此脚本的思路是如没有</font><code>80</code><font color=red>端口存在，就停掉</font><code>keepalived</code><font color=red>服务实现释放本地的</font><code>VIP</code><font color=red>在后台执行上述脚本</font></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># cat &gt;/server/scripts/check_nginx.sh&lt;&lt;-EOF</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#!/bin/sh</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> true
</span></span><span style=display:flex><span><span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>`</span>netstat -lntup|grep nginx|wc -l<span style=color:#e6db74>`</span> -eq <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span>;<span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    /etc/init.d/keepalived stop
</span></span><span style=display:flex><span> <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>  sleep <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>EOF
</span></span><span style=display:flex><span>$ sh server/scripts/check_nginx.sh &amp;
</span></span><span style=display:flex><span>$ ps -ef|grep check|grep -v grep
</span></span><span style=display:flex><span>root       <span style=color:#ae81ff>8580</span>   <span style=color:#ae81ff>8394</span>  <span style=color:#ae81ff>0</span> 16:19 pts/0    00:00:00 sh check_nginx.s
</span></span></code></pre></div><ul><li>2.2 <font color=red>确定</font><code>nginx</code><font color=red>以及</font><code>keepalived</code><font color=red>服务是否正常</font></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># netstat -lntup|grep nginx</span>
</span></span><span style=display:flex><span>tcp        <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> 10.0.0.4:80                 0.0.0.0:*                   LISTEN      8541/nginx          
</span></span><span style=display:flex><span>tcp        <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> 10.0.0.3:80                 0.0.0.0:*                   LISTEN      8541/nginx          
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># /etc/init.d/keepalived status</span>
</span></span><span style=display:flex><span>keepalived <span style=color:#f92672>(</span>pid  8438<span style=color:#f92672>)</span> 正在运行...
</span></span></code></pre></div><ul><li>2.3 <font color=red>然后模拟</font><code>nginx</code><font color=red>服务挂掉，看</font><code>IP</code><font color=red>是否会发生切换</font></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># /usr/local/nginx/sbin/nginx -s stop</span>
</span></span><span style=display:flex><span> 停止 keepalived：       <span style=color:#f92672>[</span>确定<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@@keepalived-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># /etc/init.d/keepalived status</span>
</span></span><span style=display:flex><span>keepalived       已停
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># netstat -lntup|grep nginx            </span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-01 ~<span style=color:#f92672>]</span><span style=color:#75715e>#</span>
</span></span></code></pre></div><ul><li>2.4 <font color=red>此时备节点接管</font></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-02 ~<span style=color:#f92672>]</span><span style=color:#75715e># ip add|grep -E &#34;10.0.0.3|0.4&#34;</span>
</span></span><span style=display:flex><span>    inet 10.0.0.3/24 scope global secondary eth0:1
</span></span><span style=display:flex><span>    inet 10.0.0.4/24 scope global secondary eth0:2
</span></span></code></pre></div></blockquote><ul><li><ol start=3><li><font color=red>方法二：</font>可以使用<code>keepalived</code>的配置脚本参数触发写好的监测服务脚本 首先要开发监测服务脚本，注意:这个脚本与上一个的不同</li></ol></li></ul><blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># cat &gt;/server/scripts/chk_nginx_proxy.sh&lt;&lt;-EOF</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#!/bin/sh</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>`</span>netstat -lntup|grep nginx|wc -l<span style=color:#e6db74>`</span> -eq <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span>;<span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    /etc/init.d/keepalived stop
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>EOF
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># chmod +x /server/scripts/chk_nginx_proxy.sh </span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ll /server/scripts/chk_nginx_proxy.sh </span>
</span></span><span style=display:flex><span>-rwxr-xr-x <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>99</span> 6月  <span style=color:#ae81ff>10</span> 16:30 chk_nginx_proxy.sh
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-01 ~<span style=color:#f92672>]</span><span style=color:#75715e>#</span>
</span></span></code></pre></div><ul><li>3.1 <font color=red>此时</font><code>keepalived</code><font color=red>服务的完整配置为</font></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># cat &gt;/etc/keepalived/keepalived.conf&lt;&lt;-EOF</span>
</span></span><span style=display:flex><span>! Configuration File <span style=color:#66d9ef>for</span> keepalived
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>global_defs <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   notification_email <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   31333741@qq.com
</span></span><span style=display:flex><span>   <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>   notification_email_from  31333741@qq.com
</span></span><span style=display:flex><span>   smtp_server 127.0.0.1
</span></span><span style=display:flex><span>   smtp_connect_timeout <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>   router_id lb01
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>vrrp_script chk_nginx_proxy <span style=color:#f92672>{</span>  	<span style=color:#75715e># 定义vrrp脚本，检测HTTP端口。</span>
</span></span><span style=display:flex><span>script <span style=color:#e6db74>&#34;/server/scripts/chk_nginx_proxy.sh&#34;</span>  	<span style=color:#75715e># 执行脚本，当nginx服务有问题，就停掉keepalived服务。</span>
</span></span><span style=display:flex><span>interval <span style=color:#ae81ff>2</span>  	<span style=color:#75715e># 间隔2秒</span>
</span></span><span style=display:flex><span>weight <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>vrrp_instance VI_1 <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    state MASTER
</span></span><span style=display:flex><span>    interface eth0
</span></span><span style=display:flex><span>    virtual_router_id <span style=color:#ae81ff>51</span>
</span></span><span style=display:flex><span>    priority <span style=color:#ae81ff>150</span>
</span></span><span style=display:flex><span>    advert_int <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    authentication <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        auth_type PASS
</span></span><span style=display:flex><span>        auth_pass <span style=color:#ae81ff>1111</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    virtual_ipaddress <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>     10.0.0.3/24 dev eth0 label eth0:1  
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>     track_script <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    chk_nginx_proxy        <span style=color:#75715e>#触发检查</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>vrrp_instance VI_2 <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    state BACKUP
</span></span><span style=display:flex><span>    interface eth0
</span></span><span style=display:flex><span>    virtual_router_id <span style=color:#ae81ff>52</span>
</span></span><span style=display:flex><span>    priority <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>    advert_int <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    authentication <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        auth_type PASS
</span></span><span style=display:flex><span>        auth_pass <span style=color:#ae81ff>1112</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    virtual_ipaddress <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>     10.0.0.4/24 dev eth0 label eth0:2
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>EOF
</span></span></code></pre></div><ul><li>3.2 <font color=red>注意：</font></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>vrrp_script chk_nginx_proxy <span style=color:#f92672>{</span>  <span style=color:#75715e># &lt;==定义vrrp脚本，检测HTTP端口。</span>
</span></span><span style=display:flex><span>script <span style=color:#e6db74>&#34;/server/scripts/chk_nginx_proxy.sh&#34;</span>  <span style=color:#75715e># &lt;==执行脚本，当nginx服务有问题，就停掉keepalived服务。</span>
</span></span><span style=display:flex><span>interval <span style=color:#ae81ff>2</span> <span style=color:#75715e># &lt;==间隔2秒</span>
</span></span><span style=display:flex><span>weight <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div></blockquote></div><h3 id=解决多组keepalived服务器在一个局域网的冲突问题>解决多组<code>keepalived</code>服务器在一个局域网的冲突问题
<a class=header-anchor href=#%e8%a7%a3%e5%86%b3%e5%a4%9a%e7%bb%84keepalived%e6%9c%8d%e5%8a%a1%e5%99%a8%e5%9c%a8%e4%b8%80%e4%b8%aa%e5%b1%80%e5%9f%9f%e7%bd%91%e7%9a%84%e5%86%b2%e7%aa%81%e9%97%ae%e9%a2%98></a></h3><div class="note info"><ul><li><ol><li><font color=red>可以在同组的</font><code>keepalived</code><font color=red>服务器所有配置文件里指定独一无二的多播地址</font></li></ol></li><li><ol start=2><li><font color=red>不同实例的认证密码最好不同</font></li></ol></li></ul><blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>global_defs <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   router_id LVS_19
</span></span><span style=display:flex><span>   vrrp_mcast_group4 224.0.0.19 <span style=color:#75715e># &lt;==这个就是指定多播地址的配置</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div></blockquote></div><h2 id=font-colorred配置指定文件接收fontkeepalivedfont-colorred服务日记font><font color=red>配置指定文件接收</font><code>keepalived</code><font color=red>服务日记</font>
<a class=header-anchor href=#font-colorred%e9%85%8d%e7%bd%ae%e6%8c%87%e5%ae%9a%e6%96%87%e4%bb%b6%e6%8e%a5%e6%94%b6fontkeepalivedfont-colorred%e6%9c%8d%e5%8a%a1%e6%97%a5%e8%ae%b0font></a></h2><div class="note info"><ul><li><ol><li>默认情况下<code>keepalived</code>服务日记会输出到系统日记<code>/var/log/messages</code>和其他日记信息会混合在一起，很不方便，可以将其调整为由独立的文件记录<code>keepalived</code>服务日记;操作步骤如下</li></ol></li><li><ol start=2><li>编辑配置文件<code>/etc/sysconfig/keepalived</code>，将第14行的<code>KEEPALIVED_OPTIONS="-D"</code>修改为<code>KEEPALIVED_OPTIONS="-D -d -S 0"</code>快速修改方法：</li></ol></li></ul><blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># sed -i &#39;14 s#KEEPALIVED_OPTIONS=&#34;-D&#34;#KEEPALIVED_OPTIONS=&#34;-D -d -S 0&#34;#g&#39; /etc/sysconfig/keepalived </span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># sed -n &#39;14p&#39;  /etc/sysconfig/keepalived</span>
</span></span><span style=display:flex><span>KEEPALIVED_OPTIONS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;-D -d -S 0&#34;</span>
</span></span></code></pre></div><ul><li>2.1 <font color=red>说明：可以查看</font><code>/etc/sysconfig/keepalived</code><font color=red>里注释获得上述参数的说明</font></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># --dump-conf       -d     导出备份配置数据</span>
</span></span><span style=display:flex><span><span style=color:#75715e># --log-detail      -D     详细日志</span>
</span></span><span style=display:flex><span><span style=color:#75715e># --log-facility    -S     设置本地的syslog设备，编号0-7（default=LOG_DAEMON）</span>
</span></span><span style=display:flex><span>* -S <span style=color:#ae81ff>0</span> 表示指定为local0设备
</span></span></code></pre></div></blockquote><ul><li><ol start=3><li><font color=red>修改</font><code>rsyslog</code><font color=red>的配置文件</font><code>vim /etc/rsyslog.conf</code><font color=red>，在结尾处加入如下2行内容：</font></li></ol></li></ul><blockquote><ul><li>3.1 配置表示来自<code>local0设</code>备的所有日志信息都记录到<code>/var/log/keepalived.log</code>文件。 然后在约第42行如下信息的第一列结尾加入<code>“；local0.none”：</code></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># keepalived</span>
</span></span><span style=display:flex><span>local0.*  /var/log/keepalived.log
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置表示来自local0设备的所有日志信息不再记录于/var/log/messages里。 3 配置完成后，重启rsyslog服务。</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># sed -i &#39;42 s#*.info;mail.none;authpriv.none;cron.none#*.info;mail.none;authpriv.none;cron.none;local0.none#g&#39; /etc/rsyslog.conf </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># sed -n &#39;42p&#39; /etc/rsyslog.conf </span>
</span></span><span style=display:flex><span>*.info;mail.none;authpriv.none;cron.none;local0.none                /var/log/messages
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># /etc/init.d/rsyslog restart</span>
</span></span><span style=display:flex><span>关闭系统日志记录器：     <span style=color:#f92672>[</span>确定<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>启动系统日志记录器：            <span style=color:#f92672>[</span>确定<span style=color:#f92672>]</span>
</span></span></code></pre></div></blockquote><ul><li><ol start=4><li><font color=red>测试</font><code>Keepalived</code><font color=red>日志记录结果。在重启</font><code>Keepalived</code><font color=red>服务后，就会把日志信息输出到</font><code>rsyslog</code><font color=red>定义的</font><code>/var/log/ keepalived.log</code><font color=red>文件</font></li></ol></li></ul><blockquote><ul><li>4.1 如果要求更高，还可以在<code>/var/log/messages</code>上设置对<code>/var/log/keepalived.log</code>进行轮询，以防单个日志文件变得太大</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>Jun <span style=color:#ae81ff>10</span> 22:38:03 lb01 Keepalived<span style=color:#f92672>[</span>10852<span style=color:#f92672>]</span>: Stopping Keepalived v1.2.13 <span style=color:#f92672>(</span>03/19,2015<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Jun <span style=color:#ae81ff>10</span> 22:38:03 lb01 Keepalived_vrrp<span style=color:#f92672>[</span>10855<span style=color:#f92672>]</span>: VRRP_Instance<span style=color:#f92672>(</span>VI_1<span style=color:#f92672>)</span> sending <span style=color:#ae81ff>0</span> priority
</span></span><span style=display:flex><span>Jun <span style=color:#ae81ff>10</span> 22:38:03 lb01 Keepalived_vrrp<span style=color:#f92672>[</span>10855<span style=color:#f92672>]</span>: VRRP_Instance<span style=color:#f92672>(</span>VI_1<span style=color:#f92672>)</span> removing protocol VIPs.
</span></span><span style=display:flex><span>Jun <span style=color:#ae81ff>10</span> 22:38:03 lb01 Keepalived_vrrp<span style=color:#f92672>[</span>10855<span style=color:#f92672>]</span>: VRRP_Instance<span style=color:#f92672>(</span>VI_2<span style=color:#f92672>)</span> sending <span style=color:#ae81ff>0</span> priority
</span></span><span style=display:flex><span>Jun <span style=color:#ae81ff>10</span> 22:38:03 lb01 Keepalived_vrrp<span style=color:#f92672>[</span>10855<span style=color:#f92672>]</span>: VRRP_Instance<span style=color:#f92672>(</span>VI_2<span style=color:#f92672>)</span> removing protocol VIPs.
</span></span><span style=display:flex><span>Jun <span style=color:#ae81ff>10</span> 22:38:03 lb01 Keepalived_healthcheckers<span style=color:#f92672>[</span>10854<span style=color:#f92672>]</span>: Netlink reflector reports IP 10.0.0.3 removed
</span></span><span style=display:flex><span>Jun <span style=color:#ae81ff>10</span> 22:38:03 lb01 Keepalived_healthcheckers<span style=color:#f92672>[</span>10854<span style=color:#f92672>]</span>: Netlink reflector reports IP 10.0.0.4 removed
</span></span><span style=display:flex><span>Jun <span style=color:#ae81ff>10</span> 22:38:03 lb01 Keepalived<span style=color:#f92672>[</span>10884<span style=color:#f92672>]</span>: Starting Keepalived v1.2.13 <span style=color:#f92672>(</span>03/19,2015<span style=color:#f92672>)</span>
</span></span></code></pre></div></blockquote></div><h2 id=font-colorred开发监控fontkeepalivedfont-colorred脑裂脚本font><font color=red>开发监控</font><code>Keepalived</code><font color=red>脑裂脚本</font>
<a class=header-anchor href=#font-colorred%e5%bc%80%e5%8f%91%e7%9b%91%e6%8e%a7fontkeepalivedfont-colorred%e8%84%91%e8%a3%82%e8%84%9a%e6%9c%acfont></a></h2><div class="note info"><ul><li><ol><li><font color=red>检测思路：</font></li></ol></li></ul><blockquote><ul><li>1.1 在备节点上执行脚本，如果可以<code>ping</code>通主节点并且备节点有<code>VIP</code>就报警.</li><li>1.2 让人员介入检查是否裂脑。</li><li>1.3 在<code>keepalived-02</code>备节点开发脚本并执行</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-02 ~<span style=color:#f92672>]</span><span style=color:#75715e># cat &gt;check_split_brain.sh&lt;&lt;-EOF </span>
</span></span><span style=display:flex><span><span style=color:#75715e>#!/bin/sh</span>
</span></span><span style=display:flex><span>keepalived-01_vip<span style=color:#f92672>=</span>10.0.0.12
</span></span><span style=display:flex><span>keepalived-01_ip<span style=color:#f92672>=</span>10.0.0.7
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> true
</span></span><span style=display:flex><span><span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>   ping -c <span style=color:#ae81ff>2</span> -W <span style=color:#ae81ff>3</span> <span style=color:#e6db74>${</span><span style=color:#e6db74>&#34;keepalived-01_ip&#34;</span><span style=color:#e6db74>}</span> &amp;&gt;/dev/null 
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> $ -eq <span style=color:#ae81ff>0</span> -a <span style=color:#e6db74>`</span>ip add|grep <span style=color:#e6db74>${</span><span style=color:#e6db74>&#34;keepalived-01_vip&#34;</span><span style=color:#e6db74>}</span>|wc -l<span style=color:#e6db74>`</span> -eq <span style=color:#ae81ff>1</span> <span style=color:#f92672>]</span>  
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>then</span>    
</span></span><span style=display:flex><span>       echo <span style=color:#e6db74>&#34;ha is split brain.warning.&#34;</span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>else</span>    
</span></span><span style=display:flex><span>       echo <span style=color:#e6db74>&#34;ha is ok&#34;</span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>   sleep <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>EOF
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-02 ~<span style=color:#f92672>]</span><span style=color:#75715e># sh check_split_brain.sh  </span>
</span></span><span style=display:flex><span>ha is okha is ok
</span></span></code></pre></div></blockquote><ul><li><ol start=2><li><font color=red>正常情况下主节点活着，</font><code>VIP 10.0.0.12</code><font color=red>在主节点，因此不会报警提示</font><code>ha is ok</code>。 <code>keepalived-01</code> 停止<code>Keepalived</code><font color=red>服务看</font><code>keepalived-02</code><font color=red>脚本执行情况</font></li></ol></li></ul><blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># /etc/init.d/keepalived stop</span>
</span></span><span style=display:flex><span>停止 keepalived：                                          <span style=color:#f92672>[</span>确定<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ip add|grep 10.0.0.12 </span>
</span></span></code></pre></div></blockquote><ul><li><ol start=3><li><font color=red>在</font><code>keepalived-02</code><font color=red>上观察即可，此前脚本已经执行</font></li></ol></li></ul><blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@keepalived-02 ~<span style=color:#f92672>]</span><span style=color:#75715e># sh check_split_brain.sh</span>
</span></span><span style=display:flex><span>ha is okha is ok
</span></span><span style=display:flex><span>ha is split brain.warning.
</span></span><span style=display:flex><span>ha is split brain.warning.
</span></span><span style=display:flex><span>ha is split brain.warning.
</span></span></code></pre></div></blockquote><ul><li><ol start=4><li><font color=red>关掉</font><code>keepalived-01</code><font color=red>服务器，然后再观察</font><code>keepalived-02</code><font color=red>脚本的输出</font></li></ol></li></ul><blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@@keepalived-02 ~<span style=color:#f92672>]</span><span style=color:#75715e># sh check_split_brain.sh </span>
</span></span><span style=display:flex><span>ha is okha is ok
</span></span><span style=display:flex><span>ha is split brain.warning.
</span></span><span style=display:flex><span>ha is split brain.warning.
</span></span><span style=display:flex><span>ha is split brain.warning.
</span></span><span style=display:flex><span>ha is ok
</span></span><span style=display:flex><span>ha is ok
</span></span><span style=display:flex><span>ha is ok
</span></span></code></pre></div></blockquote></div></div><footer class=post-footer><div class=post-tags><a href=/tags/keepalived>Keepalived</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=reward-container><div><i class="fa-solid fa-mug-hot"></i>请我喝杯咖啡吧 ヾ(^▽^*)))</div><button>
赞赏</button><div class=post-reward><div class=post-reward-item><img src=/imgs/img-lazy-loading.gif data-src=/imgs/ali-pay.png alt="二哥 - 支付宝">
<span>支付宝</span></div><div class=post-reward-item><img src=/imgs/img-lazy-loading.gif data-src=/imgs/wechat-pay.png alt="二哥 - 微信">
<span>微信</span></div></div></div><div class=post-copyright><img src=/imgs/cc/cc.svg width=75 height=75 align=right alt=共享知识><ul><li class=post-copyright-title><strong>文章标题：</strong>
Install Keepalived</li><li class=post-copyright-author><strong>本文作者： </strong>二哥</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=http://localhost:1313/system/linux/keepalived/install-keepalived/ title="Install Keepalived">http://localhost:1313/system/linux/keepalived/install-keepalived/</a></li><li class=post-copyright-license><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class=followme><span>欢迎关注我的其它发布渠道</span><div class=social-list><div class=social-item><a target=_blank class=social-link href=/images/wechat_channel.jpg><span class=icon><i class="fab fa-weixin"></i>
</span><span class=label>WeChat</span></a></div><div class=social-item><a target=_blank class=social-link href=/atom.xml><span class=icon><i class="fa fa-rss"></i>
</span><span class=label>RSS</span></a></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/system/linux/daemon/install-supervisord/ rel=next title="Install Supervisord"><i class="fa fa-chevron-left"></i> Install Supervisord</a></div><div class="post-nav-prev post-nav-item"><a href=/system/linux/haproxy/install-haproxy/ rel=prev title="Install HAProxy">Install HAProxy
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div id=comments class=post-comments><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i>
<span>评论交流</span></div><div class=comment-switch><span class=first-comment>Giscus</span>
<span class=switch-btn></span>
<span class=second-comment>Waline</span></div></div><div class=comment-wrap><div><div class=comment-loading><i class="fa fa-sync fa-spin"></i></div><div class=giscus-container></div></div><div><div class=comment-loading><i class="fa fa-sync fa-spin"></i></div><div class=waline-container></div></div></div></div></div></main><footer class=footer><div class=footer-inner><div id=gtranslate class=google-translate><i class="fa fa-language"></i><div id=google_translate_element></div></div><div class=copyright>&copy;
<span itemprop=copyrightYear>2010 - 2024
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>二哥</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.125.4 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.5.3 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div><div class=beian><a href=https://beian.miit.gov.cn target=_blank>粤ICP备 18047355-1 号</a>
<img src=/imgs/gongan.png alt=沪公网安备>
<a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=31011402009770" target=_blank>沪公网安备 31011402009770 号</a></div><div class=vendors-list><a target=_blank href=https://vercel.com title=Vercel><img src=/imgs/img-lazy-loading.gif data-src=/imgs/vendors/vercel.svg alt=Vercel>
</a><a target=_blank href=https://upyun.com title=又拍云><img src=/imgs/img-lazy-loading.gif data-src=/imgs/vendors/upyun.png alt=又拍云>
</a><a target=_blank href=https://webify.cloudbase.net title=Webify>Webify
</a><span>提供CDN/云资源支持</span></div></div></footer><script type=text/javascript src=https://cdn.staticfile.org/animejs/3.2.1/anime.min.js defer></script><script type=text/javascript src=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.js defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"copybtn":true,"darkmode":false,"giscus":{"cfg":{"category":"Comments","categoryid":null,"emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"username/repo-name","repoid":null,"theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"http://localhost:1313/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"limit":1e3,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":true,"plugin":"waline"},"views":{"enable":true,"plugin":"busuanzi"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"vendor":{"plugins":"qiniu","router":"https://cdn.staticfile.org"},"version":"4.5.3","waline":{"cfg":{"emoji":false,"imguploader":false,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"serverurl":null,"sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"waline","file":"dist/waline.css","name":"@waline/client","version":"2.13.0"},"js":{"alias":"waline","file":"dist/waline.js","name":"@waline/client","version":"2.13.0"}}}</script><script type=text/javascript src=/js/main.js defer></script></body></html>