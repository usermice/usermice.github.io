<!DOCTYPE html>
<html lang="en" dir="ltr" itemscope itemtype="http://schema.org/Article">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.125.4">
    <meta name="generator" content="Relearn 6.0.0+tip">
    <meta name="robots" content="noindex, nofollow, noarchive, noimageindex">
    <meta name="description" content="">
    <meta name="author" content="二哥">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://erge.blog/images/s2-1.png">
    <meta name="twitter:title" content="Logs :: Hugo Relearn Theme">
    <meta property="og:url" content="https://erge.blog/systems/linux/logs/">
    <meta property="og:site_name" content="Hugo Relearn Theme">
    <meta property="og:title" content="Logs :: Hugo Relearn Theme">
    <meta property="og:locale" content="en">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://erge.blog/images/s2-1.png">
    <meta itemprop="name" content="Logs :: Hugo Relearn Theme">
    <meta itemprop="datePublished" content="2024-06-13T00:32:08+08:00">
    <meta itemprop="dateModified" content="2024-06-13T00:32:08+08:00">
    <meta itemprop="image" content="https://erge.blog/images/s2-1.png">
    <title>Logs :: Hugo Relearn Theme</title>
    <link href="../../../images/favicon.ico?1722425298" rel="icon" type="image/x-icon" sizes="any">
    <link href="../../../css/fontawesome-all.min.css?1722425299" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="../../../css/fontawesome-all.min.css?1722425299" rel="stylesheet"></noscript>
    <link href="../../../css/nucleus.css?1722425299" rel="stylesheet">
    <link href="../../../css/auto-complete.css?1722425299" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="../../../css/auto-complete.css?1722425299" rel="stylesheet"></noscript>
    <link href="../../../css/perfect-scrollbar.min.css?1722425299" rel="stylesheet">
    <link href="../../../css/fonts.css?1722425299" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="../../../css/fonts.css?1722425299" rel="stylesheet"></noscript>
    <link href="../../../css/theme.css?1722425299" rel="stylesheet">
    <link href="../../../css/theme-relearn-auto.css?1722425299" rel="stylesheet" id="R-variant-style">
    <link href="../../../css/chroma-relearn-auto.css?1722425299" rel="stylesheet" id="R-variant-chroma-style">
    <link href="../../../css/variant.css?1722425299" rel="stylesheet">
    <link href="../../../css/print.css?1722425299" rel="stylesheet" media="print">
    <link href="../../../css/format-print.css?1722425299" rel="stylesheet">
    <script src="../../../js/variant.js?1722425299"></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.relBasePath='..\/..\/..';
      window.relearn.relBaseUri='..\/..\/..';
      window.relearn.absBaseUri='https:\/\/erge.blog';
      window.index_js_url="../../../index.search.js";
      // variant stuff
      window.variants && variants.init( [ 'relearn-auto', 'relearn-light', 'relearn-dark', 'relearn-bright', 'zen-auto', 'zen-light', 'zen-dark', 'retro-auto', 'neon', 'learn', 'blue', 'green', 'red', 'my-branding' ] );
      // translations
      window.T_Copy_to_clipboard = `Copy to clipboard`;
      window.T_Copied_to_clipboard = `Copied to clipboard!`;
      window.T_Copy_link_to_clipboard = `Copy link to clipboard`;
      window.T_Link_copied_to_clipboard = `Copied link to clipboard!`;
      window.T_Reset_view = `Reset view`;
      window.T_View_reset = `View reset!`;
      window.T_No_results_found = `No results found for "{0}"`;
      window.T_N_results_found = `{1} results found for "{0}"`;
    </script>Partial intended to be overwritten to add custom headers, like CSS or any other info
<style>
    
</style>


  </head>
  <body class="mobile-support print disableInlineCopyToClipboard" data-url="../../../systems/linux/logs/">
    <div id="R-body" class="default-animation">
      <div id="R-body-overlay"></div>
      <nav id="R-topbar">
        <div class="topbar-wrapper">
          <div class="topbar-sidebar-divider"></div>
          <div class="topbar-area topbar-area-start" data-area="start">
            <div class="topbar-button topbar-button-sidebar" data-content-empty="show" data-width-s="show" data-width-m="show" data-width-l="show"><button class="topbar-control" onclick="toggleNav()" type="button" title="Menu (CTRL&#43;ALT&#43;n)"><i class="fa-fw fas fa-bars"></i></button>
            </div>



          </div>
          <ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype="http://schema.org/BreadcrumbList"><li
            itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><a itemprop="item" href="../../../systems/"><span itemprop="name">Systems</span></a><meta itemprop="position" content="1">&nbsp;>&nbsp;</li><li
            itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><a itemprop="item" href="../../../systems/linux/"><span itemprop="name">Linux</span></a><meta itemprop="position" content="2">&nbsp;>&nbsp;</li><li
            itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><span itemprop="name">Logs</span><meta itemprop="position" content="3"></li>
          </ol>
          <div class="topbar-area topbar-area-end" data-area="end">


            <div class="topbar-button topbar-button-prev" data-content-empty="show" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="../../../systems/linux/ldap/install_openldap/" title="Install_OpenLDAP (🡐)"><i class="fa-fw fas fa-chevron-left"></i></a>
            </div>

            <div class="topbar-button topbar-button-next" data-content-empty="show" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="../../../systems/linux/logs/use_logrotate/" title="Use_Logrotate (🡒)"><i class="fa-fw fas fa-chevron-right"></i></a>
            </div>



          </div>
        </div>
      </nav>
      <div id="R-main-overlay"></div>
      <main id="R-body-inner" class="highlightable default" tabindex="-1">
        <div class="flex-block-wrapper">
          <article class="default">
            <header class="headline">
            </header>

<h1 id="logs">Logs</h1>


            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Logs</h1>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="use_logrotate">Use_Logrotate</h1>

<h2 id="logrotate日志切割"><code>logrotate</code>日志切割</h2>
<blockquote>
<ul>
<li><code>man logrotate</code><!-- raw HTML omitted -->查看<!-- raw HTML omitted --><code>logrodate</code><!-- raw HTML omitted -->使用详情<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->如果日志切割在：<!-- raw HTML omitted --><code>/usr</code>, <code>boot</code>, <code>/etc</code>, <code>efi</code><!-- raw HTML omitted -->等目录下时，会提示：<!-- raw HTML omitted --><code>error: error opening /usr/local/nginx/logs/nginx.log: Read-only file system</code><!-- raw HTML omitted -->这是因为启动文件配置：<!-- raw HTML omitted --><code>ProtectSystem=full</code></li>
</ul>
<blockquote>
<ul>
<li>修改<code>/lib/systemd/system/logrotate.service</code>配置文件</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl status logrotate.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;/lib/systemd/system/logrotate.service<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ReadWritePaths=/usr/local/nginx/logs  	# 文件末尾添加此行
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ systemctl daemon-reload 
</span></span><span style="display:flex;"><span>$ systemctl restart logrotate.service</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="配置nginx日志切割">配置<code>Nginx</code>日志切割</h3>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://blog.csdn.net/weixin_45203131/article/details/113186186" rel="external" target="_self"><code>centos7 logrotate</code>日志切割</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.cnblogs.com/diantong/p/10717926.html" rel="external" target="_self"><code>CentOS</code>下使用<code>Logrotate</code>日志切割</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://bypass007.github.io/Emergency-Response-Notes/" rel="external" target="_self"><code>Logs</code>日志分析排查<code>GitBook</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/Bypass007/Emergency-Response-Notes" rel="external" target="_self"><code>Logs</code>日志分析排查<code>Github</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.cnblogs.com/kevingrace/p/6307298.html" rel="external" target="_self">日志切割方法小结<code>Logrotate、python、shell</code>脚本实现 </a></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ man logrotate
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 新增nginx log 每日切割</span>
</span></span><span style="display:flex;"><span>$ grep <span style="color:#e6db74">&#34;nginx&#34;</span> /etc/logrotate.d/nginx  &amp;&gt;/dev/null  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;/etc/logrotate.d/nginx<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;/opt/apps/nginx/logs/*.jsonl&#34; /opt/apps/nginx/logs/*.log{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">daily  	# 安日期轮转日志：hourly(小时)、daily(天)、weekly(月)、monthly(月)、yearly(年)，如果设置(size)则不用该参数
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">dateext  	# 文件后缀是日期格式,也就是切割后文件是:xxx.log-20150828，该设置可能和大小切割冲突，该设置按日期生成
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">size 100k	# 在日志大小大于 logsize（例如 100K，100M，100G）时轮换、minsize、maxsize，该选项与日期设置是互斥的
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rotate 15  	# 指定日志文件删除之前转储的次数，0指没有备份，15指保留15个备份
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">compress  	# 通过gzip压缩转储以后的日志（gzip -d xxx.gz解压）
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">missingok  	# 如果日志不存在则忽略该警告信息
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">notifempty  	# 如果是空文件的话，不转储
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">copytruncate  	# 用于还在打开中的日志文件，把当前日志备份并截断
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">delaycompress  	# 和compress一起使用时，delaycompress选项指示logrotate不要将最近的归档压缩，压缩将在下一次轮循周期进行
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sharedscripts  	# 运行postrotate脚本，在所有日志都轮转后统一执行一次脚本。如果没配该选项，每个日志轮转后都会执行一次脚本
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">postrotate  	# 运行postrotate脚本，作用是在所有日志都轮转后统一执行一次脚本，如重启（kill -HUP）服务
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    [ -f /var/run/nginx.pid ] &amp;&amp; kill -USR1 `cat /var/run/nginx.pid`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">endscript  	# 最通常的作用是让应用重启，以便切换到新的日志文件, 在所有其它指令完成后，postrotate和endscript里面指定的命令将被执行。在这种情况下，nginx 进程将立即再次读取其配置并继续运行
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">create 640 www root 	# 以指定的权限用户和组创建全新的日志文件，同时logrotate也会重命名原始日志文件
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">su root root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">} 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 手动调试验证不执行：-d</span>
</span></span><span style="display:flex;"><span>$ /usr/sbin/logrotate -d /etc/logrotate.d/nginx
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 手动强制执行：-f</span>
</span></span><span style="display:flex;"><span>$ /usr/sbin/logrotate -f /etc/logrotate.d/nginx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 新增刪除7天以前log定時腳本  </span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;###nginx超過七天log刪除
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">1 0 * * * /bin/bash /opt/scripts/DEL_NGINX.sh &gt;&gt; ~/del_tom.log 2&gt;&amp;1&#34;</span> &gt;&gt; /var/spool/cron/admin</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_quickwit">Install_Quickwit</h1>

<h2 id="quickwit"><code>Quickwit</code></h2>
<blockquote>
<ul>
<li><a href="https://quickwit.io/docs/" rel="external" target="_self"><code>Quickwit</code>日志管理、分析</a></li>
<li><a href="https://opentelemetry.io/docs/" rel="external" target="_self"><code>OpenTelemetry</code></a></li>
</ul>
</blockquote>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_logkit">Install_Logkit</h1>

<h2 id="logkit"><code>LogKit</code></h2>
<blockquote>
<ul>
<li><a href="https://github.com/qiniu/logkit" rel="external" target="_self"><code>LogKit</code></a></li>
</ul>
<blockquote>
<ul>
<li>非常强大的服务器代理，用于通过易于使用的<code>Web</code>控制台收集和发送日志和指标</li>
</ul>
</blockquote>
</blockquote>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_graylog">Install_Graylog</h1>

<h2 id="graylog日志服务"><code>GrayLog</code>日志服务</h2>
<blockquote>
<ul>
<li><a href="https://docs.graylog.org/docs/operating-system-packages" rel="external" target="_self"><code>GrayLog</code></a>日志服务</li>
<li><a href="https://testerhome.com/topics/3026" rel="external" target="_self"><code>Graylog</code>—日志聚合工具中的后起之秀</a></li>
<li><a href="https://my.oschina.net/HeAlvin/blog/378262" rel="external" target="_self">推荐！国外程序员整理的系统管理员资源大全</a></li>
</ul>
<blockquote>
<ul>
<li><code>Java ( &gt;= 8 )</code></li>
<li><code>MongoDB (4.0, 4.2 or 4.4)</code></li>
<li><code>Elasticsearch (6.x or 7.x)</code></li>
<li><code>GrayLog-Server</code></li>
<li><code>GrayLog-Web</code></li>
</ul>
</blockquote>
</blockquote>
<hr>
<h3 id="安装graylog所需服务">安装<code>GrayLog</code>所需服务</h3>
<ul>
<li>
<ol>
<li><a href="https://www.mongodb.com/docs/manual/tutorial/install-mongodb-on-red-hat/" rel="external" target="_self"><code>Mongodb</code></a>数据库</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>Mongodb</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>yum</code><!-- raw HTML omitted -->存储库<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/yum.repos.d/mongodb-org.repo<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[mongodb-org-4.2]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name=MongoDB Repository
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">baseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/4.2/x86_64/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgcheck=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">enabled=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgkey=https://www.mongodb.org/static/pgp/server-4.2.asc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->安装并启动<!-- raw HTML omitted --><code>MongoDB</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install mongodb-org
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ systemctl daemon-reload
</span></span><span style="display:flex;"><span>$ systemctl enable mongod.service <span style="color:#f92672">&amp;&amp;</span> systemctl start mongod.service
</span></span><span style="display:flex;"><span>$ systemctl --type<span style="color:#f92672">=</span>service --state<span style="color:#f92672">=</span>active | grep mongod</span></span></code></pre></div></blockquote>
</blockquote>
<ul>
<li>
<ol start="2">
<li><code>Elasticsearch</code>数据存储服务</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>GrayLog</code>所需服务<code>Elasticsearch</code>弹性搜索、数据存储服务</li>
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>Elasticsearch</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>yum</code><!-- raw HTML omitted -->存储库<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>GrayLog</code><!-- raw HTML omitted -->不支持<!-- raw HTML omitted --><code>Elasticsearch 7.11</code><!-- raw HTML omitted -->及更高版本。它会破坏你的<!-- raw HTML omitted --><code>Graylog</code><!-- raw HTML omitted -->实例！<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rpm --import https://artifacts.elastic.co/GPG-KEY-elasticsearch  	<span style="color:#75715e"># 添加密钥</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;/etc/yum.repos.d/elasticsearch.repo<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[elasticsearch-7.x]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name=Elasticsearch repository for 7.x packages
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">baseurl=https://artifacts.elastic.co/packages/oss-7.x/yum
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgcheck=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">enabled=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">autorefresh=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">type=rpm-md
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>elasticsearch-oss</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install elasticsearch-oss</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>Elasticsearch</code><!-- raw HTML omitted -->配置文件，并将集群名称设置为<!-- raw HTML omitted --><code>Graylog</code><!-- raw HTML omitted -->并取消注释<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ tee -a /etc/elasticsearch/elasticsearch.yml &gt;/dev/null <span style="color:#e6db74">&lt;&lt;-EOT
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">cluster.name: graylog
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">action.auto_create_index: false  	# 并取消注释，启用该操作
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOT</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->启动<!-- raw HTML omitted --><code>Elasticsearch</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl daemon-reload
</span></span><span style="display:flex;"><span>$ systemctl enable elasticsearch.service <span style="color:#f92672">&amp;&amp;</span> systemctl restart elasticsearch.service
</span></span><span style="display:flex;"><span>$ systemctl --type<span style="color:#f92672">=</span>service --state<span style="color:#f92672">=</span>active | grep elasticsearch</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="安装graylog服务">安装<code>GrayLog</code>服务</h3>
<blockquote>
<ul>
<li><code>GrayLog</code><!-- raw HTML omitted -->各插件功能<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>graylog-enterprise-integrations-plugins</code><!-- raw HTML omitted -->企业集成插件<!-- raw HTML omitted --></li>
<li><code>graylog-enterprise-plugins</code><!-- raw HTML omitted -->企业插件<!-- raw HTML omitted --></li>
<li><code>graylog-integrations-plugins</code><!-- raw HTML omitted -->集成插件<!-- raw HTML omitted --></li>
<li><code>graylog-server</code><!-- raw HTML omitted -->服务端<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rpm -Uvh https://packages.graylog2.org/repo/packages/graylog-4.2-repository_latest.rpm
</span></span><span style="display:flex;"><span>$ yum install graylog-server graylog-enterprise-plugins graylog-integrations-plugins graylog-enterprise-integrations-plugins</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>GrayLog</code><!-- raw HTML omitted -->配置文件<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->阅读配置文件中的说明并根据需要进行编辑，位于<!-- raw HTML omitted --><code>/etc/graylog/server/server.conf</code><!-- raw HTML omitted -->另外添加<!-- raw HTML omitted --><code>password_secret</code><!-- raw HTML omitted -->和<!-- raw HTML omitted --><code>root_password_sha2</code><!-- raw HTML omitted -->因为这些是强制性的，没有它们<!-- raw HTML omitted --><code>Graylog</code><!-- raw HTML omitted -->将无法启动<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ln -s /usr/local/src/jdk1.8.0_221/bin/java /usr/bin/java  	<span style="color:#75715e"># 给Java做个软连接</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ echo -n <span style="color:#e6db74">&#34;Enter Password: &#34;</span> <span style="color:#f92672">&amp;&amp;</span> head -1 &lt;/dev/stdin | tr -d <span style="color:#e6db74">&#39;\n&#39;</span> | sha256sum | cut -d<span style="color:#e6db74">&#34; &#34;</span> -f1  	<span style="color:#75715e"># 为：password_secret，生成64位密码字符</span>
</span></span><span style="display:flex;"><span>$ echo -n yourpassword | sha256sum  	<span style="color:#75715e"># 为：root_password_sha2，生成哈希值</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改配置文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat //etc/graylog/server/server.conf 
</span></span><span style="display:flex;"><span>password_secret <span style="color:#f92672">=</span>   	<span style="color:#75715e"># 57行左右， 添加用户集群数据库中所用</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root_password_sha2 <span style="color:#f92672">=</span>   	<span style="color:#75715e"># 68行左右，添加生成的哈希值， 用于登录web界面</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>http_bind_address <span style="color:#f92672">=</span> 127.0.0.1:9000  	<span style="color:#75715e"># 105行左右修改为：http_bind_address = 0.0.0.0:9000</span></span></span></code></pre></div></blockquote>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->启动<!-- raw HTML omitted --><code>GrayLog</code><!-- raw HTML omitted -->服务<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl daemon-reload
</span></span><span style="display:flex;"><span>$ systemctl enable graylog-server.service <span style="color:#f92672">&amp;&amp;</span> systemctl start graylog-server.service
</span></span><span style="display:flex;"><span>$ systemctl --type<span style="color:#f92672">=</span>service --state<span style="color:#f92672">=</span>active | grep graylog</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>Selinux</code><!-- raw HTML omitted -->开放端口<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->允许<!-- raw HTML omitted --><code>Web</code><!-- raw HTML omitted -->服务器访问网络<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ setsebool -P httpd_can_network_connect <span style="color:#ae81ff">1</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->针对端口配置<!-- raw HTML omitted --><code>Selinux</code><!-- raw HTML omitted -->开放<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ semanage port -a -t http_port_t -p tcp <span style="color:#ae81ff">9000</span>  	<span style="color:#75715e"># Graylog REST API 和 Web 界面</span>
</span></span><span style="display:flex;"><span>$ semanage port -a -t http_port_t -p tcp <span style="color:#ae81ff">9200</span>  	<span style="color:#75715e"># Elasticsearch（仅当使用 HTTP API 时）</span>
</span></span><span style="display:flex;"><span>$ semanage port -a -t mongod_port_t -p tcp <span style="color:#ae81ff">27017</span>  	<span style="color:#75715e"># 允许使用 MongoDB 的默认端口 (27017/tcp)</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->防火墙开放端口<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ firewall-cmd --add-port<span style="color:#f92672">=</span>9000/tcp --permanent
</span></span><span style="display:flex;"><span>$ firewall-cmd --reload</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->打开浏览器访问<!-- raw HTML omitted --><code>GrayLog</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ http://IP:9000  	<span style="color:#75715e"># 默认用户名：admin，所定义的root_password_sha2密码</span></span></span></code></pre></div><ul>
<li><code>Google</code><!-- raw HTML omitted -->浏览器访问报错更换浏览器<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>While rendering this widget, the following error occurred:
</span></span><span style="display:flex;"><span>NotFoundError: Failed to execute <span style="color:#e6db74">&#39;removeChild&#39;</span> on <span style="color:#e6db74">&#39;Node&#39;</span>: The node to be removed is not a child of this node.</span></span></code></pre></div></blockquote>
</blockquote>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_fluentd">Install_Fluentd</h1>

<h2 id="fluentd"><code>Fluentd</code></h2>
<blockquote>
<ul>
<li>
<p><a href="https://www.fluentd.org/" rel="external" target="_self"><code>Fluentd</code></a></p>
<p><code>Fluentd</code>是一个开源的数据收集器，用作统一化数据收集和使用</p>
</li>
</ul>
</blockquote>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_finder">Install_Finder</h1>

<h2 id="finder日志系统"><code>Finder</code>日志系统</h2>
<blockquote>
<ul>
<li><!-- raw HTML omitted --><code>JDK1.8</code><!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted --><code>Tomcat8</code><!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 使用root登录</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1. 创建用户: tomcat</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 如果已有可忽略</span>
</span></span><span style="display:flex;"><span>$ useradd tomcat
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2. 设置临时变量: TOMCAT_HOME</span>
</span></span><span style="display:flex;"><span>TOMCAT_HOME<span style="color:#f92672">=</span>Tomcat根目录
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3. 删除并重建ROOT目录, 如有重要资料请注意备份</span>
</span></span><span style="display:flex;"><span>$ rm -rf $TOMCAT_HOME/webapps/ROOT
</span></span><span style="display:flex;"><span>$ mkdir -p $TOMCAT_HOME/webapps/ROOT
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 4. 下载并解压到ROOT目录</span>
</span></span><span style="display:flex;"><span>$ wget -O /tmp/finder-web-2.5.8.zip http://www.finderweb.net/download/finder-web-2.5.8.war
</span></span><span style="display:flex;"><span>$ unzip -o -d $TOMCAT_HOME/webapps/ROOT /tmp/finder-web-2.5.8.zip
</span></span><span style="display:flex;"><span><span style="color:#75715e"># rm -f /tmp/finder-web-2.5.8.zip</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 5. 为应用目录赋权限</span>
</span></span><span style="display:flex;"><span>$ chown -R tomcat:tomcat $TOMCAT_HOME
</span></span><span style="display:flex;"><span>$ chmod -R <span style="color:#ae81ff">755</span> $TOMCAT_HOME
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 6. 启动Tomcat</span>
</span></span><span style="display:flex;"><span>$ sudo -u tomcat $TOMCAT_HOME/bin/startup.sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 7. 访问地址：http://ip:8080/finder</span>
</span></span><span style="display:flex;"><span>tomcat默认的端口号为8080，如需修改，请手动编辑TOMCAT_HOME/conf/server.xml，需重启Tomcat。
</span></span><span style="display:flex;"><span>默认的用户名密码：
</span></span><span style="display:flex;"><span>admin <span style="color:#ae81ff">1234</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 8. 修改挂载文件</span>
</span></span><span style="display:flex;"><span>$ cat &gt;finder/webapps/ROOT/WEB-INF/finderweb/workspaces.xml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;finderweb&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> &lt;workspace name=&#34;nginx&#34; displayName=&#34;nginx&#34; work=&#34;/opt/logs/nginx&#34; charset=&#34;utf8&#34; readonly=&#34;true&#34; orderNum=&#34;1&#34;/&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> &lt;workspace name=&#34;mysql&#34; displayName=&#34;mysql&#34; work=&#34;/opt/logs/mysql&#34; charset=&#34;utf8&#34; readonly=&#34;true&#34; orderNum=&#34;2&#34;/&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;/finderweb&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li><code>Docker</code>方式安装<code>Finder</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#39;1.0&#39;</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">services</span>:   
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tomcat</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">tomcat:8.5.15-jre8</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">tomcat_finder</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">8090</span>:<span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">TZ</span>: <span style="color:#ae81ff">Asiz/Shanghai </span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">/opt/finder/webapps:/usr/local/tomcat/webapps</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">/opt/finder/conf:/usr/local/tomcat/conf</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">/opt/finder/logs:/usr/local/tomcat/logs</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">/opt/finder/project/logs/nginx:/opt/hwc-logs/nginx</span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_es_head">Install_Es_Head</h1>

<h2 id="elasticsearch-head"><code>elasticsearch-head</code></h2>
<blockquote>
<ul>
<li><a href="https://github.com/mobz/elasticsearch-head" rel="external" target="_self"><code>elasticsearch-head Github</code>地址</a></li>
</ul>
</blockquote>
<h3 id="安装nodejsnpm">安装<code>nodejs、npm</code></h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>nodejs</code><!-- raw HTML omitted -->前先安装<!-- raw HTML omitted --><code>epel-release</code><!-- raw HTML omitted -->源<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install epel-release</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>nodejs、npm</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install nodejs npm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 更新npm</span>
</span></span><span style="display:flex;"><span>$ npm install -g npm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装 n 模块</span>
</span></span><span style="display:flex;"><span>$ npm install -g n</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="国内安装cnpm">国内安装<code>cnpm</code></h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->更换国内阿里云源<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 查看npm 使用地址</span>
</span></span><span style="display:flex;"><span>$ npm config get registry
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 更换源</span>
</span></span><span style="display:flex;"><span>$ npm config set registry https://registry.npm.taobao.org
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用cnpm</span>
</span></span><span style="display:flex;"><span>$ npm install -g cnpm --registry<span style="color:#f92672">=</span>https://registry.npm.taobao.org</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="安装elasticsearch-head">安装<code>elasticsearch-head</code></h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget https://github.com/mobz/elasticsearch-head/archive/refs/tags/v5.0.0.tar.gz
</span></span><span style="display:flex;"><span>$ tar zxvf v5.0.0.tar.gz
</span></span><span style="display:flex;"><span>$ cd elasticsearch-head
</span></span><span style="display:flex;"><span>$ npm install
</span></span><span style="display:flex;"><span>$ npm run start</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_elk">Install_ELK</h1>

<h2 id="elasticsearch部署"><code>Elasticsearch</code>部署</h2>
<blockquote>
<ul>
<li><code>Elasticsearch</code><!-- raw HTML omitted -->简介<!-- raw HTML omitted --><a href="https://www.elastic.co/guide/index.html" rel="external" target="_self">官方文档</a></li>
<li><a href="https://blog.csdn.net/u012332735/article/details/54946355" rel="external" target="_self"><code>Elasticsearch</code>常用插件集合</a></li>
<li><a href="https://www.cnblogs.com/hahaha111122222/p/13139809.html" rel="external" target="_self"><code>ELK</code>基于<code>ElastAlert</code>实现日志的微信报警</a></li>
</ul>
<blockquote>
<ul>
<li><code>Elasticsearch</code>是一个基于<code>Lucene</code>的弹性数据存储、搜索、开源分布式搜索服务，它提供了一个分布式多用户能力的全文搜索引擎，基于<code>RESTful web</code>接口，在<code>elasticsearch</code>中，所有节点的数据是均等的。</li>
<li>特点：分布式，零配置，自动发现，索引自动分片，索引副本机制，<code>restful</code>风格接口，多数据源， 自动搜索负载等。</li>
<li><code>Elasticsearch</code>是用<code>Java</code>开发的，并作为<code>Apache</code>许可条款下的开放源码发布，是第二流行的企业搜索引擎。设计用于云计算中，能够达到实时搜索，稳定，可靠，快速，安装使用方便。</li>
</ul>
</blockquote>
<ul>
<li><a href="https://www.elastic.co/cn/downloads/elasticsearch" rel="external" target="_self">下载<code>elasticsearch-8.1</code></a></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-8.1.3-linux-x86_64.tar.gz
</span></span><span style="display:flex;"><span>$ wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-8.1.3-linux-x86_64.tar.gz.sha512
</span></span><span style="display:flex;"><span>$ sha512sum -c elasticsearch-8.1.3-linux-x86_64.tar.gz.sha512
</span></span><span style="display:flex;"><span>$ tar -xzf elasticsearch-8.1.3-linux-x86_64.tar.gz
</span></span><span style="display:flex;"><span>$ cd elasticsearch-8.1.3/ </span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>Elasticsearch</code><!-- raw HTML omitted -->配置文件<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>Elasticsearch</code><!-- raw HTML omitted -->主配置文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /opt/elasticsearch/config
</span></span><span style="display:flex;"><span>$ cp elasticsearch.yml<span style="color:#f92672">{</span>,.bak<span style="color:#f92672">}</span>  	<span style="color:#75715e"># 提前给配置文件做个备份</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 17行、组名(同一个组，组名必须一致)</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;/cluster.name:/a\\cluster.name: cluster-1&#34;</span> elasticsearch.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 23行、节点名称，建议和主机名一致</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;/node.name:/a\\node.name: server-1&#34;</span> elasticsearch.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 33行、数据存放的路径</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;/path.data:/a\\path.data: /opt/elasticsearch/data&#34;</span> elasticsearch.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 37行、日志存放的路径</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;/path.logs:/a\\path.logs: /opt/elasticsearch/logs&#34;</span> elasticsearch.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 43行、 锁住内存，不被使用到交换分区去(通常在内部不足时，休眠的程序内存信息会交换到交换分区)</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;/bootstrap.memory_lock:/a\\bootstrap.memory_lock: false&#34;</span> elasticsearch.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 56行、网络设置，建议填写本机IP或者0.0.0.0</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;/network.host:/a\\network.host: 0.0.0.0&#34;</span> elasticsearch.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 61行、开启端口</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;/http.port:/a\\http.port: 9200&#34;</span> elasticsearch.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 74行、和节点名称一致</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;/cluster.initial_master_nodes:/a\\cluster.initial_master_nodes: [&#34;</span>server_1<span style="color:#e6db74">&#34;]&#34;</span> elasticsearch.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;http.cors.enabled: true  	# 支持跨域
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">xpack.security.enabled: true  	# 启用安全性检查
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">xpack.security.transport.ssl.enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># discovery.zen.ping.multicast.enabled: false  	# 集群模式，从节点关闭多播
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># discovery.zen.ping.unicast.hosts: [&#34;</span>10.18.41.31<span style="color:#e6db74">&#34;,&#34;</span>10.18.41.137<span style="color:#e6db74">&#34;  	# 集群模式，从节点配置主服务器和自己的地址
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">http.cors.allow-origin: &#34;</span>*<span style="color:#e6db74">&#34;  	# 范围  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">http.cors.allow-headers: Authorization,X-Requested-With,Content-Length,Content-Type
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 手动创建系统索引
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">action.auto_create_index: .monitoring*,.watches,.triggered_watches,.watcher-history*,.ml* &#34;</span> &gt;&gt;elasticsearch.yml</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>Elasticsearch</code><!-- raw HTML omitted -->资源限制配置文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 调整jvm.options文件的32、和33行</span>
</span></span><span style="display:flex;"><span>$ cd /opt/elasticsearch/config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;/## -Xms4g/a\\-Xms512m&#34;</span> jvm.options
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;/## -Xmx4g/a\\-Xmx512m&#34;</span> jvm.options</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->启动服务并开启<!-- raw HTML omitted -->防火墙：9200<!-- raw HTML omitted -->端口<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>Ulimit</code><!-- raw HTML omitted -->调整进程的最大文件描述符<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ulimit -n <span style="color:#ae81ff">65535</span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;* soft nofile 65536
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* hard nofile 65536
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* soft nproc 32000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* hard nproc 32000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* hard memlock unlimited
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* soft memlock unlimited &#34;</span>&gt;&gt;/etc/security/limits.conf</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>vm.max_map_count</code><!-- raw HTML omitted -->最大虚拟内存区域<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;vm.max_map_count=655360&#34;</span> &gt;&gt;/etc/sysctl.conf</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改权限启动服务开放防火墙<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>
<p><!-- raw HTML omitted --><strong>9200端口</strong>：<!-- raw HTML omitted -->用于所有通过<code>HTTP</code>协议进行的<code>API</code>调用。包括搜索、聚合、监控、以及其他任何使用<code>HTTP</code>协议的请求。所有的客户端库都会使用该端口与<code>ElasticSearch</code>进行交互。</p>
</li>
<li>
<p><!-- raw HTML omitted --><strong>9300端口</strong>：<!-- raw HTML omitted -->是一个自定义的二进制协议，用于集群中各节点之间的通信。用于诸如集群变更、主节点选举、节点加入/离开、分片分配等事项。</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ chown -R user:user /opt/elasticsearch  	<span style="color:#75715e"># 普通用户启动</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cd /opt/elasticsearch/
</span></span><span style="display:flex;"><span>$ ./bin/elasticsearch-setup-passwords interactive  	<span style="color:#75715e"># 设置密码，修改密码也是一样。</span>
</span></span><span style="display:flex;"><span>$ ./bin/elasticsearch
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 此命令来判断是init启动还是systemctl启动</span>
</span></span><span style="display:flex;"><span>$ ps -p <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 当systemd启用了日志记录，日志信息使用可用journalctl的命令</span>
</span></span><span style="display:flex;"><span>$ journalctl - f
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 列出elasticsearch服务的日记帐分录</span>
</span></span><span style="display:flex;"><span>$ journalctl - unit elasticsearch
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 要从给定时间开始列出elasticsearch服务的日记帐分录：</span>
</span></span><span style="display:flex;"><span>$ journalctl --unit elasticsearch --since  <span style="color:#e6db74">&#34;2016-10-30 18:17:16&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 检查Elasticsearch</span>
</span></span><span style="display:flex;"><span>$  curl -i -XGET http://127.0.0.1:9200</span></span></code></pre></div></li>
</ul>
</blockquote>
</blockquote>
</blockquote>
<hr>
<h3 id="elasticsearch-head插件安装"><code>elasticsearch-head</code>插件安装</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->下载启动<!-- raw HTML omitted --><code>elasticsearch-head</code><!-- raw HTML omitted -->防火墙开放：9100<!-- raw HTML omitted --><!-- raw HTML omitted -->端口<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /opt/
</span></span><span style="display:flex;"><span>$ git clone git://github.com/mobz/elasticsearch-head.git
</span></span><span style="display:flex;"><span>$ cd elasticsearch-head
</span></span><span style="display:flex;"><span>$ npm install
</span></span><span style="display:flex;"><span>$ npm run start
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  grunt server  	# 或者使用  grunt 启动</span>
</span></span><span style="display:flex;"><span>$ curl http://localhost:9100/  	<span style="color:#75715e"># 登录浏览器输入地址访问</span></span></span></code></pre></div></blockquote>
<hr>
<h2 id="logstash部署"><code>Logstash</code>部署</h2>
<blockquote>
<ul>
<li><code>Logstash</code><!-- raw HTML omitted -->简介<!-- raw HTML omitted -->、<a href="https://www.elastic.co/guide/en/logstash/master/index.html" rel="external" target="_self">官方文档</a></li>
</ul>
<blockquote>
<ul>
<li><code>Logstash</code>是一个完全开源工具，可以对你的日志进行收集、过滤、分析，并将其存储供以后使用（如，搜索），<code>logstash</code>带有一个<code>web</code>界面，搜索和展示所有日志。</li>
</ul>
</blockquote>
<ul>
<li><a href="https://www.elastic.co/cn/downloads/logstash" rel="external" target="_self">下载、解压<code>Logstash</code></a></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget https://artifacts.elastic.co/downloads/logstash/logstash-8.3.3-linux-x86_64.tar.gz
</span></span><span style="display:flex;"><span>$ tar zxvf logstash-8.3.3-linux-x86_64.tar.gz</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>Logstash</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>conf</code><!-- raw HTML omitted -->文件收集<!-- raw HTML omitted --><code>Nginx</code><!-- raw HTML omitted -->日志<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://www.elastic.co/guide/en/logstash/current/configuration.html" rel="external" target="_self">参考官网标准输入输出</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.elastic.co/guide/en/logstash/current/configuration-file-structure.html" rel="external" target="_self">参考官网函数输入输出</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.elastic.co/guide/en/logstash/current/plugins-outputs-elasticsearch.html" rel="external" target="_self">参考官网收集系统日志</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.elastic.co/guide/en/logstash/current/event-dependent-configuration.html" rel="external" target="_self">参考官网收集<code>Java</code>日志</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.elastic.co/guide/en/logstash/current/plugins-codecs-multiline.html" rel="external" target="_self">参考官网使用<code>multiline</code>多行模式</a></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li><code>input{}</code>：<code>logstash</code><!-- raw HTML omitted -->从日志文件中调用函数输入<!-- raw HTML omitted --></li>
<li><code>output{}</code>：<code>logstash</code><!-- raw HTML omitted -->从日志文件中调用函数输出<!-- raw HTML omitted --></li>
<li><code>stdin{}</code>：<code>logstash</code><!-- raw HTML omitted -->从标准输入中收集日志<!-- raw HTML omitted --></li>
<li><code>stdout{} </code>：<code>logstash</code><!-- raw HTML omitted -->从标准输出日志<!-- raw HTML omitted --></li>
<li><code>syslog</code>：<code>logstash</code><!-- raw HTML omitted -->从系统日志程序中收集日志<!-- raw HTML omitted --></li>
<li><code>tcp</code>：<code>logstash</code><!-- raw HTML omitted -->从<!-- raw HTML omitted --><code>TCP</code><!-- raw HTML omitted -->程序端口中收集日志<!-- raw HTML omitted --></li>
<li><code>udp</code>：<code>logstash</code><!-- raw HTML omitted -->从<!-- raw HTML omitted --><code>UDP</code><!-- raw HTML omitted -->程序端口中收集日志<!-- raw HTML omitted --></li>
<li><code>rubuydebug</code>：<!-- raw HTML omitted -->通过<!-- raw HTML omitted --><code>rubuy</code><!-- raw HTML omitted -->库进行收集<!-- raw HTML omitted --></li>
<li><code>multiline</code>：<!-- raw HTML omitted -->多行模块<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;Settings: Default filter workers: 4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Logstash startup completed
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">input {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">file {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">type =&gt; &#34;</span>nginx-error-log<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">path =&gt; &#34;</span>/usr/local/nginx/logs/*error*.log<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">start_position =&gt; &#34;</span>beginning<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}file {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">type =&gt; &#34;</span>nginx-access-log<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">path =&gt; &#34;</span>/usr/local/nginx/logs/*access*.log<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">start_position =&gt; &#34;</span>beginning<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">codec =&gt; json
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">output {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if [type] =~ &#34;</span>nginx-error-log<span style="color:#e6db74">&#34; {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">elasticsearch {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">hosts =&gt; [&#34;</span>elasticsearch服务所在IP:9200<span style="color:#e6db74">&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">index =&gt; &#34;</span>mayi-nginx-error--%<span style="color:#f92672">{</span>+YYYY.MM.dd<span style="color:#f92672">}</span><span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}else if [type] =~ &#34;</span>nginx-access-log<span style="color:#e6db74">&#34; {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">elasticsearch {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">hosts =&gt; [&#34;</span>elasticsearch服务所在IP:9200<span style="color:#e6db74">&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">index =&gt; &#34;</span>mayi-nginx-access-%<span style="color:#f92672">{</span>+YYYY.MM.dd<span style="color:#f92672">}</span><span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">} &#34;</span> &gt;&gt;/opt/elk/logstash/data/nginx-log.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#######  </span>
</span></span><span style="display:flex;"><span>$ cat &gt;logstash.yml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">input {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> redis {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     host =&gt; &#34;Redis 服务所在IP&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     port =&gt; &#34;6379&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     password =&gt; &#34;password&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     data_type =&gt; &#34;list&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     key =&gt; &#34;filebeat&#34; #从redis中导入的key，与filebeat输出对应
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     type =&gt; &#34;redis-input&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     db =&gt; 0 #导入key的数据库，默认为0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">filter {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # 判断redis字符串在不在自己定义的新字段中，用于区分日志类型，做对应的处理
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> if &#39;redis&#39; in [app] {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     # 聚合redis日志
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     grok {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		   # 自定义匹配日志内容，默认一条日志从上到下只会匹配一次对的。且只会匹配一个字段，如需要匹配多个字段，需进行严格匹配
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		   patterns_dir =&gt; [&#34;/opt/elk/patterns_time&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		   # grok提供很多自带的正则，可供使用
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        match =&gt; { &#34;message&#34; =&gt; &#34;%{LOGTIME</span>:log_time<span style="color:#f92672">}</span><span style="color:#e6db74">&#34; }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		   # （?&lt;自定义的&gt;要匹配的内容）
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        match =&gt; { &#34;</span>message<span style="color:#e6db74">&#34; =&gt; &#34;</span><span style="color:#f92672">(</span>?&lt;log_time&gt;%<span style="color:#f92672">{</span>TIMESTAMP_ISO8601<span style="color:#f92672">})</span>.*session <span style="color:#f92672">(</span>?&lt;session&gt;.*<span style="color:#ae81ff">\S</span>$<span style="color:#f92672">)</span><span style="color:#e6db74">&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     date {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		    # 修改采集时间为日志里的时间
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         match =&gt; [&#34;</span>log_time<span style="color:#e6db74">&#34;, &#34;</span>yyyy-MM-dd HH:mm<span style="color:#e6db74">&#34;,&#34;</span>dd MMM yyyy HH:mm:ss.SSS<span style="color:#e6db74">&#34; ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         locale =&gt; &#34;</span>en<span style="color:#e6db74">&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     ruby {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         code =&gt; &#34;</span>event.set<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;timestamp&#39;</span>, event.get<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;@timestamp&#39;</span><span style="color:#f92672">)</span>.time.localtime - 8*60*60<span style="color:#f92672">)</span><span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     ruby {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         code =&gt; &#34;</span>event.set<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;@timestamp&#39;</span>,event.get<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;timestamp&#39;</span><span style="color:#f92672">))</span><span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     mutate {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		      # 转换字段类型，用于聚合操作
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">           convert =&gt; { &#34;</span>session<span style="color:#e6db74">&#34; =&gt; &#34;</span>string<span style="color:#e6db74">&#34; }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			  # 删除无用字段
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">           remove_field =&gt; [&#34;</span>log_time<span style="color:#e6db74">&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	 # 将logstash时间转化中国时间,logstash默认为utc时间，比中国时间慢8个小时（修改的是采集时间，对日志时间没有影响）
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ruby {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     code =&gt; &#34;</span>event.set<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;timestamp&#39;</span>, event.get<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;@timestamp&#39;</span><span style="color:#f92672">)</span>.time.localtime + 8*60*60<span style="color:#f92672">)</span><span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ruby {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     code =&gt; &#34;</span>event.set<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;@timestamp&#39;</span>,event.get<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;timestamp&#39;</span><span style="color:#f92672">))</span><span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  mutate {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     remove_field =&gt; [&#34;</span>timestamp<span style="color:#e6db74">&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">output {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # 用于调试
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # stdout{ codec =&gt; rubydebug }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> #####  创建线上环境索引  ######
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if &#39;online_82&#39; in [app] {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     elasticsearch {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       action =&gt; &#34;</span>index<span style="color:#e6db74">&#34; #The operation on ES
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       hosts =&gt; &#34;</span>127.0.0.1:9200<span style="color:#e6db74">&#34; # ElasticSearch host, can be array.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		  # 输出到es中的索引
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       index =&gt; &#34;</span>online_82_%<span style="color:#f92672">{</span>+YYYY.MM.dd<span style="color:#f92672">}</span><span style="color:#e6db74">&#34; #The index to write data to.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       user =&gt; &#34;</span>elastic<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       password =&gt; &#34;</span>dtyn!@<span style="color:#e6db74">$&#34; }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		 # 对应filebeat中[tags],用对应索引进行判断
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   if [tags][0] == &#39;count&#39; {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     elasticsearch {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       action =&gt; &#34;</span>index<span style="color:#e6db74">&#34; #The operation on ES
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       hosts =&gt; &#34;</span>127.0.0.1:9200<span style="color:#e6db74">&#34; #ElasticSearch host, can be array.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       index =&gt; &#34;</span>online_82_redis_count<span style="color:#e6db74">&#34; #The index to write data to.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       user =&gt; &#34;</span>elastic<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       password =&gt; &#34;</span>dtyn!@$<span style="color:#e6db74">&#34; }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->检查配置、启动服务<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 添加&#34;--configtest&#34;或者&#34;-t&#34;参数检查配置语法是否有误</span>
</span></span><span style="display:flex;"><span>$ /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/nginx.conf --config.test_and_exit
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动程序后台运行&#34;&amp;&#34;</span>
</span></span><span style="display:flex;"><span>$ nohup /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/nginx.conf &amp;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># &#34;screen&#34; 启动另一个终端 </span>
</span></span><span style="display:flex;"><span>$ /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/nginx.conf
</span></span><span style="display:flex;"><span>$ screen -ls
</span></span><span style="display:flex;"><span>$ screen -r <span style="color:#ae81ff">16582</span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h2 id="beats部署"><code>Beats</code>部署</h2>
<blockquote>
<ul>
<li><code>Beats</code>是由<code>Elastic</code>公司开发和维护的一组开源数据采集器。它们设计用于从各种数据源收集数据，然后将数据发送到<code>Elasticsearch</code>或者<code>Logstash</code>等后端存储和分析系统中</li>
</ul>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://www.elastic.co/guide/en/beats/libbeat/current/index.html" rel="external" target="_self">官方文档</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.elastic.co/cn/downloads/beats/" rel="external" target="_self">选择一个<code>Beat</code>任何<code>Beat</code>皆可</a></td>
<td>-</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h3 id="filebeat部署"><code>Filebeat</code>部署</h3>
<blockquote>
<ul>
<li><code>Filebeat</code>用于轻量级日志和文件数据收集。<code>Filebeat</code>可以监控指定的日志文件或位置，收集日志数据，并将其发送到<code>Elasticsearch</code>或<code>Logstash</code>进行存储和分析</li>
<li><a href="https://www.elastic.co/cn/downloads/beats/filebeat" rel="external" target="_self">下载安装<code>Filebeat</code></a></li>
</ul>
<blockquote>
<ul>
<li><a href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-installation-configuration.html" rel="external" target="_self"><code>Filebeat</code>安装配置编辑</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ curl -L -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-8.3.3-linux-x86_64.tar.gz
</span></span><span style="display:flex;"><span>$ tar xzvf filebeat-8.3.3-linux-x86_64.tar.gz</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>Filebeat</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># elasticsearch</span>
</span></span><span style="display:flex;"><span>output.elasticsearch:
</span></span><span style="display:flex;"><span>hosts: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;https://myEShost:9200&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>username: <span style="color:#e6db74">&#34;filebeat_internal&#34;</span>
</span></span><span style="display:flex;"><span>password: <span style="color:#e6db74">&#34;YOUR_PASSWORD&#34;</span> 
</span></span><span style="display:flex;"><span>ssl:
</span></span><span style="display:flex;"><span>enabled: true
</span></span><span style="display:flex;"><span>ca_trusted_fingerprint: <span style="color:#e6db74">&#34;b9a10bbe64ee9826abeda6546fc988c8bf798b41957c33d05db736716513dc9c&#34;</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kibana</span>
</span></span><span style="display:flex;"><span>setup.kibana:
</span></span><span style="display:flex;"><span>host: <span style="color:#e6db74">&#34;mykibanahost:5601&#34;</span> 
</span></span><span style="display:flex;"><span>username: <span style="color:#e6db74">&#34;my_kibana_user&#34;</span>  
</span></span><span style="display:flex;"><span>password: <span style="color:#e6db74">&#34;{pwd}&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;filebeat.yml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">filebeat.inputs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- type: log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  enabled: True # True表示收集
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # pasths配置收集日志的路径，支持配置多条路径，及多目录
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  paths:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - /opt/app/nacos-1.3.2/nacos/bin/logs/*.log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # tags 标记;可以用来区分日志,这是一个列表可以写多个标记
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  tags: [&#34;nacos&#34;] 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # fileds创建新的字段，默认是二级字段，可以自定义多个key: value
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  fields:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    app: test_71_nacos-1.3.2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # 让新建的字段变成顶级字段，减少不必要的资源开销
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  fields_under_root: true 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # 让filebeat采集最新的日志变化，忽略掉之前旧日志
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  tail_files: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # 下边这几项可以不用
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # filebeat依靠文件描述符识别文件，当发生重命名或移动，filebeat依然采集的原文件。
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  close_renamed: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # 等待再次检查文件的时间，默认是10s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  max_backoff: 1s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # 此选项指定等待时间的增加速度,1表示禁用回算算法
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  backoff_factor: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ====== Outputs ======
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># --------- reids output ------------
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">output.redis:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  hosts: [&#34;Redis服务所在IP:6379&#34;] # 输出到redis的ip端口号
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  password: &#34;password&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  key: &#34;filebeat&#34; # 输出到redis中的key，这个key是一个列表，llen key查看长度  lrange key 0 -1 查看列表所有的值
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  timeout: 30 # 连接redis超时时间，默认为5s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">output.elasticsearch:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> hosts: [&#34;&lt;节点01的IP&gt;:9200&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> template.name: &#34;filebeat&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> template.path: &#34;filebeat.template.json&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> template.overwrite: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> username: &#34;elastic&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> password: &#34;changeme&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 拓展
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">filbeat也可以采集jar堆栈日志
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 堆栈日志的格式：多行日志内容为一条日志
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- type: log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  enabled: True
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  paths:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - /opt/app/nacos-1.3.2/nacos/bin/logs/*.log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  multiline:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # 自定义每条日志的开头
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    pattern: &#39;\# Time: \d{4}-\d{2}-\d{2}&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# 定义模式是否被否定,默认值为false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	negate: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# 与模式不匹配的连续行将追加到匹配的上一行
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	match: after
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;filebeat.yml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">filebeat.config.inputs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  path: /etc/filebeat/input.d/*.yml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  reload.enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  reload.period: 10s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">filebeat.config.modules:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  path: ${path.config}/modules.d/*.yml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  reload.enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">setup.template.settings:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  index.number_of_shards: 3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">processors:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - drop_fields:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      fields: [&#34;agent.ephemeral_id&#34;, &#34;agent.hostname&#34;, &#34;agent.id&#34;, &#34;agent.name&#34;, &#34;agent.type&#34;, &#34;agent.version&#34;, &#34;headers&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - rename:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      fields:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - from: &#34;url&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          to: &#34;url_host&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      ignore_missing: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      fail_on_error: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">output.elasticsearch:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  hosts: [&#34;&#34;&lt;节点01的IP&gt;:9200&#34;&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  api_key: &#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  index: &#34;nginx-%{[fields.application]}-%{+yyyy.MM.dd}&#34;  # fields.application参数修改
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  indices:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    when.equals:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      fields.application: [&#39;app-docker-nginx_access&#39;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">setup.ilm.enabled: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 自定义模板格式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">setup.template.name: &#34;nginx&#34;  	# 模板名称
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">setup.template.pattern: &#34;nginx-*&#34;  	# 匹配模板类型
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">setup.template.enabled: false  	# false：不使用默认模板，true：使用默认模板
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">setup.template.overwrite: true  	# 是否覆盖原来模板
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;/etc/filebeat/input.d/app-docker-nginx_access.yml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">filebeat.inputs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- type: log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  paths:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - /usr/local/nginx/logs/gitlab.log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  fields:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    application: app-docker-nginx_access
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # 开启 json日志格式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  json.keys_under_root: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  json.overwrite_keys: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  json.message_key: message
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  json.add_error_key: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 输出位置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">output.elasticsearch:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  hosts: [&#34;192.168.1.1:9200&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->列出以及使用模块<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ./filebeat modules list
</span></span><span style="display:flex;"><span>$ ./filebeat modules enable nginx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- module: nginx
</span></span><span style="display:flex;"><span>  access:
</span></span><span style="display:flex;"><span>    enabled: true
</span></span><span style="display:flex;"><span>    var.paths: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;/var/log/nginx/access.log*&#34;</span><span style="color:#f92672">]</span> </span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->检测启动<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ./filebeat setup -e
</span></span><span style="display:flex;"><span>$ chown root filebeat.yml 
</span></span><span style="display:flex;"><span>$ chown root modules.d/nginx.yml 
</span></span><span style="display:flex;"><span>$ ./filebeat -e</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="metricbeat部署"><code>Metricbeat</code>部署</h3>
<blockquote>
<ul>
<li><code>Metricbeat</code>用于定时收集系统和服务的指标数据。<code>Metricbeat</code>支持收集各种服务（如<code>Redis</code>、<code>Apache</code>、<code>MySQL</code>等）的性能指标，并将这些数据发送到<code>Elasticsearch</code>或者其他数据存储和可视化工具中</li>
</ul>
</blockquote>
<hr>
<h3 id="packetbeat部署"><code>Packetbeat</code>部署</h3>
<blockquote>
<ul>
<li><code>Packetbeat</code>用于实时网络数据分析。<code>Packetbeat</code>可以监控网络流量，捕获和分析应用层协议（如<code>HTTP</code>、MySQL<code>、</code>DNS`等）的数据，帮助识别问题和优化网络性能</li>
</ul>
</blockquote>
<hr>
<h3 id="heartbeat部署"><code>Heartbeat</code>部署</h3>
<blockquote>
<ul>
<li><code>Heartbeat</code>用于监控服务的可用性。<code>Heartbeat</code>可以定期检查服务、网站或者主机的可访问性，并记录响应时间和状态，以帮助运维人员快速发现和解决故障。</li>
</ul>
</blockquote>
<hr>
<h3 id="auditbeat部署"><code>Auditbeat</code>部署</h3>
<blockquote>
<ul>
<li><code>Auditbeat</code>用于收集系统审计日志。<code>Auditbeat</code>监控操作系统和文件系统的活动，包括文件访问、用户登录等安全相关事件，并将这些事件发送到中心化的日志管理系统</li>
</ul>
</blockquote>
<hr>
<h2 id="kibana部署"><code>Kibana</code>部署</h2>
<blockquote>
<ul>
<li>
<p><a href="https://www.elastic.co/guide/en/kibana/current/index.html" rel="external" target="_self">部署<code>Kibana</code>图形化展示官方文档</a></p>
</li>
<li>
<p><code>Kibana</code>是由<code>Elastic</code>公司开发的开源数据可视化工具，用于对<code>Elasticsearch</code>索引中的数据进行搜索、分析和可视化。它是<code>Elastic Stack</code>（也称为<code>ELK Stack</code>）中的一个重要组件，与<code>Elasticsearch</code>、<code>Logstash</code>和<code>Beats</code>一起构成了一个强大的数据分析平台</p>
</li>
<li>
<p>是一个基于浏览器页面的<code>Elasticsearch</code>前端展示工具，也是一个开源和免费的工具，<code>Kibana</code>可以为<code>Logstash</code>和<code>ElasticSearch</code>提供的日志分析友好的<code>Web</code>界面，可以帮你汇总、分析和搜索重要数据日志</p>
</li>
<li>
<p><strong>主要功能和特点：</strong></p>
</li>
</ul>
<blockquote>
<ul>
<li>
<p><strong>数据查询和搜索</strong>：</p>
<p><code>Kibana</code>提供了一个直观的搜索和查询界面，允许用户在<code>Elasticsearch</code>索引中执行复杂的搜索操作。用户可以使用<code>Lucene</code>&gt; 查询语法或者结构化的查询构建器来筛选和查找数据。</p>
</li>
<li>
<p><strong>数据可视化</strong>：</p>
<p><code>Kibana</code>允许用户将<code>Elasticsearch</code>&gt; 中的数据通过各种图表（如折线图、柱状图、饼图等）和图形化展示方式进行可视化。这些图表可以帮助用户直观地理解数据的趋势、关系和模式</p>
</li>
<li>
<p><strong>仪表盘和视图</strong>：</p>
<p>用户可以通过创建仪表盘<code>Dashboard</code>&gt; 来集成多个数据可视化组件，形成一个全面的数据展示和监控面板。仪表盘可以包含多个图表、指标和数据表格，为用户提供全面的数据洞察力</p>
</li>
<li>
<p><strong>实时数据分析</strong>：</p>
<p><code>Kibana</code>支持实时数据分析和实时查询，用户可以即时查看和分析数据的变化和趋势。这对于监控和操作实时系统特别有用</p>
</li>
<li>
<p><strong>用户权限和安全性</strong>：</p>
<p><code>Kibana</code>提供了灵活的用户权限管理和安全功能，允许管理员定义和控制用户对不同数据和功能的访问权限。这对于多用户和多团队协作使用的环境非常重要。</p>
</li>
<li>
<p><strong>插件和扩展性</strong>：</p>
<p><code>Kibana</code>提供了丰富的插件和可扩展的<code>API</code>，使得用户可以根据自己的需求和场景定制和扩展<code>Kibana</code>的功能。社区和第三方开发者可以通过插件扩展<code>Kibana</code>的功能，增加新的数据处理和可视化能力。</p>
</li>
</ul>
</blockquote>
<ul>
<li><strong>使用场景：</strong></li>
</ul>
<blockquote>
<ul>
<li>
<p><strong>日志分析和监控</strong>：</p>
<p>通过结合<code>Elasticsearch</code>和<code>Beats</code>，<code>Kibana</code>可以实时分析和监控日志数据，帮助用户快速发现和解决系统问题。</p>
</li>
<li>
<p><strong>应用性能监控</strong>：</p>
<p>通过集成<code>Metricbeat</code>和<code>Elasticsearch</code>，<code>Kibana</code>可以实时展示和分析应用程序的性能指标，帮助开发团队优化应用性能。</p>
</li>
<li>
<p><strong>安全事件分析</strong>：</p>
<p>结合<code>Auditbeat</code>和<code>Elasticsearch</code>，<code>Kibana</code>可以监控和分析系统和应用的安全事件，帮助安全团队及时响应和调查安全事件。</p>
</li>
</ul>
</blockquote>
<ul>
<li><a href="https://elastic.co/cn/downloads/kibana" rel="external" target="_self">下载、解压<code>Kibana</code>图形化展示工具</a></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ curl -O https://artifacts.elastic.co/downloads/kibana/kibana-8.3.3-linux-x86_64.tar.gz
</span></span><span style="display:flex;"><span>$ curl https://artifacts.elastic.co/downloads/kibana/kibana-8.3.3-linux-x86_64.tar.gz.sha512 | sha512sum -c - 
</span></span><span style="display:flex;"><span>$ tar -zxvf kibana-8.3.3-linux-x86_64.tar.gz
</span></span><span style="display:flex;"><span>$ cd kibana-8.3.3/ </span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->修改配置文件<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /usr/local/src/kibana-8.3.3/config
</span></span><span style="display:flex;"><span>$ cp kibana.yml<span style="color:#f92672">{</span>,.bak<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 6行左右、去掉注释</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;/server.port:/a\\server.port: 5601&#34;</span> kibana.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 11行左右、去掉注释，修改为本机IP</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;/server.host:/a\\server.host: &#34;Kibana服务所在IP&#34;&#39;</span> kibana.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 43行左右、去掉注释，修改为elssticsearch的IP地址和端口</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;/elasticsearch.host:/a\\elasticsearch.host: [&#34;http://elssticsearch服务所在IP:9200&#34;]&#39;</span> kibana.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 49行左右、设置访问用户名密码</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;/#elasticsearch.username:/a\\elasticsearch.username: &#34;username&#34;&#39;</span> kibana.yml
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;/#elasticsearch.password:/a\\elasticsearch.password: &#34;password&#34;&#39;</span> kibana.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># sed -i &#39;/kibana.index:/a\\kibana.index: &#34;.kibana&#34;&#39; kibana.yml  	# 新版不存在此参数</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->启动服务、处理不能删除索引问题<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->防火墙开放：5601<!-- raw HTML omitted --><!-- raw HTML omitted -->端口<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 检测启动方式  </span>
</span></span><span style="display:flex;"><span>$ ps -p <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ./bin/kibana
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 命令行执行</span>
</span></span><span style="display:flex;"><span>$ curl -XPUT -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> http://localhost:9200/_all/_settings -d <span style="color:#e6db74">&#39;{&#34;index.blocks.read_only_allow_delete&#34;:null}&#39;</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 浏览器</span>
</span></span><span style="display:flex;"><span>PUT _settings
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;index&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;blocks&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;read_only_allow_delete&#34;</span>: <span style="color:#e6db74">&#34;false&#34;</span>
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;delete-es-index.sh<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">date=`date -d &#34;7 days ago&#34; +%Y.%m.%d`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">curl -XDELETE -u &#39;elastic:dtyn!@$&#39; http://localhost:9200/*{$date}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="configure_elk">Configure_ELK</h1>

<h2 id="配置elasticsearchredis">配置<code>elasticsearch+redis</code></h2>
<ul>
<li>
<ol>
<li><code>elasticsearch</code><!-- raw HTML omitted -->出现问题怎么处理<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>接下来描述会遇见到的一个问题：一旦我们的<code>elasticsearch</code>出现问题，就不能进行日志采集处理了！这种情况下该怎么办呢？</li>
<li><!-- raw HTML omitted -->解决方案：<!-- raw HTML omitted -->可以在<code>client</code>和<code>elasticsearch</code>之间添加一个中间件作为缓存，先将采集到的日志内容写到中间件上，然后再从中间件输入到<code>elasticsearch</code>中。
这就完美的解决了上述的问题了。<code>ELK</code>中使用<code>redis</code>作为中间件，缓存日志采集内容</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ curl <span style="color:#e6db74">&#39;localhost:9200/_cat/health?v&#39;</span>  	<span style="color:#75715e"># 检测集群是否健康</span>
</span></span><span style="display:flex;"><span>$ curl <span style="color:#e6db74">&#39;localhost:9200/_cat/nodes?v&#39;</span>  	<span style="color:#75715e"># 获取集群节点列表</span>
</span></span><span style="display:flex;"><span>$ curl <span style="color:#e6db74">&#39;localhost:9200/_cat/indices?v&#39;</span>  	<span style="color:#75715e"># 列出所有索引</span>
</span></span><span style="display:flex;"><span>$ curl -XPUT <span style="color:#e6db74">&#39;localhost:9200/customer?pretty&#39;</span>  	<span style="color:#75715e"># 创建一个名为&#34;customer&#34;的索引</span>
</span></span><span style="display:flex;"><span>$ curl -XDELETE <span style="color:#e6db74">&#39;localhost:9200/customer?pretty&#39;</span>  	<span style="color:#75715e"># 删除一个名为&#34;customer&#34;的索引</span>
</span></span><span style="display:flex;"><span>$ curl localhost:9200/_cat/segments/<span style="color:#f92672">{</span>indexName<span style="color:#f92672">}</span>|wc -l  	<span style="color:#75715e"># 查看某个索引的段数量：GET /nginx-2022-*/_segments</span>
</span></span><span style="display:flex;"><span>$ curl -XPOST 192.168.60.7:9200/indexName/_forcemerge?max_num_segments<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>  	<span style="color:#75715e"># 合并某个索引的段</span>
</span></span><span style="display:flex;"><span>POST /nginx-2022-*/_forcemerge?max_num_segments<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>  	<span style="color:#75715e"># 支持通配符</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;delete_es_index.sh<span style="color:#e6db74">&lt;&lt;-EOF 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 定期删除两个月之前elasticsearch索引
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">date=`date -d &#34;-2 months&#34; &#34;+%Y.%m&#34;`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/usr/bin/curl -v --user elastic:elastic用户密码 -XDELETE &#34;http://es机器IP:9200/*-$date&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>Redis</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat /etc/redis.conf  	<span style="color:#75715e"># 修改下面两行内容</span>
</span></span><span style="display:flex;"><span>daemonize yes
</span></span><span style="display:flex;"><span>bind 192.168.1.160
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ systemctl start redis
</span></span><span style="display:flex;"><span>$ lsof -i:6379
</span></span><span style="display:flex;"><span>COMMAND     PID  USER   FD   TYPE  DEVICE SIZE/OFF NODE NAME
</span></span><span style="display:flex;"><span>redis-ser <span style="color:#ae81ff">19474</span> redis    4u  IPv4 <span style="color:#ae81ff">1344465</span>      0t0  TCP elk-node1:6379 <span style="color:#f92672">(</span>LISTEN<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ redis-cli -h 192.168.1.160
</span></span><span style="display:flex;"><span>192.168.1.160:6379&gt; info
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Server</span>
</span></span><span style="display:flex;"><span>redis_version:2.8.19
</span></span><span style="display:flex;"><span>.......</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->编写从<!-- raw HTML omitted --><code>Client</code><!-- raw HTML omitted -->端收集数据的文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat /opt/logstash/data/redis-out.conf
</span></span><span style="display:flex;"><span>input <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>stdin <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>output <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>redis <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>host <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;192.168.1.160&#34;</span>
</span></span><span style="display:flex;"><span>port <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6379&#34;</span>
</span></span><span style="display:flex;"><span>db <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6&#34;</span>
</span></span><span style="display:flex;"><span>data_type <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;list&#34;</span>
</span></span><span style="display:flex;"><span>key <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;demo&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->执行收集数据的文件，并输入数据<!-- raw HTML omitted --><code>hello redis</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /opt/logstash/bin/logstash -f redis-out.conf 
</span></span><span style="display:flex;"><span>Settings: Default filter workers: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>Logstash startup completed  	<span style="color:#75715e"># 下面输入数据hello redis</span>
</span></span><span style="display:flex;"><span>hello redis</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->在<!-- raw HTML omitted --><code>redis</code><!-- raw HTML omitted -->中查看数据<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ redis-cli -h 192.168.1.160
</span></span><span style="display:flex;"><span>192.168.1.160:6379&gt; info
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Server</span>
</span></span><span style="display:flex;"><span>.......
</span></span><span style="display:flex;"><span>.......
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Keyspace</span>
</span></span><span style="display:flex;"><span>db6:keys<span style="color:#f92672">=</span>1,expires<span style="color:#f92672">=</span>0,avg_ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>  	<span style="color:#75715e"># 在最下面一行，显示是db6</span>
</span></span><span style="display:flex;"><span>192.168.1.160:6379&gt; <span style="color:#66d9ef">select</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>192.168.1.160:6379<span style="color:#f92672">[</span>6<span style="color:#f92672">]</span>&gt; keys *
</span></span><span style="display:flex;"><span>1<span style="color:#f92672">)</span> <span style="color:#e6db74">&#34;demo&#34;</span>
</span></span><span style="display:flex;"><span>192.168.1.160:6379<span style="color:#f92672">[</span>6<span style="color:#f92672">]</span>&gt; LINDEX demo -1
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;{\&#34;message\&#34;:\&#34;hello redis\&#34;,\&#34;@version\&#34;:\&#34;1\&#34;,\&#34;@timestamp\&#34;:\&#34;2016-11-14T08:04:25.981Z\&#34;,\&#34;host\&#34;:\&#34;elk-node1\&#34;}&#34;</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="6">
<li><!-- raw HTML omitted -->继续随便写点数据测试<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /opt/logstash/bin/logstash -f redis-out.conf
</span></span><span style="display:flex;"><span>Settings: Default filter workers: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>Logstash startup completed
</span></span><span style="display:flex;"><span>hello redis
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">123456</span>
</span></span><span style="display:flex;"><span>asdf
</span></span><span style="display:flex;"><span>ert
</span></span><span style="display:flex;"><span>wang
</span></span><span style="display:flex;"><span>shi
</span></span><span style="display:flex;"><span>bo
</span></span><span style="display:flex;"><span>guohuihui
</span></span><span style="display:flex;"><span>as
</span></span><span style="display:flex;"><span>we
</span></span><span style="display:flex;"><span>r
</span></span><span style="display:flex;"><span>g
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asdfjkdfsak
</span></span><span style="display:flex;"><span>5423wer
</span></span><span style="display:flex;"><span>34rt3
</span></span><span style="display:flex;"><span>6y
</span></span><span style="display:flex;"><span>7uj
</span></span><span style="display:flex;"><span>u
</span></span><span style="display:flex;"><span>io9
</span></span><span style="display:flex;"><span>sdjfhsdk890
</span></span><span style="display:flex;"><span>huanqiu
</span></span><span style="display:flex;"><span>huanqiuchain
</span></span><span style="display:flex;"><span>hqsb
</span></span><span style="display:flex;"><span>asda    </span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="7">
<li><!-- raw HTML omitted -->在<!-- raw HTML omitted --><code>redis</code><!-- raw HTML omitted -->中查看长度<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ redis-cli -h 192.168.1.160
</span></span><span style="display:flex;"><span>192.168.1.160:6379&gt; info
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Server</span>
</span></span><span style="display:flex;"><span>redis_version:2.8.19
</span></span><span style="display:flex;"><span>.......
</span></span><span style="display:flex;"><span>.......
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Keyspace</span>
</span></span><span style="display:flex;"><span>db6:keys<span style="color:#f92672">=</span>1,expires<span style="color:#f92672">=</span>0,avg_ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>  	<span style="color:#75715e"># 显示是db6</span>
</span></span><span style="display:flex;"><span>192.168.1.160:6379&gt; <span style="color:#66d9ef">select</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>192.168.1.160:6379<span style="color:#f92672">[</span>6<span style="color:#f92672">]</span>&gt; keys *
</span></span><span style="display:flex;"><span>1<span style="color:#f92672">)</span> <span style="color:#e6db74">&#34;demo&#34;</span>
</span></span><span style="display:flex;"><span>192.168.1.160:6379<span style="color:#f92672">[</span>6<span style="color:#f92672">]</span>&gt; LLEN demo
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>integer<span style="color:#f92672">)</span> <span style="color:#ae81ff">24</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="8">
<li><!-- raw HTML omitted -->将<!-- raw HTML omitted --><code>redis</code><!-- raw HTML omitted -->中的内容写到<!-- raw HTML omitted --><code>elasticsearch</code><!-- raw HTML omitted -->中<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ vim redis-in.conf
</span></span><span style="display:flex;"><span>input <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>redis <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span> host <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;192.168.1.160&#34;</span>
</span></span><span style="display:flex;"><span> port <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6379&#34;</span>
</span></span><span style="display:flex;"><span> db <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6&#34;</span>
</span></span><span style="display:flex;"><span> data_type <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;list&#34;</span>
</span></span><span style="display:flex;"><span> key <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;demo&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>output <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>elasticsearch <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span> hosts <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;192.168.1.160:9200&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span> index <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;redis-in-%{+YYYY.MM.dd}&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="9">
<li><!-- raw HTML omitted -->执行<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /opt/logstash/bin/logstash -f  redis-in.conf --configtest
</span></span><span style="display:flex;"><span>Configuration OK
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ /opt/logstash/bin/logstash -f  redis-in.conf &amp;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在redis中查看，发现数据已被读出：</span>
</span></span><span style="display:flex;"><span>192.168.1.160:6379<span style="color:#f92672">[</span>6<span style="color:#f92672">]</span>&gt; LLEN demo
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>integer<span style="color:#f92672">)</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 登陆elasticsearch界面查看</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="10">
<li><!-- raw HTML omitted -->将收集到的所有日志写入到<!-- raw HTML omitted --><code>redis</code><!-- raw HTML omitted -->中。这了重新定义一个添加<!-- raw HTML omitted --><code>redis</code><!-- raw HTML omitted -->缓存后的总文件<!-- raw HTML omitted --><code>shipper.conf</code><!-- raw HTML omitted -->。（可以将之前执行的总文件<!-- raw HTML omitted --><code>file.conf</code><!-- raw HTML omitted -->停掉）<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ vim shipper.conf
</span></span><span style="display:flex;"><span>input <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>file <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span> path <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;/var/log/messages&#34;</span>
</span></span><span style="display:flex;"><span> type <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;system&#34;</span>
</span></span><span style="display:flex;"><span> start_position <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;beginning&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>file <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  path <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;/var/log/elasticsearch/huanqiu.log&#34;</span>
</span></span><span style="display:flex;"><span>  type <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;es-error&#34;</span>
</span></span><span style="display:flex;"><span>  start_position <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;beginning&#34;</span>
</span></span><span style="display:flex;"><span>  codec <span style="color:#f92672">=</span>&gt; multiline <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      pattern <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;^\[&#34;</span>
</span></span><span style="display:flex;"><span>      negate <span style="color:#f92672">=</span>&gt; true
</span></span><span style="display:flex;"><span>      what <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;previous&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>file <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>   path <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;/var/log/nginx/access_json.log&#34;</span>
</span></span><span style="display:flex;"><span>   codec <span style="color:#f92672">=</span>&gt; json
</span></span><span style="display:flex;"><span>   start_position <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;beginning&#34;</span>
</span></span><span style="display:flex;"><span>   type <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;nginx-log&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>syslog <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    type <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;system-syslog&#34;</span>
</span></span><span style="display:flex;"><span>    host <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;192.168.1.160&#34;</span>
</span></span><span style="display:flex;"><span>    port <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;514&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>output <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span>type<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;system&#34;</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span> redis <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    host <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;192.168.1.160&#34;</span>
</span></span><span style="display:flex;"><span>    port <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6379&#34;</span>
</span></span><span style="display:flex;"><span>    db <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6&#34;</span>
</span></span><span style="display:flex;"><span>    data_type <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;list&#34;</span>
</span></span><span style="display:flex;"><span>    key <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;system&#34;</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span>type<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;es-error&#34;</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  redis <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>   host <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;192.168.1.160&#34;</span>
</span></span><span style="display:flex;"><span>   port <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6379&#34;</span>
</span></span><span style="display:flex;"><span>   db <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6&#34;</span>
</span></span><span style="display:flex;"><span>   data_type <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;list&#34;</span>
</span></span><span style="display:flex;"><span>   key <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;demo&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span>type<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;nginx-log&#34;</span><span style="color:#f92672">{</span>   
</span></span><span style="display:flex;"><span>   redis <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      host <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;192.168.1.160&#34;</span>
</span></span><span style="display:flex;"><span>      port <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6379&#34;</span>
</span></span><span style="display:flex;"><span>      db <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6&#34;</span>
</span></span><span style="display:flex;"><span>      data_type <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;list&#34;</span>
</span></span><span style="display:flex;"><span>      key <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;nginx-log&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span>type<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;system-syslog&#34;</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>   redis <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      host <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;192.168.1.160&#34;</span>
</span></span><span style="display:flex;"><span>      port <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6379&#34;</span>
</span></span><span style="display:flex;"><span>      db <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6&#34;</span>
</span></span><span style="display:flex;"><span>      data_type <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;list&#34;</span>
</span></span><span style="display:flex;"><span>      key <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;system-syslog&#34;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">}</span>   
</span></span><span style="display:flex;"><span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="11">
<li><!-- raw HTML omitted -->执行上面的文件（提前将上面之前启动的<!-- raw HTML omitted --><code>file.conf</code><!-- raw HTML omitted -->文件的执行给结束掉！）<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$  /opt/logstash/bin/logstash -f shipper.conf --configtest
</span></span><span style="display:flex;"><span>Configuration OK
</span></span><span style="display:flex;"><span>$ /opt/logstash/bin/logstash -f shipper.conf
</span></span><span style="display:flex;"><span>Settings: Default filter workers: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>Logstash startup completed
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在redis中查看：</span>
</span></span><span style="display:flex;"><span>$ redis-cli -h 192.168.1.160
</span></span><span style="display:flex;"><span>192.168.1.160:6379&gt; info
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Server</span>
</span></span><span style="display:flex;"><span>redis_version:2.8.19
</span></span><span style="display:flex;"><span>.......
</span></span><span style="display:flex;"><span>.......
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Keyspace</span>
</span></span><span style="display:flex;"><span>db6:keys<span style="color:#f92672">=</span>1,expires<span style="color:#f92672">=</span>0,avg_ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>  	<span style="color:#75715e"># 显示是db6</span>
</span></span><span style="display:flex;"><span>192.168.1.160:6379&gt; <span style="color:#66d9ef">select</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>192.168.1.160:6379<span style="color:#f92672">[</span>6<span style="color:#f92672">]</span>&gt; keys *
</span></span><span style="display:flex;"><span>1<span style="color:#f92672">)</span> <span style="color:#e6db74">&#34;demo&#34;</span>
</span></span><span style="display:flex;"><span>2<span style="color:#f92672">)</span> <span style="color:#e6db74">&#34;system&#34;</span>
</span></span><span style="display:flex;"><span>192.168.1.160:6379<span style="color:#f92672">[</span>6<span style="color:#f92672">]</span>&gt; keys *
</span></span><span style="display:flex;"><span>1<span style="color:#f92672">)</span> <span style="color:#e6db74">&#34;nginx-log&#34;</span>
</span></span><span style="display:flex;"><span>2<span style="color:#f92672">)</span> <span style="color:#e6db74">&#34;demo&#34;</span>
</span></span><span style="display:flex;"><span>3<span style="color:#f92672">)</span> <span style="color:#e6db74">&#34;system&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 另开一个窗口，添加点日志:</span>
</span></span><span style="display:flex;"><span>$ logger <span style="color:#e6db74">&#34;12325423&#34;</span>
</span></span><span style="display:flex;"><span>$ logger <span style="color:#e6db74">&#34;12325423&#34;</span>
</span></span><span style="display:flex;"><span>$ logger <span style="color:#e6db74">&#34;12325423&#34;</span>
</span></span><span style="display:flex;"><span>$ logger <span style="color:#e6db74">&#34;12325423&#34;</span>
</span></span><span style="display:flex;"><span>$ logger <span style="color:#e6db74">&#34;12325423&#34;</span>
</span></span><span style="display:flex;"><span>$ logger <span style="color:#e6db74">&#34;12325423&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 又会增加日志：</span>
</span></span><span style="display:flex;"><span>192.168.1.160:6379<span style="color:#f92672">[</span>6<span style="color:#f92672">]</span>&gt; keys *
</span></span><span style="display:flex;"><span>1<span style="color:#f92672">)</span> <span style="color:#e6db74">&#34;system-syslog&#34;</span>
</span></span><span style="display:flex;"><span>2<span style="color:#f92672">)</span> <span style="color:#e6db74">&#34;nginx-log&#34;</span>
</span></span><span style="display:flex;"><span>3<span style="color:#f92672">)</span> <span style="color:#e6db74">&#34;demo&#34;</span>
</span></span><span style="display:flex;"><span>4<span style="color:#f92672">)</span> <span style="color:#e6db74">&#34;system&#34;</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="12">
<li><!-- raw HTML omitted -->可以在任意的一台<!-- raw HTML omitted --><code>ES</code><!-- raw HTML omitted -->中将数据从<!-- raw HTML omitted --><code>redis</code><!-- raw HTML omitted -->读取到<!-- raw HTML omitted --><code>ES</code><!-- raw HTML omitted -->中。
下面咱们在<!-- raw HTML omitted --><code>elk-node2</code><!-- raw HTML omitted -->节点，将数据从<!-- raw HTML omitted --><code>redis</code><!-- raw HTML omitted -->读取到<!-- raw HTML omitted --><code>ES</code><!-- raw HTML omitted -->中：
编写文件：<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat file.conf
</span></span><span style="display:flex;"><span>input <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>redis <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>   type <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;system&#34;</span>
</span></span><span style="display:flex;"><span>   host <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;192.168.1.160&#34;</span>
</span></span><span style="display:flex;"><span>   port <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6379&#34;</span>
</span></span><span style="display:flex;"><span>   db <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6&#34;</span>
</span></span><span style="display:flex;"><span>   data_type <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;list&#34;</span>
</span></span><span style="display:flex;"><span>   key <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;system&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> redis <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>   type <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;es-error&#34;</span>
</span></span><span style="display:flex;"><span>   host <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;192.168.1.160&#34;</span>
</span></span><span style="display:flex;"><span>   port <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6379&#34;</span>
</span></span><span style="display:flex;"><span>   db <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6&#34;</span>
</span></span><span style="display:flex;"><span>   data_type <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;list&#34;</span>
</span></span><span style="display:flex;"><span>   key <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;es-error&#34;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>   redis <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      type <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;nginx-log&#34;</span>
</span></span><span style="display:flex;"><span>      host <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;192.168.1.160&#34;</span>
</span></span><span style="display:flex;"><span>      port <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6379&#34;</span>
</span></span><span style="display:flex;"><span>      db <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6&#34;</span>
</span></span><span style="display:flex;"><span>      data_type <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;list&#34;</span>
</span></span><span style="display:flex;"><span>      key <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;nginx-log&#34;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  redis <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      type <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;system-syslog&#34;</span>
</span></span><span style="display:flex;"><span>      host <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;192.168.1.160&#34;</span>
</span></span><span style="display:flex;"><span>      port <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6379&#34;</span>
</span></span><span style="display:flex;"><span>      db <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6&#34;</span>
</span></span><span style="display:flex;"><span>      data_type <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;list&#34;</span>
</span></span><span style="display:flex;"><span>      key <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;system-syslog&#34;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">}</span>   
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>output <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span>type<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;system&#34;</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    elasticsearch <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>       hosts <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;192.168.1.160:9200&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>       index <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;system-%{+YYYY.MM.dd}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span>type<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;es-error&#34;</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    elasticsearch <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>       hosts <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;192.168.1.160:9200&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>       index <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;es-error-%{+YYYY.MM.dd}&#34;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span>type<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;nginx-log&#34;</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>   elasticsearch <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      hosts <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;192.168.1.160:9200&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>      index <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;nignx-log-%{+YYYY.MM.dd}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span>type<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;system-syslog&#34;</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    elasticsearch <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>       hosts <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;192.168.1.160:9200&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>       index <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;system-syslog-%{+YYYY.MM.dd}&#34;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 执行</span>
</span></span><span style="display:flex;"><span>$ /opt/logstash/bin/logstash -f file.conf --configtest
</span></span><span style="display:flex;"><span>Configuration OK
</span></span><span style="display:flex;"><span>$ /opt/logstash/bin/logstash -f file.conf &amp;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 去redis中检查，发现数据已经被读出到elasticsearch中了、同时登陆logstash和kibana看，发现可以正常收集到日志了。</span>
</span></span><span style="display:flex;"><span>192.168.1.160:6379<span style="color:#f92672">[</span>6<span style="color:#f92672">]</span>&gt; keys *
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>empty list or set<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 可以执行这个 去查看nginx日志、也可以启动多个redis写到ES中，具体根据自己的实际情况而定。</span>
</span></span><span style="display:flex;"><span>$ ab -n10000 -c1 http://192.168.1.160/ </span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          </section>
        </div>
      </main>
    </div>
    <script src="../../../js/clipboard.min.js?1722425299" defer></script>
    <script src="../../../js/perfect-scrollbar.min.js?1722425299" defer></script>
    <script src="../../../js/theme.js?1722425299" defer></script>
  </body>
</html>
