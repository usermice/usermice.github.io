<!DOCTYPE html>
<html lang="en" dir="ltr" itemscope itemtype="http://schema.org/Article">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.125.4">
    <meta name="generator" content="Relearn 6.0.0+tip">
    <meta name="robots" content="noindex, nofollow, noarchive, noimageindex">
    <meta name="description" content="éƒ¨ç½²Kubernetes Etcdï¼šè´Ÿè´£å­˜å‚¨é›†ç¾¤ä¸­å„ç§èµ„æºå¯¹è±¡çš„ä¿¡æ¯
Kubeletï¼šè´Ÿè´£ç»´æŠ¤å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œå³é€šè¿‡æ§åˆ¶Dockerï¼Œæ¥åˆ›å»ºã€æ›´æ–°ã€é”€æ¯å®¹å™¨
KubeProxyï¼šè´Ÿè´£æä¾›é›†ç¾¤å†…éƒ¨çš„æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡
Dockerï¼šè´Ÿè´£èŠ‚ç‚¹ä¸Šå®¹å™¨çš„å„ç§æ“ä½œ
Schedulerï¼šè´Ÿè´£é›†ç¾¤èµ„æºè°ƒåº¦ï¼ŒæŒ‰ç…§é¢„å®šçš„è°ƒåº¦ç­–ç•¥å°†Podè°ƒåº¦åˆ°ç›¸åº”çš„nodeèŠ‚ç‚¹ä¸Š
API Serverï¼šé›†ç¾¤æ“ä½œçš„å”¯ä¸€å…¥å£ï¼Œæ¥æ”¶ç”¨æˆ·è¾“å…¥çš„å‘½ä»¤ï¼Œæä¾›è®¤è¯ã€æˆæƒã€APIæ³¨å†Œå’Œå‘ç°ç­‰æœºåˆ¶
ControllerManagerï¼šè´Ÿè´£ç»´æŠ¤é›†ç¾¤çš„çŠ¶æ€ï¼Œæ¯”å¦‚ç¨‹åºéƒ¨ç½²å®‰æ’ã€æ•…éšœæ£€æµ‹ã€è‡ªåŠ¨æ‰©å±•å’Œæ»šåŠ¨æ›´æ–°ç­‰
Core DNSï¼šå¯ä»¥ä¸ºé›†ç¾¤ä¸­çš„SVCåˆ›å»ºä¸€ä¸ªåŸŸåIPçš„å¯¹åº”å…³ç³»è§£æ">
    <meta name="author" content="äºŒå“¥">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://erge.blog/images/s2-1.png">
    <meta name="twitter:title" content="Install_Kubernetes :: Hugo Relearn Theme">
    <meta name="twitter:description" content="éƒ¨ç½²Kubernetes Etcdï¼šè´Ÿè´£å­˜å‚¨é›†ç¾¤ä¸­å„ç§èµ„æºå¯¹è±¡çš„ä¿¡æ¯
Kubeletï¼šè´Ÿè´£ç»´æŠ¤å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œå³é€šè¿‡æ§åˆ¶Dockerï¼Œæ¥åˆ›å»ºã€æ›´æ–°ã€é”€æ¯å®¹å™¨
KubeProxyï¼šè´Ÿè´£æä¾›é›†ç¾¤å†…éƒ¨çš„æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡
Dockerï¼šè´Ÿè´£èŠ‚ç‚¹ä¸Šå®¹å™¨çš„å„ç§æ“ä½œ
Schedulerï¼šè´Ÿè´£é›†ç¾¤èµ„æºè°ƒåº¦ï¼ŒæŒ‰ç…§é¢„å®šçš„è°ƒåº¦ç­–ç•¥å°†Podè°ƒåº¦åˆ°ç›¸åº”çš„nodeèŠ‚ç‚¹ä¸Š
API Serverï¼šé›†ç¾¤æ“ä½œçš„å”¯ä¸€å…¥å£ï¼Œæ¥æ”¶ç”¨æˆ·è¾“å…¥çš„å‘½ä»¤ï¼Œæä¾›è®¤è¯ã€æˆæƒã€APIæ³¨å†Œå’Œå‘ç°ç­‰æœºåˆ¶
ControllerManagerï¼šè´Ÿè´£ç»´æŠ¤é›†ç¾¤çš„çŠ¶æ€ï¼Œæ¯”å¦‚ç¨‹åºéƒ¨ç½²å®‰æ’ã€æ•…éšœæ£€æµ‹ã€è‡ªåŠ¨æ‰©å±•å’Œæ»šåŠ¨æ›´æ–°ç­‰
Core DNSï¼šå¯ä»¥ä¸ºé›†ç¾¤ä¸­çš„SVCåˆ›å»ºä¸€ä¸ªåŸŸåIPçš„å¯¹åº”å…³ç³»è§£æ">
    <meta property="og:url" content="https://erge.blog/systems/linux/kubernetes/install_kubernetes/">
    <meta property="og:site_name" content="Hugo Relearn Theme">
    <meta property="og:title" content="Install_Kubernetes :: Hugo Relearn Theme">
    <meta property="og:description" content="éƒ¨ç½²Kubernetes Etcdï¼šè´Ÿè´£å­˜å‚¨é›†ç¾¤ä¸­å„ç§èµ„æºå¯¹è±¡çš„ä¿¡æ¯
Kubeletï¼šè´Ÿè´£ç»´æŠ¤å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œå³é€šè¿‡æ§åˆ¶Dockerï¼Œæ¥åˆ›å»ºã€æ›´æ–°ã€é”€æ¯å®¹å™¨
KubeProxyï¼šè´Ÿè´£æä¾›é›†ç¾¤å†…éƒ¨çš„æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡
Dockerï¼šè´Ÿè´£èŠ‚ç‚¹ä¸Šå®¹å™¨çš„å„ç§æ“ä½œ
Schedulerï¼šè´Ÿè´£é›†ç¾¤èµ„æºè°ƒåº¦ï¼ŒæŒ‰ç…§é¢„å®šçš„è°ƒåº¦ç­–ç•¥å°†Podè°ƒåº¦åˆ°ç›¸åº”çš„nodeèŠ‚ç‚¹ä¸Š
API Serverï¼šé›†ç¾¤æ“ä½œçš„å”¯ä¸€å…¥å£ï¼Œæ¥æ”¶ç”¨æˆ·è¾“å…¥çš„å‘½ä»¤ï¼Œæä¾›è®¤è¯ã€æˆæƒã€APIæ³¨å†Œå’Œå‘ç°ç­‰æœºåˆ¶
ControllerManagerï¼šè´Ÿè´£ç»´æŠ¤é›†ç¾¤çš„çŠ¶æ€ï¼Œæ¯”å¦‚ç¨‹åºéƒ¨ç½²å®‰æ’ã€æ•…éšœæ£€æµ‹ã€è‡ªåŠ¨æ‰©å±•å’Œæ»šåŠ¨æ›´æ–°ç­‰
Core DNSï¼šå¯ä»¥ä¸ºé›†ç¾¤ä¸­çš„SVCåˆ›å»ºä¸€ä¸ªåŸŸåIPçš„å¯¹åº”å…³ç³»è§£æ">
    <meta property="og:locale" content="en">
    <meta property="og:type" content="article">
    <meta property="article:section" content="Systems">
    <meta property="article:published_time" content="2024-06-25T02:09:06+08:00">
    <meta property="article:modified_time" content="2024-06-25T02:09:06+08:00">
    <meta property="og:image" content="https://erge.blog/images/s2-1.png">
    <meta itemprop="name" content="Install_Kubernetes :: Hugo Relearn Theme">
    <meta itemprop="description" content="éƒ¨ç½²Kubernetes Etcdï¼šè´Ÿè´£å­˜å‚¨é›†ç¾¤ä¸­å„ç§èµ„æºå¯¹è±¡çš„ä¿¡æ¯
Kubeletï¼šè´Ÿè´£ç»´æŠ¤å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œå³é€šè¿‡æ§åˆ¶Dockerï¼Œæ¥åˆ›å»ºã€æ›´æ–°ã€é”€æ¯å®¹å™¨
KubeProxyï¼šè´Ÿè´£æä¾›é›†ç¾¤å†…éƒ¨çš„æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡
Dockerï¼šè´Ÿè´£èŠ‚ç‚¹ä¸Šå®¹å™¨çš„å„ç§æ“ä½œ
Schedulerï¼šè´Ÿè´£é›†ç¾¤èµ„æºè°ƒåº¦ï¼ŒæŒ‰ç…§é¢„å®šçš„è°ƒåº¦ç­–ç•¥å°†Podè°ƒåº¦åˆ°ç›¸åº”çš„nodeèŠ‚ç‚¹ä¸Š
API Serverï¼šé›†ç¾¤æ“ä½œçš„å”¯ä¸€å…¥å£ï¼Œæ¥æ”¶ç”¨æˆ·è¾“å…¥çš„å‘½ä»¤ï¼Œæä¾›è®¤è¯ã€æˆæƒã€APIæ³¨å†Œå’Œå‘ç°ç­‰æœºåˆ¶
ControllerManagerï¼šè´Ÿè´£ç»´æŠ¤é›†ç¾¤çš„çŠ¶æ€ï¼Œæ¯”å¦‚ç¨‹åºéƒ¨ç½²å®‰æ’ã€æ•…éšœæ£€æµ‹ã€è‡ªåŠ¨æ‰©å±•å’Œæ»šåŠ¨æ›´æ–°ç­‰
Core DNSï¼šå¯ä»¥ä¸ºé›†ç¾¤ä¸­çš„SVCåˆ›å»ºä¸€ä¸ªåŸŸåIPçš„å¯¹åº”å…³ç³»è§£æ">
    <meta itemprop="datePublished" content="2024-06-25T02:09:06+08:00">
    <meta itemprop="dateModified" content="2024-06-25T02:09:06+08:00">
    <meta itemprop="wordCount" content="4742">
    <meta itemprop="image" content="https://erge.blog/images/s2-1.png">
    <title>Install_Kubernetes :: Hugo Relearn Theme</title>
    <link href="../../../../images/favicon.ico?1722425298" rel="icon" type="image/x-icon" sizes="any">
    <link href="../../../../css/fontawesome-all.min.css?1722425299" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="../../../../css/fontawesome-all.min.css?1722425299" rel="stylesheet"></noscript>
    <link href="../../../../css/nucleus.css?1722425299" rel="stylesheet">
    <link href="../../../../css/auto-complete.css?1722425299" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="../../../../css/auto-complete.css?1722425299" rel="stylesheet"></noscript>
    <link href="../../../../css/perfect-scrollbar.min.css?1722425299" rel="stylesheet">
    <link href="../../../../css/fonts.css?1722425299" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="../../../../css/fonts.css?1722425299" rel="stylesheet"></noscript>
    <link href="../../../../css/theme.css?1722425299" rel="stylesheet">
    <link href="../../../../css/theme-relearn-auto.css?1722425299" rel="stylesheet" id="R-variant-style">
    <link href="../../../../css/chroma-relearn-auto.css?1722425299" rel="stylesheet" id="R-variant-chroma-style">
    <link href="../../../../css/variant.css?1722425299" rel="stylesheet">
    <link href="../../../../css/print.css?1722425299" rel="stylesheet" media="print">
    <link href="../../../../css/format-print.css?1722425299" rel="stylesheet">
    <script src="../../../../js/variant.js?1722425299"></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.relBasePath='..\/..\/..\/..';
      window.relearn.relBaseUri='..\/..\/..\/..';
      window.relearn.absBaseUri='https:\/\/erge.blog';
      window.index_js_url="../../../../index.search.js";
      // variant stuff
      window.variants && variants.init( [ 'relearn-auto', 'relearn-light', 'relearn-dark', 'relearn-bright', 'zen-auto', 'zen-light', 'zen-dark', 'retro-auto', 'neon', 'learn', 'blue', 'green', 'red', 'my-branding' ] );
      // translations
      window.T_Copy_to_clipboard = `Copy to clipboard`;
      window.T_Copied_to_clipboard = `Copied to clipboard!`;
      window.T_Copy_link_to_clipboard = `Copy link to clipboard`;
      window.T_Link_copied_to_clipboard = `Copied link to clipboard!`;
      window.T_Reset_view = `Reset view`;
      window.T_View_reset = `View reset!`;
      window.T_No_results_found = `No results found for "{0}"`;
      window.T_N_results_found = `{1} results found for "{0}"`;
    </script>Partial intended to be overwritten to add custom headers, like CSS or any other info
<style>
    
</style>


  </head>
  <body class="mobile-support print disableInlineCopyToClipboard" data-url="../../../../systems/linux/kubernetes/install_kubernetes/">
    <div id="R-body" class="default-animation">
      <div id="R-body-overlay"></div>
      <nav id="R-topbar">
        <div class="topbar-wrapper">
          <div class="topbar-sidebar-divider"></div>
          <div class="topbar-area topbar-area-start" data-area="start">
            <div class="topbar-button topbar-button-sidebar" data-content-empty="show" data-width-s="show" data-width-m="show" data-width-l="show"><button class="topbar-control" onclick="toggleNav()" type="button" title="Menu (CTRL&#43;ALT&#43;n)"><i class="fa-fw fas fa-bars"></i></button>
            </div>



          </div>
          <ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype="http://schema.org/BreadcrumbList"><li
            itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><a itemprop="item" href="../../../../systems/"><span itemprop="name">Systems</span></a><meta itemprop="position" content="1">&nbsp;>&nbsp;</li><li
            itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><a itemprop="item" href="../../../../systems/linux/"><span itemprop="name">Linux</span></a><meta itemprop="position" content="2">&nbsp;>&nbsp;</li><li
            itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><a itemprop="item" href="../../../../systems/linux/kubernetes/"><span itemprop="name">Kubernetes</span></a><meta itemprop="position" content="3">&nbsp;>&nbsp;</li><li
            itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><span itemprop="name">Install_Kubernetes</span><meta itemprop="position" content="4"></li>
          </ol>
          <div class="topbar-area topbar-area-end" data-area="end">


            <div class="topbar-button topbar-button-prev" data-content-empty="show" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="../../../../systems/linux/kubernetes/kubernetes_command/" title="Kubernetes_Command (ğŸ¡)"><i class="fa-fw fas fa-chevron-left"></i></a>
            </div>

            <div class="topbar-button topbar-button-next" data-content-empty="show" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="../../../../systems/linux/kubernetes/install_k8s_rancher/" title="Install_K8s_Rancher (ğŸ¡’)"><i class="fa-fw fas fa-chevron-right"></i></a>
            </div>



          </div>
        </div>
      </nav>
      <div id="R-main-overlay"></div>
      <main id="R-body-inner" class="highlightable default" tabindex="-1">
        <div class="flex-block-wrapper">
          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_kubernetes">Install_Kubernetes</h1>

<h1 id="éƒ¨ç½²kubernetes">éƒ¨ç½²<code>Kubernetes</code></h1>
<blockquote>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<ul>
<li>
<p><code>Etcd</code><!-- raw HTML omitted -->ï¼šè´Ÿè´£å­˜å‚¨é›†ç¾¤ä¸­å„ç§èµ„æºå¯¹è±¡çš„ä¿¡æ¯<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>Kubelet</code><!-- raw HTML omitted -->ï¼šè´Ÿè´£ç»´æŠ¤å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œå³é€šè¿‡æ§åˆ¶<!-- raw HTML omitted --><code>Docker</code><!-- raw HTML omitted -->ï¼Œæ¥åˆ›å»ºã€æ›´æ–°ã€é”€æ¯å®¹å™¨<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>KubeProxy</code><!-- raw HTML omitted -->ï¼šè´Ÿè´£æä¾›é›†ç¾¤å†…éƒ¨çš„æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>Docker</code><!-- raw HTML omitted -->ï¼šè´Ÿè´£èŠ‚ç‚¹ä¸Šå®¹å™¨çš„å„ç§æ“ä½œ<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>Scheduler</code><!-- raw HTML omitted -->ï¼šè´Ÿè´£é›†ç¾¤èµ„æºè°ƒåº¦ï¼ŒæŒ‰ç…§é¢„å®šçš„è°ƒåº¦ç­–ç•¥å°†<code>Pod</code>è°ƒåº¦åˆ°ç›¸åº”çš„<code>node</code>èŠ‚ç‚¹ä¸Š<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>API Server</code><!-- raw HTML omitted -->ï¼šé›†ç¾¤æ“ä½œçš„å”¯ä¸€å…¥å£ï¼Œæ¥æ”¶ç”¨æˆ·è¾“å…¥çš„å‘½ä»¤ï¼Œæä¾›è®¤è¯ã€æˆæƒã€<code>API</code>æ³¨å†Œå’Œå‘ç°ç­‰æœºåˆ¶<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>ControllerManager</code><!-- raw HTML omitted -->ï¼šè´Ÿè´£ç»´æŠ¤é›†ç¾¤çš„çŠ¶æ€ï¼Œæ¯”å¦‚ç¨‹åºéƒ¨ç½²å®‰æ’ã€æ•…éšœæ£€æµ‹ã€è‡ªåŠ¨æ‰©å±•å’Œæ»šåŠ¨æ›´æ–°ç­‰<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>Core DNS</code><!-- raw HTML omitted -->ï¼šå¯ä»¥ä¸ºé›†ç¾¤ä¸­çš„<code>SVC</code>åˆ›å»ºä¸€ä¸ªåŸŸå<code>IP</code>çš„å¯¹åº”å…³ç³»è§£æ<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>Dashboard</code><!-- raw HTML omitted -->ï¼šç»™<code>K8S</code>é›†ç¾¤æä¾›ä¸€ä¸ª<code>B/S</code>ç»“æ„çš„ä½“ç³»è®¿é—®<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>Ingress Controller</code><!-- raw HTML omitted -->ï¼šå®˜æ–¹åªèƒ½å®ç°å››å±‚ä»£ç†ï¼Œ<code>Ingress</code>å¯ä»¥å®ç°ä¸ƒå±‚ä»£ç†<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>Fedetation</code><!-- raw HTML omitted -->ï¼šæä¾›ä¸€ä¸ªå¯ä»¥è·¨é›†ç¾¤ä¸­å¿ƒçš„å¤š<code>K8S</code>ç»Ÿä¸€ç®¡ç†åŠŸèƒ½<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>Prometheus</code><!-- raw HTML omitted -->ï¼šæä¾›ä¸€ä¸ª<code>K8S</code>é›†ç¾¤ç›‘æ§èƒ½åŠ›<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>ELK</code><!-- raw HTML omitted -->ï¼šæä¾›<code>K8S</code>é›†ç¾¤æ—¥å¿—ç»Ÿä¸€åˆ†æä»‹å…¥å¹³å°<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>K8S</code>éƒ¨ç½²æ–¹å¼åˆ†ä¸º<!-- raw HTML omitted -->äºŒè¿›åˆ¶<!-- raw HTML omitted -->ä»¥åŠ<!-- raw HTML omitted -->å¿«é€Ÿéƒ¨ç½²<!-- raw HTML omitted -->æ–¹å¼ï¼Œå®˜æ–¹ç»™äºˆ<!-- raw HTML omitted -->ä¸‰ç§å¿«é€Ÿéƒ¨ç½²<!-- raw HTML omitted -->æ–¹å¼ï¼š<a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/" rel="external" target="_self">ä½¿ç”¨<code>kubeadm</code>å¼•å¯¼é›†ç¾¤</a>ã€<a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kops/" rel="external" target="_self">ä½¿ç”¨<code>Kops</code>å®‰è£…<code>Kubernetes</code></a>ã€<a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubespray/" rel="external" target="_self">ä½¿ç”¨<code>Kubespray</code>å®‰è£…<code>Kubernetes</code></a></p>
</li>
</ul>
<table>
<thead>
<tr>
<th>åç§°åœ°å€</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/kubewharf" rel="external" target="_self"><code>KubeWharf</code>è½»é‡çº§å¤šç§Ÿæˆ·</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/kubernetes/perf-tests" rel="external" target="_self"><code>Kubernetes</code>æ€§èƒ½æµ‹è¯•</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://learnk8s.io/a/a-visual-guide-on-troubleshooting-kubernetes-deployments/troubleshooting-kubernetes.en_en.v3.pdf" rel="external" target="_self"><code>kubernetes</code>æ’é”™æ€ç»´</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://kubespray.io/#/docs/getting-started" rel="external" target="_self"><code>Ansible-playbook</code>ä½¿ç”¨<code>kubespray</code>å®‰è£…<code>K8S</code></a></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<h2 id="æœåŠ¡å™¨ç«¯å£å‡†å¤‡">æœåŠ¡å™¨ã€ç«¯å£å‡†å¤‡</h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->éƒ¨ç½²ä¸€ä¸»ä¸‰ä»<!-- raw HTML omitted --><code>kubernetes</code>æ¶æ„</li>
</ol>
</li>
</ul>
<blockquote>

<pre class="mermaid align-center zoomable">graph TD
F[ä¸€ä¸»å¤šä»] 
A{{K8S-Master}} ==&gt; B{{K8S-Nodes}}
A{{K8S-Master}} ==&gt; C{{K8S-Nodes}}
A{{K8S-Master}} ==&gt; D{{K8S-Nodes}}
Z[å¤šä¸»å¤šä»]
G{{K8S-Master}} ==&gt; J{{K8S-Nodes}}
G{{K8S-Master}} ==&gt; K{{K8S-Nodes}}
G{{K8S-Master}} ==&gt; L{{K8S-Nodes}}
H{{K8S-Master}} ==&gt; J{{K8S-Nodes}}
H{{K8S-Master}} ==&gt; K{{K8S-Nodes}}
H{{K8S-Master}} ==&gt; L{{K8S-Nodes}} </pre><table>
<thead>
<tr>
<th>è§’è‰²</th>
<th><code>IP</code>åœ°å€</th>
<th>é…ç½®</th>
<th>æ“ä½œç³»ç»Ÿ</th>
</tr>
</thead>
<tbody>
<tr>
<td>Master</td>
<td>192.168.35.128</td>
<td><code>2coreã€4Gã€80Gdisk</code></td>
<td><code>CentOS Linux release 7.9.2</code></td>
</tr>
<tr>
<td>node-1</td>
<td>192.168.35.129</td>
<td><code>2coreã€1Gã€60Gdisk</code></td>
<td><code>CentOS Linux release 7.9.2</code></td>
</tr>
<tr>
<td>node-2</td>
<td>192.168.35.130</td>
<td><code>2coreã€1Gã€60Gdisk</code></td>
<td><code>CentOS Linux release 7.9.2</code></td>
</tr>
</tbody>
</table>
<ul>
<li><!-- raw HTML omitted -->é›†ç¾¤æ¶æ„<!-- raw HTML omitted --></li>
</ul>
<table>
<thead>
<tr>
<th>è§’è‰²</th>
<th><code>IP</code>åœ°å€</th>
<th>é…ç½®</th>
<th>æ“ä½œç³»ç»Ÿ</th>
</tr>
</thead>
<tbody>
<tr>
<td>Master-1</td>
<td>192.168.80.210</td>
<td><code>2coreã€4Gã€80Gdisk</code></td>
<td><code>CentOS Linux release 7.9.2</code></td>
</tr>
<tr>
<td>Master-2</td>
<td>192.168.80.211</td>
<td><code>2coreã€4Gã€80Gdisk</code></td>
<td><code>CentOS Linux release 7.9.2</code></td>
</tr>
<tr>
<td>node-1</td>
<td>192.168.80.212</td>
<td><code>2coreã€2Gã€60Gdisk</code></td>
<td><code>CentOS Linux release 7.9.2</code></td>
</tr>
<tr>
<td>node-2</td>
<td>192.168.80.213</td>
<td><code>2coreã€2Gã€60Gdisk</code></td>
<td><code>CentOS Linux release 7.9.2</code></td>
</tr>
<tr>
<td>node-3</td>
<td>192.168.80.215</td>
<td><code>2coreã€2Gã€60Gdisk</code></td>
<td><code>CentOS Linux release 7.9.2</code></td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->æ§åˆ¶èŠ‚ç‚¹<!-- raw HTML omitted --><code>master</code>ï¼šé›†ç¾¤çš„æ§åˆ¶å¹³é¢ï¼Œè´Ÿè´£é›†ç¾¤çš„å†³ç­–ï¼Œä»¥åŠéœ€è¦å¼€æ”¾çš„ç«¯å£</li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>åè®®</th>
<th>æ–¹å‘</th>
<th>ç«¯å£èŒƒå›´</th>
<th>ä½œç”¨</th>
<th>ä½¿ç”¨è€…</th>
</tr>
</thead>
<tbody>
<tr>
<td>TCP</td>
<td>å…¥ç«™</td>
<td>6443</td>
<td><code>Kubernetes API</code> æœåŠ¡å™¨</td>
<td>æ‰€æœ‰ç»„ä»¶,ç®¡ç†å‘˜æ“ä½œ<code>Kubernetes</code>çš„æ¥å£ã€‚å› æ­¤ï¼Œ<code>API</code>æœåŠ¡å™¨é€šå¸¸æš´éœ²åœ¨æ§åˆ¶å¹³é¢ä¹‹å¤–ã€‚<code>API</code>æœåŠ¡å™¨è¢«è®¾è®¡æˆå¯æ‰©å±•çš„ï¼Œå¯èƒ½å­˜åœ¨äºå¤šä¸ªæ§åˆ¶å¹³é¢èŠ‚ç‚¹ä¸Š</td>
</tr>
<tr>
<td>TCP</td>
<td>å…¥ç«™</td>
<td>2379-2380</td>
<td><code>etcd</code>æœåŠ¡å™¨å®¢æˆ·ç«¯ <code>API</code></td>
<td><code>kube-apiserver, etcd</code>ï¼ŒæŒä¹…åŒ–çš„å¤‡ä»½å­˜å‚¨ï¼Œå…³äºé›†ç¾¤çŠ¶æ€çš„æ‰€æœ‰ä¿¡æ¯éƒ½ä¿å­˜åœ¨è¿™é‡Œã€‚<code>Etcd</code>ä¸åº”è¯¥è¢«ç›´æ¥æ“ä½œï¼Œè€Œåº”è¯¥é€šè¿‡ <code>API</code> æœåŠ¡å™¨æ¥ç®¡ç†ã€‚</td>
</tr>
<tr>
<td>TCP</td>
<td>å…¥ç«™</td>
<td>10250</td>
<td><code>Kubelet API</code></td>
<td><code>kubelet</code>è‡ªèº«ã€åœ¨æ¯ä¸ªå·¥ä½œèŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œä»¥åè°ƒå’ŒéªŒè¯<code>Pod</code>çš„æ‰§è¡Œ</td>
</tr>
<tr>
<td>TCP</td>
<td>å…¥ç«™</td>
<td>10259</td>
<td><code>kube-scheduler</code></td>
<td><code>kube-scheduler</code>è‡ªèº«ï¼Œè·Ÿè¸ªå·¥ä½œèŠ‚ç‚¹çš„çŠ¶æ€å¹¶å†³å®šåœ¨å“ªé‡Œè¿è¡Œ Podã€‚<code>Kube-scheduler</code> åªå¯ä»¥ç”±æ§åˆ¶å¹³é¢å†…çš„èŠ‚ç‚¹è®¿é—®ã€‚</td>
</tr>
<tr>
<td>TCP</td>
<td>å…¥ç«™</td>
<td>10257</td>
<td><code>kube-controller-manager</code></td>
<td><code>kube-controller-manager</code>è‡ªèº«ï¼Œç›‘è§†<code>Kubernetes</code>é›†ç¾¤ï¼Œä»¥æ£€æµ‹å’Œç»´æŠ¤<code>Kubernetes</code>ç¯å¢ƒçš„å‡ ä¸ªæ–¹é¢ï¼ŒåŒ…æ‹¬å°†<code>Pod</code>åŠ å…¥åˆ°æœåŠ¡ä¸­ï¼Œä¿æŒä¸€ç»„<code>Pod</code>çš„æ­£ç¡®æ•°é‡ï¼Œå¹¶å¯¹èŠ‚ç‚¹çš„ä¸¢å¤±åšå‡ºååº”</td>
</tr>
<tr>
<td>TCP</td>
<td>å…¥ç«™</td>
<td>10258</td>
<td><code>Cloud controller manager</code></td>
<td>ä¸€ä¸ªç”¨äºåŸºäºäº‘çš„éƒ¨ç½²çš„å¯é€‰ç»„ä»¶ã€‚äº‘æ§åˆ¶å™¨ä¸äº‘æœåŠ¡æä¾›å•†æ¥å£ï¼Œä»¥ç®¡ç†é›†ç¾¤çš„è´Ÿè½½å‡è¡¡å™¨å’Œè™šæ‹Ÿç½‘ç»œ</td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->å·¥ä½œèŠ‚ç‚¹<!-- raw HTML omitted --><code>node</code>ï¼šé›†ç¾¤çš„æ•°æ®å¹³é¢ï¼Œè´Ÿè´£ä¸ºå®¹å™¨æä¾›è¿è¡Œç¯å¢ƒ ï¼Œéœ€è¦å¼€æ”¾çš„ç«¯å£</li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>åè®®</th>
<th>æ–¹å‘</th>
<th>ç«¯å£èŒƒå›´</th>
<th>ä½œç”¨</th>
<th>ä½¿ç”¨è€…</th>
</tr>
</thead>
<tbody>
<tr>
<td>TCP</td>
<td>å…¥ç«™</td>
<td>10250</td>
<td><code>Kubelet API</code></td>
<td><code>kubelet</code>è‡ªèº«ã€æ§åˆ¶å¹³é¢ç»„ä»¶</td>
</tr>
<tr>
<td>TCP</td>
<td>å…¥ç«™</td>
<td>30000-32767</td>
<td><code>NodePort</code>æœåŠ¡â€ </td>
<td>æ‰€æœ‰ç»„ä»¶</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h3 id="åˆå§‹åŒ–ç¯å¢ƒ">åˆå§‹åŒ–ç¯å¢ƒ</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->è®¾ç½®ä¸‰å°ä¸»æœºå<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ hostnamectl set-hostname k8s-master-128
</span></span><span style="display:flex;"><span>$ hostnamectl set-hostname k8s-node-01-129
</span></span><span style="display:flex;"><span>$ hostnamectl set-hostname k8s-node-02-130</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->è®¾ç½®é›†ç¾¤çš„ä¸»æœºå<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ hostnamectl set-hostname k8s-master-1-80-210
</span></span><span style="display:flex;"><span>$ hostnamectl set-hostname k8s-master-2-80-211
</span></span><span style="display:flex;"><span>$ hostnamectl set-hostname k8s-node-1-80-212
</span></span><span style="display:flex;"><span>$ hostnamectl set-hostname k8s-node-2-80-213
</span></span><span style="display:flex;"><span>$ hostnamectl set-hostname k8s-node-3-80-215</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->åˆ†åˆ«åœ¨ä¸‰å°æœåŠ¡å™¨åšæœ¬åœ°<!-- raw HTML omitted --><code>hosts</code><!-- raw HTML omitted -->è§£æ<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;&gt;/etc/hosts<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.35.128 k8s-master-01
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.35.129 k8s-node-01
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.35.130 k8s-node-02
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->äº”å°æœåŠ¡å™¨çš„é›†ç¾¤<!-- raw HTML omitted --><code>hosts</code><!-- raw HTML omitted -->é…ç½®<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;&gt;/etc/hosts<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.80.210 k8s-master-01
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.80.211 k8s-master-02
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.80.212 k8s-node-01
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.80.213 k8s-node-02
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.80.215 k8s-node-03
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.80.220 k8s-master-lb # VIP(è™šæ‹ŸIP)ç”¨äºLoadBalanceï¼Œå¦‚æœä¸æ˜¯é«˜å¯ç”¨é›†ç¾¤ï¼Œè¯¥IPå¯ä»¥æ˜¯k8s-master01çš„IP 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->è®¾ç½®æ—¶é—´åŒæ­¥ï¼Œä¿®æ”¹æ—¶åŒºä¸¤ç§æ–¹å¼<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->å®‰è£…<!-- raw HTML omitted --><code>tzdata</code><!-- raw HTML omitted -->æ—¶åŒºè½¯ä»¶åŒ…<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install tzdata 
</span></span><span style="display:flex;"><span>$ timedatectl set-timezone Asia/Shanghai</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->ç¬¬ä¸€ç§<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->ç¬¬äºŒç§<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl enable chronyd.service <span style="color:#f92672">&amp;&amp;</span> systemctl start chronyd.service</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->å…³é—­é˜²ç«å¢™å¹¶ç¦æ­¢å¼€æœºè‡ªå¯<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl disable firewalld <span style="color:#f92672">&amp;&amp;</span> systemctl stop firewalld</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->å…³é—­<!-- raw HTML omitted --><code>SElinux</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ setenforce <span style="color:#ae81ff">0</span>  	<span style="color:#75715e"># ä¸´æ—¶å…³é—­Selinux</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s/^SELINUX=.*/SELINUX=disabled/&#39;</span> /etc/selinux/config  	<span style="color:#75715e"># æ°¸ä¹…å…³é—­Selinux</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="6">
<li><!-- raw HTML omitted -->å…³é—­<!-- raw HTML omitted --><code>swap</code><!-- raw HTML omitted -->äº¤æ¢åˆ†åŒº<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sed -ri <span style="color:#e6db74">&#39;s/.*swap.*/#&amp;/&#39;</span> /etc/fstab <span style="color:#f92672">&amp;&amp;</span> swapoff -a</span></span></code></pre></div><ul>
<li><code>Ubunt</code><!-- raw HTML omitted -->å…³é—­äº¤æ¢åˆ†åŒº<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;etc/fstab<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/dev/disk/by-uuid/95e38332-76fc-4d2f-81a4-04bc581f2ed3 none swap sw,noauto 0 0  	# æ·»åŠ ï¼šnoauto
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># /swap.img     none    swap    sw      0       0  	# æ·»åŠ æ³¨é‡Š
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥è¯¢éªŒè¯ï¼Œè¾“å‡ºä¸ºç©ºåˆ™ç”Ÿæ•ˆ</span>
</span></span><span style="display:flex;"><span>$ sudo swapon --show</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="7">
<li>å…è®¸<code>iptables</code><!-- raw HTML omitted -->æ£€æŸ¥æ¡¥æ¥æµé‡<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->ç¡®ä¿<!-- raw HTML omitted --><code>br_netfilter</code><!-- raw HTML omitted -->æ¨¡å—è¢«åŠ è½½ã€‚è¿™ä¸€æ“ä½œå¯ä»¥é€šè¿‡è¿è¡Œ<!-- raw HTML omitted --><code>lsmod | grep br_netfilter</code><!-- raw HTML omitted -->æ¥å®Œæˆã€‚è‹¥è¦æ˜¾å¼åŠ è½½è¯¥æ¨¡å—ï¼Œå¯æ‰§è¡Œ<!-- raw HTML omitted --><code>modprobe br_netfilter</code></li>
<li><!-- raw HTML omitted -->ä¸ºäº†è®©ä½ çš„<!-- raw HTML omitted --><code>Linux</code><!-- raw HTML omitted -->èŠ‚ç‚¹ä¸Šçš„<!-- raw HTML omitted --><code>iptables</code><!-- raw HTML omitted -->èƒ½å¤Ÿæ­£ç¡®åœ°æŸ¥çœ‹æ¡¥æ¥æµé‡ï¼Œä½ éœ€è¦ç¡®ä¿åœ¨ä½ çš„<!-- raw HTML omitted --><code>sysctl</code><!-- raw HTML omitted -->é…ç½®ä¸­å°†<!-- raw HTML omitted --><code>net.bridge.bridge-nf-call-iptables</code><!-- raw HTML omitted -->è®¾ç½®ä¸º 1<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat <span style="color:#e6db74">&lt;&lt;EOF | sudo tee /etc/modules-load.d/k8s.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">br_netfilter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat <span style="color:#e6db74">&lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.bridge.bridge-nf-call-iptables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.ip_forward = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sysctl --system
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##########################################################  ä½¿ç”¨è„šæœ¬å‡½æ•°</span>
</span></span><span style="display:flex;"><span>__k8s_kernel_iptables<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># åŠ è½½br_netfilteræ¨¡å—</span>
</span></span><span style="display:flex;"><span>    modprobe br_netfilter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># æŸ¥çœ‹æ˜¯å¦åŠ è½½</span>
</span></span><span style="display:flex;"><span>    lsmod | grep br_netfilter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># å†™å†…æ ¸é…ç½®æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>    cat &gt;/etc/sysctl.d/k8s.conf <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.bridge.bridge-nf-call-iptables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.ip_forward = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">vm.swappiness = 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># å†…æ ¸å‚æ•°ç”Ÿæ•ˆ</span>
</span></span><span style="display:flex;"><span>    sysctl --system
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>__k8s_kernel_iptables</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="8">
<li><!-- raw HTML omitted -->å¼€å¯<!-- raw HTML omitted --><code>ipvs</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>åœ¨<code>kubernetes</code>ä¸­<code>service</code>æœ‰ä¸¤ç§ä»£ç†æ¨¡å‹ï¼Œä¸€ç§æ˜¯åŸºäº<code>iptables</code>ï¼Œå¦ä¸€ç§æ˜¯åŸºäº<code>ipvs</code>çš„ã€‚<code>ipvs</code>çš„æ€§èƒ½è¦é«˜äº<code>iptables</code>çš„ï¼Œä½†æ˜¯å¦‚æœè¦ä½¿ç”¨å®ƒï¼Œéœ€è¦æ‰‹åŠ¨è½½å…¥<code>ipvs</code>æ¨¡å—ã€‚</li>
<li><code>Centos</code><!-- raw HTML omitted -->ç³»ç»Ÿåœ¨æ¯ä¸ªèŠ‚ç‚¹å®‰è£…é…ç½®<!-- raw HTML omitted --><code>ipset</code>å’Œ<code>ipvsadm</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install ipset ipvsadm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åœ¨æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œå¦‚ä¸‹è„šæœ¬</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/etc/sysconfig/modules/ipvs.modules<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_rr
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_wrr
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- nf_conntrack_ipv4  	# é«˜ç‰ˆæœ¬æ›¿æ¢ä¸ºnf_conntrack
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æˆæƒã€è¿è¡Œã€æ£€æŸ¥æ˜¯å¦åŠ è½½</span>
</span></span><span style="display:flex;"><span>$ chmod <span style="color:#ae81ff">755</span> /etc/sysconfig/modules/ipvs.modules <span style="color:#f92672">&amp;&amp;</span> bash /etc/sysconfig/modules/ipvs.modules
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ£€æŸ¥æ˜¯å¦åŠ è½½</span>
</span></span><span style="display:flex;"><span>$ lsmod | grep -e ipvs -e nf_conntrack_ipv4</span></span></code></pre></div><ul>
<li><code>Debian</code><!-- raw HTML omitted -->ç³»ç»Ÿåœ¨æ¯ä¸ªèŠ‚ç‚¹å®‰è£…é…ç½®<!-- raw HTML omitted --><code>ipset</code>å’Œ<code>ipvsadm</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -vp /etc/modules.d/
</span></span><span style="display:flex;"><span>$ tee /etc/modules.d/k8s.modules <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># netfilter æ¨¡å— å…è®¸ iptables æ£€æŸ¥æ¡¥æ¥æµé‡
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- br_netfilter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># containerd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- overlay
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># nf_conntrack
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- nf_conntrack
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ipvs
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_lc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_lblc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_lblcr
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_rr
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_wrr
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_dh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_fo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_nq
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_sed
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_ftp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_tables
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_set
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ipt_set
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ipt_rpfilter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ipt_REJECT
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ipip
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- xt_set
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ chmod <span style="color:#ae81ff">755</span> /etc/modules.d/k8s.modules <span style="color:#f92672">&amp;&amp;</span> bash /etc/modules.d/k8s.modules <span style="color:#f92672">&amp;&amp;</span> lsmod | grep -e ip_vs -e nf_conntrack  
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ip_vs_sh               16384  0  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ip_vs_wrr              16384  0  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ip_vs_rr               16384  0  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ip_vs                 155648  6 ip_vs_rr,ip_vs_sh,ip_vs_wrr  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># nf_conntrack          139264  1 ip_vs  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># nf_defrag_ipv6         24576  2 nf_conntrack,ip_vs  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># nf_defrag_ipv4         16384  1 nf_conntrack  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># libcrc32c              16384  5 nf_conntrack,btrfs,xfs,raid456,ip_vs</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sysctl --system</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="9">
<li><!-- raw HTML omitted -->æ‰€æœ‰èŠ‚ç‚¹é…ç½®<!-- raw HTML omitted --><code>Limit</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ulimit -SHn <span style="color:#ae81ff">65536</span>  	<span style="color:#75715e"># ä¸´æ—¶ç”Ÿæ•ˆ</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* soft nproc 65535  	# soft è½¯é™åˆ¶
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* hard nproc 65535  	# hard ç¡¬é™åˆ¶
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* soft nofile 25535
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* hard nofile 25535
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* soft memlock unlimited
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* soft memlock unlimited &#34;</span> &gt;&gt;/etc/security/limits.conf  	<span style="color:#75715e"># æ°¸ä¹…ç”Ÿæ•ˆ</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="10">
<li><code>k8s-master01</code><!-- raw HTML omitted -->èŠ‚ç‚¹è®¾ç½®å…å¯†ç™»å½•å…¶ä»–èŠ‚ç‚¹<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>ssh-keygen</code><!-- raw HTML omitted -->ï¼šç”¨äºåˆ›å»ºå¯†é’¥çš„ç¨‹åº<!-- raw HTML omitted --></li>
<li><code>-m PEM</code><!-- raw HTML omitted -->ï¼šå°†å¯†é’¥çš„æ ¼å¼è®¾ä¸º<!-- raw HTML omitted --><code>PEM</code></li>
<li><code>-t rsa</code><!-- raw HTML omitted -->ï¼šåˆ›å»ºå¯†é’¥ç±»å‹ä¸ºï¼š<code>RSA</code>æ ¼å¼ï¼Œç³»ç»Ÿé»˜è®¤æä¾›åä¸º <code>id_rsa</code> çš„å¯†é’¥å¯¹ï¼Œæœ‰äº›å·¥å…·å¯èƒ½è¦æ±‚ç§é’¥æ–‡ä»¶åä¸º<!-- raw HTML omitted --><code>id_rsa</code></li>
<li><code>-b 4096</code><!-- raw HTML omitted -->ï¼šå¯†é’¥çš„ä½æ•°ï¼Œæœ¬ä¾‹ä¸­ä¸º<!-- raw HTML omitted --><code>4096</code></li>
<li><code>-C &quot;xxx@myserver&quot;</code><!-- raw HTML omitted -->ï¼šè¿½åŠ åˆ°å…¬é’¥æ–‡ä»¶æœ«å°¾ä»¥ä¾¿äºè¯†åˆ«çš„æ³¨é‡Šã€‚ é€šå¸¸ä»¥ç”µå­é‚®ä»¶åœ°å€ç”¨ä½œæ³¨é‡Šï¼Œä½†ä¹Ÿå¯ä»¥ä½¿ç”¨ä»»ä½•æœ€é€‚åˆä½ åŸºç¡€ç»“æ„çš„äº‹ç‰©<!-- raw HTML omitted --></li>
<li><code>-f ~/.ssh/</code><!-- raw HTML omitted -->ï¼šç§é’¥æ–‡ä»¶çš„æ–‡ä»¶åï¼ˆå¦‚æœé€‰æ‹©ä¸ä½¿ç”¨é»˜è®¤åç§°ï¼‰ã€‚ è¿½åŠ äº†<code>.pub</code>çš„ç›¸åº”å…¬é’¥æ–‡ä»¶åœ¨ç›¸åŒç›®å½•ä¸­ç”Ÿæˆã€‚ è¯¥ç›®å½•å¿…é¡»å­˜åœ¨<!-- raw HTML omitted --></li>
<li><code>-N mypassphrase</code><!-- raw HTML omitted -->ï¼šç”¨äºè®¿é—®ç§é’¥æ–‡ä»¶çš„å…¶ä»–å¯†ç <!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ssh-keygen <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-m PEM <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-t rsa <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-b <span style="color:#ae81ff">4096</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-C <span style="color:#e6db74">&#34;xxx@163.com&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-f ~/.ssh/name_rsa <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-N mypassphrase
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ <span style="color:#66d9ef">for</span> i in master-01 master-02 noder-01 noder-02 noder-03;<span style="color:#66d9ef">do</span> ssh-copy-id -i .ssh/id_rsa.pub $i;<span style="color:#66d9ef">done</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="11">
<li><!-- raw HTML omitted -->æ‰€æœ‰èŠ‚ç‚¹æ›´æ–°ç³»ç»Ÿå¹¶ä¸”é‡å¯<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y --exclude<span style="color:#f92672">=</span>kernel* update <span style="color:#f92672">&amp;&amp;</span> reboot</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="12">
<li><!-- raw HTML omitted -->å‡çº§ç³»ç»Ÿ<!-- raw HTML omitted --><code>Kernel</code>å†…æ ¸åˆ°<code>4.18+</code>ä»¥ä¸Š</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org
</span></span><span style="display:flex;"><span>$ rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä»¤åˆ—å‡ºå¯ç”¨çš„å†…æ ¸ç›¸å…³åŒ…</span>
</span></span><span style="display:flex;"><span>$ yum --disablerepo<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;*&#34;</span> --enablerepo<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;elrepo-kernel&#34;</span> list available
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å®‰è£…æœ€æ–°ä¸»çº¿ç¨³å®šå†…æ ¸</span>
</span></span><span style="display:flex;"><span>$ yum -y --enablerepo<span style="color:#f92672">=</span>elrepo-kernel install kernel-ml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è®¾ç½® GRUB é»˜è®¤çš„å†…æ ¸ç‰ˆæœ¬ï¼š</span>
</span></span><span style="display:flex;"><span>$ vim /etc/default/grub
</span></span><span style="display:flex;"><span>GRUB_DEFAULT<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>  	<span style="color:#75715e"># ä¿®æ”¹éƒ¨åˆ†ï¼Œ GRUB åˆå§‹åŒ–é¡µé¢çš„ç¬¬ä¸€ä¸ªå†…æ ¸å°†ä½œä¸ºé»˜è®¤å†…æ ¸</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># é‡æ–°åˆ›å»ºå†…æ ¸é…ç½®</span>
</span></span><span style="display:flex;"><span>$ grub2-mkconfig -o /boot/grub2/grub.cfg
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ reboot</span></span></code></pre></div></blockquote>
<hr>
<h3 id="æ‰€æœ‰èŠ‚ç‚¹éƒ½å®‰è£…docker">æ‰€æœ‰èŠ‚ç‚¹éƒ½å®‰è£…<code>docker</code></h3>
<ul>
<li>
<ol>
<li><code>yum</code><!-- raw HTML omitted -->æºçš„ä½¿ç”¨<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->ä½¿ç”¨å®˜æ–¹æº <!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum install -y yum-utils
</span></span><span style="display:flex;"><span>$ yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->ä½¿ç”¨é˜¿é‡Œäº‘å®˜æ–¹<code>repo</code>æº<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># å¤‡ä»½æœåŠ¡å™¨ä¸ŠåŸæœ‰çš„CentOS-Baseå’Œepel</span>
</span></span><span style="display:flex;"><span>$ mv /etc/yum.repos.d/CentOS-Base.repo<span style="color:#f92672">{</span>,.bak<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>$ mv /etc/yum.repos.d/epel.repo<span style="color:#f92672">{</span>,.bak<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å®‰è£…CentOS0-Baseå’Œepelæº </span>
</span></span><span style="display:flex;"><span>$ curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo
</span></span><span style="display:flex;"><span>$ curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç¬¬ä¸€ç§æ–¹å¼å®‰è£…docker æº  </span>
</span></span><span style="display:flex;"><span>$ wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç¬¬äºŒç§æ–¹å¼dockeræº</span>
</span></span><span style="display:flex;"><span>$ yum install -y yum-utils device-mapper-persistent-data lvm2
</span></span><span style="display:flex;"><span>$ yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åšæ›¿æ¢</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s+download.docker.com+mirrors.aliyun.com/docker-ce+&#39;</span> /etc/yum.repos.d/docker-ce.repo</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->å¸è½½æœåŠ¡å™¨è‡ªå¸¦<!-- raw HTML omitted --><code>docker</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->å®‰è£…å¯¹åº”<code>docker</code>ç‰ˆæœ¬æœåŠ¡<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum makecache fast
</span></span><span style="display:flex;"><span>$ yum list docker-ce  --showduplicates|sort -r
</span></span><span style="display:flex;"><span>$ yum install -y docker-ce-20.10.4 docker-ce-cli-20.10.4 containerd.io docker-compose-plugin
</span></span><span style="display:flex;"><span>$ systemctl enable docker <span style="color:#f92672">&amp;&amp;</span> systemctl start docker</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->å®‰è£…<!-- raw HTML omitted --><code>docker-compose</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo curl -L <span style="color:#e6db74">&#34;https://github.com/docker/compose/releases/download/v2.2.2/docker-compose-</span><span style="color:#66d9ef">$(</span>uname -s<span style="color:#66d9ef">)</span><span style="color:#e6db74">-</span><span style="color:#66d9ef">$(</span>uname -m<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> -o /usr/local/bin/docker-compose
</span></span><span style="display:flex;"><span>$ chmod +x /usr/local/bin/docker-compose
</span></span><span style="display:flex;"><span>$ ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose
</span></span><span style="display:flex;"><span>$ docker compose COMMAND --help  	<span style="color:#75715e"># æŸ¥çœ‹é•œåƒç¼–å†™æ–¹å¼</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="6">
<li><code>Kubernetes</code><!-- raw HTML omitted -->æ–‡ä»¶é©±åŠ¨é»˜è®¤ç”±<!-- raw HTML omitted --><code>systemd</code><!-- raw HTML omitted -->æ”¹æˆ<!-- raw HTML omitted --><code>cgroupfs</code><!-- raw HTML omitted -->, è€Œæˆ‘ä»¬å®‰è£…çš„<!-- raw HTML omitted --><code>docker</code><!-- raw HTML omitted -->ä½¿ç”¨çš„æ–‡ä»¶é©±åŠ¨æ˜¯<!-- raw HTML omitted --><code>systemd</code><!-- raw HTML omitted -->, é€ æˆä¸ä¸€è‡´, å¯¼è‡´é•œåƒæ— æ³•å¯åŠ¨<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>&quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo cat &gt;/etc/docker/daemon.json<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;registry-mirrors&#34;: [&#34;https://bn4ll166.mirror.aliyuncs.com&#34;],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;data-root&#34;: &#34;/data/docker-root&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;dns&#34;: [&#34;223.5.5.5&#34;,&#34;119.29.29.29&#34;],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;bip&#34;: &#34;172.31.255.254/16&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;storage-driver&#34;: &#34;overlay2&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;storage-opts&#34;: [&#34;overlay2.override_kernel_check=true&#34;],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;userland-proxy&#34;: false,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;log-driver&#34;: &#34;json-file&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;log-opts&#34;: {&#34;max-size&#34;: &#34;500m&#34;,&#34;max-file&#34;: &#34;1&#34;},
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;exec-opts&#34;: [&#34;native.cgroupdriver=systemd&#34;],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;live-restore&#34;: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="7">
<li><a href="https://www.qikqiak.com/k8s-book/docs/1.%E8%AF%BE%E7%A8%8B%E4%BB%8B%E7%BB%8D.html" rel="external" target="_self"><code>Docker</code>+<code>Kubernetes</code></a></li>
</ol>
</li>
</ul>
<hr>
<h3 id="æ‰€æœ‰èŠ‚ç‚¹é…ç½®kubernetes-yumæº">æ‰€æœ‰èŠ‚ç‚¹é…ç½®<code>kubernetes yum</code>æº</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->å›½å†…ä¿®æ”¹ä¸ºé˜¿é‡Œäº‘<code>yum</code>æº <!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/yum.repos.d/kubernetes.repo<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[kubernetes]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name=Kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">enabled=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgcheck=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">repo_gpgcheck=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->ç›´æ¥ä½¿ç”¨<code>kubernetes</code>å®˜æ–¹<code>yum</code>æº<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat <span style="color:#e6db74">&lt;&lt;-EOF | sudo tee /etc/yum.repos.d/kubernetes.repo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[kubernetes]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name=Kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\$basearch
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">enabled=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgcheck=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">exclude=kubelet kubeadm kubectl
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->é‡å¯æ‰€æœ‰èŠ‚ç‚¹æœåŠ¡å™¨<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ reboot</span></span></code></pre></div></blockquote>
<hr>
<h3 id="æ‰€æœ‰èŠ‚ç‚¹éƒ½å®‰è£…kubeadmkubeletkubectl">æ‰€æœ‰èŠ‚ç‚¹éƒ½å®‰è£…<code>kubeadmã€kubeletã€kubectl</code></h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum list kubelet kubeadm kubectl  --showduplicates | sort -r
</span></span><span style="display:flex;"><span>$ yum -y install kubelet-1.24.5 kubeadm-1.24.5 kubectl-1.24.5</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol>
<li><code>--cgroup-driver=systemd</code><!-- raw HTML omitted -->ï¼šä¸ºäº†å®ç°<!-- raw HTML omitted --><code>Docker</code><!-- raw HTML omitted -->ä½¿ç”¨çš„<!-- raw HTML omitted --><code>cgroup drvier</code><!-- raw HTML omitted -->å’Œ<!-- raw HTML omitted --><code>kubelet</code><!-- raw HTML omitted -->ä½¿ç”¨çš„<!-- raw HTML omitted --><code>cgroup</code><!-- raw HTML omitted -->é»˜è®¤å€¼ä¸ºä¸€è‡´ï¼Œ<!-- raw HTML omitted --><code>/etc/sysconfig/kubelet</code><!-- raw HTML omitted -->æ–‡ä»¶ä¸­æ·»åŠ <!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>--fail-swap-on=false</code><!-- raw HTML omitted -->å¿½ç•¥<code>swap</code>æŠ¥é”™<!-- raw HTML omitted --></li>
<li><code>--feature-gates EphemeralContainers=true</code><!-- raw HTML omitted -->å¼€å¯ä¸´æ—¶å®¹å™¨å‚æ•°<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubelet -h | grep EphemeralContainers</span></span></code></pre></div><div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/sysconfig/kubelet<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">KUBELET_EXTRA_ARGS=&#34;--cgroup-driver=systemd --fail-swap-on=false&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">KUBE_PROXY_MODE=&#34;ipvs&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->ç½®ä¸ºå¼€æœºè‡ªå¯åŠ¨å³å¯ï¼Œç”±äºæ²¡æœ‰ç”Ÿæˆé…ç½®æ–‡ä»¶ï¼Œé›†ç¾¤åˆå§‹åŒ–åè‡ªåŠ¨å¯åŠ¨<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl enable kubelet <span style="color:#f92672">&amp;&amp;</span> systemctl start kubelet</span></span></code></pre></div></blockquote>
<hr>
<h2 id="ä½¿ç”¨kubeadméƒ¨ç½²kubernetes">ä½¿ç”¨<code>Kubeadm</code>éƒ¨ç½²<code>Kubernetes</code></h2>
<h3 id="æŸ¥çœ‹ä¸‹è½½æ‰€éœ€é•œåƒ">æŸ¥çœ‹ä¸‹è½½æ‰€éœ€é•œåƒ</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->æŸ¥çœ‹<!-- raw HTML omitted --><code>k8s</code><!-- raw HTML omitted -->æ‰€éœ€é•œåƒ<!-- raw HTML omitted --><code>kubeadm config images list</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm config images list   <span style="color:#75715e"># listæ›¿æ¢ï¼špullã€æ‹‰å–é•œåƒ</span>
</span></span><span style="display:flex;"><span>k8s.gcr.io/kube-apiserver:v1.24.6
</span></span><span style="display:flex;"><span>k8s.gcr.io/kube-controller-manager:v1.24.6
</span></span><span style="display:flex;"><span>k8s.gcr.io/kube-scheduler:v1.24.6
</span></span><span style="display:flex;"><span>k8s.gcr.io/kube-proxy:v1.24.6
</span></span><span style="display:flex;"><span>k8s.gcr.io/pause:3.7
</span></span><span style="display:flex;"><span>k8s.gcr.io/etcd:3.5.3-0
</span></span><span style="display:flex;"><span>k8s.gcr.io/coredns/coredns:v1.8.6
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ docker images --digests  	<span style="color:#75715e"># éªŒè¯é•œåƒå®Œæ•´æ€§</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->ä¸‹è½½<code>K8S</code>æ‰€éœ€é•œåƒ (å¦‚æœè¿‡ç¨‹ä¸­æœ‰æç¤ºå¤±è´¥è¿¹è±¡, é‚£ä¹ˆå¯èƒ½æ˜¯ç½‘ç»œåŸå› , å¤šæ‰§è¡Œå‡ æ¬¡)<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm config images list | xargs -n1 docker pull  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŒ‡å®šæ‹‰å–é˜¿é‡Œäº‘æºçš„é•œåƒ  </span>
</span></span><span style="display:flex;"><span>$ kubeadm config images pull --kubernetes-version<span style="color:#f92672">=</span>v1.20.2 --image-repository<span style="color:#f92672">=</span>registry.aliyuncs.com/google_containers  </span></span></code></pre></div></blockquote>
<hr>
<h3 id="éƒ¨ç½²masterèŠ‚ç‚¹">éƒ¨ç½²<code>master</code>èŠ‚ç‚¹</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->ä¸¤ç§æ–¹å¼éƒ¨ç½²<!-- raw HTML omitted --><code>Master</code>èŠ‚ç‚¹ï¼š<strong>å‘½ä»¤è¡Œ</strong>å’Œ**<code>yaml</code>**</li>
<li><!-- raw HTML omitted -->**æ³¨æ„ï¼š**ä¸»æœºåä¸­ä¸èƒ½å¸¦æœ‰_ï¼ˆä¸‹åˆ’çº¿ï¼‰ï¼Œä¸ç„¶åˆå§‹åŒ–ä¼šæŠ¥é”™<!-- raw HTML omitted --><a href="https://kubernetes.io/zh/docs/reference/setup-tools/kubeadm/kubeadm-init/" rel="external" target="_self"><code>kubeadm init</code></a></li>
</ul>
</blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->ä½¿ç”¨å‘½ä»¤è¡Œæ–¹å¼åˆå§‹åŒ–<!-- raw HTML omitted --><code>Kubernetes</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>--kubernetes-version</code>ï¼šæŒ‡å®šç‰ˆæœ¬</li>
<li><code>--apiserver-advertise-address</code>ï¼š<code>master</code>æœ¬æœº<code>IP</code></li>
<li><code>--service-cidr</code>ï¼š<!-- raw HTML omitted -->ç”¨äºæŒ‡å®šä¸º<code>Service</code>åˆ†é…ä½¿ç”¨ç½‘ç»œåœ°å€ï¼Œå®ƒç”±<code>kubernetes</code>ç®¡ç†ï¼Œé»˜è®¤ç½‘æ®µï¼š<code>10.96.0.0/12</code><!-- raw HTML omitted --></li>
<li><code>--pod-network-cidr</code>ï¼š<!-- raw HTML omitted -->å¯åŠ¨å®¹å™¨ç»™å®¹å™¨æ‰€åˆ†é…<code>IP</code>ï¼Œ<code>ip a</code>å¯ä»¥æŸ¥çœ‹æœåŠ¡å™¨æœ¬æœºç”Ÿæˆ<code>IP</code>æ®µï¼Œå½“æœ‰ä»é›†ç¾¤å¤–èŠ‚ç‚¹é€šè¿‡é™æ€è·¯ç”±æ–¹å¼è®¿é—®é›†ç¾¤å†…<code>Service</code>çš„éœ€æ±‚æ—¶ï¼Œéœ€è¦åœ¨åˆ›å»ºé›†ç¾¤æ—¶æŒ‡å®š<code>pod-network-cidr</code>ï¼Œ ä»¥å¯¹æ¥è‡ªé<code>Pod</code>ç½‘ç»œçš„æµé‡(å¤–éƒ¨æµé‡)æ‰§è¡Œ<code>MASQ</code>ï¼Œå¤–éƒ¨è®¿é—®podæœåŠ¡åš<code>nat</code>è½¬å‘,å®ƒé€šå¸¸åº”è¯¥ä¸éƒ¨ç½²ä½¿ç”¨çš„ç½‘ç»œæ’ä»¶(ä¾‹å¦‚ï¼š<code>flannel</code>ã€<code>calico</code>)é»˜è®¤è®¾å®šä¿æŒä¸€è‡´ï¼Œ<code>10.244.0.0/16</code>æ˜¯<code>flannel</code>é»˜è®¤ä½¿ç”¨ç½‘ç»œ<!-- raw HTML omitted --></li>
<li><code>--ignore-preflight-errors=Swap</code>ï¼š<!-- raw HTML omitted -->é€šè¿‡æ­¤å‚æ•°å¿½ç•¥swapæŠ¥é”™<!-- raw HTML omitted --></li>
<li><code>--image-repository registry.aliyuncs.com/google_containers</code>ï¼š<!-- raw HTML omitted -->æŒ‡å®šä»é˜¿é‡Œäº‘ä¸‹è½½<!-- raw HTML omitted --></li>
<li><code>--cri-socket</code>ï¼š<!-- raw HTML omitted -->é…ç½®<code>CRI</code>ç«¯ç‚¹<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm init --kubernetes-version<span style="color:#f92672">=</span>v1.24.6 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--apiserver-advertise-address<span style="color:#f92672">=</span>192.168.35.128 --node-name<span style="color:#f92672">=</span>k8s-master <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--service-cidr<span style="color:#f92672">=</span>10.64.0.0/12 --pod-network-cidr<span style="color:#f92672">=</span>10.244.0.0/16 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cri-socket unix:///var/run/containerd/containerd.sock  	<span style="color:#75715e"># é…ç½® CRI ç«¯ç‚¹</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->é€šè¿‡é…ç½®æ–‡ä»¶åˆå§‹åŒ–<!-- raw HTML omitted --><code>Kubernetes</code>çš„<code>master</code>èŠ‚ç‚¹</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># è¾“å‡ºåˆå§‹åŒ–é…ç½®åˆ°æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>$ kubeadm config print init-defaults &gt;/opt/k8s/yaml/kubeadm-config.yaml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¿®æ”¹é…ç½®æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>apiVersion: kubeadm.k8s.io/v1beta3
</span></span><span style="display:flex;"><span>bootstrapTokens:
</span></span><span style="display:flex;"><span>- groups:
</span></span><span style="display:flex;"><span>    - system:bootstrappers:kubeadm:default-node-token
</span></span><span style="display:flex;"><span>    token: abcdef.0123456789abcdef
</span></span><span style="display:flex;"><span>    ttl: 24h0m0s
</span></span><span style="display:flex;"><span>    usages:
</span></span><span style="display:flex;"><span>    - signing
</span></span><span style="display:flex;"><span>    - authentication
</span></span><span style="display:flex;"><span>kind: InitConfiguration
</span></span><span style="display:flex;"><span>localAPIEndpoint:
</span></span><span style="display:flex;"><span>    advertiseAddress: 1.2.3.4  	<span style="color:#75715e"># ä¿®æ”¹ä¸ºmasteræœ¬æœºIP</span>
</span></span><span style="display:flex;"><span>    bindPort: <span style="color:#ae81ff">6443</span>  	<span style="color:#75715e"># ä½¿ç”¨ç«¯å£</span>
</span></span><span style="display:flex;"><span>nodeRegistration:
</span></span><span style="display:flex;"><span>    criSocket: unix:///var/run/containerd/containerd.sock  	<span style="color:#75715e"># é…ç½® CRI ç«¯ç‚¹</span>
</span></span><span style="display:flex;"><span>    imagePullPolicy: IfNotPresent
</span></span><span style="display:flex;"><span>    name: node  	<span style="color:#75715e"># é…ç½®ä¸»æœºåï¼Œ ä¸»æœºåä¸å…è®¸ä½¿ç”¨ä¸‹åˆ’çº¿</span>
</span></span><span style="display:flex;"><span>    taints: null
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiServer:
</span></span><span style="display:flex;"><span>    timeoutForControlPlane: 4m0s
</span></span><span style="display:flex;"><span>apiVersion: kubeadm.k8s.io/v1beta3
</span></span><span style="display:flex;"><span>certificatesDir: /etc/kubernetes/pki
</span></span><span style="display:flex;"><span>clusterName: kubernetes
</span></span><span style="display:flex;"><span>controllerManager: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>dns: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>etcd:
</span></span><span style="display:flex;"><span>    local:
</span></span><span style="display:flex;"><span>        dataDir: /var/lib/etcd
</span></span><span style="display:flex;"><span>imageRepository: k8s.gcr.io  	<span style="color:#75715e"># å®šä¹‰ä½¿ç”¨é•œåƒæº</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## imageRepository: registry.aliyuncs.com/google_containers  	# é˜¿é‡Œäº‘é•œåƒæº</span>
</span></span><span style="display:flex;"><span>kind: ClusterConfiguration
</span></span><span style="display:flex;"><span>kubernetesVersion: 1.24.6  	<span style="color:#75715e"># å®šä¹‰kubernetesç‰ˆæœ¬</span>
</span></span><span style="display:flex;"><span>networking:
</span></span><span style="display:flex;"><span>    dnsDomain: cluster.local
</span></span><span style="display:flex;"><span>    serviceSubnet: 10.96.0.0/12  	<span style="color:#75715e"># 10.244.0.0/16 æ˜¯`flannel`é»˜è®¤ä½¿ç”¨ç½‘ç»œ</span>
</span></span><span style="display:flex;"><span>scheduler: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiVersion: kubeproxy.config.k8s.io/v1alpha1
</span></span><span style="display:flex;"><span>kind: KubeProxyConfiguration
</span></span><span style="display:flex;"><span>featureGates:
</span></span><span style="display:flex;"><span>    SupportIPVSProxyMode: true
</span></span><span style="display:flex;"><span>mode: ipvs  	<span style="color:#75715e"># å¯ç”¨ipvs  </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubeadm init --config<span style="color:#f92672">=</span>/opt/k8s/yaml/kubeadm-config.yaml  	<span style="color:#75715e"># åˆå§‹åŒ–é…ç½®æ–‡ä»¶</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->å¦‚æœåˆå§‹åŒ–æŠ¥é”™æ‰§è¡Œä¸‹é¢å‘½ä»¤ã€ç„¶åé‡æ–°åˆå§‹åŒ–<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">############################################################# 	 é…ç½®containerdæœåŠ¡</span>
</span></span><span style="display:flex;"><span>$ rm -rf /etc/containerd/config.toml
</span></span><span style="display:flex;"><span>$ containerd config default &gt;/etc/containerd/config.toml  	<span style="color:#75715e"># ç”Ÿæˆæ–°é…ç½®æ¥è¦†ç›–é»˜è®¤é…ç½®</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo cat &gt;&gt;/etc/containerd/config.toml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[plugins.&#34;io.containerd.grpc.v1.cri&#34;.containerd.runtimes.runc.options]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> SystemdCgroup = false  	# ä¿®æ”¹ä¸ºï¼štrue
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>$ systemctl restart containerd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#############################################################  	kubelet é…ç½®æ–‡ä»¶ä¿®æ”¹</span>
</span></span><span style="display:flex;"><span>$ sudo cat &gt;&gt;/var/lib/kubelet/kubeadm-flags.env<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">KUBELET_KUBEADM_ARGS=&#34;--container-runtime-endpoint=unix:///var/run/containerd/containerd.sock --pod-infra-container-image=registry.k8s.io/pause:3.9&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¯åŠ¨é…ç½®å¢åŠ --container-runtime=remote --container-runtime-endpoint=unix:///var/run/containerd/containerd.sock</span>
</span></span><span style="display:flex;"><span>$ sudo cat &gt;&gt;/usr/lib/systemd/system/kubelet.service<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/usr/bin/kubelet --container-runtime=remote --container-runtime-endpoint=unix:///var/run/containerd/containerd.sock
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">############################################################## 	 åˆ é™¤é…ç½®é‡è½½</span>
</span></span><span style="display:flex;"><span>$ swapoff -a <span style="color:#f92672">&amp;&amp;</span> kubeadm reset <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	<span style="color:#f92672">&amp;&amp;</span> systemctl daemon-reload <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	<span style="color:#f92672">&amp;&amp;</span> systemctl restart kubelet <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	<span style="color:#f92672">&amp;&amp;</span> iptables -F <span style="color:#f92672">&amp;&amp;</span> iptables -t nat -F <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	<span style="color:#f92672">&amp;&amp;</span> iptables -t mangle -F <span style="color:#f92672">&amp;&amp;</span> iptables -X</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->æŸ¥çœ‹<code>node</code>ä¿¡æ¯<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl get nodes
</span></span><span style="display:flex;"><span>NAME         STATUS   ROLES                  AGE   VERSION
</span></span><span style="display:flex;"><span>k8s-master   Ready    control-plane,master   23h   v1.21.12
</span></span><span style="display:flex;"><span>k8s-node1    Ready    &lt;none&gt;                 23h   v1.21.12
</span></span><span style="display:flex;"><span>k8s-node2    Ready    &lt;none&gt;                 23h   v1.21.12</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->æ ¹æ®æç¤ºæ¶ˆæ¯ï¼Œåœ¨<code>Master</code>èŠ‚ç‚¹ä¸Šä½¿ç”¨<code>kubectl</code>å·¥å…·ï¼Œå¯ä»¥æŠŠä¸‹åˆ—<code>.kube</code>ç›®å½•åŒæ­¥åˆ°<code>node</code>èŠ‚ç‚¹ï¼Œä»¥ä¾¿<code>node</code>èŠ‚ç‚¹ä½¿ç”¨<code>kubectl</code>å·¥å…·<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted --><strong>æ³¨æ„ï¼š</strong><!-- raw HTML omitted -->å¦‚æœä¸æ‰§è¡Œ<!-- raw HTML omitted -->ä»¥ä¸‹å‘½ä»¤<!-- raw HTML omitted -->ï¼Œæ‰§è¡Œ<code>kubectl get nodes</code>å‘½ä»¤æŠ¥é”™ï¼š<code>couldn't get current server API group list: Get &quot;http://localhost:8080/api?timeout=32s&quot;: dial tcp [::1]:8080: connect: connection refused</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -p $HOME/.kube
</span></span><span style="display:flex;"><span>$ cp -i /etc/kubernetes/admin.conf <span style="color:#e6db74">${</span>HOME<span style="color:#e6db74">}</span>/.kube/config
</span></span><span style="display:flex;"><span>$ chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> <span style="color:#e6db74">${</span>HOME<span style="color:#e6db74">}</span>/.kube/config
</span></span><span style="display:flex;"><span>$ scp -r /root/.kube root@k8s-node-01:/root/</span></span></code></pre></div></blockquote>
<hr>
<h3 id="nodeèŠ‚ç‚¹åŠ å…¥é›†ç¾¤"><code>node</code>èŠ‚ç‚¹åŠ å…¥é›†ç¾¤</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->å½“ä¸»èŠ‚ç‚¹å¯åŠ¨å®Œ<code>k8s</code>ä¹‹åä¼šç”ŸæˆåŠ å…¥èŠ‚ç‚¹çš„å‘½ä»¤ï¼Œè§†è‡ªå·±æœåŠ¡å™¨è€Œå®š<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm join 192.168.35.128:6443 --token l37r7y.75gjs1ltufdp8kp2 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	--discovery-token-ca-cert-hash sha256:9ebc670ec3f97b5f42d77908f378786ed806ef22e9ae2cf21fe5fb239483833c</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->é»˜è®¤<code>token</code>æœ‰æ•ˆæœŸä¸º24å°æ—¶ï¼Œå½“è¿‡æœŸä¹‹åï¼Œè¯¥<code>token</code>å°±ä¸å¯ç”¨äº†ã€‚è¿™æ—¶å°±éœ€è¦é‡æ–°åˆ›å»º<code>token</code>ï¼Œæ“ä½œå¦‚ä¸‹ï¼š<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm token list  	<span style="color:#75715e"># æŸ¥çœ‹Token</span>
</span></span><span style="display:flex;"><span>$ kubeadm token create --print-join-command
</span></span><span style="display:flex;"><span>$ kubeadm token create --ttl <span style="color:#ae81ff">0</span> --print-join-command  <span style="color:#75715e"># ç”Ÿæˆä¸€ä¸ªæ°¸ä¸è¿‡æœŸçš„token</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># é‡æ–°è·å–sha56key</span>
</span></span><span style="display:flex;"><span>$ openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outfrom der 2&gt;dev/null | openssl dgst -sha256 -hex | sed <span style="color:#e6db74">&#39;s/^.* //&#39;</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><code>master</code><!-- raw HTML omitted -->æ‰§è¡Œå‘½ä»¤æŸ¥çœ‹èŠ‚ç‚¹æ˜¯å¦å·²åŠ å…¥<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl get componentstatuses  	<span style="color:#75715e"># æŸ¥çœ‹é›†ç¾¤å¥åº·çŠ¶å†µï¼Œç¼©å†™ä¸ºï¼šcs</span>
</span></span><span style="display:flex;"><span>NAME                 STATUS    MESSAGE             ERROR
</span></span><span style="display:flex;"><span>scheduler            Healthy   ok                  
</span></span><span style="display:flex;"><span>controller-manager   Healthy   ok                  
</span></span><span style="display:flex;"><span>etcd-0               Healthy   <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;health&#34;</span>:<span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">}</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->æŸ¥çœ‹éƒ¨ç½²å¥½çš„å‘½åç©ºé—´<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>default</code><!-- raw HTML omitted -->ï¼šæ‰€æœ‰æœªæŒ‡å®šçš„<code>Namespace</code>çš„å¯¹è±¡éƒ½ä¼šè¢«åˆ†é…åœ¨defaultå‘½åç©ºé—´<!-- raw HTML omitted --></li>
<li><code>kube-node-lease</code><!-- raw HTML omitted -->ï¼šé›†ç¾¤èŠ‚ç‚¹ä¹‹é—´çš„å¿ƒè·³ç»´æŠ¤ï¼Œ<code>v1.13</code>å¼€å§‹å¼•å…¥<!-- raw HTML omitted --></li>
<li><code>kube-public</code><!-- raw HTML omitted -->ï¼šæ­¤å‘½åç©ºé—´çš„èµ„æºå¯ä»¥è¢«æ‰€æœ‰äººè®¿é—®ï¼ˆåŒ…æ‹¬æœªè®¤è¯ç”¨æˆ·ï¼‰<!-- raw HTML omitted --></li>
<li><code>kube-system</code><!-- raw HTML omitted -->ï¼šæ‰€æœ‰ç”±<code>kubernetes</code>ç³»ç»Ÿåˆ›å»ºçš„èµ„æºéƒ½å¤„äºè¿™ä¸ªå‘½åç©ºé—´<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl get namespace  <span style="color:#75715e"># ç¼©å†™ä¸ºï¼š ns</span>
</span></span><span style="display:flex;"><span>NAME              STATUS   AGE 
</span></span><span style="display:flex;"><span>default           Active   19h
</span></span><span style="display:flex;"><span>kube-node-lease   Active   19h
</span></span><span style="display:flex;"><span>kube-public       Active   19h
</span></span><span style="display:flex;"><span>kube-system       Active   19h</span></span></code></pre></div></blockquote>
<hr>
<h4 id="å¤„ç†é›†ç¾¤çŠ¶æ€statusnotreadyfont-colorredæ˜¯ç½‘ç»œä¸é€šéƒ¨ç½²fontcnifont-colorredç½‘ç»œæ’ä»¶font">å¤„ç†é›†ç¾¤çŠ¶æ€ï¼š<code>STATUSï¼šNotReady</code><!-- raw HTML omitted -->æ˜¯ç½‘ç»œä¸é€šéƒ¨ç½²ï¼š<!-- raw HTML omitted --><code>CNI</code><!-- raw HTML omitted -->ç½‘ç»œæ’ä»¶<!-- raw HTML omitted --></h4>
<blockquote>
<table>
<thead>
<tr>
<th>åç§°åœ°å€</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://segmentfault.com/a/1190000018698263" rel="external" target="_self">ç½‘ç»œï¼š<code>Flannel</code>ã€<code>Calico</code>ã€<code>Canal</code>å’Œ<code>Weave</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://dockone.io/article/10501" rel="external" target="_self">ç®€å•èŠèŠ<code>Calico</code>ä¸<code>Flannel</code></a></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li><code>kubernetes</code><!-- raw HTML omitted -->æ”¯æŒå¤šç§ç½‘ç»œæ’ä»¶ï¼Œæ¯”å¦‚<!-- raw HTML omitted --><code>flannel</code>ã€<code>calico</code>ã€<code>canal</code><!-- raw HTML omitted -->ç­‰ï¼Œä»»é€‰ä¸€ç§å³å¯ï¼Œæœ¬æ¬¡é€‰æ‹©<!-- raw HTML omitted --><code>flannel</code><!-- raw HTML omitted -->ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥å®‰è£…<!-- raw HTML omitted --><code>calico</code><!-- raw HTML omitted -->ï¼Œæ¨èå®‰è£…<!-- raw HTML omitted --><code>calico</code></li>
<li><!-- raw HTML omitted -->åœ¨<code>Master</code>èŠ‚ç‚¹ä¸Šè·å–<code>flannel</code>é…ç½®æ–‡ä»¶(å¯èƒ½ä¼šå¤±è´¥ï¼Œå¦‚æœå¤±è´¥ï¼Œè¯·ä¸‹è½½åˆ°æœ¬åœ°ï¼Œç„¶åå®‰è£…)ï¼š<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li>
<ol>
<li><code>flannelã€calico</code><!-- raw HTML omitted -->ï¼šåŸºäºéš§é“<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>éš§é“æ–¹æ¡ˆæœ€å…·æ™®é€‚æ€§ï¼Œåœ¨ä»»ä½•ç½‘ç»œç¯å¢ƒä¸‹éƒ½å¯ä»¥æ­£å¸¸å·¥ä½œï¼Œè¿™ä¸å®ƒçš„åŸç†å¯†ä¸å¯åˆ†ã€‚</li>
<li>æœ€å¸¸è§çš„éš§é“æ–¹æ¡ˆæ˜¯<code>flannel &quot;Type&quot;: &quot;vxlan&quot;</code>æ¨¡å¼ï¼Œä»¥åŠ<code>calico</code>çš„<code>ipip</code>æ¨¡å¼ï¼Œ</li>
</ul>
</blockquote>
<ul>
<li>
<ol start="2">
<li><code>flannelã€calico</code><!-- raw HTML omitted -->ï¼šåŸºäºè·¯ç”±<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>è·¯ç”±æ–¹æ¡ˆæ€§èƒ½æœ€å¥½ï¼ŒåŸå› æ˜¯è¯¥æ–¹æ¡ˆä¸éœ€è¦å°åŒ…å’Œè§£åŒ…ï¼Œæ‰€ä»¥æ²¡æœ‰éš§é“æ–¹æ¡ˆçš„åŠ£åŠ¿ï¼Œç½‘ç»œæ€§èƒ½å¾ˆå¥½ã€‚</li>
<li>å¸¸è§çš„è·¯ç”±æ–¹æ¡ˆåŒ…æ‹¬äº†<code>flannel</code>çš„<code>&quot;Type&quot;: &quot;host-gw&quot;</code>æ¨¡å¼ï¼Œä»¥åŠ<code>calico</code>çš„<code>bgp</code>æ¨¡å¼ã€‚</li>
<li><code>master</code><!-- raw HTML omitted -->èŠ‚ç‚¹æ‰§è¡Œä¸€ä¸‹è¯­å¥å®‰è£…<!-- raw HTML omitted --><code>calico</code><!-- raw HTML omitted -->ç½‘ç»œæ’ä»¶<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ curl https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/calico.yaml -O
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># çœ‹æƒ…å†µä¿®æ”¹ calicoé…ç½®æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>$ cat &gt;calico.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- name: CALICO_IPV4POOL_CIDR  	# ä¿®æ”¹ CALICO_IPV4POOL_CIDRå¯¹åº”çš„å‚æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  value: &#34;192.168.1.0/24&#34;  	# ä¿®æ”¹ä¸º --pod-network-cidr å¯¹åº”çš„ç½‘æ®µ
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¿®æ”¹calico é•œåƒåœ°å€</span>
</span></span><span style="display:flex;"><span>$ grep image calico.yaml
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s#docker.io/##g&#39;</span> calico.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl apply -f calico.yaml</span></span></code></pre></div><ul>
<li><code>master</code><!-- raw HTML omitted -->èŠ‚ç‚¹æ‰§è¡Œä¸€ä¸‹è¯­å¥å®‰è£…<code>flannel</code>ç½‘ç»œæ’ä»¶<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget -P /opt/k8s/yaml/ https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</span></span><span style="display:flex;"><span>$ kubectl get pods -n kube-system</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><code>kubernetes</code><!-- raw HTML omitted -->ä¸­<code>kubectl</code>å‘½ä»¤è‡ªåŠ¨è¡¥å…¨<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum install -y bash-completion
</span></span><span style="display:flex;"><span>$ source /etc/profile.d/bash_completion.sh</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->é›†ç¾¤ä¸å¥åº·<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>
<p><!-- raw HTML omitted -->éœ€è¦æ³¨é‡Šæ‰<!-- raw HTML omitted --><code>etc/kubernetes/manifests</code>ç›®å½•ä¸‹çš„<code>kube-controller-manager.yaml</code>å’Œ<code>kube-scheduler.yaml</code>çš„<code>--port=0</code>ï¼š</p>
</li>
<li>
<p><!-- raw HTML omitted -->ä¿®æ”¹<!-- raw HTML omitted --><code>kube-controller-manager.yaml</code>æ–‡ä»¶</p>
</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo cat &gt;&gt;/etc/kubernetes/manifests/kube-controller-manager.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - command:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - kube-controller-manager
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --allocate-node-cidrs=true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --authentication-kubeconfig=/etc/kubernetes/controller-manager.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --authorization-kubeconfig=/etc/kubernetes/controller-manager.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --bind-address=127.0.0.1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --client-ca-file=/etc/kubernetes/pki/ca.crt
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --cluster-cidr=10.244.0.0/16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --cluster-name=kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --cluster-signing-cert-file=/etc/kubernetes/pki/ca.crt
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --cluster-signing-key-file=/etc/kubernetes/pki/ca.key
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --controllers=*,bootstrapsigner,tokencleaner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --kubeconfig=/etc/kubernetes/controller-manager.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --leader-elect=true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # ä¿®æ”¹éƒ¨åˆ†
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # - --port=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --root-ca-file=/etc/kubernetes/pki/ca.crt
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --service-account-private-key-file=/etc/kubernetes/pki/sa.key
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --service-cluster-ip-range=10.96.0.0/12
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --use-service-account-credentials=true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->ä¿®æ”¹<!-- raw HTML omitted --><code>kube-scheduler.yaml</code>æ–‡ä»¶</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo cat &gt;&gt;/etc/kubernetes/manifests/kube-scheduler.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - command:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - kube-scheduler
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --authentication-kubeconfig=/etc/kubernetes/scheduler.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --authorization-kubeconfig=/etc/kubernetes/scheduler.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --bind-address=127.0.0.1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --kubeconfig=/etc/kubernetes/scheduler.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --leader-elect=true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # ä¿®æ”¹éƒ¨åˆ†
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # - --port=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åœ¨æ‰€æœ‰MasterèŠ‚ç‚¹å†æ¬¡æŸ¥çœ‹é›†ç¾¤å¥åº·çŠ¶å†µï¼š</span>
</span></span><span style="display:flex;"><span>$ kubectl get cs</span></span></code></pre></div></blockquote>
<hr>
<h2 id="éƒ¨ç½²kubernetesé›†ç¾¤">éƒ¨ç½²<code>Kubernetes</code>é›†ç¾¤</h2>
<h3 id="å®‰è£…é«˜å¯ç”¨ç»„ä»¶">å®‰è£…é«˜å¯ç”¨ç»„ä»¶</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->æ³¨æ„ï¼šå¦‚æœä¸æ˜¯é«˜å¯ç”¨é›†ç¾¤ï¼Œ<!-- raw HTML omitted --><code>haproxy</code>å’Œ<code>keepalived</code>æ— éœ€å®‰è£…</li>
</ul>
</blockquote>
<ul>
<li>
<ol>
<li>æ‰€æœ‰<code>Master</code>èŠ‚ç‚¹å®‰è£…<code>HAPROXY</code>å’Œ<code>Keepalived</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install keepalived haproxy</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->æ‰€æœ‰<!-- raw HTML omitted --><code>Master</code><!-- raw HTML omitted -->èŠ‚ç‚¹é…ç½®<!-- raw HTML omitted --><code>HAProxy</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/haproxy/haproxy.cfg<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">global
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	maxconn  2000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	ulimit-n  16384
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	log  127.0.0.1 local0 err
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	stats timeout 30s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">defaults
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	log global
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	mode  http
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	option  httplog
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	timeout connect 5000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	timeout client  50000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	timeout server  50000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	timeout http-request 15s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	timeout http-keep-alive 15s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">frontend monitor-in
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	bind *:33305
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	mode http
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	option httplog
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	monitor-uri /monitor
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">listen stats
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	bind    *:8006
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	mode    http
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	stats   enable
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	stats   hide-version
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	stats   uri       /stats
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	stats   refresh   30s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	stats   realm     Haproxy\ Statistics
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	stats   auth      admin:admin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">frontend k8s-master
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	bind 0.0.0.0:16443
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	bind 127.0.0.1:16443
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	mode tcp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	option tcplog
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	tcp-request inspect-delay 5s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	default_backend k8s-master
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">backend k8s-master
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	mode tcp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	option tcplog
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	option tcp-check
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	balance roundrobin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# ä¸‹é¢çš„é…ç½®æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	server k8s-master-01 192.168.80.210:6443  check
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	server k8s-master-02 192.168.80.211:6443  check
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><code>Msster-01</code>çš„<code>Keepalived</code><!-- raw HTML omitted -->é…ç½®æ–‡ä»¶<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/keepalived/keepalived.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">! Configuration File for keepalived
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	global_defs {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		# æ ‡è¯†æœ¬èŠ‚ç‚¹çš„å­—æ¡ä¸²ï¼Œé€šå¸¸ä¸º hostname
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		router_id k8s-master-01
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		script_user root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		enable_script_security    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# æ£€æµ‹è„šæœ¬
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# keepalivedä¼šå®šæ—¶æ‰§è¡Œè„šæœ¬å¹¶å¯¹è„šæœ¬æ‰§è¡Œçš„ç»“æœè¿›è¡Œåˆ†æï¼ŒåŠ¨æ€è°ƒæ•´vrrp_instanceçš„ä¼˜å…ˆçº§ã€‚å¦‚æœè„šæœ¬æ‰§è¡Œç»“æœä¸º0ï¼Œå¹¶ä¸”weighté…ç½®çš„å€¼å¤§äº0ï¼Œåˆ™ä¼˜å…ˆçº§ç›¸åº”çš„å¢åŠ ã€‚å¦‚æœè„šæœ¬æ‰§è¡Œç»“æœé0ï¼Œå¹¶ä¸”weighté…ç½®çš„å€¼å°äº0ï¼Œåˆ™ä¼˜å…ˆçº§ç›¸åº”çš„å‡å°‘ã€‚å…¶ä»–æƒ…å†µï¼Œç»´æŒåŸæœ¬é…ç½®çš„ä¼˜å…ˆçº§ï¼Œå³é…ç½®æ–‡ä»¶ä¸­priorityå¯¹åº”çš„å€¼ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	vrrp_script chk_apiserver {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		script &#34;/etc/keepalived/check_apiserver.sh&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        # æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        interval 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        # ä¸€æ—¦è„šæœ¬æ‰§è¡ŒæˆåŠŸï¼Œæƒé‡å‡å°‘5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        weight -5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        fall 3  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        rise 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# å®šä¹‰è™šæ‹Ÿè·¯ç”±ï¼ŒVI_1 ä¸ºè™šæ‹Ÿè·¯ç”±çš„æ ‡ç¤ºç¬¦ï¼Œè‡ªå·±å®šä¹‰åç§°
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	vrrp_instance VI_1 {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		# ä¸»èŠ‚ç‚¹ä¸º MASTERï¼Œå¯¹åº”çš„å¤‡ä»½èŠ‚ç‚¹ä¸º BACKUP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		state MASTER
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		# ç»‘å®šè™šæ‹Ÿ IP çš„ç½‘ç»œæ¥å£ï¼Œä¸æœ¬æœº IP åœ°å€æ‰€åœ¨çš„ç½‘å¡åç§°ç›¸åŒ
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		interface ens32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		# ä¸»æœºçš„IPåœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		mcast_src_ip 192.168.80.210
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		# è™šæ‹Ÿè·¯ç”±id
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		virtual_router_id 100
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		# èŠ‚ç‚¹ä¼˜å…ˆçº§ï¼Œå€¼èŒƒå›´ 0-254ï¼ŒMASTER è¦æ¯” BACKUP é«˜
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		priority 100
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		# ä¼˜å…ˆçº§é«˜çš„è®¾ç½® nopreempt è§£å†³å¼‚å¸¸æ¢å¤åå†æ¬¡æŠ¢å çš„é—®é¢˜
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		nopreempt 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		# ç»„æ’­ä¿¡æ¯å‘é€é—´éš”ï¼Œæ‰€æœ‰èŠ‚ç‚¹è®¾ç½®å¿…é¡»ä¸€æ ·ï¼Œé»˜è®¤ 1s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		advert_int 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        # è®¾ç½®éªŒè¯ä¿¡æ¯ï¼Œæ‰€æœ‰èŠ‚ç‚¹å¿…é¡»ä¸€è‡´
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		authentication {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			auth_type PASS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			auth_pass K8SHA_KA_AUTH
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		# è™šæ‹Ÿ IP æ± , æ‰€æœ‰èŠ‚ç‚¹è®¾ç½®å¿…é¡»ä¸€æ ·
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		virtual_ipaddress {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			# è™šæ‹Ÿ ipï¼Œå¯ä»¥å®šä¹‰å¤šä¸ª	
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			192.168.80.220/24
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		track_script {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			chk_apiserver
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><code>Master-02</code>çš„<code>Keepalived</code><!-- raw HTML omitted -->é…ç½®æ–‡ä»¶<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/keepalived/keepalived.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">! Configuration File for keepalived
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	global_defs {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		router_id k8s-master-02
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		script_user root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		enable_script_security    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	vrrp_script chk_apiserver {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		script &#34;/etc/keepalived/check_apiserver.sh&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		interval 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		weight -5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		fall 3  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		rise 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	vrrp_instance VI_1 {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		state BACKUP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		interface ens32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		mcast_src_ip 192.168.80.211
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		virtual_router_id 101
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		priority 99
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		advert_int 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		authentication {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			auth_type PASS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			auth_pass K8SHA_KA_AUTH
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		virtual_ipaddress {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			192.168.80.220/24
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		track_script {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			chk_apiserver
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li>æ‰€æœ‰<code>Master</code><!-- raw HTML omitted -->èŠ‚ç‚¹è®¾ç½®ç›‘æ§è„šæœ¬ï¼Œå¹¶ä¸”ç»™äºˆæ‰§è¡Œæƒé™<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/keepalived/check_apiserver.sh<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">err=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">for k in $(seq 1 5)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">do
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	check_code=$(pgrep kube-apiserver)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	if [[ $check_code == &#34;&#34; ]]; then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		err=$(expr $err + 1)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		sleep 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		continue
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	else
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		err=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		break
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">done
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if [[ $err != &#34;0&#34; ]]; then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	echo &#34;systemctl stop keepalived&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	/usr/bin/systemctl stop keepalived
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	exit 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">else
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	exit 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>$ chmod +x /etc/keepalived/check_apiserver.sh</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li>æ‰€æœ‰<code>Master</code><!-- raw HTML omitted -->èŠ‚ç‚¹å¯åŠ¨<!-- raw HTML omitted --><code>HAProxy</code>å’Œ<code>Keepalived</code>å¹¶ä¸”æµ‹è¯•<code>VIP(è™šæ‹ŸIP)</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl daemon-reload
</span></span><span style="display:flex;"><span>$ systemctl enable --now haproxy
</span></span><span style="display:flex;"><span>$ systemctl enable --now keepalived
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ping 192.168.80.220 -c <span style="color:#ae81ff">4</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="åˆå§‹åŒ–kubernetes">åˆå§‹åŒ–<code>Kubernetes</code></h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->å‘½ä»¤è¡Œ<!-- raw HTML omitted --><!-- raw HTML omitted -->æ–¹å¼åˆå§‹åŒ–æ‰€æœ‰<!-- raw HTML omitted --><code>Master</code>èŠ‚ç‚¹</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>åœ¨<code>k8s-master01</code><!-- raw HTML omitted -->èŠ‚ç‚¹æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm init <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --apiserver-advertise-address<span style="color:#f92672">=</span>192.168.80.210 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --image-repository registry.aliyuncs.com/google_containers <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --control-plane-endpoint<span style="color:#f92672">=</span>192.168.80.225:16443 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --kubernetes-version v1.20.2 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --service-cidr<span style="color:#f92672">=</span>10.96.0.0/12 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --pod-network-cidr<span style="color:#f92672">=</span>10.244.0.0/16 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --cri-socket unix:///var/run/containerd/containerd.sock  	<span style="color:#75715e"># é…ç½® CRI ç«¯ç‚¹</span>
</span></span><span style="display:flex;"><span>  --upload-certs</span></span></code></pre></div><ul>
<li>å°†<code>k8s-master02</code><!-- raw HTML omitted -->èŠ‚ç‚¹åŠ å…¥åˆ°é›†ç¾¤ä¸­ï¼Œå…¶ä»–<code>master</code>èŠ‚ç‚¹åŠ å…¥åŒæ ·å‘½ä»¤<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm join 192.168.80.225:16443 --token povqsg.arg07e5ia1pywr71 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --discovery-token-ca-cert-hash sha256:9efd30b7f35747289b9de0c8d0768b9c2d5eb7d675cb86fa05b9a6d9526c3441 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --control-plane --certificate-key 363cc6296537b41607851c10f1f41ef23cf5cdc6965cb9c26e4b252315086855</span></span></code></pre></div><ul>
<li>é˜²æ­¢åœ¨<code>Master-02</code><!-- raw HTML omitted -->èŠ‚ç‚¹ä¸­ä¸èƒ½ä½¿ç”¨<!-- raw HTML omitted --><code>kubectl</code>å‘½ä»¤</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -p $HOME/.kube
</span></span><span style="display:flex;"><span>$ sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style="display:flex;"><span>$ sudo chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config</span></span></code></pre></div><ul>
<li>å¦‚æœ<code>Token</code>è¿‡æœŸï¼Œéœ€è¦åœ¨<code>Master-01</code><!-- raw HTML omitted -->ç”Ÿæˆæ–°çš„<!-- raw HTML omitted --><code>Token</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm token create --print-join-command</span></span></code></pre></div><ul>
<li>å¦‚æœ<code>Master</code><!-- raw HTML omitted -->è¦åŠ å…¥åˆ°é›†ç¾¤ä¸­ï¼Œéœ€è¦åœ¨<!-- raw HTML omitted --><code>Master-01</code>ç”Ÿæˆ<code>--certificate-key</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm init phase upload-certs --upload-certs</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><code> yaml</code><!-- raw HTML omitted -->æ–¹å¼åˆå§‹åŒ–æ‰€æœ‰<!-- raw HTML omitted --><code>Master</code>èŠ‚ç‚¹</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>åœ¨<code>k8s-master01</code><!-- raw HTML omitted -->åˆ›å»ºç›®å½•ç”Ÿæˆé…ç½®æ–‡ä»¶<!-- raw HTML omitted --><code>kubeadm-config.yaml</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -p /opt/k8s/yaml
</span></span><span style="display:flex;"><span>$ kubeadm config print init-defaults &gt;/opt/k8s/yaml/kubeadm-config.yaml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¿®æ”¹é…ç½®æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>apiVersion: kubeadm.k8s.io/v1beta3
</span></span><span style="display:flex;"><span>bootstrapTokens:
</span></span><span style="display:flex;"><span>- groups:
</span></span><span style="display:flex;"><span>    - system:bootstrappers:kubeadm:default-node-token
</span></span><span style="display:flex;"><span>    token: abcdef.0123456789abcdef
</span></span><span style="display:flex;"><span>    ttl: 24h0m0s
</span></span><span style="display:flex;"><span>    usages:
</span></span><span style="display:flex;"><span>    - signing
</span></span><span style="display:flex;"><span>    - authentication
</span></span><span style="display:flex;"><span>kind: InitConfiguration
</span></span><span style="display:flex;"><span>localAPIEndpoint:
</span></span><span style="display:flex;"><span>    advertiseAddress: 1.2.3.4  	<span style="color:#75715e"># ä¿®æ”¹ä¸ºmasteræœ¬æœºIP</span>
</span></span><span style="display:flex;"><span>    bindPort: <span style="color:#ae81ff">6443</span>  	<span style="color:#75715e"># ä½¿ç”¨ç«¯å£</span>
</span></span><span style="display:flex;"><span>nodeRegistration:
</span></span><span style="display:flex;"><span>    criSocket: unix:///var/run/containerd/containerd.sock  	<span style="color:#75715e"># é…ç½® CRI ç«¯ç‚¹</span>
</span></span><span style="display:flex;"><span>    imagePullPolicy: IfNotPresent
</span></span><span style="display:flex;"><span>    name: node  	<span style="color:#75715e"># é…ç½®ä¸»æœºåï¼Œ ä¸»æœºåä¸å…è®¸ä½¿ç”¨ä¸‹åˆ’çº¿</span>
</span></span><span style="display:flex;"><span>    taints: null
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiServer:
</span></span><span style="display:flex;"><span>    timeoutForControlPlane: 4m0s
</span></span><span style="display:flex;"><span>apiVersion: kubeadm.k8s.io/v1beta3
</span></span><span style="display:flex;"><span>certificatesDir: /etc/kubernetes/pki
</span></span><span style="display:flex;"><span>clusterName: kubernetes
</span></span><span style="display:flex;"><span>controllerManager: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>dns: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>etcd:
</span></span><span style="display:flex;"><span>    local:
</span></span><span style="display:flex;"><span>        dataDir: /var/lib/etcd
</span></span><span style="display:flex;"><span>imageRepository: k8s.gcr.io  	<span style="color:#75715e"># å®šä¹‰ä½¿ç”¨é•œåƒæº</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># imageRepository: registry.aliyuncs.com/google_containers  	# é˜¿é‡Œäº‘é•œåƒæº</span>
</span></span><span style="display:flex;"><span>kind: ClusterConfiguration
</span></span><span style="display:flex;"><span>kubernetesVersion: 1.24.0  	<span style="color:#75715e"># å®šä¹‰kubernetesç‰ˆæœ¬</span>
</span></span><span style="display:flex;"><span>networking:
</span></span><span style="display:flex;"><span>    dnsDomain: cluster.local
</span></span><span style="display:flex;"><span>    serviceSubnet: 10.96.0.0/12
</span></span><span style="display:flex;"><span>scheduler: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiVersion: kubeproxy.config.k8s.io/v1alpha1
</span></span><span style="display:flex;"><span>kind: KubeProxyConfiguration
</span></span><span style="display:flex;"><span>featureGates:
</span></span><span style="display:flex;"><span>    SupportIPVSProxyMode: true
</span></span><span style="display:flex;"><span>mode: ipvs  	<span style="color:#75715e"># å¯ç”¨ipvs</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->å¯ä»¥ä½¿ç”¨å¦‚ä¸‹çš„å‘½ä»¤æ›´æ–°<!-- raw HTML omitted --><code>kubeadm-config.yaml</code>æ–‡ä»¶ï¼Œéœ€è¦å°†<code>k8s</code>è®¾ç½®åˆ°å¯¹åº”çš„ç‰ˆæœ¬</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm config migrate --old-config /opt/k8s/yaml/kubeadm-config.yaml --new-config <span style="color:#e6db74">&#34;new.yaml&#34;</span></span></span></code></pre></div><ul>
<li>å°†<code>new.yaml</code><!-- raw HTML omitted -->æ–‡ä»¶å¤åˆ¶åˆ°æ‰€æœ‰çš„<!-- raw HTML omitted --><code>master</code>èŠ‚ç‚¹</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ scp new.yaml k8s-master-02:/opt/k8s/yaml/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹ä»¥åŠä¸‹è½½æ‰€æœ‰masterèŠ‚ç‚¹æå‰ä¸‹è½½é•œåƒ</span>
</span></span><span style="display:flex;"><span>$ kubeadm config images pull --config /opt/k8s/yaml/new.yaml  	<span style="color:#75715e"># pullæ›¿æ¢listå¯æŸ¥çœ‹æ‰€éœ€é•œåƒ</span></span></span></code></pre></div><ul>
<li><code>k8s-master01</code>èŠ‚ç‚¹åˆå§‹åŒ–åï¼Œä¼šåœ¨<code>/etc/kubernetes</code><!-- raw HTML omitted -->ç›®å½•ä¸‹ç”Ÿæˆå¯¹åº”çš„è¯ä¹¦å’Œé…ç½®æ–‡ä»¶ï¼Œä¹‹åå…¶ä»–çš„<!-- raw HTML omitted --><code>Master</code>èŠ‚ç‚¹åŠ å…¥åˆ°<code>k8s-master01</code>èŠ‚ç‚¹å³å¯</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm init --config /opt/k8s/yaml/new.yaml --upload-certs</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->å¦‚æœåˆå§‹åŒ–å¤±è´¥ï¼Œé‡ç½®åå†æ¬¡åˆå§‹åŒ–ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm reset -f;ipvsadm --clear;rm -rf ~/.kube</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->åˆå§‹åŒ–æˆåŠŸåï¼Œä¼šäº§ç”Ÿ<!-- raw HTML omitted --><code>token</code>å€¼ï¼Œç”¨äºå…¶ä»–èŠ‚ç‚¹åŠ å…¥æ—¶ä½¿ç”¨ï¼Œ</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>Your Kubernetes control-plane has initialized successfully!
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>To start using your cluster, you need to run the following as a regular user:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  mkdir -p $HOME/.kube
</span></span><span style="display:flex;"><span>  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style="display:flex;"><span>  sudo chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Alternatively, <span style="color:#66d9ef">if</span> you are the root user, you can run:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  export KUBECONFIG<span style="color:#f92672">=</span>/etc/kubernetes/admin.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>You should now deploy a pod network to the cluster.
</span></span><span style="display:flex;"><span>Run <span style="color:#e6db74">&#34;kubectl apply -f [podnetwork].yaml&#34;</span> with one of the options listed at:
</span></span><span style="display:flex;"><span>  https://kubernetes.io/docs/concepts/cluster-administration/addons/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>You can now join any number of the control-plane node running the following command on each as root:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># å…¶ä»– Master èŠ‚ç‚¹æ‰§è¡Œ</span>
</span></span><span style="display:flex;"><span>  kubeadm join 192.168.80.210:16443 --token abcdef.0123456789abcdef <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --discovery-token-ca-cert-hash sha256:505e373bae6123fc3e27e778c5fedbccbf0f91a51efdcc11b32c4573605b8e71 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --control-plane --certificate-key 70aef5f76111a5824085c644b3f34cf830efad00c1b16b878701166bf069664e
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Please note that the certificate-key gives access to cluster sensitive data, keep it secret!
</span></span><span style="display:flex;"><span>As a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;kubeadm init phase upload-certs --upload-certs&#34;</span> to reload certs afterward.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Then you can join any number of worker nodes by running the following on each as root:
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ‰€æœ‰ Node èŠ‚ç‚¹æ‰§è¡Œ</span>
</span></span><span style="display:flex;"><span>kubeadm join 192.168.80.210:16443 --token abcdef.0123456789abcdef <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --discovery-token-ca-cert-hash sha256:505e373bae6123fc3e27e778c5fedbccbf0f91a51efdcc11b32c4573605b8e71</span></span></code></pre></div><ul>
<li><code>k8s-master01</code><!-- raw HTML omitted -->èŠ‚ç‚¹é…ç½®ç¯å¢ƒå˜é‡ï¼Œç”¨äºè®¿é—®<!-- raw HTML omitted --><code>kubernetes</code>é›†ç¾¤</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># rootç”¨æˆ·</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/root/.bashrc<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export KUBECONFIG=/etc/kubernetes/admin.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ source ~/.bash_profile
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ™®é€šç”¨æˆ·</span>
</span></span><span style="display:flex;"><span>$ mkdir -p $HOME/.kube
</span></span><span style="display:flex;"><span>$ sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style="display:flex;"><span>$ sudo chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># k8s-master-01ä¸­æŸ¥çœ‹èŠ‚ç‚¹çš„çŠ¶æ€ï¼š</span>
</span></span><span style="display:flex;"><span>$ kubectl get nodes</span></span></code></pre></div></blockquote>
<hr>
<h3 id="nodeèŠ‚ç‚¹åŠ å…¥é›†ç¾¤-1"><code>Node</code>èŠ‚ç‚¹åŠ å…¥é›†ç¾¤</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->æ‰€æœ‰<!-- raw HTML omitted --><code>Node</code><!-- raw HTML omitted -->èŠ‚ç‚¹æ‰§è¡Œ<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm join 192.168.80.225:16443 --token povqsg.arg07e5ia1pywr71 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> --discovery-token-ca-cert-hash sha256:9efd30b7f35747289b9de0c8d0768b9c2d5eb7d675cb86fa05b9a6d9526c3441</span></span></code></pre></div></blockquote>
<hr>
<h2 id="font-colorredäºŒè¿›åˆ¶å®‰è£…fontkubernetes"><!-- raw HTML omitted -->äºŒè¿›åˆ¶å®‰è£…<!-- raw HTML omitted --><code>kubernetes</code></h2>
<h3 id="éƒ¨ç½²etcdå­˜å‚¨é›†ç¾¤ä¸‰å°ä¸»æœºä½œä¸ºèŠ‚ç‚¹">éƒ¨ç½²<code>Etcd</code>å­˜å‚¨é›†ç¾¤ã€ä¸‰å°ä¸»æœºä½œä¸ºèŠ‚ç‚¹</h3>
<ul>
<li>
<ol>
<li>é”®å€¼å¯¹æ•°æ®åº“ï¼Œå­˜å‚¨<code>K8S</code>é›†ç¾¤æ‰€æœ‰é‡è¦ä¿¡æ¯(æŒä¹…åŒ–)  <a href="https://blog.csdn.net/qq_27276045/article/details/115650151" rel="external" target="_self"><code>Kubernetes</code>å­˜å‚¨å¤§è„‘ä¹‹<code>etcd</code></a>ã€<a href="https://www.infoq.cn/article/rhzug069xvr5z5bhhtiv" rel="external" target="_self">çªç ´<code>etcd</code>é™åˆ¶ï¼å­—èŠ‚å¼€æºè‡ªç ”<code>K8s</code>å­˜å‚¨<code>KubeBrain</code></a></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>Etcd æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼é”®å€¼å­˜å‚¨ç³»ç»Ÿï¼ŒKubernetesä½¿ç”¨Etcdè¿›è¡Œæ•°æ®å­˜å‚¨ï¼Œæ‰€ä»¥å…ˆå‡†å¤‡ä¸€ä¸ªEtcdæ•°æ®åº“ï¼Œä¸ºè§£å†³Etcdå•ç‚¹æ•…éšœï¼Œåº”é‡‡ç”¨é›†ç¾¤æ–¹å¼éƒ¨ç½²ï¼Œè¿™é‡Œä½¿ç”¨3å°ç»„å»ºé›†ç¾¤ï¼Œå¯å®¹å¿1å°æœºå™¨æ•…éšœï¼Œå½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨5å°ç»„å»ºé›†ç¾¤ï¼Œå¯å®¹å¿2å°æœºå™¨æ•…éšœ</span></span></code></pre></div><ul>
<li>1.1 æ³¨æ„è¿™é‡Œ<code>profiles</code>å­—æ®µä¸‹åç§°ï¼Œå…¶ä¸­<code>CjServer</code>ä¸‹æ³¨æ˜<code>server auth</code>ç”¨äºæœåŠ¡å™¨ç«¯è®¤è¯ï¼Œåç»­åœ¨ç”ŸæˆæœåŠ¡å™¨è¯ä¹¦æ—¶å€™ï¼Œéœ€è¦ä½¿ç”¨è¿™ä¸ªåç§°ä½œä¸º<code>cfssl</code>å‘½ä»¤çš„é…ç½®æ–‡ä»¶åç§°ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚</li>
<li>1.2 æ³¨æ„è¿™é‡Œ<code>profiles</code>å­—æ®µä¸‹åç§°ï¼Œå…¶ä¸­<code>CjServer</code>ä¸‹æ³¨æ˜<code>server auth</code>ç”¨äºæœåŠ¡å™¨ç«¯è®¤è¯ï¼Œåç»­åœ¨ç”ŸæˆæœåŠ¡å™¨è¯ä¹¦æ—¶å€™ï¼Œéœ€è¦ä½¿ç”¨è¿™ä¸ªåç§°ä½œä¸º<code>cfssl</code>å‘½ä»¤çš„é…ç½®æ–‡ä»¶åç§°ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">{</span><span style="color:#e6db74">&#34;code&#34;</span>:5100,<span style="color:#e6db74">&#34;message&#34;</span>:<span style="color:#e6db74">&#34;Invalid policy: no key usage available&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>Failed to parse input: unexpected end of JSON input</span></span></code></pre></div><ul>
<li>1.3 å¾€å¾€æ˜¯æä¾›çš„<code>-profile</code>å‚æ•°ä¸­çš„é…ç½®æ–‡ä»¶ååœ¨<code>ca-config.json</code>ä¸­æ— æ³•åŒ¹é…</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 1.å‡†å¤‡cfsslè¯ä¹¦ç”Ÿæˆå·¥å…·ã€cfsslæ˜¯ä¸€ä¸ªå¼€æºçš„è¯ä¹¦ç®¡ç†å·¥å…·ï¼Œä½¿ç”¨jsonæ–‡ä»¶ç”Ÿæˆè¯ä¹¦ï¼Œæ‰¾ä»»æ„ä¸€å°æœåŠ¡å™¨æ“ä½œï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cd /usr/local/src/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64  	# æ˜¯v1.2.0 æœ€å¥½å‡çº§åˆ°v1.3.4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ chmod +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># æ·»åŠ ç¯å¢ƒå˜é‡ç¬¬ä¸€ç§æ–¹å¼
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ vim /etc/profile
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export PATH=$PATH:/opt/kubernetes/bin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ source /etc/profile
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># æŠŠå¯æ‰§è¡Œæ–‡ä»¶æŒªç§»å¹¶æ”¹å
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ mv cfssl_linux-amd64 /usr/local/bin/cfssl
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ mv cfssljson_linux-amd64 /usr/local/bin/cfssljson
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ mv cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 2.ç”ŸæˆEtcdè¯ä¹¦ã€è‡ªç­¾è¯ä¹¦é¢å‘æœºæ„ï¼ˆCAï¼‰åˆ›å»ºå·¥ä½œç›®å½•ï¼š
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cat &gt;/opt/kubernetes/ssl/ca-config.json&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;signing&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;default&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;expiry&#34;: &#34;87600h&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;profiles&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;kubernetes&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         &#34;expiry&#34;: &#34;87600h&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         &#34;usages&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;signing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;key encipherment&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;server auth&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;client auth&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">###################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cat &gt;/opt/kubernetes/ssl/ca-csr.json&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;CN&#34;: &#34;etcd CA&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;key&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;size&#34;: 2048
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;names&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;L&#34;: &#34;Beijing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;ST&#34;: &#34;Beijing&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 3.ç”Ÿæˆè¯ä¹¦
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cd /opt/kubernetes/ssl/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cfssl gencert -initca ca-csr.json | cfssljson -bare ca -
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 4. ä½¿ç”¨è‡ªç­¾CAç­¾å‘Etcd HTTPSè¯ä¹¦:åˆ›å»ºè¯ä¹¦ç”³è¯·æ–‡ä»¶  #####
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cat &gt;/opt/kubernetes/ssl/etcd-csr.json&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;CN&#34;: &#34;etcd&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;hosts&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;192.168.4.110&#34;, # ä¿®æ”¹IPã€ä¸ºäº†æ‰©å®¹æ–¹ä¾¿å¯ä»¥å¤šå†™å‡ ä¸ªIPã€å»æ‰æ³¨é‡Š
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;192.168.4.111&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;192.168.4.112&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;xxx.xxx.xxx.xxx&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;xxx.xxx.xxx.xxx&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;xxx.xxx.xxx.xxx&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;key&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;size&#34;: 2048
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;names&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;L&#34;: &#34;BeiJing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;ST&#34;: &#34;BeiJing&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 5. ç”Ÿæˆè¯ä¹¦
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cd /opt/kubernetes/ssl/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes etcd-csr.json | cfssljson -bare etcd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 6.åœ¨GitHubä¸Šä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cd /usr/local/src/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ wget https://github.com/etcd-io/etcd/releases/download/v3.4.14/etcd-v3.4.14-linux-amd64.tar.gz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ tar zxvf etcd-v3.4.14-linux-amd64.tar.gz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ mv etcd-v3.4.14-linux-amd64/{etcd,etcdctl} /opt/etcd/bin/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 6.åˆ›å»ºetcdé…ç½®æ–‡ä»¶ï¼šé’ˆå¯¹IPä¿®æ”¹ä¸ºæœ¬æœºIPï¼Œæ‹·è´è¿‡å»åæŠŠæ‰€æœ‰ç»“å°¾çš„â€œæ³¨é‡Šå–æ¶ˆæ‰â€
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cat &gt;/opt/etcd/cfg/etcd.conf&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># [Member]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ETCD_NAME=&#34;etcd-node1&#34;  	# ä¿®æ”¹æ­¤å¤„ï¼ŒèŠ‚ç‚¹2æ”¹ä¸ºetcd-2ï¼ŒèŠ‚ç‚¹3æ”¹ä¸ºetcd-3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ETCD_DATA_DIR=&#34;/var/lib/etcd/default.etcd&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ETCD_LISTEN_PEER_URLS=&#34;https://192.168.4.110:2380&#34;  	# ä¿®æ”¹æ­¤å¤„ä¸ºå½“å‰æœåŠ¡å™¨IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ETCD_LISTEN_CLIENT_URLS=&#34;https://192.168.4.110:2379,https://127.0.0.1:2379&#34;  	# ä¿®æ”¹æ­¤å¤„ä¸ºå½“å‰æœåŠ¡å™¨IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># [Clustering]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ETCD_INITIAL_ADVERTISE_PEER_URLS=&#34;https://192.168.4.110:2380&#34;  	# ä¿®æ”¹æ­¤å¤„ä¸ºå½“å‰æœåŠ¡å™¨IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ETCD_ADVERTISE_CLIENT_URLS=&#34;https://192.168.4.110:2379&#34;  # ä¿®æ”¹æ­¤å¤„ä¸ºå½“å‰æœåŠ¡å™¨IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ä¿®æ”¹ä¸ºæ‰€æœ‰èŠ‚ç‚¹IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ETCD_INITIAL_CLUSTER=&#34;etcd-node1=https://192.168.4.110:2380,etcd-node2=https://192.168.4.111:2380,etcd-node3=https://192.168.4.112:2380&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ETCD_INITIAL_CLUSTER_TOKEN=&#34;etcd-cluster&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ETCD_INITIAL_CLUSTER_STATE=&#34;new&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># [security]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># CLIENT_CERT_AUTH=&#34;true&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_CA_FILE=&#34;/opt/etcd/ssl/ca.pem&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_CERT_FILE=&#34;/opt/etcd/ssl/server.pem&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_KEY_FILE=&#34;/opt/etcd/ssl/server-key.pem&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># PEER_CLIENT_CERT_AUTH=&#34;true&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_PEER_CA_FILE=&#34;/opt/etcd/ssl/ca.pem&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_PEER_CERT_FILE=&#34;/opt/etcd/ssl/server.pem&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_PEER_KEY_FILE=&#34;/opt/etcd/ssl/server-key.pem&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#####################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_NAMEï¼šèŠ‚ç‚¹åç§°ï¼Œé›†ç¾¤ä¸­å”¯ä¸€
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_DATA_DIRï¼šæ•°æ®ç›®å½•
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_LISTEN_PEER_URLSï¼šé›†ç¾¤é€šä¿¡ç›‘å¬åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_LISTEN_CLIENT_URLSï¼šå®¢æˆ·ç«¯è®¿é—®ç›‘å¬åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_INITIAL_ADVERTISE_PEER_URLSï¼šé›†ç¾¤é€šå‘Šåœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_ADVERTISE_CLIENT_URLSï¼šå®¢æˆ·ç«¯é€šå‘Šåœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_INITIAL_CLUSTERï¼šé›†ç¾¤èŠ‚ç‚¹åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_INITIAL_CLUSTER_TOKENï¼šé›†ç¾¤Token
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_INITIAL_CLUSTER_STATEï¼šåŠ å…¥é›†ç¾¤çš„å½“å‰çŠ¶æ€ï¼Œnewæ˜¯æ–°é›†ç¾¤ï¼Œexistingè¡¨ç¤ºåŠ å…¥å·²æœ‰é›†ç¾¤
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 7.systemctlç®¡ç†etcd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cat &gt;/usr/lib/systemd/system/etcd.service&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=Etcd Server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Wants=network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Type=notify
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EnvironmentFile=/opt/etcd/cfg/etcd.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/etcd/bin/etcd \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cert-file=/opt/etcd/ssl/etcd.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--key-file=/opt/etcd/ssl/etcd-key.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--peer-cert-file=/opt/etcd/ssl/etcd.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--peer-key-file=/opt/etcd/ssl/etcd-key.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--trusted-ca-file=/opt/etcd/ssl/ca.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--peer-trusted-ca-file=/opt/etcd/ssl/ca.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--logger=zap
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LimitNOFILE=65536
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">###################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 8.æ‹·è´åˆšåˆšç”Ÿæˆè¯ä¹¦åˆ°etcdç›®å½•ä¸‹
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cd /opt/kubernetes/ssl/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cp ca*.pem etcd*.pem /opt/etcd/ssl/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 9.èŠ‚ç‚¹1ç”Ÿæˆçš„æ‰€æœ‰æ–‡ä»¶æ‹·è´åˆ°å…¶ä»–æ‰€æœ‰èŠ‚ç‚¹ã€ç„¶ååœ¨å…¶ä»–èŠ‚ç‚¹åˆ†åˆ«ä¿®æ”¹etcd.confé…ç½®æ–‡ä»¶ä¸­çš„èŠ‚ç‚¹åç§°å’Œå½“å‰æœåŠ¡å™¨IPï¼š
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ ansible node -i /etc/ansible/hosts -m copy -a &#34;src=../../../../opt/etcd dest=/opt&#34; -f 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ ansible node -i /etc/ansible/hosts -m copy -a &#34;src=../../../../usr/lib/systemd/system/etcd.service dest=/usr/lib/systemd/system&#34; -f 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ mkdir -p /var/lib/etcd  	# ä¸‰ä¸ªèŠ‚ç‚¹éƒ½æ‰§è¡Œ
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ chmod +x /opt/etcd/bin/*  	# å…¶ä»–ä¸¤ä¸ªèŠ‚ç‚¹æ‰§è¡Œè¯­å¥ç»™äºˆæ‰§è¡Œæƒé™
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 10.æ‰€æœ‰èŠ‚ç‚¹è®¾ç½®å¼€æœºè‡ªå¯
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ systemctl daemon-reload
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ systemctl enable etcd &amp;&amp; systemctl start etcd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># æµ‹è¯•etcdæ•°æ®åº“å¯ç”¨æ€§
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ etcdctl set testdir/testkey0 0  	# è®¾ç½®ä¸€ä¸ªé”®å€¼å¯¹ 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ etcdctl get testdir/testkey0  	# æŸ¥çœ‹æ˜¯å¦è·å–åˆ°æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ etcdctl -C http://localhost:2379 cluster-health
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 11.æŸ¥çœ‹é›†ç¾¤çŠ¶æ€
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ ETCDCTL_API=3 /opt/etcd/bin/etcdctl --cacert=/opt/etcd/ssl/ca.pem --cert=/opt/etcd/ssl/etcd.pem --key=/opt/etcd/ssl/etcd-key.pem --endpoints=&#34;https://192.168.4.110:2379,https://192.168.4.111:2379,https://192.168.4.112:2379&#34; endpoint health &#39;</span> &gt;&gt;install_etcd.sh</span></span></code></pre></div></blockquote>
<hr>
<h3 id="ç½²master-nodeç”Ÿæˆkube-apiserverè¯ä¹¦è‡ªç­¾è¯ä¹¦é¢å‘æœºæ„ca">ç½²<code>Master Node</code>ï¼Œç”Ÿæˆ<code>kube-apiserver</code>è¯ä¹¦ï¼šè‡ªç­¾è¯ä¹¦é¢å‘æœºæ„<code>CA</code></h3>
<ul>
<li>
<ol>
<li><code>api-serverï¼š</code>æ‰€æœ‰æœåŠ¡è®¿é—®ç»Ÿä¸€å…¥å£</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 1.åˆ›å»ºè¯ä¹¦ç”³è¯·æ–‡ä»¶ï¼š
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># hostså­—æ®µä¸­IPä¸ºæ‰€æœ‰Master/LB/VIP IP,ä¸€ä¸ªéƒ½ä¸èƒ½å°‘ï¼ä¸ºäº†æ–¹ä¾¿åæœŸæ‰©å®¹å¯ä»¥å¤šå†™å‡ ä¸ªé¢„ç•™çš„IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cat &gt; /opt/kubernetes/ssl/kube-apiserver-csr.json &lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;CN&#34;: &#34;kubernetes&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;hosts&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;10.0.0.1&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;127.0.0.1&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;192.168.4.110&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;192.168.4.111&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;192.168.4.112&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;xxx.xxx.xxx.xxx&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;xxx.xxx.xxx.xxx&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;kubernetes&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;kubernetes.default&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;kubernetes.default.svc&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;kubernetes.default.svc.cluster&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;kubernetes.default.svc.cluster.local&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;key&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;size&#34;: 2048
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">},
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;names&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;L&#34;: &#34;BeiJing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;ST&#34;: &#34;BeiJing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;O&#34;: &#34;k8s&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;OU&#34;: &#34;System&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">######################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 2.ç”Ÿæˆè¯ä¹¦:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cd /opt/kubernetes/ssl
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-apiserver-csr.json | cfssljson -bare api-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># æ‰“å¼€é“¾æ¥ä¸‹è½½äºŒè¿›åˆ¶åŒ…
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.20.md#v1202
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cd /usr/local/src
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ wget https://dl.k8s.io/v1.18.6/kubernetes-server-linux-amd64.tar.gz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ tar zxvf kubernetes-server-linux-amd64.tar.gz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cd kubernetes/server/bin/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cp kube-apiserver kube-scheduler kube-controller-manager /opt/kubernetes/bin/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cp kubectl /usr/bin/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 3.éƒ¨ç½²kube-apiserver
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ä¸¤ä¸ª&#34;\\&#34;ç¬¬ä¸€ä¸ªæ˜¯è½¬ä¹‰ç¬¦ï¼Œç¬¬äºŒä¸ªæ˜¯æ¢è¡Œç¬¦ï¼Œä½¿ç”¨è½¬ä¹‰ç¬¦æ˜¯ä¸ºäº†ä½¿ç”¨EOFä¿ç•™æ¢è¡Œç¬¦
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cat &gt;/opt/kubernetes/cfg/kube-apiserver.conf&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">KUBE_APISERVER_OPTS=&#34;--logtostderr=false \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--v=2 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--log-dir=/opt/kubernetes/logs \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--etcd-servers=https://192.168.4.110:2379,https://192.168.4.111:2379,https://192.168.4.112:2379 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--bind-address=192.168.4.110 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--secure-port=6443 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--advertise-address=192.168.4.110 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--allow-privileged=true \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--service-cluster-ip-range=10.0.0.0/24 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--authorization-mode=RBAC,Node \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--enable-bootstrap-token-auth=true \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--token-auth-file=/opt/kubernetes/cfg/token.csv \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--service-node-port-range=30000-32767 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--kubelet-client-certificate=/opt/kubernetes/ssl/api-server.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--kubelet-client-key=/opt/kubernetes/ssl/api-server-key.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--tls-cert-file=/opt/kubernetes/ssl/api-server.pem  \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--tls-private-key-file=/opt/kubernetes/ssl/api-server-key.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--client-ca-file=/opt/kubernetes/ssl/ca.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--service-account-key-file=/opt/kubernetes/ssl/ca-key.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--etcd-cafile=/opt/etcd/ssl/ca.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--etcd-certfile=/opt/etcd/ssl/server.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--etcd-keyfile=/opt/etcd/ssl/server-key.pem \\  	# è¯ä¹¦éœ€è¦ä¿®æ”¹
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--audit-log-maxbackup=3 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--audit-log-maxsize=100 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--audit-log-path=/opt/kubernetes/logs/k8s-audit.log&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#######################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">â€“logtostderrï¼šå¯ç”¨æ—¥å¿—
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">â€”vï¼šæ—¥å¿—ç­‰çº§
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">â€“log-dirï¼šæ—¥å¿—ç›®å½•
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">â€“etcd-serversï¼šetcdé›†ç¾¤åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">â€“bind-addressï¼šç›‘å¬åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">â€“secure-portï¼šhttpså®‰å…¨ç«¯å£
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">â€“advertise-addressï¼šé›†ç¾¤é€šå‘Šåœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">â€“allow-privilegedï¼šå¯ç”¨æˆæƒ
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">â€“service-cluster-ip-rangeï¼šServiceè™šæ‹ŸIPåœ°å€æ®µ
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">â€“enable-admission-pluginsï¼šå‡†å…¥æ§åˆ¶æ¨¡å—
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">â€“authorization-modeï¼šè®¤è¯æˆæƒï¼Œå¯ç”¨RBACæˆæƒå’ŒèŠ‚ç‚¹è‡ªç®¡ç†
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">â€“enable-bootstrap-token-authï¼šå¯ç”¨TLS bootstrapæœºåˆ¶
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">â€“token-auth-fileï¼šbootstrap tokenæ–‡ä»¶
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">â€“service-node-port-rangeï¼šService nodeportç±»å‹é»˜è®¤åˆ†é…ç«¯å£èŒƒå›´
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">â€“kubelet-client-xxxï¼šapiserverè®¿é—®kubeletå®¢æˆ·ç«¯è¯ä¹¦
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">â€“tls-xxx-fileï¼šapiserver httpsè¯ä¹¦
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">â€“etcd-xxxfileï¼šè¿æ¥Etcdé›†ç¾¤è¯ä¹¦
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">â€“audit-log-xxxï¼šå®¡è®¡æ—¥å¿— &#39;</span>&gt;&gt; kube-apiserver.sh</span></span></code></pre></div></blockquote>
<hr>
<h3 id="å¯ç”¨tls-bootstrappingæœºåˆ¶">å¯ç”¨<code>TLS Bootstrapping</code>æœºåˆ¶</h3>
<ul>
<li>
<ol>
<li><code>TLS Bootstrapingï¼šMaster apiserver</code>å¯ç”¨<code>TLS</code>è®¤è¯åï¼Œ<code>Node</code>èŠ‚ç‚¹<code>kubelet</code>å’Œ<code>kube-proxy</code>è¦ä¸<code>kube-apiserver</code>è¿›è¡Œé€šä¿¡ï¼Œå¿…é¡»ä½¿ç”¨<code>CA</code>ç­¾å‘çš„æœ‰æ•ˆè¯ä¹¦æ‰å¯ä»¥ï¼Œå½“<code>Node</code>èŠ‚ç‚¹å¾ˆå¤šæ—¶ï¼Œè¿™ç§å®¢æˆ·ç«¯è¯ä¹¦é¢å‘éœ€è¦å¤§é‡å·¥ä½œï¼ŒåŒæ ·ä¹Ÿä¼šå¢åŠ é›†ç¾¤æ‰©å±•å¤æ‚åº¦ã€‚ä¸ºäº†ç®€åŒ–æµç¨‹ï¼Œ<code>Kubernetes</code>å¼•å…¥äº†<code>TLS bootstraping</code>æœºåˆ¶æ¥è‡ªåŠ¨é¢å‘å®¢æˆ·ç«¯è¯ä¹¦ï¼Œ<code>kubelet</code>ä¼šä»¥ä¸€ä¸ªä½æƒé™ç”¨æˆ·è‡ªåŠ¨å‘<code>apiserver</code>ç”³è¯·è¯ä¹¦ï¼Œ<code>kubelet</code>çš„è¯ä¹¦ç”±<code>apiserver</code>åŠ¨æ€ç­¾ç½²ã€‚æ‰€ä»¥å¼ºçƒˆå»ºè®®åœ¨<code>Node</code>ä¸Šä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œç›®å‰ä¸»è¦ç”¨äº<code>kubelet</code>ï¼Œ<code>kube-proxy</code>è¿˜æ˜¯ç”±æˆ‘ä»¬ç»Ÿä¸€é¢å‘ä¸€ä¸ªè¯ä¹¦</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">cat &gt;/opt/kubernetes/cfg/token.csv&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$(head -c 16 /dev/urandom | od -An -t x | tr -d &#39;</span> <span style="color:#e6db74">&#39;),kubelet-bootstrap,10001,&#34;system:node-bootstrapper&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">###########################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># è‡ªè¡Œç”Ÿæˆtoken
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># token=$(head -c 16 /dev/urandom | od -An -t x | tr -d &#39;</span> <span style="color:#e6db74">&#39;)  	# Cè¯­è¨€æ‰§è¡Œç”Ÿæˆæ–¹å¼
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># token=`head -c 16 /dev/urandom | od -An -t x | tr -d &#39;</span> <span style="color:#e6db74">&#39;`  	# shellæ‰§è¡Œç”Ÿæˆæ–¹å¼
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># sed -i &#34;s/c47ffb939f5ca36231d9e3121a252940/${token}/g&#34;  /opt/kubernetes/cfg/token.csv
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># systemctç®¡ç†apiserverã€å¹¶è®¾ç½®å¼€æœºè‡ªå¯
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">cat &gt;/usr/lib/systemd/system/kube-apiserver.service&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=Kubernetes API Server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Documentation=https://github.com/kubernetes/kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EnvironmentFile=/opt/kubernetes/cfg/kube-apiserver.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/kubernetes/bin/kube-apiserver \$KUBE_APISERVER_OPTS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#######################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ systemctl daemon-reload
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ systemctl enable kube-apiserver &amp;&amp; systemctl start kube-apiserver
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># kube-apiserveræŠ¥é”™æ’æŸ¥
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cat /var/log/messages|grep kube-apiserver|grep -i error  	# -iä¸åŒºåˆ†å¤§å°å†™
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">journalctl -xe -u kube-apiserver | more  	# å‘½ä»¤æ’é”™ 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 3.è®¾ç½®æˆæƒkubelet-bootstrapç”¨æˆ·å…è®¸è¯·æ±‚è¯ä¹¦
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --user=kubelet-bootstrap &#39;</span> &gt;&gt;token-apiserver.sh</span></span></code></pre></div></blockquote>
<hr>
<h3 id="éƒ¨ç½²kube-controller-manageræ§åˆ¶å™¨">éƒ¨ç½²<code>kube-controller-manager</code>(æ§åˆ¶å™¨)</h3>
<ul>
<li>
<ol>
<li><code>Pod</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>1.1 <!-- raw HTML omitted -->æœ€å°éƒ¨ç½²å•å…ƒ<!-- raw HTML omitted --></li>
<li>1.2 <!-- raw HTML omitted -->ä¸€ç»„å®¹å™¨çš„é›†åˆ<!-- raw HTML omitted --></li>
<li>1.3 <!-- raw HTML omitted -->ä¸€ä¸ª<code>Pod</code>ä¸­çš„å®¹å™¨å…±äº«ç½‘ç»œå‘½åç©ºé—´<!-- raw HTML omitted --></li>
<li>1.4 <!-- raw HTML omitted --><code>Pod</code>æ˜¯çŸ­æš‚çš„<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li>
<ol start="2">
<li><code>Controllers</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>2.1 <!-- raw HTML omitted --><code>Deploymentï¼š</code>æ— çŠ¶æ€åº”ç”¨éƒ¨ç½²<!-- raw HTML omitted --></li>
<li>2.2 <!-- raw HTML omitted --><code>StatefulSetï¼š</code>æœ‰çŠ¶æ€åº”ç”¨éƒ¨ç½²<!-- raw HTML omitted --></li>
<li>2.3 <!-- raw HTML omitted --><code>DaemonSetï¼š</code>ç¡®ä¿æ‰€æœ‰çš„<code>Node</code>è¿è¡Œä¸€ä¸ª<code>Pod</code><!-- raw HTML omitted --></li>
<li>2.4 <!-- raw HTML omitted --><code>Jobï¼š</code>ä¸€æ¬¡æ€§ä»»åŠ¡<!-- raw HTML omitted --></li>
<li>2.5 <!-- raw HTML omitted --><code>Cronjobï¼š</code>å®šæ—¶ä»»åŠ¡<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->æ›´é«˜çº§å±‚çº§å¯¹è±¡ï¼Œéƒ¨ç½²å’Œç®¡ç†<code>Pod</code><!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="4">
<li><code>Service</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>4.1 <!-- raw HTML omitted -->é˜²æ­¢<code>Pod</code>å¤±è”<!-- raw HTML omitted --></li>
<li>4.2 <!-- raw HTML omitted -->å®šä¹‰ä¸€ç»„<code>Pod</code>çš„è®¿é—®ç­–ç•¥<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted --><code>Labelï¼š</code>æ ‡ç­¾ï¼Œé™„åŠ åˆ°æŸä¸ªèµ„æºä¸Šï¼Œç”¨äºå…³è”å¯¹è±¡ï¼ŒæŸ¥è¯¢å’Œç­›é€‰<!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="6">
<li><!-- raw HTML omitted --><code>Namespacesï¼š</code>å‘½åç©ºé—´ï¼Œå°†å¯¹è±¡é€»è¾‘ä¸Šéš”ç¦»<!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="7">
<li><!-- raw HTML omitted --><code>Controllerï¼š</code>ç»´æŒå‰¯æœ¬æœŸæœ›æ•°ç›®,<code>ReplicaSet</code>æ›¿ä»£<code>ReplicationControlled</code><!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="8">
<li><!-- raw HTML omitted --><code>deployentï¼š</code>ç®¡ç†<code>RS</code>ï¼Œå®ç°æ»šåŠ¨æ›´æ–°<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>8.1 <!-- raw HTML omitted --><code>--kubeconfigï¼š</code>è¿æ¥<code>apiserver</code>é…ç½®æ–‡ä»¶<!-- raw HTML omitted --></li>
<li>8.2 <!-- raw HTML omitted --><code>--masterï¼š</code>é€šè¿‡æœ¬åœ°éå®‰å…¨æœ¬åœ°ç«¯å£<code>8080</code>è¿æ¥<code>apiserver</code><!-- raw HTML omitted --></li>
<li>8.3 <!-- raw HTML omitted --><code>--leader-electï¼š</code>å½“è¯¥ç»„ä»¶å¯åŠ¨å¤šä¸ªæ—¶ï¼Œè‡ªåŠ¨é€‰ä¸¾<code>HA</code><!-- raw HTML omitted --></li>
<li>8.4 <!-- raw HTML omitted --><code>--cluster-signing-cert-file/--cluster-signing-key-fileï¼š</code>è‡ªåŠ¨ä¸º<code>kubelet</code>é¢å‘è¯ä¹¦çš„<code>CA</code>ï¼Œä¸<code>apiserver</code>ä¿æŒä¸€è‡´<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºé…ç½®æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/kube-controller-manager.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">KUBE_CONTROLLER_MANAGER_OPTS=&#34;--logtostderr=false \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--v=2 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--log-dir=/opt/kubernetes/logs \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--leader-elect=true \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--kubeconfig=/opt/kubernetes/cfg/kube-controller-manager.kubeconfig \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--master=127.0.0.1:8080 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--bind-address=127.0.0.1 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--allocate-node-cidrs=true \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cluster-cidr=10.244.0.0/16 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--service-cluster-ip-range=10.0.0.0/24 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cluster-signing-cert-file=/opt/kubernetes/ssl/ca.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cluster-signing-key-file=/opt/kubernetes/ssl/ca-key.pem  \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--root-ca-file=/opt/kubernetes/ssl/ca.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--service-account-private-key-file=/opt/kubernetes/ssl/ca-key.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--experimental-cluster-signing-duration=87600h0m0s&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºkube-controller-manager-csr.json è¯ä¹¦è¯·æ±‚æ–‡ä»¶ï¼Œå¯ä»¥è¶Šè¿‡</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cat &gt;/opt/kubernetes/ssl/kube-controller-manager-csr.json&lt;&lt;-EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># {</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &#34;CN&#34;: &#34;system:kube-controller-manager&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &#34;hosts&#34;: [],</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &#34;key&#34;: {</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    &#34;algo&#34;: &#34;rsa&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    &#34;size&#34;: 2048</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  },</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &#34;names&#34;: [</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    {</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;C&#34;: &#34;CN&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;L&#34;: &#34;BeiJing&#34;, </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;ST&#34;: &#34;BeiJing&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;O&#34;: &#34;system:masters&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;OU&#34;: &#34;System&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    }</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  ]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># }</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç”Ÿæˆè¯ä¹¦</span>
</span></span><span style="display:flex;"><span>$ cd /opt/kubernetes/ssl
</span></span><span style="display:flex;"><span>$ cfssl gencert -ca<span style="color:#f92672">=</span>ca.pem -ca-key<span style="color:#f92672">=</span>ca-key.pem -config<span style="color:#f92672">=</span>ca-config.json -profile<span style="color:#f92672">=</span>kubernetes kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="9">
<li><!-- raw HTML omitted -->ç”Ÿæˆ<code>kubeconfig</code>æ–‡ä»¶ï¼ˆä»¥ä¸‹æ˜¯<code>shell</code>å‘½ä»¤ï¼Œç›´æ¥åœ¨ç»ˆç«¯æ‰§è¡Œï¼‰ï¼šå¯ä»¥è¶Šè¿‡<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># KUBE_CONFIG=&#34;/opt/kubernetes/cfg/kube-controller-manager.kubeconfig&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># KUBE_APISERVER=&#34;https://192.168.4.110:6443&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>$ kubectl config set-cluster kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#75715e">#  --certificate-authority=/opt/kubernetes/ssl/ca.pem \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --embed-certs=true \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --server=${KUBE_APISERVER} \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --kubeconfig=${KUBE_CONFIG}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config set-credentials kube-controller-manager <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#75715e">#  --client-certificate=./kube-controller-manager.pem \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --client-key=./kube-controller-manager-key.pem \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --embed-certs=true \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --kubeconfig=${KUBE_CONFIG}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config set-context default <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#75715e">#  --cluster=kubernetes \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --user=kube-controller-manager \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --kubeconfig=${KUBE_CONFIG}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config use-context default --kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="systemdç®¡ç†controller-manager"><code>systemd</code>ç®¡ç†<code>controller-manager</code></h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted --><code>Controller manager</code>ï¼ˆé»˜è®¤ç«¯å£ï¼š<code>10252</code>ï¼‰ç›‘è§†<code>Kubernetes</code>é›†ç¾¤ï¼Œä»¥æ£€æµ‹å’Œç»´æŠ¤<code>Kubernetes</code>ç¯å¢ƒçš„å‡ ä¸ªæ–¹é¢ï¼ŒåŒ…æ‹¬å°†<code>Pod</code>åŠ å…¥åˆ°æœåŠ¡ä¸­ï¼Œä¿æŒä¸€ç»„<code>Pod</code>çš„æ­£ç¡®æ•°é‡ï¼Œå¹¶å¯¹èŠ‚ç‚¹çš„ä¸¢å¤±åšå‡ºååº”<!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="2">
<li><!-- raw HTML omitted --><code>Cloud controller manager</code>ï¼ˆé»˜è®¤ç«¯å£ï¼š10258ï¼‰ä¸€ä¸ªç”¨äºåŸºäºäº‘çš„éƒ¨ç½²çš„å¯é€‰ç»„ä»¶ã€‚äº‘æ§åˆ¶å™¨ä¸äº‘æœåŠ¡æä¾›å•†æ¥å£ï¼Œä»¥ç®¡ç†é›†ç¾¤çš„è´Ÿè½½å‡è¡¡å™¨å’Œè™šæ‹Ÿç½‘ç»œ<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/usr/lib/systemd/system/kube-controller-manager.service<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=Kubernetes Controller Manager
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Documentation=https://github.com/kubernetes/kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EnvironmentFile=/opt/kubernetes/cfg/kube-controller-manager.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/kubernetes/bin/kube-controller-manager \$KUBE_CONTROLLER_MANAGER_OPTS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecReload=/bin/kill -HUP $MAINPID
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="å¯åŠ¨å¹¶è®¾ç½®å¼€æœºå¯åŠ¨">å¯åŠ¨å¹¶è®¾ç½®å¼€æœºå¯åŠ¨</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl daemon-reload
</span></span><span style="display:flex;"><span>$ systemctl enable kube-controller-manager <span style="color:#f92672">&amp;&amp;</span> systemctl start kube-controller-manager</span></span></code></pre></div></blockquote>
<hr>
<h3 id="éƒ¨ç½²kube-scheduleråˆ›å»ºé…ç½®æ–‡ä»¶è°ƒåº¦å™¨è´Ÿè´£é›†ç¾¤èµ„æºè°ƒåº¦ç»„ä»¶æŠ½ç¦»">éƒ¨ç½²<code>kube-scheduler</code>:åˆ›å»ºé…ç½®æ–‡ä»¶(è°ƒåº¦å™¨è´Ÿè´£é›†ç¾¤èµ„æºè°ƒåº¦,ç»„ä»¶æŠ½ç¦»)</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted --><code>Schedulerï¼š</code>è´Ÿè´£ä»‹ç»ä»»åŠ¡ï¼Œé€‰æ‹©åˆé€‚çš„èŠ‚ç‚¹è¿›è¡Œåˆ†é…ä»»åŠ¡<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>1.1 <!-- raw HTML omitted --><code>--kubeconfig</code>ï¼šè¿æ¥<code>apiserver</code>é…ç½®æ–‡ä»¶<!-- raw HTML omitted --></li>
<li>1.2 <!-- raw HTML omitted --><code>--master</code>ï¼šé€šè¿‡æœ¬åœ°éå®‰å…¨æœ¬åœ°ç«¯å£8080è¿æ¥<code>apiserver</code><!-- raw HTML omitted --></li>
<li>1.3 <!-- raw HTML omitted --><code>--leader-elect</code>ï¼šå½“è¯¥ç»„ä»¶å¯åŠ¨å¤šä¸ªæ—¶ï¼Œè‡ªåŠ¨é€‰ä¸¾(HA) <!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/kube-scheduler.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">KUBE_SCHEDULER_OPTS=&#34;--logtostderr=false \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--v=2 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--log-dir=/opt/kubernetes/logs \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--leader-elect \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#--kubeconfig=/opt/kubernetes/cfg/kube-scheduler.kubeconfig \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--master=127.0.0.1:8080 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--bind-address=127.0.0.1&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->åˆ›å»º<code>kube-scheduler-csr.json</code>è¯ä¹¦è¯·æ±‚æ–‡ä»¶ï¼šå¯ä»¥è¶Šè¿‡æ­¤æ­¥éª¤<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># cat &gt;/opt/kubernetes/ssl/kube-scheduler-csr.json&lt;&lt;-EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># {</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &#34;CN&#34;: &#34;system:kube-scheduler&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &#34;hosts&#34;: [],</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &#34;key&#34;: {</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    &#34;algo&#34;: &#34;rsa&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    &#34;size&#34;: 2048</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  },</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &#34;names&#34;: [</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    {</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;C&#34;: &#34;CN&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;L&#34;: &#34;BeiJing&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;ST&#34;: &#34;BeiJing&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;O&#34;: &#34;system:masters&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;OU&#34;: &#34;System&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    }</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  ]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># }</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç”Ÿæˆè¯ä¹¦</span>
</span></span><span style="display:flex;"><span>$ cd /opt/kubernetes/ssl
</span></span><span style="display:flex;"><span>$ cfssl gencert -ca<span style="color:#f92672">=</span>ca.pem -ca-key<span style="color:#f92672">=</span>ca-key.pem -config<span style="color:#f92672">=</span>ca-config.json -profile<span style="color:#f92672">=</span>kubernetes kube-scheduler-csr.json | cfssljson -bare kube-scheduler</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->ç”Ÿæˆ<code>kubeconfig</code>æ–‡ä»¶(ä»¥ä¸‹æ˜¯<code>shell</code>å‘½ä»¤ï¼Œç›´æ¥åœ¨ç»ˆç«¯æ‰§è¡Œ)ï¼šæ­¤æ­¥éª¤å¯ä»¥è¶Šè¿‡<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># KUBE_CONFIG=&#34;/opt/kubernetes/cfg/kube-scheduler.kubeconfig&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># KUBE_APISERVER=&#34;https://192.168.100.11:6443&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config set-cluster kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#75715e">#  --certificate-authority=/opt/kubernetes/ssl/ca.pem \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --embed-certs=true \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --server=${KUBE_APISERVER} \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --kubeconfig=${KUBE_CONFIG}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config set-credentials kube-scheduler <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#75715e">#  --client-certificate=./kube-scheduler.pem \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --client-key=./kube-scheduler-key.pem \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --embed-certs=true \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --kubeconfig=${KUBE_CONFIG}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config set-context default <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#75715e">#  --cluster=kubernetes \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --user=kube-scheduler \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --kubeconfig=${KUBE_CONFIG}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config use-context default --kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="systemdç®¡ç†scheduler"><code>systemd</code>ç®¡ç†<code>scheduler</code></h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/usr/lib/systemd/system/kube-scheduler.service<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=Kubernetes Scheduler
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Documentation=https://github.com/kubernetes/kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EnvironmentFile=/opt/kubernetes/cfg/kube-scheduler.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/kubernetes/bin/kube-scheduler \$KUBE_SCHEDULER_OPTS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->è®¾ç½®å¼€æœºè‡ªå·±å¹¶ä¸”å¯åŠ¨æœåŠ¡å™¨<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl daemon-reload
</span></span><span style="display:flex;"><span>$ systemctl enable kube-scheduler <span style="color:#f92672">&amp;&amp;</span> systemctl start kube-scheduler</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->ç”Ÿæˆ<code>kubectl</code>è¿æ¥é›†ç¾¤çš„è¯ä¹¦ï¼š<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/ssl/admin-csr.json<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;CN&#34;: &#34;admin&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;hosts&#34;: [],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;key&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;size&#34;: 2048
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">},
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;names&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;L&#34;: &#34;BeiJing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;ST&#34;: &#34;BeiJing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;O&#34;: &#34;system:masters&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;OU&#34;: &#34;System&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->ç”Ÿæˆè¯ä¹¦<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /opt/kubernetes/ssl/
</span></span><span style="display:flex;"><span>$ cfssl gencert -ca<span style="color:#f92672">=</span>ca.pem -ca-key<span style="color:#f92672">=</span>ca-key.pem -config<span style="color:#f92672">=</span>ca-config.json -profile<span style="color:#f92672">=</span>kubernetes admin-csr.json | cfssljson -bare admin</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->ç”Ÿæˆ<code>kubeconfig</code>æ–‡ä»¶<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir /root/.kube
</span></span><span style="display:flex;"><span>$ KUBE_CONFIG<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/root/.kube/config&#34;</span>
</span></span><span style="display:flex;"><span>$ KUBE_APISERVER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://192.168.4.110:6443&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config set-cluster kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--certificate-authority<span style="color:#f92672">=</span>/opt/kubernetes/ssl/ca.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--server<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_APISERVER<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>$ kubectl config set-credentials cluster-admin <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--client-certificate<span style="color:#f92672">=</span>./admin.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--client-key<span style="color:#f92672">=</span>./admin-key.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>$ kubectl config set-context default <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cluster<span style="color:#f92672">=</span>kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--user<span style="color:#f92672">=</span>cluster-admin <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>$ kubectl config use-context default --kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->é€šè¿‡<code>kubectl</code>å·¥å…·æŸ¥çœ‹å½“å‰é›†ç¾¤ç»„ä»¶çŠ¶æ€<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl get cs
</span></span><span style="display:flex;"><span>NAME                 STATUS    MESSAGE             ERROR
</span></span><span style="display:flex;"><span>controller-manager   Healthy   ok                  
</span></span><span style="display:flex;"><span>scheduler            Healthy   ok                  
</span></span><span style="display:flex;"><span>etcd-0               Healthy   <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;health&#34;</span>:<span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">}</span>   
</span></span><span style="display:flex;"><span>etcd-1               Healthy   <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;health&#34;</span>:<span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">}</span>   
</span></span><span style="display:flex;"><span>etcd-2               Healthy   <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;health&#34;</span>:<span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">}</span> </span></span></code></pre></div></blockquote>
<hr>
<h3 id="åœ¨masteræ“ä½œéƒ¨ç½²worker-node">åœ¨<code>Master</code>æ“ä½œéƒ¨ç½²<code>Worker Node</code></h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted --><code>Kubeletï¼š</code>ç›´æ¥è·Ÿå®¹å™¨å¼•æ“äº¤äº’å®ç°å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†<!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="2">
<li><!-- raw HTML omitted --><code>Kube proxyï¼š</code>è´Ÿè´£å†™å…¥è§„åˆ™è‡³<code>iptables</code>ã€<code>ipvs</code>å®ç°æœåŠ¡æ˜ å°„è®¿é—®<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>2.1 <!-- raw HTML omitted --><code>--hostname-override</code>ï¼šæ˜¾ç¤ºåç§°ï¼Œé›†ç¾¤ä¸­å”¯ä¸€<!-- raw HTML omitted --></li>
<li>2.2 <!-- raw HTML omitted --><code>--network-plugin</code>ï¼šå¯ç”¨<code>CNI</code><!-- raw HTML omitted --></li>
<li>2.3 <!-- raw HTML omitted --><code>--kubeconfig</code>ï¼šç©ºè·¯å¾„ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆï¼Œåé¢ç”¨äºè¿æ¥<code>apiserver</code><!-- raw HTML omitted --></li>
<li>2.4 <!-- raw HTML omitted --><code>--bootstrap-kubeconfig</code>ï¼šé¦–æ¬¡å¯åŠ¨å‘<code>apiserver</code>ç”³è¯·è¯ä¹¦<!-- raw HTML omitted --></li>
<li>2.5 <!-- raw HTML omitted --><code>--config</code>ï¼šé…ç½®å‚æ•°æ–‡ä»¶<!-- raw HTML omitted --></li>
<li>2.6 <!-- raw HTML omitted --><code>--cert-dir</code>ï¼š<code>kubelet</code>è¯ä¹¦ç”Ÿæˆç›®å½•<!-- raw HTML omitted --></li>
<li>2.7 <!-- raw HTML omitted --><code>--pod-infra-container-image</code>ï¼šç®¡ç†<code>Pod</code>ç½‘ç»œå®¹å™¨çš„é•œåƒ<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /usr/local/src/kubernetes/server/bin/
</span></span><span style="display:flex;"><span>$ cp kubelet kube-proxy /opt/kubernetes/bin   <span style="color:#75715e"># æœ¬åœ°æ‹·è´</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># éƒ¨ç½²bubelet</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/kubelet.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">KUBELET_OPTS=&#34;--logtostderr=false \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--v=2 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--log-dir=/opt/kubernetes/logs \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--hostname-override=k8s-master \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--network-plugin=cni \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--bootstrap-kubeconfig=/opt/kubernetes/cfg/bootstrap.kubeconfig \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--config=/opt/kubernetes/cfg/kubelet-config.yml \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cert-dir=/opt/kubernetes/ssl \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--pod-infra-container-image=lizhenliang/pause-amd64:3.0&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="é…ç½®å‚æ•°æ–‡ä»¶">é…ç½®å‚æ•°æ–‡ä»¶</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/kubelet-config.yml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: KubeletConfiguration
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: kubelet.config.k8s.io/v1beta1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">address: 0.0.0.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">port: 10250
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">readOnlyPort: 10255
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">cgroupDriver: cgroupfs
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">clusterDNS:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - 10.0.0.2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">clusterDomain: cluster.local 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">failSwapOn: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">authentication:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  anonymous:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    enabled: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  webhook:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    cacheTTL: 2m0s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  x509:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    clientCAFile: /opt/kubernetes/ssl/ca.pem 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">authorization:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  mode: Webhook
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  webhook:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    cacheAuthorizedTTL: 5m0s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    cacheUnauthorizedTTL: 30s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">evictionHard:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  imagefs.available: 15%
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  memory.available: 100Mi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  nodefs.available: 10%
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  nodefs.inodesFree: 5%
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">maxOpenFiles: 1000000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">maxPods: 110
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="åœ¨masterèŠ‚ç‚¹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ç”Ÿæˆkubeletåˆæ¬¡åŠ å…¥é›†ç¾¤å¼•å¯¼bootstrapkubeconfigæ–‡ä»¶">åœ¨<code>master</code>èŠ‚ç‚¹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œç”Ÿæˆ<code>kubelet</code>åˆæ¬¡åŠ å…¥é›†ç¾¤å¼•å¯¼<code>bootstrap.kubeconfig</code>æ–‡ä»¶</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ KUBE_CONFIG<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/opt/kubernetes/cfg/bootstrap.kubeconfig&#34;</span>
</span></span><span style="display:flex;"><span>$ KUBE_APISERVER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://192.168.4.110:6443&#34;</span> <span style="color:#75715e"># apiserver IP:PORT</span>
</span></span><span style="display:flex;"><span>$ TOKEN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;bed185231bd89516f68ed5031946b9f9&#34;</span>  	<span style="color:#75715e"># ä¸token.csvé‡Œä¿æŒä¸€è‡´</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç”Ÿæˆ kubelet bootstrap kubeconfig é…ç½®æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>$ kubectl config set-cluster kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--certificate-authority<span style="color:#f92672">=</span>/opt/kubernetes/ssl/ca.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--server<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_APISERVER<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>Cluster <span style="color:#e6db74">&#34;kubernetes&#34;</span> set.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config set-credentials <span style="color:#e6db74">&#34;kubelet-bootstrap&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--token<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>TOKEN<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>User <span style="color:#e6db74">&#34;kubelet-bootstrap&#34;</span> set.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config set-context default <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cluster<span style="color:#f92672">=</span>kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--user<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;kubelet-bootstrap&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>Context <span style="color:#e6db74">&#34;default&#34;</span> created.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config use-context default --kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>Switched to context <span style="color:#e6db74">&#34;default&#34;</span>.</span></span></code></pre></div></blockquote>
<hr>
<h3 id="systemç®¡ç†kubelet"><code>system</code>ç®¡ç†<code>kubelet</code></h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt; /usr/lib/systemd/system/kubelet.service <span style="color:#e6db74">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=Kubernetes Kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=docker.service
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EnvironmentFile=/opt/kubernetes/cfg/kubelet.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/kubernetes/bin/kubelet \$KUBELET_OPTS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LimitNOFILE=65536
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">####################################################################</span>
</span></span><span style="display:flex;"><span>$ systemctl daemon-reload
</span></span><span style="display:flex;"><span>$ systemctl enable kubelet systemctl start kubelet</span></span></code></pre></div></blockquote>
<hr>
<h3 id="æ‰¹å‡†kubeletè¯ä¹¦ç”³è¯·å¹¶åŠ å…¥é›†ç¾¤">æ‰¹å‡†<code>kubelet</code>è¯ä¹¦ç”³è¯·å¹¶åŠ å…¥é›†ç¾¤</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹kubeletè¯ä¹¦è¯·æ±‚</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get csr</span>
</span></span><span style="display:flex;"><span>NAME                                                   AGE     SIGNERNAME                                    REQUESTOR           CONDITION
</span></span><span style="display:flex;"><span>node-csr-Pbamt5FDLAwv0HlJpcgUP9B5c4ynIRe0Xa17zXq9I6E   4m16s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ‰¹å‡†ç”³è¯·</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl certificate approve node-csr-Pbamt5FDLAwv0HlJpcgUP9B5c4ynIRe0Xa17zXq9I6E</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>certificatesigningrequest.certificates.k8s.io/node-csr-Pbamt5FDLAwv0HlJpcgUP9B5c4ynIRe0Xa17zXq9I6E approved
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹èŠ‚ç‚¹,ç”±äºç½‘ç»œæ’ä»¶æ²¡æœ‰éƒ¨ç½²ï¼ŒèŠ‚ç‚¹çŠ¶æ€ NotReady</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get node</span>
</span></span><span style="display:flex;"><span>NAME         STATUS     ROLES    AGE   VERSION
</span></span><span style="display:flex;"><span>k8s-master   NotReady   &lt;none&gt;   71s   v1.18.3</span></span></code></pre></div></blockquote>
<hr>
<h3 id="éƒ¨ç½²kube-proxy">éƒ¨ç½²<code>kube-proxy</code></h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 1. åˆ›å»ºé…ç½®kube-proxyæ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/kube-proxy.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">KUBE_PROXY_OPTS=&#34;--logtostderr=false \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--v=2 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--log-dir=/opt/kubernetes/logs \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--config=/opt/kubernetes/cfg/kube-proxy-config.yml&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2. é…ç½®å‚æ•°æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/kube-proxy-config.yml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: KubeProxyConfiguration
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: kubeproxy.config.k8s.io/v1alpha1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">bindAddress: 0.0.0.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metricsBindAddress: 0.0.0.0:10249
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">clientConnection:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kubeconfig: /opt/kubernetes/cfg/kube-proxy.kubeconfig
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">hostnameOverride: k8s-master
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">clusterCIDR: 10.0.0.0/24
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3. ç”Ÿæˆkube-proxy.kubeconfigæ–‡ä»¶ï¼šç”Ÿæˆkube-proxyè¯ä¹¦ï¼š</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/ssl/kube-proxy-csr.json<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;CN&#34;: &#34;system:kube-proxy&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;hosts&#34;: [],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;key&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;size&#34;: 2048
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">},
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;names&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;L&#34;: &#34;BeiJing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;ST&#34;: &#34;BeiJing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;O&#34;: &#34;k8s&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;OU&#34;: &#34;System&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 4.ç”Ÿæˆè¯ä¹¦</span>
</span></span><span style="display:flex;"><span>$ cd /opt/kubernetes/ssl/
</span></span><span style="display:flex;"><span>$ cfssl gencert -ca<span style="color:#f92672">=</span>ca.pem -ca-key<span style="color:#f92672">=</span>ca-key.pem -config<span style="color:#f92672">=</span>ca-config.json -profile<span style="color:#f92672">=</span>kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 5. ç”Ÿæˆkubeconfigæ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>$ KUBE_CONFIG<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/opt/kubernetes/cfg/kube-proxy.kubeconfig&#34;</span>
</span></span><span style="display:flex;"><span>$ KUBE_APISERVER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://192.168.4.110:6443&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ssl<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl config set-cluster kubernetes \</span>
</span></span><span style="display:flex;"><span>--certificate-authority<span style="color:#f92672">=</span>/opt/kubernetes/ssl/ca.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--server<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_APISERVER<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>Cluster <span style="color:#e6db74">&#34;kubernetes&#34;</span> set.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ssl<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl config set-credentials kube-proxy \</span>
</span></span><span style="display:flex;"><span>--client-certificate<span style="color:#f92672">=</span>./kube-proxy.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--client-key<span style="color:#f92672">=</span>./kube-proxy-key.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>User <span style="color:#e6db74">&#34;kube-proxy&#34;</span> set.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ssl<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl config set-context default \</span>
</span></span><span style="display:flex;"><span>--cluster<span style="color:#f92672">=</span>kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--user<span style="color:#f92672">=</span>kube-proxy <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>Context <span style="color:#e6db74">&#34;default&#34;</span> created.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ssl<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl config use-context default --kubeconfig=${KUBE_CONFIG}</span>
</span></span><span style="display:flex;"><span>Switched to context <span style="color:#e6db74">&#34;default&#34;</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 6.systemç®¡ç†kube-proxy</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/usr/lib/systemd/system/kube-proxy.service<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=Kubernetes Proxy
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EnvironmentFile=/opt/kubernetes/cfg/kube-proxy.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/kubernetes/bin/kube-proxy \$KUBE_PROXY_OPTS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LimitNOFILE=65536
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">########################################################################</span>
</span></span><span style="display:flex;"><span>$ systemctl daemon-reload
</span></span><span style="display:flex;"><span>$ systemctl enable kube-proxy <span style="color:#f92672">&amp;&amp;</span> systemctl start kube-proxy</span></span></code></pre></div></blockquote>
<hr>
<h3 id="éƒ¨ç½²ç½‘ç»œç»„ä»¶">éƒ¨ç½²ç½‘ç»œç»„ä»¶</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted --><code>Calico</code>æ˜¯ä¸€ä¸ªçº¯ä¸‰å±‚çš„æ•°æ®ä¸­å¿ƒç½‘ç»œæ–¹æ¡ˆï¼Œæ˜¯ç›®å‰<code>Kubernetes</code>ä¸»æµçš„ç½‘ç»œæ–¹æ¡ˆã€‚éƒ¨ç½²<code>Calico</code><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /usr/local/src/
</span></span><span style="display:flex;"><span>$ wget https://docs.projectcalico.org/v3.14/manifests/calico.yaml
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master src<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f calico.yaml  # ç­‰Calico Podéƒ½Runningï¼ŒèŠ‚ç‚¹ä¹Ÿä¼šå‡†å¤‡å°±ç»ª</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master src<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get node</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master src<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pod -n kube-system</span>
</span></span><span style="display:flex;"><span>NAME                                       READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>calico-kube-controllers-65f8bc95db-27zj8   1/1     Running   <span style="color:#ae81ff">0</span>          37m
</span></span><span style="display:flex;"><span>calico-node-skvcj                          1/1     Running   <span style="color:#ae81ff">0</span>          37m</span></span></code></pre></div></blockquote>
<hr>
<h4 id="éƒ¨ç½²cniç½‘ç»œ">éƒ¨ç½²<code>CNI</code>ç½‘ç»œ</h4>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->å…ˆå‡†å¤‡å¥½<code>CNI</code>äºŒè¿›åˆ¶æ–‡ä»¶<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -p /opt/cni/bin
</span></span><span style="display:flex;"><span>$ cd /usr/local/src/
</span></span><span style="display:flex;"><span>$ wget https://github.com/containernetworking/plugins/releases/download/v0.8.6/cni-plugins-linux-amd64-v0.8.6.tgz  	<span style="color:#75715e"># ä¸‹è½½äºŒè¿›åˆ¶å®‰è£…åŒ…</span>
</span></span><span style="display:flex;"><span>$ tar zxvf cni-plugins-linux-amd64-v0.8.6.tgz -C /opt/cni/bin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># éƒ¨ç½²CNIç½‘ç»œ</span>
</span></span><span style="display:flex;"><span>$ cd /opt/kubernetes/cfg/
</span></span><span style="display:flex;"><span>$ wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</span></span><span style="display:flex;"><span>$ sed -i -r <span style="color:#e6db74">&#34;s#quay.io/coreos/flannel:.*-amd64#lizhenliang/flannel:v0.12.0-amd64#g&#34;</span> kube-flannel.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master cfg<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f kube-flannel.yml</span>
</span></span><span style="display:flex;"><span>podsecuritypolicy.policy/psp.flannel.unprivileged created
</span></span><span style="display:flex;"><span>clusterrole.rbac.authorization.k8s.io/flannel created
</span></span><span style="display:flex;"><span>clusterrolebinding.rbac.authorization.k8s.io/flannel created
</span></span><span style="display:flex;"><span>serviceaccount/flannel created
</span></span><span style="display:flex;"><span>configmap/kube-flannel-cfg created
</span></span><span style="display:flex;"><span>daemonset.apps/kube-flannel-ds created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master cfg<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n kube-system</span>
</span></span><span style="display:flex;"><span>NAME                    READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>kube-flannel-ds-xv7db   1/1     Running   <span style="color:#ae81ff">0</span>          58s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master cfg<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get node</span>
</span></span><span style="display:flex;"><span>NAME         STATUS   ROLES    AGE   VERSION
</span></span><span style="display:flex;"><span>k8s-master   Ready    &lt;none&gt;   23m   v1.18.3</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->æˆæƒ<code>apiserver</code>è®¿é—®<code>kubelet</code><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/apiserver-to-kubelet-rbac.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: ClusterRole
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">annotations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rbac.authorization.kubernetes.io/autoupdate: &#34;true&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kubernetes.io/bootstrapping: rbac-defaults
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name: system:kube-apiserver-to-kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rules:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - apiGroups:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    resources:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - nodes/proxy
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - nodes/stats
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - nodes/log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - nodes/spec
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - nodes/metrics
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - pods/log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    verbs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &#34;*&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: ClusterRoleBinding
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: system:kube-apiserver
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: &#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">roleRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  apiGroup: rbac.authorization.k8s.io
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  kind: ClusterRole
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: system:kube-apiserver-to-kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">subjects:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - apiGroup: rbac.authorization.k8s.io
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    kind: User
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##############################################################</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master cfg<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f apiserver-to-kubelet-rbac.yaml</span>
</span></span><span style="display:flex;"><span>clusterrole.rbac.authorization.k8s.io/system:kube-apiserver-to-kubelet created
</span></span><span style="display:flex;"><span>clusterrolebinding.rbac.authorization.k8s.io/system:kube-apiserver created</span></span></code></pre></div></blockquote>
<hr>
<h3 id="æ–°å¢åŠ worker-nodeæ‹·è´å·²éƒ¨ç½²å¥½çš„nodeç›¸å…³æ–‡ä»¶åˆ°æ–°èŠ‚ç‚¹">æ–°å¢åŠ <code>Worker Node:</code>æ‹·è´å·²éƒ¨ç½²å¥½çš„<code>Node</code>ç›¸å…³æ–‡ä»¶åˆ°æ–°èŠ‚ç‚¹</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->åœ¨<code>master</code>èŠ‚ç‚¹å°†<code>Worker Node</code>æ¶‰åŠæ–‡ä»¶æ‹·è´åˆ°å…¶ä»–å‡ ä¸ªæ–°èŠ‚ç‚¹<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ~<span style="color:#f92672">]</span><span style="color:#75715e"># ansible node -i /etc/ansible/hosts -m copy -a &#34;src=../../../../opt/kubernetes dest=/opt/&#34; -f 5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ~<span style="color:#f92672">]</span><span style="color:#75715e"># ansible node -i /etc/ansible/hosts -m copy -a &#34;src=../../../../opt/cni  dest=/opt/&#34; -f 5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ~<span style="color:#f92672">]</span><span style="color:#75715e"># scp -r /usr/lib/systemd/system/{kubelet,kube-proxy}.service k8s-node-1:/usr/lib/systemd/system</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ~<span style="color:#f92672">]</span><span style="color:#75715e"># scp -r /usr/lib/systemd/system/{kubelet,kube-proxy}.service k8s-node-2:/usr/lib/systemd/system</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è¿™å‡ ä¸ªæ–‡ä»¶æ˜¯è¯ä¹¦ç”³è¯·å®¡æ‰¹åè‡ªåŠ¨ç”Ÿæˆçš„ï¼Œæ¯ä¸ªNodeä¸åŒï¼Œå¿…é¡»åˆ é™¤å…¶ä»–å‡ ä¸ªèŠ‚ç‚¹åˆ é™¤kubeletè¯ä¹¦å’Œkubeconfigæ–‡ä»¶ï¼Œé‡æ–°ç”Ÿæˆ</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-node-1 ~<span style="color:#f92672">]</span><span style="color:#75715e"># rm -rf /opt/kubernetes/cfg/kubelet.kubeconfig</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-node-2 ~<span style="color:#f92672">]</span><span style="color:#75715e"># rm -rf /opt/kubernetes/cfg/kubelet.kubeconfig </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-node-1 ~<span style="color:#f92672">]</span><span style="color:#75715e"># rm -f /opt/kubernetes/ssl/kubelet*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¿®æ”¹ä¸»æœºå</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-node-1 ~<span style="color:#f92672">]</span><span style="color:#75715e"># sed -i &#34;s/k8s-master/k8s-node-1/g&#34; /opt/kubernetes/cfg/kubelet.conf</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-node-1 ~<span style="color:#f92672">]</span><span style="color:#75715e"># sed -i &#34;s/k8s-master/k8s-node-1/g&#34;  /opt/kubernetes/cfg/kube-proxy-config.yml </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-node-2 ~<span style="color:#f92672">]</span><span style="color:#75715e"># sed -i &#34;s/k8s-master/k8s-node-2/g&#34; /opt/kubernetes/cfg/kubelet.conf</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-node-2 ~<span style="color:#f92672">]</span><span style="color:#75715e"># sed -i &#34;s/k8s-master/k8s-node-2/g&#34;  /opt/kubernetes/cfg/kube-proxy-config.yml</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åœ¨å…¶ä»–å‡ ä¸ªå‡ ç‚¹ç»™äºˆå¯æ‰§è¡Œæ–‡ä»¶æ‰§è¡Œæƒé™ï¼Œ</span>
</span></span><span style="display:flex;"><span>$ chmod +x /opt/cni/bin/*
</span></span><span style="display:flex;"><span>$ chmod +x /opt/etcd/bin/*
</span></span><span style="display:flex;"><span>$ chmod +x /opt/kubernetes/bin/*
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ systemctl daemon-reload
</span></span><span style="display:flex;"><span>$ systemctl enable kubelet <span style="color:#f92672">&amp;&amp;</span> systemctl start kubelet
</span></span><span style="display:flex;"><span>$ systemctl enable kube-proxy <span style="color:#f92672">&amp;&amp;</span> systemctl start kube-proxy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åœ¨Masteræ“ä½œæ‰¹å‡†Node kubeletè¯ä¹¦ç”³è¯·</span>
</span></span><span style="display:flex;"><span>$ kubectl get csr
</span></span><span style="display:flex;"><span>NAME                                                   AGE     SIGNERNAME                                    REQUESTOR           CONDITION
</span></span><span style="display:flex;"><span>node-csr-4vSZMnrv8OUR-zfD7dQYcDdi1L84Tv_nkNHlS8Iltfk   2m46s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending
</span></span><span style="display:flex;"><span>node-csr-KRMLTPJj4yvk5Cb6s0n5T4HtFPYJ152PpDjYHLM3Ass   10s     kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending
</span></span><span style="display:flex;"><span>node-csr-Pbamt5FDLAwv0HlJpcgUP9B5c4ynIRe0Xa17zXq9I6E   71m     kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Approved,Issued
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl certificate approve node-csr-KRMLTPJj4yvk5Cb6s0n5T4HtFPYJ152PpDjYHLM3Ass
</span></span><span style="display:flex;"><span>$ kubectl certificate approve node-csr-4vSZMnrv8OUR-zfD7dQYcDdi1L84Tv_nkNHlS8Iltfk
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># STATUS éƒ½æ˜¯Ready</span>
</span></span><span style="display:flex;"><span>$ kubectl get node
</span></span><span style="display:flex;"><span>NAME         STATUS   ROLES    AGE     VERSION
</span></span><span style="display:flex;"><span>k8s-master   Ready    &lt;none&gt;   70m     v1.18.3
</span></span><span style="display:flex;"><span>k8s-node-1   Ready    &lt;none&gt;   3m21s   v1.18.3
</span></span><span style="display:flex;"><span>k8s-node-2   Ready    &lt;none&gt;   3m2s    v1.18.3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># STATUS éƒ½æ˜¯Runing</span>
</span></span><span style="display:flex;"><span>$ kubectl get pod -n kube-system
</span></span><span style="display:flex;"><span>NAME                                       READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>calico-kube-controllers-65f8bc95db-27zj8   1/1     Running   <span style="color:#ae81ff">0</span>          65m
</span></span><span style="display:flex;"><span>calico-node-skvcj                          1/1     Running   <span style="color:#ae81ff">0</span>          65m
</span></span><span style="display:flex;"><span>calico-node-wc72m                          1/1     Running   <span style="color:#ae81ff">0</span>          2m22s
</span></span><span style="display:flex;"><span>calico-node-z5kmp                          1/1     Running   <span style="color:#ae81ff">0</span>          2m2s</span></span></code></pre></div></blockquote>
<hr>
<h4 id="åˆ›å»ºlocalçš„storage-class">åˆ›å»º<code>local</code>çš„<code>Storage Class</code></h4>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -p /opt/data
</span></span><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/storage-class.yml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: StorageClass
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: storage.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name: local-storage
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">provisioner: kubernetes.io/no-provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">volumeBindingMode: WaitForFirstConsumer
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ‰§è¡Œå‘½ä»¤åˆ›å»º</span>
</span></span><span style="display:flex;"><span>$ kubectl create -f storage-class.yml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹ä¸€ä¸‹åˆ›å»ºçš„storage class</span>
</span></span><span style="display:flex;"><span>$ kubectl get sc</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->åˆ›å»º<code>PV</code><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/pv-sdc.yml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: PersistentVolume
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name: local-pv-sdc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">capacity:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">storage: 30Gi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">accessModes:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - ReadWriteOnce
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  persistentVolumeReclaimPolicy: Retain
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  storageClassName: local-storage
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  local:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    path: /opt/data
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  nodeAffinity:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    required:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      nodeSelectorTerms:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - matchExpressions:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - key: kubernetes.io/hostname
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          operator: In
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          values:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          - cka
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ‰§è¡Œåˆ›å»ºå‘½ä»¤</span>
</span></span><span style="display:flex;"><span>$ kubectl create -f pv-sdc.yml
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master cfg<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pv</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->åˆ›å»º<code>PVC</code><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/pvc1.yml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: PersistentVolumeClaim
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name: pvc1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">accessModes:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - ReadWriteOnce
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  storageClassName: local-storage
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  resources:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    requests:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      storage: 10Gi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>$ kubectl create -f pvc1.yml</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted --><code>PVC</code>å°†ä¼šä¸€ç›´å¤„äº<code>Pending</code>çŠ¶æ€ç›´åˆ°æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª<code>Pod</code>ä½¿ç”¨å®ƒ<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master cfg<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pvc</span>
</span></span><span style="display:flex;"><span>NAME      STATUS    VOLUME    CAPACITY   ACCESS MODES   STORAGECLASS    AGE
</span></span><span style="display:flex;"><span>pvc1      Pending                                       local-storage   5s</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

        </div>
      </main>
    </div>
    <script src="../../../../js/clipboard.min.js?1722425299" defer></script>
    <script src="../../../../js/perfect-scrollbar.min.js?1722425299" defer></script>
    <script src="../../../../js/d3/d3-color.min.js?1722425299" defer></script>
    <script src="../../../../js/d3/d3-dispatch.min.js?1722425299" defer></script>
    <script src="../../../../js/d3/d3-drag.min.js?1722425299" defer></script>
    <script src="../../../../js/d3/d3-ease.min.js?1722425299" defer></script>
    <script src="../../../../js/d3/d3-interpolate.min.js?1722425299" defer></script>
    <script src="../../../../js/d3/d3-selection.min.js?1722425299" defer></script>
    <script src="../../../../js/d3/d3-timer.min.js?1722425299" defer></script>
    <script src="../../../../js/d3/d3-transition.min.js?1722425299" defer></script>
    <script src="../../../../js/d3/d3-zoom.min.js?1722425299" defer></script>
    <script src="../../../../js/js-yaml.min.js?1722425299" defer></script>
    <script src="../../../../js/mermaid.min.js?1722425299" defer></script>
    <script>
      window.themeUseMermaid = JSON.parse("{ \"securityLevel\": \"loose\" }");
    </script>
    <script src="../../../../js/theme.js?1722425299" defer></script>
  </body>
</html>
