<!DOCTYPE html>
<html lang="en" dir="ltr" itemscope itemtype="http://schema.org/Article">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.125.4">
    <meta name="generator" content="Relearn 6.0.0+tip">
    <meta name="robots" content="noindex, nofollow, noarchive, noimageindex">
    <meta name="description" content="部署Kubernetes Etcd：负责存储集群中各种资源对象的信息
Kubelet：负责维护容器的生命周期，即通过控制Docker，来创建、更新、销毁容器
KubeProxy：负责提供集群内部的服务发现和负载均衡
Docker：负责节点上容器的各种操作
Scheduler：负责集群资源调度，按照预定的调度策略将Pod调度到相应的node节点上
API Server：集群操作的唯一入口，接收用户输入的命令，提供认证、授权、API注册和发现等机制
ControllerManager：负责维护集群的状态，比如程序部署安排、故障检测、自动扩展和滚动更新等
Core DNS：可以为集群中的SVC创建一个域名IP的对应关系解析">
    <meta name="author" content="二哥">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://erge.blog/images/s2-1.png">
    <meta name="twitter:title" content="Install_Kubernetes :: Hugo Relearn Theme">
    <meta name="twitter:description" content="部署Kubernetes Etcd：负责存储集群中各种资源对象的信息
Kubelet：负责维护容器的生命周期，即通过控制Docker，来创建、更新、销毁容器
KubeProxy：负责提供集群内部的服务发现和负载均衡
Docker：负责节点上容器的各种操作
Scheduler：负责集群资源调度，按照预定的调度策略将Pod调度到相应的node节点上
API Server：集群操作的唯一入口，接收用户输入的命令，提供认证、授权、API注册和发现等机制
ControllerManager：负责维护集群的状态，比如程序部署安排、故障检测、自动扩展和滚动更新等
Core DNS：可以为集群中的SVC创建一个域名IP的对应关系解析">
    <meta property="og:url" content="https://erge.blog/systems/linux/kubernetes/install_kubernetes/">
    <meta property="og:site_name" content="Hugo Relearn Theme">
    <meta property="og:title" content="Install_Kubernetes :: Hugo Relearn Theme">
    <meta property="og:description" content="部署Kubernetes Etcd：负责存储集群中各种资源对象的信息
Kubelet：负责维护容器的生命周期，即通过控制Docker，来创建、更新、销毁容器
KubeProxy：负责提供集群内部的服务发现和负载均衡
Docker：负责节点上容器的各种操作
Scheduler：负责集群资源调度，按照预定的调度策略将Pod调度到相应的node节点上
API Server：集群操作的唯一入口，接收用户输入的命令，提供认证、授权、API注册和发现等机制
ControllerManager：负责维护集群的状态，比如程序部署安排、故障检测、自动扩展和滚动更新等
Core DNS：可以为集群中的SVC创建一个域名IP的对应关系解析">
    <meta property="og:locale" content="en">
    <meta property="og:type" content="article">
    <meta property="article:section" content="Systems">
    <meta property="article:published_time" content="2024-06-25T02:09:06+08:00">
    <meta property="article:modified_time" content="2024-06-25T02:09:06+08:00">
    <meta property="og:image" content="https://erge.blog/images/s2-1.png">
    <meta itemprop="name" content="Install_Kubernetes :: Hugo Relearn Theme">
    <meta itemprop="description" content="部署Kubernetes Etcd：负责存储集群中各种资源对象的信息
Kubelet：负责维护容器的生命周期，即通过控制Docker，来创建、更新、销毁容器
KubeProxy：负责提供集群内部的服务发现和负载均衡
Docker：负责节点上容器的各种操作
Scheduler：负责集群资源调度，按照预定的调度策略将Pod调度到相应的node节点上
API Server：集群操作的唯一入口，接收用户输入的命令，提供认证、授权、API注册和发现等机制
ControllerManager：负责维护集群的状态，比如程序部署安排、故障检测、自动扩展和滚动更新等
Core DNS：可以为集群中的SVC创建一个域名IP的对应关系解析">
    <meta itemprop="datePublished" content="2024-06-25T02:09:06+08:00">
    <meta itemprop="dateModified" content="2024-06-25T02:09:06+08:00">
    <meta itemprop="wordCount" content="4742">
    <meta itemprop="image" content="https://erge.blog/images/s2-1.png">
    <title>Install_Kubernetes :: Hugo Relearn Theme</title>
    <link href="../../../../images/favicon.ico?1722425298" rel="icon" type="image/x-icon" sizes="any">
    <link href="../../../../css/fontawesome-all.min.css?1722425299" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="../../../../css/fontawesome-all.min.css?1722425299" rel="stylesheet"></noscript>
    <link href="../../../../css/nucleus.css?1722425299" rel="stylesheet">
    <link href="../../../../css/auto-complete.css?1722425299" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="../../../../css/auto-complete.css?1722425299" rel="stylesheet"></noscript>
    <link href="../../../../css/perfect-scrollbar.min.css?1722425299" rel="stylesheet">
    <link href="../../../../css/fonts.css?1722425299" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="../../../../css/fonts.css?1722425299" rel="stylesheet"></noscript>
    <link href="../../../../css/theme.css?1722425299" rel="stylesheet">
    <link href="../../../../css/theme-relearn-auto.css?1722425299" rel="stylesheet" id="R-variant-style">
    <link href="../../../../css/chroma-relearn-auto.css?1722425299" rel="stylesheet" id="R-variant-chroma-style">
    <link href="../../../../css/variant.css?1722425299" rel="stylesheet">
    <link href="../../../../css/print.css?1722425299" rel="stylesheet" media="print">
    <link href="../../../../css/format-print.css?1722425299" rel="stylesheet">
    <script src="../../../../js/variant.js?1722425299"></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.relBasePath='..\/..\/..\/..';
      window.relearn.relBaseUri='..\/..\/..\/..';
      window.relearn.absBaseUri='https:\/\/erge.blog';
      window.index_js_url="../../../../index.search.js";
      // variant stuff
      window.variants && variants.init( [ 'relearn-auto', 'relearn-light', 'relearn-dark', 'relearn-bright', 'zen-auto', 'zen-light', 'zen-dark', 'retro-auto', 'neon', 'learn', 'blue', 'green', 'red', 'my-branding' ] );
      // translations
      window.T_Copy_to_clipboard = `Copy to clipboard`;
      window.T_Copied_to_clipboard = `Copied to clipboard!`;
      window.T_Copy_link_to_clipboard = `Copy link to clipboard`;
      window.T_Link_copied_to_clipboard = `Copied link to clipboard!`;
      window.T_Reset_view = `Reset view`;
      window.T_View_reset = `View reset!`;
      window.T_No_results_found = `No results found for "{0}"`;
      window.T_N_results_found = `{1} results found for "{0}"`;
    </script>Partial intended to be overwritten to add custom headers, like CSS or any other info
<style>
    
</style>


  </head>
  <body class="mobile-support print disableInlineCopyToClipboard" data-url="../../../../systems/linux/kubernetes/install_kubernetes/">
    <div id="R-body" class="default-animation">
      <div id="R-body-overlay"></div>
      <nav id="R-topbar">
        <div class="topbar-wrapper">
          <div class="topbar-sidebar-divider"></div>
          <div class="topbar-area topbar-area-start" data-area="start">
            <div class="topbar-button topbar-button-sidebar" data-content-empty="show" data-width-s="show" data-width-m="show" data-width-l="show"><button class="topbar-control" onclick="toggleNav()" type="button" title="Menu (CTRL&#43;ALT&#43;n)"><i class="fa-fw fas fa-bars"></i></button>
            </div>



          </div>
          <ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype="http://schema.org/BreadcrumbList"><li
            itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><a itemprop="item" href="../../../../systems/"><span itemprop="name">Systems</span></a><meta itemprop="position" content="1">&nbsp;>&nbsp;</li><li
            itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><a itemprop="item" href="../../../../systems/linux/"><span itemprop="name">Linux</span></a><meta itemprop="position" content="2">&nbsp;>&nbsp;</li><li
            itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><a itemprop="item" href="../../../../systems/linux/kubernetes/"><span itemprop="name">Kubernetes</span></a><meta itemprop="position" content="3">&nbsp;>&nbsp;</li><li
            itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><span itemprop="name">Install_Kubernetes</span><meta itemprop="position" content="4"></li>
          </ol>
          <div class="topbar-area topbar-area-end" data-area="end">


            <div class="topbar-button topbar-button-prev" data-content-empty="show" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="../../../../systems/linux/kubernetes/kubernetes_command/" title="Kubernetes_Command (🡐)"><i class="fa-fw fas fa-chevron-left"></i></a>
            </div>

            <div class="topbar-button topbar-button-next" data-content-empty="show" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="../../../../systems/linux/kubernetes/install_k8s_rancher/" title="Install_K8s_Rancher (🡒)"><i class="fa-fw fas fa-chevron-right"></i></a>
            </div>



          </div>
        </div>
      </nav>
      <div id="R-main-overlay"></div>
      <main id="R-body-inner" class="highlightable default" tabindex="-1">
        <div class="flex-block-wrapper">
          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_kubernetes">Install_Kubernetes</h1>

<h1 id="部署kubernetes">部署<code>Kubernetes</code></h1>
<blockquote>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<ul>
<li>
<p><code>Etcd</code><!-- raw HTML omitted -->：负责存储集群中各种资源对象的信息<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>Kubelet</code><!-- raw HTML omitted -->：负责维护容器的生命周期，即通过控制<!-- raw HTML omitted --><code>Docker</code><!-- raw HTML omitted -->，来创建、更新、销毁容器<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>KubeProxy</code><!-- raw HTML omitted -->：负责提供集群内部的服务发现和负载均衡<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>Docker</code><!-- raw HTML omitted -->：负责节点上容器的各种操作<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>Scheduler</code><!-- raw HTML omitted -->：负责集群资源调度，按照预定的调度策略将<code>Pod</code>调度到相应的<code>node</code>节点上<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>API Server</code><!-- raw HTML omitted -->：集群操作的唯一入口，接收用户输入的命令，提供认证、授权、<code>API</code>注册和发现等机制<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>ControllerManager</code><!-- raw HTML omitted -->：负责维护集群的状态，比如程序部署安排、故障检测、自动扩展和滚动更新等<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>Core DNS</code><!-- raw HTML omitted -->：可以为集群中的<code>SVC</code>创建一个域名<code>IP</code>的对应关系解析<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>Dashboard</code><!-- raw HTML omitted -->：给<code>K8S</code>集群提供一个<code>B/S</code>结构的体系访问<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>Ingress Controller</code><!-- raw HTML omitted -->：官方只能实现四层代理，<code>Ingress</code>可以实现七层代理<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>Fedetation</code><!-- raw HTML omitted -->：提供一个可以跨集群中心的多<code>K8S</code>统一管理功能<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>Prometheus</code><!-- raw HTML omitted -->：提供一个<code>K8S</code>集群监控能力<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>ELK</code><!-- raw HTML omitted -->：提供<code>K8S</code>集群日志统一分析介入平台<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>K8S</code>部署方式分为<!-- raw HTML omitted -->二进制<!-- raw HTML omitted -->以及<!-- raw HTML omitted -->快速部署<!-- raw HTML omitted -->方式，官方给予<!-- raw HTML omitted -->三种快速部署<!-- raw HTML omitted -->方式：<a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/" rel="external" target="_self">使用<code>kubeadm</code>引导集群</a>、<a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kops/" rel="external" target="_self">使用<code>Kops</code>安装<code>Kubernetes</code></a>、<a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubespray/" rel="external" target="_self">使用<code>Kubespray</code>安装<code>Kubernetes</code></a></p>
</li>
</ul>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/kubewharf" rel="external" target="_self"><code>KubeWharf</code>轻量级多租户</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/kubernetes/perf-tests" rel="external" target="_self"><code>Kubernetes</code>性能测试</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://learnk8s.io/a/a-visual-guide-on-troubleshooting-kubernetes-deployments/troubleshooting-kubernetes.en_en.v3.pdf" rel="external" target="_self"><code>kubernetes</code>排错思维</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://kubespray.io/#/docs/getting-started" rel="external" target="_self"><code>Ansible-playbook</code>使用<code>kubespray</code>安装<code>K8S</code></a></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<h2 id="服务器端口准备">服务器、端口准备</h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->部署一主三从<!-- raw HTML omitted --><code>kubernetes</code>架构</li>
</ol>
</li>
</ul>
<blockquote>

<pre class="mermaid align-center zoomable">graph TD
F[一主多从] 
A{{K8S-Master}} ==&gt; B{{K8S-Nodes}}
A{{K8S-Master}} ==&gt; C{{K8S-Nodes}}
A{{K8S-Master}} ==&gt; D{{K8S-Nodes}}
Z[多主多从]
G{{K8S-Master}} ==&gt; J{{K8S-Nodes}}
G{{K8S-Master}} ==&gt; K{{K8S-Nodes}}
G{{K8S-Master}} ==&gt; L{{K8S-Nodes}}
H{{K8S-Master}} ==&gt; J{{K8S-Nodes}}
H{{K8S-Master}} ==&gt; K{{K8S-Nodes}}
H{{K8S-Master}} ==&gt; L{{K8S-Nodes}} </pre><table>
<thead>
<tr>
<th>角色</th>
<th><code>IP</code>地址</th>
<th>配置</th>
<th>操作系统</th>
</tr>
</thead>
<tbody>
<tr>
<td>Master</td>
<td>192.168.35.128</td>
<td><code>2core、4G、80Gdisk</code></td>
<td><code>CentOS Linux release 7.9.2</code></td>
</tr>
<tr>
<td>node-1</td>
<td>192.168.35.129</td>
<td><code>2core、1G、60Gdisk</code></td>
<td><code>CentOS Linux release 7.9.2</code></td>
</tr>
<tr>
<td>node-2</td>
<td>192.168.35.130</td>
<td><code>2core、1G、60Gdisk</code></td>
<td><code>CentOS Linux release 7.9.2</code></td>
</tr>
</tbody>
</table>
<ul>
<li><!-- raw HTML omitted -->集群架构<!-- raw HTML omitted --></li>
</ul>
<table>
<thead>
<tr>
<th>角色</th>
<th><code>IP</code>地址</th>
<th>配置</th>
<th>操作系统</th>
</tr>
</thead>
<tbody>
<tr>
<td>Master-1</td>
<td>192.168.80.210</td>
<td><code>2core、4G、80Gdisk</code></td>
<td><code>CentOS Linux release 7.9.2</code></td>
</tr>
<tr>
<td>Master-2</td>
<td>192.168.80.211</td>
<td><code>2core、4G、80Gdisk</code></td>
<td><code>CentOS Linux release 7.9.2</code></td>
</tr>
<tr>
<td>node-1</td>
<td>192.168.80.212</td>
<td><code>2core、2G、60Gdisk</code></td>
<td><code>CentOS Linux release 7.9.2</code></td>
</tr>
<tr>
<td>node-2</td>
<td>192.168.80.213</td>
<td><code>2core、2G、60Gdisk</code></td>
<td><code>CentOS Linux release 7.9.2</code></td>
</tr>
<tr>
<td>node-3</td>
<td>192.168.80.215</td>
<td><code>2core、2G、60Gdisk</code></td>
<td><code>CentOS Linux release 7.9.2</code></td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->控制节点<!-- raw HTML omitted --><code>master</code>：集群的控制平面，负责集群的决策，以及需要开放的端口</li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>协议</th>
<th>方向</th>
<th>端口范围</th>
<th>作用</th>
<th>使用者</th>
</tr>
</thead>
<tbody>
<tr>
<td>TCP</td>
<td>入站</td>
<td>6443</td>
<td><code>Kubernetes API</code> 服务器</td>
<td>所有组件,管理员操作<code>Kubernetes</code>的接口。因此，<code>API</code>服务器通常暴露在控制平面之外。<code>API</code>服务器被设计成可扩展的，可能存在于多个控制平面节点上</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>2379-2380</td>
<td><code>etcd</code>服务器客户端 <code>API</code></td>
<td><code>kube-apiserver, etcd</code>，持久化的备份存储，关于集群状态的所有信息都保存在这里。<code>Etcd</code>不应该被直接操作，而应该通过 <code>API</code> 服务器来管理。</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>10250</td>
<td><code>Kubelet API</code></td>
<td><code>kubelet</code>自身、在每个工作节点上运行，以协调和验证<code>Pod</code>的执行</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>10259</td>
<td><code>kube-scheduler</code></td>
<td><code>kube-scheduler</code>自身，跟踪工作节点的状态并决定在哪里运行 Pod。<code>Kube-scheduler</code> 只可以由控制平面内的节点访问。</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>10257</td>
<td><code>kube-controller-manager</code></td>
<td><code>kube-controller-manager</code>自身，监视<code>Kubernetes</code>集群，以检测和维护<code>Kubernetes</code>环境的几个方面，包括将<code>Pod</code>加入到服务中，保持一组<code>Pod</code>的正确数量，并对节点的丢失做出反应</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>10258</td>
<td><code>Cloud controller manager</code></td>
<td>一个用于基于云的部署的可选组件。云控制器与云服务提供商接口，以管理集群的负载均衡器和虚拟网络</td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->工作节点<!-- raw HTML omitted --><code>node</code>：集群的数据平面，负责为容器提供运行环境 ，需要开放的端口</li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>协议</th>
<th>方向</th>
<th>端口范围</th>
<th>作用</th>
<th>使用者</th>
</tr>
</thead>
<tbody>
<tr>
<td>TCP</td>
<td>入站</td>
<td>10250</td>
<td><code>Kubelet API</code></td>
<td><code>kubelet</code>自身、控制平面组件</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>30000-32767</td>
<td><code>NodePort</code>服务†</td>
<td>所有组件</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h3 id="初始化环境">初始化环境</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->设置三台主机名<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ hostnamectl set-hostname k8s-master-128
</span></span><span style="display:flex;"><span>$ hostnamectl set-hostname k8s-node-01-129
</span></span><span style="display:flex;"><span>$ hostnamectl set-hostname k8s-node-02-130</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->设置集群的主机名<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ hostnamectl set-hostname k8s-master-1-80-210
</span></span><span style="display:flex;"><span>$ hostnamectl set-hostname k8s-master-2-80-211
</span></span><span style="display:flex;"><span>$ hostnamectl set-hostname k8s-node-1-80-212
</span></span><span style="display:flex;"><span>$ hostnamectl set-hostname k8s-node-2-80-213
</span></span><span style="display:flex;"><span>$ hostnamectl set-hostname k8s-node-3-80-215</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->分别在三台服务器做本地<!-- raw HTML omitted --><code>hosts</code><!-- raw HTML omitted -->解析<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;&gt;/etc/hosts<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.35.128 k8s-master-01
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.35.129 k8s-node-01
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.35.130 k8s-node-02
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->五台服务器的集群<!-- raw HTML omitted --><code>hosts</code><!-- raw HTML omitted -->配置<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;&gt;/etc/hosts<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.80.210 k8s-master-01
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.80.211 k8s-master-02
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.80.212 k8s-node-01
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.80.213 k8s-node-02
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.80.215 k8s-node-03
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.80.220 k8s-master-lb # VIP(虚拟IP)用于LoadBalance，如果不是高可用集群，该IP可以是k8s-master01的IP 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->设置时间同步，修改时区两种方式<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>tzdata</code><!-- raw HTML omitted -->时区软件包<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install tzdata 
</span></span><span style="display:flex;"><span>$ timedatectl set-timezone Asia/Shanghai</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->第一种<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->第二种<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl enable chronyd.service <span style="color:#f92672">&amp;&amp;</span> systemctl start chronyd.service</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->关闭防火墙并禁止开机自启<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl disable firewalld <span style="color:#f92672">&amp;&amp;</span> systemctl stop firewalld</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->关闭<!-- raw HTML omitted --><code>SElinux</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ setenforce <span style="color:#ae81ff">0</span>  	<span style="color:#75715e"># 临时关闭Selinux</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s/^SELINUX=.*/SELINUX=disabled/&#39;</span> /etc/selinux/config  	<span style="color:#75715e"># 永久关闭Selinux</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="6">
<li><!-- raw HTML omitted -->关闭<!-- raw HTML omitted --><code>swap</code><!-- raw HTML omitted -->交换分区<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sed -ri <span style="color:#e6db74">&#39;s/.*swap.*/#&amp;/&#39;</span> /etc/fstab <span style="color:#f92672">&amp;&amp;</span> swapoff -a</span></span></code></pre></div><ul>
<li><code>Ubunt</code><!-- raw HTML omitted -->关闭交换分区<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;etc/fstab<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/dev/disk/by-uuid/95e38332-76fc-4d2f-81a4-04bc581f2ed3 none swap sw,noauto 0 0  	# 添加：noauto
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># /swap.img     none    swap    sw      0       0  	# 添加注释
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查询验证，输出为空则生效</span>
</span></span><span style="display:flex;"><span>$ sudo swapon --show</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="7">
<li>允许<code>iptables</code><!-- raw HTML omitted -->检查桥接流量<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->确保<!-- raw HTML omitted --><code>br_netfilter</code><!-- raw HTML omitted -->模块被加载。这一操作可以通过运行<!-- raw HTML omitted --><code>lsmod | grep br_netfilter</code><!-- raw HTML omitted -->来完成。若要显式加载该模块，可执行<!-- raw HTML omitted --><code>modprobe br_netfilter</code></li>
<li><!-- raw HTML omitted -->为了让你的<!-- raw HTML omitted --><code>Linux</code><!-- raw HTML omitted -->节点上的<!-- raw HTML omitted --><code>iptables</code><!-- raw HTML omitted -->能够正确地查看桥接流量，你需要确保在你的<!-- raw HTML omitted --><code>sysctl</code><!-- raw HTML omitted -->配置中将<!-- raw HTML omitted --><code>net.bridge.bridge-nf-call-iptables</code><!-- raw HTML omitted -->设置为 1<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat <span style="color:#e6db74">&lt;&lt;EOF | sudo tee /etc/modules-load.d/k8s.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">br_netfilter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat <span style="color:#e6db74">&lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.bridge.bridge-nf-call-iptables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.ip_forward = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sysctl --system
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##########################################################  使用脚本函数</span>
</span></span><span style="display:flex;"><span>__k8s_kernel_iptables<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 加载br_netfilter模块</span>
</span></span><span style="display:flex;"><span>    modprobe br_netfilter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 查看是否加载</span>
</span></span><span style="display:flex;"><span>    lsmod | grep br_netfilter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 写内核配置文件</span>
</span></span><span style="display:flex;"><span>    cat &gt;/etc/sysctl.d/k8s.conf <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.bridge.bridge-nf-call-iptables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.ip_forward = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">vm.swappiness = 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 内核参数生效</span>
</span></span><span style="display:flex;"><span>    sysctl --system
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>__k8s_kernel_iptables</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="8">
<li><!-- raw HTML omitted -->开启<!-- raw HTML omitted --><code>ipvs</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>在<code>kubernetes</code>中<code>service</code>有两种代理模型，一种是基于<code>iptables</code>，另一种是基于<code>ipvs</code>的。<code>ipvs</code>的性能要高于<code>iptables</code>的，但是如果要使用它，需要手动载入<code>ipvs</code>模块。</li>
<li><code>Centos</code><!-- raw HTML omitted -->系统在每个节点安装配置<!-- raw HTML omitted --><code>ipset</code>和<code>ipvsadm</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install ipset ipvsadm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在所有节点执行如下脚本</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/etc/sysconfig/modules/ipvs.modules<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_rr
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_wrr
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- nf_conntrack_ipv4  	# 高版本替换为nf_conntrack
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 授权、运行、检查是否加载</span>
</span></span><span style="display:flex;"><span>$ chmod <span style="color:#ae81ff">755</span> /etc/sysconfig/modules/ipvs.modules <span style="color:#f92672">&amp;&amp;</span> bash /etc/sysconfig/modules/ipvs.modules
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 检查是否加载</span>
</span></span><span style="display:flex;"><span>$ lsmod | grep -e ipvs -e nf_conntrack_ipv4</span></span></code></pre></div><ul>
<li><code>Debian</code><!-- raw HTML omitted -->系统在每个节点安装配置<!-- raw HTML omitted --><code>ipset</code>和<code>ipvsadm</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -vp /etc/modules.d/
</span></span><span style="display:flex;"><span>$ tee /etc/modules.d/k8s.modules <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># netfilter 模块 允许 iptables 检查桥接流量
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- br_netfilter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># containerd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- overlay
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># nf_conntrack
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- nf_conntrack
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ipvs
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_lc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_lblc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_lblcr
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_rr
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_wrr
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_dh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_fo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_nq
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_sed
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_ftp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_tables
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_set
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ipt_set
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ipt_rpfilter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ipt_REJECT
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ipip
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- xt_set
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ chmod <span style="color:#ae81ff">755</span> /etc/modules.d/k8s.modules <span style="color:#f92672">&amp;&amp;</span> bash /etc/modules.d/k8s.modules <span style="color:#f92672">&amp;&amp;</span> lsmod | grep -e ip_vs -e nf_conntrack  
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ip_vs_sh               16384  0  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ip_vs_wrr              16384  0  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ip_vs_rr               16384  0  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ip_vs                 155648  6 ip_vs_rr,ip_vs_sh,ip_vs_wrr  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># nf_conntrack          139264  1 ip_vs  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># nf_defrag_ipv6         24576  2 nf_conntrack,ip_vs  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># nf_defrag_ipv4         16384  1 nf_conntrack  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># libcrc32c              16384  5 nf_conntrack,btrfs,xfs,raid456,ip_vs</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sysctl --system</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="9">
<li><!-- raw HTML omitted -->所有节点配置<!-- raw HTML omitted --><code>Limit</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ulimit -SHn <span style="color:#ae81ff">65536</span>  	<span style="color:#75715e"># 临时生效</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* soft nproc 65535  	# soft 软限制
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* hard nproc 65535  	# hard 硬限制
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* soft nofile 25535
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* hard nofile 25535
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* soft memlock unlimited
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* soft memlock unlimited &#34;</span> &gt;&gt;/etc/security/limits.conf  	<span style="color:#75715e"># 永久生效</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="10">
<li><code>k8s-master01</code><!-- raw HTML omitted -->节点设置免密登录其他节点<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>ssh-keygen</code><!-- raw HTML omitted -->：用于创建密钥的程序<!-- raw HTML omitted --></li>
<li><code>-m PEM</code><!-- raw HTML omitted -->：将密钥的格式设为<!-- raw HTML omitted --><code>PEM</code></li>
<li><code>-t rsa</code><!-- raw HTML omitted -->：创建密钥类型为：<code>RSA</code>格式，系统默认提供名为 <code>id_rsa</code> 的密钥对，有些工具可能要求私钥文件名为<!-- raw HTML omitted --><code>id_rsa</code></li>
<li><code>-b 4096</code><!-- raw HTML omitted -->：密钥的位数，本例中为<!-- raw HTML omitted --><code>4096</code></li>
<li><code>-C &quot;xxx@myserver&quot;</code><!-- raw HTML omitted -->：追加到公钥文件末尾以便于识别的注释。 通常以电子邮件地址用作注释，但也可以使用任何最适合你基础结构的事物<!-- raw HTML omitted --></li>
<li><code>-f ~/.ssh/</code><!-- raw HTML omitted -->：私钥文件的文件名（如果选择不使用默认名称）。 追加了<code>.pub</code>的相应公钥文件在相同目录中生成。 该目录必须存在<!-- raw HTML omitted --></li>
<li><code>-N mypassphrase</code><!-- raw HTML omitted -->：用于访问私钥文件的其他密码<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ssh-keygen <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-m PEM <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-t rsa <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-b <span style="color:#ae81ff">4096</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-C <span style="color:#e6db74">&#34;xxx@163.com&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-f ~/.ssh/name_rsa <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-N mypassphrase
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ <span style="color:#66d9ef">for</span> i in master-01 master-02 noder-01 noder-02 noder-03;<span style="color:#66d9ef">do</span> ssh-copy-id -i .ssh/id_rsa.pub $i;<span style="color:#66d9ef">done</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="11">
<li><!-- raw HTML omitted -->所有节点更新系统并且重启<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y --exclude<span style="color:#f92672">=</span>kernel* update <span style="color:#f92672">&amp;&amp;</span> reboot</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="12">
<li><!-- raw HTML omitted -->升级系统<!-- raw HTML omitted --><code>Kernel</code>内核到<code>4.18+</code>以上</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org
</span></span><span style="display:flex;"><span>$ rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 令列出可用的内核相关包</span>
</span></span><span style="display:flex;"><span>$ yum --disablerepo<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;*&#34;</span> --enablerepo<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;elrepo-kernel&#34;</span> list available
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装最新主线稳定内核</span>
</span></span><span style="display:flex;"><span>$ yum -y --enablerepo<span style="color:#f92672">=</span>elrepo-kernel install kernel-ml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设置 GRUB 默认的内核版本：</span>
</span></span><span style="display:flex;"><span>$ vim /etc/default/grub
</span></span><span style="display:flex;"><span>GRUB_DEFAULT<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>  	<span style="color:#75715e"># 修改部分， GRUB 初始化页面的第一个内核将作为默认内核</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 重新创建内核配置</span>
</span></span><span style="display:flex;"><span>$ grub2-mkconfig -o /boot/grub2/grub.cfg
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ reboot</span></span></code></pre></div></blockquote>
<hr>
<h3 id="所有节点都安装docker">所有节点都安装<code>docker</code></h3>
<ul>
<li>
<ol>
<li><code>yum</code><!-- raw HTML omitted -->源的使用<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->使用官方源 <!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum install -y yum-utils
</span></span><span style="display:flex;"><span>$ yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->使用阿里云官方<code>repo</code>源<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 备份服务器上原有的CentOS-Base和epel</span>
</span></span><span style="display:flex;"><span>$ mv /etc/yum.repos.d/CentOS-Base.repo<span style="color:#f92672">{</span>,.bak<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>$ mv /etc/yum.repos.d/epel.repo<span style="color:#f92672">{</span>,.bak<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装CentOS0-Base和epel源 </span>
</span></span><span style="display:flex;"><span>$ curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo
</span></span><span style="display:flex;"><span>$ curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 第一种方式安装docker 源  </span>
</span></span><span style="display:flex;"><span>$ wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 第二种方式docker源</span>
</span></span><span style="display:flex;"><span>$ yum install -y yum-utils device-mapper-persistent-data lvm2
</span></span><span style="display:flex;"><span>$ yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 做替换</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s+download.docker.com+mirrors.aliyun.com/docker-ce+&#39;</span> /etc/yum.repos.d/docker-ce.repo</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->卸载服务器自带<!-- raw HTML omitted --><code>docker</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->安装对应<code>docker</code>版本服务<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum makecache fast
</span></span><span style="display:flex;"><span>$ yum list docker-ce  --showduplicates|sort -r
</span></span><span style="display:flex;"><span>$ yum install -y docker-ce-20.10.4 docker-ce-cli-20.10.4 containerd.io docker-compose-plugin
</span></span><span style="display:flex;"><span>$ systemctl enable docker <span style="color:#f92672">&amp;&amp;</span> systemctl start docker</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>docker-compose</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo curl -L <span style="color:#e6db74">&#34;https://github.com/docker/compose/releases/download/v2.2.2/docker-compose-</span><span style="color:#66d9ef">$(</span>uname -s<span style="color:#66d9ef">)</span><span style="color:#e6db74">-</span><span style="color:#66d9ef">$(</span>uname -m<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> -o /usr/local/bin/docker-compose
</span></span><span style="display:flex;"><span>$ chmod +x /usr/local/bin/docker-compose
</span></span><span style="display:flex;"><span>$ ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose
</span></span><span style="display:flex;"><span>$ docker compose COMMAND --help  	<span style="color:#75715e"># 查看镜像编写方式</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="6">
<li><code>Kubernetes</code><!-- raw HTML omitted -->文件驱动默认由<!-- raw HTML omitted --><code>systemd</code><!-- raw HTML omitted -->改成<!-- raw HTML omitted --><code>cgroupfs</code><!-- raw HTML omitted -->, 而我们安装的<!-- raw HTML omitted --><code>docker</code><!-- raw HTML omitted -->使用的文件驱动是<!-- raw HTML omitted --><code>systemd</code><!-- raw HTML omitted -->, 造成不一致, 导致镜像无法启动<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>&quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo cat &gt;/etc/docker/daemon.json<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;registry-mirrors&#34;: [&#34;https://bn4ll166.mirror.aliyuncs.com&#34;],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;data-root&#34;: &#34;/data/docker-root&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;dns&#34;: [&#34;223.5.5.5&#34;,&#34;119.29.29.29&#34;],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;bip&#34;: &#34;172.31.255.254/16&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;storage-driver&#34;: &#34;overlay2&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;storage-opts&#34;: [&#34;overlay2.override_kernel_check=true&#34;],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;userland-proxy&#34;: false,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;log-driver&#34;: &#34;json-file&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;log-opts&#34;: {&#34;max-size&#34;: &#34;500m&#34;,&#34;max-file&#34;: &#34;1&#34;},
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;exec-opts&#34;: [&#34;native.cgroupdriver=systemd&#34;],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;live-restore&#34;: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="7">
<li><a href="https://www.qikqiak.com/k8s-book/docs/1.%E8%AF%BE%E7%A8%8B%E4%BB%8B%E7%BB%8D.html" rel="external" target="_self"><code>Docker</code>+<code>Kubernetes</code></a></li>
</ol>
</li>
</ul>
<hr>
<h3 id="所有节点配置kubernetes-yum源">所有节点配置<code>kubernetes yum</code>源</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->国内修改为阿里云<code>yum</code>源 <!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/yum.repos.d/kubernetes.repo<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[kubernetes]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name=Kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">enabled=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgcheck=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">repo_gpgcheck=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->直接使用<code>kubernetes</code>官方<code>yum</code>源<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat <span style="color:#e6db74">&lt;&lt;-EOF | sudo tee /etc/yum.repos.d/kubernetes.repo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[kubernetes]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name=Kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\$basearch
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">enabled=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgcheck=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">exclude=kubelet kubeadm kubectl
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->重启所有节点服务器<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ reboot</span></span></code></pre></div></blockquote>
<hr>
<h3 id="所有节点都安装kubeadmkubeletkubectl">所有节点都安装<code>kubeadm、kubelet、kubectl</code></h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum list kubelet kubeadm kubectl  --showduplicates | sort -r
</span></span><span style="display:flex;"><span>$ yum -y install kubelet-1.24.5 kubeadm-1.24.5 kubectl-1.24.5</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol>
<li><code>--cgroup-driver=systemd</code><!-- raw HTML omitted -->：为了实现<!-- raw HTML omitted --><code>Docker</code><!-- raw HTML omitted -->使用的<!-- raw HTML omitted --><code>cgroup drvier</code><!-- raw HTML omitted -->和<!-- raw HTML omitted --><code>kubelet</code><!-- raw HTML omitted -->使用的<!-- raw HTML omitted --><code>cgroup</code><!-- raw HTML omitted -->默认值为一致，<!-- raw HTML omitted --><code>/etc/sysconfig/kubelet</code><!-- raw HTML omitted -->文件中添加<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>--fail-swap-on=false</code><!-- raw HTML omitted -->忽略<code>swap</code>报错<!-- raw HTML omitted --></li>
<li><code>--feature-gates EphemeralContainers=true</code><!-- raw HTML omitted -->开启临时容器参数<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubelet -h | grep EphemeralContainers</span></span></code></pre></div><div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/sysconfig/kubelet<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">KUBELET_EXTRA_ARGS=&#34;--cgroup-driver=systemd --fail-swap-on=false&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">KUBE_PROXY_MODE=&#34;ipvs&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->置为开机自启动即可，由于没有生成配置文件，集群初始化后自动启动<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl enable kubelet <span style="color:#f92672">&amp;&amp;</span> systemctl start kubelet</span></span></code></pre></div></blockquote>
<hr>
<h2 id="使用kubeadm部署kubernetes">使用<code>Kubeadm</code>部署<code>Kubernetes</code></h2>
<h3 id="查看下载所需镜像">查看下载所需镜像</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->查看<!-- raw HTML omitted --><code>k8s</code><!-- raw HTML omitted -->所需镜像<!-- raw HTML omitted --><code>kubeadm config images list</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm config images list   <span style="color:#75715e"># list替换：pull、拉取镜像</span>
</span></span><span style="display:flex;"><span>k8s.gcr.io/kube-apiserver:v1.24.6
</span></span><span style="display:flex;"><span>k8s.gcr.io/kube-controller-manager:v1.24.6
</span></span><span style="display:flex;"><span>k8s.gcr.io/kube-scheduler:v1.24.6
</span></span><span style="display:flex;"><span>k8s.gcr.io/kube-proxy:v1.24.6
</span></span><span style="display:flex;"><span>k8s.gcr.io/pause:3.7
</span></span><span style="display:flex;"><span>k8s.gcr.io/etcd:3.5.3-0
</span></span><span style="display:flex;"><span>k8s.gcr.io/coredns/coredns:v1.8.6
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ docker images --digests  	<span style="color:#75715e"># 验证镜像完整性</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->下载<code>K8S</code>所需镜像 (如果过程中有提示失败迹象, 那么可能是网络原因, 多执行几次)<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm config images list | xargs -n1 docker pull  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 指定拉取阿里云源的镜像  </span>
</span></span><span style="display:flex;"><span>$ kubeadm config images pull --kubernetes-version<span style="color:#f92672">=</span>v1.20.2 --image-repository<span style="color:#f92672">=</span>registry.aliyuncs.com/google_containers  </span></span></code></pre></div></blockquote>
<hr>
<h3 id="部署master节点">部署<code>master</code>节点</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->两种方式部署<!-- raw HTML omitted --><code>Master</code>节点：<strong>命令行</strong>和**<code>yaml</code>**</li>
<li><!-- raw HTML omitted -->**注意：**主机名中不能带有_（下划线），不然初始化会报错<!-- raw HTML omitted --><a href="https://kubernetes.io/zh/docs/reference/setup-tools/kubeadm/kubeadm-init/" rel="external" target="_self"><code>kubeadm init</code></a></li>
</ul>
</blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->使用命令行方式初始化<!-- raw HTML omitted --><code>Kubernetes</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>--kubernetes-version</code>：指定版本</li>
<li><code>--apiserver-advertise-address</code>：<code>master</code>本机<code>IP</code></li>
<li><code>--service-cidr</code>：<!-- raw HTML omitted -->用于指定为<code>Service</code>分配使用网络地址，它由<code>kubernetes</code>管理，默认网段：<code>10.96.0.0/12</code><!-- raw HTML omitted --></li>
<li><code>--pod-network-cidr</code>：<!-- raw HTML omitted -->启动容器给容器所分配<code>IP</code>，<code>ip a</code>可以查看服务器本机生成<code>IP</code>段，当有从集群外节点通过静态路由方式访问集群内<code>Service</code>的需求时，需要在创建集群时指定<code>pod-network-cidr</code>， 以对来自非<code>Pod</code>网络的流量(外部流量)执行<code>MASQ</code>，外部访问pod服务做<code>nat</code>转发,它通常应该与部署使用的网络插件(例如：<code>flannel</code>、<code>calico</code>)默认设定保持一致，<code>10.244.0.0/16</code>是<code>flannel</code>默认使用网络<!-- raw HTML omitted --></li>
<li><code>--ignore-preflight-errors=Swap</code>：<!-- raw HTML omitted -->通过此参数忽略swap报错<!-- raw HTML omitted --></li>
<li><code>--image-repository registry.aliyuncs.com/google_containers</code>：<!-- raw HTML omitted -->指定从阿里云下载<!-- raw HTML omitted --></li>
<li><code>--cri-socket</code>：<!-- raw HTML omitted -->配置<code>CRI</code>端点<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm init --kubernetes-version<span style="color:#f92672">=</span>v1.24.6 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--apiserver-advertise-address<span style="color:#f92672">=</span>192.168.35.128 --node-name<span style="color:#f92672">=</span>k8s-master <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--service-cidr<span style="color:#f92672">=</span>10.64.0.0/12 --pod-network-cidr<span style="color:#f92672">=</span>10.244.0.0/16 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cri-socket unix:///var/run/containerd/containerd.sock  	<span style="color:#75715e"># 配置 CRI 端点</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->通过配置文件初始化<!-- raw HTML omitted --><code>Kubernetes</code>的<code>master</code>节点</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 输出初始化配置到文件</span>
</span></span><span style="display:flex;"><span>$ kubeadm config print init-defaults &gt;/opt/k8s/yaml/kubeadm-config.yaml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改配置文件</span>
</span></span><span style="display:flex;"><span>apiVersion: kubeadm.k8s.io/v1beta3
</span></span><span style="display:flex;"><span>bootstrapTokens:
</span></span><span style="display:flex;"><span>- groups:
</span></span><span style="display:flex;"><span>    - system:bootstrappers:kubeadm:default-node-token
</span></span><span style="display:flex;"><span>    token: abcdef.0123456789abcdef
</span></span><span style="display:flex;"><span>    ttl: 24h0m0s
</span></span><span style="display:flex;"><span>    usages:
</span></span><span style="display:flex;"><span>    - signing
</span></span><span style="display:flex;"><span>    - authentication
</span></span><span style="display:flex;"><span>kind: InitConfiguration
</span></span><span style="display:flex;"><span>localAPIEndpoint:
</span></span><span style="display:flex;"><span>    advertiseAddress: 1.2.3.4  	<span style="color:#75715e"># 修改为master本机IP</span>
</span></span><span style="display:flex;"><span>    bindPort: <span style="color:#ae81ff">6443</span>  	<span style="color:#75715e"># 使用端口</span>
</span></span><span style="display:flex;"><span>nodeRegistration:
</span></span><span style="display:flex;"><span>    criSocket: unix:///var/run/containerd/containerd.sock  	<span style="color:#75715e"># 配置 CRI 端点</span>
</span></span><span style="display:flex;"><span>    imagePullPolicy: IfNotPresent
</span></span><span style="display:flex;"><span>    name: node  	<span style="color:#75715e"># 配置主机名， 主机名不允许使用下划线</span>
</span></span><span style="display:flex;"><span>    taints: null
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiServer:
</span></span><span style="display:flex;"><span>    timeoutForControlPlane: 4m0s
</span></span><span style="display:flex;"><span>apiVersion: kubeadm.k8s.io/v1beta3
</span></span><span style="display:flex;"><span>certificatesDir: /etc/kubernetes/pki
</span></span><span style="display:flex;"><span>clusterName: kubernetes
</span></span><span style="display:flex;"><span>controllerManager: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>dns: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>etcd:
</span></span><span style="display:flex;"><span>    local:
</span></span><span style="display:flex;"><span>        dataDir: /var/lib/etcd
</span></span><span style="display:flex;"><span>imageRepository: k8s.gcr.io  	<span style="color:#75715e"># 定义使用镜像源</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## imageRepository: registry.aliyuncs.com/google_containers  	# 阿里云镜像源</span>
</span></span><span style="display:flex;"><span>kind: ClusterConfiguration
</span></span><span style="display:flex;"><span>kubernetesVersion: 1.24.6  	<span style="color:#75715e"># 定义kubernetes版本</span>
</span></span><span style="display:flex;"><span>networking:
</span></span><span style="display:flex;"><span>    dnsDomain: cluster.local
</span></span><span style="display:flex;"><span>    serviceSubnet: 10.96.0.0/12  	<span style="color:#75715e"># 10.244.0.0/16 是`flannel`默认使用网络</span>
</span></span><span style="display:flex;"><span>scheduler: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiVersion: kubeproxy.config.k8s.io/v1alpha1
</span></span><span style="display:flex;"><span>kind: KubeProxyConfiguration
</span></span><span style="display:flex;"><span>featureGates:
</span></span><span style="display:flex;"><span>    SupportIPVSProxyMode: true
</span></span><span style="display:flex;"><span>mode: ipvs  	<span style="color:#75715e"># 启用ipvs  </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubeadm init --config<span style="color:#f92672">=</span>/opt/k8s/yaml/kubeadm-config.yaml  	<span style="color:#75715e"># 初始化配置文件</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->如果初始化报错执行下面命令、然后重新初始化<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">############################################################# 	 配置containerd服务</span>
</span></span><span style="display:flex;"><span>$ rm -rf /etc/containerd/config.toml
</span></span><span style="display:flex;"><span>$ containerd config default &gt;/etc/containerd/config.toml  	<span style="color:#75715e"># 生成新配置来覆盖默认配置</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo cat &gt;&gt;/etc/containerd/config.toml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[plugins.&#34;io.containerd.grpc.v1.cri&#34;.containerd.runtimes.runc.options]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> SystemdCgroup = false  	# 修改为：true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>$ systemctl restart containerd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#############################################################  	kubelet 配置文件修改</span>
</span></span><span style="display:flex;"><span>$ sudo cat &gt;&gt;/var/lib/kubelet/kubeadm-flags.env<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">KUBELET_KUBEADM_ARGS=&#34;--container-runtime-endpoint=unix:///var/run/containerd/containerd.sock --pod-infra-container-image=registry.k8s.io/pause:3.9&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动配置增加--container-runtime=remote --container-runtime-endpoint=unix:///var/run/containerd/containerd.sock</span>
</span></span><span style="display:flex;"><span>$ sudo cat &gt;&gt;/usr/lib/systemd/system/kubelet.service<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/usr/bin/kubelet --container-runtime=remote --container-runtime-endpoint=unix:///var/run/containerd/containerd.sock
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">############################################################## 	 删除配置重载</span>
</span></span><span style="display:flex;"><span>$ swapoff -a <span style="color:#f92672">&amp;&amp;</span> kubeadm reset <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	<span style="color:#f92672">&amp;&amp;</span> systemctl daemon-reload <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	<span style="color:#f92672">&amp;&amp;</span> systemctl restart kubelet <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	<span style="color:#f92672">&amp;&amp;</span> iptables -F <span style="color:#f92672">&amp;&amp;</span> iptables -t nat -F <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	<span style="color:#f92672">&amp;&amp;</span> iptables -t mangle -F <span style="color:#f92672">&amp;&amp;</span> iptables -X</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->查看<code>node</code>信息<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl get nodes
</span></span><span style="display:flex;"><span>NAME         STATUS   ROLES                  AGE   VERSION
</span></span><span style="display:flex;"><span>k8s-master   Ready    control-plane,master   23h   v1.21.12
</span></span><span style="display:flex;"><span>k8s-node1    Ready    &lt;none&gt;                 23h   v1.21.12
</span></span><span style="display:flex;"><span>k8s-node2    Ready    &lt;none&gt;                 23h   v1.21.12</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->根据提示消息，在<code>Master</code>节点上使用<code>kubectl</code>工具，可以把下列<code>.kube</code>目录同步到<code>node</code>节点，以便<code>node</code>节点使用<code>kubectl</code>工具<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted --><strong>注意：</strong><!-- raw HTML omitted -->如果不执行<!-- raw HTML omitted -->以下命令<!-- raw HTML omitted -->，执行<code>kubectl get nodes</code>命令报错：<code>couldn't get current server API group list: Get &quot;http://localhost:8080/api?timeout=32s&quot;: dial tcp [::1]:8080: connect: connection refused</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -p $HOME/.kube
</span></span><span style="display:flex;"><span>$ cp -i /etc/kubernetes/admin.conf <span style="color:#e6db74">${</span>HOME<span style="color:#e6db74">}</span>/.kube/config
</span></span><span style="display:flex;"><span>$ chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> <span style="color:#e6db74">${</span>HOME<span style="color:#e6db74">}</span>/.kube/config
</span></span><span style="display:flex;"><span>$ scp -r /root/.kube root@k8s-node-01:/root/</span></span></code></pre></div></blockquote>
<hr>
<h3 id="node节点加入集群"><code>node</code>节点加入集群</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->当主节点启动完<code>k8s</code>之后会生成加入节点的命令，视自己服务器而定<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm join 192.168.35.128:6443 --token l37r7y.75gjs1ltufdp8kp2 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	--discovery-token-ca-cert-hash sha256:9ebc670ec3f97b5f42d77908f378786ed806ef22e9ae2cf21fe5fb239483833c</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->默认<code>token</code>有效期为24小时，当过期之后，该<code>token</code>就不可用了。这时就需要重新创建<code>token</code>，操作如下：<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm token list  	<span style="color:#75715e"># 查看Token</span>
</span></span><span style="display:flex;"><span>$ kubeadm token create --print-join-command
</span></span><span style="display:flex;"><span>$ kubeadm token create --ttl <span style="color:#ae81ff">0</span> --print-join-command  <span style="color:#75715e"># 生成一个永不过期的token</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 重新获取sha56key</span>
</span></span><span style="display:flex;"><span>$ openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outfrom der 2&gt;dev/null | openssl dgst -sha256 -hex | sed <span style="color:#e6db74">&#39;s/^.* //&#39;</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><code>master</code><!-- raw HTML omitted -->执行命令查看节点是否已加入<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl get componentstatuses  	<span style="color:#75715e"># 查看集群健康状况，缩写为：cs</span>
</span></span><span style="display:flex;"><span>NAME                 STATUS    MESSAGE             ERROR
</span></span><span style="display:flex;"><span>scheduler            Healthy   ok                  
</span></span><span style="display:flex;"><span>controller-manager   Healthy   ok                  
</span></span><span style="display:flex;"><span>etcd-0               Healthy   <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;health&#34;</span>:<span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">}</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->查看部署好的命名空间<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>default</code><!-- raw HTML omitted -->：所有未指定的<code>Namespace</code>的对象都会被分配在default命名空间<!-- raw HTML omitted --></li>
<li><code>kube-node-lease</code><!-- raw HTML omitted -->：集群节点之间的心跳维护，<code>v1.13</code>开始引入<!-- raw HTML omitted --></li>
<li><code>kube-public</code><!-- raw HTML omitted -->：此命名空间的资源可以被所有人访问（包括未认证用户）<!-- raw HTML omitted --></li>
<li><code>kube-system</code><!-- raw HTML omitted -->：所有由<code>kubernetes</code>系统创建的资源都处于这个命名空间<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl get namespace  <span style="color:#75715e"># 缩写为： ns</span>
</span></span><span style="display:flex;"><span>NAME              STATUS   AGE 
</span></span><span style="display:flex;"><span>default           Active   19h
</span></span><span style="display:flex;"><span>kube-node-lease   Active   19h
</span></span><span style="display:flex;"><span>kube-public       Active   19h
</span></span><span style="display:flex;"><span>kube-system       Active   19h</span></span></code></pre></div></blockquote>
<hr>
<h4 id="处理集群状态statusnotreadyfont-colorred是网络不通部署fontcnifont-colorred网络插件font">处理集群状态：<code>STATUS：NotReady</code><!-- raw HTML omitted -->是网络不通部署：<!-- raw HTML omitted --><code>CNI</code><!-- raw HTML omitted -->网络插件<!-- raw HTML omitted --></h4>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://segmentfault.com/a/1190000018698263" rel="external" target="_self">网络：<code>Flannel</code>、<code>Calico</code>、<code>Canal</code>和<code>Weave</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://dockone.io/article/10501" rel="external" target="_self">简单聊聊<code>Calico</code>与<code>Flannel</code></a></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li><code>kubernetes</code><!-- raw HTML omitted -->支持多种网络插件，比如<!-- raw HTML omitted --><code>flannel</code>、<code>calico</code>、<code>canal</code><!-- raw HTML omitted -->等，任选一种即可，本次选择<!-- raw HTML omitted --><code>flannel</code><!-- raw HTML omitted -->，当然你也可以安装<!-- raw HTML omitted --><code>calico</code><!-- raw HTML omitted -->，推荐安装<!-- raw HTML omitted --><code>calico</code></li>
<li><!-- raw HTML omitted -->在<code>Master</code>节点上获取<code>flannel</code>配置文件(可能会失败，如果失败，请下载到本地，然后安装)：<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li>
<ol>
<li><code>flannel、calico</code><!-- raw HTML omitted -->：基于隧道<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>隧道方案最具普适性，在任何网络环境下都可以正常工作，这与它的原理密不可分。</li>
<li>最常见的隧道方案是<code>flannel &quot;Type&quot;: &quot;vxlan&quot;</code>模式，以及<code>calico</code>的<code>ipip</code>模式，</li>
</ul>
</blockquote>
<ul>
<li>
<ol start="2">
<li><code>flannel、calico</code><!-- raw HTML omitted -->：基于路由<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>路由方案性能最好，原因是该方案不需要封包和解包，所以没有隧道方案的劣势，网络性能很好。</li>
<li>常见的路由方案包括了<code>flannel</code>的<code>&quot;Type&quot;: &quot;host-gw&quot;</code>模式，以及<code>calico</code>的<code>bgp</code>模式。</li>
<li><code>master</code><!-- raw HTML omitted -->节点执行一下语句安装<!-- raw HTML omitted --><code>calico</code><!-- raw HTML omitted -->网络插件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ curl https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/calico.yaml -O
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 看情况修改 calico配置文件</span>
</span></span><span style="display:flex;"><span>$ cat &gt;calico.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- name: CALICO_IPV4POOL_CIDR  	# 修改 CALICO_IPV4POOL_CIDR对应的参数
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  value: &#34;192.168.1.0/24&#34;  	# 修改为 --pod-network-cidr 对应的网段
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改calico 镜像地址</span>
</span></span><span style="display:flex;"><span>$ grep image calico.yaml
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s#docker.io/##g&#39;</span> calico.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl apply -f calico.yaml</span></span></code></pre></div><ul>
<li><code>master</code><!-- raw HTML omitted -->节点执行一下语句安装<code>flannel</code>网络插件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget -P /opt/k8s/yaml/ https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</span></span><span style="display:flex;"><span>$ kubectl get pods -n kube-system</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><code>kubernetes</code><!-- raw HTML omitted -->中<code>kubectl</code>命令自动补全<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum install -y bash-completion
</span></span><span style="display:flex;"><span>$ source /etc/profile.d/bash_completion.sh</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->集群不健康<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>
<p><!-- raw HTML omitted -->需要注释掉<!-- raw HTML omitted --><code>etc/kubernetes/manifests</code>目录下的<code>kube-controller-manager.yaml</code>和<code>kube-scheduler.yaml</code>的<code>--port=0</code>：</p>
</li>
<li>
<p><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>kube-controller-manager.yaml</code>文件</p>
</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo cat &gt;&gt;/etc/kubernetes/manifests/kube-controller-manager.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - command:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - kube-controller-manager
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --allocate-node-cidrs=true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --authentication-kubeconfig=/etc/kubernetes/controller-manager.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --authorization-kubeconfig=/etc/kubernetes/controller-manager.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --bind-address=127.0.0.1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --client-ca-file=/etc/kubernetes/pki/ca.crt
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --cluster-cidr=10.244.0.0/16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --cluster-name=kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --cluster-signing-cert-file=/etc/kubernetes/pki/ca.crt
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --cluster-signing-key-file=/etc/kubernetes/pki/ca.key
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --controllers=*,bootstrapsigner,tokencleaner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --kubeconfig=/etc/kubernetes/controller-manager.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --leader-elect=true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # 修改部分
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # - --port=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --root-ca-file=/etc/kubernetes/pki/ca.crt
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --service-account-private-key-file=/etc/kubernetes/pki/sa.key
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --service-cluster-ip-range=10.96.0.0/12
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --use-service-account-credentials=true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>kube-scheduler.yaml</code>文件</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo cat &gt;&gt;/etc/kubernetes/manifests/kube-scheduler.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - command:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - kube-scheduler
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --authentication-kubeconfig=/etc/kubernetes/scheduler.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --authorization-kubeconfig=/etc/kubernetes/scheduler.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --bind-address=127.0.0.1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --kubeconfig=/etc/kubernetes/scheduler.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --leader-elect=true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # 修改部分
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # - --port=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在所有Master节点再次查看集群健康状况：</span>
</span></span><span style="display:flex;"><span>$ kubectl get cs</span></span></code></pre></div></blockquote>
<hr>
<h2 id="部署kubernetes集群">部署<code>Kubernetes</code>集群</h2>
<h3 id="安装高可用组件">安装高可用组件</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->注意：如果不是高可用集群，<!-- raw HTML omitted --><code>haproxy</code>和<code>keepalived</code>无需安装</li>
</ul>
</blockquote>
<ul>
<li>
<ol>
<li>所有<code>Master</code>节点安装<code>HAPROXY</code>和<code>Keepalived</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install keepalived haproxy</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->所有<!-- raw HTML omitted --><code>Master</code><!-- raw HTML omitted -->节点配置<!-- raw HTML omitted --><code>HAProxy</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/haproxy/haproxy.cfg<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">global
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	maxconn  2000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	ulimit-n  16384
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	log  127.0.0.1 local0 err
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	stats timeout 30s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">defaults
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	log global
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	mode  http
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	option  httplog
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	timeout connect 5000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	timeout client  50000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	timeout server  50000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	timeout http-request 15s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	timeout http-keep-alive 15s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">frontend monitor-in
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	bind *:33305
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	mode http
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	option httplog
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	monitor-uri /monitor
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">listen stats
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	bind    *:8006
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	mode    http
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	stats   enable
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	stats   hide-version
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	stats   uri       /stats
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	stats   refresh   30s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	stats   realm     Haproxy\ Statistics
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	stats   auth      admin:admin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">frontend k8s-master
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	bind 0.0.0.0:16443
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	bind 127.0.0.1:16443
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	mode tcp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	option tcplog
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	tcp-request inspect-delay 5s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	default_backend k8s-master
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">backend k8s-master
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	mode tcp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	option tcplog
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	option tcp-check
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	balance roundrobin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# 下面的配置根据实际情况修改
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	server k8s-master-01 192.168.80.210:6443  check
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	server k8s-master-02 192.168.80.211:6443  check
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><code>Msster-01</code>的<code>Keepalived</code><!-- raw HTML omitted -->配置文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/keepalived/keepalived.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">! Configuration File for keepalived
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	global_defs {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		# 标识本节点的字条串，通常为 hostname
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		router_id k8s-master-01
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		script_user root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		enable_script_security    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# 检测脚本
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# keepalived会定时执行脚本并对脚本执行的结果进行分析，动态调整vrrp_instance的优先级。如果脚本执行结果为0，并且weight配置的值大于0，则优先级相应的增加。如果脚本执行结果非0，并且weight配置的值小于0，则优先级相应的减少。其他情况，维持原本配置的优先级，即配置文件中priority对应的值。
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	vrrp_script chk_apiserver {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		script &#34;/etc/keepalived/check_apiserver.sh&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        # 每2秒检查一次
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        interval 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        # 一旦脚本执行成功，权重减少5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        weight -5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        fall 3  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        rise 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# 定义虚拟路由，VI_1 为虚拟路由的标示符，自己定义名称
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	vrrp_instance VI_1 {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		# 主节点为 MASTER，对应的备份节点为 BACKUP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		state MASTER
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		# 绑定虚拟 IP 的网络接口，与本机 IP 地址所在的网卡名称相同
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		interface ens32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		# 主机的IP地址
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		mcast_src_ip 192.168.80.210
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		# 虚拟路由id
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		virtual_router_id 100
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		# 节点优先级，值范围 0-254，MASTER 要比 BACKUP 高
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		priority 100
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		# 优先级高的设置 nopreempt 解决异常恢复后再次抢占的问题
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		nopreempt 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		# 组播信息发送间隔，所有节点设置必须一样，默认 1s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		advert_int 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        # 设置验证信息，所有节点必须一致
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		authentication {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			auth_type PASS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			auth_pass K8SHA_KA_AUTH
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		# 虚拟 IP 池, 所有节点设置必须一样
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		virtual_ipaddress {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			# 虚拟 ip，可以定义多个	
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			192.168.80.220/24
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		track_script {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			chk_apiserver
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><code>Master-02</code>的<code>Keepalived</code><!-- raw HTML omitted -->配置文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/keepalived/keepalived.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">! Configuration File for keepalived
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	global_defs {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		router_id k8s-master-02
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		script_user root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		enable_script_security    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	vrrp_script chk_apiserver {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		script &#34;/etc/keepalived/check_apiserver.sh&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		interval 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		weight -5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		fall 3  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		rise 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	vrrp_instance VI_1 {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		state BACKUP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		interface ens32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		mcast_src_ip 192.168.80.211
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		virtual_router_id 101
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		priority 99
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		advert_int 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		authentication {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			auth_type PASS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			auth_pass K8SHA_KA_AUTH
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		virtual_ipaddress {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			192.168.80.220/24
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		track_script {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			chk_apiserver
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li>所有<code>Master</code><!-- raw HTML omitted -->节点设置监控脚本，并且给予执行权限<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/keepalived/check_apiserver.sh<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">err=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">for k in $(seq 1 5)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">do
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	check_code=$(pgrep kube-apiserver)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	if [[ $check_code == &#34;&#34; ]]; then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		err=$(expr $err + 1)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		sleep 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		continue
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	else
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		err=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		break
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">done
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if [[ $err != &#34;0&#34; ]]; then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	echo &#34;systemctl stop keepalived&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	/usr/bin/systemctl stop keepalived
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	exit 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">else
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	exit 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>$ chmod +x /etc/keepalived/check_apiserver.sh</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li>所有<code>Master</code><!-- raw HTML omitted -->节点启动<!-- raw HTML omitted --><code>HAProxy</code>和<code>Keepalived</code>并且测试<code>VIP(虚拟IP)</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl daemon-reload
</span></span><span style="display:flex;"><span>$ systemctl enable --now haproxy
</span></span><span style="display:flex;"><span>$ systemctl enable --now keepalived
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ping 192.168.80.220 -c <span style="color:#ae81ff">4</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="初始化kubernetes">初始化<code>Kubernetes</code></h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->命令行<!-- raw HTML omitted --><!-- raw HTML omitted -->方式初始化所有<!-- raw HTML omitted --><code>Master</code>节点</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>在<code>k8s-master01</code><!-- raw HTML omitted -->节点执行下面的命令：<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm init <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --apiserver-advertise-address<span style="color:#f92672">=</span>192.168.80.210 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --image-repository registry.aliyuncs.com/google_containers <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --control-plane-endpoint<span style="color:#f92672">=</span>192.168.80.225:16443 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --kubernetes-version v1.20.2 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --service-cidr<span style="color:#f92672">=</span>10.96.0.0/12 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --pod-network-cidr<span style="color:#f92672">=</span>10.244.0.0/16 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --cri-socket unix:///var/run/containerd/containerd.sock  	<span style="color:#75715e"># 配置 CRI 端点</span>
</span></span><span style="display:flex;"><span>  --upload-certs</span></span></code></pre></div><ul>
<li>将<code>k8s-master02</code><!-- raw HTML omitted -->节点加入到集群中，其他<code>master</code>节点加入同样命令<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm join 192.168.80.225:16443 --token povqsg.arg07e5ia1pywr71 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --discovery-token-ca-cert-hash sha256:9efd30b7f35747289b9de0c8d0768b9c2d5eb7d675cb86fa05b9a6d9526c3441 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --control-plane --certificate-key 363cc6296537b41607851c10f1f41ef23cf5cdc6965cb9c26e4b252315086855</span></span></code></pre></div><ul>
<li>防止在<code>Master-02</code><!-- raw HTML omitted -->节点中不能使用<!-- raw HTML omitted --><code>kubectl</code>命令</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -p $HOME/.kube
</span></span><span style="display:flex;"><span>$ sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style="display:flex;"><span>$ sudo chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config</span></span></code></pre></div><ul>
<li>如果<code>Token</code>过期，需要在<code>Master-01</code><!-- raw HTML omitted -->生成新的<!-- raw HTML omitted --><code>Token</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm token create --print-join-command</span></span></code></pre></div><ul>
<li>如果<code>Master</code><!-- raw HTML omitted -->要加入到集群中，需要在<!-- raw HTML omitted --><code>Master-01</code>生成<code>--certificate-key</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm init phase upload-certs --upload-certs</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><code> yaml</code><!-- raw HTML omitted -->方式初始化所有<!-- raw HTML omitted --><code>Master</code>节点</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>在<code>k8s-master01</code><!-- raw HTML omitted -->创建目录生成配置文件<!-- raw HTML omitted --><code>kubeadm-config.yaml</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -p /opt/k8s/yaml
</span></span><span style="display:flex;"><span>$ kubeadm config print init-defaults &gt;/opt/k8s/yaml/kubeadm-config.yaml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改配置文件</span>
</span></span><span style="display:flex;"><span>apiVersion: kubeadm.k8s.io/v1beta3
</span></span><span style="display:flex;"><span>bootstrapTokens:
</span></span><span style="display:flex;"><span>- groups:
</span></span><span style="display:flex;"><span>    - system:bootstrappers:kubeadm:default-node-token
</span></span><span style="display:flex;"><span>    token: abcdef.0123456789abcdef
</span></span><span style="display:flex;"><span>    ttl: 24h0m0s
</span></span><span style="display:flex;"><span>    usages:
</span></span><span style="display:flex;"><span>    - signing
</span></span><span style="display:flex;"><span>    - authentication
</span></span><span style="display:flex;"><span>kind: InitConfiguration
</span></span><span style="display:flex;"><span>localAPIEndpoint:
</span></span><span style="display:flex;"><span>    advertiseAddress: 1.2.3.4  	<span style="color:#75715e"># 修改为master本机IP</span>
</span></span><span style="display:flex;"><span>    bindPort: <span style="color:#ae81ff">6443</span>  	<span style="color:#75715e"># 使用端口</span>
</span></span><span style="display:flex;"><span>nodeRegistration:
</span></span><span style="display:flex;"><span>    criSocket: unix:///var/run/containerd/containerd.sock  	<span style="color:#75715e"># 配置 CRI 端点</span>
</span></span><span style="display:flex;"><span>    imagePullPolicy: IfNotPresent
</span></span><span style="display:flex;"><span>    name: node  	<span style="color:#75715e"># 配置主机名， 主机名不允许使用下划线</span>
</span></span><span style="display:flex;"><span>    taints: null
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiServer:
</span></span><span style="display:flex;"><span>    timeoutForControlPlane: 4m0s
</span></span><span style="display:flex;"><span>apiVersion: kubeadm.k8s.io/v1beta3
</span></span><span style="display:flex;"><span>certificatesDir: /etc/kubernetes/pki
</span></span><span style="display:flex;"><span>clusterName: kubernetes
</span></span><span style="display:flex;"><span>controllerManager: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>dns: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>etcd:
</span></span><span style="display:flex;"><span>    local:
</span></span><span style="display:flex;"><span>        dataDir: /var/lib/etcd
</span></span><span style="display:flex;"><span>imageRepository: k8s.gcr.io  	<span style="color:#75715e"># 定义使用镜像源</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># imageRepository: registry.aliyuncs.com/google_containers  	# 阿里云镜像源</span>
</span></span><span style="display:flex;"><span>kind: ClusterConfiguration
</span></span><span style="display:flex;"><span>kubernetesVersion: 1.24.0  	<span style="color:#75715e"># 定义kubernetes版本</span>
</span></span><span style="display:flex;"><span>networking:
</span></span><span style="display:flex;"><span>    dnsDomain: cluster.local
</span></span><span style="display:flex;"><span>    serviceSubnet: 10.96.0.0/12
</span></span><span style="display:flex;"><span>scheduler: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiVersion: kubeproxy.config.k8s.io/v1alpha1
</span></span><span style="display:flex;"><span>kind: KubeProxyConfiguration
</span></span><span style="display:flex;"><span>featureGates:
</span></span><span style="display:flex;"><span>    SupportIPVSProxyMode: true
</span></span><span style="display:flex;"><span>mode: ipvs  	<span style="color:#75715e"># 启用ipvs</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->可以使用如下的命令更新<!-- raw HTML omitted --><code>kubeadm-config.yaml</code>文件，需要将<code>k8s</code>设置到对应的版本</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm config migrate --old-config /opt/k8s/yaml/kubeadm-config.yaml --new-config <span style="color:#e6db74">&#34;new.yaml&#34;</span></span></span></code></pre></div><ul>
<li>将<code>new.yaml</code><!-- raw HTML omitted -->文件复制到所有的<!-- raw HTML omitted --><code>master</code>节点</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ scp new.yaml k8s-master-02:/opt/k8s/yaml/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看以及下载所有master节点提前下载镜像</span>
</span></span><span style="display:flex;"><span>$ kubeadm config images pull --config /opt/k8s/yaml/new.yaml  	<span style="color:#75715e"># pull替换list可查看所需镜像</span></span></span></code></pre></div><ul>
<li><code>k8s-master01</code>节点初始化后，会在<code>/etc/kubernetes</code><!-- raw HTML omitted -->目录下生成对应的证书和配置文件，之后其他的<!-- raw HTML omitted --><code>Master</code>节点加入到<code>k8s-master01</code>节点即可</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm init --config /opt/k8s/yaml/new.yaml --upload-certs</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->如果初始化失败，重置后再次初始化，命令如下：<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm reset -f;ipvsadm --clear;rm -rf ~/.kube</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->初始化成功后，会产生<!-- raw HTML omitted --><code>token</code>值，用于其他节点加入时使用，</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>Your Kubernetes control-plane has initialized successfully!
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>To start using your cluster, you need to run the following as a regular user:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  mkdir -p $HOME/.kube
</span></span><span style="display:flex;"><span>  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style="display:flex;"><span>  sudo chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Alternatively, <span style="color:#66d9ef">if</span> you are the root user, you can run:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  export KUBECONFIG<span style="color:#f92672">=</span>/etc/kubernetes/admin.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>You should now deploy a pod network to the cluster.
</span></span><span style="display:flex;"><span>Run <span style="color:#e6db74">&#34;kubectl apply -f [podnetwork].yaml&#34;</span> with one of the options listed at:
</span></span><span style="display:flex;"><span>  https://kubernetes.io/docs/concepts/cluster-administration/addons/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>You can now join any number of the control-plane node running the following command on each as root:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 其他 Master 节点执行</span>
</span></span><span style="display:flex;"><span>  kubeadm join 192.168.80.210:16443 --token abcdef.0123456789abcdef <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --discovery-token-ca-cert-hash sha256:505e373bae6123fc3e27e778c5fedbccbf0f91a51efdcc11b32c4573605b8e71 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --control-plane --certificate-key 70aef5f76111a5824085c644b3f34cf830efad00c1b16b878701166bf069664e
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Please note that the certificate-key gives access to cluster sensitive data, keep it secret!
</span></span><span style="display:flex;"><span>As a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;kubeadm init phase upload-certs --upload-certs&#34;</span> to reload certs afterward.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Then you can join any number of worker nodes by running the following on each as root:
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 所有 Node 节点执行</span>
</span></span><span style="display:flex;"><span>kubeadm join 192.168.80.210:16443 --token abcdef.0123456789abcdef <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --discovery-token-ca-cert-hash sha256:505e373bae6123fc3e27e778c5fedbccbf0f91a51efdcc11b32c4573605b8e71</span></span></code></pre></div><ul>
<li><code>k8s-master01</code><!-- raw HTML omitted -->节点配置环境变量，用于访问<!-- raw HTML omitted --><code>kubernetes</code>集群</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># root用户</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/root/.bashrc<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export KUBECONFIG=/etc/kubernetes/admin.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ source ~/.bash_profile
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 普通用户</span>
</span></span><span style="display:flex;"><span>$ mkdir -p $HOME/.kube
</span></span><span style="display:flex;"><span>$ sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style="display:flex;"><span>$ sudo chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># k8s-master-01中查看节点的状态：</span>
</span></span><span style="display:flex;"><span>$ kubectl get nodes</span></span></code></pre></div></blockquote>
<hr>
<h3 id="node节点加入集群-1"><code>Node</code>节点加入集群</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->所有<!-- raw HTML omitted --><code>Node</code><!-- raw HTML omitted -->节点执行<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm join 192.168.80.225:16443 --token povqsg.arg07e5ia1pywr71 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> --discovery-token-ca-cert-hash sha256:9efd30b7f35747289b9de0c8d0768b9c2d5eb7d675cb86fa05b9a6d9526c3441</span></span></code></pre></div></blockquote>
<hr>
<h2 id="font-colorred二进制安装fontkubernetes"><!-- raw HTML omitted -->二进制安装<!-- raw HTML omitted --><code>kubernetes</code></h2>
<h3 id="部署etcd存储集群三台主机作为节点">部署<code>Etcd</code>存储集群、三台主机作为节点</h3>
<ul>
<li>
<ol>
<li>键值对数据库，存储<code>K8S</code>集群所有重要信息(持久化)  <a href="https://blog.csdn.net/qq_27276045/article/details/115650151" rel="external" target="_self"><code>Kubernetes</code>存储大脑之<code>etcd</code></a>、<a href="https://www.infoq.cn/article/rhzug069xvr5z5bhhtiv" rel="external" target="_self">突破<code>etcd</code>限制！字节开源自研<code>K8s</code>存储<code>KubeBrain</code></a></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>Etcd 是一个分布式键值存储系统，Kubernetes使用Etcd进行数据存储，所以先准备一个Etcd数据库，为解决Etcd单点故障，应采用集群方式部署，这里使用3台组建集群，可容忍1台机器故障，当然，你也可以使用5台组建集群，可容忍2台机器故障</span></span></code></pre></div><ul>
<li>1.1 注意这里<code>profiles</code>字段下名称，其中<code>CjServer</code>下注明<code>server auth</code>用于服务器端认证，后续在生成服务器证书时候，需要使用这个名称作为<code>cfssl</code>命令的配置文件名称作为参数传入。</li>
<li>1.2 注意这里<code>profiles</code>字段下名称，其中<code>CjServer</code>下注明<code>server auth</code>用于服务器端认证，后续在生成服务器证书时候，需要使用这个名称作为<code>cfssl</code>命令的配置文件名称作为参数传入。</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">{</span><span style="color:#e6db74">&#34;code&#34;</span>:5100,<span style="color:#e6db74">&#34;message&#34;</span>:<span style="color:#e6db74">&#34;Invalid policy: no key usage available&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>Failed to parse input: unexpected end of JSON input</span></span></code></pre></div><ul>
<li>1.3 往往是提供的<code>-profile</code>参数中的配置文件名在<code>ca-config.json</code>中无法匹配</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 1.准备cfssl证书生成工具、cfssl是一个开源的证书管理工具，使用json文件生成证书，找任意一台服务器操作，
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cd /usr/local/src/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64  	# 是v1.2.0 最好升级到v1.3.4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ chmod +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 添加环境变量第一种方式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ vim /etc/profile
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export PATH=$PATH:/opt/kubernetes/bin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ source /etc/profile
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 把可执行文件挪移并改名
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ mv cfssl_linux-amd64 /usr/local/bin/cfssl
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ mv cfssljson_linux-amd64 /usr/local/bin/cfssljson
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ mv cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 2.生成Etcd证书、自签证书颁发机构（CA）创建工作目录：
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cat &gt;/opt/kubernetes/ssl/ca-config.json&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;signing&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;default&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;expiry&#34;: &#34;87600h&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;profiles&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;kubernetes&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         &#34;expiry&#34;: &#34;87600h&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         &#34;usages&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;signing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;key encipherment&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;server auth&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;client auth&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">###################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cat &gt;/opt/kubernetes/ssl/ca-csr.json&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;CN&#34;: &#34;etcd CA&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;key&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;size&#34;: 2048
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;names&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;L&#34;: &#34;Beijing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;ST&#34;: &#34;Beijing&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 3.生成证书
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cd /opt/kubernetes/ssl/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cfssl gencert -initca ca-csr.json | cfssljson -bare ca -
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 4. 使用自签CA签发Etcd HTTPS证书:创建证书申请文件  #####
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cat &gt;/opt/kubernetes/ssl/etcd-csr.json&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;CN&#34;: &#34;etcd&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;hosts&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;192.168.4.110&#34;, # 修改IP、为了扩容方便可以多写几个IP、去掉注释
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;192.168.4.111&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;192.168.4.112&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;xxx.xxx.xxx.xxx&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;xxx.xxx.xxx.xxx&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;xxx.xxx.xxx.xxx&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;key&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;size&#34;: 2048
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;names&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;L&#34;: &#34;BeiJing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;ST&#34;: &#34;BeiJing&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 5. 生成证书
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cd /opt/kubernetes/ssl/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes etcd-csr.json | cfssljson -bare etcd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 6.在GitHub上下载二进制文件
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cd /usr/local/src/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ wget https://github.com/etcd-io/etcd/releases/download/v3.4.14/etcd-v3.4.14-linux-amd64.tar.gz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ tar zxvf etcd-v3.4.14-linux-amd64.tar.gz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ mv etcd-v3.4.14-linux-amd64/{etcd,etcdctl} /opt/etcd/bin/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 6.创建etcd配置文件：针对IP修改为本机IP，拷贝过去后把所有结尾的“注释取消掉”
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cat &gt;/opt/etcd/cfg/etcd.conf&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># [Member]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ETCD_NAME=&#34;etcd-node1&#34;  	# 修改此处，节点2改为etcd-2，节点3改为etcd-3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ETCD_DATA_DIR=&#34;/var/lib/etcd/default.etcd&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ETCD_LISTEN_PEER_URLS=&#34;https://192.168.4.110:2380&#34;  	# 修改此处为当前服务器IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ETCD_LISTEN_CLIENT_URLS=&#34;https://192.168.4.110:2379,https://127.0.0.1:2379&#34;  	# 修改此处为当前服务器IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># [Clustering]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ETCD_INITIAL_ADVERTISE_PEER_URLS=&#34;https://192.168.4.110:2380&#34;  	# 修改此处为当前服务器IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ETCD_ADVERTISE_CLIENT_URLS=&#34;https://192.168.4.110:2379&#34;  # 修改此处为当前服务器IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 修改为所有节点IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ETCD_INITIAL_CLUSTER=&#34;etcd-node1=https://192.168.4.110:2380,etcd-node2=https://192.168.4.111:2380,etcd-node3=https://192.168.4.112:2380&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ETCD_INITIAL_CLUSTER_TOKEN=&#34;etcd-cluster&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ETCD_INITIAL_CLUSTER_STATE=&#34;new&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># [security]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># CLIENT_CERT_AUTH=&#34;true&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_CA_FILE=&#34;/opt/etcd/ssl/ca.pem&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_CERT_FILE=&#34;/opt/etcd/ssl/server.pem&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_KEY_FILE=&#34;/opt/etcd/ssl/server-key.pem&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># PEER_CLIENT_CERT_AUTH=&#34;true&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_PEER_CA_FILE=&#34;/opt/etcd/ssl/ca.pem&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_PEER_CERT_FILE=&#34;/opt/etcd/ssl/server.pem&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_PEER_KEY_FILE=&#34;/opt/etcd/ssl/server-key.pem&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#####################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_NAME：节点名称，集群中唯一
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_DATA_DIR：数据目录
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_LISTEN_PEER_URLS：集群通信监听地址
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_LISTEN_CLIENT_URLS：客户端访问监听地址
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_INITIAL_ADVERTISE_PEER_URLS：集群通告地址
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_ADVERTISE_CLIENT_URLS：客户端通告地址
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_INITIAL_CLUSTER：集群节点地址
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_INITIAL_CLUSTER_TOKEN：集群Token
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_INITIAL_CLUSTER_STATE：加入集群的当前状态，new是新集群，existing表示加入已有集群
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 7.systemctl管理etcd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cat &gt;/usr/lib/systemd/system/etcd.service&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=Etcd Server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Wants=network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Type=notify
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EnvironmentFile=/opt/etcd/cfg/etcd.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/etcd/bin/etcd \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cert-file=/opt/etcd/ssl/etcd.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--key-file=/opt/etcd/ssl/etcd-key.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--peer-cert-file=/opt/etcd/ssl/etcd.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--peer-key-file=/opt/etcd/ssl/etcd-key.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--trusted-ca-file=/opt/etcd/ssl/ca.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--peer-trusted-ca-file=/opt/etcd/ssl/ca.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--logger=zap
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LimitNOFILE=65536
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">###################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 8.拷贝刚刚生成证书到etcd目录下
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cd /opt/kubernetes/ssl/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cp ca*.pem etcd*.pem /opt/etcd/ssl/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 9.节点1生成的所有文件拷贝到其他所有节点、然后在其他节点分别修改etcd.conf配置文件中的节点名称和当前服务器IP：
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ ansible node -i /etc/ansible/hosts -m copy -a &#34;src=../../../../opt/etcd dest=/opt&#34; -f 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ ansible node -i /etc/ansible/hosts -m copy -a &#34;src=../../../../usr/lib/systemd/system/etcd.service dest=/usr/lib/systemd/system&#34; -f 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ mkdir -p /var/lib/etcd  	# 三个节点都执行
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ chmod +x /opt/etcd/bin/*  	# 其他两个节点执行语句给予执行权限
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 10.所有节点设置开机自启
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ systemctl daemon-reload
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ systemctl enable etcd &amp;&amp; systemctl start etcd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 测试etcd数据库可用性
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ etcdctl set testdir/testkey0 0  	# 设置一个键值对 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ etcdctl get testdir/testkey0  	# 查看是否获取到数据
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ etcdctl -C http://localhost:2379 cluster-health
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 11.查看集群状态
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ ETCDCTL_API=3 /opt/etcd/bin/etcdctl --cacert=/opt/etcd/ssl/ca.pem --cert=/opt/etcd/ssl/etcd.pem --key=/opt/etcd/ssl/etcd-key.pem --endpoints=&#34;https://192.168.4.110:2379,https://192.168.4.111:2379,https://192.168.4.112:2379&#34; endpoint health &#39;</span> &gt;&gt;install_etcd.sh</span></span></code></pre></div></blockquote>
<hr>
<h3 id="署master-node生成kube-apiserver证书自签证书颁发机构ca">署<code>Master Node</code>，生成<code>kube-apiserver</code>证书：自签证书颁发机构<code>CA</code></h3>
<ul>
<li>
<ol>
<li><code>api-server：</code>所有服务访问统一入口</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 1.创建证书申请文件：
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># hosts字段中IP为所有Master/LB/VIP IP,一个都不能少！为了方便后期扩容可以多写几个预留的IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cat &gt; /opt/kubernetes/ssl/kube-apiserver-csr.json &lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;CN&#34;: &#34;kubernetes&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;hosts&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;10.0.0.1&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;127.0.0.1&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;192.168.4.110&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;192.168.4.111&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;192.168.4.112&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;xxx.xxx.xxx.xxx&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;xxx.xxx.xxx.xxx&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;kubernetes&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;kubernetes.default&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;kubernetes.default.svc&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;kubernetes.default.svc.cluster&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;kubernetes.default.svc.cluster.local&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;key&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;size&#34;: 2048
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">},
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;names&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;L&#34;: &#34;BeiJing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;ST&#34;: &#34;BeiJing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;O&#34;: &#34;k8s&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;OU&#34;: &#34;System&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">######################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 2.生成证书:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cd /opt/kubernetes/ssl
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-apiserver-csr.json | cfssljson -bare api-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 打开链接下载二进制包
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.20.md#v1202
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cd /usr/local/src
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ wget https://dl.k8s.io/v1.18.6/kubernetes-server-linux-amd64.tar.gz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ tar zxvf kubernetes-server-linux-amd64.tar.gz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cd kubernetes/server/bin/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cp kube-apiserver kube-scheduler kube-controller-manager /opt/kubernetes/bin/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cp kubectl /usr/bin/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 3.部署kube-apiserver
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 两个&#34;\\&#34;第一个是转义符，第二个是换行符，使用转义符是为了使用EOF保留换行符
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cat &gt;/opt/kubernetes/cfg/kube-apiserver.conf&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">KUBE_APISERVER_OPTS=&#34;--logtostderr=false \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--v=2 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--log-dir=/opt/kubernetes/logs \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--etcd-servers=https://192.168.4.110:2379,https://192.168.4.111:2379,https://192.168.4.112:2379 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--bind-address=192.168.4.110 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--secure-port=6443 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--advertise-address=192.168.4.110 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--allow-privileged=true \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--service-cluster-ip-range=10.0.0.0/24 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--authorization-mode=RBAC,Node \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--enable-bootstrap-token-auth=true \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--token-auth-file=/opt/kubernetes/cfg/token.csv \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--service-node-port-range=30000-32767 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--kubelet-client-certificate=/opt/kubernetes/ssl/api-server.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--kubelet-client-key=/opt/kubernetes/ssl/api-server-key.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--tls-cert-file=/opt/kubernetes/ssl/api-server.pem  \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--tls-private-key-file=/opt/kubernetes/ssl/api-server-key.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--client-ca-file=/opt/kubernetes/ssl/ca.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--service-account-key-file=/opt/kubernetes/ssl/ca-key.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--etcd-cafile=/opt/etcd/ssl/ca.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--etcd-certfile=/opt/etcd/ssl/server.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--etcd-keyfile=/opt/etcd/ssl/server-key.pem \\  	# 证书需要修改
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--audit-log-maxbackup=3 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--audit-log-maxsize=100 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--audit-log-path=/opt/kubernetes/logs/k8s-audit.log&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#######################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–logtostderr：启用日志
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">—v：日志等级
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–log-dir：日志目录
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–etcd-servers：etcd集群地址
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–bind-address：监听地址
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–secure-port：https安全端口
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–advertise-address：集群通告地址
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–allow-privileged：启用授权
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–service-cluster-ip-range：Service虚拟IP地址段
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–enable-admission-plugins：准入控制模块
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–authorization-mode：认证授权，启用RBAC授权和节点自管理
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–enable-bootstrap-token-auth：启用TLS bootstrap机制
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–token-auth-file：bootstrap token文件
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–service-node-port-range：Service nodeport类型默认分配端口范围
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–kubelet-client-xxx：apiserver访问kubelet客户端证书
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–tls-xxx-file：apiserver https证书
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–etcd-xxxfile：连接Etcd集群证书
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–audit-log-xxx：审计日志 &#39;</span>&gt;&gt; kube-apiserver.sh</span></span></code></pre></div></blockquote>
<hr>
<h3 id="启用tls-bootstrapping机制">启用<code>TLS Bootstrapping</code>机制</h3>
<ul>
<li>
<ol>
<li><code>TLS Bootstraping：Master apiserver</code>启用<code>TLS</code>认证后，<code>Node</code>节点<code>kubelet</code>和<code>kube-proxy</code>要与<code>kube-apiserver</code>进行通信，必须使用<code>CA</code>签发的有效证书才可以，当<code>Node</code>节点很多时，这种客户端证书颁发需要大量工作，同样也会增加集群扩展复杂度。为了简化流程，<code>Kubernetes</code>引入了<code>TLS bootstraping</code>机制来自动颁发客户端证书，<code>kubelet</code>会以一个低权限用户自动向<code>apiserver</code>申请证书，<code>kubelet</code>的证书由<code>apiserver</code>动态签署。所以强烈建议在<code>Node</code>上使用这种方式，目前主要用于<code>kubelet</code>，<code>kube-proxy</code>还是由我们统一颁发一个证书</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">cat &gt;/opt/kubernetes/cfg/token.csv&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$(head -c 16 /dev/urandom | od -An -t x | tr -d &#39;</span> <span style="color:#e6db74">&#39;),kubelet-bootstrap,10001,&#34;system:node-bootstrapper&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">###########################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 自行生成token
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># token=$(head -c 16 /dev/urandom | od -An -t x | tr -d &#39;</span> <span style="color:#e6db74">&#39;)  	# C语言执行生成方式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># token=`head -c 16 /dev/urandom | od -An -t x | tr -d &#39;</span> <span style="color:#e6db74">&#39;`  	# shell执行生成方式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># sed -i &#34;s/c47ffb939f5ca36231d9e3121a252940/${token}/g&#34;  /opt/kubernetes/cfg/token.csv
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># systemct管理apiserver、并设置开机自启
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">cat &gt;/usr/lib/systemd/system/kube-apiserver.service&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=Kubernetes API Server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Documentation=https://github.com/kubernetes/kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EnvironmentFile=/opt/kubernetes/cfg/kube-apiserver.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/kubernetes/bin/kube-apiserver \$KUBE_APISERVER_OPTS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#######################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ systemctl daemon-reload
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ systemctl enable kube-apiserver &amp;&amp; systemctl start kube-apiserver
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># kube-apiserver报错排查
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cat /var/log/messages|grep kube-apiserver|grep -i error  	# -i不区分大小写
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">journalctl -xe -u kube-apiserver | more  	# 命令排错 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 3.设置授权kubelet-bootstrap用户允许请求证书
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --user=kubelet-bootstrap &#39;</span> &gt;&gt;token-apiserver.sh</span></span></code></pre></div></blockquote>
<hr>
<h3 id="部署kube-controller-manager控制器">部署<code>kube-controller-manager</code>(控制器)</h3>
<ul>
<li>
<ol>
<li><code>Pod</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>1.1 <!-- raw HTML omitted -->最小部署单元<!-- raw HTML omitted --></li>
<li>1.2 <!-- raw HTML omitted -->一组容器的集合<!-- raw HTML omitted --></li>
<li>1.3 <!-- raw HTML omitted -->一个<code>Pod</code>中的容器共享网络命名空间<!-- raw HTML omitted --></li>
<li>1.4 <!-- raw HTML omitted --><code>Pod</code>是短暂的<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li>
<ol start="2">
<li><code>Controllers</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>2.1 <!-- raw HTML omitted --><code>Deployment：</code>无状态应用部署<!-- raw HTML omitted --></li>
<li>2.2 <!-- raw HTML omitted --><code>StatefulSet：</code>有状态应用部署<!-- raw HTML omitted --></li>
<li>2.3 <!-- raw HTML omitted --><code>DaemonSet：</code>确保所有的<code>Node</code>运行一个<code>Pod</code><!-- raw HTML omitted --></li>
<li>2.4 <!-- raw HTML omitted --><code>Job：</code>一次性任务<!-- raw HTML omitted --></li>
<li>2.5 <!-- raw HTML omitted --><code>Cronjob：</code>定时任务<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->更高级层级对象，部署和管理<code>Pod</code><!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="4">
<li><code>Service</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>4.1 <!-- raw HTML omitted -->防止<code>Pod</code>失联<!-- raw HTML omitted --></li>
<li>4.2 <!-- raw HTML omitted -->定义一组<code>Pod</code>的访问策略<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted --><code>Label：</code>标签，附加到某个资源上，用于关联对象，查询和筛选<!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="6">
<li><!-- raw HTML omitted --><code>Namespaces：</code>命名空间，将对象逻辑上隔离<!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="7">
<li><!-- raw HTML omitted --><code>Controller：</code>维持副本期望数目,<code>ReplicaSet</code>替代<code>ReplicationControlled</code><!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="8">
<li><!-- raw HTML omitted --><code>deployent：</code>管理<code>RS</code>，实现滚动更新<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>8.1 <!-- raw HTML omitted --><code>--kubeconfig：</code>连接<code>apiserver</code>配置文件<!-- raw HTML omitted --></li>
<li>8.2 <!-- raw HTML omitted --><code>--master：</code>通过本地非安全本地端口<code>8080</code>连接<code>apiserver</code><!-- raw HTML omitted --></li>
<li>8.3 <!-- raw HTML omitted --><code>--leader-elect：</code>当该组件启动多个时，自动选举<code>HA</code><!-- raw HTML omitted --></li>
<li>8.4 <!-- raw HTML omitted --><code>--cluster-signing-cert-file/--cluster-signing-key-file：</code>自动为<code>kubelet</code>颁发证书的<code>CA</code>，与<code>apiserver</code>保持一致<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 创建配置文件</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/kube-controller-manager.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">KUBE_CONTROLLER_MANAGER_OPTS=&#34;--logtostderr=false \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--v=2 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--log-dir=/opt/kubernetes/logs \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--leader-elect=true \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--kubeconfig=/opt/kubernetes/cfg/kube-controller-manager.kubeconfig \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--master=127.0.0.1:8080 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--bind-address=127.0.0.1 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--allocate-node-cidrs=true \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cluster-cidr=10.244.0.0/16 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--service-cluster-ip-range=10.0.0.0/24 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cluster-signing-cert-file=/opt/kubernetes/ssl/ca.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cluster-signing-key-file=/opt/kubernetes/ssl/ca-key.pem  \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--root-ca-file=/opt/kubernetes/ssl/ca.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--service-account-private-key-file=/opt/kubernetes/ssl/ca-key.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--experimental-cluster-signing-duration=87600h0m0s&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建kube-controller-manager-csr.json 证书请求文件，可以越过</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cat &gt;/opt/kubernetes/ssl/kube-controller-manager-csr.json&lt;&lt;-EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># {</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &#34;CN&#34;: &#34;system:kube-controller-manager&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &#34;hosts&#34;: [],</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &#34;key&#34;: {</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    &#34;algo&#34;: &#34;rsa&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    &#34;size&#34;: 2048</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  },</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &#34;names&#34;: [</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    {</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;C&#34;: &#34;CN&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;L&#34;: &#34;BeiJing&#34;, </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;ST&#34;: &#34;BeiJing&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;O&#34;: &#34;system:masters&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;OU&#34;: &#34;System&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    }</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  ]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># }</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成证书</span>
</span></span><span style="display:flex;"><span>$ cd /opt/kubernetes/ssl
</span></span><span style="display:flex;"><span>$ cfssl gencert -ca<span style="color:#f92672">=</span>ca.pem -ca-key<span style="color:#f92672">=</span>ca-key.pem -config<span style="color:#f92672">=</span>ca-config.json -profile<span style="color:#f92672">=</span>kubernetes kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="9">
<li><!-- raw HTML omitted -->生成<code>kubeconfig</code>文件（以下是<code>shell</code>命令，直接在终端执行）：可以越过<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># KUBE_CONFIG=&#34;/opt/kubernetes/cfg/kube-controller-manager.kubeconfig&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># KUBE_APISERVER=&#34;https://192.168.4.110:6443&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>$ kubectl config set-cluster kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#75715e">#  --certificate-authority=/opt/kubernetes/ssl/ca.pem \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --embed-certs=true \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --server=${KUBE_APISERVER} \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --kubeconfig=${KUBE_CONFIG}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config set-credentials kube-controller-manager <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#75715e">#  --client-certificate=./kube-controller-manager.pem \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --client-key=./kube-controller-manager-key.pem \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --embed-certs=true \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --kubeconfig=${KUBE_CONFIG}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config set-context default <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#75715e">#  --cluster=kubernetes \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --user=kube-controller-manager \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --kubeconfig=${KUBE_CONFIG}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config use-context default --kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="systemd管理controller-manager"><code>systemd</code>管理<code>controller-manager</code></h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted --><code>Controller manager</code>（默认端口：<code>10252</code>）监视<code>Kubernetes</code>集群，以检测和维护<code>Kubernetes</code>环境的几个方面，包括将<code>Pod</code>加入到服务中，保持一组<code>Pod</code>的正确数量，并对节点的丢失做出反应<!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="2">
<li><!-- raw HTML omitted --><code>Cloud controller manager</code>（默认端口：10258）一个用于基于云的部署的可选组件。云控制器与云服务提供商接口，以管理集群的负载均衡器和虚拟网络<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/usr/lib/systemd/system/kube-controller-manager.service<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=Kubernetes Controller Manager
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Documentation=https://github.com/kubernetes/kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EnvironmentFile=/opt/kubernetes/cfg/kube-controller-manager.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/kubernetes/bin/kube-controller-manager \$KUBE_CONTROLLER_MANAGER_OPTS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecReload=/bin/kill -HUP $MAINPID
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="启动并设置开机启动">启动并设置开机启动</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl daemon-reload
</span></span><span style="display:flex;"><span>$ systemctl enable kube-controller-manager <span style="color:#f92672">&amp;&amp;</span> systemctl start kube-controller-manager</span></span></code></pre></div></blockquote>
<hr>
<h3 id="部署kube-scheduler创建配置文件调度器负责集群资源调度组件抽离">部署<code>kube-scheduler</code>:创建配置文件(调度器负责集群资源调度,组件抽离)</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted --><code>Scheduler：</code>负责介绍任务，选择合适的节点进行分配任务<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>1.1 <!-- raw HTML omitted --><code>--kubeconfig</code>：连接<code>apiserver</code>配置文件<!-- raw HTML omitted --></li>
<li>1.2 <!-- raw HTML omitted --><code>--master</code>：通过本地非安全本地端口8080连接<code>apiserver</code><!-- raw HTML omitted --></li>
<li>1.3 <!-- raw HTML omitted --><code>--leader-elect</code>：当该组件启动多个时，自动选举(HA) <!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/kube-scheduler.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">KUBE_SCHEDULER_OPTS=&#34;--logtostderr=false \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--v=2 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--log-dir=/opt/kubernetes/logs \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--leader-elect \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#--kubeconfig=/opt/kubernetes/cfg/kube-scheduler.kubeconfig \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--master=127.0.0.1:8080 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--bind-address=127.0.0.1&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->创建<code>kube-scheduler-csr.json</code>证书请求文件：可以越过此步骤<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># cat &gt;/opt/kubernetes/ssl/kube-scheduler-csr.json&lt;&lt;-EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># {</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &#34;CN&#34;: &#34;system:kube-scheduler&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &#34;hosts&#34;: [],</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &#34;key&#34;: {</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    &#34;algo&#34;: &#34;rsa&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    &#34;size&#34;: 2048</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  },</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &#34;names&#34;: [</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    {</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;C&#34;: &#34;CN&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;L&#34;: &#34;BeiJing&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;ST&#34;: &#34;BeiJing&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;O&#34;: &#34;system:masters&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;OU&#34;: &#34;System&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    }</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  ]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># }</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成证书</span>
</span></span><span style="display:flex;"><span>$ cd /opt/kubernetes/ssl
</span></span><span style="display:flex;"><span>$ cfssl gencert -ca<span style="color:#f92672">=</span>ca.pem -ca-key<span style="color:#f92672">=</span>ca-key.pem -config<span style="color:#f92672">=</span>ca-config.json -profile<span style="color:#f92672">=</span>kubernetes kube-scheduler-csr.json | cfssljson -bare kube-scheduler</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->生成<code>kubeconfig</code>文件(以下是<code>shell</code>命令，直接在终端执行)：此步骤可以越过<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># KUBE_CONFIG=&#34;/opt/kubernetes/cfg/kube-scheduler.kubeconfig&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># KUBE_APISERVER=&#34;https://192.168.100.11:6443&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config set-cluster kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#75715e">#  --certificate-authority=/opt/kubernetes/ssl/ca.pem \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --embed-certs=true \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --server=${KUBE_APISERVER} \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --kubeconfig=${KUBE_CONFIG}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config set-credentials kube-scheduler <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#75715e">#  --client-certificate=./kube-scheduler.pem \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --client-key=./kube-scheduler-key.pem \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --embed-certs=true \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --kubeconfig=${KUBE_CONFIG}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config set-context default <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#75715e">#  --cluster=kubernetes \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --user=kube-scheduler \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --kubeconfig=${KUBE_CONFIG}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config use-context default --kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="systemd管理scheduler"><code>systemd</code>管理<code>scheduler</code></h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/usr/lib/systemd/system/kube-scheduler.service<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=Kubernetes Scheduler
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Documentation=https://github.com/kubernetes/kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EnvironmentFile=/opt/kubernetes/cfg/kube-scheduler.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/kubernetes/bin/kube-scheduler \$KUBE_SCHEDULER_OPTS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->设置开机自己并且启动服务器<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl daemon-reload
</span></span><span style="display:flex;"><span>$ systemctl enable kube-scheduler <span style="color:#f92672">&amp;&amp;</span> systemctl start kube-scheduler</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->生成<code>kubectl</code>连接集群的证书：<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/ssl/admin-csr.json<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;CN&#34;: &#34;admin&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;hosts&#34;: [],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;key&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;size&#34;: 2048
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">},
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;names&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;L&#34;: &#34;BeiJing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;ST&#34;: &#34;BeiJing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;O&#34;: &#34;system:masters&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;OU&#34;: &#34;System&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->生成证书<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /opt/kubernetes/ssl/
</span></span><span style="display:flex;"><span>$ cfssl gencert -ca<span style="color:#f92672">=</span>ca.pem -ca-key<span style="color:#f92672">=</span>ca-key.pem -config<span style="color:#f92672">=</span>ca-config.json -profile<span style="color:#f92672">=</span>kubernetes admin-csr.json | cfssljson -bare admin</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->生成<code>kubeconfig</code>文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir /root/.kube
</span></span><span style="display:flex;"><span>$ KUBE_CONFIG<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/root/.kube/config&#34;</span>
</span></span><span style="display:flex;"><span>$ KUBE_APISERVER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://192.168.4.110:6443&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config set-cluster kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--certificate-authority<span style="color:#f92672">=</span>/opt/kubernetes/ssl/ca.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--server<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_APISERVER<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>$ kubectl config set-credentials cluster-admin <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--client-certificate<span style="color:#f92672">=</span>./admin.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--client-key<span style="color:#f92672">=</span>./admin-key.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>$ kubectl config set-context default <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cluster<span style="color:#f92672">=</span>kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--user<span style="color:#f92672">=</span>cluster-admin <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>$ kubectl config use-context default --kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->通过<code>kubectl</code>工具查看当前集群组件状态<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl get cs
</span></span><span style="display:flex;"><span>NAME                 STATUS    MESSAGE             ERROR
</span></span><span style="display:flex;"><span>controller-manager   Healthy   ok                  
</span></span><span style="display:flex;"><span>scheduler            Healthy   ok                  
</span></span><span style="display:flex;"><span>etcd-0               Healthy   <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;health&#34;</span>:<span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">}</span>   
</span></span><span style="display:flex;"><span>etcd-1               Healthy   <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;health&#34;</span>:<span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">}</span>   
</span></span><span style="display:flex;"><span>etcd-2               Healthy   <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;health&#34;</span>:<span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">}</span> </span></span></code></pre></div></blockquote>
<hr>
<h3 id="在master操作部署worker-node">在<code>Master</code>操作部署<code>Worker Node</code></h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted --><code>Kubelet：</code>直接跟容器引擎交互实现容器的生命周期管理<!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="2">
<li><!-- raw HTML omitted --><code>Kube proxy：</code>负责写入规则至<code>iptables</code>、<code>ipvs</code>实现服务映射访问<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>2.1 <!-- raw HTML omitted --><code>--hostname-override</code>：显示名称，集群中唯一<!-- raw HTML omitted --></li>
<li>2.2 <!-- raw HTML omitted --><code>--network-plugin</code>：启用<code>CNI</code><!-- raw HTML omitted --></li>
<li>2.3 <!-- raw HTML omitted --><code>--kubeconfig</code>：空路径，会自动生成，后面用于连接<code>apiserver</code><!-- raw HTML omitted --></li>
<li>2.4 <!-- raw HTML omitted --><code>--bootstrap-kubeconfig</code>：首次启动向<code>apiserver</code>申请证书<!-- raw HTML omitted --></li>
<li>2.5 <!-- raw HTML omitted --><code>--config</code>：配置参数文件<!-- raw HTML omitted --></li>
<li>2.6 <!-- raw HTML omitted --><code>--cert-dir</code>：<code>kubelet</code>证书生成目录<!-- raw HTML omitted --></li>
<li>2.7 <!-- raw HTML omitted --><code>--pod-infra-container-image</code>：管理<code>Pod</code>网络容器的镜像<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /usr/local/src/kubernetes/server/bin/
</span></span><span style="display:flex;"><span>$ cp kubelet kube-proxy /opt/kubernetes/bin   <span style="color:#75715e"># 本地拷贝</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 部署bubelet</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/kubelet.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">KUBELET_OPTS=&#34;--logtostderr=false \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--v=2 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--log-dir=/opt/kubernetes/logs \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--hostname-override=k8s-master \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--network-plugin=cni \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--bootstrap-kubeconfig=/opt/kubernetes/cfg/bootstrap.kubeconfig \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--config=/opt/kubernetes/cfg/kubelet-config.yml \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cert-dir=/opt/kubernetes/ssl \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--pod-infra-container-image=lizhenliang/pause-amd64:3.0&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="配置参数文件">配置参数文件</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/kubelet-config.yml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: KubeletConfiguration
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: kubelet.config.k8s.io/v1beta1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">address: 0.0.0.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">port: 10250
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">readOnlyPort: 10255
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">cgroupDriver: cgroupfs
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">clusterDNS:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - 10.0.0.2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">clusterDomain: cluster.local 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">failSwapOn: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">authentication:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  anonymous:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    enabled: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  webhook:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    cacheTTL: 2m0s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  x509:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    clientCAFile: /opt/kubernetes/ssl/ca.pem 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">authorization:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  mode: Webhook
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  webhook:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    cacheAuthorizedTTL: 5m0s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    cacheUnauthorizedTTL: 30s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">evictionHard:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  imagefs.available: 15%
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  memory.available: 100Mi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  nodefs.available: 10%
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  nodefs.inodesFree: 5%
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">maxOpenFiles: 1000000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">maxPods: 110
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="在master节点执行以下命令生成kubelet初次加入集群引导bootstrapkubeconfig文件">在<code>master</code>节点执行以下命令，生成<code>kubelet</code>初次加入集群引导<code>bootstrap.kubeconfig</code>文件</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ KUBE_CONFIG<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/opt/kubernetes/cfg/bootstrap.kubeconfig&#34;</span>
</span></span><span style="display:flex;"><span>$ KUBE_APISERVER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://192.168.4.110:6443&#34;</span> <span style="color:#75715e"># apiserver IP:PORT</span>
</span></span><span style="display:flex;"><span>$ TOKEN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;bed185231bd89516f68ed5031946b9f9&#34;</span>  	<span style="color:#75715e"># 与token.csv里保持一致</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成 kubelet bootstrap kubeconfig 配置文件</span>
</span></span><span style="display:flex;"><span>$ kubectl config set-cluster kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--certificate-authority<span style="color:#f92672">=</span>/opt/kubernetes/ssl/ca.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--server<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_APISERVER<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>Cluster <span style="color:#e6db74">&#34;kubernetes&#34;</span> set.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config set-credentials <span style="color:#e6db74">&#34;kubelet-bootstrap&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--token<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>TOKEN<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>User <span style="color:#e6db74">&#34;kubelet-bootstrap&#34;</span> set.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config set-context default <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cluster<span style="color:#f92672">=</span>kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--user<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;kubelet-bootstrap&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>Context <span style="color:#e6db74">&#34;default&#34;</span> created.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config use-context default --kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>Switched to context <span style="color:#e6db74">&#34;default&#34;</span>.</span></span></code></pre></div></blockquote>
<hr>
<h3 id="system管理kubelet"><code>system</code>管理<code>kubelet</code></h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt; /usr/lib/systemd/system/kubelet.service <span style="color:#e6db74">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=Kubernetes Kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=docker.service
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EnvironmentFile=/opt/kubernetes/cfg/kubelet.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/kubernetes/bin/kubelet \$KUBELET_OPTS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LimitNOFILE=65536
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">####################################################################</span>
</span></span><span style="display:flex;"><span>$ systemctl daemon-reload
</span></span><span style="display:flex;"><span>$ systemctl enable kubelet systemctl start kubelet</span></span></code></pre></div></blockquote>
<hr>
<h3 id="批准kubelet证书申请并加入集群">批准<code>kubelet</code>证书申请并加入集群</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 查看kubelet证书请求</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get csr</span>
</span></span><span style="display:flex;"><span>NAME                                                   AGE     SIGNERNAME                                    REQUESTOR           CONDITION
</span></span><span style="display:flex;"><span>node-csr-Pbamt5FDLAwv0HlJpcgUP9B5c4ynIRe0Xa17zXq9I6E   4m16s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 批准申请</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl certificate approve node-csr-Pbamt5FDLAwv0HlJpcgUP9B5c4ynIRe0Xa17zXq9I6E</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>certificatesigningrequest.certificates.k8s.io/node-csr-Pbamt5FDLAwv0HlJpcgUP9B5c4ynIRe0Xa17zXq9I6E approved
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看节点,由于网络插件没有部署，节点状态 NotReady</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get node</span>
</span></span><span style="display:flex;"><span>NAME         STATUS     ROLES    AGE   VERSION
</span></span><span style="display:flex;"><span>k8s-master   NotReady   &lt;none&gt;   71s   v1.18.3</span></span></code></pre></div></blockquote>
<hr>
<h3 id="部署kube-proxy">部署<code>kube-proxy</code></h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 1. 创建配置kube-proxy文件</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/kube-proxy.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">KUBE_PROXY_OPTS=&#34;--logtostderr=false \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--v=2 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--log-dir=/opt/kubernetes/logs \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--config=/opt/kubernetes/cfg/kube-proxy-config.yml&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2. 配置参数文件</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/kube-proxy-config.yml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: KubeProxyConfiguration
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: kubeproxy.config.k8s.io/v1alpha1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">bindAddress: 0.0.0.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metricsBindAddress: 0.0.0.0:10249
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">clientConnection:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kubeconfig: /opt/kubernetes/cfg/kube-proxy.kubeconfig
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">hostnameOverride: k8s-master
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">clusterCIDR: 10.0.0.0/24
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3. 生成kube-proxy.kubeconfig文件：生成kube-proxy证书：</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/ssl/kube-proxy-csr.json<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;CN&#34;: &#34;system:kube-proxy&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;hosts&#34;: [],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;key&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;size&#34;: 2048
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">},
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;names&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;L&#34;: &#34;BeiJing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;ST&#34;: &#34;BeiJing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;O&#34;: &#34;k8s&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;OU&#34;: &#34;System&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 4.生成证书</span>
</span></span><span style="display:flex;"><span>$ cd /opt/kubernetes/ssl/
</span></span><span style="display:flex;"><span>$ cfssl gencert -ca<span style="color:#f92672">=</span>ca.pem -ca-key<span style="color:#f92672">=</span>ca-key.pem -config<span style="color:#f92672">=</span>ca-config.json -profile<span style="color:#f92672">=</span>kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 5. 生成kubeconfig文件</span>
</span></span><span style="display:flex;"><span>$ KUBE_CONFIG<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/opt/kubernetes/cfg/kube-proxy.kubeconfig&#34;</span>
</span></span><span style="display:flex;"><span>$ KUBE_APISERVER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://192.168.4.110:6443&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ssl<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl config set-cluster kubernetes \</span>
</span></span><span style="display:flex;"><span>--certificate-authority<span style="color:#f92672">=</span>/opt/kubernetes/ssl/ca.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--server<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_APISERVER<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>Cluster <span style="color:#e6db74">&#34;kubernetes&#34;</span> set.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ssl<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl config set-credentials kube-proxy \</span>
</span></span><span style="display:flex;"><span>--client-certificate<span style="color:#f92672">=</span>./kube-proxy.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--client-key<span style="color:#f92672">=</span>./kube-proxy-key.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>User <span style="color:#e6db74">&#34;kube-proxy&#34;</span> set.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ssl<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl config set-context default \</span>
</span></span><span style="display:flex;"><span>--cluster<span style="color:#f92672">=</span>kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--user<span style="color:#f92672">=</span>kube-proxy <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>Context <span style="color:#e6db74">&#34;default&#34;</span> created.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ssl<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl config use-context default --kubeconfig=${KUBE_CONFIG}</span>
</span></span><span style="display:flex;"><span>Switched to context <span style="color:#e6db74">&#34;default&#34;</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 6.system管理kube-proxy</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/usr/lib/systemd/system/kube-proxy.service<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=Kubernetes Proxy
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EnvironmentFile=/opt/kubernetes/cfg/kube-proxy.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/kubernetes/bin/kube-proxy \$KUBE_PROXY_OPTS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LimitNOFILE=65536
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">########################################################################</span>
</span></span><span style="display:flex;"><span>$ systemctl daemon-reload
</span></span><span style="display:flex;"><span>$ systemctl enable kube-proxy <span style="color:#f92672">&amp;&amp;</span> systemctl start kube-proxy</span></span></code></pre></div></blockquote>
<hr>
<h3 id="部署网络组件">部署网络组件</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted --><code>Calico</code>是一个纯三层的数据中心网络方案，是目前<code>Kubernetes</code>主流的网络方案。部署<code>Calico</code><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /usr/local/src/
</span></span><span style="display:flex;"><span>$ wget https://docs.projectcalico.org/v3.14/manifests/calico.yaml
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master src<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f calico.yaml  # 等Calico Pod都Running，节点也会准备就绪</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master src<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get node</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master src<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pod -n kube-system</span>
</span></span><span style="display:flex;"><span>NAME                                       READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>calico-kube-controllers-65f8bc95db-27zj8   1/1     Running   <span style="color:#ae81ff">0</span>          37m
</span></span><span style="display:flex;"><span>calico-node-skvcj                          1/1     Running   <span style="color:#ae81ff">0</span>          37m</span></span></code></pre></div></blockquote>
<hr>
<h4 id="部署cni网络">部署<code>CNI</code>网络</h4>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->先准备好<code>CNI</code>二进制文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -p /opt/cni/bin
</span></span><span style="display:flex;"><span>$ cd /usr/local/src/
</span></span><span style="display:flex;"><span>$ wget https://github.com/containernetworking/plugins/releases/download/v0.8.6/cni-plugins-linux-amd64-v0.8.6.tgz  	<span style="color:#75715e"># 下载二进制安装包</span>
</span></span><span style="display:flex;"><span>$ tar zxvf cni-plugins-linux-amd64-v0.8.6.tgz -C /opt/cni/bin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 部署CNI网络</span>
</span></span><span style="display:flex;"><span>$ cd /opt/kubernetes/cfg/
</span></span><span style="display:flex;"><span>$ wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</span></span><span style="display:flex;"><span>$ sed -i -r <span style="color:#e6db74">&#34;s#quay.io/coreos/flannel:.*-amd64#lizhenliang/flannel:v0.12.0-amd64#g&#34;</span> kube-flannel.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master cfg<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f kube-flannel.yml</span>
</span></span><span style="display:flex;"><span>podsecuritypolicy.policy/psp.flannel.unprivileged created
</span></span><span style="display:flex;"><span>clusterrole.rbac.authorization.k8s.io/flannel created
</span></span><span style="display:flex;"><span>clusterrolebinding.rbac.authorization.k8s.io/flannel created
</span></span><span style="display:flex;"><span>serviceaccount/flannel created
</span></span><span style="display:flex;"><span>configmap/kube-flannel-cfg created
</span></span><span style="display:flex;"><span>daemonset.apps/kube-flannel-ds created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master cfg<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n kube-system</span>
</span></span><span style="display:flex;"><span>NAME                    READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>kube-flannel-ds-xv7db   1/1     Running   <span style="color:#ae81ff">0</span>          58s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master cfg<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get node</span>
</span></span><span style="display:flex;"><span>NAME         STATUS   ROLES    AGE   VERSION
</span></span><span style="display:flex;"><span>k8s-master   Ready    &lt;none&gt;   23m   v1.18.3</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->授权<code>apiserver</code>访问<code>kubelet</code><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/apiserver-to-kubelet-rbac.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: ClusterRole
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">annotations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rbac.authorization.kubernetes.io/autoupdate: &#34;true&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kubernetes.io/bootstrapping: rbac-defaults
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name: system:kube-apiserver-to-kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rules:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - apiGroups:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    resources:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - nodes/proxy
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - nodes/stats
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - nodes/log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - nodes/spec
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - nodes/metrics
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - pods/log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    verbs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &#34;*&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: ClusterRoleBinding
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: system:kube-apiserver
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: &#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">roleRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  apiGroup: rbac.authorization.k8s.io
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  kind: ClusterRole
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: system:kube-apiserver-to-kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">subjects:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - apiGroup: rbac.authorization.k8s.io
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    kind: User
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##############################################################</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master cfg<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f apiserver-to-kubelet-rbac.yaml</span>
</span></span><span style="display:flex;"><span>clusterrole.rbac.authorization.k8s.io/system:kube-apiserver-to-kubelet created
</span></span><span style="display:flex;"><span>clusterrolebinding.rbac.authorization.k8s.io/system:kube-apiserver created</span></span></code></pre></div></blockquote>
<hr>
<h3 id="新增加worker-node拷贝已部署好的node相关文件到新节点">新增加<code>Worker Node:</code>拷贝已部署好的<code>Node</code>相关文件到新节点</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->在<code>master</code>节点将<code>Worker Node</code>涉及文件拷贝到其他几个新节点<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ~<span style="color:#f92672">]</span><span style="color:#75715e"># ansible node -i /etc/ansible/hosts -m copy -a &#34;src=../../../../opt/kubernetes dest=/opt/&#34; -f 5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ~<span style="color:#f92672">]</span><span style="color:#75715e"># ansible node -i /etc/ansible/hosts -m copy -a &#34;src=../../../../opt/cni  dest=/opt/&#34; -f 5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ~<span style="color:#f92672">]</span><span style="color:#75715e"># scp -r /usr/lib/systemd/system/{kubelet,kube-proxy}.service k8s-node-1:/usr/lib/systemd/system</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ~<span style="color:#f92672">]</span><span style="color:#75715e"># scp -r /usr/lib/systemd/system/{kubelet,kube-proxy}.service k8s-node-2:/usr/lib/systemd/system</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 这几个文件是证书申请审批后自动生成的，每个Node不同，必须删除其他几个节点删除kubelet证书和kubeconfig文件，重新生成</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-node-1 ~<span style="color:#f92672">]</span><span style="color:#75715e"># rm -rf /opt/kubernetes/cfg/kubelet.kubeconfig</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-node-2 ~<span style="color:#f92672">]</span><span style="color:#75715e"># rm -rf /opt/kubernetes/cfg/kubelet.kubeconfig </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-node-1 ~<span style="color:#f92672">]</span><span style="color:#75715e"># rm -f /opt/kubernetes/ssl/kubelet*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改主机名</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-node-1 ~<span style="color:#f92672">]</span><span style="color:#75715e"># sed -i &#34;s/k8s-master/k8s-node-1/g&#34; /opt/kubernetes/cfg/kubelet.conf</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-node-1 ~<span style="color:#f92672">]</span><span style="color:#75715e"># sed -i &#34;s/k8s-master/k8s-node-1/g&#34;  /opt/kubernetes/cfg/kube-proxy-config.yml </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-node-2 ~<span style="color:#f92672">]</span><span style="color:#75715e"># sed -i &#34;s/k8s-master/k8s-node-2/g&#34; /opt/kubernetes/cfg/kubelet.conf</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-node-2 ~<span style="color:#f92672">]</span><span style="color:#75715e"># sed -i &#34;s/k8s-master/k8s-node-2/g&#34;  /opt/kubernetes/cfg/kube-proxy-config.yml</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在其他几个几点给予可执行文件执行权限，</span>
</span></span><span style="display:flex;"><span>$ chmod +x /opt/cni/bin/*
</span></span><span style="display:flex;"><span>$ chmod +x /opt/etcd/bin/*
</span></span><span style="display:flex;"><span>$ chmod +x /opt/kubernetes/bin/*
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ systemctl daemon-reload
</span></span><span style="display:flex;"><span>$ systemctl enable kubelet <span style="color:#f92672">&amp;&amp;</span> systemctl start kubelet
</span></span><span style="display:flex;"><span>$ systemctl enable kube-proxy <span style="color:#f92672">&amp;&amp;</span> systemctl start kube-proxy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在Master操作批准Node kubelet证书申请</span>
</span></span><span style="display:flex;"><span>$ kubectl get csr
</span></span><span style="display:flex;"><span>NAME                                                   AGE     SIGNERNAME                                    REQUESTOR           CONDITION
</span></span><span style="display:flex;"><span>node-csr-4vSZMnrv8OUR-zfD7dQYcDdi1L84Tv_nkNHlS8Iltfk   2m46s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending
</span></span><span style="display:flex;"><span>node-csr-KRMLTPJj4yvk5Cb6s0n5T4HtFPYJ152PpDjYHLM3Ass   10s     kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending
</span></span><span style="display:flex;"><span>node-csr-Pbamt5FDLAwv0HlJpcgUP9B5c4ynIRe0Xa17zXq9I6E   71m     kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Approved,Issued
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl certificate approve node-csr-KRMLTPJj4yvk5Cb6s0n5T4HtFPYJ152PpDjYHLM3Ass
</span></span><span style="display:flex;"><span>$ kubectl certificate approve node-csr-4vSZMnrv8OUR-zfD7dQYcDdi1L84Tv_nkNHlS8Iltfk
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># STATUS 都是Ready</span>
</span></span><span style="display:flex;"><span>$ kubectl get node
</span></span><span style="display:flex;"><span>NAME         STATUS   ROLES    AGE     VERSION
</span></span><span style="display:flex;"><span>k8s-master   Ready    &lt;none&gt;   70m     v1.18.3
</span></span><span style="display:flex;"><span>k8s-node-1   Ready    &lt;none&gt;   3m21s   v1.18.3
</span></span><span style="display:flex;"><span>k8s-node-2   Ready    &lt;none&gt;   3m2s    v1.18.3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># STATUS 都是Runing</span>
</span></span><span style="display:flex;"><span>$ kubectl get pod -n kube-system
</span></span><span style="display:flex;"><span>NAME                                       READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>calico-kube-controllers-65f8bc95db-27zj8   1/1     Running   <span style="color:#ae81ff">0</span>          65m
</span></span><span style="display:flex;"><span>calico-node-skvcj                          1/1     Running   <span style="color:#ae81ff">0</span>          65m
</span></span><span style="display:flex;"><span>calico-node-wc72m                          1/1     Running   <span style="color:#ae81ff">0</span>          2m22s
</span></span><span style="display:flex;"><span>calico-node-z5kmp                          1/1     Running   <span style="color:#ae81ff">0</span>          2m2s</span></span></code></pre></div></blockquote>
<hr>
<h4 id="创建local的storage-class">创建<code>local</code>的<code>Storage Class</code></h4>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -p /opt/data
</span></span><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/storage-class.yml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: StorageClass
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: storage.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name: local-storage
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">provisioner: kubernetes.io/no-provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">volumeBindingMode: WaitForFirstConsumer
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 执行命令创建</span>
</span></span><span style="display:flex;"><span>$ kubectl create -f storage-class.yml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看一下创建的storage class</span>
</span></span><span style="display:flex;"><span>$ kubectl get sc</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->创建<code>PV</code><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/pv-sdc.yml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: PersistentVolume
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name: local-pv-sdc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">capacity:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">storage: 30Gi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">accessModes:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - ReadWriteOnce
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  persistentVolumeReclaimPolicy: Retain
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  storageClassName: local-storage
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  local:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    path: /opt/data
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  nodeAffinity:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    required:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      nodeSelectorTerms:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - matchExpressions:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - key: kubernetes.io/hostname
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          operator: In
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          values:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          - cka
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 执行创建命令</span>
</span></span><span style="display:flex;"><span>$ kubectl create -f pv-sdc.yml
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master cfg<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pv</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->创建<code>PVC</code><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/pvc1.yml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: PersistentVolumeClaim
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name: pvc1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">accessModes:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - ReadWriteOnce
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  storageClassName: local-storage
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  resources:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    requests:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      storage: 10Gi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>$ kubectl create -f pvc1.yml</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted --><code>PVC</code>将会一直处于<code>Pending</code>状态直到我们创建一个<code>Pod</code>使用它<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master cfg<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pvc</span>
</span></span><span style="display:flex;"><span>NAME      STATUS    VOLUME    CAPACITY   ACCESS MODES   STORAGECLASS    AGE
</span></span><span style="display:flex;"><span>pvc1      Pending                                       local-storage   5s</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

        </div>
      </main>
    </div>
    <script src="../../../../js/clipboard.min.js?1722425299" defer></script>
    <script src="../../../../js/perfect-scrollbar.min.js?1722425299" defer></script>
    <script src="../../../../js/d3/d3-color.min.js?1722425299" defer></script>
    <script src="../../../../js/d3/d3-dispatch.min.js?1722425299" defer></script>
    <script src="../../../../js/d3/d3-drag.min.js?1722425299" defer></script>
    <script src="../../../../js/d3/d3-ease.min.js?1722425299" defer></script>
    <script src="../../../../js/d3/d3-interpolate.min.js?1722425299" defer></script>
    <script src="../../../../js/d3/d3-selection.min.js?1722425299" defer></script>
    <script src="../../../../js/d3/d3-timer.min.js?1722425299" defer></script>
    <script src="../../../../js/d3/d3-transition.min.js?1722425299" defer></script>
    <script src="../../../../js/d3/d3-zoom.min.js?1722425299" defer></script>
    <script src="../../../../js/js-yaml.min.js?1722425299" defer></script>
    <script src="../../../../js/mermaid.min.js?1722425299" defer></script>
    <script>
      window.themeUseMermaid = JSON.parse("{ \"securityLevel\": \"loose\" }");
    </script>
    <script src="../../../../js/theme.js?1722425299" defer></script>
  </body>
</html>
