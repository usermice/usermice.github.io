<!DOCTYPE html>
<html lang="en" dir="ltr" itemscope itemtype="http://schema.org/Article">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.125.4">
    <meta name="generator" content="Relearn 6.0.0+tip">
    <meta name="robots" content="noindex, nofollow, noarchive, noimageindex">
    <meta name="description" content="">
    <meta name="author" content="二哥">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://erge.blog/images/s2-1.png">
    <meta name="twitter:title" content="Kubernetes :: Hugo Relearn Theme">
    <meta property="og:url" content="https://erge.blog/systems/linux/kubernetes/">
    <meta property="og:site_name" content="Hugo Relearn Theme">
    <meta property="og:title" content="Kubernetes :: Hugo Relearn Theme">
    <meta property="og:locale" content="en">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://erge.blog/images/s2-1.png">
    <meta itemprop="name" content="Kubernetes :: Hugo Relearn Theme">
    <meta itemprop="datePublished" content="2024-06-13T00:31:03+08:00">
    <meta itemprop="dateModified" content="2024-06-13T00:31:03+08:00">
    <meta itemprop="image" content="https://erge.blog/images/s2-1.png">
    <title>Kubernetes :: Hugo Relearn Theme</title>
    <link href="../../../images/favicon.ico?1722425298" rel="icon" type="image/x-icon" sizes="any">
    <link href="../../../css/fontawesome-all.min.css?1722425299" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="../../../css/fontawesome-all.min.css?1722425299" rel="stylesheet"></noscript>
    <link href="../../../css/nucleus.css?1722425299" rel="stylesheet">
    <link href="../../../css/auto-complete.css?1722425299" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="../../../css/auto-complete.css?1722425299" rel="stylesheet"></noscript>
    <link href="../../../css/perfect-scrollbar.min.css?1722425299" rel="stylesheet">
    <link href="../../../css/fonts.css?1722425299" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="../../../css/fonts.css?1722425299" rel="stylesheet"></noscript>
    <link href="../../../css/theme.css?1722425299" rel="stylesheet">
    <link href="../../../css/theme-relearn-auto.css?1722425299" rel="stylesheet" id="R-variant-style">
    <link href="../../../css/chroma-relearn-auto.css?1722425299" rel="stylesheet" id="R-variant-chroma-style">
    <link href="../../../css/variant.css?1722425299" rel="stylesheet">
    <link href="../../../css/print.css?1722425299" rel="stylesheet" media="print">
    <link href="../../../css/format-print.css?1722425299" rel="stylesheet">
    <script src="../../../js/variant.js?1722425299"></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.relBasePath='..\/..\/..';
      window.relearn.relBaseUri='..\/..\/..';
      window.relearn.absBaseUri='https:\/\/erge.blog';
      window.index_js_url="../../../index.search.js";
      // variant stuff
      window.variants && variants.init( [ 'relearn-auto', 'relearn-light', 'relearn-dark', 'relearn-bright', 'zen-auto', 'zen-light', 'zen-dark', 'retro-auto', 'neon', 'learn', 'blue', 'green', 'red', 'my-branding' ] );
      // translations
      window.T_Copy_to_clipboard = `Copy to clipboard`;
      window.T_Copied_to_clipboard = `Copied to clipboard!`;
      window.T_Copy_link_to_clipboard = `Copy link to clipboard`;
      window.T_Link_copied_to_clipboard = `Copied link to clipboard!`;
      window.T_Reset_view = `Reset view`;
      window.T_View_reset = `View reset!`;
      window.T_No_results_found = `No results found for "{0}"`;
      window.T_N_results_found = `{1} results found for "{0}"`;
    </script>Partial intended to be overwritten to add custom headers, like CSS or any other info
<style>
    
</style>


  </head>
  <body class="mobile-support print disableInlineCopyToClipboard" data-url="../../../systems/linux/kubernetes/">
    <div id="R-body" class="default-animation">
      <div id="R-body-overlay"></div>
      <nav id="R-topbar">
        <div class="topbar-wrapper">
          <div class="topbar-sidebar-divider"></div>
          <div class="topbar-area topbar-area-start" data-area="start">
            <div class="topbar-button topbar-button-sidebar" data-content-empty="show" data-width-s="show" data-width-m="show" data-width-l="show"><button class="topbar-control" onclick="toggleNav()" type="button" title="Menu (CTRL&#43;ALT&#43;n)"><i class="fa-fw fas fa-bars"></i></button>
            </div>



          </div>
          <ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype="http://schema.org/BreadcrumbList"><li
            itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><a itemprop="item" href="../../../systems/"><span itemprop="name">Systems</span></a><meta itemprop="position" content="1">&nbsp;>&nbsp;</li><li
            itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><a itemprop="item" href="../../../systems/linux/"><span itemprop="name">Linux</span></a><meta itemprop="position" content="2">&nbsp;>&nbsp;</li><li
            itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><span itemprop="name">Kubernetes</span><meta itemprop="position" content="3"></li>
          </ol>
          <div class="topbar-area topbar-area-end" data-area="end">


            <div class="topbar-button topbar-button-prev" data-content-empty="show" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="../../../systems/linux/keepalived/install_keepalived/" title="Install_Keepalived (🡐)"><i class="fa-fw fas fa-chevron-left"></i></a>
            </div>

            <div class="topbar-button topbar-button-next" data-content-empty="show" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="../../../systems/linux/kubernetes/kubernetes_template/" title="Kubernetes_Template (🡒)"><i class="fa-fw fas fa-chevron-right"></i></a>
            </div>



          </div>
        </div>
      </nav>
      <div id="R-main-overlay"></div>
      <main id="R-body-inner" class="highlightable default" tabindex="-1">
        <div class="flex-block-wrapper">
          <article class="default">
            <header class="headline">
            </header>

<h1 id="kubernetes">Kubernetes</h1>


            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Kubernetes</h1>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="kubernetes_template">Kubernetes_Template</h1>

<h1 id="资源控制器">资源控制器</h1>
<blockquote>

<pre class="mermaid align-center zoomable">graph LR
A[思维导图] --&gt;B[1.前言]
A[思维导图] --&gt;C[2.Namespace]
A[思维导图] --&gt;D[3.Deployment]
A[思维导图] --&gt;E[4.StatefulSet]
A[思维导图] --&gt;F[5.DaemonSet]
A[思维导图] --&gt;G[6.HorizontalPodAutoscaler]
A[思维导图] --&gt;H[7.EndPoint]
A[思维导图] --&gt;I[8.Service]
A[思维导图] --&gt;J[9.Label标签/Selector选择器]
C[2.Namespace] --&gt;|a=1|C1[2.1概述]
C[2.Namespace] --&gt;|a=2|C2[2.2应用示例]
D[3.Deployment] --&gt;|a=1|D1[3.1概述]
D[3.Deployment] --&gt;|a=2|D2[3.2语法以及应用示例]
E[4.StatefulSet] --&gt;|a=1|E1[4.1概述]
E[4.StatefulSet] --&gt;|a=2|E2[4.2语法以及应用示例]
F[5.DaemonSet] --&gt;|a=1|F1[5.1概述]
F[5.DaemonSet] --&gt;|a=2|F2[5.2语法以及应用示例]
G[6.HorizontalPodAutoscaler] --&gt;|a=1|G1[6.1概述]
G[6.HorizontalPodAutoscaler] --&gt;|a=2|G2[6.2语法以及应用]
H[7.EndPoint] --&gt;|a=1|H1[7.1概述]
H[7.EndPoint] --&gt;|a=2|H2[7.2语法以及应用]
I[8.Service] --&gt;|a=1|I1[8.1概述]
I[8.Service] --&gt;|a=2|I2[8.2语法以及应用]
J[9.Label标签/Selector选择器] --&gt;|a=1|J1[9.1概述]
J[9.Label标签/Selector选择器] --&gt;|a=2|J2[9.2语法以及应用]

Z[横向流程图]</pre>
<pre class="mermaid align-center zoomable">graph TD
A[Deployment] --&gt; D[ReplicaSet]
B[CronJob] --&gt; E[Job]
C[DaemonSet] --&gt; G{{容器}}
D[ReplicaSet] --&gt; G{{容器}}
E[Job] --&gt; G{{容器}}
F[StatefulSet] --&gt; G{{容器}}

G{{容器}} --&gt; J[/Volume\]
G{{容器}} --&gt; H(Service服务)

J[/Volume\] --&gt; K[/configMap\]
J[/Volume\] --&gt; L[/PVC\]
J[/Volume\] --&gt; M[/Secret\]

Z[Kubernetes控制流程]</pre><ul>
<li><!-- raw HTML omitted -->标签选择器<!-- raw HTML omitted --></li>
</ul>

<pre class="mermaid align-center zoomable">graph LR
A[Deployment&lt;br&gt;seletor:env=dev] -.- C[Label&lt;br&gt;]  
B{Service&lt;br&gt;seletor:env=dev} --- C[Label&lt;br&gt;]
C[Label&lt;br&gt;] --- C1((Pod&lt;br&gt;labe:env=dev))
C[Label&lt;br&gt;] --- C2((Pod&lt;br&gt;labe:env=dev))
C[Label&lt;br&gt;] --- C3((Pod&lt;br&gt;labe:env=dev))
    Z[Service]</pre>
<pre class="mermaid align-center zoomable">graph TD

A[user containerN&lt;br&gt;user ImageN&lt;br&gt;user container1&lt;br&gt;user Image1&lt;br&gt;Pause&lt;br&gt;gcr.io/google_containers/pause-amd64&lt;br&gt;] 
    Z[Pod]</pre></blockquote>
<hr>
<h2 id="资源名称">资源名称</h2>
<blockquote>
<ul>
<li>
<ol>
<li><code>kubectl api-resources -o wide</code><!-- raw HTML omitted -->：获取参数定义命令<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<table>
<thead>
<tr>
<th><code>Name</code>(名称)</th>
<th><code>ShortNames</code>(简写)</th>
<th><code>apiVersion</code>(<code>API</code>版本)</th>
<th><code>NameSpaced</code>(命名空间)</th>
<th>kind(类型)</th>
<th>Verbs(可执行操作命令)</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>configmaps</code></td>
<td>cm</td>
<td>v1</td>
<td>true</td>
<td>ConfigMap</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>events</td>
<td>ev</td>
<td>v1</td>
<td>true</td>
<td>Event</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td><code>limitranges</code></td>
<td>limits</td>
<td>v1</td>
<td>true</td>
<td>LimitRange</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>pods</td>
<td>po</td>
<td>v1</td>
<td>true</td>
<td>Pod</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>serviceaccounts</td>
<td>sa</td>
<td>v1</td>
<td>true</td>
<td>ServiceAccount</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>services</td>
<td>svc</td>
<td>v1</td>
<td>true</td>
<td>Service</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>daemonsets</td>
<td>ds</td>
<td>apps/v1</td>
<td>true</td>
<td>DaemonSet</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>deployments</td>
<td>deploy</td>
<td>apps/v1</td>
<td>true</td>
<td>Deployment</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>replicasets</td>
<td>rs</td>
<td>apps/v1</td>
<td>true</td>
<td>ReplicaSet</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>statefulsets</td>
<td>sts</td>
<td>apps/v1</td>
<td>true</td>
<td>StatefulSet</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>horizontalpodautoscalers</td>
<td>hpa</td>
<td>autoscaling/v2</td>
<td>true</td>
<td>HorizontalPodAutoscaler</td>
<td>create,delete,deletecollection,get,list,patch,update,watch   all</td>
</tr>
<tr>
<td>cronjobs</td>
<td>cj</td>
<td>batch/v1</td>
<td>true</td>
<td>CronJob</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>jobs</td>
<td></td>
<td>batch/v1</td>
<td>true</td>
<td>Job</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>events</td>
<td>ev</td>
<td>events.k8s.io/v1</td>
<td>true</td>
<td>Event</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>ingresses</td>
<td>ing</td>
<td>networking.k8s.io/v1</td>
<td>true</td>
<td>Ingress</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>networkpolicies</td>
<td>netpol</td>
<td>networking.k8s.io/v1</td>
<td>true</td>
<td>NetworkPolicy</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>poddisruptionbudgets</td>
<td>pdb</td>
<td>policy/v1</td>
<td>true</td>
<td>PodDisruptionBudget</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
</tbody>
</table>
<ul>
<li><!-- raw HTML omitted -->资源控制器作用<!-- raw HTML omitted --></li>
</ul>
<table>
<thead>
<tr>
<th>资源分类</th>
<th>资源名称</th>
<th>缩写</th>
<th>资源作用</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Pod</code>资源控制器</td>
<td><code>replicasets</code></td>
<td><code>rs</code></td>
<td>保证指定数量的<code>Pod</code>运行，并支持<code>Pod</code>数量变更，镜像版本变更</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>deployments</code></td>
<td><code>deploy</code></td>
<td>通过控制<code>ReplicaSet</code>来控制<code>Pod</code>，并支持滚动升级、版本回退</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>daemonsets</code></td>
<td><code>ds</code></td>
<td>在集群中的指定<code>Node</code>上都运行一个副本，一般用于日志采集、监控、守护进程类的任务。</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>jobs</code></td>
<td>&mdash;</td>
<td>它创建出来的<code>Pod</code>只要完成任务就立即退出，用于执行一次性任务</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>cronjobs</code></td>
<td><code>cj</code></td>
<td>它创建的Pod会周期性的执行，用于执行周期性的任务</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>horizontalpodautoscalers</code></td>
<td><code>hpa</code></td>
<td>可以根据集群负载自动调整<code>Pod</code>的数量，实现削峰填谷</td>
</tr>
<tr>
<td><code>Pod</code>资源控制器</td>
<td><code>statefulsets</code></td>
<td><code>sts</code></td>
<td>管理有状态的应用。</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h2 id="资源控制器字段类型作用">资源控制器字段类型作用</h2>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>explain</code><!-- raw HTML omitted -->选项获取字段使用方式<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl explain deployment.metadata  	<span style="color:#75715e"># 获取 deployment的metadata使用方式， 还可以获取：spec、kind</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl explain deployment.spec.selector  <span style="color:#75715e"># 获取yaml基础格式命令 </span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->资源控制器<!-- raw HTML omitted --><!-- raw HTML omitted -->必选字段<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>参数名</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>version</code></td>
<td><code>String</code></td>
<td><code>Kubernetes API </code>的版本，可以用<code>kubectl api-versions</code>命令查询</td>
</tr>
<tr>
<td><code>kind</code></td>
<td><code>String</code></td>
<td>标明<code>YAML</code>定义的资源类型和角色，如<code>Pod</code>、<code>Deployment</code>等</td>
</tr>
<tr>
<td><code>metadata</code></td>
<td><code>String</code></td>
<td>元数据对象</td>
</tr>
<tr>
<td><code>metadata.name</code></td>
<td><code>String</code></td>
<td>元数据对象的名字，可自定义，比如命名<code>Pod</code>的名字</td>
</tr>
<tr>
<td><code>spec</code></td>
<td><code>Object</code></td>
<td>详细定义对象</td>
</tr>
<tr>
<td><code>spec.containers[]</code></td>
<td><code>List</code></td>
<td>容器列表定义</td>
</tr>
<tr>
<td><code>spec.containers[].name</code></td>
<td><code>String</code></td>
<td>定义容器的名字</td>
</tr>
<tr>
<td><code>spec.containers[].image</code></td>
<td><code>String</code></td>
<td>定义容器使用的镜像</td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>
<ol start="2">
<li><code>metadata</code><!-- raw HTML omitted -->字段选择<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>metadata.name</code></td>
<td></td>
<td><code>Pod</code>名称</td>
</tr>
<tr>
<td><code>metadata.uid</code></td>
<td></td>
<td><code>Pod</code>的<code>UID</code></td>
</tr>
<tr>
<td><code>metadata.namespace</code></td>
<td></td>
<td><code>Pod</code>名字空间</td>
</tr>
<tr>
<td><code>metadata.labels['&lt;KEY&gt;']</code></td>
<td></td>
<td><code>Pod</code>标签 <code>&lt;KEY&gt;</code> 的值 (例如<code>metadata.labels['mylabel']</code>）</td>
</tr>
<tr>
<td><code>metadata.annotations['&lt;KEY&gt;']</code></td>
<td></td>
<td><code>Pod</code>的注解 <code>&lt;KEY&gt;</code> 的值（例如, <code>metadata.annotations['myannotation']</code>）</td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>
<ol start="3">
<li><code>spec.containers</code><!-- raw HTML omitted -->字段定义<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>spec.containers[].name</td>
<td>String</td>
<td>定义容器的名字。</td>
</tr>
<tr>
<td>spec.containers[].image</td>
<td>String</td>
<td>定义容器使用的镜像。</td>
</tr>
<tr>
<td>spec.containers[].imagePullSecrets</td>
<td></td>
<td>要从私有仓库拉取镜像，<code>Kubernetes</code>需要凭证。 配置文件中的 <code>imagePullSecrets</code>字段表明<code>Kubernetes</code>应该通过名为 <code>regcred</code> 的 Secret 获取凭证</td>
</tr>
<tr>
<td>spec.containers[].imagePullPolicy</td>
<td>S</td>
<td>定镜像拉取有3个值可选:<!-- raw HTML omitted --> <!-- raw HTML omitted --><code>Always</code><!-- raw HTML omitted -->：总是从远程仓库拉取镜像、<!-- raw HTML omitted --><!-- raw HTML omitted --><code>IfNotPresent</code><!-- raw HTML omitted -->：本地有则使用本地镜像，本地没有则从远程仓库拉取镜像。如上面 3个值都没设置，默认是<code>Always</code><!-- raw HTML omitted --><!-- raw HTML omitted --><code>Never</code><!-- raw HTML omitted -->：仅使用本地镜像，本地没有就报错</td>
</tr>
<tr>
<td>spec.containers[].command[]</td>
<td>List</td>
<td>指定容器启动命令，因为是数组形式，所以可以指定多个启动命令，不指定则使用镜像打包时的启动命令。</td>
</tr>
<tr>
<td>spec.containers[].args[]</td>
<td>List</td>
<td>指定容器启动命令参数，因为是数组形式，所以可以指定多个参数。</td>
</tr>
</tbody>
</table>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spec</span>:   	<span style="color:#75715e"># 必选，Pod中容器的详细定义</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">imagePullSecrets</span>:  	<span style="color:#75715e"># 配置登录 docker registry 的 secret 仓库</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">docker-harbor  	# 指定使用的secret库房名称</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:   	<span style="color:#75715e"># 必选，Pod中容器列表，一个Pod中可以定义多个容器</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">tomcat-demo   	# 指定容器名称，不可更新</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">192.168.80.210</span>:<span style="color:#ae81ff">8080</span><span style="color:#ae81ff">/test/tomcat-demo:v1 </span> <span style="color:#75715e"># 镜像仓库地址</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">Always   	# 容器下载策略：Always|Never|IfNotPresent，不管本地存不存在，都从仓库拉取镜像</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: [<span style="color:#ae81ff">string]   	# 容器的启动命令列表，替代docker的ENTRYPOINT指令、如不指定，使用打包时使用的启动命令</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">args</span>:   	<span style="color:#75715e"># 容器的启动命令参数列表、替代docker的CMD指令</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">/bin/sh</span>
</span></span><span style="display:flex;"><span>    - -<span style="color:#ae81ff">c</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">touch /tmp/healthy; sleep 30; rm -fr /tmp/healthy; sleep 600</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><code>spec.containers.volumeMounts</code><!-- raw HTML omitted -->容器工作目录定义<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>spec.containers[].workingDir</td>
<td>String</td>
<td>指定容器的工作目录</td>
</tr>
<tr>
<td>spec.containers[].volumeMounts[]</td>
<td>List</td>
<td>指定容器内部的存储卷配置</td>
</tr>
<tr>
<td>spec.containers[].volumeMounts[].name</td>
<td>String</td>
<td>指定可以被容器挂载的存储卷的名称</td>
</tr>
<tr>
<td>spec.containers[].volumeMounts[].mountPath</td>
<td>String</td>
<td>指定可以被容器挂载的存储卷的路径。</td>
</tr>
<tr>
<td>spec.containers[].volumeMountsf].readOnly</td>
<td>String</td>
<td>设置存储卷路径的读写模式，true 或者 false，默认为读写模式。</td>
</tr>
</tbody>
</table>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spec</span>:   	<span style="color:#75715e"># 必选，Pod中容器的详细定义</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">containers</span>:   	<span style="color:#75715e"># 必选，Pod中容器列表</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">workingDir</span>: <span style="color:#ae81ff">string   	# 容器的工作目录、不指定则使用镜像默认值</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumeMounts</span>:   	<span style="color:#75715e"># 挂载到容器内部的存储卷配置</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">data   	# 引用pod定义的共享存储卷的名称，需用volumes[]部分定义的的卷名</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/opt/data   	# 存储卷在容器内mount的绝对路径，应少于512字符</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">readOnly</span>: <span style="color:#ae81ff">boolean   	# 是否为只读模式</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><code>spec.containers.ports</code><!-- raw HTML omitted -->容器端口定义<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl explain deployment.spec.containers.ports  	<span style="color:#75715e"># 获取端口使用方式</span></span></span></code></pre></div><table>
<thead>
<tr>
<th>参数名称</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>spec.containers[].ports[]</td>
<td>List</td>
<td>指定容器需要用到的端口列表。</td>
</tr>
<tr>
<td>spec.containers[].ports[].name</td>
<td>String</td>
<td>指定端口名称。</td>
</tr>
<tr>
<td>spec.containers[].ports[].containerPort</td>
<td>String</td>
<td>指定容器需要监听的端口号。</td>
</tr>
<tr>
<td>spec.containers[].ports[].hostPort</td>
<td>String</td>
<td>指定容器所在主机需要监听的端口号，默认和 spec.containers[].ports[].containerPort 相同。注意，设置了则同一台主机无法启动该容器的相同副本（主机的端口号不能相同，若相同，会引发冲突）。</td>
</tr>
<tr>
<td>spec.containers[].ports[].protocol</td>
<td>String</td>
<td>指定端口协议，支持 TCP 和 UDP，默认值为 TCP 。</td>
</tr>
</tbody>
</table>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spec</span>:  	<span style="color:#75715e"># 必选，Pod中容器的详细定义</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">containers</span>:  	<span style="color:#75715e"># 必选，Pod中容器列表</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:  	<span style="color:#75715e"># 容器暴露的端口</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http  	# 服务名称、该名称可以在service种被引用</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>  	<span style="color:#75715e"># 容器需要监听的端口号</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">hostPort</span>: <span style="color:#ae81ff">int  	# 容器所在主机需要监听的端口号，默认与Container相同</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP  	# 端口协议，支持TCP和UDP，默认TCP</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>  	<span style="color:#75715e"># 集群端口</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">80</span>  	<span style="color:#75715e"># Pod端口</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nodePort</span>: <span style="color:#ae81ff">30080</span>  	<span style="color:#75715e"># 节点对外端口</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="6">
<li><code>spec.containers.env</code><!-- raw HTML omitted -->容器变量定义<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>spec.containers[].env[]</td>
<td>List</td>
<td>指定容器运行前需要设置的环境变量列表。</td>
</tr>
<tr>
<td>spec.containers[].env[].name</td>
<td>String</td>
<td>指定环境变量名称。</td>
</tr>
<tr>
<td>spec.containers[].env[].value</td>
<td>String</td>
<td>指定环境变量值。</td>
</tr>
</tbody>
</table>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spec</span>:   	<span style="color:#75715e"># 必选，Pod中容器的详细定义</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">containers</span>:   	<span style="color:#75715e"># 必选，Pod中容器列表</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">env</span>:   	<span style="color:#75715e"># 容器运行前需设置的环境变量列表</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">JAVA_OPTS   	# 环境变量名称</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;-Xmx1g&#34;</span>   	<span style="color:#75715e"># 定义使用内存、环境变量的值</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="7">
<li><code>spec.containers.resources</code><!-- raw HTML omitted -->容器资源限制<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>spec.containers[].resources</td>
<td>Object</td>
<td>指定资源限制和资源请求的值（这里开始就是设置容器的资源上限）。</td>
</tr>
<tr>
<td>spec.containers[].resources.limits</td>
<td>Object</td>
<td>指定设置容器运行时资源的运行上限。</td>
</tr>
<tr>
<td>spec.containers[].resources.limits.cpu</td>
<td>String</td>
<td>指定<code>CPU</code>的限制，单位为<code>core</code>，是用于运行 <code>docker run --cpu-shares</code>命令的参数。</td>
</tr>
<tr>
<td>spec.containers[].resources.limits.memory</td>
<td>String</td>
<td>指定内存的限制，单位为 MiB 或 GiB。</td>
</tr>
<tr>
<td>spec.containers[].resources.requests</td>
<td>Object</td>
<td>指定容器启动和调度时的限制。</td>
</tr>
<tr>
<td>spec.containers[].resources.requests.cpu</td>
<td>String</td>
<td>CPU 请求，单位为 core，容器启动时初始化可用数量。</td>
</tr>
<tr>
<td>spec.containers[].resources.requests.memory</td>
<td>String</td>
<td>内存请求，单位为 MiB 或 GiB，容器启动的初始化可用数量。</td>
</tr>
</tbody>
</table>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># 设定默认request和limit</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Namespace</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">name</span>: <span style="color:#ae81ff">apps</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">LimitRange</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">name</span>: <span style="color:#ae81ff">limit-resource  	# 在一个名称空间不能重复</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default  	# 指定名称空间，默认defalut</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">labels</span>:      <span style="color:#ae81ff">&lt;map[string]string&gt;  	# 标签</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">annotations</span>: <span style="color:#ae81ff">&lt;map[string]string&gt;  	# 注释</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设定默认request和limit</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">default</span>:  	<span style="color:#75715e"># 默认的资源上限, limit</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">1024Mi</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">500m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">defaultRequest</span>:  	<span style="color:#75715e"># 默认的资源申请值, required</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">128Mi</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">100m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">max</span>:  	<span style="color:#75715e"># 声明的limit上限</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">2048Mi</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">1000m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">min</span>:  	<span style="color:#75715e"># 声明的required下线</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">64Mi</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">50m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">Container  	# 被限制的对象，Container</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">###############################################</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:   	<span style="color:#75715e"># Pod中容器的详细定义</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:   	<span style="color:#75715e"># Pod中容器列表</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>:   	<span style="color:#75715e"># 资源限制和请求的设置</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">limits</span>:   	<span style="color:#75715e"># 限定Pod最大使用硬件资源、通常设置cpu和memory</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cpu</span>: <span style="color:#e6db74">&#34;1&#34;</span>   	<span style="color:#75715e"># Cpu的限制，单位为core数</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">memory</span>: <span style="color:#e6db74">&#34;1Gi&#34;</span>   	<span style="color:#75715e"># 内存限制，单位可以为Mib/Gib</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">requests</span>:   	<span style="color:#75715e"># 最低资源要求，在scheduler中被用到，通常设置cpu和memory</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cpu</span>: <span style="color:#e6db74">&#34;0.5&#34;</span>   	<span style="color:#75715e"># 限定使用几个核心CPU、容器启动的初始可用数量</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">memory</span>: <span style="color:#e6db74">&#34;256Mi&#34;</span>   	<span style="color:#75715e"># 设定使用内存、容器启动的初始可用数量</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="8">
<li><!-- raw HTML omitted -->容器健康检查设置<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>
<p><code>startupProbe</code><!-- raw HTML omitted -->： 启动探测：<!-- raw HTML omitted -->容器启动完毕的配置，该配置与<code>readinessProbe</code>一致，在<code>lifecycle</code>和<code>Probe</code>之前运行，失败则重启</p>
<p><code>k8s1.16</code>版本后新加<code>startupProbe</code>探测方式，用于判断容器内应用程序是否已经启动，如果配置了<code>startuprobe</code>，就会先禁用其他的探测，直到它成功为止</p>
</li>
<li>
<p><code>liveness probe</code><!-- raw HTML omitted -->(存活探针)<!-- raw HTML omitted --><code>Kubelet</code> 使用<code>liveness probe</code>（存活探针）来确定何时重启容器。例如，当应用程序处于运行状态但无法做进一步操作，<code>liveness</code>探针将捕获到<code>deadlock</code>重启处于该状态下的容器，使应用程序在存在<code>bug</code>的情况下依然能够继续运行下去（谁的程序还没几个<code>bug</code>呢）</p>
</li>
<li>
<p><code>readiness probe</code><!-- raw HTML omitted -->(就绪探针)<!-- raw HTML omitted --><code>Kubelet</code>使用<code>readiness probe(就绪探针)</code>来确定容器是否已经就绪可以接受流量。只有当<code>Pod</code>中的容器都处于就绪状态时<code>kubelet</code>才会认定该<code>Pod</code>处于就绪状态。该信号的作用是控制哪些<code>Pod</code>应该作为<code>service</code>的后端。如果<code>Pod</code>处于非就绪状态，那么它们将会被从<code>service</code>的<code>load balancer</code>中移除</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>spec.containers[].livenessProbe(存活探针)</td>
<td>Object</td>
<td>指定<code>Pod</code>内容器健康检查的设置，当探测几次无响应后，系统将自动重启该容器。参数可以设置为<code>exec</code>、<code>httpGet</code>、<code>tcpSocket</code>。</td>
</tr>
<tr>
<td>spec.containers[].livenessProbe.exec</td>
<td>Object</td>
<td>指定<code>Pod</code>内容器健康检查的设置，确定是<code>exec</code>方式。</td>
</tr>
<tr>
<td>spec.containers[].livenessProbe.exec.command[]</td>
<td>String</td>
<td>指定<code>exec</code>方式后用这个参数设置需要指定的命令或者脚本。</td>
</tr>
<tr>
<td>spec.containers[].livenessProbe.httpGet</td>
<td>Object</td>
<td>指定 Pod 内容器健康检查的设置，确定是<code>httpGet</code>方式。</td>
</tr>
<tr>
<td>spec.containers[].livenessProbe.tcpSocket</td>
<td>Object</td>
<td>指定 Pod 内容器健康检查的设置，确定是 <code>tcpSocket</code>方式。</td>
</tr>
<tr>
<td>spec.containers[].livenessProbe.initialDelaySeconds</td>
<td>Number</td>
<td>指定容器启动完成后延迟多久开始首次探测的时间间隔，单位为秒。</td>
</tr>
<tr>
<td>spec.containers[].livenessProbe.timeoutSeconds</td>
<td>Number</td>
<td>容器健康检查的探测等待时间，单位为秒，默认为 1 秒。若超过该时间，则认为该次探测失败。</td>
</tr>
<tr>
<td>spec.containers[].livenessProbe.periodSeconds</td>
<td>Number</td>
<td>对容器健康检查的定期探测时间设置，单位为秒，默认每 10 秒探测一次。<code>Kubernetes</code>如果连续执行3次Liveness探测均失败，则会杀掉并重启容器</td>
</tr>
<tr>
<td>spec.containers[].livenessProbe.failureThreshold</td>
<td>Number</td>
<td>连续探测失败多少次才被认定为失败。默认是3。最小值是1</td>
</tr>
<tr>
<td>spec.containers[].livenessProbe.successThreshold</td>
<td>Number</td>
<td>连续探测成功多少次才被认定为成功。默认是1</td>
</tr>
</tbody>
</table>
<ul>
<li><code>infrastructure Container:</code><!-- raw HTML omitted -->基础容器，维护整个<code>Pod</code>网络空间<!-- raw HTML omitted --></li>
<li><code>initContainers:</code><!-- raw HTML omitted -->初始化容器，先于业务容器开始运行<!-- raw HTML omitted --></li>
<li><code>Containers:</code><!-- raw HTML omitted -->业务容器，并行启动<!-- raw HTML omitted --></li>
<li><code>Pod</code><!-- raw HTML omitted -->内所有容器公用一个<!-- raw HTML omitted --><code>ip</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">initc-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">initc-template</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">initContainers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">initc-template</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#39;sh&#39;</span>, <span style="color:#e6db74">&#39;-c&#39;</span>, <span style="color:#e6db74">&#39;sleep 10; echo &#34;Hello&#34; &gt;&gt;/tmp/hello.txt&#39;</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-container</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#39;sh&#39;</span>, <span style="color:#e6db74">&#39;-c&#39;</span>, <span style="color:#e6db74">&#39;echo The app is running! &amp;&amp; sleep 3600&#39;</span>]</span></span></code></pre></div><ul>
<li><code>exec</code><!-- raw HTML omitted -->命令：在容器内执行一次命令，如果命令执行的退出码为<code>0</code>，则认为程序正常，否则不正常<!-- raw HTML omitted --></li>
<li><code>Pod</code><!-- raw HTML omitted -->五种状态<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>Pending(挂起)</code>：<code>API Server</code><!-- raw HTML omitted -->已经创建了<code>Pod</code>资源对象，但它尚未被调度完成或者仍处于下载镜像的过程中<!-- raw HTML omitted --></li>
<li><code>Running(运行中)</code>：<code>Pod</code><!-- raw HTML omitted -->已经被调度到某节点，并且所有容器都已经被<code>kubelet</code>创建完成<!-- raw HTML omitted --></li>
<li><code>Succeeded(成功终止)</code>：<code>Pod</code><!-- raw HTML omitted -->中的所有容器都已经成功终止并且不会被重启<!-- raw HTML omitted --></li>
<li><code>Failed(失败)</code><!-- raw HTML omitted -->：所有容器都已经终止，但至少有一个容器终止失败，即容器返回了非<code>0</code>值的退出状态<!-- raw HTML omitted --></li>
<li><code>Unknown(未知)</code>：<code>API Server</code><!-- raw HTML omitted -->无法正常获取到<code>Pod</code>对象的状态信息，通常由于网络通信失败所导致<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spec</span>:   	<span style="color:#75715e"># 必选，Pod中容器的详细定义</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:   	<span style="color:#75715e"># 必选，Pod中容器列表</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">lifecycle</span>:   	<span style="color:#75715e"># 生命周期钩子</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">postStart</span>:  	<span style="color:#75715e"># 容器启动后立即执行此钩子,如果执行失败,会根据重启策略进行重启</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">exec</span>:  	<span style="color:#75715e"># 通过执行特定命令来探测容器健康状态</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;echo Hello from the postStart handler&gt; /usr/share/message&#34;</span>]
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">preStop</span>:  	<span style="color:#75715e"># 容器终止前执行此钩子,无论结果如何,容器都会终止</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">exec</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;nginx -s quit; while killall -0 nginx; do sleep 1; done&#34;</span>]
</span></span><span style="display:flex;"><span><span style="color:#75715e">#################  		启动探针	  #####################</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">startupProbe</span>:  	<span style="color:#75715e"># 容器启动完毕的配置，该配置与readinessProbe一致，在lifecycle和Probe之前运行，失败则重启</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">tcpSocket</span>:   		<span style="color:#75715e"># 使用TcpSocket、httpGet健康检查</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8010</span>   	<span style="color:#75715e"># 探测8010端口</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">5</span>  	<span style="color:#75715e"># 检测失败5次表示未就绪</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">60</span>   	<span style="color:#75715e"># 指定容器启动60s之后开始执行Liveness探测，</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>  	<span style="color:#75715e"># 两次探测的间隔多少秒，默认值为10</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>  	<span style="color:#75715e"># 连续多少次检测成功认为容器正常，默认值为1。不支持修改</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">3</span>  	<span style="color:#75715e"># 连续多少次检测失败认为容器异常，默认值为3</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span>  	<span style="color:#75715e"># 探测请求超时时间</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##################  	存活探针编写方式  	################</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">livenessprobe</span>:  	<span style="color:#75715e"># 存活探针检查,不通过不转发流量</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tcpSocket</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8010</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#####################  		就绪探针编写方式  		################</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">readinessProbe</span>:   	<span style="color:#75715e"># 就绪探针检查、不通过重建pod</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">tcpSocket</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8010</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">####################  		httpGet编写  		###########################</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">httpGet</span>:
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/  	# URI地址</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>  	<span style="color:#75715e"># 端口号,或者协议：http/https</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">host</span>: <span style="color:#ae81ff">192.168.109.100</span>  	<span style="color:#75715e"># 主机地址  </span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTP  	# 支持的协议，http或者https</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="9">
<li><code>spec.volumes</code><!-- raw HTML omitted -->挂载目录字段<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>参数名</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>spec.volumes[].name</td>
<td>String</td>
<td>定义<code>Pod</code>共享存储卷的名称，容器定义部分 <code>spec.containers[].volumeMounts[].name</code>的值和这里是一样的。</td>
</tr>
<tr>
<td>spec.volumes[].emptyDir</td>
<td>Object</td>
<td>指定<code>Pod</code>的临时目录，值为一个空对象：<code>emptyDir:{}</code></td>
</tr>
<tr>
<td>spec.volumes[].hostPath</td>
<td>Object</td>
<td>指定挂载<code>Pod</code>所在宿主机的目录。</td>
</tr>
<tr>
<td>spec.volumes[].hostPath.path</td>
<td>String</td>
<td>指定<code>Pod</code>所在主机的目录，将被用于容器中<code>mount</code>的目录。</td>
</tr>
<tr>
<td>spec.volumes.nfs</td>
<td></td>
<td></td>
</tr>
<tr>
<td>spec.volumes[]</td>
<td>Object</td>
<td>指定类型为<code>Secret</code>的存储卷，<code>Secret</code>意为私密、秘密，这很容易理解，它存储一些密码、密钥等敏感安全文件。挂载集群预定义的<code>Secret</code>对象到容器内部。</td>
</tr>
<tr>
<td>spec.volumes[].configMap</td>
<td>Object</td>
<td>指定类型为<code>ConfigMap</code>的存储卷，表示挂载集群预定义的<code>ConfigMap</code>对象到容器内部。</td>
</tr>
</tbody>
</table>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl explain deployment.spec.volumes  	<span style="color:#75715e"># 获取 deployment存储使用</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl explain deployment.spec.volumes.hostPath.type  	<span style="color:#75715e"># 类型声明  </span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->简单存储模式→<!-- raw HTML omitted --><code>volume-emptydir</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod  </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">name</span>: <span style="color:#ae81ff">volume-emptydir </span> <span style="color:#75715e"># 定义名称</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:   	<span style="color:#75715e"># 必选，Pod中容器的详细定义</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">containers</span>:  	<span style="color:#75715e"># 必选，Pod中容器列表</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumeMounts</span>: <span style="color:#75715e"># 将logs-volume挂载到nginx容器中对应的目录，该目录为/var/log/nginx</span>
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/log/nginx </span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30  	# 可以选择 1.28.4版本</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;tail -f /logs/access.log&#34;</span>] <span style="color:#75715e"># 初始命令，动态读取指定文件</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumeMounts</span>: <span style="color:#75715e"># 将logs-volume挂载到busybox容器中的对应目录，该目录为/logs</span>
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/logs</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:   	<span style="color:#75715e"># 声明volume，name为logs-volume，类型为emptyDir</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume  	# 共享存储卷名称 （volumes类型有很多种）</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">emptyDir</span>: {}   		<span style="color:#75715e"># 类型为emtyDir的存储卷，与Pod同生命周期的一个临时目录。为空值</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->简单存储模式→<!-- raw HTML omitted --><code>volume-HostPath</code></li>
</ul>
<blockquote>
<ul>
<li><code>DirectoryOrCreate</code><!-- raw HTML omitted -->：目录存在就使用，不存在就先创建后使用<!-- raw HTML omitted --></li>
<li><code>Directory</code><!-- raw HTML omitted -->：目录必须存在<!-- raw HTML omitted --></li>
<li><code>FileOrCreate</code><!-- raw HTML omitted -->：文件存在就使用，不存在就先创建后使用<!-- raw HTML omitted --></li>
<li><code>File</code><!-- raw HTML omitted -->：文件必须存在<!-- raw HTML omitted --></li>
<li><code>Socket</code><!-- raw HTML omitted -->：<code>unix</code>套接字必须存在<!-- raw HTML omitted --></li>
<li><code>CharDevice</code><!-- raw HTML omitted -->：字符设备必须存在<!-- raw HTML omitted --></li>
<li><code>BlockDevice</code><!-- raw HTML omitted -->：块设备必须存在<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">volume-hostpath</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumeMounts</span>: <span style="color:#75715e"># 将logs-volume挂载到nginx容器中对应的目录，该目录为/var/log/nginx</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/log/nginx</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;tail -f /logs/access.log&#34;</span>] <span style="color:#75715e"># 初始命令，动态读取指定文件</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumeMounts</span>: <span style="color:#75715e"># 将logs-volume挂载到busybox容器中的对应目录，该目录为/logs</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/logs</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>: <span style="color:#75715e"># 声明volume，name为logs-volume，类型为hostPath</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">hostPath</span>:  <span style="color:#75715e"># 类型为hostPath的存储卷，表示挂载Pod所在宿主机的目录</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/root/logs </span> <span style="color:#75715e"># Pod所在宿主机的目录，将被用于同期中mount的目录</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">type</span>: <span style="color:#ae81ff">DirectoryOrCreate</span> <span style="color:#75715e"># 目录存在就使用，不存在就先创建再使用 </span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->简单存储模式→<!-- raw HTML omitted --><code>volume-nfs</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">name</span>: <span style="color:#ae81ff">volume-nfs</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumeMounts</span>:  	<span style="color:#75715e"># 将logs-volume挂载到nginx容器中对应的目录，该目录为/var/log/nginx</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/log/nginx</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;tail -f /logs/access.log&#34;</span>]  	<span style="color:#75715e"># 初始命令，动态读取指定文件</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumeMounts</span>:  	<span style="color:#75715e"># 将logs-volume挂载到busybox容器中的对应目录，该目录为/logs</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/logs</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:  	<span style="color:#75715e"># 声明volume</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nfs</span>:  	<span style="color:#75715e"># 存储类型，和底层正则的存储对应</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server</span>: <span style="color:#ae81ff">192.168.18.100</span>  	<span style="color:#75715e"># NFS服务器地址</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/root/data/nfs  	# 共享文件路径</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->高级存储模式→<!-- raw HTML omitted --><code>volume-pv</code></li>
</ul>
<blockquote>
<ul>
<li><code>PV：kubernetes</code><!-- raw HTML omitted -->管理员维护<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolume</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pv2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">nfs</span>:  	<span style="color:#75715e"># 存储类型，和底层正则的存储对应</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/root/data/pv1</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">server</span>: <span style="color:#ae81ff">192.168.18.100</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">capacity</span>:  	<span style="color:#75715e"># 存储能力，目前只支持存储空间的设置</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">2Gi</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">accessModes</span>:  	<span style="color:#75715e"># 访问模式</span>
</span></span><span style="display:flex;"><span>   - <span style="color:#ae81ff">ReadWriteMany</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">storageClassName</span>:  	<span style="color:#75715e"># 存储类别</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">persistentVolumeReclaimPolicy</span>: <span style="color:#ae81ff">Retain  	# 回收策略</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->高级存储→<!-- raw HTML omitted --><code>volume-pvc</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolumeClaim</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pvc1</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">accessModes</span>:  	<span style="color:#75715e"># 访客模式</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">ReadWriteMany</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:  	<span style="color:#75715e"># 采用标签对PV选择</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">storageClassName</span>:  	<span style="color:#75715e"># 存储类别</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:  	<span style="color:#75715e"># 请求空间</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">1Gi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#################################################### 创建 Pod 访问 PVC 类型存储</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;while true;do echo pod1 &gt;&gt; /root/out.txt; sleep 10; done;&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">volume</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/root/</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">volume</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">persistentVolumeClaim</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">claimName</span>: <span style="color:#ae81ff">pvc1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">readOnly</span>: <span style="color:#66d9ef">false</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->配置存储→<!-- raw HTML omitted --><code>volumes-secret</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Secret</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">name</span>: <span style="color:#ae81ff">secret</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">type</span>: <span style="color:#ae81ff">Opaque</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">data</span>:  	<span style="color:#75715e"># 提前编码实名：data、使用Kubernetes进行编码使用：stringData</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">username</span>: <span style="color:#ae81ff">YWRtaW4=  	# 使用kubernetes进行编码写原数据：admin</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">password</span>: <span style="color:#ae81ff">MTIzNDU2  	# 使用kubernetes进行编码写原数据：123456</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">############################################## 配置 pod-secret</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-secret</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/secret/config</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">secret</span>:  	<span style="color:#75715e"># 类型为secret的存储卷，挂载集群与定义的secret对象到容器内部</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">secretName</span>: <span style="color:#ae81ff">secret</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">items</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">string</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">string</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="10">
<li><!-- raw HTML omitted -->额外的参数对象<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>参数名</th>
<th>参数类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>spec.restartPolicy</td>
<td>String</td>
<td>定义<code>Pod</code>的重启策略，可选值为<code>Always</code>、<code>OnFailure</code>，默认值为<code>Always</code>。<!-- raw HTML omitted -->(1) <!-- raw HTML omitted --><code>Always</code><!-- raw HTML omitted -->：<code>Pod</code>一旦终止运行，无论容器是如何终止的，<code>kubelet</code>服务都将重启它<!-- raw HTML omitted -->(2) <!-- raw HTML omitted --><code>OnFailure</code><!-- raw HTML omitted -->：只有<code>Pod</code>以非零退出码终止时，<code>kubelet</code>才会重启该容器，如果容器正常结束（退出码为 0），则<code>kubelet</code>将不会重启它<!-- raw HTML omitted --> (3)<!-- raw HTML omitted --><code>Never</code><!-- raw HTML omitted -->：<code>Pod</code>终止后，<code>kubelet</code>将退出码报告给<code>master</code>，不会重启该 <code>Pod</code></td>
</tr>
<tr>
<td>spec.nodeName</td>
<td></td>
<td>定向调度</td>
</tr>
<tr>
<td>spec.nodeSelector</td>
<td>Object</td>
<td>定向调度，定义节点的过滤标签（以<code>key:value</code>格式指定）。</td>
</tr>
<tr>
<td>pod.spec.affinity</td>
<td>亲和调度</td>
<td></td>
</tr>
<tr>
<td>pod.spec.affinity.nodeAffinity</td>
<td></td>
<td>（node亲和性）：以Node为目标，解决Pod可以调度到那些Node的问题。</td>
</tr>
<tr>
<td>pod.spec.affinity.podAffinity</td>
<td></td>
<td>（pod亲和性）：以Pod为目标，解决Pod可以和那些已存在的Pod部署在同一个拓扑域中的问题。</td>
</tr>
<tr>
<td>pod.spec.affinity.podAntiAffinity</td>
<td></td>
<td>（pod反亲和性）：以Pod为目标，解决Pod不能和那些已经存在的Pod部署在同一拓扑域中的问题。</td>
</tr>
<tr>
<td>pod.spec.tolerations</td>
<td>容忍调度</td>
<td>污点就是拒绝，容忍就是忽略，Node通过污点拒绝Pod调度上去，Pod通过容忍忽略拒绝</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>spec.imagePullSecrets</td>
<td>List</td>
<td>定义拉取镜像时使用<code>Secret</code>名称（以<code>name:secretkey</code>格式指定）。</td>
</tr>
<tr>
<td>spec.hostNetwork</td>
<td>Boolean</td>
<td>定义是否使用主机网络模式，默认值为 false。 设置 true 表示使用宿主机网络，不使用 Docker 网桥，同时设置了 true 将无法在同一台宿主机上启动第二个副本。</td>
</tr>
<tr>
<td>service.spec.type</td>
<td></td>
<td><code>type</code>确定服务的公开方式。 默认为<code>ClusterIP</code>。有效的选项是<code>ExternalName</code>、<code>ClusterIP</code>、<code>NodePort</code>和<code>LoadBalancer</code></td>
</tr>
<tr>
<td>service.spec.type.ClusterIP</td>
<td></td>
<td><code>ClusterIP</code>为负载均衡分配集群内部<code>IP</code>地址端点。 端点由选择器确定，或者如果不是通过手动构造<code>Endpoints</code>对象或<code>EndpointSlice</code>指定对象。 如果<code>clusterIP</code>为<code>None</code>，则不分配虚拟<code>IP</code>，并且端点作为一组端点而不是虚拟<code>IP</code>发布。</td>
</tr>
<tr>
<td>service.spec.type.NodePort</td>
<td></td>
<td><code>NodePort</code>建立在<code>ClusterIP</code>之上，并在每个节点上分配一个端口路由到与<code>clusterIP</code>相同的端点。</td>
</tr>
<tr>
<td>service.spec.type.LoadBalancer</td>
<td></td>
<td><code>LoadBalancer</code>建立在<code>NodePort</code>并创建一个外部负载均衡器（如果当前支持<code>cloud</code>) 路由到与<code>clusterIP</code>相同的端点。</td>
</tr>
<tr>
<td>service.spec.type.ExternalName</td>
<td></td>
<td><code>ExternalName</code>将此服务别名为指定的<code>externalName</code>。 其他几个领域不适用于<code>ExternalName</code>服务</td>
</tr>
</tbody>
</table>
<ul>
<li><code>tolerations</code><!-- raw HTML omitted -->(容忍)配置<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl explain deployment.spec.template.spec.tolerations</span></span></code></pre></div><ul>
<li><code>affinity</code><!-- raw HTML omitted -->(亲和性)配置<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl explain deployment.spec.template.spec.affinity  	<span style="color:#75715e"># 查看 Deployment 亲和性使用</span></span></span></code></pre></div><blockquote>
<ul>
<li><code>nodeAffinity</code><!-- raw HTML omitted -->节点亲和性<!-- raw HTML omitted --></li>
<li><code>requiredDuringSchedulingIgnoredDuringExecution:</code><!-- raw HTML omitted -->硬性要求，必须满足条件<!-- raw HTML omitted --></li>
<li><code>preferredDuringSchedulingIgnoredDuringExecution:</code><!-- raw HTML omitted -->软性要求，不强制满足<!-- raw HTML omitted --></li>
<li><code>In</code><!-- raw HTML omitted -->：满足条件之一<!-- raw HTML omitted --></li>
<li><code>NotIn</code><!-- raw HTML omitted -->：所有条件都不满足，反亲和性<!-- raw HTML omitted --></li>
<li><code>Exists</code><!-- raw HTML omitted -->：存在就满足<!-- raw HTML omitted --></li>
<li><code>DoesNotExist</code><!-- raw HTML omitted -->不存在就满足<!-- raw HTML omitted --></li>
<li><code>Gt</code><!-- raw HTML omitted -->大于节点上的数值就满足<!-- raw HTML omitted --></li>
<li><code>Lt</code><!-- raw HTML omitted -->小于节点上的数值就满足<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl explain deployment.spec.template.spec.affinity.nodeAffinity  	<span style="color:#75715e"># 查看Deployment nodes亲和性使用</span></span></span></code></pre></div><div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">with-affinity-anti-affinity</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">affinity</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nodeAffinity</span>:  	<span style="color:#75715e"># 节点亲和性  </span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">requiredDuringSchedulingIgnoredDuringExecution</span>:  	<span style="color:#75715e"># 必须满足条件</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">nodeSelectorTerms</span>:  	<span style="color:#75715e"># 选择器，nodeSelectorTerms：节点选择器，labelSelector：标签选择器</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">matchExpressions</span>:  	<span style="color:#75715e"># 表达式匹配</span>
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">kubernetes.io/os  	# 必须存在的Key</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">In  	# 在Key中满足一个条件，匹配类型：In、NotIn、Exists、DoesNotExist、Gt、Lt</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">values</span>:  	<span style="color:#75715e"># 下方 value 在 Key 中必须存在其中之一(value)</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">linux  	# 必须是Linux才部署  </span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">preferredDuringSchedulingIgnoredDuringExecution</span>:  	<span style="color:#75715e"># 软性要求，不强制满足，优先选择亲和性目标</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">weight</span>: <span style="color:#ae81ff">1</span>  	<span style="color:#75715e"># 权重，数值越大，优先部署</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">preference</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">matchExpressions</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">label-1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">In</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">values</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">key-1</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">weight</span>: <span style="color:#ae81ff">50</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">preference</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">matchExpressions</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">label-2</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">In</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">values</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">key-2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">with-node-affinity</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">registry.k8s.io/pause:2.0</span></span></span></code></pre></div><ul>
<li><code>podAffinity</code><!-- raw HTML omitted -->亲和性<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl explain pod.spec.affinity.podAffinity</span></span></code></pre></div><div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">with-pod-affinity</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">affinity</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">podAffinity</span>:  	<span style="color:#75715e"># Pod 亲和性</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">requiredDuringSchedulingIgnoredDuringExecution</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">labelSelector</span>:  	<span style="color:#75715e"># 选择器：</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">matchExpressions</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">security</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">In</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">values</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">S1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">topologyKey</span>: <span style="color:#ae81ff">topology.kubernetes.io/zone  	# 匹配节点标签亲和性</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">podAntiAffinity</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">preferredDuringSchedulingIgnoredDuringExecution</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">weight</span>: <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">podAffinityTerm</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">labelSelector</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">matchExpressions</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">security</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">In</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">values</span>:
</span></span><span style="display:flex;"><span>              - <span style="color:#ae81ff">S2</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">topologyKey</span>: <span style="color:#ae81ff">topology.kubernetes.io/zone</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">with-pod-affinity</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">registry.k8s.io/pause:2.0  </span></span></span></code></pre></div><ul>
<li><code>podAntiAffinity</code><!-- raw HTML omitted -->反亲和性<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl explain pod.spec.affinity.podAntiAffinity  </span></span></code></pre></div></blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spec</span>:  	<span style="color:#75715e"># 必选，Pod中容器的详细定义</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">2</span>  	<span style="color:#75715e"># 创建Pod个数</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">selector</span>:  	<span style="color:#75715e"># 标签选择器</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">matchLabels</span>:  	<span style="color:#75715e"># 标签选择方式:直接给定标签键值,这里是取交集的,也就是Pod必须满足下面两个标签才能被调度</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">project</span>: <span style="color:#ae81ff">ms</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">product  	# 此行以上定义控制器本身</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:  	<span style="color:#75715e"># 定义Deployment更新回滚</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>         - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">string</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">annotations</span>:  	<span style="color:#75715e"># 注释，不能作为被筛选</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hostAliases</span>:  	<span style="color:#75715e"># /etc/hosts/手动添加解析</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">ip</span>: <span style="color:#e6db74">&#34;192.168.4.110&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hostnames</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;k8s.com&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:   	<span style="color:#75715e"># 必选，Pod中容器列表</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">restartPolicy</span>: [<span style="color:#ae81ff">Always、Never、OnFailure] </span> <span style="color:#75715e">#默认K8S-Pod的重启策略,此容器退出后立即创建一个相同容器</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nodeName</span>: <span style="color:#ae81ff">k8s-node1</span> <span style="color:#75715e"># NodeName表示将该Pod调度到指定到名称的node节点上</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nodeSelector</span>: <span style="color:#ae81ff">obeject</span> <span style="color:#75715e"># nodeSelector用于将Pod调度到添加了指定标签的Node节点上</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">imagePullSecrets</span>:  	<span style="color:#75715e"># 配置登录 docker registry 的 secret 仓库</span>
</span></span><span style="display:flex;"><span>     - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">docker-harbor  	# 指定使用的secret库房名称</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">hostNetwork</span>: <span style="color:#66d9ef">false</span>   <span style="color:#75715e">#是否使用主机网络模式，默认为false，如果设置为true，表示使用宿主机网络</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="replicasetrs类型控制器"><code>ReplicaSet(RS)</code>类型控制器</h3>
<blockquote>
<ul>
<li><code>ReplicaSet</code><!-- raw HTML omitted -->：主要作用是保证一定数量的<code>Pod</code>能够正常运行，它会持续监听这些<code>Pod</code>的运行状态，一旦<code>Pod</code>发生故障，就会重启或重建。同时它还支持对<code>Pod</code>数量的扩缩容和版本镜像的升级<!-- raw HTML omitted --></li>
<li><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/ReplicaSet/kubernetes-replicaset-template.yaml" rel="external" target="_self"><code>Kubernetes replicaset Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1    </span> <span style="color:#75715e"># 版本号 </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ReplicaSet       </span> <span style="color:#75715e"># 类型 </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:       <span style="color:#75715e"># 元数据 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">replicaset-template    </span> <span style="color:#75715e"># 名称、在一个名称空间内不能重复</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default   </span> <span style="color:#75715e"># 指定名称空间、默认defalut</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:       <span style="color:#75715e"># 标签 </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">replicaset-template</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:   <span style="color:#75715e"># 详情描述 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>   <span style="color:#75715e"># 指定副本数量，是rs创建出来的Pod的数量，默认为1.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:     <span style="color:#75715e"># 选择器，它的作用是建立Pod控制器和Pod之间的关联关系，采用了Label Selector机制（在Pod模块上定义Label，在控制器上定义选择器，就可以表明当前控制器能管理哪些Pod了）</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:        <span style="color:#75715e"># Labels匹配规则，matchExpressions：Expressions匹配规则</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">replicaset-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:     <span style="color:#75715e"># 模块 当副本数据不足的时候，会根据下面的模板创建Pod副本</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">replicaset-template</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx    </span> <span style="color:#75715e"># 容器名称</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1    </span> <span style="color:#75715e"># 容器需要的镜像地址</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>     <span style="color:#75715e"># 容器所监听的端口</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">100m</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">128Mi</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">50m</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">128Mi</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="horizontalpodautoscaler类型"><code>HorizontalPodAutoscaler</code>类型</h3>
<blockquote>
<ul>
<li><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/HPA/kubernetes-hpa-template.yaml" rel="external" target="_self"><code>Kubernetes HorizontalPodAutoscaler Template</code>模板</a></li>
</ul>
<blockquote>
<ul>
<li><code>deployment</code><!-- raw HTML omitted -->：类型控制器<!-- raw HTML omitted --></li>
<li><code>deployment-name</code><!-- raw HTML omitted -->：<code>Pod</code>的名称<!-- raw HTML omitted --></li>
<li><code>--cpu-percent</code><!-- raw HTML omitted -->：使用<code>CPU</code>百分比<!-- raw HTML omitted --></li>
<li><code>--min</code><!-- raw HTML omitted -->：<code>Pod</code>最少数量<!-- raw HTML omitted --></li>
<li><code>--max</code><!-- raw HTML omitted -->：<code>Pod</code>最多数量<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl autoscale deployment deployment-name --cpu-percent<span style="color:#f92672">=</span><span style="color:#ae81ff">50</span> --min<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> --max<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span></span></span></code></pre></div></blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">autoscaling/v2   </span> <span style="color:#75715e"># 版本号</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">HorizontalPodAutoscaler  </span> <span style="color:#75715e"># 类型</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:   <span style="color:#75715e"># 元数据 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default   </span> <span style="color:#75715e"># 指定名称空间、默认default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">hpa-template</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">minReplicas</span>: <span style="color:#ae81ff">2</span>   <span style="color:#75715e"># 最小Pod数量</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">maxReplicas</span>: <span style="color:#ae81ff">10</span>    <span style="color:#75715e"># 最大Pod数量</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">metrics</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">resource</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cpu  	# 扩缩容名称</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">averageUtilization</span>: <span style="color:#ae81ff">30</span>  	<span style="color:#75715e"># 设置CPU使用百分比，超过就扩容</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">type</span>: <span style="color:#ae81ff">Utilization  	# 利用率：Utilization，平均值：AverageValue：1k、1M、1G</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">Resource</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scaleTargetRef</span>:    <span style="color:#75715e"># 指定要控制Pod、Deployment信息</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">deployment-template</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">name</span>: <span style="color:#ae81ff">service-template</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">deployment-nginx-template</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  clusterIP: None       # 将clusterIP设置为None，即可创建headliness Service</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">NodePort       </span> <span style="color:#75715e"># Pod使用的IP类型：ClusterIP、NodePort</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>    <span style="color:#75715e"># Service的端口</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">80</span>      <span style="color:#75715e"># StatefulSet 的Pod端口</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1    </span> <span style="color:#75715e"># 版本号 </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment       </span> <span style="color:#75715e"># 类型 </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:       <span style="color:#75715e"># 元数据 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">deployment-template    </span> <span style="color:#75715e"># deployment的名称</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default   </span> <span style="color:#75715e"># 指定名称空间、默认default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:       <span style="color:#75715e"># 标签 </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">deployment-nginx-template</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:   <span style="color:#75715e"># 详情描述 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>   <span style="color:#75715e"># 副本数量 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">revisionHistoryLimit</span>: <span style="color:#ae81ff">3</span>       <span style="color:#75715e"># 保留历史版本，默认为10 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">paused</span>: <span style="color:#66d9ef">false</span>         <span style="color:#75715e"># 暂停部署，默认是false </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">progressDeadlineSeconds</span>: <span style="color:#ae81ff">600</span>          <span style="color:#75715e"># 部署超时时间（s），默认是600</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">strategy</span>:     <span style="color:#75715e"># pod更新策略，即如何替换已有的pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate        </span> <span style="color:#75715e"># 更新策略、支持 Recreate, RollingUpdate。默认RollingUpdate</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>:      <span style="color:#75715e"># 当type为RollingUpdate的时候生效，用于为rollingUpdate设置参数</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">30</span><span style="color:#ae81ff">%      </span> <span style="color:#75715e"># 用来指定在升级过程中不可用的Pod的最大数量，默认为25%。</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxSurge</span>: <span style="color:#ae81ff">30</span><span style="color:#ae81ff">%    </span> <span style="color:#75715e"># 用来指定在升级过程中可以超过期望的Pod的最大数量，默认为25%</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:     <span style="color:#75715e"># 选择器，通过它指定该控制器管理哪些pod </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:        <span style="color:#75715e"># Labels匹配规则，matchExpressions：Expressions匹配规则 </span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">deployment-nginx-template </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:     <span style="color:#75715e"># 模板，当副本数量不足时，会根据下面的模板创建pod副本 </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:   <span style="color:#75715e"># Pod 的标签</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">deployment-nginx-template</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:   <span style="color:#75715e"># Pod 的期望信息</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:   <span style="color:#75715e"># Pod 容器描述</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx  </span> <span style="color:#75715e"># 镜像名称</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent  </span> <span style="color:#75715e"># IfNotPresent：如果镜像不存在就拉取</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">100m</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">128Mi</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">50m</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">128Mi</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">restartPolicy</span>: <span style="color:#ae81ff">Always  </span> <span style="color:#75715e"># 重启策略，Always：代表一直重启</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">terminationGracePeriodSeconds</span>: <span style="color:#ae81ff">30</span>   <span style="color:#75715e"># 删除操作宽限时间</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="deploymentdeploy无状态类型"><code>Deployment(deploy)</code>无状态类型</h3>

<pre class="mermaid align-center zoomable">graph TD
A[&lt;p&gt;Deployment&lt;br&gt;seletor:env=dev] --&gt; A1((&lt;p&gt;Pod&lt;br&gt;label:env=dev))
A[&lt;p&gt;Deployment&lt;br&gt;seletor:env=dev] --&gt; A2((&lt;p&gt;Pod&lt;br&gt;label:env=dev))
A[&lt;p&gt;Deployment&lt;br&gt;seletor:env=dev] --&gt; A3((&lt;p&gt;Pod&lt;br&gt;label:env=dev))
    Z[Deployment控制Pod]  </pre><blockquote>
<ul>
<li><code>Deployment</code><!-- raw HTML omitted -->：为了更好的解决服务编排的问题，<!-- raw HTML omitted --><code>kubernetes</code>在<code>v1.2</code>版本开始，引入了<code>Deployment</code>控制器。值得一提的是，<code>Deployment</code>控制器并不直接管理<code>Pod</code>，而是通过管理<code>ReplicaSet</code>来间接管理<code>Pod</code>，即：<code>Deployment</code>管理<code>ReplicaSet</code>，<code>ReplicaSet</code>管理<code>Pod</code>。所以<code>Deployment</code>的功能比<code>ReplicaSet</code>强大</li>
<li>支持<code>ReplicaSet</code>的所有功能</li>
<li><!-- raw HTML omitted -->支持发布的停止、继续<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->支持版本滚动更新和版本回退<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>
<p><code>Recreate</code><!-- raw HTML omitted -->重建更新：在创建出新的<code>Pod</code>之前会先杀掉所有已经存在的<!-- raw HTML omitted --><code>Pod</code></p>
</li>
<li>
<p><code>RollingUpdate</code><!-- raw HTML omitted -->滚动更新：杀死一部分，就启动一部分，在更新过程中存在两个版本的<!-- raw HTML omitted --><code>Pod</code>，当<code>type</code>为<code>RollingUpdate</code>的时候生效，用于为<code>rollingUpdate</code>设置参数，  支持两个属性：</p>
</li>
<li>
<p><code>maxSurge</code><!-- raw HTML omitted -->：用来指定在升级过程中可以超过期望的<code>Pod</code>的最大数量，默认为25%<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>maxUnavailable</code><!-- raw HTML omitted -->：用来指定在升级过程中不可用的<code>Pod</code>的最大数量，默认为25%<!-- raw HTML omitted --></p>
</li>
</ul>
</blockquote>
<ul>
<li><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/Deployment/kubernetes-deployment-template.yaml" rel="external" target="_self"><code>Kubernetes Deployment Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1  	# 版本号 </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment  	# 类型 </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:  	<span style="color:#75715e"># 元数据 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">deployment-template  	# deployment的名称</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default  	# 指定名称空间、默认defalut</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:  	<span style="color:#75715e"># 标签 </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">deployment-nginx-template</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:  	<span style="color:#75715e"># 详情描述 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>  	<span style="color:#75715e"># 副本数量 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">revisionHistoryLimit</span>: <span style="color:#ae81ff">3</span>  	<span style="color:#75715e"># 保留历史版本，默认为10 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">paused</span>: <span style="color:#66d9ef">false</span>  	<span style="color:#75715e"># 暂停部署，默认是false </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">progressDeadlineSeconds</span>: <span style="color:#ae81ff">600</span>  	<span style="color:#75715e"># 部署超时时间（s），默认是600</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">strategy</span>:  	<span style="color:#75715e"># pod更新策略，即如何替换已有的pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>:  	<span style="color:#75715e"># 当type为RollingUpdate的时候生效，用于为rollingUpdate设置参数</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">30</span><span style="color:#ae81ff">%  	# 用来指定在升级过程中不可用的Pod的最大数量，默认为25%。</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxSurge</span>: <span style="color:#ae81ff">30</span><span style="color:#ae81ff">%  	# 用来指定在升级过程中可以超过期望的Pod的最大数量，默认为25%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate  	# 更新策略、支持 Recreate, RollingUpdate。默认RollingUpdate</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:  	<span style="color:#75715e"># 选择器，通过它指定该控制器管理哪些pod </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:  	<span style="color:#75715e"># Labels匹配规则，matchExpressions：Expressions匹配规则 </span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">deployment-nginx-template </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:  	<span style="color:#75715e"># 模板，当副本数量不足时，会根据下面的模板创建pod副本 </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:   <span style="color:#75715e"># Pod 的标签</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">deployment-nginx-template</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:   <span style="color:#75715e"># Pod 的期望信息</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:   <span style="color:#75715e"># Pod 容器描述</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx  </span> <span style="color:#75715e"># 镜像名称</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1    </span> <span style="color:#75715e"># fxgxxxxx/nginx:v1 在所有节点登录自己的 hub.docker.com 账户</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent  </span> <span style="color:#75715e"># IfNotPresent：如果镜像不存在就拉取</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">volumeMounts</span>:   <span style="color:#75715e"># 挂载到容器内部的存储卷配置</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx_vhosts   </span> <span style="color:#75715e"># 引用pod定义的共享存储卷的名称，需用volumes[]部分定义的的卷名</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/usr/local/nginx/conf/vhosts  </span> <span style="color:#75715e"># 存储卷在容器内mount的绝对路径，应少于512字符</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx_logs</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/usr/local/nginx/logs</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx_html</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">resources</span>:      <span style="color:#75715e"># 资源限制和请求的设置</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">limits</span>:   <span style="color:#75715e"># 限定Pod最大使用硬件资源、通常设置cpu和memory</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#e6db74">&#34;6&#34;</span>    <span style="color:#75715e"># Cpu的限制，单位为core数，将用于docker run --cpu-shares参数，1000m等于一个核心</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#e6db74">&#34;128Mi&#34;</span>     <span style="color:#75715e"># 内存限制，单位可以为Mib/Gib，将用于docker run --memory参数</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">requests</span>:     <span style="color:#75715e"># 最低资源要求，在scheduler中被用到，通常设置cpu和memory</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#e6db74">&#34;3&#34;</span>    <span style="color:#75715e"># 限定使用几个核心CPU、容器启动的初始可用数量</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#e6db74">&#34;64Mi&#34;</span>      <span style="color:#75715e"># 设定使用内存、容器启动的初始可用数量</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">restartPolicy</span>: <span style="color:#ae81ff">Always  </span> <span style="color:#75715e"># 重启策略，Always：代表一直重启</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">terminationGracePeriodSeconds</span>: <span style="color:#ae81ff">30</span>   <span style="color:#75715e"># 删除操作宽限时间</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumes</span>:      <span style="color:#75715e"># 在该pod上定义共享存储卷列表</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx_vhosts    </span> <span style="color:#75715e"># 共享存储卷名称 （volumes类型有很多种） </span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">hostPath</span>:   <span style="color:#75715e"># 类型为hostPath的存储卷，表示挂载Pod所在宿主机的目录</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/opt/data/nginx/vhosts</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">type</span>: <span style="color:#ae81ff">DirectoryOrCreate  </span> <span style="color:#75715e"># 目录存在就使用，不存在就先创建再使用</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx_logs</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">hostPath</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/opt/data/nginx/logs</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">type</span>: <span style="color:#ae81ff">DirectoryOrCreate</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx_html</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">hostPath</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/opt/data/nginx/html</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">type</span>: <span style="color:#ae81ff">DirectoryOrCreate</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">status</span>: {}</span></span></code></pre></div></blockquote>
<hr>
<h3 id="statefulset有状态类型"><code>StatefulSet</code>有状态类型</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->无状态应用定义<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>认为<code>Pod</code>都是一样的</li>
<li>没有顺序要求</li>
<li>不用考虑在哪个<code>Node</code>节点上运行</li>
<li>随意进行伸缩和扩展</li>
</ul>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->有状态应用定义<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>有顺序要求</li>
<li>认为每个<code>Pod</code>都是不一样的</li>
<li>需要考虑在哪个<code>Node</code>节点上运行</li>
<li>需要按照顺序进行伸缩和扩展</li>
<li>让每个<code>Pod</code>都是独立的，保持<code>Pod</code>启动顺序和唯一性</li>
</ul>
</blockquote>
<ul>
<li><code>StatefulSet</code> 是<code>Kubernetes</code><!-- raw HTML omitted -->提供的管理有状态应用的负载管理控制器<!-- raw HTML omitted --></li>
<li><code>StatefulSet</code><!-- raw HTML omitted -->常用来部署<!-- raw HTML omitted --><code>RabbitMQ</code>集群、<code>Zookeeper</code>集群、<code>MySQL</code>集群、<code>Eureka</code>集群等</li>
<li><code>StatefulSet</code><!-- raw HTML omitted -->部署需要<!-- raw HTML omitted --><code>HeadLinessService</code>（无头服务）</li>
</ul>
<blockquote>
<ul>
<li>在用<code>Deployment</code>时，每一个<code>Pod</code>名称是没有顺序的，是随机字符串，因此是<code>Pod</code>名称是无序的，但是在<code>StatefulSet</code>中要求必须是有序 ，每一个<code>Pod</code>不能被随意取代，<code>Pod</code>重建后<code>pod</code>名称还是一样的</li>
<li>而<code>Pod IP</code>是变化的，所以是以<code>Pod</code>名称来识别。<code>Pod</code>名称是<code>Pod</code>唯一性的标识符，必须持久稳定有效。这时候要用到<!-- raw HTML omitted -->无头服务<!-- raw HTML omitted -->，它可以给每个<code>Pod</code>一个唯一的名称</li>
</ul>
</blockquote>
<ul>
<li><code>Deployment</code>和<code>StatefulSet</code>区别：<code>Deployment</code><!-- raw HTML omitted -->没有唯一标识而<!-- raw HTML omitted --><code>StatefulSet</code>有唯一标识</li>
<li><code>StatefulSet</code><!-- raw HTML omitted -->唯一标识生成规则<!-- raw HTML omitted -->：  根据主机名+一定规则生成的：<!-- raw HTML omitted -->主机名.无头<!-- raw HTML omitted --><code>Service</code>名称.命名空间<code>.svc.cluster.local</code></li>
<li><code>StatefulSet</code><!-- raw HTML omitted -->控制器支持两种更新策略<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>OnDelete</code>： <code>OnDelete</code><!-- raw HTML omitted -->表示删除之后才更新<!-- raw HTML omitted --></li>
<li>(默认)<code>RollingUpdate</code>：<code>RollingUpdate</code><!-- raw HTML omitted -->表示滚动更新<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/StatefulSet/kubernetes-statefulset-template.yaml" rel="external" target="_self"><code>Kubernetes StatefulSet Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">name</span>: <span style="color:#ae81ff">service-template</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">statefulset-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">clusterIP</span>: <span style="color:#ae81ff">None      </span> <span style="color:#75715e"># 将clusterIP设置为None，即可创建headliness Service</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP  	# 类型：NodePort</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>    <span style="color:#75715e"># Service的端口</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">80</span>      <span style="color:#75715e"># StatefulSet 的Pod端口</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">StatefulSet</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">statefulset-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">service-template  </span> <span style="color:#75715e"># 使用那个Service管理DNS</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">updateStrategy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate        </span> <span style="color:#75715e"># 滚动更新，OnDelete：删除更新</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>:      <span style="color:#75715e"># 如果更新的策略是OnDelete，那么rollingUpdate就失效</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">partition</span>: <span style="color:#ae81ff">2</span>      <span style="color:#75715e"># 表示从第2个分区开始更新，默认是0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">statefulset-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">statefulset-template</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="daemonsetds守护进程类型"><code>DaemonSet(ds)</code>守护进程类型</h3>
<blockquote>
<ul>
<li>
<p><code>DaemonSet</code><!-- raw HTML omitted -->：控制器可以保证集群中的每一台（或指定）节点上都运行一个副本，一般适用于日志(<code>elk</code>)收集、节点监控(<code>zabbix</code>)等场景。也就是说，<!-- raw HTML omitted -->如果一个<code>Pod</code>提供的功能是节点级别的（每个节点都需要且只需要一个），那么这类<code>Pod</code>就适合使用<code>DaemonSet</code>类型的控制器创建</p>
</li>
<li>
<p><code>DaemonSet</code><!-- raw HTML omitted -->控制器的特点<!-- raw HTML omitted --></p>
<p><!-- raw HTML omitted -->  每向集群中添加一个节点的时候，<!-- raw HTML omitted -->指定的<code>Pod</code>副本也将添加到该节点上</p>
<p><!-- raw HTML omitted -->当节点从集群中移除的时候，<!-- raw HTML omitted --><code>Pod</code>也会被垃圾回收</p>
</li>
<li>
<p><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/DaemonSet/kubernetes-daemonset-template.yaml" rel="external" target="_self"><code>Kubernetes DaemonSet Template</code>模板</a></p>
</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1  </span> <span style="color:#75715e"># 版本号</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">DaemonSet        </span> <span style="color:#75715e"># 类型</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:       <span style="color:#75715e"># 元数据</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fluentd-daemonset      </span> <span style="color:#75715e"># Pod 名称</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default   </span> <span style="color:#75715e"># 指定名称空间、默认default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:       <span style="color:#75715e"># 标签</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#39;fluentd-es&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:   <span style="color:#75715e"># Pod 详情描述</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">revisionHistoryLimit</span>: <span style="color:#ae81ff">3</span>       <span style="color:#75715e"># 保留历史版本、默认为最大值(2^32)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">updateStrategy</span>:       <span style="color:#75715e"># 更新策略</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate        </span> <span style="color:#75715e"># 滚动更新策略</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>:      <span style="color:#75715e"># 滚动更新</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">1</span>         <span style="color:#75715e"># 最大不可用状态的Pod的最大值，可用为百分比，也可以为整数</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:     <span style="color:#75715e"># 选择器，通过它指定该控制器管理那些Pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels:        # Labels匹配规则，matchExpressions</span>: <span style="color:#ae81ff">匹配规则</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#39;fluentd-es&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:     <span style="color:#75715e"># 模板，当副本数量不足时，会根据下面的模板创建Pod模板</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#39;fluentd-es&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fluentd-es</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">agilestacks/fluentd-elasticsearch:v1.3.0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">env</span>:    <span style="color:#75715e"># 环境变量配置</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">FLUENTD_ARGS   </span> <span style="color:#75715e"># 环境变量的 key</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">value</span>: -<span style="color:#ae81ff">qq   </span> <span style="color:#75715e"># 环境变量的 value</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">volumeMounts</span>:   <span style="color:#75715e"># 加载数据卷 避免数据丢失</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">containers     </span> <span style="color:#75715e"># 数据卷名称</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/lib/docker/containers        </span> <span style="color:#75715e"># 将数据卷挂载到容器内那个目录</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">varlog</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/log</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumes</span>:          <span style="color:#75715e"># 定义数据卷</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">containers       </span> <span style="color:#75715e"># 定义数据卷的名称</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">hostPath</span>:       <span style="color:#75715e"># 数据卷类型，主机路径模式</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/var/lib/docker/containers     </span> <span style="color:#75715e"># node 中共享目录</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">varlog</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">hostPath</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/var/log</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="service类型控制器"><code>Service</code>类型控制器</h3>
<blockquote>
<ul>
<li>在<code>kubernetes</code>中，<code>Pod</code>是应用程序的载体，我们可以通过<code>Pod</code>的<code>IP</code>来访问应用程序，但是<code>Pod</code>的<code>IP</code>地址不是固定的，这就意味着不方便直接采用<code>Pod</code>的<code>IP</code>对服务进行访问</li>
<li>为了解决这个问题，<code>kubernetes</code>提供了<code>Service</code>资源，<code>Service</code>会对提供同一个服务的多个<code>Pod</code>进行聚合，并且提供一个统一的入口地址，通过访问<code>Service</code>的入口地址就能访问到后面的<code>Pod</code>服务</li>
<li><code>Service</code>在很多情况下只是一个概念：真正起作用的其实是<code>kube-proxy</code>服务进程，每个<code>Node</code>节点上都运行了一个<code>kube-proxy</code>的服务进程。当创建<code>Service</code>的时候会通过<code>API Server</code>向<code>etcd</code>写入创建的Service的信息，而<code>kube-proxy</code>会基于监听的机制发现这种<code>Service</code>的变化，然后它会将最新的<code>Service</code>信息转换为对应的访问规则</li>
<li>假如：<code>10.97.97.97:80</code>是<code>service</code>提供的访问入口：当访问这个入口的时候，可以发现后面有三个<code>pod</code>的服务在等待调用，<code>kube-proxy</code>会基于<code>rr</code>（轮询）的策略，将请求分发到其中一个<code>pod</code>上去，这个规则会同时在集群内的所有节点上都生成，所以在任何一个节点上访问都可以</li>
<li><code>ClusterIP</code><!-- raw HTML omitted -->默认值：它是<code>kubernetes</code>系统自动分配的虚拟<code>IP</code>(<code>VIP</code>)，只能在集群内部（所有<code>Node</code>节点）访问<!-- raw HTML omitted --></li>
<li><code>NodePort</code><!-- raw HTML omitted -->：将<code>Service</code>通过指定的<code>Node</code>上的端口暴露给外部，通过此方法，就可以在集群外部访问（使用浏览器域名或<code>IP</code>端口访问）服务<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>创建的<code>Service</code>的<code>IP</code>地址只能在集群内部才可以访问，如果希望<code>Service</code>暴露给集群外部使用，那么就需要使用到另外一种类型的<code>Service</code>，称为<code>NodePort</code>类型的<code>Service</code>。<code>NodePort</code>的工作原理就是将<code>Service</code>的端口映射到<code>Node</code>的一个端口上，然后就可以通过<code>NodeIP:NodePort</code>来访问<code>Service</code>了</li>
</ul>
</blockquote>
<ul>
<li><code>LoadBalancer</code><!-- raw HTML omitted -->：使用外接负载均衡器完成到服务的负载分发，注意此模式需要外部云环境的支持<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code> LoadBalancer</code>和<code>NodePort</code>很相似，目的都是向外部暴露一个端口，区别在于<code>LoadBalancer</code>会在集群的外部再来做一个负载均衡设备，而这个设备需要外部环境的支持，外部服务发送到这个设备上的请求，会被设备负载之后转发到集群中</li>
</ul>
</blockquote>
<ul>
<li><code>ExternalName</code><!-- raw HTML omitted -->：把集群外部的服务引入集群内部，直接使用<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>ExternalName</code>类型的<code>Service</code>用于引入集群外部的服务，它通过<code>externalName</code>属性指定一个服务的地址，然后在集群内部访问此<code>Service</code>就可以访问到外部的服务了</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl explain service.spec.type  	<span style="color:#75715e"># </span></span></span></code></pre></div></blockquote>
<ul>
<li><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/Service/kubernetes-service-template.yaml" rel="external" target="_self"><code>Kubernetes Service Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1         </span> <span style="color:#75715e"># 版本</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service  </span> <span style="color:#75715e"># 类型</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:       <span style="color:#75715e"># 元数据</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">service-template       </span> <span style="color:#75715e"># Service 名字</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default   </span> <span style="color:#75715e"># 命名空间</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx        </span> <span style="color:#75715e"># Service 自己本身的标签</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:     <span style="color:#75715e"># 标签选择器，用于确定当前Service代理那些Pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-deploymen      </span> <span style="color:#75715e"># 所有匹配到这些标签的Pod 都可以进行访问</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">NodePort       </span> <span style="color:#75715e"># 指定Service的类型访问方式、ClusterIP、NodePort、ExternalName，NodePort支持集群外部访问，启用ingress设置：ClusterIP</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">externalName</span>: <span style="color:#ae81ff">www.baidu.com  </span> <span style="color:#75715e"># 改成IP地址也可以,只有type类型为：ExternalName，域名配置才生效</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">clusterIP</span>: <span style="color:#ae81ff">10.64.0.47</span>        <span style="color:#75715e"># 定service IP，不指定就随机生成，启用ingress设置为：None</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">sessionAffinity</span>: <span style="color:#ae81ff">None     </span> <span style="color:#75715e"># 分发策略、session亲和性，支持ClientIP、None两个选项，默认值为None</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:        <span style="color:#75715e"># 端口映射信息</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>          <span style="color:#75715e"># Service 端口，在使用内网IP访问时使用</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP      </span> <span style="color:#75715e"># 协议</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort </span>: <span style="color:#ae81ff">80</span>     <span style="color:#75715e"># 目标Pod端口，例如：deployment、statefulset等，Nginx：80，Tomcat：8080</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nodePort</span>: <span style="color:#ae81ff">30002</span>     <span style="color:#75715e"># 绑定到node主机上的端口(端口使用范围：30000~32767)，如果不指定，会默认分配，启用ingress删除此行</span></span></span></code></pre></div><ul>
<li><code>kube-proxy</code>目前支持的三种工作模式</li>
<li><code>userspace</code><!-- raw HTML omitted -->模式<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>userspace</code>模式下，<code>kube-proxy</code>会为每一个<code>Service</code>创建一个监听端口，发向<code>Cluster IP</code>的请求被<code>iptables</code>规则重定向到<code>kube-proxy</code>监听的端口上，<code>kube-proxy</code>根据<code>LB</code>算法（负载均衡算法）选择一个提供服务的<code>Pod</code>并和其建立连接，以便将请求转发到<code>Pod</code>上</li>
<li><code>userspace</code>模式下，<code>kube-proxy</code>充当了一个四层负载均衡器的角色。由于<code>kube-proxy</code>运行在<code>userspace</code>中，在进行转发处理的时候会增加内核和用户空间之间的数据拷贝，虽然比较稳定，但是效率非常低下</li>
</ul>
</blockquote>
<ul>
<li><code>iptables</code><!-- raw HTML omitted -->模式<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>iptables</code>模式下，<code>kube-proxy</code>为<code>Service</code>后端的每个<code>Pod</code>创建对应的<code>iptables</code>规则，直接将发向<code>Cluster IP</code>的请求重定向到一个<code>Pod</code>的<code>IP</code>上</li>
<li><code>iptables</code>模式下<code>kube-proxy</code>不承担四层负载均衡器的角色，只负责创建<code>iptables</code>规则。该模式的优点在于较<code>userspace</code>模式效率更高，但是不能提供灵活的<code>LB</code>策略，当后端<code>Pod</code>不可用的时候无法进行重试</li>
</ul>
</blockquote>
<ul>
<li><code>ipvs</code><!-- raw HTML omitted -->模式<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>
<p><code>ipvs</code>模式和<code>iptables</code>类似，<code>kube-proxy</code>监控<code>Pod</code>的变化并创建相应的<code>ipvs</code>规则。<code>ipvs</code>相对<code>iptables</code>转发效率更高，除此之外，<code>ipvs</code>支持更多的<code>LB</code>算法</p>
</li>
<li>
<p><code>ipvs</code><!-- raw HTML omitted -->的映射规则，<code>rr</code>表示轮询<!-- raw HTML omitted --></p>
</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ipvsadm -Ln  	<span style="color:#75715e"># 查看kube-proxy工作模式</span></span></span></code></pre></div></blockquote>
<ul>
<li>对<code>Service</code>的访问被分发到了后端的<code>Pod</code>上去，目前<code>kubernetes</code>提供了<!-- raw HTML omitted -->两种负载分发<!-- raw HTML omitted -->策略</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->默认使用<code>kube-proxy</code>的策略，比如随机、轮询等<!-- raw HTML omitted --></li>
<li><code>sessionAffinity</code>：基于客户端地址的会话保持模式，即来自同一个客户端发起的所有请求都会转发到固定的一个<code>Pod</code>上，这对于传统基于<code>Session</code>的认证项目来说很友好，此模式可以在<code>spec</code>中添加<code>sessionAffinity: ClusterIP</code>选项</li>
</ul>
</blockquote>
<ul>
<li><code>HeadLiness</code>类型负载均的<code>Service</code></li>
</ul>
<blockquote>
<ul>
<li>在某些场景中，开发人员可能不想使用<code>Service</code>提供的负载均衡功能，而希望自己来控制负载均衡策略，针对这种情况，<code>kubernetes</code>提供了<code>HeadLinesss Service</code>，这类<code>Service不</code>会分配<code>Cluster IP</code>，如果想要访问<code>Service</code>，只能通过<code>Service</code>的域名进行查询</li>
<li><code>clusterIP: None</code>：将<code>clusterIP</code>设置为<code>None</code>，即可创建<code>headliness Service</code></li>
</ul>
</blockquote>
</blockquote>
<hr>
<h3 id="endpoint类型控制器"><code>Endpoint</code>类型控制器</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->实际中使用的不多<!-- raw HTML omitted --></li>
<li><code>Endpoint</code>：是<code>kubernete</code>中的一个资源对象，存储在<code>etcd</code>中，用来记录一个<code>service</code>对应的所有<code>Pod</code>的访问地址，它是根据<code>service</code>配置文件中的<code>selector</code>描述产生的</li>
<li>一个<code>service</code>由一组<code>Pod</code>组成，这些<code>Pod</code>通过<code>Endpoints</code>暴露出来，<code>Endpoints</code>是实现实际服务的端点集合。换言之<code>servic</code>和<code>Pod</code>之间的联系是通过<code>Endpoints</code>实现的</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl describe svc nginx-service -n app  
</span></span><span style="display:flex;"><span>$ kubectl get endpoints -n dev -o wide  </span></span></code></pre></div><ul>
<li><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/EndPoint/kubernetes-endpoint-template.yaml" rel="external" target="_self"><code>Kubernetes Endpoint Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Endpoints</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">endpoints-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx        </span> <span style="color:#75715e"># 标签和Service 里的labels一致</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subsets</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">addresses</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">ip</span>: <span style="color:#ae81ff">23.41.187.94</span>    <span style="color:#75715e"># 目标IP地址</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:        <span style="color:#75715e"># 与 Service一致</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1         </span> <span style="color:#75715e"># 版本</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service  </span> <span style="color:#75715e"># 类型</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:       <span style="color:#75715e"># 元数据</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">service-template       </span> <span style="color:#75715e"># Service 名字</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default   </span> <span style="color:#75715e"># 命名空间</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx        </span> <span style="color:#75715e"># Service 自己本身的标签</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP       </span> <span style="color:#75715e"># 指定Service的类型访问方式、ClusterIP、NodePort、ExternalName</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">sessionAffinity</span>: <span style="color:#ae81ff">None        </span> <span style="color:#75715e"># 分发策略、session亲和性，支持ClientIP、None两个选项，默认值为None</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:        <span style="color:#75715e"># 端口映射信息</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>          <span style="color:#75715e"># Service 端口，在使用内网IP访问时使用</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP      </span> <span style="color:#75715e"># 协议</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort </span>: <span style="color:#ae81ff">80</span>     <span style="color:#75715e"># 目标Pod端口，例如：deployment、statefulset等</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="job类型控制器"><code>Job</code>类型控制器</h3>
<blockquote>
<ul>
<li><code>Job</code><!-- raw HTML omitted -->主要用于负责批量处理短暂的一次性任务<!-- raw HTML omitted --></li>
<li><code>Job</code><!-- raw HTML omitted -->特点<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>当<code>Job</code>创建的<code>Pod</code>执行成功结束时，<code>Job</code>将记录成功结束的<code>Pod</code>数量</li>
<li>当成功结束的<code>Pod</code>达到指定的数量时，<code>Job</code>将完成执行</li>
</ul>
</blockquote>
<ul>
<li><code>Job</code><!-- raw HTML omitted -->模板使用重启策略定义<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->设置为：<!-- raw HTML omitted --><code>OnFailure</code>，<code> Job</code>会在<code>Pod</code>出现故障的时候重启容器，而不是创建<code>Pod</code>，<code>failed</code>次数不变</li>
<li><!-- raw HTML omitted -->设置为：<!-- raw HTML omitted --><code>Never</code>，<code>Job</code>会在<code>Pod</code>出现故障的时候创建新的<code>Pod</code>，并且故障<code>Pod</code>不会消失也不会重启，<code>failed</code>次数+1</li>
<li><!-- raw HTML omitted -->设置为：<!-- raw HTML omitted --><code>Always</code>，意味<code>Job</code>一直重启，意味<code>Pod</code>任务会重复执行，这和<code>Job</code>的定义冲突，所以不能设置为<code>Always</code></li>
</ul>
</blockquote>
<ul>
<li><code>Job</code><!-- raw HTML omitted -->资源清单<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">batch/v1  	# 版本号</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Job  	# 类型</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:  	<span style="color:#75715e"># 元数据</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">name</span>: <span style="color:#ae81ff">job-template  	# 名称</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">namespace</span>:  <span style="color:#ae81ff">default  	# 命名空间</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">labels</span>:  	<span style="color:#75715e"># 标签</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">controller</span>: <span style="color:#ae81ff">job</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:  	<span style="color:#75715e"># 详情描述</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">completions</span>: <span style="color:#ae81ff">1</span>  	<span style="color:#75715e"># 指定Job需要成功运行Pod的总次数，默认为1</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">parallelism</span>: <span style="color:#ae81ff">1</span>  	<span style="color:#75715e"># 指定Job在任一时刻应该并发运行Pod的数量，默认为1</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">activeDeadlineSeconds</span>: <span style="color:#ae81ff">30</span>  	<span style="color:#75715e"># 指定Job可以运行的时间期限，超过时间还没结束，系统将会尝试进行终止</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">backoffLimit</span>: <span style="color:#ae81ff">6</span>  	<span style="color:#75715e"># 指定Job失败后进行重试的次数，默认为6</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">manualSelector</span>: <span style="color:#66d9ef">true</span>  	<span style="color:#75715e"># 是否可以使用selector选择器选择Pod，默认为false</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">selector</span>:  	<span style="color:#75715e"># 选择器，通过它指定该控制器管理那些Pod</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">matchLabels</span>:  	<span style="color:#75715e"># Labels匹配规则</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">app</span>: <span style="color:#ae81ff">counter-pod</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">matchExpressions</span>:  	<span style="color:#75715e"># Expressions匹配规则</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">app</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">In</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">values</span>:
</span></span><span style="display:flex;"><span>              - <span style="color:#ae81ff">counter-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">template</span>:  	<span style="color:#75715e"># 模板，当副本数量不足时，会根据下面的模板创建Pod模板</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">app</span>: <span style="color:#ae81ff">counter-pod</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">restartPolicy</span>: <span style="color:#ae81ff">Never  	# 重启策略只能设置为Never或OnFailure</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>                - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">counter</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;for i in 9 8 7 6 5 4 3 2 1;do echo $i;sleep 20;done&#34;</span>]</span></span></code></pre></div></blockquote>
<hr>
<h3 id="cronjob类型控制器"><code>CronJob</code>类型控制器</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted --><code>CronJob</code>控制器<!-- raw HTML omitted -->：以<code>Job</code>控制器为其管控对象，并借助它管理<code>Pod</code>资源对象，<code>Job</code>控制器定义的作业任务在其控制器资源创建之后便会立即执行，但<code>CronJob</code>可以以类似<code>Linux</code>操作系统的周期性任务作业计划的方式控制器运行时间点及重复运行的方式，换言之，<code>CronJob</code>可以在特定的时间点反复去执行<code>Job</code>任务</li>
<li><code>schedule：cron</code><!-- raw HTML omitted -->表达式，用于指定任务的执行时间<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>/1  *</code><!-- raw HTML omitted -->：表示分钟  小时  日  月份  星期<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->分钟值从<code>0</code>到<!-- raw HTML omitted --><code>59</code></li>
<li><!-- raw HTML omitted -->小时值从<code>0</code>到<!-- raw HTML omitted --><code>23</code></li>
<li><!-- raw HTML omitted -->日(天)的值从<code>1</code>到<!-- raw HTML omitted --><code>31</code></li>
<li><!-- raw HTML omitted -->月的值从<code>1</code>到<!-- raw HTML omitted --><code>12</code></li>
<li><!-- raw HTML omitted -->星期的值从<code>0</code>到<code>6</code>，<!-- raw HTML omitted --><code>0</code><!-- raw HTML omitted -->表示星期日<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->多个时间可以用逗号隔开，范围可以用连字符给出：* 可以作为通配符，/表示每&hellip;<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li><code>concurrencyPolicy</code><!-- raw HTML omitted -->并发执行策略<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>Allow</code><!-- raw HTML omitted -->：运行<code>Job</code>并发调度（默认）<!-- raw HTML omitted --></li>
<li><code>Forbid</code><!-- raw HTML omitted -->：禁止并发运行，如果之前的任务没完成，则跳过，直接执行新的<!-- raw HTML omitted --></li>
<li><code>Replace</code><!-- raw HTML omitted -->：替换，取消当前正在运行的作业并使用新作业替换它<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/kubernetes-cronjob-template.yaml" rel="external" target="_self"><code>Kubernetes CronJob Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">batch/v1   </span> <span style="color:#75715e"># 版本号</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">CronJob  </span> <span style="color:#75715e"># 类型</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:       <span style="color:#75715e"># 元数据</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cronjob-template       </span> <span style="color:#75715e"># 名称</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default   </span> <span style="color:#75715e"># 命名空间</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">controller</span>: <span style="color:#ae81ff">cronjob</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:   <span style="color:#75715e"># 详情描述</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">concurrencyPolicy</span>: <span style="color:#ae81ff">Allow   </span> <span style="color:#75715e"># 并发执行策略，Allow：并发调度，</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">failedJobsHistoryLimit</span>: <span style="color:#ae81ff">1</span>   <span style="color:#75715e"># 保留多少个失败的任务，默认为1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">successfulJobsHistoryLimit</span>: <span style="color:#ae81ff">3</span>   <span style="color:#75715e"># 保留多少个成功的任务，默认为3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># startingDeadlineSeconds: 30   # 间隔多长时间检测失败的任务并重新执行，时间不能小于：10</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">suspend</span>: <span style="color:#66d9ef">false</span>    <span style="color:#75715e"># 是否挂起任务，若为：true 则该任务不执行</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">schedule</span>: <span style="color:#e6db74">&#34;*/1 * * * * &#34;</span>    <span style="color:#75715e"># cron格式的作业调度运行时间点，用于控制任务任务时间执行</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">jobTemplate</span>:          <span style="color:#75715e"># job控制器模板，用于为cronjob控制器生成job对象，下面其实就是job的定义</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">completions</span>: <span style="color:#ae81ff">1</span>    <span style="color:#75715e"># 指定Job需要成功运行Pod的总次数，默认为1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">parallelism</span>: <span style="color:#ae81ff">1</span>    <span style="color:#75715e"># 指定Job在任一时刻应该并发运行Pod的数量，默认为1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">activeDeadlineSeconds</span>: <span style="color:#ae81ff">30</span>         <span style="color:#75715e"># 指定Job可以运行的时间期限，超过时间还没结束，系统将会尝试进行终止</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">backoffLimit</span>: <span style="color:#ae81ff">6</span>   <span style="color:#75715e"># 指定Job失败后进行重试的次数，默认为6</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">template</span>:         <span style="color:#75715e"># 模板，当副本数量不足时，会根据下面的模板创建Pod模板</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">restartPolicy</span>: <span style="color:#ae81ff">Never         </span> <span style="color:#75715e"># 重启策略只能设置为Never或OnFailure</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">container-name</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">command</span>: [ <span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;for i in 9 8 7 6 5 4 3 2 1;do echo $i;sleep 20;done&#34;</span> ]</span></span></code></pre></div></blockquote>
<hr>
<h3 id="模板详细描述">模板详细描述</h3>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/bitnami/" rel="external" target="_self"><code>Bitnami</code>模板库</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/bitnami/charts/tree/main/bitnami" rel="external" target="_self"><code>Kubernetes</code>的<code>Bitnami</code>库</a></td>
<td><code>Helm</code>安装<code>Kubernetes</code>服务<code>Zabbix</code>、<code>Redis</code>、<code>Mysql</code>模板</td>
</tr>
<tr>
<td><a href="https://github.com/bitnami/charts-docs/tree/main/charts" rel="external" target="_self"><code>Kubernetes</code>的<code>Charts-docs</code>库</a></td>
<td><code>Helm</code>安装<code>Kubernetes</code>服务<code>Zabbix</code>、<code>Redis</code>、<code>Mysql</code>模板</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/kubernetes-template.yaml" rel="external" target="_self"><code>Kubernetes Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1   </span> <span style="color:#75715e"># 版本号，例如v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment   </span> <span style="color:#75715e"># 资源类型，例如 Pod、Deployment、Service、ReplicaSet、StatefulSet</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:   <span style="color:#75715e"># POd相关的元数据，用于描述Pod数据</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">java-demo  </span> <span style="color:#75715e"># Pod名称、在同一个名称空间内不能重复</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">string  </span> <span style="color:#75715e"># Pod所属的命名空间,默认为&#34;default&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:   <span style="color:#75715e"># 定义Pod的标签，只能使用字符串类型：string</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">java-demo  </span> <span style="color:#75715e"># 自定义label标签，key(键)为：name，value(值)为：java-demo</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v1.1.0  </span> <span style="color:#75715e"># 自定义版本</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">annotations</span>:    <span style="color:#75715e"># 注释，不能作为被筛选</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">java-demo</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:   <span style="color:#75715e"># Pod中容器的详细定义</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>   <span style="color:#75715e"># 创建的副本数量</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">revisionHistoryLimit</span>: <span style="color:#ae81ff">10</span>    <span style="color:#75715e"># 滚动更新后保留的历史版本数</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:   <span style="color:#75715e"># 选择器，用于找到匹配的 ReplicaSet(副本)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:    <span style="color:#75715e"># 按照Labels标签匹配副本</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">java-demo  </span> <span style="color:#75715e"># 匹配的key，value</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v1.1.0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">strategy</span>:   <span style="color:#75715e"># 更新策略，StatefulSet更新使用：updateStrategy</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>:    <span style="color:#75715e"># 滚动更新配置</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">partition</span>: <span style="color:#ae81ff">3</span>    <span style="color:#75715e"># 实现灰度/金丝雀发布，按序号更新，更新大于等于3的序号，不和百分比共用</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxSurge</span>: <span style="color:#ae81ff">25</span><span style="color:#ae81ff">%  </span> <span style="color:#75715e"># 多少个/百分之多少Pods处于更新，数值越大更新越快，不稳定</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">25</span><span style="color:#ae81ff">%  </span> <span style="color:#75715e"># 多少个/百分之多少Pods处于关闭，数值越小更新慢，稳定</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate  </span> <span style="color:#75715e"># 更新类型选择器，采用滚动更新，OnDelete：方式更新，删除pods时更新</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:   <span style="color:#75715e"># Pod 模板</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:   <span style="color:#75715e"># Pod 的元信息</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:   <span style="color:#75715e"># Pod 的标签 </span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">java-demo</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v1.1.0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:   <span style="color:#75715e"># Pod的期望信息</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nodeName</span>: <span style="color:#ae81ff">k8s-node1  </span> <span style="color:#75715e"># 设置NodeName表示将该Pod调度到指定到名称的node节点上</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nodeSelector</span>: <span style="color:#ae81ff">obeject  </span> <span style="color:#75715e"># 设置NodeSelector表示将该Pod调度到包含这个label的node上</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">hostNetwork</span>: <span style="color:#66d9ef">false</span>    <span style="color:#75715e"># 是否使用主机网络模式，默认为false，如果设置为true，表示使用宿主机网络</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">tolerations</span>:  	<span style="color:#75715e"># 容忍配置</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">effect</span>: <span style="color:#e6db74">&#34;污点的类型&#34;</span>  <span style="color:#75715e"># Noschedule</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">key</span>: <span style="color:#e6db74">&#34;污点的Key&#34;</span>  	<span style="color:#75715e"># 污点的Key</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">operate</span>: <span style="color:#e6db74">&#34;Equal&#34;</span>  	<span style="color:#75715e"># Exists：匹配Key，Equal添加：value配置，</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;污点的value&#34;</span>  	<span style="color:#75715e"># 污点的value</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullSecrets</span>:   <span style="color:#75715e"># 配置登录 docker registry 的 secret 仓库</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">docker-harbor  </span> <span style="color:#75715e"># 指定使用的secret库房名称</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:   <span style="color:#75715e"># 对于 Pod中容器描述</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">tomcat-demo  </span> <span style="color:#75715e"># 指定容器名称，不可更新</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">192.168.80.210</span>:<span style="color:#ae81ff">8080</span><span style="color:#ae81ff">/test/tomcat-demo:v1   </span> <span style="color:#75715e"># 镜像仓库地址</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">imagePullPolicy</span>: [ <span style="color:#ae81ff">Always | Never | IfNotPresent ]   </span> <span style="color:#75715e"># 镜像拉取方式</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">command</span>: [<span style="color:#ae81ff">string]  </span> <span style="color:#75715e"># 以数组方式指定容器启动命令列表，如不指定，使用打包时使用的启动命令</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">args</span>:   <span style="color:#75715e"># 以数组方式指定容器启动命令参数列表，替代docker的CMD指令</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">/bin/sh</span>
</span></span><span style="display:flex;"><span>        - -<span style="color:#ae81ff">c</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">touch /tmp/healthy; sleep 30; rm -fr /tmp/healthy; sleep 600   </span> <span style="color:#75715e"># 不能超过探针执行时间</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">workingDir</span>: <span style="color:#ae81ff">string   </span> <span style="color:#75715e"># 容器启动后进入的工作目录，不指定则使用镜像默认值</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">volumeMounts</span>:   <span style="color:#75715e"># 挂载到容器内部的存储卷配置</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">data   </span> <span style="color:#75715e"># 引用pod定义的共享存储卷的名称，需用volumes[]部分定义的的卷名</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/opt/data   </span> <span style="color:#75715e"># 存储卷在容器内mount的绝对路径，应少于512字符</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">readOnly</span>: <span style="color:#ae81ff">boolean  </span> <span style="color:#75715e"># 是否为只读模式</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:    <span style="color:#75715e"># 需要暴露的端口库号列表</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http   </span> <span style="color:#75715e"># 为端口取名，该名称可以在service种被引用</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">int   </span> <span style="color:#75715e"># 容器需要监听的端口号</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">hostPort</span>: <span style="color:#ae81ff">int  </span> <span style="color:#75715e"># 容器所在主机需要监听的端口号，默认与Container相同</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP  </span> <span style="color:#75715e"># 端口协议，支持TCP和UDP，默认TCP</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">80</span>    <span style="color:#75715e"># Pod 本身服务端口，比如Nginx：80，Tomcat：8080</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">nodePort</span>: <span style="color:#ae81ff">30001</span>   <span style="color:#75715e"># 节点对外端口</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">env</span>:    <span style="color:#75715e"># 容器运行前需设置的环境变量列表</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">JAVA_OPTS  </span> <span style="color:#75715e"># 环境变量名称</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;-Xmx1g&#34;</span>   <span style="color:#75715e"># 环境变量的值</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">resources</span>:    <span style="color:#75715e"># 资源限制和请求的设置</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">limits</span>:   <span style="color:#75715e"># 限定Pod最大使用硬件资源、通常设置cpu和memory</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#e6db74">&#34;1&#34;</span>    <span style="color:#75715e"># Cpu的限制，单位为core数，将用于docker run --cpu-shares参数，1000m等于一个核心</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#e6db74">&#34;1Gi&#34;</span>   <span style="color:#75715e"># 内存限制，单位可以为Mib/Gib，将用于docker run --memory参数</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">requests</span>:   <span style="color:#75715e"># 最低资源要求，在scheduler中被用到，通常设置cpu和memory</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#e6db74">&#34;0.5&#34;</span>    <span style="color:#75715e"># 限定使用几个核心CPU、容器启动的初始可用数量</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#e6db74">&#34;256Mi&#34;</span>   <span style="color:#75715e"># 设定使用内存、容器启动的初始可用数量</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">lifecycle</span>:    <span style="color:#75715e"># 生命周期钩子</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">postStart</span>:    <span style="color:#75715e"># 容器启动后立即执行此钩子,如果执行失败,会根据重启策略进行重启</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">exec</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;echo Hello from the postStart handler &gt;/usr/share/message&#34;</span>]
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">preStop</span>:    <span style="color:#75715e"># 容器终止前执行此钩子,无论结果如何,容器都会终止</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">exec</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;nginx -s quit; while killall -0 nginx; do sleep 1; done&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">startupProbe</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">tcpSocket</span>:    <span style="color:#75715e"># 使用TcpSocket、httpGet健康检查</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8010</span>    <span style="color:#75715e"># 探测8010端口</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">5</span>   <span style="color:#75715e"># 检测失败5次表示未就绪</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">60</span>   <span style="color:#75715e"># 指定容器启动60s之后开始执行Liveness探测，</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>   <span style="color:#75715e"># 指定每10秒执行一次Liveness探测。</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>   <span style="color:#75715e"># 检查成功为2次表示就绪</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span>   <span style="color:#75715e"># 检测失败1次表示未就绪</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">livenessProbe</span>:    <span style="color:#75715e"># 对Pod内各容器健康检查的设置，当探测无响应几次后将自动重启该容器</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">exec</span>:   <span style="color:#75715e"># 对Pod容器内检查方式设置为exec方式</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">command</span>:    <span style="color:#75715e"># exec方式需要制定的命令或脚本</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">sh</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">c</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#e6db74">&#34;sleep 5; echo &#39;success&#39;;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">httpGet</span>:    <span style="color:#75715e"># 对Pod内个容器健康检查方法设置为HttpGet，需要制定Path、port</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/  </span> <span style="color:#75715e"># URI地址：http://:80/index.html</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8010</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">host</span>: <span style="color:#ae81ff">192.168.109.100</span>   <span style="color:#75715e"># 主机地址</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTP   </span> <span style="color:#75715e"># 支持的协议，http或者https</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">HttpHeaders</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">string</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">value</span>: <span style="color:#ae81ff">string(字符串)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">tcpSocket</span>:    <span style="color:#75715e"># 对Pod内个容器健康检查方式设置为tcpSocket方式</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8010</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">60</span>   <span style="color:#75715e"># 容器启动完成后首次探测的时间，单位为秒</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span>   <span style="color:#75715e"># 对容器健康检查探测等待响应的超时时间，单位秒，默认1秒</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>   <span style="color:#75715e"># 对容器监控检查的定期探测时间设置，单位秒，默认10秒一次</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>   <span style="color:#75715e"># 配置为：1，表示检查一次成功就成功，配置为：3，表示检查3次</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">5</span>   <span style="color:#75715e"># 失败次数，检查5次失败表示失败</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">securityContext</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">privileged</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">restartPolicy</span>: [<span style="color:#ae81ff">Always | Never | OnFailure]  </span> <span style="color:#75715e"># Pod的重启策略</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">terminationGracePeriodSeconds</span>: <span style="color:#ae81ff">30</span>   <span style="color:#75715e"># 删除pods、deployment后等待时间</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumes</span>:    <span style="color:#75715e"># 在该pod上定义共享存储卷列表</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume  </span> <span style="color:#75715e"># 共享存储卷名称 （volumes类型有很多种）</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">emptyDir</span>: {}    <span style="color:#75715e"># 类型为emtyDir的存储卷，与Pod同生命周期的一个临时目录。为空值</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">hostPath</span>:   <span style="color:#75715e"># 类型为hostPath的存储卷，表示挂载Pod所在宿主机的目录</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/root/logs   </span> <span style="color:#75715e"># Pod所在宿主机的目录，将被用于同期中mount的目录</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">type</span>: <span style="color:#ae81ff">DirectoryOrCreate  </span> <span style="color:#75715e"># 目录存在就使用，不存在就先创建再使用</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">secret</span>:   <span style="color:#75715e"># 类型为secret的存储卷，挂载集群与定义的secret对象到容器内部</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">scretname</span>: <span style="color:#ae81ff">secret</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">items</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">string</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">configMap</span>:    <span style="color:#75715e"># 类型为configMap的存储卷，挂载预定义的configMap对象到容器内部</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">configmap</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">items</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">string</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">string</span></span></span></code></pre></div></blockquote>
<hr>
<h4 id="编写适用java的yaml">编写适用<code>Java</code>的<code>yaml</code></h4>
<ul>
<li>
<ol>
<li>下载<code>java demo</code>代码</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git clone https://github.com/frankinbj/tomcat-java-demo.git     </span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->修改连接数据库配置文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;tomcat-java-demo/src/main/resources/application.yml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">datasource:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    url: jdbc:mysql://192.168.80.215:3306/test?characterEncoding=utf-8
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    username: admin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    password: admin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li>打包<code>java war</code>包</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /opt/tomcat-java-demo/
</span></span><span style="display:flex;"><span>$ mvn clean package -Dmaven.test.skip<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成war包</span>
</span></span><span style="display:flex;"><span>$ ll /opt/tomcat-java-demo/target/ly-simple-tomcat-0.0.1-SNAPSHOT.war</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->把数据导入数据库，创建授权连接用户<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mysql -uroot -p &lt; tomcat-java-demo/doc/db/tables_ly_tomcat.sql
</span></span><span style="display:flex;"><span>$ grant all privileges on *.* to admin@<span style="color:#e6db74">&#39;%&#39;</span> identified by <span style="color:#e6db74">&#39;admin&#39;</span>;</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><code>JDK</code>、<code>Maven</code><!-- raw HTML omitted -->配置环境变量<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;#####  	JDK 環境變數  	#####
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export JAVA_HOME=/usr/local/jdk
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export JRE_HOME=</span><span style="color:#e6db74">${</span>JAVA_HOME<span style="color:#e6db74">}</span><span style="color:#e6db74">/jre
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export CLASSPATH=</span><span style="color:#e6db74">${</span>JAVA_HOME<span style="color:#e6db74">}</span><span style="color:#e6db74">/lib:</span><span style="color:#e6db74">${</span>JAVA_HOME<span style="color:#e6db74">}</span><span style="color:#e6db74">/lib/tools.jar
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export PATH=</span><span style="color:#e6db74">${</span>PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">:</span><span style="color:#e6db74">${</span>JAVA_HOME<span style="color:#e6db74">}</span><span style="color:#e6db74">/bin:</span><span style="color:#e6db74">${</span>JAVA_HOME<span style="color:#e6db74">}</span><span style="color:#e6db74">/jre/bin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export PATH=</span><span style="color:#e6db74">${</span>PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">:/usr/local/maven/bin &#34;</span>&gt;&gt;/etc/profile</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="6">
<li>修改<code>Dockerfile</code>配置文件，<code>docker build</code>成镜像</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>6.1 使用<code>Tomcat</code>服务打包启动容器</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/tomcat-java-demo/Dockerfile<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">FROM lizhenliang/tomcat
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">RUN rm -rf /usr/local/tomcat/webapps/*
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ADD target/*.war /usr/local/tomcat/webapps/ROOT.war
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 声明时区
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">RUN ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp; echo &#39;Asia/Shanghai&#39; &gt;/etc/timezone
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li>6.2 使用<code>java -jar</code><!-- raw HTML omitted -->打包镜像，可以使用<!-- raw HTML omitted --><code>xxl-job</code>的<code>jar</code>包</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> openjdk</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">VOLUME</span><span style="color:#e6db74"> /tmp</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> ./target/live-server-1.0.0-SNAPSHOT.jar live-server-1.0.0-SNAPSHOT.jar<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> bash -c <span style="color:#e6db74">&#34;touch /live-server-1.0.0-SNAPSHOT.jar&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># 声明时区</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime <span style="color:#f92672">&amp;&amp;</span> echo <span style="color:#e6db74">&#39;Asia/Shanghai&#39;</span> &gt;/etc/timezone<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># 声明运行时容器提供服务端口，运行时不会开启这个端口的服务，需要把端口映射</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 8080</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [<span style="color:#e6db74">&#34;java&#34;</span>,<span style="color:#e6db74">&#34;-jar&#34;</span>,<span style="color:#e6db74">&#34;/live-server-1.0.0-SNAPSHOT.jar&#34;</span>]</span></span></code></pre></div><ul>
<li>6.3 生成<code>docker images：</code>镜像并推送到私人仓库</li>
</ul>
<blockquote>
<ul>
<li>
<p><code>-t,--tag list</code>：镜像名称</p>
</li>
<li>
<p><code>-f，--file string</code>：如果文件名不是<code>Dockerfile</code>，<code>-f</code>可以指定其他文件</p>
</li>
<li>
<p><code>192.168.80.210:8080</code>：私人仓库地址</p>
</li>
<li>
<p><code>test</code>：私人仓库名</p>
</li>
<li>
<p><code>tomcat-demo:v1</code>：定义镜像名称以及版本</p>
</li>
<li>
<p>如果打包报错：<code>epository does not exist,</code>更换<code>Dockerfile</code>的<code>FROM</code>源地址</p>
</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /opt/tomcat-java-demo/
</span></span><span style="display:flex;"><span>$ docker build -t 192.168.80.210:8080/test/tomcat-demo:v1 .  	<span style="color:#75715e"># 打包镜像</span>
</span></span><span style="display:flex;"><span>$ docker push 192.168.80.210:8080/test/tomcat-demo:v1  	<span style="color:#75715e"># 推送到私人仓库 </span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h4 id="部署elk日志服务">部署<code>ELK</code>日志服务</h4>
<blockquote>
<ul>
<li><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/devops/Logs/kubernetes-elasticsearch.yaml" rel="external" target="_self"><code>Kubernetes Elasticsearch Template</code>模板</a></li>
<li><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/devops/Logs/kubernetes-logstash.yaml" rel="external" target="_self"><code>Kubernetes Logstash Template</code>模板</a></li>
<li><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/devops/Logs/kubernetes-filebeat.yaml" rel="external" target="_self"><code>Kubernetes Filebeat Template</code>模板</a></li>
<li><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/devops/Logs/kubernetes-kibana.yaml" rel="external" target="_self"><code>Kubernetes Kibana Template</code>模板</a></li>
</ul>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="kubernetes_command">Kubernetes_Command</h1>

<h1 id="kubernetes命令使用"><code>Kubernetes</code>命令使用</h1>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands" rel="external" target="_self"><code>Kubernetes</code>官方命令文档</a></td>
<td><code>Kubernetes</code>官方文档详解</td>
</tr>
<tr>
<td><a href="https://github.com/cloudnativelabs/kube-shell" rel="external" target="_self"><code>Kube-shell</code></a></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p><a href="#R-image-f6426c44ee62733d330c84724ff2075a" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/14d359426542433e871819e0de267de1.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-f6426c44ee62733d330c84724ff2075a"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/14d359426542433e871819e0de267de1.png"></a></p>
</blockquote>
<h2 id="kubectl获取资源名称使用命令"><code>kubectl</code>获取资源名称、使用命令</h2>
<blockquote>
<ul>
<li><code>kubectl</code><!-- raw HTML omitted -->是<!-- raw HTML omitted --><code>kubernetes</code><!-- raw HTML omitted -->集群的命令行工具，通过它能够对集群本身进行管理，并能够在集群上进行容器化应用的安装和部署<!-- raw HTML omitted --></li>
<li><code>kubectl api-resources</code><!-- raw HTML omitted -->是查看<!-- raw HTML omitted --><code>kubernetes</code><!-- raw HTML omitted -->资源命令<!-- raw HTML omitted --></li>
<li><code>Kubernetes</code><!-- raw HTML omitted -->中所有的内容都抽象为资源，所有命令都是围绕资源操作、执行<!-- raw HTML omitted --></li>
</ul>
<table>
<thead>
<tr>
<th>资源分类</th>
<th>资源名称</th>
<th>缩写</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>集群级别资源</td>
<td><code>nodes</code></td>
<td><code>no</code></td>
<td>集群组成部分</td>
</tr>
<tr>
<td>集群级别资源</td>
<td><code>namespaces</code></td>
<td><code>ns</code></td>
<td>隔离<code>Pod</code></td>
</tr>
<tr>
<td><code>Pods</code></td>
<td><code>Pods</code></td>
<td><code>po</code></td>
<td>装载容器</td>
</tr>
<tr>
<td><code>Pod</code>资源控制器</td>
<td><code>replicationcontrollers</code></td>
<td><code>rc</code></td>
<td>比较原始的<code>Pod</code>控制器，已经被废弃，由<code>ReplicaSet</code>替代</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>replicasets</code></td>
<td><code>rs</code></td>
<td>保证指定数量的<code>Pod</code>运行，并支持<code>Pod</code>数量变更，镜像版本变更</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>deployments</code></td>
<td><code>deploy</code></td>
<td>通过控制<code>ReplicaSet</code>来控制<code>Pod</code>，并支持滚动升级、版本回退</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>daemonsets</code></td>
<td><code>ds</code></td>
<td>在集群中的指定<code>Node</code>上都运行一个副本，一般用于守护进程类的任务</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>jobs</code></td>
<td>&mdash;</td>
<td>它创建出来的<code>Pod</code>只要完成任务就立即退出，用于执行一次性任务</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>cronjobs</code></td>
<td><code>cj</code></td>
<td>它创建的<code>Pod</code>会周期性的执行，用于执行周期性的任务</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>horizontalpodautoscalers</code></td>
<td><code>hpa</code></td>
<td>可以根据集群负载自动调整<code>Pod</code>的数量，实现削峰填谷</td>
</tr>
<tr>
<td><code>Pod</code>资源控制器</td>
<td><code>statefulsets</code></td>
<td><code>sts</code></td>
<td>管理有状态的应用</td>
</tr>
<tr>
<td>服务发现资源</td>
<td><code>services</code></td>
<td><code>svc</code></td>
<td>统一<code>Pod</code>对外接口</td>
</tr>
<tr>
<td>服务发现资源</td>
<td><code>ingress</code></td>
<td><code>ing</code></td>
<td>统一<code>Pod</code>对外接口</td>
</tr>
<tr>
<td>存储资源</td>
<td><code>volumeattachments</code></td>
<td>&mdash;</td>
<td>存储</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>persistentvolumes</code></td>
<td><code>pv</code></td>
<td>存储</td>
</tr>
<tr>
<td>存储资源</td>
<td><code>persistentvolumeclaims</code></td>
<td><code>pvc</code></td>
<td>存储</td>
</tr>
<tr>
<td>配置资源</td>
<td><code>configmaps</code></td>
<td><code>cm</code></td>
<td>配置</td>
</tr>
<tr>
<td>配置资源</td>
<td><code>secrets</code></td>
<td>&mdash;</td>
<td>配置</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th><strong>常用命令</strong></th>
<th>命令</th>
<th>翻译</th>
<th>命令作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>&mdash;</td>
<td><code>run</code></td>
<td>运行</td>
<td>在集群中运行一个指定的镜像</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>get</code></td>
<td>获取</td>
<td>获取显示一个或多个资源</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>set</code></td>
<td>设置</td>
<td>设置一个对象的特定特征</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>create</code></td>
<td>创建</td>
<td>从文件或标准输入创建资源</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>edit</code></td>
<td>编辑</td>
<td>编辑服务器上的资源</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>patch</code></td>
<td>更新</td>
<td>更新一个资源，更新资源的字段</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>apply</code></td>
<td>应用</td>
<td>通过文件名或标准输入将配置应用于资源</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>replace</code></td>
<td>替换</td>
<td>用文件名或标准输入替换资源</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>delete</code></td>
<td>删除</td>
<td><code>delete</code>按文件名、标准输入、资源和名称，或按资源和标签选择器删除资源</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>api-resources</code></td>
<td>&mdash;</td>
<td>打印服务器上支持的<code>API</code>资源</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>api-versions</code></td>
<td>&mdash;</td>
<td>打印服务器上支持的<code>API</code>版本，格式为<code>group/version</code></td>
</tr>
<tr>
<td><strong>常用命令</strong></td>
<td><code>version</code></td>
<td>版本</td>
<td>打印客户端和服务器版本信息</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th><strong>中级命令</strong></th>
<th>命令</th>
<th>翻译</th>
<th>命令作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>&mdash;</td>
<td><code>cp</code></td>
<td>复制</td>
<td>在<code>Pod</code>内外复制文件</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>exec</code></td>
<td>执行</td>
<td>在容器中执行命令</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>label</code></td>
<td>标签</td>
<td>更新资源上的标签</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>logs</code></td>
<td>日志</td>
<td>打印<code>pod</code>中容器的日志</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>attach</code></td>
<td>缠绕</td>
<td>进入运行中的容器、附加到正在运行的容器</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>describe</code></td>
<td>描述</td>
<td><code>describe</code>显示特定资源或资源组的详细信息</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>expose</code></td>
<td>暴露</td>
<td>将复制控制器、服务、部署或<code>pod</code>暴露为新的<code>Kubernetes</code>服务<code>Service</code></td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>explain</code></td>
<td>解释</td>
<td>展示资源类型、属性文档，获取资源控制器字段使用</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>annotate</code></td>
<td>注释</td>
<td>更新资源上的注释</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>rollout</code></td>
<td>首次展示</td>
<td>管理资源的发布，查看、更新<code>Pods</code>版本发布</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>scale</code></td>
<td>手动扩容、缩容</td>
<td>扩(缩)容<code>Pod</code>的数量,为<code>Deployment</code>、<!-- raw HTML omitted --><code>ReplicaSet</code>或<!-- raw HTML omitted --><code>Replication</code> <code>Controller</code>设置新的大小</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>autoscale</code></td>
<td>监控<code>CPU</code>、内存自动扩容、缩容</td>
<td>自动调整<code>Pod</code>的数量，自动缩放<code>Deployment</code>、<!-- raw HTML omitted --><code>ReplicaSet</code>、<code>StatefulSet</code>或<code>ReplicationController</code></td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>plugin</code></td>
<td>&mdash;</td>
<td>提供与插件交互的实用程序</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>taint</code></td>
<td>污点</td>
<td><code>taint</code>节点上设置污点</td>
</tr>
<tr>
<td><strong>中级命令</strong></td>
<td><code>config</code></td>
<td>&mdash;</td>
<td>修改<code>kubeconfig</code>文件</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th><strong>高级命令</strong></th>
<th>命令</th>
<th>翻译</th>
<th>命令作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>&mdash;</td>
<td><code>top</code></td>
<td></td>
<td>顶部显示资源（<code>CPU</code>/内存）使用情况</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>auth</code></td>
<td></td>
<td>检查授权</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>diff</code></td>
<td>对比</td>
<td>对比实时版本与将要应用的版本之间的差异</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>wait</code></td>
<td>等待</td>
<td>等待实验：等待一个或多个资源的特定条件</td>
</tr>
<tr>
<td></td>
<td><code>proxy</code></td>
<td>代理</td>
<td>运行到<code>Kubernetes API</code>服务器的代理</td>
</tr>
<tr>
<td></td>
<td><code>cordon</code></td>
<td>警戒线</td>
<td>警戒线 将节点标记为不可调度</td>
</tr>
<tr>
<td></td>
<td><code>uncordon</code></td>
<td></td>
<td><code>uncordon</code>将节点标记为可调度</td>
</tr>
<tr>
<td></td>
<td><code>drain</code></td>
<td>排水</td>
<td>排水节点准备维护</td>
</tr>
<tr>
<td></td>
<td><code>completion</code></td>
<td></td>
<td>完成输出指定<code>shell</code>的<code>shell</code>完成代码（<code>bash</code>或<code>zsh</code>）</td>
</tr>
<tr>
<td></td>
<td><code>certificate</code></td>
<td>证书</td>
<td>修改证书资源</td>
</tr>
<tr>
<td></td>
<td><code>cluster-info</code></td>
<td>集群信息</td>
<td>显示集群信息</td>
</tr>
<tr>
<td></td>
<td><code>port-forward</code></td>
<td>转发</td>
<td>将一个或多个本地端口转发到一个<code>pod</code></td>
</tr>
<tr>
<td></td>
<td><code>debug</code></td>
<td>调试</td>
<td>创建调试会话以对工作负载和节点进行故障排除</td>
</tr>
<tr>
<td><strong>高级命令</strong></td>
<td><code>kustomize</code></td>
<td></td>
<td>从目录或<code>URL</code>构建一个<code>kustomization</code>目标</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>品控级别(Track)</th>
<th>日期、时间</th>
<th>&mdash;</th>
</tr>
</thead>
<tbody>
<tr>
<td>每天</td>
<td><code>daily</code></td>
<td>&mdash;</td>
</tr>
<tr>
<td>每周</td>
<td><code>weekly</code></td>
<td>&mdash;</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h3 id="span-id常用命令常用命令创建删除span"><!-- raw HTML omitted -->常用命令：创建、删除<!-- raw HTML omitted --></h3>
<blockquote>
<ul>
<li><code>kubectl --help</code><!-- raw HTML omitted -->：可以通过<code>--help</code>查看详细的操作命令<!-- raw HTML omitted --></li>
<li><code>kubectl</code><!-- raw HTML omitted -->命令的语法如下<!-- raw HTML omitted --><code>$ kubectl [command] [type] [name] [flags]</code></li>
</ul>
<blockquote>
<ul>
<li><code>command</code>:	<!-- raw HTML omitted -->指定要对资源执行的操作，比如：<!-- raw HTML omitted --><code>create</code>、<code>get</code>、<code>delete</code></li>
<li><code>type</code>：<!-- raw HTML omitted -->指定资源的类型，比如：<!-- raw HTML omitted --><code>deployment</code>、<code>pod</code>、<code>service</code></li>
<li><code>name</code>： <!-- raw HTML omitted -->指定资源的名称，名称大小写敏感 <!-- raw HTML omitted --></li>
<li><code>flags</code>： <!-- raw HTML omitted -->指定额外的可选参数<!-- raw HTML omitted --></li>
</ul>
</blockquote>
</blockquote>
<ul>
<li>
<ol>
<li><code>kubectl run --help</code><!-- raw HTML omitted -->：命令使用镜像创建容器 <!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl run nginx --image<span style="color:#f92672">=</span>nginx:1.17.1 -n web</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><code>kubectl get --help</code><!-- raw HTML omitted -->：获取资源，选择输出的格式<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>3.1 <!-- raw HTML omitted --><code>-o wide</code><!-- raw HTML omitted --></li>
<li>3.2 <!-- raw HTML omitted --><code>-o json</code><!-- raw HTML omitted --></li>
<li>3.3 <!-- raw HTML omitted --><code>-o yaml</code><!-- raw HTML omitted --></li>
<li>3.4 <code>Service</code><!-- raw HTML omitted -->可以看做是一组同类的<code>Pod</code>对外的访问接口，借助<code>Service</code>，应用可以方便的实现服务发现和负载均衡<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl get csr  	<span style="color:#75715e"># 查看申请加入kubernetes集群的token信息</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl get endpoints  	<span style="color:#75715e"># 获取service对应的所有pod的访问地址</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl get all --namespace<span style="color:#f92672">=</span>kube-system  	<span style="color:#75715e"># 查看所有namespace下所有资源</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl get pods -n web -o wide -w  	<span style="color:#75715e"># 查看namespace web下的pod，-o wide:查看更多信息，-w：动态查看</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用kubectl get命令导出yaml文件</span>
</span></span><span style="display:flex;"><span>$ kubectl get pod coredns-558bd4d5db-9h55s  -n kube-system -o yaml &gt; /tmp/coredns-558bd4d5db-9h55s.yaml</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><code>kubectl set --help</code><!-- raw HTML omitted -->更新镜像、设置一个对象的特定特征<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl set image deployment/web nginx<span style="color:#f92672">=</span>nginx1.15</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><code>kubectl create --help</code><!-- raw HTML omitted -->：创建命令用于创建资源<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>yaml</code><!-- raw HTML omitted -->文件详解、使用<!-- raw HTML omitted --><code>kubectl create</code><!-- raw HTML omitted -->命令生成<!-- raw HTML omitted --><code>yaml</code><!-- raw HTML omitted -->文件<!-- raw HTML omitted --></li>
<li><code>deployment</code><!-- raw HTML omitted -->：无状态应用部署<!-- raw HTML omitted --></li>
<li><code>java-demo</code><!-- raw HTML omitted -->：自定义名称<!-- raw HTML omitted --></li>
<li><code> --image</code><!-- raw HTML omitted -->：使用镜像<!-- raw HTML omitted --></li>
<li><code> --dry-run</code><!-- raw HTML omitted -->：测试<!-- raw HTML omitted --></li>
<li><code>-o</code><!-- raw HTML omitted -->：输出<!-- raw HTML omitted --></li>
<li><code>&gt;/tmp/deploy.yaml</code><!-- raw HTML omitted -->：定向输出到文件，不加<!-- raw HTML omitted --><code>&gt;/tmp/deploy.yaml</code><!-- raw HTML omitted --> 输出到屏幕查看<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 创建一个namespace命名空间</span>
</span></span><span style="display:flex;"><span>$ kubectl create namespace dev
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl create deployment java-demo --image<span style="color:#f92672">=</span>192.168.80.210:8080/test/tomcat-demo:v1 --dry-run<span style="color:#f92672">=</span>client -o yaml &gt;/tmp/deploy.yaml  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl create service clusterip ngx-dep --tcp<span style="color:#f92672">=</span>80:80  <span style="color:#75715e"># 命令行创建service</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl create -f  ns-dev.yaml    <span style="color:#75715e"># 根据yaml文件创建资源</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><code>kubectl edit --help</code><!-- raw HTML omitted -->：<code>cm</code>：编辑<!-- raw HTML omitted --><code>configMap</code><!-- raw HTML omitted -->中的配置<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 修改service中的服务</span>
</span></span><span style="display:flex;"><span>$ kubectl edit service/ingress-nginx-controller-admission -n ingress-nginx 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl edit cm kube-proxy -n kube-system <span style="color:#75715e"># 修改ipvs(必须安装ipvs内核模块，否则会降级为iptables) 修改：mode: &#34;ipvs&#34;</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="6">
<li><code>kubectl patch --help</code><!-- raw HTML omitted -->：补丁修改、更新资源的字段<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl patch pod rc-nginx-2-kpiqt -p <span style="color:#e6db74">&#39;{&#34;metadata&#34;:{&#34;labels&#34;:{&#34;app&#34;:&#34;nginx-3&#34;}}}&#39;</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="7">
<li><code>kubectl apply --help</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->如果资源不存在，就创建，相当于<!-- raw HTML omitted --><code>kubectl create</code></li>
<li><!-- raw HTML omitted -->如果资源存在，就更新，相当于<!-- raw HTML omitted --><code>kubectl patch</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 运行构建命令</span>
</span></span><span style="display:flex;"><span>$ kubectl apply -f ./  	<span style="color:#75715e"># 应用当前目录下所有yaml文件</span>
</span></span><span style="display:flex;"><span>$ kubectl apply -f deploy.yaml  	<span style="color:#75715e"># K8S默认拉去GitHub上镜像</span>
</span></span><span style="display:flex;"><span>$ kubectl apply -f nginx-pod.yaml -n web --record</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="8">
<li><code>kubectl replace --help</code><!-- raw HTML omitted -->：根据<code>yaml</code>文件更新修改后配置资源，会停掉原来的资源，重新创建<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl replace -f rc-nginx.yaml  </span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="9">
<li><code>kubectl delete --help</code><!-- raw HTML omitted -->：删除<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><a href="https://aws.amazon.com/cn/premiumsupport/knowledge-center/eks-terminated-namespaces/" rel="external" target="_self">删除<code>Terminating</code>(正在终止)状态命名空间</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl delete svc/web
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl delete -f  deployment-nginx.yaml   <span style="color:#75715e">#删除该yaml中创建的资源</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl delete pod nginx-deployment-798444d598-87hlk -n web  <span style="color:#75715e">#删除pod资源  </span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="10">
<li><code>kubectl api-resources --help</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl api-resources  	<span style="color:#75715e"># 查看k8s所有的资源以及对应的apiversion</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl api-versions  	<span style="color:#75715e"># 查看k8s所有 版本号 </span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="span-id中级命令中级命令运行调试span"><!-- raw HTML omitted -->中级命令：运行、调试<!-- raw HTML omitted --></h3>
<ul>
<li>
<ol>
<li><code>kubectl exec --help</code><!-- raw HTML omitted -->进入容器<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl exec -it nginx-deployment-798444d598-87hlk  -n web -- /bin/sh
</span></span><span style="display:flex;"><span>$ kubectl exec my-pod -it -- ls /opt/  	<span style="color:#75715e"># 在已存在的容器中执行命令（只有一个容器的情况下）</span>
</span></span><span style="display:flex;"><span>$ kubectl exec my-pod -c my-container -- ls /  	<span style="color:#75715e"># 在已存在的容器中执行命令（pod中有多个容器的情况下） </span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><code>kubectl label --help</code><!-- raw HTML omitted -->：更新资源上的标签<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>标签<code>Key</code></th>
<th><code>Values</code></th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>release</code>(发布)</td>
<td>版本：<code>stable</code>(稳定版)、<code>canary</code>(金丝雀版)、<code>alpha</code>(内测)、<code>bate</code>(公测)</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>environment</code>(环境)</td>
<td>环境：<code>dev</code>(开发)、<code>qa/test</code>(测试)、<code>gray</code>(灰度)、<code>production</code>(生产)、<code>op</code>(运维)、<code>ui,as,pc,sc</code>(应用类(<code>app</code>))</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>tier</code>(层级)</td>
<td>层级：<code>frontend</code>(前端)、<code>backend</code>(后端)、<code>cache</code>(缓存)</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>partition</code>(分区/模块)</td>
<td>分区/模块：<code>customerA</code>(业务A/客户A)、<code>customerB</code>(业务B/客户B)</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>version</code>(版本号)</td>
<td>版本号：<code>v1.1、v1.2</code></td>
<td>&mdash;</td>
</tr>
</tbody>
</table>
<ul>
<li><!-- raw HTML omitted -->给节点<!-- raw HTML omitted --><code>Nodes</code><!-- raw HTML omitted -->打标签、删除标签<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 显示 Nodes 标签</span>
</span></span><span style="display:flex;"><span>$ kubectl get node --show-labels
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 给 Nodes 节点打上，名字为：data 的标签</span>
</span></span><span style="display:flex;"><span>$ kubectl label nodes nodes_name data<span style="color:#f92672">=</span>labels_name
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除 Nodes 上，名字为：data 的标签</span>
</span></span><span style="display:flex;"><span>$ kubectl label nodes nodes_name data-</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->给节点<!-- raw HTML omitted --><code>Pods</code><!-- raw HTML omitted -->打标签、删除标签<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 显示命名空间为：web 下 Pods 的标签</span>
</span></span><span style="display:flex;"><span>$ kubectl get pods --show-labels -n web -o wide
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 为 Pods 打上，名字为：version 的标签</span>
</span></span><span style="display:flex;"><span>$ kucectl label pods pods_name version<span style="color:#f92672">=</span>1.0 -n web
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 覆盖原来的标签：--overwrite</span>
</span></span><span style="display:flex;"><span>$ kucectl label pods pods_name version<span style="color:#f92672">=</span>2.0 --overwrite -n web
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除 Pods 上，名字为：version 的标签</span>
</span></span><span style="display:flex;"><span>$ kucectl label pods pods_name version- -n web</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><code>kubectl describe --help</code><!-- raw HTML omitted -->显示资源内部信息<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl describe namespace kube-system
</span></span><span style="display:flex;"><span>Name:         kube-system
</span></span><span style="display:flex;"><span>Labels:       kubernetes.io/metadata.name<span style="color:#f92672">=</span>kube-system
</span></span><span style="display:flex;"><span>Annotations:  &lt;none&gt;
</span></span><span style="display:flex;"><span>Status:       Active  	<span style="color:#75715e"># 表示正在使用中，Terminating:表示正在删除命名空间</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>No resource quota.  	<span style="color:#75715e"># 表示：针对命名空间做的资源限制</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>No LimitRange resource.  	<span style="color:#75715e"># 表示：针对命名空间中的每个组件做的资源限制</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl describe  pods -n web nginx-pod  	<span style="color:#75715e"># 查看pod 的详细信息</span>
</span></span><span style="display:flex;"><span>$ kubectl describe service -n web nginx-svc  	<span style="color:#75715e"># 查看service的 详细信息 </span>
</span></span><span style="display:flex;"><span>$ kubectl describe node 192.168.3.125  	<span style="color:#75715e"># 查看node的详细信息</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><code>kubectl logs --help</code><!-- raw HTML omitted -->日志查看<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl logs -n web nginx-deployment-798444d598-87hlk  	<span style="color:#75715e"># 查看pod日志</span>
</span></span><span style="display:flex;"><span>$ kubectl logs -f  nginx-deployment-798444d598-87hlk -n web  <span style="color:#75715e"># 实时查看日志</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl log  nginx-deployment-798444d598-87hlk -c &lt;container_name&gt; -n web  <span style="color:#75715e"># 查看pod中单个容器的日志</span>
</span></span><span style="display:flex;"><span>$ kubectl logs -l app<span style="color:#f92672">=</span>frontend  -n web    <span style="color:#75715e"># 返回全部标记为 app=frontend 的 pod 的合并日志</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><code>kubectl expose --help</code><!-- raw HTML omitted -->端口暴露<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>expose</code><!-- raw HTML omitted -->端口设置固定选项<!-- raw HTML omitted --></li>
<li><code> java-demo</code><!-- raw HTML omitted -->： 自定义名称<!-- raw HTML omitted --></li>
<li><code>--port</code><!-- raw HTML omitted -->：<code>Pod</code>的<code>Service</code>服务端口，集群内部互通端口<!-- raw HTML omitted --></li>
<li><code>--target-port</code><!-- raw HTML omitted -->：<code>Pod</code>容器内服务端口端口<!-- raw HTML omitted --></li>
<li><code>--type</code><!-- raw HTML omitted -->：随机生成外部访问端口<!-- raw HTML omitted --></li>
<li><code>&gt;java-demo-svc.yaml</code><!-- raw HTML omitted -->：定向输出到文件，不加<!-- raw HTML omitted --><code>&gt;java-demo-svc.yaml</code><!-- raw HTML omitted -->输出到屏幕查看<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl expose --help
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl expose deployment java-demo --port<span style="color:#f92672">=</span><span style="color:#ae81ff">80</span> --target-port<span style="color:#f92672">=</span><span style="color:#ae81ff">8080</span> --type<span style="color:#f92672">=</span>NodePort --dry-run<span style="color:#f92672">=</span>client -o yaml &gt;java-demo-svc.yaml  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl apply -f java-demo-svc.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 对外发布允许外网访问</span>
</span></span><span style="display:flex;"><span>$ kubectl expose deployment web --port<span style="color:#f92672">=</span><span style="color:#ae81ff">80</span> --type<span style="color:#f92672">=</span>NodePort --target-port<span style="color:#f92672">=</span><span style="color:#ae81ff">80</span> --name<span style="color:#f92672">=</span>web
</span></span><span style="display:flex;"><span>$ kubectl get service
</span></span><span style="display:flex;"><span>$ kubectl get deploy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># PORT(S):80(集群内部互通端口)、30040/TCP(外部访问端口)</span>
</span></span><span style="display:flex;"><span>$ kubectl get pods,svc
</span></span><span style="display:flex;"><span>NAME                             READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pod/java-demo-56d54df448-2m8kr   1/1     Running   <span style="color:#ae81ff">0</span>          68m
</span></span><span style="display:flex;"><span>pod/java-demo-56d54df448-9k5dn   1/1     Running   <span style="color:#ae81ff">0</span>          68m
</span></span><span style="display:flex;"><span>pod/java-demo-56d54df448-wvqkf   1/1     Running   <span style="color:#ae81ff">0</span>          68m
</span></span><span style="display:flex;"><span>pod/nginx-6799fc88d8-5sxfn       1/1     Running   <span style="color:#ae81ff">0</span>          3h4m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                 TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>        AGE
</span></span><span style="display:flex;"><span>service/java-demo    NodePort    10.103.37.12   &lt;none&gt;        80:30040/TCP   105s
</span></span><span style="display:flex;"><span>service/kubernetes   ClusterIP   10.96.0.1      &lt;none&gt;        443/TCP        4h35m
</span></span><span style="display:flex;"><span>service/nginx        NodePort    10.106.61.55   &lt;none&gt;        80:31750/TCP   3h4m</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="6">
<li><code>kubectl explain --help</code><!-- raw HTML omitted -->：展示资源使用文档<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl explain pod.kind.replicasets <span style="color:#75715e"># 查看某种资源可以配置的一级配置如：pod、deployment</span>
</span></span><span style="display:flex;"><span>$ kubectl explain pod.metadata       <span style="color:#75715e"># 查看资源的子属性，资源类型：pod、属性：metadata</span>
</span></span><span style="display:flex;"><span>$ kubectl explain pod.spec 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># nodes</span>
</span></span><span style="display:flex;"><span>$ kubectl explain pod.spec.nodeName.containers
</span></span><span style="display:flex;"><span>$ kubectl explain pod.spec.nodeSelector.containers</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="7">
<li><code>kubectl rollout --help</code><!-- raw HTML omitted -->：管理资源<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>status</code><!-- raw HTML omitted -->：显示当前升级状态<!-- raw HTML omitted --></li>
<li><code>history</code><!-- raw HTML omitted -->：显示升级历史记录<!-- raw HTML omitted --></li>
<li><code>pause</code><!-- raw HTML omitted -->：暂停版本升级过程<!-- raw HTML omitted --></li>
<li><code>resume</code><!-- raw HTML omitted -->：继续已经暂停的版本升级过程<!-- raw HTML omitted --></li>
<li><code>restart</code><!-- raw HTML omitted -->：重启版本升级过程<!-- raw HTML omitted --></li>
<li><code>undo</code><!-- raw HTML omitted -->：回滚到上一级版本(可以使用<!-- raw HTML omitted --><code>--to-revision</code><!-- raw HTML omitted -->，指定版本)<!-- raw HTML omitted --></li>
<li><code>--record</code><!-- raw HTML omitted -->：记录<!-- raw HTML omitted --><code>CHANGE-CAUSE</code><!-- raw HTML omitted -->(改变原因)操作记录,便于回滚<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 更新发布</span>
</span></span><span style="display:flex;"><span>$ kubectl apply -f nginx-deployment.yml --record  <span style="color:#75715e"># --record，记录操作记录,便于回滚</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># pause 暂定更新发布</span>
</span></span><span style="display:flex;"><span>$ kubectl rollout pause deployment nginx-deployment -n app
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># resume 继续更新发布</span>
</span></span><span style="display:flex;"><span>$ kubectl rollout resume deployment nginx-deployment -n app
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看升级状态</span>
</span></span><span style="display:flex;"><span>$ kubectl rollout status deployment/nginx-deployment
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看升级历史版本</span>
</span></span><span style="display:flex;"><span>$ kubectl rollout history deployment/web
</span></span><span style="display:flex;"><span>$ kubectl rollout history deployment -n app
</span></span><span style="display:flex;"><span>$ kubectl rollout history deployment/web --revision<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>  	<span style="color:#75715e"># 查看某个更新具体内容</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 回滚</span>
</span></span><span style="display:flex;"><span>$ kubectl rollout undo deployment/web --revision<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>$ kubectl rollout undo deployment/nginx-deployment --to-revision<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> -n app <span style="color:#75715e"># 版本回滚到v1</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="8">
<li><code>kubectl scale --help</code><!-- raw HTML omitted -->：手动扩缩容<code>Pod</code>数量<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>--replicas</code><!-- raw HTML omitted -->：参数定义<code>Pod</code>数量<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl scale rc redis --replicas<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> -n web  	<span style="color:#75715e"># 操作pod 的扩容和缩容</span>
</span></span><span style="display:flex;"><span>$ kubectl scale --replicas<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> -f redis-slave-deployment.yaml</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="9">
<li><code>kubectl autoscale --help</code><!-- raw HTML omitted -->：监控<code>CPU</code>使用百分比自动扩缩<code>Pod</code>数量<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>deployment</code><!-- raw HTML omitted -->：类型控制器<!-- raw HTML omitted --></li>
<li><code>deployment-name</code><!-- raw HTML omitted -->：<code>Pod</code>的名称<!-- raw HTML omitted --></li>
<li><code>--cpu-percent</code><!-- raw HTML omitted -->：使用<code>CPU</code>百分比<!-- raw HTML omitted --></li>
<li><code>--min</code><!-- raw HTML omitted -->：<code>Pod</code>最少数量<!-- raw HTML omitted --></li>
<li><code>--max</code><!-- raw HTML omitted -->：<code>Pod</code>最多数量<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl autoscale deployment deployment-name --cpu-percent<span style="color:#f92672">=</span><span style="color:#ae81ff">60</span> --min<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> --max<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="10">
<li><code>kubectl taint --help</code><!-- raw HTML omitted -->：污点配置<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->查看节点上的污点<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl describe nodes k8s-node1 | grep Taints</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->设置污点<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>tag=webapps</code>、<code>tag</code><!-- raw HTML omitted -->：污点名称，可以自定义，依<!-- raw HTML omitted --><code>Key=value</code></li>
<li><code>NoSchedule</code><!-- raw HTML omitted -->：影响，不会调度到此节点<!-- raw HTML omitted --></li>
<li><code>NoExecute</code><!-- raw HTML omitted -->：驱除，把此节点上的<code>Pods</code>驱除到其他节点<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl taint node k8s-node1 tag<span style="color:#f92672">=</span>webapps:NoSchedule</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->去除污点<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>-</code><!-- raw HTML omitted -->：污点名称后面跟<!-- raw HTML omitted --><!-- raw HTML omitted -->减号<!-- raw HTML omitted --><!-- raw HTML omitted -->就是去除污点意思<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl taint node k8s-master-01 node-role.kubernetes.io/control-plane:NoSchedule-
</span></span><span style="display:flex;"><span>node/k8s-master-01 untainted  	<span style="color:#75715e"># 返回结果 污点已去除</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 去除以 tag 为名设置的所有污点</span>
</span></span><span style="display:flex;"><span>$ kubectl taint node k8s-node1 tag-</span></span></code></pre></div></blockquote>
<hr>
<h3 id="span-id高级命令高级命令管理排查span"><!-- raw HTML omitted -->高级命令：管理、排查<!-- raw HTML omitted --></h3>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/kubernetes-sigs/metrics-server" rel="external" target="_self"><code>Kubernetes</code>指标服务器</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/cai11745/hybrid-cloud/blob/master/prometheus/2019-10-22-prometheus-1-install-and-metricsIngress.md" rel="external" target="_self">安装<code>Prometheus</code>监控服务器资源</a></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>
<ol>
<li><code>kubectl top --help</code><!-- raw HTML omitted -->：监控集群内存<code>CPU</code>指标<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>metrics-server</code><!-- raw HTML omitted -->可以用来收集集群中的资源使用情况、需要单独安装<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->新增参数：<!-- raw HTML omitted --><code>hostNetwork: true</code><!-- raw HTML omitted -->，用于使用宿主机网络<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->国内修改为阿里云地址：<!-- raw HTML omitted --><code>image: registry.cn-hangzhou.aliyuncs.com/google_containers/metrics-server-amd64:v0.3.6</code></li>
<li><!-- raw HTML omitted -->新增参数：<!-- raw HTML omitted --><code>- --kubelet-insecure-tls</code>，不验证客户端证书，仅用于测试目的，<code>kubelet</code>的<code>10250</code>端口使用的是<code>https</code>协议，连接需要验证<code>tls</code>证书</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml -O metrics-server.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 替换为阿里云镜像地址</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s/k8s.io\/metrics-server/cn-hangzhou.aliyuncs.com\/google_containers/g&#39;</span> metrics-server.yaml</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>metrics-server.yaml</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">metrics-server</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">metrics-server</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">metrics-server</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">strategy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">metrics-server</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">hostNetwork</span>: <span style="color:#66d9ef">true</span>   <span style="color:#75715e"># 新增参数，使用宿主机网络</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">args</span>:
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">cert-dir=/tmp</span>
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">secure-port=4443</span>
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname</span>
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">kubelet-use-node-status-port</span>
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">metric-resolution=15s</span>
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">kubelet-insecure-tls   </span> <span style="color:#75715e"># 新增参数，不校验https协议</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">registry.cn-hangzhou.aliyuncs.com/google_containers/metrics-server:v0.6.4</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span></span></span></code></pre></div><div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl apply -f metrics-server.yaml
</span></span><span style="display:flex;"><span>$ kubectl top node  --use-protocol-buffers
</span></span><span style="display:flex;"><span>$ kubectl top  pod/node  -n dev </span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><code>kubectl port-forward --help</code><!-- raw HTML omitted -->转发<code>Pod</code>中端口<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl port-forward my-pod 5000:6000  	<span style="color:#75715e"># 转发pod中的6000端口到本地的 5000 端口</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="故障排查解决">故障排查、解决</h3>
<h5 id="nodesfont-colorred节点显示fontnotreadyfont-colorred是节点之间网络不通导致font"><code>nodes</code><!-- raw HTML omitted -->节点显示<!-- raw HTML omitted --><code>NotReady</code><!-- raw HTML omitted -->是节点之间网络不通导致<!-- raw HTML omitted --></h5>
<blockquote>
<p><a href="#R-image-7e16504736d34795772f4bb7bc7d6736" class="lightbox-link"><img alt="get-nodes" class="border lazy lightbox noshadow figure-image" loading="lazy" src="http://oss.linuxtxc.com/images/image-20220407170459496.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-7e16504736d34795772f4bb7bc7d6736"><img alt="get-nodes" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="http://oss.linuxtxc.com/images/image-20220407170459496.png"></a></p>
</blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->查看集群健康状况<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl get cs
</span></span><span style="display:flex;"><span>$ kubectl cluster-info
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用镜像测试容器命令</span>
</span></span><span style="display:flex;"><span>$ kubectl run -it --image busybox:1.28.4 container-name --restart<span style="color:#f92672">=</span>Never --rm /bin/sh
</span></span><span style="display:flex;"><span>$ ping pod-name.server-name</span></span></code></pre></div><p><a href="#R-image-9d327c689f82e1146b9495be71fd8ade" class="lightbox-link"><img alt="get-sc" class="border lazy lightbox noshadow figure-image" loading="lazy" src="http://oss.linuxtxc.com/images/image-20220407170643950.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-9d327c689f82e1146b9495be71fd8ade"><img alt="get-sc" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="http://oss.linuxtxc.com/images/image-20220407170643950.png"></a></p>
</blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->先处理网络、后处理配置文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ vim  /etc/kubernetes/manifests/kube-controller-manager.yaml （注释掉 - --port<span style="color:#f92672">=</span>0）
</span></span><span style="display:flex;"><span>$ vim  /etc/kubernetes/manifests/kube-scheduler.yaml          （注释掉 - --port<span style="color:#f92672">=</span>0）
</span></span><span style="display:flex;"><span>$ systemctl start kubelet </span></span></code></pre></div><ul>
<li>2.1 <!-- raw HTML omitted -->再次查看，节点正常显示： <!-- raw HTML omitted --><code>Ready</code></li>
</ul>
<p><a href="#R-image-7c88d02065d5054b916ddb7aa72c3910" class="lightbox-link"><img alt="get-cs-2" class="border lazy lightbox noshadow figure-image" loading="lazy" src="http://oss.linuxtxc.com/images/image-20220407170817379.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-7c88d02065d5054b916ddb7aa72c3910"><img alt="get-cs-2" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="http://oss.linuxtxc.com/images/image-20220407170817379.png"></a></p>
<p><a href="#R-image-e79b5259d3e09e50a121f0c99d622c5e" class="lightbox-link"><img alt="get-nodes-2" class="border lazy lightbox noshadow figure-image" loading="lazy" src="http://oss.linuxtxc.com/images/image-20220407171343144.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-e79b5259d3e09e50a121f0c99d622c5e"><img alt="get-nodes-2" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="http://oss.linuxtxc.com/images/image-20220407171343144.png"></a></p>
</blockquote>
<hr>
<h5 id="重置kubernetes集群">重置<code>Kubernetes</code>集群</h5>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 在master、node节点都执行以下命令</span>
</span></span><span style="display:flex;"><span>$ kubeadm reset 
</span></span><span style="display:flex;"><span>$ rm -rf /etc/cni/net.d
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在master上执行</span>
</span></span><span style="display:flex;"><span>$ kubeadm init --kubernetes-version<span style="color:#f92672">=</span>1.19.0 --apiserver-advertise-address<span style="color:#f92672">=</span>192.168.3.124 --service-cidr<span style="color:#f92672">=</span>10.64.0.0/24 --pod-network-cidr<span style="color:#f92672">=</span>10.244.0.0/16
</span></span><span style="display:flex;"><span>$ mkdir -p $HOME/.kube
</span></span><span style="display:flex;"><span>$ cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style="display:flex;"><span>$ chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config
</span></span><span style="display:flex;"><span>$ vim /etc/kubernetes/manifests/kube-controller-manager.yaml （注释掉 - --port<span style="color:#f92672">=</span>0）
</span></span><span style="display:flex;"><span>$ vim /etc/kubernetes/manifests/kube-scheduler.yaml          （注释掉 - --port<span style="color:#f92672">=</span>0）
</span></span><span style="display:flex;"><span>$ systemctl start kubelet 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在node节点执行</span>
</span></span><span style="display:flex;"><span>$ kubeadm reset
</span></span><span style="display:flex;"><span>$ kubeadm join 192.168.3.124:6443 --token f62e1g.exfdrr8bg2fxpdmu <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--discovery-token-ca-cert-hash sha256:7e4762cccce2e8306b6635cbc2091eae34bbf33577276413521a343c49fc026a</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_kubernetes">Install_Kubernetes</h1>

<h1 id="部署kubernetes">部署<code>Kubernetes</code></h1>
<blockquote>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<ul>
<li>
<p><code>Etcd</code><!-- raw HTML omitted -->：负责存储集群中各种资源对象的信息<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>Kubelet</code><!-- raw HTML omitted -->：负责维护容器的生命周期，即通过控制<!-- raw HTML omitted --><code>Docker</code><!-- raw HTML omitted -->，来创建、更新、销毁容器<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>KubeProxy</code><!-- raw HTML omitted -->：负责提供集群内部的服务发现和负载均衡<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>Docker</code><!-- raw HTML omitted -->：负责节点上容器的各种操作<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>Scheduler</code><!-- raw HTML omitted -->：负责集群资源调度，按照预定的调度策略将<code>Pod</code>调度到相应的<code>node</code>节点上<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>API Server</code><!-- raw HTML omitted -->：集群操作的唯一入口，接收用户输入的命令，提供认证、授权、<code>API</code>注册和发现等机制<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>ControllerManager</code><!-- raw HTML omitted -->：负责维护集群的状态，比如程序部署安排、故障检测、自动扩展和滚动更新等<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>Core DNS</code><!-- raw HTML omitted -->：可以为集群中的<code>SVC</code>创建一个域名<code>IP</code>的对应关系解析<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>Dashboard</code><!-- raw HTML omitted -->：给<code>K8S</code>集群提供一个<code>B/S</code>结构的体系访问<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>Ingress Controller</code><!-- raw HTML omitted -->：官方只能实现四层代理，<code>Ingress</code>可以实现七层代理<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>Fedetation</code><!-- raw HTML omitted -->：提供一个可以跨集群中心的多<code>K8S</code>统一管理功能<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>Prometheus</code><!-- raw HTML omitted -->：提供一个<code>K8S</code>集群监控能力<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>ELK</code><!-- raw HTML omitted -->：提供<code>K8S</code>集群日志统一分析介入平台<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>K8S</code>部署方式分为<!-- raw HTML omitted -->二进制<!-- raw HTML omitted -->以及<!-- raw HTML omitted -->快速部署<!-- raw HTML omitted -->方式，官方给予<!-- raw HTML omitted -->三种快速部署<!-- raw HTML omitted -->方式：<a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/" rel="external" target="_self">使用<code>kubeadm</code>引导集群</a>、<a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kops/" rel="external" target="_self">使用<code>Kops</code>安装<code>Kubernetes</code></a>、<a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubespray/" rel="external" target="_self">使用<code>Kubespray</code>安装<code>Kubernetes</code></a></p>
</li>
</ul>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/kubewharf" rel="external" target="_self"><code>KubeWharf</code>轻量级多租户</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/kubernetes/perf-tests" rel="external" target="_self"><code>Kubernetes</code>性能测试</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://learnk8s.io/a/a-visual-guide-on-troubleshooting-kubernetes-deployments/troubleshooting-kubernetes.en_en.v3.pdf" rel="external" target="_self"><code>kubernetes</code>排错思维</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://kubespray.io/#/docs/getting-started" rel="external" target="_self"><code>Ansible-playbook</code>使用<code>kubespray</code>安装<code>K8S</code></a></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<h2 id="服务器端口准备">服务器、端口准备</h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->部署一主三从<!-- raw HTML omitted --><code>kubernetes</code>架构</li>
</ol>
</li>
</ul>
<blockquote>

<pre class="mermaid align-center zoomable">graph TD
F[一主多从] 
A{{K8S-Master}} ==&gt; B{{K8S-Nodes}}
A{{K8S-Master}} ==&gt; C{{K8S-Nodes}}
A{{K8S-Master}} ==&gt; D{{K8S-Nodes}}
Z[多主多从]
G{{K8S-Master}} ==&gt; J{{K8S-Nodes}}
G{{K8S-Master}} ==&gt; K{{K8S-Nodes}}
G{{K8S-Master}} ==&gt; L{{K8S-Nodes}}
H{{K8S-Master}} ==&gt; J{{K8S-Nodes}}
H{{K8S-Master}} ==&gt; K{{K8S-Nodes}}
H{{K8S-Master}} ==&gt; L{{K8S-Nodes}} </pre><table>
<thead>
<tr>
<th>角色</th>
<th><code>IP</code>地址</th>
<th>配置</th>
<th>操作系统</th>
</tr>
</thead>
<tbody>
<tr>
<td>Master</td>
<td>192.168.35.128</td>
<td><code>2core、4G、80Gdisk</code></td>
<td><code>CentOS Linux release 7.9.2</code></td>
</tr>
<tr>
<td>node-1</td>
<td>192.168.35.129</td>
<td><code>2core、1G、60Gdisk</code></td>
<td><code>CentOS Linux release 7.9.2</code></td>
</tr>
<tr>
<td>node-2</td>
<td>192.168.35.130</td>
<td><code>2core、1G、60Gdisk</code></td>
<td><code>CentOS Linux release 7.9.2</code></td>
</tr>
</tbody>
</table>
<ul>
<li><!-- raw HTML omitted -->集群架构<!-- raw HTML omitted --></li>
</ul>
<table>
<thead>
<tr>
<th>角色</th>
<th><code>IP</code>地址</th>
<th>配置</th>
<th>操作系统</th>
</tr>
</thead>
<tbody>
<tr>
<td>Master-1</td>
<td>192.168.80.210</td>
<td><code>2core、4G、80Gdisk</code></td>
<td><code>CentOS Linux release 7.9.2</code></td>
</tr>
<tr>
<td>Master-2</td>
<td>192.168.80.211</td>
<td><code>2core、4G、80Gdisk</code></td>
<td><code>CentOS Linux release 7.9.2</code></td>
</tr>
<tr>
<td>node-1</td>
<td>192.168.80.212</td>
<td><code>2core、2G、60Gdisk</code></td>
<td><code>CentOS Linux release 7.9.2</code></td>
</tr>
<tr>
<td>node-2</td>
<td>192.168.80.213</td>
<td><code>2core、2G、60Gdisk</code></td>
<td><code>CentOS Linux release 7.9.2</code></td>
</tr>
<tr>
<td>node-3</td>
<td>192.168.80.215</td>
<td><code>2core、2G、60Gdisk</code></td>
<td><code>CentOS Linux release 7.9.2</code></td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->控制节点<!-- raw HTML omitted --><code>master</code>：集群的控制平面，负责集群的决策，以及需要开放的端口</li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>协议</th>
<th>方向</th>
<th>端口范围</th>
<th>作用</th>
<th>使用者</th>
</tr>
</thead>
<tbody>
<tr>
<td>TCP</td>
<td>入站</td>
<td>6443</td>
<td><code>Kubernetes API</code> 服务器</td>
<td>所有组件,管理员操作<code>Kubernetes</code>的接口。因此，<code>API</code>服务器通常暴露在控制平面之外。<code>API</code>服务器被设计成可扩展的，可能存在于多个控制平面节点上</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>2379-2380</td>
<td><code>etcd</code>服务器客户端 <code>API</code></td>
<td><code>kube-apiserver, etcd</code>，持久化的备份存储，关于集群状态的所有信息都保存在这里。<code>Etcd</code>不应该被直接操作，而应该通过 <code>API</code> 服务器来管理。</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>10250</td>
<td><code>Kubelet API</code></td>
<td><code>kubelet</code>自身、在每个工作节点上运行，以协调和验证<code>Pod</code>的执行</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>10259</td>
<td><code>kube-scheduler</code></td>
<td><code>kube-scheduler</code>自身，跟踪工作节点的状态并决定在哪里运行 Pod。<code>Kube-scheduler</code> 只可以由控制平面内的节点访问。</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>10257</td>
<td><code>kube-controller-manager</code></td>
<td><code>kube-controller-manager</code>自身，监视<code>Kubernetes</code>集群，以检测和维护<code>Kubernetes</code>环境的几个方面，包括将<code>Pod</code>加入到服务中，保持一组<code>Pod</code>的正确数量，并对节点的丢失做出反应</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>10258</td>
<td><code>Cloud controller manager</code></td>
<td>一个用于基于云的部署的可选组件。云控制器与云服务提供商接口，以管理集群的负载均衡器和虚拟网络</td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->工作节点<!-- raw HTML omitted --><code>node</code>：集群的数据平面，负责为容器提供运行环境 ，需要开放的端口</li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>协议</th>
<th>方向</th>
<th>端口范围</th>
<th>作用</th>
<th>使用者</th>
</tr>
</thead>
<tbody>
<tr>
<td>TCP</td>
<td>入站</td>
<td>10250</td>
<td><code>Kubelet API</code></td>
<td><code>kubelet</code>自身、控制平面组件</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>30000-32767</td>
<td><code>NodePort</code>服务†</td>
<td>所有组件</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h3 id="初始化环境">初始化环境</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->设置三台主机名<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ hostnamectl set-hostname k8s-master-128
</span></span><span style="display:flex;"><span>$ hostnamectl set-hostname k8s-node-01-129
</span></span><span style="display:flex;"><span>$ hostnamectl set-hostname k8s-node-02-130</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->设置集群的主机名<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ hostnamectl set-hostname k8s-master-1-80-210
</span></span><span style="display:flex;"><span>$ hostnamectl set-hostname k8s-master-2-80-211
</span></span><span style="display:flex;"><span>$ hostnamectl set-hostname k8s-node-1-80-212
</span></span><span style="display:flex;"><span>$ hostnamectl set-hostname k8s-node-2-80-213
</span></span><span style="display:flex;"><span>$ hostnamectl set-hostname k8s-node-3-80-215</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->分别在三台服务器做本地<!-- raw HTML omitted --><code>hosts</code><!-- raw HTML omitted -->解析<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;&gt;/etc/hosts<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.35.128 k8s-master-01
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.35.129 k8s-node-01
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.35.130 k8s-node-02
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->五台服务器的集群<!-- raw HTML omitted --><code>hosts</code><!-- raw HTML omitted -->配置<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;&gt;/etc/hosts<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.80.210 k8s-master-01
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.80.211 k8s-master-02
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.80.212 k8s-node-01
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.80.213 k8s-node-02
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.80.215 k8s-node-03
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.80.220 k8s-master-lb # VIP(虚拟IP)用于LoadBalance，如果不是高可用集群，该IP可以是k8s-master01的IP 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->设置时间同步，修改时区两种方式<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>tzdata</code><!-- raw HTML omitted -->时区软件包<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install tzdata 
</span></span><span style="display:flex;"><span>$ timedatectl set-timezone Asia/Shanghai</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->第一种<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->第二种<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl enable chronyd.service <span style="color:#f92672">&amp;&amp;</span> systemctl start chronyd.service</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->关闭防火墙并禁止开机自启<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl disable firewalld <span style="color:#f92672">&amp;&amp;</span> systemctl stop firewalld</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->关闭<!-- raw HTML omitted --><code>SElinux</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ setenforce <span style="color:#ae81ff">0</span>  	<span style="color:#75715e"># 临时关闭Selinux</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s/^SELINUX=.*/SELINUX=disabled/&#39;</span> /etc/selinux/config  	<span style="color:#75715e"># 永久关闭Selinux</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="6">
<li><!-- raw HTML omitted -->关闭<!-- raw HTML omitted --><code>swap</code><!-- raw HTML omitted -->交换分区<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sed -ri <span style="color:#e6db74">&#39;s/.*swap.*/#&amp;/&#39;</span> /etc/fstab <span style="color:#f92672">&amp;&amp;</span> swapoff -a</span></span></code></pre></div><ul>
<li><code>Ubunt</code><!-- raw HTML omitted -->关闭交换分区<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;etc/fstab<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/dev/disk/by-uuid/95e38332-76fc-4d2f-81a4-04bc581f2ed3 none swap sw,noauto 0 0  	# 添加：noauto
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># /swap.img     none    swap    sw      0       0  	# 添加注释
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查询验证，输出为空则生效</span>
</span></span><span style="display:flex;"><span>$ sudo swapon --show</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="7">
<li>允许<code>iptables</code><!-- raw HTML omitted -->检查桥接流量<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->确保<!-- raw HTML omitted --><code>br_netfilter</code><!-- raw HTML omitted -->模块被加载。这一操作可以通过运行<!-- raw HTML omitted --><code>lsmod | grep br_netfilter</code><!-- raw HTML omitted -->来完成。若要显式加载该模块，可执行<!-- raw HTML omitted --><code>modprobe br_netfilter</code></li>
<li><!-- raw HTML omitted -->为了让你的<!-- raw HTML omitted --><code>Linux</code><!-- raw HTML omitted -->节点上的<!-- raw HTML omitted --><code>iptables</code><!-- raw HTML omitted -->能够正确地查看桥接流量，你需要确保在你的<!-- raw HTML omitted --><code>sysctl</code><!-- raw HTML omitted -->配置中将<!-- raw HTML omitted --><code>net.bridge.bridge-nf-call-iptables</code><!-- raw HTML omitted -->设置为 1<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat <span style="color:#e6db74">&lt;&lt;EOF | sudo tee /etc/modules-load.d/k8s.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">br_netfilter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat <span style="color:#e6db74">&lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.bridge.bridge-nf-call-iptables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.ip_forward = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sysctl --system
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##########################################################  使用脚本函数</span>
</span></span><span style="display:flex;"><span>__k8s_kernel_iptables<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 加载br_netfilter模块</span>
</span></span><span style="display:flex;"><span>    modprobe br_netfilter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 查看是否加载</span>
</span></span><span style="display:flex;"><span>    lsmod | grep br_netfilter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 写内核配置文件</span>
</span></span><span style="display:flex;"><span>    cat &gt;/etc/sysctl.d/k8s.conf <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.bridge.bridge-nf-call-iptables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.ip_forward = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">vm.swappiness = 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 内核参数生效</span>
</span></span><span style="display:flex;"><span>    sysctl --system
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>__k8s_kernel_iptables</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="8">
<li><!-- raw HTML omitted -->开启<!-- raw HTML omitted --><code>ipvs</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>在<code>kubernetes</code>中<code>service</code>有两种代理模型，一种是基于<code>iptables</code>，另一种是基于<code>ipvs</code>的。<code>ipvs</code>的性能要高于<code>iptables</code>的，但是如果要使用它，需要手动载入<code>ipvs</code>模块。</li>
<li><code>Centos</code><!-- raw HTML omitted -->系统在每个节点安装配置<!-- raw HTML omitted --><code>ipset</code>和<code>ipvsadm</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install ipset ipvsadm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在所有节点执行如下脚本</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/etc/sysconfig/modules/ipvs.modules<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_rr
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_wrr
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- nf_conntrack_ipv4  	# 高版本替换为nf_conntrack
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 授权、运行、检查是否加载</span>
</span></span><span style="display:flex;"><span>$ chmod <span style="color:#ae81ff">755</span> /etc/sysconfig/modules/ipvs.modules <span style="color:#f92672">&amp;&amp;</span> bash /etc/sysconfig/modules/ipvs.modules
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 检查是否加载</span>
</span></span><span style="display:flex;"><span>$ lsmod | grep -e ipvs -e nf_conntrack_ipv4</span></span></code></pre></div><ul>
<li><code>Debian</code><!-- raw HTML omitted -->系统在每个节点安装配置<!-- raw HTML omitted --><code>ipset</code>和<code>ipvsadm</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -vp /etc/modules.d/
</span></span><span style="display:flex;"><span>$ tee /etc/modules.d/k8s.modules <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># netfilter 模块 允许 iptables 检查桥接流量
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- br_netfilter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># containerd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- overlay
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># nf_conntrack
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- nf_conntrack
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ipvs
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_lc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_lblc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_lblcr
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_rr
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_wrr
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_dh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_fo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_nq
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_sed
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_ftp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_tables
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_set
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ipt_set
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ipt_rpfilter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ipt_REJECT
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ipip
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- xt_set
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ chmod <span style="color:#ae81ff">755</span> /etc/modules.d/k8s.modules <span style="color:#f92672">&amp;&amp;</span> bash /etc/modules.d/k8s.modules <span style="color:#f92672">&amp;&amp;</span> lsmod | grep -e ip_vs -e nf_conntrack  
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ip_vs_sh               16384  0  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ip_vs_wrr              16384  0  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ip_vs_rr               16384  0  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ip_vs                 155648  6 ip_vs_rr,ip_vs_sh,ip_vs_wrr  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># nf_conntrack          139264  1 ip_vs  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># nf_defrag_ipv6         24576  2 nf_conntrack,ip_vs  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># nf_defrag_ipv4         16384  1 nf_conntrack  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># libcrc32c              16384  5 nf_conntrack,btrfs,xfs,raid456,ip_vs</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sysctl --system</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="9">
<li><!-- raw HTML omitted -->所有节点配置<!-- raw HTML omitted --><code>Limit</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ulimit -SHn <span style="color:#ae81ff">65536</span>  	<span style="color:#75715e"># 临时生效</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* soft nproc 65535  	# soft 软限制
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* hard nproc 65535  	# hard 硬限制
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* soft nofile 25535
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* hard nofile 25535
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* soft memlock unlimited
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* soft memlock unlimited &#34;</span> &gt;&gt;/etc/security/limits.conf  	<span style="color:#75715e"># 永久生效</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="10">
<li><code>k8s-master01</code><!-- raw HTML omitted -->节点设置免密登录其他节点<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>ssh-keygen</code><!-- raw HTML omitted -->：用于创建密钥的程序<!-- raw HTML omitted --></li>
<li><code>-m PEM</code><!-- raw HTML omitted -->：将密钥的格式设为<!-- raw HTML omitted --><code>PEM</code></li>
<li><code>-t rsa</code><!-- raw HTML omitted -->：创建密钥类型为：<code>RSA</code>格式，系统默认提供名为 <code>id_rsa</code> 的密钥对，有些工具可能要求私钥文件名为<!-- raw HTML omitted --><code>id_rsa</code></li>
<li><code>-b 4096</code><!-- raw HTML omitted -->：密钥的位数，本例中为<!-- raw HTML omitted --><code>4096</code></li>
<li><code>-C &quot;xxx@myserver&quot;</code><!-- raw HTML omitted -->：追加到公钥文件末尾以便于识别的注释。 通常以电子邮件地址用作注释，但也可以使用任何最适合你基础结构的事物<!-- raw HTML omitted --></li>
<li><code>-f ~/.ssh/</code><!-- raw HTML omitted -->：私钥文件的文件名（如果选择不使用默认名称）。 追加了<code>.pub</code>的相应公钥文件在相同目录中生成。 该目录必须存在<!-- raw HTML omitted --></li>
<li><code>-N mypassphrase</code><!-- raw HTML omitted -->：用于访问私钥文件的其他密码<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ssh-keygen <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-m PEM <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-t rsa <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-b <span style="color:#ae81ff">4096</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-C <span style="color:#e6db74">&#34;xxx@163.com&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-f ~/.ssh/name_rsa <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-N mypassphrase
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ <span style="color:#66d9ef">for</span> i in master-01 master-02 noder-01 noder-02 noder-03;<span style="color:#66d9ef">do</span> ssh-copy-id -i .ssh/id_rsa.pub $i;<span style="color:#66d9ef">done</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="11">
<li><!-- raw HTML omitted -->所有节点更新系统并且重启<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y --exclude<span style="color:#f92672">=</span>kernel* update <span style="color:#f92672">&amp;&amp;</span> reboot</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="12">
<li><!-- raw HTML omitted -->升级系统<!-- raw HTML omitted --><code>Kernel</code>内核到<code>4.18+</code>以上</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org
</span></span><span style="display:flex;"><span>$ rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 令列出可用的内核相关包</span>
</span></span><span style="display:flex;"><span>$ yum --disablerepo<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;*&#34;</span> --enablerepo<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;elrepo-kernel&#34;</span> list available
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装最新主线稳定内核</span>
</span></span><span style="display:flex;"><span>$ yum -y --enablerepo<span style="color:#f92672">=</span>elrepo-kernel install kernel-ml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设置 GRUB 默认的内核版本：</span>
</span></span><span style="display:flex;"><span>$ vim /etc/default/grub
</span></span><span style="display:flex;"><span>GRUB_DEFAULT<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>  	<span style="color:#75715e"># 修改部分， GRUB 初始化页面的第一个内核将作为默认内核</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 重新创建内核配置</span>
</span></span><span style="display:flex;"><span>$ grub2-mkconfig -o /boot/grub2/grub.cfg
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ reboot</span></span></code></pre></div></blockquote>
<hr>
<h3 id="所有节点都安装docker">所有节点都安装<code>docker</code></h3>
<ul>
<li>
<ol>
<li><code>yum</code><!-- raw HTML omitted -->源的使用<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->使用官方源 <!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum install -y yum-utils
</span></span><span style="display:flex;"><span>$ yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->使用阿里云官方<code>repo</code>源<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 备份服务器上原有的CentOS-Base和epel</span>
</span></span><span style="display:flex;"><span>$ mv /etc/yum.repos.d/CentOS-Base.repo<span style="color:#f92672">{</span>,.bak<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>$ mv /etc/yum.repos.d/epel.repo<span style="color:#f92672">{</span>,.bak<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装CentOS0-Base和epel源 </span>
</span></span><span style="display:flex;"><span>$ curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo
</span></span><span style="display:flex;"><span>$ curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 第一种方式安装docker 源  </span>
</span></span><span style="display:flex;"><span>$ wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 第二种方式docker源</span>
</span></span><span style="display:flex;"><span>$ yum install -y yum-utils device-mapper-persistent-data lvm2
</span></span><span style="display:flex;"><span>$ yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 做替换</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s+download.docker.com+mirrors.aliyun.com/docker-ce+&#39;</span> /etc/yum.repos.d/docker-ce.repo</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->卸载服务器自带<!-- raw HTML omitted --><code>docker</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->安装对应<code>docker</code>版本服务<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum makecache fast
</span></span><span style="display:flex;"><span>$ yum list docker-ce  --showduplicates|sort -r
</span></span><span style="display:flex;"><span>$ yum install -y docker-ce-20.10.4 docker-ce-cli-20.10.4 containerd.io docker-compose-plugin
</span></span><span style="display:flex;"><span>$ systemctl enable docker <span style="color:#f92672">&amp;&amp;</span> systemctl start docker</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>docker-compose</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo curl -L <span style="color:#e6db74">&#34;https://github.com/docker/compose/releases/download/v2.2.2/docker-compose-</span><span style="color:#66d9ef">$(</span>uname -s<span style="color:#66d9ef">)</span><span style="color:#e6db74">-</span><span style="color:#66d9ef">$(</span>uname -m<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> -o /usr/local/bin/docker-compose
</span></span><span style="display:flex;"><span>$ chmod +x /usr/local/bin/docker-compose
</span></span><span style="display:flex;"><span>$ ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose
</span></span><span style="display:flex;"><span>$ docker compose COMMAND --help  	<span style="color:#75715e"># 查看镜像编写方式</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="6">
<li><code>Kubernetes</code><!-- raw HTML omitted -->文件驱动默认由<!-- raw HTML omitted --><code>systemd</code><!-- raw HTML omitted -->改成<!-- raw HTML omitted --><code>cgroupfs</code><!-- raw HTML omitted -->, 而我们安装的<!-- raw HTML omitted --><code>docker</code><!-- raw HTML omitted -->使用的文件驱动是<!-- raw HTML omitted --><code>systemd</code><!-- raw HTML omitted -->, 造成不一致, 导致镜像无法启动<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>&quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo cat &gt;/etc/docker/daemon.json<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;registry-mirrors&#34;: [&#34;https://bn4ll166.mirror.aliyuncs.com&#34;],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;data-root&#34;: &#34;/data/docker-root&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;dns&#34;: [&#34;223.5.5.5&#34;,&#34;119.29.29.29&#34;],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;bip&#34;: &#34;172.31.255.254/16&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;storage-driver&#34;: &#34;overlay2&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;storage-opts&#34;: [&#34;overlay2.override_kernel_check=true&#34;],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;userland-proxy&#34;: false,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;log-driver&#34;: &#34;json-file&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;log-opts&#34;: {&#34;max-size&#34;: &#34;500m&#34;,&#34;max-file&#34;: &#34;1&#34;},
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;exec-opts&#34;: [&#34;native.cgroupdriver=systemd&#34;],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;live-restore&#34;: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="7">
<li><a href="https://www.qikqiak.com/k8s-book/docs/1.%E8%AF%BE%E7%A8%8B%E4%BB%8B%E7%BB%8D.html" rel="external" target="_self"><code>Docker</code>+<code>Kubernetes</code></a></li>
</ol>
</li>
</ul>
<hr>
<h3 id="所有节点配置kubernetes-yum源">所有节点配置<code>kubernetes yum</code>源</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->国内修改为阿里云<code>yum</code>源 <!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/yum.repos.d/kubernetes.repo<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[kubernetes]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name=Kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">enabled=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgcheck=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">repo_gpgcheck=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->直接使用<code>kubernetes</code>官方<code>yum</code>源<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat <span style="color:#e6db74">&lt;&lt;-EOF | sudo tee /etc/yum.repos.d/kubernetes.repo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[kubernetes]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name=Kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\$basearch
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">enabled=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgcheck=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">exclude=kubelet kubeadm kubectl
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->重启所有节点服务器<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ reboot</span></span></code></pre></div></blockquote>
<hr>
<h3 id="所有节点都安装kubeadmkubeletkubectl">所有节点都安装<code>kubeadm、kubelet、kubectl</code></h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum list kubelet kubeadm kubectl  --showduplicates | sort -r
</span></span><span style="display:flex;"><span>$ yum -y install kubelet-1.24.5 kubeadm-1.24.5 kubectl-1.24.5</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol>
<li><code>--cgroup-driver=systemd</code><!-- raw HTML omitted -->：为了实现<!-- raw HTML omitted --><code>Docker</code><!-- raw HTML omitted -->使用的<!-- raw HTML omitted --><code>cgroup drvier</code><!-- raw HTML omitted -->和<!-- raw HTML omitted --><code>kubelet</code><!-- raw HTML omitted -->使用的<!-- raw HTML omitted --><code>cgroup</code><!-- raw HTML omitted -->默认值为一致，<!-- raw HTML omitted --><code>/etc/sysconfig/kubelet</code><!-- raw HTML omitted -->文件中添加<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>--fail-swap-on=false</code><!-- raw HTML omitted -->忽略<code>swap</code>报错<!-- raw HTML omitted --></li>
<li><code>--feature-gates EphemeralContainers=true</code><!-- raw HTML omitted -->开启临时容器参数<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubelet -h | grep EphemeralContainers</span></span></code></pre></div><div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/sysconfig/kubelet<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">KUBELET_EXTRA_ARGS=&#34;--cgroup-driver=systemd --fail-swap-on=false&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">KUBE_PROXY_MODE=&#34;ipvs&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->置为开机自启动即可，由于没有生成配置文件，集群初始化后自动启动<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl enable kubelet <span style="color:#f92672">&amp;&amp;</span> systemctl start kubelet</span></span></code></pre></div></blockquote>
<hr>
<h2 id="使用kubeadm部署kubernetes">使用<code>Kubeadm</code>部署<code>Kubernetes</code></h2>
<h3 id="查看下载所需镜像">查看下载所需镜像</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->查看<!-- raw HTML omitted --><code>k8s</code><!-- raw HTML omitted -->所需镜像<!-- raw HTML omitted --><code>kubeadm config images list</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm config images list   <span style="color:#75715e"># list替换：pull、拉取镜像</span>
</span></span><span style="display:flex;"><span>k8s.gcr.io/kube-apiserver:v1.24.6
</span></span><span style="display:flex;"><span>k8s.gcr.io/kube-controller-manager:v1.24.6
</span></span><span style="display:flex;"><span>k8s.gcr.io/kube-scheduler:v1.24.6
</span></span><span style="display:flex;"><span>k8s.gcr.io/kube-proxy:v1.24.6
</span></span><span style="display:flex;"><span>k8s.gcr.io/pause:3.7
</span></span><span style="display:flex;"><span>k8s.gcr.io/etcd:3.5.3-0
</span></span><span style="display:flex;"><span>k8s.gcr.io/coredns/coredns:v1.8.6
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ docker images --digests  	<span style="color:#75715e"># 验证镜像完整性</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->下载<code>K8S</code>所需镜像 (如果过程中有提示失败迹象, 那么可能是网络原因, 多执行几次)<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm config images list | xargs -n1 docker pull  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 指定拉取阿里云源的镜像  </span>
</span></span><span style="display:flex;"><span>$ kubeadm config images pull --kubernetes-version<span style="color:#f92672">=</span>v1.20.2 --image-repository<span style="color:#f92672">=</span>registry.aliyuncs.com/google_containers  </span></span></code></pre></div></blockquote>
<hr>
<h3 id="部署master节点">部署<code>master</code>节点</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->两种方式部署<!-- raw HTML omitted --><code>Master</code>节点：<strong>命令行</strong>和**<code>yaml</code>**</li>
<li><!-- raw HTML omitted -->**注意：**主机名中不能带有_（下划线），不然初始化会报错<!-- raw HTML omitted --><a href="https://kubernetes.io/zh/docs/reference/setup-tools/kubeadm/kubeadm-init/" rel="external" target="_self"><code>kubeadm init</code></a></li>
</ul>
</blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->使用命令行方式初始化<!-- raw HTML omitted --><code>Kubernetes</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>--kubernetes-version</code>：指定版本</li>
<li><code>--apiserver-advertise-address</code>：<code>master</code>本机<code>IP</code></li>
<li><code>--service-cidr</code>：<!-- raw HTML omitted -->用于指定为<code>Service</code>分配使用网络地址，它由<code>kubernetes</code>管理，默认网段：<code>10.96.0.0/12</code><!-- raw HTML omitted --></li>
<li><code>--pod-network-cidr</code>：<!-- raw HTML omitted -->启动容器给容器所分配<code>IP</code>，<code>ip a</code>可以查看服务器本机生成<code>IP</code>段，当有从集群外节点通过静态路由方式访问集群内<code>Service</code>的需求时，需要在创建集群时指定<code>pod-network-cidr</code>， 以对来自非<code>Pod</code>网络的流量(外部流量)执行<code>MASQ</code>，外部访问pod服务做<code>nat</code>转发,它通常应该与部署使用的网络插件(例如：<code>flannel</code>、<code>calico</code>)默认设定保持一致，<code>10.244.0.0/16</code>是<code>flannel</code>默认使用网络<!-- raw HTML omitted --></li>
<li><code>--ignore-preflight-errors=Swap</code>：<!-- raw HTML omitted -->通过此参数忽略swap报错<!-- raw HTML omitted --></li>
<li><code>--image-repository registry.aliyuncs.com/google_containers</code>：<!-- raw HTML omitted -->指定从阿里云下载<!-- raw HTML omitted --></li>
<li><code>--cri-socket</code>：<!-- raw HTML omitted -->配置<code>CRI</code>端点<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm init --kubernetes-version<span style="color:#f92672">=</span>v1.24.6 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--apiserver-advertise-address<span style="color:#f92672">=</span>192.168.35.128 --node-name<span style="color:#f92672">=</span>k8s-master <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--service-cidr<span style="color:#f92672">=</span>10.64.0.0/12 --pod-network-cidr<span style="color:#f92672">=</span>10.244.0.0/16 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cri-socket unix:///var/run/containerd/containerd.sock  	<span style="color:#75715e"># 配置 CRI 端点</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->通过配置文件初始化<!-- raw HTML omitted --><code>Kubernetes</code>的<code>master</code>节点</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 输出初始化配置到文件</span>
</span></span><span style="display:flex;"><span>$ kubeadm config print init-defaults &gt;/opt/k8s/yaml/kubeadm-config.yaml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改配置文件</span>
</span></span><span style="display:flex;"><span>apiVersion: kubeadm.k8s.io/v1beta3
</span></span><span style="display:flex;"><span>bootstrapTokens:
</span></span><span style="display:flex;"><span>- groups:
</span></span><span style="display:flex;"><span>    - system:bootstrappers:kubeadm:default-node-token
</span></span><span style="display:flex;"><span>    token: abcdef.0123456789abcdef
</span></span><span style="display:flex;"><span>    ttl: 24h0m0s
</span></span><span style="display:flex;"><span>    usages:
</span></span><span style="display:flex;"><span>    - signing
</span></span><span style="display:flex;"><span>    - authentication
</span></span><span style="display:flex;"><span>kind: InitConfiguration
</span></span><span style="display:flex;"><span>localAPIEndpoint:
</span></span><span style="display:flex;"><span>    advertiseAddress: 1.2.3.4  	<span style="color:#75715e"># 修改为master本机IP</span>
</span></span><span style="display:flex;"><span>    bindPort: <span style="color:#ae81ff">6443</span>  	<span style="color:#75715e"># 使用端口</span>
</span></span><span style="display:flex;"><span>nodeRegistration:
</span></span><span style="display:flex;"><span>    criSocket: unix:///var/run/containerd/containerd.sock  	<span style="color:#75715e"># 配置 CRI 端点</span>
</span></span><span style="display:flex;"><span>    imagePullPolicy: IfNotPresent
</span></span><span style="display:flex;"><span>    name: node  	<span style="color:#75715e"># 配置主机名， 主机名不允许使用下划线</span>
</span></span><span style="display:flex;"><span>    taints: null
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiServer:
</span></span><span style="display:flex;"><span>    timeoutForControlPlane: 4m0s
</span></span><span style="display:flex;"><span>apiVersion: kubeadm.k8s.io/v1beta3
</span></span><span style="display:flex;"><span>certificatesDir: /etc/kubernetes/pki
</span></span><span style="display:flex;"><span>clusterName: kubernetes
</span></span><span style="display:flex;"><span>controllerManager: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>dns: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>etcd:
</span></span><span style="display:flex;"><span>    local:
</span></span><span style="display:flex;"><span>        dataDir: /var/lib/etcd
</span></span><span style="display:flex;"><span>imageRepository: k8s.gcr.io  	<span style="color:#75715e"># 定义使用镜像源</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## imageRepository: registry.aliyuncs.com/google_containers  	# 阿里云镜像源</span>
</span></span><span style="display:flex;"><span>kind: ClusterConfiguration
</span></span><span style="display:flex;"><span>kubernetesVersion: 1.24.6  	<span style="color:#75715e"># 定义kubernetes版本</span>
</span></span><span style="display:flex;"><span>networking:
</span></span><span style="display:flex;"><span>    dnsDomain: cluster.local
</span></span><span style="display:flex;"><span>    serviceSubnet: 10.96.0.0/12  	<span style="color:#75715e"># 10.244.0.0/16 是`flannel`默认使用网络</span>
</span></span><span style="display:flex;"><span>scheduler: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiVersion: kubeproxy.config.k8s.io/v1alpha1
</span></span><span style="display:flex;"><span>kind: KubeProxyConfiguration
</span></span><span style="display:flex;"><span>featureGates:
</span></span><span style="display:flex;"><span>    SupportIPVSProxyMode: true
</span></span><span style="display:flex;"><span>mode: ipvs  	<span style="color:#75715e"># 启用ipvs  </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubeadm init --config<span style="color:#f92672">=</span>/opt/k8s/yaml/kubeadm-config.yaml  	<span style="color:#75715e"># 初始化配置文件</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->如果初始化报错执行下面命令、然后重新初始化<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">############################################################# 	 配置containerd服务</span>
</span></span><span style="display:flex;"><span>$ rm -rf /etc/containerd/config.toml
</span></span><span style="display:flex;"><span>$ containerd config default &gt;/etc/containerd/config.toml  	<span style="color:#75715e"># 生成新配置来覆盖默认配置</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo cat &gt;&gt;/etc/containerd/config.toml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[plugins.&#34;io.containerd.grpc.v1.cri&#34;.containerd.runtimes.runc.options]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> SystemdCgroup = false  	# 修改为：true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>$ systemctl restart containerd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#############################################################  	kubelet 配置文件修改</span>
</span></span><span style="display:flex;"><span>$ sudo cat &gt;&gt;/var/lib/kubelet/kubeadm-flags.env<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">KUBELET_KUBEADM_ARGS=&#34;--container-runtime-endpoint=unix:///var/run/containerd/containerd.sock --pod-infra-container-image=registry.k8s.io/pause:3.9&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动配置增加--container-runtime=remote --container-runtime-endpoint=unix:///var/run/containerd/containerd.sock</span>
</span></span><span style="display:flex;"><span>$ sudo cat &gt;&gt;/usr/lib/systemd/system/kubelet.service<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/usr/bin/kubelet --container-runtime=remote --container-runtime-endpoint=unix:///var/run/containerd/containerd.sock
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">############################################################## 	 删除配置重载</span>
</span></span><span style="display:flex;"><span>$ swapoff -a <span style="color:#f92672">&amp;&amp;</span> kubeadm reset <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	<span style="color:#f92672">&amp;&amp;</span> systemctl daemon-reload <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	<span style="color:#f92672">&amp;&amp;</span> systemctl restart kubelet <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	<span style="color:#f92672">&amp;&amp;</span> iptables -F <span style="color:#f92672">&amp;&amp;</span> iptables -t nat -F <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	<span style="color:#f92672">&amp;&amp;</span> iptables -t mangle -F <span style="color:#f92672">&amp;&amp;</span> iptables -X</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->查看<code>node</code>信息<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl get nodes
</span></span><span style="display:flex;"><span>NAME         STATUS   ROLES                  AGE   VERSION
</span></span><span style="display:flex;"><span>k8s-master   Ready    control-plane,master   23h   v1.21.12
</span></span><span style="display:flex;"><span>k8s-node1    Ready    &lt;none&gt;                 23h   v1.21.12
</span></span><span style="display:flex;"><span>k8s-node2    Ready    &lt;none&gt;                 23h   v1.21.12</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->根据提示消息，在<code>Master</code>节点上使用<code>kubectl</code>工具，可以把下列<code>.kube</code>目录同步到<code>node</code>节点，以便<code>node</code>节点使用<code>kubectl</code>工具<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted --><strong>注意：</strong><!-- raw HTML omitted -->如果不执行<!-- raw HTML omitted -->以下命令<!-- raw HTML omitted -->，执行<code>kubectl get nodes</code>命令报错：<code>couldn't get current server API group list: Get &quot;http://localhost:8080/api?timeout=32s&quot;: dial tcp [::1]:8080: connect: connection refused</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -p $HOME/.kube
</span></span><span style="display:flex;"><span>$ cp -i /etc/kubernetes/admin.conf <span style="color:#e6db74">${</span>HOME<span style="color:#e6db74">}</span>/.kube/config
</span></span><span style="display:flex;"><span>$ chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> <span style="color:#e6db74">${</span>HOME<span style="color:#e6db74">}</span>/.kube/config
</span></span><span style="display:flex;"><span>$ scp -r /root/.kube root@k8s-node-01:/root/</span></span></code></pre></div></blockquote>
<hr>
<h3 id="node节点加入集群"><code>node</code>节点加入集群</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->当主节点启动完<code>k8s</code>之后会生成加入节点的命令，视自己服务器而定<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm join 192.168.35.128:6443 --token l37r7y.75gjs1ltufdp8kp2 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	--discovery-token-ca-cert-hash sha256:9ebc670ec3f97b5f42d77908f378786ed806ef22e9ae2cf21fe5fb239483833c</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->默认<code>token</code>有效期为24小时，当过期之后，该<code>token</code>就不可用了。这时就需要重新创建<code>token</code>，操作如下：<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm token list  	<span style="color:#75715e"># 查看Token</span>
</span></span><span style="display:flex;"><span>$ kubeadm token create --print-join-command
</span></span><span style="display:flex;"><span>$ kubeadm token create --ttl <span style="color:#ae81ff">0</span> --print-join-command  <span style="color:#75715e"># 生成一个永不过期的token</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 重新获取sha56key</span>
</span></span><span style="display:flex;"><span>$ openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outfrom der 2&gt;dev/null | openssl dgst -sha256 -hex | sed <span style="color:#e6db74">&#39;s/^.* //&#39;</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><code>master</code><!-- raw HTML omitted -->执行命令查看节点是否已加入<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl get componentstatuses  	<span style="color:#75715e"># 查看集群健康状况，缩写为：cs</span>
</span></span><span style="display:flex;"><span>NAME                 STATUS    MESSAGE             ERROR
</span></span><span style="display:flex;"><span>scheduler            Healthy   ok                  
</span></span><span style="display:flex;"><span>controller-manager   Healthy   ok                  
</span></span><span style="display:flex;"><span>etcd-0               Healthy   <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;health&#34;</span>:<span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">}</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->查看部署好的命名空间<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>default</code><!-- raw HTML omitted -->：所有未指定的<code>Namespace</code>的对象都会被分配在default命名空间<!-- raw HTML omitted --></li>
<li><code>kube-node-lease</code><!-- raw HTML omitted -->：集群节点之间的心跳维护，<code>v1.13</code>开始引入<!-- raw HTML omitted --></li>
<li><code>kube-public</code><!-- raw HTML omitted -->：此命名空间的资源可以被所有人访问（包括未认证用户）<!-- raw HTML omitted --></li>
<li><code>kube-system</code><!-- raw HTML omitted -->：所有由<code>kubernetes</code>系统创建的资源都处于这个命名空间<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl get namespace  <span style="color:#75715e"># 缩写为： ns</span>
</span></span><span style="display:flex;"><span>NAME              STATUS   AGE 
</span></span><span style="display:flex;"><span>default           Active   19h
</span></span><span style="display:flex;"><span>kube-node-lease   Active   19h
</span></span><span style="display:flex;"><span>kube-public       Active   19h
</span></span><span style="display:flex;"><span>kube-system       Active   19h</span></span></code></pre></div></blockquote>
<hr>
<h4 id="处理集群状态statusnotreadyfont-colorred是网络不通部署fontcnifont-colorred网络插件font">处理集群状态：<code>STATUS：NotReady</code><!-- raw HTML omitted -->是网络不通部署：<!-- raw HTML omitted --><code>CNI</code><!-- raw HTML omitted -->网络插件<!-- raw HTML omitted --></h4>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://segmentfault.com/a/1190000018698263" rel="external" target="_self">网络：<code>Flannel</code>、<code>Calico</code>、<code>Canal</code>和<code>Weave</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://dockone.io/article/10501" rel="external" target="_self">简单聊聊<code>Calico</code>与<code>Flannel</code></a></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li><code>kubernetes</code><!-- raw HTML omitted -->支持多种网络插件，比如<!-- raw HTML omitted --><code>flannel</code>、<code>calico</code>、<code>canal</code><!-- raw HTML omitted -->等，任选一种即可，本次选择<!-- raw HTML omitted --><code>flannel</code><!-- raw HTML omitted -->，当然你也可以安装<!-- raw HTML omitted --><code>calico</code><!-- raw HTML omitted -->，推荐安装<!-- raw HTML omitted --><code>calico</code></li>
<li><!-- raw HTML omitted -->在<code>Master</code>节点上获取<code>flannel</code>配置文件(可能会失败，如果失败，请下载到本地，然后安装)：<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li>
<ol>
<li><code>flannel、calico</code><!-- raw HTML omitted -->：基于隧道<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>隧道方案最具普适性，在任何网络环境下都可以正常工作，这与它的原理密不可分。</li>
<li>最常见的隧道方案是<code>flannel &quot;Type&quot;: &quot;vxlan&quot;</code>模式，以及<code>calico</code>的<code>ipip</code>模式，</li>
</ul>
</blockquote>
<ul>
<li>
<ol start="2">
<li><code>flannel、calico</code><!-- raw HTML omitted -->：基于路由<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>路由方案性能最好，原因是该方案不需要封包和解包，所以没有隧道方案的劣势，网络性能很好。</li>
<li>常见的路由方案包括了<code>flannel</code>的<code>&quot;Type&quot;: &quot;host-gw&quot;</code>模式，以及<code>calico</code>的<code>bgp</code>模式。</li>
<li><code>master</code><!-- raw HTML omitted -->节点执行一下语句安装<!-- raw HTML omitted --><code>calico</code><!-- raw HTML omitted -->网络插件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ curl https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/calico.yaml -O
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 看情况修改 calico配置文件</span>
</span></span><span style="display:flex;"><span>$ cat &gt;calico.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- name: CALICO_IPV4POOL_CIDR  	# 修改 CALICO_IPV4POOL_CIDR对应的参数
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  value: &#34;192.168.1.0/24&#34;  	# 修改为 --pod-network-cidr 对应的网段
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改calico 镜像地址</span>
</span></span><span style="display:flex;"><span>$ grep image calico.yaml
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s#docker.io/##g&#39;</span> calico.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl apply -f calico.yaml</span></span></code></pre></div><ul>
<li><code>master</code><!-- raw HTML omitted -->节点执行一下语句安装<code>flannel</code>网络插件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget -P /opt/k8s/yaml/ https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</span></span><span style="display:flex;"><span>$ kubectl get pods -n kube-system</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><code>kubernetes</code><!-- raw HTML omitted -->中<code>kubectl</code>命令自动补全<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum install -y bash-completion
</span></span><span style="display:flex;"><span>$ source /etc/profile.d/bash_completion.sh</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->集群不健康<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>
<p><!-- raw HTML omitted -->需要注释掉<!-- raw HTML omitted --><code>etc/kubernetes/manifests</code>目录下的<code>kube-controller-manager.yaml</code>和<code>kube-scheduler.yaml</code>的<code>--port=0</code>：</p>
</li>
<li>
<p><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>kube-controller-manager.yaml</code>文件</p>
</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo cat &gt;&gt;/etc/kubernetes/manifests/kube-controller-manager.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - command:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - kube-controller-manager
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --allocate-node-cidrs=true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --authentication-kubeconfig=/etc/kubernetes/controller-manager.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --authorization-kubeconfig=/etc/kubernetes/controller-manager.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --bind-address=127.0.0.1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --client-ca-file=/etc/kubernetes/pki/ca.crt
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --cluster-cidr=10.244.0.0/16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --cluster-name=kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --cluster-signing-cert-file=/etc/kubernetes/pki/ca.crt
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --cluster-signing-key-file=/etc/kubernetes/pki/ca.key
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --controllers=*,bootstrapsigner,tokencleaner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --kubeconfig=/etc/kubernetes/controller-manager.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --leader-elect=true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # 修改部分
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # - --port=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --root-ca-file=/etc/kubernetes/pki/ca.crt
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --service-account-private-key-file=/etc/kubernetes/pki/sa.key
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --service-cluster-ip-range=10.96.0.0/12
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --use-service-account-credentials=true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>kube-scheduler.yaml</code>文件</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo cat &gt;&gt;/etc/kubernetes/manifests/kube-scheduler.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - command:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - kube-scheduler
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --authentication-kubeconfig=/etc/kubernetes/scheduler.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --authorization-kubeconfig=/etc/kubernetes/scheduler.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --bind-address=127.0.0.1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --kubeconfig=/etc/kubernetes/scheduler.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --leader-elect=true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # 修改部分
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # - --port=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在所有Master节点再次查看集群健康状况：</span>
</span></span><span style="display:flex;"><span>$ kubectl get cs</span></span></code></pre></div></blockquote>
<hr>
<h2 id="部署kubernetes集群">部署<code>Kubernetes</code>集群</h2>
<h3 id="安装高可用组件">安装高可用组件</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->注意：如果不是高可用集群，<!-- raw HTML omitted --><code>haproxy</code>和<code>keepalived</code>无需安装</li>
</ul>
</blockquote>
<ul>
<li>
<ol>
<li>所有<code>Master</code>节点安装<code>HAPROXY</code>和<code>Keepalived</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install keepalived haproxy</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->所有<!-- raw HTML omitted --><code>Master</code><!-- raw HTML omitted -->节点配置<!-- raw HTML omitted --><code>HAProxy</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/haproxy/haproxy.cfg<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">global
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	maxconn  2000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	ulimit-n  16384
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	log  127.0.0.1 local0 err
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	stats timeout 30s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">defaults
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	log global
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	mode  http
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	option  httplog
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	timeout connect 5000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	timeout client  50000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	timeout server  50000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	timeout http-request 15s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	timeout http-keep-alive 15s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">frontend monitor-in
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	bind *:33305
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	mode http
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	option httplog
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	monitor-uri /monitor
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">listen stats
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	bind    *:8006
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	mode    http
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	stats   enable
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	stats   hide-version
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	stats   uri       /stats
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	stats   refresh   30s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	stats   realm     Haproxy\ Statistics
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	stats   auth      admin:admin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">frontend k8s-master
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	bind 0.0.0.0:16443
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	bind 127.0.0.1:16443
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	mode tcp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	option tcplog
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	tcp-request inspect-delay 5s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	default_backend k8s-master
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">backend k8s-master
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	mode tcp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	option tcplog
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	option tcp-check
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	balance roundrobin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# 下面的配置根据实际情况修改
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	server k8s-master-01 192.168.80.210:6443  check
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	server k8s-master-02 192.168.80.211:6443  check
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><code>Msster-01</code>的<code>Keepalived</code><!-- raw HTML omitted -->配置文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/keepalived/keepalived.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">! Configuration File for keepalived
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	global_defs {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		# 标识本节点的字条串，通常为 hostname
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		router_id k8s-master-01
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		script_user root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		enable_script_security    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# 检测脚本
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# keepalived会定时执行脚本并对脚本执行的结果进行分析，动态调整vrrp_instance的优先级。如果脚本执行结果为0，并且weight配置的值大于0，则优先级相应的增加。如果脚本执行结果非0，并且weight配置的值小于0，则优先级相应的减少。其他情况，维持原本配置的优先级，即配置文件中priority对应的值。
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	vrrp_script chk_apiserver {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		script &#34;/etc/keepalived/check_apiserver.sh&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        # 每2秒检查一次
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        interval 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        # 一旦脚本执行成功，权重减少5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        weight -5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        fall 3  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        rise 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# 定义虚拟路由，VI_1 为虚拟路由的标示符，自己定义名称
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	vrrp_instance VI_1 {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		# 主节点为 MASTER，对应的备份节点为 BACKUP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		state MASTER
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		# 绑定虚拟 IP 的网络接口，与本机 IP 地址所在的网卡名称相同
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		interface ens32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		# 主机的IP地址
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		mcast_src_ip 192.168.80.210
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		# 虚拟路由id
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		virtual_router_id 100
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		# 节点优先级，值范围 0-254，MASTER 要比 BACKUP 高
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		priority 100
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		# 优先级高的设置 nopreempt 解决异常恢复后再次抢占的问题
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		nopreempt 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		# 组播信息发送间隔，所有节点设置必须一样，默认 1s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		advert_int 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        # 设置验证信息，所有节点必须一致
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		authentication {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			auth_type PASS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			auth_pass K8SHA_KA_AUTH
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		# 虚拟 IP 池, 所有节点设置必须一样
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		virtual_ipaddress {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			# 虚拟 ip，可以定义多个	
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			192.168.80.220/24
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		track_script {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			chk_apiserver
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><code>Master-02</code>的<code>Keepalived</code><!-- raw HTML omitted -->配置文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/keepalived/keepalived.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">! Configuration File for keepalived
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	global_defs {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		router_id k8s-master-02
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		script_user root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		enable_script_security    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	vrrp_script chk_apiserver {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		script &#34;/etc/keepalived/check_apiserver.sh&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		interval 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		weight -5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		fall 3  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		rise 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	vrrp_instance VI_1 {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		state BACKUP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		interface ens32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		mcast_src_ip 192.168.80.211
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		virtual_router_id 101
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		priority 99
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		advert_int 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		authentication {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			auth_type PASS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			auth_pass K8SHA_KA_AUTH
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		virtual_ipaddress {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			192.168.80.220/24
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		track_script {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			chk_apiserver
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li>所有<code>Master</code><!-- raw HTML omitted -->节点设置监控脚本，并且给予执行权限<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/keepalived/check_apiserver.sh<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">err=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">for k in $(seq 1 5)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">do
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	check_code=$(pgrep kube-apiserver)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	if [[ $check_code == &#34;&#34; ]]; then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		err=$(expr $err + 1)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		sleep 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		continue
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	else
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		err=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		break
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">done
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if [[ $err != &#34;0&#34; ]]; then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	echo &#34;systemctl stop keepalived&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	/usr/bin/systemctl stop keepalived
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	exit 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">else
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	exit 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>$ chmod +x /etc/keepalived/check_apiserver.sh</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li>所有<code>Master</code><!-- raw HTML omitted -->节点启动<!-- raw HTML omitted --><code>HAProxy</code>和<code>Keepalived</code>并且测试<code>VIP(虚拟IP)</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl daemon-reload
</span></span><span style="display:flex;"><span>$ systemctl enable --now haproxy
</span></span><span style="display:flex;"><span>$ systemctl enable --now keepalived
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ping 192.168.80.220 -c <span style="color:#ae81ff">4</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="初始化kubernetes">初始化<code>Kubernetes</code></h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->命令行<!-- raw HTML omitted --><!-- raw HTML omitted -->方式初始化所有<!-- raw HTML omitted --><code>Master</code>节点</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>在<code>k8s-master01</code><!-- raw HTML omitted -->节点执行下面的命令：<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm init <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --apiserver-advertise-address<span style="color:#f92672">=</span>192.168.80.210 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --image-repository registry.aliyuncs.com/google_containers <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --control-plane-endpoint<span style="color:#f92672">=</span>192.168.80.225:16443 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --kubernetes-version v1.20.2 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --service-cidr<span style="color:#f92672">=</span>10.96.0.0/12 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --pod-network-cidr<span style="color:#f92672">=</span>10.244.0.0/16 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --cri-socket unix:///var/run/containerd/containerd.sock  	<span style="color:#75715e"># 配置 CRI 端点</span>
</span></span><span style="display:flex;"><span>  --upload-certs</span></span></code></pre></div><ul>
<li>将<code>k8s-master02</code><!-- raw HTML omitted -->节点加入到集群中，其他<code>master</code>节点加入同样命令<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm join 192.168.80.225:16443 --token povqsg.arg07e5ia1pywr71 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --discovery-token-ca-cert-hash sha256:9efd30b7f35747289b9de0c8d0768b9c2d5eb7d675cb86fa05b9a6d9526c3441 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --control-plane --certificate-key 363cc6296537b41607851c10f1f41ef23cf5cdc6965cb9c26e4b252315086855</span></span></code></pre></div><ul>
<li>防止在<code>Master-02</code><!-- raw HTML omitted -->节点中不能使用<!-- raw HTML omitted --><code>kubectl</code>命令</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -p $HOME/.kube
</span></span><span style="display:flex;"><span>$ sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style="display:flex;"><span>$ sudo chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config</span></span></code></pre></div><ul>
<li>如果<code>Token</code>过期，需要在<code>Master-01</code><!-- raw HTML omitted -->生成新的<!-- raw HTML omitted --><code>Token</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm token create --print-join-command</span></span></code></pre></div><ul>
<li>如果<code>Master</code><!-- raw HTML omitted -->要加入到集群中，需要在<!-- raw HTML omitted --><code>Master-01</code>生成<code>--certificate-key</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm init phase upload-certs --upload-certs</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><code> yaml</code><!-- raw HTML omitted -->方式初始化所有<!-- raw HTML omitted --><code>Master</code>节点</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>在<code>k8s-master01</code><!-- raw HTML omitted -->创建目录生成配置文件<!-- raw HTML omitted --><code>kubeadm-config.yaml</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -p /opt/k8s/yaml
</span></span><span style="display:flex;"><span>$ kubeadm config print init-defaults &gt;/opt/k8s/yaml/kubeadm-config.yaml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改配置文件</span>
</span></span><span style="display:flex;"><span>apiVersion: kubeadm.k8s.io/v1beta3
</span></span><span style="display:flex;"><span>bootstrapTokens:
</span></span><span style="display:flex;"><span>- groups:
</span></span><span style="display:flex;"><span>    - system:bootstrappers:kubeadm:default-node-token
</span></span><span style="display:flex;"><span>    token: abcdef.0123456789abcdef
</span></span><span style="display:flex;"><span>    ttl: 24h0m0s
</span></span><span style="display:flex;"><span>    usages:
</span></span><span style="display:flex;"><span>    - signing
</span></span><span style="display:flex;"><span>    - authentication
</span></span><span style="display:flex;"><span>kind: InitConfiguration
</span></span><span style="display:flex;"><span>localAPIEndpoint:
</span></span><span style="display:flex;"><span>    advertiseAddress: 1.2.3.4  	<span style="color:#75715e"># 修改为master本机IP</span>
</span></span><span style="display:flex;"><span>    bindPort: <span style="color:#ae81ff">6443</span>  	<span style="color:#75715e"># 使用端口</span>
</span></span><span style="display:flex;"><span>nodeRegistration:
</span></span><span style="display:flex;"><span>    criSocket: unix:///var/run/containerd/containerd.sock  	<span style="color:#75715e"># 配置 CRI 端点</span>
</span></span><span style="display:flex;"><span>    imagePullPolicy: IfNotPresent
</span></span><span style="display:flex;"><span>    name: node  	<span style="color:#75715e"># 配置主机名， 主机名不允许使用下划线</span>
</span></span><span style="display:flex;"><span>    taints: null
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiServer:
</span></span><span style="display:flex;"><span>    timeoutForControlPlane: 4m0s
</span></span><span style="display:flex;"><span>apiVersion: kubeadm.k8s.io/v1beta3
</span></span><span style="display:flex;"><span>certificatesDir: /etc/kubernetes/pki
</span></span><span style="display:flex;"><span>clusterName: kubernetes
</span></span><span style="display:flex;"><span>controllerManager: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>dns: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>etcd:
</span></span><span style="display:flex;"><span>    local:
</span></span><span style="display:flex;"><span>        dataDir: /var/lib/etcd
</span></span><span style="display:flex;"><span>imageRepository: k8s.gcr.io  	<span style="color:#75715e"># 定义使用镜像源</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># imageRepository: registry.aliyuncs.com/google_containers  	# 阿里云镜像源</span>
</span></span><span style="display:flex;"><span>kind: ClusterConfiguration
</span></span><span style="display:flex;"><span>kubernetesVersion: 1.24.0  	<span style="color:#75715e"># 定义kubernetes版本</span>
</span></span><span style="display:flex;"><span>networking:
</span></span><span style="display:flex;"><span>    dnsDomain: cluster.local
</span></span><span style="display:flex;"><span>    serviceSubnet: 10.96.0.0/12
</span></span><span style="display:flex;"><span>scheduler: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiVersion: kubeproxy.config.k8s.io/v1alpha1
</span></span><span style="display:flex;"><span>kind: KubeProxyConfiguration
</span></span><span style="display:flex;"><span>featureGates:
</span></span><span style="display:flex;"><span>    SupportIPVSProxyMode: true
</span></span><span style="display:flex;"><span>mode: ipvs  	<span style="color:#75715e"># 启用ipvs</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->可以使用如下的命令更新<!-- raw HTML omitted --><code>kubeadm-config.yaml</code>文件，需要将<code>k8s</code>设置到对应的版本</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm config migrate --old-config /opt/k8s/yaml/kubeadm-config.yaml --new-config <span style="color:#e6db74">&#34;new.yaml&#34;</span></span></span></code></pre></div><ul>
<li>将<code>new.yaml</code><!-- raw HTML omitted -->文件复制到所有的<!-- raw HTML omitted --><code>master</code>节点</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ scp new.yaml k8s-master-02:/opt/k8s/yaml/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看以及下载所有master节点提前下载镜像</span>
</span></span><span style="display:flex;"><span>$ kubeadm config images pull --config /opt/k8s/yaml/new.yaml  	<span style="color:#75715e"># pull替换list可查看所需镜像</span></span></span></code></pre></div><ul>
<li><code>k8s-master01</code>节点初始化后，会在<code>/etc/kubernetes</code><!-- raw HTML omitted -->目录下生成对应的证书和配置文件，之后其他的<!-- raw HTML omitted --><code>Master</code>节点加入到<code>k8s-master01</code>节点即可</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm init --config /opt/k8s/yaml/new.yaml --upload-certs</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->如果初始化失败，重置后再次初始化，命令如下：<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm reset -f;ipvsadm --clear;rm -rf ~/.kube</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->初始化成功后，会产生<!-- raw HTML omitted --><code>token</code>值，用于其他节点加入时使用，</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>Your Kubernetes control-plane has initialized successfully!
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>To start using your cluster, you need to run the following as a regular user:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  mkdir -p $HOME/.kube
</span></span><span style="display:flex;"><span>  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style="display:flex;"><span>  sudo chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Alternatively, <span style="color:#66d9ef">if</span> you are the root user, you can run:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  export KUBECONFIG<span style="color:#f92672">=</span>/etc/kubernetes/admin.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>You should now deploy a pod network to the cluster.
</span></span><span style="display:flex;"><span>Run <span style="color:#e6db74">&#34;kubectl apply -f [podnetwork].yaml&#34;</span> with one of the options listed at:
</span></span><span style="display:flex;"><span>  https://kubernetes.io/docs/concepts/cluster-administration/addons/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>You can now join any number of the control-plane node running the following command on each as root:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 其他 Master 节点执行</span>
</span></span><span style="display:flex;"><span>  kubeadm join 192.168.80.210:16443 --token abcdef.0123456789abcdef <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --discovery-token-ca-cert-hash sha256:505e373bae6123fc3e27e778c5fedbccbf0f91a51efdcc11b32c4573605b8e71 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --control-plane --certificate-key 70aef5f76111a5824085c644b3f34cf830efad00c1b16b878701166bf069664e
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Please note that the certificate-key gives access to cluster sensitive data, keep it secret!
</span></span><span style="display:flex;"><span>As a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;kubeadm init phase upload-certs --upload-certs&#34;</span> to reload certs afterward.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Then you can join any number of worker nodes by running the following on each as root:
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 所有 Node 节点执行</span>
</span></span><span style="display:flex;"><span>kubeadm join 192.168.80.210:16443 --token abcdef.0123456789abcdef <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --discovery-token-ca-cert-hash sha256:505e373bae6123fc3e27e778c5fedbccbf0f91a51efdcc11b32c4573605b8e71</span></span></code></pre></div><ul>
<li><code>k8s-master01</code><!-- raw HTML omitted -->节点配置环境变量，用于访问<!-- raw HTML omitted --><code>kubernetes</code>集群</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># root用户</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/root/.bashrc<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export KUBECONFIG=/etc/kubernetes/admin.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ source ~/.bash_profile
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 普通用户</span>
</span></span><span style="display:flex;"><span>$ mkdir -p $HOME/.kube
</span></span><span style="display:flex;"><span>$ sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style="display:flex;"><span>$ sudo chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># k8s-master-01中查看节点的状态：</span>
</span></span><span style="display:flex;"><span>$ kubectl get nodes</span></span></code></pre></div></blockquote>
<hr>
<h3 id="node节点加入集群-1"><code>Node</code>节点加入集群</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->所有<!-- raw HTML omitted --><code>Node</code><!-- raw HTML omitted -->节点执行<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm join 192.168.80.225:16443 --token povqsg.arg07e5ia1pywr71 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> --discovery-token-ca-cert-hash sha256:9efd30b7f35747289b9de0c8d0768b9c2d5eb7d675cb86fa05b9a6d9526c3441</span></span></code></pre></div></blockquote>
<hr>
<h2 id="font-colorred二进制安装fontkubernetes"><!-- raw HTML omitted -->二进制安装<!-- raw HTML omitted --><code>kubernetes</code></h2>
<h3 id="部署etcd存储集群三台主机作为节点">部署<code>Etcd</code>存储集群、三台主机作为节点</h3>
<ul>
<li>
<ol>
<li>键值对数据库，存储<code>K8S</code>集群所有重要信息(持久化)  <a href="https://blog.csdn.net/qq_27276045/article/details/115650151" rel="external" target="_self"><code>Kubernetes</code>存储大脑之<code>etcd</code></a>、<a href="https://www.infoq.cn/article/rhzug069xvr5z5bhhtiv" rel="external" target="_self">突破<code>etcd</code>限制！字节开源自研<code>K8s</code>存储<code>KubeBrain</code></a></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>Etcd 是一个分布式键值存储系统，Kubernetes使用Etcd进行数据存储，所以先准备一个Etcd数据库，为解决Etcd单点故障，应采用集群方式部署，这里使用3台组建集群，可容忍1台机器故障，当然，你也可以使用5台组建集群，可容忍2台机器故障</span></span></code></pre></div><ul>
<li>1.1 注意这里<code>profiles</code>字段下名称，其中<code>CjServer</code>下注明<code>server auth</code>用于服务器端认证，后续在生成服务器证书时候，需要使用这个名称作为<code>cfssl</code>命令的配置文件名称作为参数传入。</li>
<li>1.2 注意这里<code>profiles</code>字段下名称，其中<code>CjServer</code>下注明<code>server auth</code>用于服务器端认证，后续在生成服务器证书时候，需要使用这个名称作为<code>cfssl</code>命令的配置文件名称作为参数传入。</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">{</span><span style="color:#e6db74">&#34;code&#34;</span>:5100,<span style="color:#e6db74">&#34;message&#34;</span>:<span style="color:#e6db74">&#34;Invalid policy: no key usage available&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>Failed to parse input: unexpected end of JSON input</span></span></code></pre></div><ul>
<li>1.3 往往是提供的<code>-profile</code>参数中的配置文件名在<code>ca-config.json</code>中无法匹配</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 1.准备cfssl证书生成工具、cfssl是一个开源的证书管理工具，使用json文件生成证书，找任意一台服务器操作，
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cd /usr/local/src/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64  	# 是v1.2.0 最好升级到v1.3.4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ chmod +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 添加环境变量第一种方式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ vim /etc/profile
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export PATH=$PATH:/opt/kubernetes/bin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ source /etc/profile
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 把可执行文件挪移并改名
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ mv cfssl_linux-amd64 /usr/local/bin/cfssl
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ mv cfssljson_linux-amd64 /usr/local/bin/cfssljson
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ mv cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 2.生成Etcd证书、自签证书颁发机构（CA）创建工作目录：
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cat &gt;/opt/kubernetes/ssl/ca-config.json&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;signing&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;default&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;expiry&#34;: &#34;87600h&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;profiles&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;kubernetes&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         &#34;expiry&#34;: &#34;87600h&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         &#34;usages&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;signing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;key encipherment&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;server auth&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;client auth&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">###################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cat &gt;/opt/kubernetes/ssl/ca-csr.json&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;CN&#34;: &#34;etcd CA&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;key&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;size&#34;: 2048
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;names&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;L&#34;: &#34;Beijing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;ST&#34;: &#34;Beijing&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 3.生成证书
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cd /opt/kubernetes/ssl/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cfssl gencert -initca ca-csr.json | cfssljson -bare ca -
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 4. 使用自签CA签发Etcd HTTPS证书:创建证书申请文件  #####
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cat &gt;/opt/kubernetes/ssl/etcd-csr.json&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;CN&#34;: &#34;etcd&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;hosts&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;192.168.4.110&#34;, # 修改IP、为了扩容方便可以多写几个IP、去掉注释
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;192.168.4.111&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;192.168.4.112&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;xxx.xxx.xxx.xxx&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;xxx.xxx.xxx.xxx&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;xxx.xxx.xxx.xxx&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;key&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;size&#34;: 2048
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;names&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;L&#34;: &#34;BeiJing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;ST&#34;: &#34;BeiJing&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 5. 生成证书
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cd /opt/kubernetes/ssl/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes etcd-csr.json | cfssljson -bare etcd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 6.在GitHub上下载二进制文件
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cd /usr/local/src/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ wget https://github.com/etcd-io/etcd/releases/download/v3.4.14/etcd-v3.4.14-linux-amd64.tar.gz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ tar zxvf etcd-v3.4.14-linux-amd64.tar.gz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ mv etcd-v3.4.14-linux-amd64/{etcd,etcdctl} /opt/etcd/bin/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 6.创建etcd配置文件：针对IP修改为本机IP，拷贝过去后把所有结尾的“注释取消掉”
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cat &gt;/opt/etcd/cfg/etcd.conf&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># [Member]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ETCD_NAME=&#34;etcd-node1&#34;  	# 修改此处，节点2改为etcd-2，节点3改为etcd-3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ETCD_DATA_DIR=&#34;/var/lib/etcd/default.etcd&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ETCD_LISTEN_PEER_URLS=&#34;https://192.168.4.110:2380&#34;  	# 修改此处为当前服务器IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ETCD_LISTEN_CLIENT_URLS=&#34;https://192.168.4.110:2379,https://127.0.0.1:2379&#34;  	# 修改此处为当前服务器IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># [Clustering]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ETCD_INITIAL_ADVERTISE_PEER_URLS=&#34;https://192.168.4.110:2380&#34;  	# 修改此处为当前服务器IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ETCD_ADVERTISE_CLIENT_URLS=&#34;https://192.168.4.110:2379&#34;  # 修改此处为当前服务器IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 修改为所有节点IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ETCD_INITIAL_CLUSTER=&#34;etcd-node1=https://192.168.4.110:2380,etcd-node2=https://192.168.4.111:2380,etcd-node3=https://192.168.4.112:2380&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ETCD_INITIAL_CLUSTER_TOKEN=&#34;etcd-cluster&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ETCD_INITIAL_CLUSTER_STATE=&#34;new&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># [security]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># CLIENT_CERT_AUTH=&#34;true&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_CA_FILE=&#34;/opt/etcd/ssl/ca.pem&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_CERT_FILE=&#34;/opt/etcd/ssl/server.pem&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_KEY_FILE=&#34;/opt/etcd/ssl/server-key.pem&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># PEER_CLIENT_CERT_AUTH=&#34;true&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_PEER_CA_FILE=&#34;/opt/etcd/ssl/ca.pem&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_PEER_CERT_FILE=&#34;/opt/etcd/ssl/server.pem&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_PEER_KEY_FILE=&#34;/opt/etcd/ssl/server-key.pem&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#####################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_NAME：节点名称，集群中唯一
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_DATA_DIR：数据目录
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_LISTEN_PEER_URLS：集群通信监听地址
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_LISTEN_CLIENT_URLS：客户端访问监听地址
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_INITIAL_ADVERTISE_PEER_URLS：集群通告地址
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_ADVERTISE_CLIENT_URLS：客户端通告地址
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_INITIAL_CLUSTER：集群节点地址
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_INITIAL_CLUSTER_TOKEN：集群Token
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_INITIAL_CLUSTER_STATE：加入集群的当前状态，new是新集群，existing表示加入已有集群
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 7.systemctl管理etcd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cat &gt;/usr/lib/systemd/system/etcd.service&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=Etcd Server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Wants=network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Type=notify
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EnvironmentFile=/opt/etcd/cfg/etcd.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/etcd/bin/etcd \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cert-file=/opt/etcd/ssl/etcd.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--key-file=/opt/etcd/ssl/etcd-key.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--peer-cert-file=/opt/etcd/ssl/etcd.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--peer-key-file=/opt/etcd/ssl/etcd-key.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--trusted-ca-file=/opt/etcd/ssl/ca.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--peer-trusted-ca-file=/opt/etcd/ssl/ca.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--logger=zap
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LimitNOFILE=65536
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">###################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 8.拷贝刚刚生成证书到etcd目录下
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cd /opt/kubernetes/ssl/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cp ca*.pem etcd*.pem /opt/etcd/ssl/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 9.节点1生成的所有文件拷贝到其他所有节点、然后在其他节点分别修改etcd.conf配置文件中的节点名称和当前服务器IP：
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ ansible node -i /etc/ansible/hosts -m copy -a &#34;src=../../../opt/etcd dest=/opt&#34; -f 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ ansible node -i /etc/ansible/hosts -m copy -a &#34;src=../../../usr/lib/systemd/system/etcd.service dest=/usr/lib/systemd/system&#34; -f 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ mkdir -p /var/lib/etcd  	# 三个节点都执行
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ chmod +x /opt/etcd/bin/*  	# 其他两个节点执行语句给予执行权限
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 10.所有节点设置开机自启
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ systemctl daemon-reload
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ systemctl enable etcd &amp;&amp; systemctl start etcd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 测试etcd数据库可用性
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ etcdctl set testdir/testkey0 0  	# 设置一个键值对 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ etcdctl get testdir/testkey0  	# 查看是否获取到数据
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ etcdctl -C http://localhost:2379 cluster-health
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 11.查看集群状态
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ ETCDCTL_API=3 /opt/etcd/bin/etcdctl --cacert=/opt/etcd/ssl/ca.pem --cert=/opt/etcd/ssl/etcd.pem --key=/opt/etcd/ssl/etcd-key.pem --endpoints=&#34;https://192.168.4.110:2379,https://192.168.4.111:2379,https://192.168.4.112:2379&#34; endpoint health &#39;</span> &gt;&gt;install_etcd.sh</span></span></code></pre></div></blockquote>
<hr>
<h3 id="署master-node生成kube-apiserver证书自签证书颁发机构ca">署<code>Master Node</code>，生成<code>kube-apiserver</code>证书：自签证书颁发机构<code>CA</code></h3>
<ul>
<li>
<ol>
<li><code>api-server：</code>所有服务访问统一入口</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 1.创建证书申请文件：
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># hosts字段中IP为所有Master/LB/VIP IP,一个都不能少！为了方便后期扩容可以多写几个预留的IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cat &gt; /opt/kubernetes/ssl/kube-apiserver-csr.json &lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;CN&#34;: &#34;kubernetes&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;hosts&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;10.0.0.1&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;127.0.0.1&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;192.168.4.110&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;192.168.4.111&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;192.168.4.112&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;xxx.xxx.xxx.xxx&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;xxx.xxx.xxx.xxx&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;kubernetes&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;kubernetes.default&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;kubernetes.default.svc&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;kubernetes.default.svc.cluster&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;kubernetes.default.svc.cluster.local&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;key&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;size&#34;: 2048
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">},
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;names&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;L&#34;: &#34;BeiJing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;ST&#34;: &#34;BeiJing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;O&#34;: &#34;k8s&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;OU&#34;: &#34;System&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">######################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 2.生成证书:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cd /opt/kubernetes/ssl
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-apiserver-csr.json | cfssljson -bare api-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 打开链接下载二进制包
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.20.md#v1202
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cd /usr/local/src
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ wget https://dl.k8s.io/v1.18.6/kubernetes-server-linux-amd64.tar.gz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ tar zxvf kubernetes-server-linux-amd64.tar.gz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cd kubernetes/server/bin/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cp kube-apiserver kube-scheduler kube-controller-manager /opt/kubernetes/bin/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cp kubectl /usr/bin/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 3.部署kube-apiserver
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 两个&#34;\\&#34;第一个是转义符，第二个是换行符，使用转义符是为了使用EOF保留换行符
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cat &gt;/opt/kubernetes/cfg/kube-apiserver.conf&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">KUBE_APISERVER_OPTS=&#34;--logtostderr=false \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--v=2 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--log-dir=/opt/kubernetes/logs \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--etcd-servers=https://192.168.4.110:2379,https://192.168.4.111:2379,https://192.168.4.112:2379 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--bind-address=192.168.4.110 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--secure-port=6443 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--advertise-address=192.168.4.110 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--allow-privileged=true \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--service-cluster-ip-range=10.0.0.0/24 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--authorization-mode=RBAC,Node \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--enable-bootstrap-token-auth=true \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--token-auth-file=/opt/kubernetes/cfg/token.csv \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--service-node-port-range=30000-32767 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--kubelet-client-certificate=/opt/kubernetes/ssl/api-server.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--kubelet-client-key=/opt/kubernetes/ssl/api-server-key.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--tls-cert-file=/opt/kubernetes/ssl/api-server.pem  \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--tls-private-key-file=/opt/kubernetes/ssl/api-server-key.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--client-ca-file=/opt/kubernetes/ssl/ca.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--service-account-key-file=/opt/kubernetes/ssl/ca-key.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--etcd-cafile=/opt/etcd/ssl/ca.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--etcd-certfile=/opt/etcd/ssl/server.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--etcd-keyfile=/opt/etcd/ssl/server-key.pem \\  	# 证书需要修改
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--audit-log-maxbackup=3 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--audit-log-maxsize=100 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--audit-log-path=/opt/kubernetes/logs/k8s-audit.log&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#######################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–logtostderr：启用日志
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">—v：日志等级
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–log-dir：日志目录
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–etcd-servers：etcd集群地址
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–bind-address：监听地址
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–secure-port：https安全端口
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–advertise-address：集群通告地址
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–allow-privileged：启用授权
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–service-cluster-ip-range：Service虚拟IP地址段
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–enable-admission-plugins：准入控制模块
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–authorization-mode：认证授权，启用RBAC授权和节点自管理
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–enable-bootstrap-token-auth：启用TLS bootstrap机制
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–token-auth-file：bootstrap token文件
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–service-node-port-range：Service nodeport类型默认分配端口范围
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–kubelet-client-xxx：apiserver访问kubelet客户端证书
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–tls-xxx-file：apiserver https证书
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–etcd-xxxfile：连接Etcd集群证书
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–audit-log-xxx：审计日志 &#39;</span>&gt;&gt; kube-apiserver.sh</span></span></code></pre></div></blockquote>
<hr>
<h3 id="启用tls-bootstrapping机制">启用<code>TLS Bootstrapping</code>机制</h3>
<ul>
<li>
<ol>
<li><code>TLS Bootstraping：Master apiserver</code>启用<code>TLS</code>认证后，<code>Node</code>节点<code>kubelet</code>和<code>kube-proxy</code>要与<code>kube-apiserver</code>进行通信，必须使用<code>CA</code>签发的有效证书才可以，当<code>Node</code>节点很多时，这种客户端证书颁发需要大量工作，同样也会增加集群扩展复杂度。为了简化流程，<code>Kubernetes</code>引入了<code>TLS bootstraping</code>机制来自动颁发客户端证书，<code>kubelet</code>会以一个低权限用户自动向<code>apiserver</code>申请证书，<code>kubelet</code>的证书由<code>apiserver</code>动态签署。所以强烈建议在<code>Node</code>上使用这种方式，目前主要用于<code>kubelet</code>，<code>kube-proxy</code>还是由我们统一颁发一个证书</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">cat &gt;/opt/kubernetes/cfg/token.csv&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$(head -c 16 /dev/urandom | od -An -t x | tr -d &#39;</span> <span style="color:#e6db74">&#39;),kubelet-bootstrap,10001,&#34;system:node-bootstrapper&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">###########################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 自行生成token
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># token=$(head -c 16 /dev/urandom | od -An -t x | tr -d &#39;</span> <span style="color:#e6db74">&#39;)  	# C语言执行生成方式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># token=`head -c 16 /dev/urandom | od -An -t x | tr -d &#39;</span> <span style="color:#e6db74">&#39;`  	# shell执行生成方式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># sed -i &#34;s/c47ffb939f5ca36231d9e3121a252940/${token}/g&#34;  /opt/kubernetes/cfg/token.csv
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># systemct管理apiserver、并设置开机自启
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">cat &gt;/usr/lib/systemd/system/kube-apiserver.service&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=Kubernetes API Server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Documentation=https://github.com/kubernetes/kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EnvironmentFile=/opt/kubernetes/cfg/kube-apiserver.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/kubernetes/bin/kube-apiserver \$KUBE_APISERVER_OPTS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#######################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ systemctl daemon-reload
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ systemctl enable kube-apiserver &amp;&amp; systemctl start kube-apiserver
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># kube-apiserver报错排查
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cat /var/log/messages|grep kube-apiserver|grep -i error  	# -i不区分大小写
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">journalctl -xe -u kube-apiserver | more  	# 命令排错 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 3.设置授权kubelet-bootstrap用户允许请求证书
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --user=kubelet-bootstrap &#39;</span> &gt;&gt;token-apiserver.sh</span></span></code></pre></div></blockquote>
<hr>
<h3 id="部署kube-controller-manager控制器">部署<code>kube-controller-manager</code>(控制器)</h3>
<ul>
<li>
<ol>
<li><code>Pod</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>1.1 <!-- raw HTML omitted -->最小部署单元<!-- raw HTML omitted --></li>
<li>1.2 <!-- raw HTML omitted -->一组容器的集合<!-- raw HTML omitted --></li>
<li>1.3 <!-- raw HTML omitted -->一个<code>Pod</code>中的容器共享网络命名空间<!-- raw HTML omitted --></li>
<li>1.4 <!-- raw HTML omitted --><code>Pod</code>是短暂的<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li>
<ol start="2">
<li><code>Controllers</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>2.1 <!-- raw HTML omitted --><code>Deployment：</code>无状态应用部署<!-- raw HTML omitted --></li>
<li>2.2 <!-- raw HTML omitted --><code>StatefulSet：</code>有状态应用部署<!-- raw HTML omitted --></li>
<li>2.3 <!-- raw HTML omitted --><code>DaemonSet：</code>确保所有的<code>Node</code>运行一个<code>Pod</code><!-- raw HTML omitted --></li>
<li>2.4 <!-- raw HTML omitted --><code>Job：</code>一次性任务<!-- raw HTML omitted --></li>
<li>2.5 <!-- raw HTML omitted --><code>Cronjob：</code>定时任务<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->更高级层级对象，部署和管理<code>Pod</code><!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="4">
<li><code>Service</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>4.1 <!-- raw HTML omitted -->防止<code>Pod</code>失联<!-- raw HTML omitted --></li>
<li>4.2 <!-- raw HTML omitted -->定义一组<code>Pod</code>的访问策略<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted --><code>Label：</code>标签，附加到某个资源上，用于关联对象，查询和筛选<!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="6">
<li><!-- raw HTML omitted --><code>Namespaces：</code>命名空间，将对象逻辑上隔离<!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="7">
<li><!-- raw HTML omitted --><code>Controller：</code>维持副本期望数目,<code>ReplicaSet</code>替代<code>ReplicationControlled</code><!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="8">
<li><!-- raw HTML omitted --><code>deployent：</code>管理<code>RS</code>，实现滚动更新<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>8.1 <!-- raw HTML omitted --><code>--kubeconfig：</code>连接<code>apiserver</code>配置文件<!-- raw HTML omitted --></li>
<li>8.2 <!-- raw HTML omitted --><code>--master：</code>通过本地非安全本地端口<code>8080</code>连接<code>apiserver</code><!-- raw HTML omitted --></li>
<li>8.3 <!-- raw HTML omitted --><code>--leader-elect：</code>当该组件启动多个时，自动选举<code>HA</code><!-- raw HTML omitted --></li>
<li>8.4 <!-- raw HTML omitted --><code>--cluster-signing-cert-file/--cluster-signing-key-file：</code>自动为<code>kubelet</code>颁发证书的<code>CA</code>，与<code>apiserver</code>保持一致<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 创建配置文件</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/kube-controller-manager.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">KUBE_CONTROLLER_MANAGER_OPTS=&#34;--logtostderr=false \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--v=2 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--log-dir=/opt/kubernetes/logs \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--leader-elect=true \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--kubeconfig=/opt/kubernetes/cfg/kube-controller-manager.kubeconfig \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--master=127.0.0.1:8080 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--bind-address=127.0.0.1 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--allocate-node-cidrs=true \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cluster-cidr=10.244.0.0/16 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--service-cluster-ip-range=10.0.0.0/24 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cluster-signing-cert-file=/opt/kubernetes/ssl/ca.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cluster-signing-key-file=/opt/kubernetes/ssl/ca-key.pem  \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--root-ca-file=/opt/kubernetes/ssl/ca.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--service-account-private-key-file=/opt/kubernetes/ssl/ca-key.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--experimental-cluster-signing-duration=87600h0m0s&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建kube-controller-manager-csr.json 证书请求文件，可以越过</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cat &gt;/opt/kubernetes/ssl/kube-controller-manager-csr.json&lt;&lt;-EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># {</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &#34;CN&#34;: &#34;system:kube-controller-manager&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &#34;hosts&#34;: [],</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &#34;key&#34;: {</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    &#34;algo&#34;: &#34;rsa&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    &#34;size&#34;: 2048</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  },</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &#34;names&#34;: [</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    {</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;C&#34;: &#34;CN&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;L&#34;: &#34;BeiJing&#34;, </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;ST&#34;: &#34;BeiJing&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;O&#34;: &#34;system:masters&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;OU&#34;: &#34;System&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    }</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  ]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># }</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成证书</span>
</span></span><span style="display:flex;"><span>$ cd /opt/kubernetes/ssl
</span></span><span style="display:flex;"><span>$ cfssl gencert -ca<span style="color:#f92672">=</span>ca.pem -ca-key<span style="color:#f92672">=</span>ca-key.pem -config<span style="color:#f92672">=</span>ca-config.json -profile<span style="color:#f92672">=</span>kubernetes kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="9">
<li><!-- raw HTML omitted -->生成<code>kubeconfig</code>文件（以下是<code>shell</code>命令，直接在终端执行）：可以越过<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># KUBE_CONFIG=&#34;/opt/kubernetes/cfg/kube-controller-manager.kubeconfig&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># KUBE_APISERVER=&#34;https://192.168.4.110:6443&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>$ kubectl config set-cluster kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#75715e">#  --certificate-authority=/opt/kubernetes/ssl/ca.pem \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --embed-certs=true \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --server=${KUBE_APISERVER} \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --kubeconfig=${KUBE_CONFIG}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config set-credentials kube-controller-manager <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#75715e">#  --client-certificate=./kube-controller-manager.pem \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --client-key=./kube-controller-manager-key.pem \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --embed-certs=true \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --kubeconfig=${KUBE_CONFIG}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config set-context default <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#75715e">#  --cluster=kubernetes \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --user=kube-controller-manager \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --kubeconfig=${KUBE_CONFIG}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config use-context default --kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="systemd管理controller-manager"><code>systemd</code>管理<code>controller-manager</code></h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted --><code>Controller manager</code>（默认端口：<code>10252</code>）监视<code>Kubernetes</code>集群，以检测和维护<code>Kubernetes</code>环境的几个方面，包括将<code>Pod</code>加入到服务中，保持一组<code>Pod</code>的正确数量，并对节点的丢失做出反应<!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="2">
<li><!-- raw HTML omitted --><code>Cloud controller manager</code>（默认端口：10258）一个用于基于云的部署的可选组件。云控制器与云服务提供商接口，以管理集群的负载均衡器和虚拟网络<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/usr/lib/systemd/system/kube-controller-manager.service<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=Kubernetes Controller Manager
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Documentation=https://github.com/kubernetes/kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EnvironmentFile=/opt/kubernetes/cfg/kube-controller-manager.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/kubernetes/bin/kube-controller-manager \$KUBE_CONTROLLER_MANAGER_OPTS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecReload=/bin/kill -HUP $MAINPID
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="启动并设置开机启动">启动并设置开机启动</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl daemon-reload
</span></span><span style="display:flex;"><span>$ systemctl enable kube-controller-manager <span style="color:#f92672">&amp;&amp;</span> systemctl start kube-controller-manager</span></span></code></pre></div></blockquote>
<hr>
<h3 id="部署kube-scheduler创建配置文件调度器负责集群资源调度组件抽离">部署<code>kube-scheduler</code>:创建配置文件(调度器负责集群资源调度,组件抽离)</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted --><code>Scheduler：</code>负责介绍任务，选择合适的节点进行分配任务<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>1.1 <!-- raw HTML omitted --><code>--kubeconfig</code>：连接<code>apiserver</code>配置文件<!-- raw HTML omitted --></li>
<li>1.2 <!-- raw HTML omitted --><code>--master</code>：通过本地非安全本地端口8080连接<code>apiserver</code><!-- raw HTML omitted --></li>
<li>1.3 <!-- raw HTML omitted --><code>--leader-elect</code>：当该组件启动多个时，自动选举(HA) <!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/kube-scheduler.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">KUBE_SCHEDULER_OPTS=&#34;--logtostderr=false \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--v=2 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--log-dir=/opt/kubernetes/logs \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--leader-elect \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#--kubeconfig=/opt/kubernetes/cfg/kube-scheduler.kubeconfig \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--master=127.0.0.1:8080 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--bind-address=127.0.0.1&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->创建<code>kube-scheduler-csr.json</code>证书请求文件：可以越过此步骤<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># cat &gt;/opt/kubernetes/ssl/kube-scheduler-csr.json&lt;&lt;-EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># {</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &#34;CN&#34;: &#34;system:kube-scheduler&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &#34;hosts&#34;: [],</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &#34;key&#34;: {</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    &#34;algo&#34;: &#34;rsa&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    &#34;size&#34;: 2048</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  },</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &#34;names&#34;: [</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    {</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;C&#34;: &#34;CN&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;L&#34;: &#34;BeiJing&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;ST&#34;: &#34;BeiJing&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;O&#34;: &#34;system:masters&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;OU&#34;: &#34;System&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    }</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  ]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># }</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成证书</span>
</span></span><span style="display:flex;"><span>$ cd /opt/kubernetes/ssl
</span></span><span style="display:flex;"><span>$ cfssl gencert -ca<span style="color:#f92672">=</span>ca.pem -ca-key<span style="color:#f92672">=</span>ca-key.pem -config<span style="color:#f92672">=</span>ca-config.json -profile<span style="color:#f92672">=</span>kubernetes kube-scheduler-csr.json | cfssljson -bare kube-scheduler</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->生成<code>kubeconfig</code>文件(以下是<code>shell</code>命令，直接在终端执行)：此步骤可以越过<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># KUBE_CONFIG=&#34;/opt/kubernetes/cfg/kube-scheduler.kubeconfig&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># KUBE_APISERVER=&#34;https://192.168.100.11:6443&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config set-cluster kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#75715e">#  --certificate-authority=/opt/kubernetes/ssl/ca.pem \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --embed-certs=true \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --server=${KUBE_APISERVER} \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --kubeconfig=${KUBE_CONFIG}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config set-credentials kube-scheduler <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#75715e">#  --client-certificate=./kube-scheduler.pem \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --client-key=./kube-scheduler-key.pem \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --embed-certs=true \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --kubeconfig=${KUBE_CONFIG}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config set-context default <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#75715e">#  --cluster=kubernetes \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --user=kube-scheduler \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --kubeconfig=${KUBE_CONFIG}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config use-context default --kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="systemd管理scheduler"><code>systemd</code>管理<code>scheduler</code></h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/usr/lib/systemd/system/kube-scheduler.service<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=Kubernetes Scheduler
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Documentation=https://github.com/kubernetes/kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EnvironmentFile=/opt/kubernetes/cfg/kube-scheduler.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/kubernetes/bin/kube-scheduler \$KUBE_SCHEDULER_OPTS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->设置开机自己并且启动服务器<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl daemon-reload
</span></span><span style="display:flex;"><span>$ systemctl enable kube-scheduler <span style="color:#f92672">&amp;&amp;</span> systemctl start kube-scheduler</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->生成<code>kubectl</code>连接集群的证书：<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/ssl/admin-csr.json<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;CN&#34;: &#34;admin&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;hosts&#34;: [],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;key&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;size&#34;: 2048
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">},
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;names&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;L&#34;: &#34;BeiJing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;ST&#34;: &#34;BeiJing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;O&#34;: &#34;system:masters&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;OU&#34;: &#34;System&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->生成证书<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /opt/kubernetes/ssl/
</span></span><span style="display:flex;"><span>$ cfssl gencert -ca<span style="color:#f92672">=</span>ca.pem -ca-key<span style="color:#f92672">=</span>ca-key.pem -config<span style="color:#f92672">=</span>ca-config.json -profile<span style="color:#f92672">=</span>kubernetes admin-csr.json | cfssljson -bare admin</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->生成<code>kubeconfig</code>文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir /root/.kube
</span></span><span style="display:flex;"><span>$ KUBE_CONFIG<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/root/.kube/config&#34;</span>
</span></span><span style="display:flex;"><span>$ KUBE_APISERVER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://192.168.4.110:6443&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config set-cluster kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--certificate-authority<span style="color:#f92672">=</span>/opt/kubernetes/ssl/ca.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--server<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_APISERVER<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>$ kubectl config set-credentials cluster-admin <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--client-certificate<span style="color:#f92672">=</span>./admin.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--client-key<span style="color:#f92672">=</span>./admin-key.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>$ kubectl config set-context default <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cluster<span style="color:#f92672">=</span>kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--user<span style="color:#f92672">=</span>cluster-admin <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>$ kubectl config use-context default --kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->通过<code>kubectl</code>工具查看当前集群组件状态<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl get cs
</span></span><span style="display:flex;"><span>NAME                 STATUS    MESSAGE             ERROR
</span></span><span style="display:flex;"><span>controller-manager   Healthy   ok                  
</span></span><span style="display:flex;"><span>scheduler            Healthy   ok                  
</span></span><span style="display:flex;"><span>etcd-0               Healthy   <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;health&#34;</span>:<span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">}</span>   
</span></span><span style="display:flex;"><span>etcd-1               Healthy   <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;health&#34;</span>:<span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">}</span>   
</span></span><span style="display:flex;"><span>etcd-2               Healthy   <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;health&#34;</span>:<span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">}</span> </span></span></code></pre></div></blockquote>
<hr>
<h3 id="在master操作部署worker-node">在<code>Master</code>操作部署<code>Worker Node</code></h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted --><code>Kubelet：</code>直接跟容器引擎交互实现容器的生命周期管理<!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="2">
<li><!-- raw HTML omitted --><code>Kube proxy：</code>负责写入规则至<code>iptables</code>、<code>ipvs</code>实现服务映射访问<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>2.1 <!-- raw HTML omitted --><code>--hostname-override</code>：显示名称，集群中唯一<!-- raw HTML omitted --></li>
<li>2.2 <!-- raw HTML omitted --><code>--network-plugin</code>：启用<code>CNI</code><!-- raw HTML omitted --></li>
<li>2.3 <!-- raw HTML omitted --><code>--kubeconfig</code>：空路径，会自动生成，后面用于连接<code>apiserver</code><!-- raw HTML omitted --></li>
<li>2.4 <!-- raw HTML omitted --><code>--bootstrap-kubeconfig</code>：首次启动向<code>apiserver</code>申请证书<!-- raw HTML omitted --></li>
<li>2.5 <!-- raw HTML omitted --><code>--config</code>：配置参数文件<!-- raw HTML omitted --></li>
<li>2.6 <!-- raw HTML omitted --><code>--cert-dir</code>：<code>kubelet</code>证书生成目录<!-- raw HTML omitted --></li>
<li>2.7 <!-- raw HTML omitted --><code>--pod-infra-container-image</code>：管理<code>Pod</code>网络容器的镜像<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /usr/local/src/kubernetes/server/bin/
</span></span><span style="display:flex;"><span>$ cp kubelet kube-proxy /opt/kubernetes/bin   <span style="color:#75715e"># 本地拷贝</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 部署bubelet</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/kubelet.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">KUBELET_OPTS=&#34;--logtostderr=false \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--v=2 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--log-dir=/opt/kubernetes/logs \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--hostname-override=k8s-master \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--network-plugin=cni \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--bootstrap-kubeconfig=/opt/kubernetes/cfg/bootstrap.kubeconfig \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--config=/opt/kubernetes/cfg/kubelet-config.yml \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cert-dir=/opt/kubernetes/ssl \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--pod-infra-container-image=lizhenliang/pause-amd64:3.0&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="配置参数文件">配置参数文件</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/kubelet-config.yml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: KubeletConfiguration
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: kubelet.config.k8s.io/v1beta1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">address: 0.0.0.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">port: 10250
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">readOnlyPort: 10255
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">cgroupDriver: cgroupfs
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">clusterDNS:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - 10.0.0.2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">clusterDomain: cluster.local 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">failSwapOn: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">authentication:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  anonymous:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    enabled: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  webhook:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    cacheTTL: 2m0s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  x509:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    clientCAFile: /opt/kubernetes/ssl/ca.pem 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">authorization:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  mode: Webhook
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  webhook:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    cacheAuthorizedTTL: 5m0s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    cacheUnauthorizedTTL: 30s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">evictionHard:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  imagefs.available: 15%
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  memory.available: 100Mi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  nodefs.available: 10%
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  nodefs.inodesFree: 5%
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">maxOpenFiles: 1000000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">maxPods: 110
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="在master节点执行以下命令生成kubelet初次加入集群引导bootstrapkubeconfig文件">在<code>master</code>节点执行以下命令，生成<code>kubelet</code>初次加入集群引导<code>bootstrap.kubeconfig</code>文件</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ KUBE_CONFIG<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/opt/kubernetes/cfg/bootstrap.kubeconfig&#34;</span>
</span></span><span style="display:flex;"><span>$ KUBE_APISERVER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://192.168.4.110:6443&#34;</span> <span style="color:#75715e"># apiserver IP:PORT</span>
</span></span><span style="display:flex;"><span>$ TOKEN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;bed185231bd89516f68ed5031946b9f9&#34;</span>  	<span style="color:#75715e"># 与token.csv里保持一致</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成 kubelet bootstrap kubeconfig 配置文件</span>
</span></span><span style="display:flex;"><span>$ kubectl config set-cluster kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--certificate-authority<span style="color:#f92672">=</span>/opt/kubernetes/ssl/ca.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--server<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_APISERVER<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>Cluster <span style="color:#e6db74">&#34;kubernetes&#34;</span> set.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config set-credentials <span style="color:#e6db74">&#34;kubelet-bootstrap&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--token<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>TOKEN<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>User <span style="color:#e6db74">&#34;kubelet-bootstrap&#34;</span> set.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config set-context default <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cluster<span style="color:#f92672">=</span>kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--user<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;kubelet-bootstrap&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>Context <span style="color:#e6db74">&#34;default&#34;</span> created.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config use-context default --kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>Switched to context <span style="color:#e6db74">&#34;default&#34;</span>.</span></span></code></pre></div></blockquote>
<hr>
<h3 id="system管理kubelet"><code>system</code>管理<code>kubelet</code></h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt; /usr/lib/systemd/system/kubelet.service <span style="color:#e6db74">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=Kubernetes Kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=docker.service
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EnvironmentFile=/opt/kubernetes/cfg/kubelet.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/kubernetes/bin/kubelet \$KUBELET_OPTS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LimitNOFILE=65536
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">####################################################################</span>
</span></span><span style="display:flex;"><span>$ systemctl daemon-reload
</span></span><span style="display:flex;"><span>$ systemctl enable kubelet systemctl start kubelet</span></span></code></pre></div></blockquote>
<hr>
<h3 id="批准kubelet证书申请并加入集群">批准<code>kubelet</code>证书申请并加入集群</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 查看kubelet证书请求</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get csr</span>
</span></span><span style="display:flex;"><span>NAME                                                   AGE     SIGNERNAME                                    REQUESTOR           CONDITION
</span></span><span style="display:flex;"><span>node-csr-Pbamt5FDLAwv0HlJpcgUP9B5c4ynIRe0Xa17zXq9I6E   4m16s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 批准申请</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl certificate approve node-csr-Pbamt5FDLAwv0HlJpcgUP9B5c4ynIRe0Xa17zXq9I6E</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>certificatesigningrequest.certificates.k8s.io/node-csr-Pbamt5FDLAwv0HlJpcgUP9B5c4ynIRe0Xa17zXq9I6E approved
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看节点,由于网络插件没有部署，节点状态 NotReady</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get node</span>
</span></span><span style="display:flex;"><span>NAME         STATUS     ROLES    AGE   VERSION
</span></span><span style="display:flex;"><span>k8s-master   NotReady   &lt;none&gt;   71s   v1.18.3</span></span></code></pre></div></blockquote>
<hr>
<h3 id="部署kube-proxy">部署<code>kube-proxy</code></h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 1. 创建配置kube-proxy文件</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/kube-proxy.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">KUBE_PROXY_OPTS=&#34;--logtostderr=false \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--v=2 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--log-dir=/opt/kubernetes/logs \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--config=/opt/kubernetes/cfg/kube-proxy-config.yml&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2. 配置参数文件</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/kube-proxy-config.yml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: KubeProxyConfiguration
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: kubeproxy.config.k8s.io/v1alpha1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">bindAddress: 0.0.0.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metricsBindAddress: 0.0.0.0:10249
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">clientConnection:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kubeconfig: /opt/kubernetes/cfg/kube-proxy.kubeconfig
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">hostnameOverride: k8s-master
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">clusterCIDR: 10.0.0.0/24
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3. 生成kube-proxy.kubeconfig文件：生成kube-proxy证书：</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/ssl/kube-proxy-csr.json<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;CN&#34;: &#34;system:kube-proxy&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;hosts&#34;: [],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;key&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;size&#34;: 2048
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">},
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;names&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;L&#34;: &#34;BeiJing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;ST&#34;: &#34;BeiJing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;O&#34;: &#34;k8s&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;OU&#34;: &#34;System&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 4.生成证书</span>
</span></span><span style="display:flex;"><span>$ cd /opt/kubernetes/ssl/
</span></span><span style="display:flex;"><span>$ cfssl gencert -ca<span style="color:#f92672">=</span>ca.pem -ca-key<span style="color:#f92672">=</span>ca-key.pem -config<span style="color:#f92672">=</span>ca-config.json -profile<span style="color:#f92672">=</span>kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 5. 生成kubeconfig文件</span>
</span></span><span style="display:flex;"><span>$ KUBE_CONFIG<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/opt/kubernetes/cfg/kube-proxy.kubeconfig&#34;</span>
</span></span><span style="display:flex;"><span>$ KUBE_APISERVER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://192.168.4.110:6443&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ssl<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl config set-cluster kubernetes \</span>
</span></span><span style="display:flex;"><span>--certificate-authority<span style="color:#f92672">=</span>/opt/kubernetes/ssl/ca.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--server<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_APISERVER<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>Cluster <span style="color:#e6db74">&#34;kubernetes&#34;</span> set.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ssl<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl config set-credentials kube-proxy \</span>
</span></span><span style="display:flex;"><span>--client-certificate<span style="color:#f92672">=</span>./kube-proxy.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--client-key<span style="color:#f92672">=</span>./kube-proxy-key.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>User <span style="color:#e6db74">&#34;kube-proxy&#34;</span> set.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ssl<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl config set-context default \</span>
</span></span><span style="display:flex;"><span>--cluster<span style="color:#f92672">=</span>kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--user<span style="color:#f92672">=</span>kube-proxy <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>Context <span style="color:#e6db74">&#34;default&#34;</span> created.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ssl<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl config use-context default --kubeconfig=${KUBE_CONFIG}</span>
</span></span><span style="display:flex;"><span>Switched to context <span style="color:#e6db74">&#34;default&#34;</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 6.system管理kube-proxy</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/usr/lib/systemd/system/kube-proxy.service<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=Kubernetes Proxy
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EnvironmentFile=/opt/kubernetes/cfg/kube-proxy.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/kubernetes/bin/kube-proxy \$KUBE_PROXY_OPTS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LimitNOFILE=65536
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">########################################################################</span>
</span></span><span style="display:flex;"><span>$ systemctl daemon-reload
</span></span><span style="display:flex;"><span>$ systemctl enable kube-proxy <span style="color:#f92672">&amp;&amp;</span> systemctl start kube-proxy</span></span></code></pre></div></blockquote>
<hr>
<h3 id="部署网络组件">部署网络组件</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted --><code>Calico</code>是一个纯三层的数据中心网络方案，是目前<code>Kubernetes</code>主流的网络方案。部署<code>Calico</code><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /usr/local/src/
</span></span><span style="display:flex;"><span>$ wget https://docs.projectcalico.org/v3.14/manifests/calico.yaml
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master src<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f calico.yaml  # 等Calico Pod都Running，节点也会准备就绪</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master src<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get node</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master src<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pod -n kube-system</span>
</span></span><span style="display:flex;"><span>NAME                                       READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>calico-kube-controllers-65f8bc95db-27zj8   1/1     Running   <span style="color:#ae81ff">0</span>          37m
</span></span><span style="display:flex;"><span>calico-node-skvcj                          1/1     Running   <span style="color:#ae81ff">0</span>          37m</span></span></code></pre></div></blockquote>
<hr>
<h4 id="部署cni网络">部署<code>CNI</code>网络</h4>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->先准备好<code>CNI</code>二进制文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -p /opt/cni/bin
</span></span><span style="display:flex;"><span>$ cd /usr/local/src/
</span></span><span style="display:flex;"><span>$ wget https://github.com/containernetworking/plugins/releases/download/v0.8.6/cni-plugins-linux-amd64-v0.8.6.tgz  	<span style="color:#75715e"># 下载二进制安装包</span>
</span></span><span style="display:flex;"><span>$ tar zxvf cni-plugins-linux-amd64-v0.8.6.tgz -C /opt/cni/bin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 部署CNI网络</span>
</span></span><span style="display:flex;"><span>$ cd /opt/kubernetes/cfg/
</span></span><span style="display:flex;"><span>$ wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</span></span><span style="display:flex;"><span>$ sed -i -r <span style="color:#e6db74">&#34;s#quay.io/coreos/flannel:.*-amd64#lizhenliang/flannel:v0.12.0-amd64#g&#34;</span> kube-flannel.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master cfg<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f kube-flannel.yml</span>
</span></span><span style="display:flex;"><span>podsecuritypolicy.policy/psp.flannel.unprivileged created
</span></span><span style="display:flex;"><span>clusterrole.rbac.authorization.k8s.io/flannel created
</span></span><span style="display:flex;"><span>clusterrolebinding.rbac.authorization.k8s.io/flannel created
</span></span><span style="display:flex;"><span>serviceaccount/flannel created
</span></span><span style="display:flex;"><span>configmap/kube-flannel-cfg created
</span></span><span style="display:flex;"><span>daemonset.apps/kube-flannel-ds created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master cfg<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n kube-system</span>
</span></span><span style="display:flex;"><span>NAME                    READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>kube-flannel-ds-xv7db   1/1     Running   <span style="color:#ae81ff">0</span>          58s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master cfg<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get node</span>
</span></span><span style="display:flex;"><span>NAME         STATUS   ROLES    AGE   VERSION
</span></span><span style="display:flex;"><span>k8s-master   Ready    &lt;none&gt;   23m   v1.18.3</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->授权<code>apiserver</code>访问<code>kubelet</code><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/apiserver-to-kubelet-rbac.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: ClusterRole
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">annotations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rbac.authorization.kubernetes.io/autoupdate: &#34;true&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kubernetes.io/bootstrapping: rbac-defaults
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name: system:kube-apiserver-to-kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rules:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - apiGroups:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    resources:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - nodes/proxy
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - nodes/stats
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - nodes/log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - nodes/spec
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - nodes/metrics
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - pods/log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    verbs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &#34;*&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: ClusterRoleBinding
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: system:kube-apiserver
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: &#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">roleRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  apiGroup: rbac.authorization.k8s.io
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  kind: ClusterRole
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: system:kube-apiserver-to-kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">subjects:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - apiGroup: rbac.authorization.k8s.io
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    kind: User
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##############################################################</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master cfg<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f apiserver-to-kubelet-rbac.yaml</span>
</span></span><span style="display:flex;"><span>clusterrole.rbac.authorization.k8s.io/system:kube-apiserver-to-kubelet created
</span></span><span style="display:flex;"><span>clusterrolebinding.rbac.authorization.k8s.io/system:kube-apiserver created</span></span></code></pre></div></blockquote>
<hr>
<h3 id="新增加worker-node拷贝已部署好的node相关文件到新节点">新增加<code>Worker Node:</code>拷贝已部署好的<code>Node</code>相关文件到新节点</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->在<code>master</code>节点将<code>Worker Node</code>涉及文件拷贝到其他几个新节点<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ~<span style="color:#f92672">]</span><span style="color:#75715e"># ansible node -i /etc/ansible/hosts -m copy -a &#34;src=../../../opt/kubernetes dest=/opt/&#34; -f 5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ~<span style="color:#f92672">]</span><span style="color:#75715e"># ansible node -i /etc/ansible/hosts -m copy -a &#34;src=../../../opt/cni  dest=/opt/&#34; -f 5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ~<span style="color:#f92672">]</span><span style="color:#75715e"># scp -r /usr/lib/systemd/system/{kubelet,kube-proxy}.service k8s-node-1:/usr/lib/systemd/system</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ~<span style="color:#f92672">]</span><span style="color:#75715e"># scp -r /usr/lib/systemd/system/{kubelet,kube-proxy}.service k8s-node-2:/usr/lib/systemd/system</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 这几个文件是证书申请审批后自动生成的，每个Node不同，必须删除其他几个节点删除kubelet证书和kubeconfig文件，重新生成</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-node-1 ~<span style="color:#f92672">]</span><span style="color:#75715e"># rm -rf /opt/kubernetes/cfg/kubelet.kubeconfig</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-node-2 ~<span style="color:#f92672">]</span><span style="color:#75715e"># rm -rf /opt/kubernetes/cfg/kubelet.kubeconfig </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-node-1 ~<span style="color:#f92672">]</span><span style="color:#75715e"># rm -f /opt/kubernetes/ssl/kubelet*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改主机名</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-node-1 ~<span style="color:#f92672">]</span><span style="color:#75715e"># sed -i &#34;s/k8s-master/k8s-node-1/g&#34; /opt/kubernetes/cfg/kubelet.conf</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-node-1 ~<span style="color:#f92672">]</span><span style="color:#75715e"># sed -i &#34;s/k8s-master/k8s-node-1/g&#34;  /opt/kubernetes/cfg/kube-proxy-config.yml </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-node-2 ~<span style="color:#f92672">]</span><span style="color:#75715e"># sed -i &#34;s/k8s-master/k8s-node-2/g&#34; /opt/kubernetes/cfg/kubelet.conf</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-node-2 ~<span style="color:#f92672">]</span><span style="color:#75715e"># sed -i &#34;s/k8s-master/k8s-node-2/g&#34;  /opt/kubernetes/cfg/kube-proxy-config.yml</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在其他几个几点给予可执行文件执行权限，</span>
</span></span><span style="display:flex;"><span>$ chmod +x /opt/cni/bin/*
</span></span><span style="display:flex;"><span>$ chmod +x /opt/etcd/bin/*
</span></span><span style="display:flex;"><span>$ chmod +x /opt/kubernetes/bin/*
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ systemctl daemon-reload
</span></span><span style="display:flex;"><span>$ systemctl enable kubelet <span style="color:#f92672">&amp;&amp;</span> systemctl start kubelet
</span></span><span style="display:flex;"><span>$ systemctl enable kube-proxy <span style="color:#f92672">&amp;&amp;</span> systemctl start kube-proxy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在Master操作批准Node kubelet证书申请</span>
</span></span><span style="display:flex;"><span>$ kubectl get csr
</span></span><span style="display:flex;"><span>NAME                                                   AGE     SIGNERNAME                                    REQUESTOR           CONDITION
</span></span><span style="display:flex;"><span>node-csr-4vSZMnrv8OUR-zfD7dQYcDdi1L84Tv_nkNHlS8Iltfk   2m46s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending
</span></span><span style="display:flex;"><span>node-csr-KRMLTPJj4yvk5Cb6s0n5T4HtFPYJ152PpDjYHLM3Ass   10s     kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending
</span></span><span style="display:flex;"><span>node-csr-Pbamt5FDLAwv0HlJpcgUP9B5c4ynIRe0Xa17zXq9I6E   71m     kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Approved,Issued
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl certificate approve node-csr-KRMLTPJj4yvk5Cb6s0n5T4HtFPYJ152PpDjYHLM3Ass
</span></span><span style="display:flex;"><span>$ kubectl certificate approve node-csr-4vSZMnrv8OUR-zfD7dQYcDdi1L84Tv_nkNHlS8Iltfk
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># STATUS 都是Ready</span>
</span></span><span style="display:flex;"><span>$ kubectl get node
</span></span><span style="display:flex;"><span>NAME         STATUS   ROLES    AGE     VERSION
</span></span><span style="display:flex;"><span>k8s-master   Ready    &lt;none&gt;   70m     v1.18.3
</span></span><span style="display:flex;"><span>k8s-node-1   Ready    &lt;none&gt;   3m21s   v1.18.3
</span></span><span style="display:flex;"><span>k8s-node-2   Ready    &lt;none&gt;   3m2s    v1.18.3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># STATUS 都是Runing</span>
</span></span><span style="display:flex;"><span>$ kubectl get pod -n kube-system
</span></span><span style="display:flex;"><span>NAME                                       READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>calico-kube-controllers-65f8bc95db-27zj8   1/1     Running   <span style="color:#ae81ff">0</span>          65m
</span></span><span style="display:flex;"><span>calico-node-skvcj                          1/1     Running   <span style="color:#ae81ff">0</span>          65m
</span></span><span style="display:flex;"><span>calico-node-wc72m                          1/1     Running   <span style="color:#ae81ff">0</span>          2m22s
</span></span><span style="display:flex;"><span>calico-node-z5kmp                          1/1     Running   <span style="color:#ae81ff">0</span>          2m2s</span></span></code></pre></div></blockquote>
<hr>
<h4 id="创建local的storage-class">创建<code>local</code>的<code>Storage Class</code></h4>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -p /opt/data
</span></span><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/storage-class.yml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: StorageClass
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: storage.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name: local-storage
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">provisioner: kubernetes.io/no-provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">volumeBindingMode: WaitForFirstConsumer
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 执行命令创建</span>
</span></span><span style="display:flex;"><span>$ kubectl create -f storage-class.yml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看一下创建的storage class</span>
</span></span><span style="display:flex;"><span>$ kubectl get sc</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->创建<code>PV</code><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/pv-sdc.yml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: PersistentVolume
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name: local-pv-sdc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">capacity:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">storage: 30Gi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">accessModes:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - ReadWriteOnce
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  persistentVolumeReclaimPolicy: Retain
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  storageClassName: local-storage
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  local:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    path: /opt/data
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  nodeAffinity:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    required:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      nodeSelectorTerms:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - matchExpressions:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - key: kubernetes.io/hostname
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          operator: In
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          values:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          - cka
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 执行创建命令</span>
</span></span><span style="display:flex;"><span>$ kubectl create -f pv-sdc.yml
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master cfg<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pv</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->创建<code>PVC</code><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/pvc1.yml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: PersistentVolumeClaim
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name: pvc1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">accessModes:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - ReadWriteOnce
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  storageClassName: local-storage
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  resources:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    requests:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      storage: 10Gi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>$ kubectl create -f pvc1.yml</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted --><code>PVC</code>将会一直处于<code>Pending</code>状态直到我们创建一个<code>Pod</code>使用它<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master cfg<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pvc</span>
</span></span><span style="display:flex;"><span>NAME      STATUS    VOLUME    CAPACITY   ACCESS MODES   STORAGECLASS    AGE
</span></span><span style="display:flex;"><span>pvc1      Pending                                       local-storage   5s</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_k8s_rancher">Install_K8s_Rancher</h1>

<h2 id="安装rancher图形化管理">安装<code>Rancher</code>图形化管理</h2>
<ul>
<li>
<ol>
<li><code>Rancher</code>是供采用容器的团队使用的完整软件堆栈。它解决了管理多个</li>
</ol>
</li>
<li>
<ol start="2">
<li><code>Kubernetes</code>集群的运营和安全挑战，并为<code>DevOps</code>团队提供用于运行容器化工作负载的集成工具</li>
</ol>
</li>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->必须存在<!-- raw HTML omitted --><code>Docker</code><!-- raw HTML omitted -->环境<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>服务器</th>
<th><code>IP</code></th>
<th>内存</th>
<th>CPU</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>master</code></td>
<td>192.168.35.128</td>
<td>8G</td>
<td>8<code>core</code></td>
</tr>
<tr>
<td><code>node-1</code></td>
<td>192.168.35.129</td>
<td>4G</td>
<td>4<code>core</code></td>
</tr>
<tr>
<td><code>node-2</code></td>
<td>192.168.35.130</td>
<td>4G</td>
<td>4<code>core</code></td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h3 id="安装基础环境">安装基础环境</h3>
<ul>
<li>
<ol>
<li><code>Nano</code><!-- raw HTML omitted -->：超轻量级开源云平台<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>Naco</code>：基于<code>KVM</code>技术，使用<code>Go</code>语言开发，简单易学的虚拟机管理软件，从<code>Web</code>管理门户、主机监控、镜像克隆到故障切换，功能完备，开箱即用，数分钟之内即可将您的服务器集群升级为云主机平台</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum install -y nano</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->在所有节点都安装<!-- raw HTML omitted --><code>Docker</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># ENV configuration  </span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;/swap / s/^\(.*\)$/#\1/g&#39;</span> /etc/fstab  
</span></span><span style="display:flex;"><span>$ swapoff -a 
</span></span><span style="display:flex;"><span>$ modprobe br_netfilter  
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;br_netfilter&#34;</span> &gt; /etc/modules-load.d/br_netfilter.conf  
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;net.bridge.bridge-nf-call-iptables = 1&#34;</span> &gt;&gt; /etc/sysctl.conf  
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;net.ipv4.ip_forward = 1&#34;</span> &gt;&gt; /etc/sysctl.conf  
</span></span><span style="display:flex;"><span>$ sysctl -p  
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s/#AllowTcpForwarding/AllowTcpForwarding/g&#39;</span> /etc/ssh/sshd_config  
</span></span><span style="display:flex;"><span>$ systemctl reload sshd  
</span></span><span style="display:flex;"><span>$ systemctl stop firewalld <span style="color:#f92672">&amp;&amp;</span> systemctl disable firewalld  
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s/SELINUX=enforcing/SELINUX=disabled/g&#39;</span> /etc/selinux/config  
</span></span><span style="display:flex;"><span>$ setenforce <span style="color:#ae81ff">0</span>  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># timedate configration  </span>
</span></span><span style="display:flex;"><span>$ timedatectl set-timezone Asia/Shanghai  
</span></span><span style="display:flex;"><span>$ yum install -y chrony  
</span></span><span style="display:flex;"><span>$ systemctl start chronyd <span style="color:#f92672">&amp;&amp;</span> sudo systemctl enable chronyd 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ yum install -y yum-utils  
</span></span><span style="display:flex;"><span>$ yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo  
</span></span><span style="display:flex;"><span>$ yum install -y docker-ce-19.03.9 docker-ce-cli-19.03.9 --nogpgcheck  
</span></span><span style="display:flex;"><span>$ systemctl enable docker <span style="color:#f92672">&amp;&amp;</span> systemctl start docker  </span></span></code></pre></div></blockquote>
<hr>
<h3 id="安装rancher-v265">安装<code>Rancher v2.6.5</code></h3>
<ul>
<li>
<ol>
<li><a href="https://rancher.com/docs/rancher/v2.6/en/installation/other-installation-methods/single-node-docker/" rel="external" target="_self">使用<code>Docker</code>在单节点上安装<code>Rancher</code></a></li>
</ol>
</li>
<li>
<ol start="2">
<li><code>Rancher v2.6.5</code><!-- raw HTML omitted -->支持的<!-- raw HTML omitted --><code>Kubernetes Versions</code><!-- raw HTML omitted -->版本<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>v1.23.6 Default</code></li>
<li><code>v1.22.9</code></li>
<li><code>v1.21.12</code></li>
<li><code>v1.20.15</code></li>
<li><code>v1.19.16</code></li>
<li><code>v1.18.20</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ docker pull rancher/rancher:v2.6.5
</span></span><span style="display:flex;"><span>$ docker run -d --restart<span style="color:#f92672">=</span>unless-stopped -p 888:80 -p 4443:443 --privileged rancher/rancher:v2.6.5 </span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><a href="https://rancher.com/docs/rancher/v2.6/en/installation/install-rancher-on-k8s/" rel="external" target="_self">在<code>Kubernetes</code>集群上安装/升级<code>Rancher</code></a></li>
</ol>
</li>
</ul>
<hr>
<h3 id="font-colorred在fontkubernetesfont-colorred集群上安装升级fontrancher"><!-- raw HTML omitted -->在<!-- raw HTML omitted --><code>Kubernetes</code><!-- raw HTML omitted -->集群上安装/升级<!-- raw HTML omitted --><code>Rancher</code></h3>
<ul>
<li>
<ol>
<li><a href="https://helm.sh/docs/intro/install/" rel="external" target="_self">安装<code>Helm</code></a></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><a href="https://blog.csdn.net/qq_37481017/article/details/119002325" rel="external" target="_self">基于<code>K8S 1.21.2</code>集群安装<code>Rancher 2.5.9 HA</code></a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 使用二进制安装Helm</span>
</span></span><span style="display:flex;"><span>$ wget https://get.helm.sh/helm-v3.9.0-linux-amd64.tar.gz  
</span></span><span style="display:flex;"><span>$ tar -zxvf helm-v3.9.0-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>$ mv linux-amd64/helm /usr/local/bin/helm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 脚本安装</span>
</span></span><span style="display:flex;"><span>$ curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
</span></span><span style="display:flex;"><span>$ chmod <span style="color:#ae81ff">700</span> get_helm.sh
</span></span><span style="display:flex;"><span>$ ./get_helm.sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 源代码安装</span>
</span></span><span style="display:flex;"><span>$ git clone https://github.com/helm/helm.git
</span></span><span style="display:flex;"><span>$ cd helm
</span></span><span style="display:flex;"><span>$ make</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>cert-manager</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl create namespace cert-manager
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 添加Jetstack Helm存储库</span>
</span></span><span style="display:flex;"><span>$ helm repo add jetstack https://charts.jetstack.io
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 更新本地 Helm 图表存储库缓存</span>
</span></span><span style="display:flex;"><span>$ helm repo update
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装cert-manager自定义所需的自定义资源</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kubectl apply -f https://github.com/jetstack/cert-manager/releases/download/v1.7.1/cert-manager.crds.yaml</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ helm install cert-manager jetstack/cert-manager --namespace cert-manager --create-namespace --version v1.7.1 --set installCRDs<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 验证cert-manager证书管理器是否安装成功</span>
</span></span><span style="display:flex;"><span>$ kubectl get pods --namespace cert-manager</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>Helm</code><!-- raw HTML omitted -->安装稳定版<!-- raw HTML omitted --><code>Rancher</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 为Rancher创建命名空间</span>
</span></span><span style="display:flex;"><span>$ kubectl create namespace cattle-system
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 添加 Helm 添加 Rancher 库</span>
</span></span><span style="display:flex;"><span>$ helm repo add rancher-stable https://releases.rancher.com/server-charts/stable</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>helm</code><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>Rancher</code><!-- raw HTML omitted -->注意选好版本，版本不对会报错<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm install rancher rancher-stable/rancher --namespace cattle-system --set hostname<span style="color:#f92672">=</span>my.rancher.org --set bootstrapPassword<span style="color:#f92672">=</span>admin --set replicas<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> --version 2.6.3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --set ingress.tls.source=letsEncrypt \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --set letsEncrypt.email=&lt;caviardé&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME: rancher
</span></span><span style="display:flex;"><span>LAST DEPLOYED: Wed May <span style="color:#ae81ff">25</span> 18:01:51 <span style="color:#ae81ff">2022</span>
</span></span><span style="display:flex;"><span>NAMESPACE: cattle-system
</span></span><span style="display:flex;"><span>STATUS: deployed
</span></span><span style="display:flex;"><span>REVISION: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>TEST SUITE: None
</span></span><span style="display:flex;"><span>NOTES:
</span></span><span style="display:flex;"><span>Rancher Server has been installed.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NOTE: Rancher may take several minutes to fully initialize. Please standby <span style="color:#66d9ef">while</span> Certificates are being issued, Containers are started and the Ingress rule comes up.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Check out our docs at https://rancher.com/docs/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>If you provided your own bootstrap password during installation, browse to https://my.rancher.org to get started.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>If this is the first time you installed Rancher, get started by running this command and clicking the URL it generates:</span></span></code></pre></div><div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo https://my.rancher.org/dashboard/?setup<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl get secret --namespace cattle-system bootstrap-secret -o go-template<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{{.data.bootstrapPassword|base64decode}}&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># To get just the bootstrap password on its own, run:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl get secret --namespace cattle-system bootstrap-secret -o go-template<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{{.data.bootstrapPassword|base64decode}}{{ &#34;\n&#34; }}&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Happy Containering!</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->等待<!-- raw HTML omitted --><code>Rancher</code><!-- raw HTML omitted -->安装成功<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl -n cattle-system rollout status deploy/rancher
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl get pods -o wide -n cattle-system
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl get pods --show-labels -n cattle-system</span></span></code></pre></div></blockquote>
<hr>
<h2 id="浏览器登录rancher页面设置">浏览器登录<code>Rancher</code>页面设置</h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted --><strong>默认用户名：</strong><!-- raw HTML omitted --><code>admin</code></li>
</ol>
</li>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->密码新设置或者随机生成<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<p><a href="#R-image-77db5d318959200411c5c6972f133510" class="lightbox-link"><img alt="设置Rancher密码" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-19_18-29-03.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-77db5d318959200411c5c6972f133510"><img alt="设置Rancher密码" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-19_18-29-03.png"></a></p>
</blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->设置<!-- raw HTML omitted --><code>Rancher Server</code><!-- raw HTML omitted -->地址<!-- raw HTML omitted --><code>IP</code><!-- raw HTML omitted -->或者域名<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<p><a href="#R-image-9ed8f1f0a95fde1794ca1dd09aba7644" class="lightbox-link"><img alt="设定Rancher地址" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-19_18-31-17.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-9ed8f1f0a95fde1794ca1dd09aba7644"><img alt="设定Rancher地址" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-19_18-31-17.png"></a></p>
</blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->设置<!-- raw HTML omitted --><code>Rancher</code><!-- raw HTML omitted -->中文页面<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<p><a href="#R-image-bc9c8b151a64d5abff85b79040148e9d" class="lightbox-link"><img alt="set-chinses" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/set-Chinses.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-bc9c8b151a64d5abff85b79040148e9d"><img alt="set-chinses" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/set-Chinses.png"></a></p>
</blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->登录后可以看到目前<!-- raw HTML omitted --><code>Rancher</code><!-- raw HTML omitted -->所管理只有<!-- raw HTML omitted --><code>Rancher</code><!-- raw HTML omitted -->本身存在<!-- raw HTML omitted --><code>K3S</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>5.1 <code>Rancher Labs</code>推出<code>Kubernetes</code>开源<code>K3S</code>是一个轻量级，只有<code>40MB</code>大小，易于安装<code>Kubernetes</code>发布版本，转为资源有限和低互动系统设计，适用于边缘应用、物联网、持续整合以及<code>ARM</code>等</li>
</ul>
<p><a href="#R-image-27e5bfd27df74e890812a6f26afd99e4" class="lightbox-link"><img alt="初次登录页面" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-19_18-34-35.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-27e5bfd27df74e890812a6f26afd99e4"><img alt="初次登录页面" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-19_18-34-35.png"></a></p>
</blockquote>
<hr>
<h2 id="使用rancher创建rke-kubernetes集群">使用<code>Rancher</code>创建<code>RKE Kubernetes</code>集群</h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->等待被创建的集群都是基于数个实体服务器或虚拟机组成，其中这些机器硬件最低要求<!-- raw HTML omitted --><code>1Cores</code>、<code>1GB</code><!-- raw HTML omitted -->并且需要提前安装好<!-- raw HTML omitted --><code>Docker</code><!-- raw HTML omitted -->服务，操作系统必须符合<!-- raw HTML omitted --><code>RKE</code><a href="https://docs.rancher.cn/docs/rke/os/_index/" rel="external" target="_self">安装要求</a></li>
</ol>
</li>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->生产环境下不允许把<!-- raw HTML omitted --><code>worker</code><!-- raw HTML omitted -->角色添加具有<!-- raw HTML omitted --><code>etcd</code><!-- raw HTML omitted -->或<!-- raw HTML omitted --><code>control plane</code><!-- raw HTML omitted -->角色节点中<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<hr>
<h3 id="web页面配置kubernetes-cluster集群"><code>Web</code>页面配置<code>Kubernetes Cluster</code>集群</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->在<!-- raw HTML omitted --><code>Rancher</code><!-- raw HTML omitted -->浏览器页面中添加<!-- raw HTML omitted --><code>Kubernetes Cluster</code></li>
</ol>
</li>
</ul>
<blockquote>
<p><a href="#R-image-c50ce82d37f1df86153069fd3a93a8e4" class="lightbox-link"><img alt="Add-K8s-Cluster" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Add-Cluster.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-c50ce82d37f1df86153069fd3a93a8e4"><img alt="Add-K8s-Cluster" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Add-Cluster.png"></a></p>
</blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->选择<!-- raw HTML omitted --><code>Existing nodes(自定义集群)</code></li>
</ol>
</li>
</ul>
<blockquote>
<p><a href="#R-image-00812c0cb32737c054f126e1a5012dc3" class="lightbox-link"><img alt="自定义集群" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Add-Nodes.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-00812c0cb32737c054f126e1a5012dc3"><img alt="自定义集群" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Add-Nodes.png"></a></p>
</blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->定义集群名称、然后下一步<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<p><a href="#R-image-5bf1006a3724d573a44bf84e78002eb4" class="lightbox-link"><img alt="填写集群名称" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-19_20-41-58.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-5bf1006a3724d573a44bf84e78002eb4"><img alt="填写集群名称" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-19_20-41-58.png"></a></p>
</blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->先选择<!-- raw HTML omitted --><code>etcd</code>、<code>Control Plane</code><!-- raw HTML omitted -->角色，把生成的命令复制到节点上执行，然后下一步<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<p><a href="#R-image-d387dc02bcf214c9e6cc833fa8629164" class="lightbox-link"><img alt="部署etcd Control Plane" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-19_21-14-45.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-d387dc02bcf214c9e6cc833fa8629164"><img alt="部署etcd Control Plane" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-19_21-14-45.png"></a></p>
</blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->选择<!-- raw HTML omitted --><code>Worker</code><!-- raw HTML omitted -->工作节点,把生成的命令复制到节点执行<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<p><a href="#R-image-418e2c8c85c559f511866baa249b3f26" class="lightbox-link"><img alt="选择<code>Worker</code>工作节点" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-19_21-15-51.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-418e2c8c85c559f511866baa249b3f26"><img alt="选择<code>Worker</code>工作节点" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-19_21-15-51.png"></a></p>
</blockquote>
<ul>
<li>
<ol start="6">
<li><!-- raw HTML omitted -->命令执行完成后，等待节点加入集群，成功后下方显示添加成功<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<p><a href="#R-image-81810223a19af271340f4ec327d499dc" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-19_21-20-56.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-81810223a19af271340f4ec327d499dc"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-19_21-20-56.png"></a></p>
</blockquote>
<hr>
<h3 id="如果错过复制添加命令选择命名空间点击edit">如果错过复制添加命令选择命名空间点击<code>Edit</code></h3>
<blockquote>
<p><a href="#R-image-760951f40501294aaf55fca8d3d742fa" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-20_15-42-56.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-760951f40501294aaf55fca8d3d742fa"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-20_15-42-56.png"></a></p>
<p><a href="#R-image-aa10bce3632a0b792702c527ddd27001" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-20_15-44-52.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-aa10bce3632a0b792702c527ddd27001"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-20_15-44-52.png"></a></p>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_k8s_kubesphere">Install_K8s_KubeSphere</h1>

<h2 id="在现有kubernetes上安装kubesphere-web管理系统">在现有<code>Kubernetes</code>上安装<code>KubeSphere Web</code>管理系统</h2>
<!-- raw HTML omitted -->
<blockquote>
<ul>
<li>
<ol>
<li><a href="https://kuboard.cn/" rel="external" target="_self"><code>Kuboard</code>一款免费的<code>Kubernetes</code>管理界面</a></li>
</ol>
</li>
<li>
<ol start="2">
<li><a href="https://kubeoperator.io/" rel="external" target="_self"><code>KubeOperator</code>可视化的<code>Web UI</code></a></li>
</ol>
</li>
</ul>
</blockquote>
<ul>
<li>
<ol>
<li>如需在<code>Kubernetes</code>上安装<code>KubeSphere 3.3.0</code>，您的<code>Kubernetes</code>版本必须为：<code>v1.19.x，v1.20.x，v1.21.x，v1.22.x 或 v1.23.x</code>（实验性支持）</li>
</ol>
</li>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->确保您的机器满足最低硬件要求：<!-- raw HTML omitted --><code>CPU &gt; 1核</code>、<code>内存 &gt; 2GB</code></li>
</ol>
</li>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->在安装之前，需要配置<!-- raw HTML omitted --><code>Kubernetes</code><!-- raw HTML omitted -->集群中的<!-- raw HTML omitted --><code>默认</code><!-- raw HTML omitted -->存储类型，以便实现动态供应<!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>NFS</code><!-- raw HTML omitted -->的动态供应的默认存储类<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/k8s/yaml/data-storage.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 创建一个存储类
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: storage.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: StorageClass
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	name: nfs-storage
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	annotations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		storageclass.kubernetes.io/is-default-class: &#34;true&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">provisioner: k8s-sigs.io/nfs-subdir-external-provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">parameters:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	archiveOnDelete: &#34;true&#34;  	# 删除pv的时候，pv的内容是否要备份
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: apps/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Deployment
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	name: nfs-client-provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		app: nfs-client-provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# replace with namespace where provisioner is deployed
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	namespace: default
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	replicas: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	strategy:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		type: Recreate
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	selector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		matchLabels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			app: nfs-client-provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	template:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">				app: nfs-client-provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			serviceAccountName: nfs-client-provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">				- name: nfs-client-provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">				  image: registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images/nfs-subdir-external-provisioner:v4.0.2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">				  # resources:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">					  # limits:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">						  # cpu: 10m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">					  # requests:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">						  # cpu: 10m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">				  volumeMounts:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">					  - name: nfs-client-root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">						mountPath: /persistentvolumes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">				  env:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">					  - name: PROVISIONER_NAME
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">						value: k8s-sigs.io/nfs-subdir-external-provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">					  - name: NFS_SERVER
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">						value: 192.168.94.110  	# 指定自己nfs服务器地址
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">					  - name: NFS_PATH  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">						value: /opt/data/kubesphere  	# nfs服务器共享的目录
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			volumes:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">				- name: nfs-client-root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">				  nfs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">					  server: 192.168.94.110
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">					  path: /opt/data/kubesphere
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: ServiceAccount
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: nfs-client-provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # replace with namespace where provisioner is deployed
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    namespace: default
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: ClusterRole
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: nfs-client-provisioner-runner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rules:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - apiGroups: [&#34;&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      resources: [&#34;nodes&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      verbs: [&#34;get&#34;, &#34;list&#34;, &#34;watch&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - apiGroups: [&#34;&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      resources: [&#34;persistentvolumes&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      verbs: [&#34;get&#34;, &#34;list&#34;, &#34;watch&#34;, &#34;create&#34;, &#34;delete&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - apiGroups: [&#34;&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      resources: [&#34;persistentvolumeclaims&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      verbs: [&#34;get&#34;, &#34;list&#34;, &#34;watch&#34;, &#34;update&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - apiGroups: [&#34;storage.k8s.io&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      resources: [&#34;storageclasses&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      verbs: [&#34;get&#34;, &#34;list&#34;, &#34;watch&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - apiGroups: [&#34;&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      resources: [&#34;events&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      verbs: [&#34;create&#34;, &#34;update&#34;, &#34;patch&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: ClusterRoleBinding
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: run-nfs-client-provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">subjects:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - kind: ServiceAccount
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      name: nfs-client-provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      # replace with namespace where provisioner is deployed
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      namespace: default
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">roleRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    kind: ClusterRole
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: nfs-client-provisioner-runner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    apiGroup: rbac.authorization.k8s.io
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Role
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: leader-locking-nfs-client-provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # replace with namespace where provisioner is deployed
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    namespace: default
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rules:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - apiGroups: [&#34;&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      resources: [&#34;endpoints&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      verbs: [&#34;get&#34;, &#34;list&#34;, &#34;watch&#34;, &#34;create&#34;, &#34;update&#34;, &#34;patch&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: RoleBinding
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: leader-locking-nfs-client-provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # replace with namespace where provisioner is deployed
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    namespace: default
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">subjects:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - kind: ServiceAccount
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      name: nfs-client-provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      # replace with namespace where provisioner is deployed
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      namespace: default
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">roleRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    kind: Role
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: leader-locking-nfs-client-provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    apiGroup: rbac.authorization.k8s.io
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->配置集群指标监控组件<!-- raw HTML omitted --><a href="https://github.com/kubernetes-sigs/metrics-server" rel="external" target="_self"><code>Kubernetes</code>指标服务器</a></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>5.1 <code>- --kubelet-insecure-tls</code>：<code>kubelet</code>的<code>10250</code>端口使用的是<code>https</code>协议，连接需要验证<code>tls</code>证书，<code>--kubelet-insecure-tls</code><!-- raw HTML omitted -->不验证客户端证书，仅用于测试目的<!-- raw HTML omitted --></li>
<li>5.2 <a href="https://github.com/kubernetes/kube-state-metrics" rel="external" target="_self"><code>kube-state-metrics</code></a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/k8s/yaml/metrics_server.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: ServiceAccount
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        k8s-app: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    namespace: kube-system
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: ClusterRole
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        k8s-app: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        rbac.authorization.k8s.io/aggregate-to-admin: &#34;true&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        rbac.authorization.k8s.io/aggregate-to-edit: &#34;true&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        rbac.authorization.k8s.io/aggregate-to-view: &#34;true&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: system:aggregated-metrics-reader
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rules:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - apiGroups:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - metrics.k8s.io
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      resources:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - pods
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - nodes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      verbs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - get
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - list
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - watch
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: ClusterRole
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        k8s-app: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: system:metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rules:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - apiGroups:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      resources:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - pods
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - nodes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - nodes/stats
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - namespaces
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - configmaps
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      verbs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - get
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - list
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - watch
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: RoleBinding
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        k8s-app: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: metrics-server-auth-reader
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    namespace: kube-system
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">roleRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    apiGroup: rbac.authorization.k8s.io
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    kind: Role
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: extension-apiserver-authentication-reader
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">subjects:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - kind: ServiceAccount
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      name: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      namespace: kube-system
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: ClusterRoleBinding
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        k8s-app: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: metrics-server:system:auth-delegator
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">roleRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    apiGroup: rbac.authorization.k8s.io
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    kind: ClusterRole
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: system:auth-delegator
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">subjects:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - kind: ServiceAccount
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      name: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      namespace: kube-system
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: ClusterRoleBinding
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        k8s-app: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: system:metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">roleRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    apiGroup: rbac.authorization.k8s.io
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    kind: ClusterRole
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: system:metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">subjects:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - kind: ServiceAccount
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      name: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      namespace: kube-system
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Service
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        k8s-app: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    namespace: kube-system
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ports:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - name: https
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          port: 443
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          protocol: TCP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          targetPort: https
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    selector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        k8s-app: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: apps/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Deployment
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        k8s-app: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    namespace: kube-system
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    selector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        matchLabels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            k8s-app: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    strategy:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        rollingUpdate:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            maxUnavailable: 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    template:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                k8s-app: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    - --cert-dir=/tmp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    - --kubelet-insecure-tls
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    - --secure-port=4443
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    - --kubelet-preferred-address-types=InternalIP,Hostname,InternalDNS,ExternalDNS,ExternalIP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    - --kubelet-use-node-status-port
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    image: k8s.gcr.io/metrics-server/metrics-server:v0.6.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    # image: registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images/metrics-server:v0.4.3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    imagePullPolicy: IfNotPresent
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    livenessProbe:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        failureThreshold: 3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        httpGet:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            path: /livez
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            port: https
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            scheme: HTTPS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        periodSeconds: 10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    name: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    ports:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        - containerPort: 4443
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                          name: https
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                          protocol: TCP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    readinessProbe:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        failureThreshold: 3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        httpGet:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            path: /readyz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            port: https
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            scheme: HTTPS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        periodSeconds: 10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    securityContext:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        readOnlyRootFilesystem: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        runAsNonRoot: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        runAsUser: 1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    volumeMounts:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        - mountPath: /tmp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                          name: tmp-dir
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            nodeSelector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                kubernetes.io/os: linux
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            priorityClassName: system-cluster-critical
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            serviceAccountName: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            volumes:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - emptyDir: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  name: tmp-dir
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: apiregistration.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: APIService
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        k8s-app: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: v1beta1.metrics.k8s.io
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    group: metrics.k8s.io
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    groupPriorityMinimum: 100
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    insecureSkipTLSVerify: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    service:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        name: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        namespace: kube-system
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    version: v1beta1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    versionPriority: 100
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li>5.1 <!-- raw HTML omitted -->执行命令查看<!-- raw HTML omitted --><code>Node</code>节点结果</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl top nodes
</span></span><span style="display:flex;"><span>NAME            CPU<span style="color:#f92672">(</span>cores<span style="color:#f92672">)</span>   CPU%   MEMORY<span style="color:#f92672">(</span>bytes<span style="color:#f92672">)</span>   MEMORY%   
</span></span><span style="display:flex;"><span>k8s-master-01   148m         7%     3690Mi          46%       
</span></span><span style="display:flex;"><span>k8s-node-01     35m          1%     492Mi           8%        
</span></span><span style="display:flex;"><span>k8s-node-02     32m          1%     358Mi           6%</span></span></code></pre></div><ul>
<li>5.2 <!-- raw HTML omitted -->执行命令查看<!-- raw HTML omitted --><code>Pod</code>状态</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$  kubectl top pods -A
</span></span><span style="display:flex;"><span>NAMESPACE       NAME                                        CPU<span style="color:#f92672">(</span>cores<span style="color:#f92672">)</span>  MEMORY<span style="color:#f92672">(</span>bytes<span style="color:#f92672">)</span>   
</span></span><span style="display:flex;"><span>default         nfs-client-provisioner-6f9769d4c4-h6jw9     3m           12Mi 
</span></span><span style="display:flex;"><span>ingress-nginx   ingress-nginx-controller-5fd8bfcbdc-bzppj   2m           96Mi
</span></span><span style="display:flex;"><span>kube-flannel    kube-flannel-ds-6tl2b                       5m           33Mi
</span></span><span style="display:flex;"><span>kube-flannel    kube-flannel-ds-n4k68                       3m           33Mi 
</span></span><span style="display:flex;"><span>kube-flannel    kube-flannel-ds-zkqhz                       3m           33Mi 
</span></span><span style="display:flex;"><span>kube-system     coredns-64897985d-6r9ds                     2m           17Mi
</span></span><span style="display:flex;"><span>kube-system     coredns-64897985d-fwmz5                     2m           14Mi
</span></span><span style="display:flex;"><span>kube-system     etcd-k8s-master-01                          20m          112Mi
</span></span><span style="display:flex;"><span>kube-system     kube-apiserver-k8s-master-01                63m          237Mi
</span></span><span style="display:flex;"><span>kube-system     kube-controller-manager-k8s-master-01       20m          50Mi 
</span></span><span style="display:flex;"><span>kube-system     kube-proxy-blnt7                            1m           18Mi 
</span></span><span style="display:flex;"><span>kube-system     kube-proxy-k5gkm                            1m           17Mi
</span></span><span style="display:flex;"><span>kube-system     kube-proxy-xpvqr                            1m           17Mi
</span></span><span style="display:flex;"><span>kube-system     kube-scheduler-k8s-master-01                5m           21Mi
</span></span><span style="display:flex;"><span>kube-system     metrics-server-658c4cf555-bpfcf             5m           19Mi</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="6">
<li><!-- raw HTML omitted -->下载、安装<!-- raw HTML omitted --><code>KubeSphere</code>的<code>yaml</code>文件</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget -P /opt/k8s/yaml/kubesphere/ https://github.com/kubesphere/ks-installer/releases/download/v3.3.1/kubesphere-installer.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ wget -P /opt/k8s/yaml/kubesphere/ https://github.com/kubesphere/ks-installer/releases/download/v3.3.1/cluster-configuration.yaml</span></span></code></pre></div><ul>
<li>6.1 修改<code>cluster-configuration</code>文件<code>启用可插拔组件</code></li>
</ul>
<blockquote>
<ul>
<li>6.1.1 <a href="https://kubesphere.com.cn/docs/v3.3/pluggable-components/overview/" rel="external" target="_self">官网<!-- raw HTML omitted -->启用可插拔组件<!-- raw HTML omitted --></a></li>
</ul>
</blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterConfiguration</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ks-installer</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kubesphere-system</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v3.3.0</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">persistence</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">storageClass</span>: <span style="color:#e6db74">&#34;&#34;</span>  	<span style="color:#75715e"># If there is no default StorageClass in your cluster, you need to specify an existing StorageClass here.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">authentication</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">jwtSecret</span>: <span style="color:#e6db74">&#34;&#34;</span>  	<span style="color:#75715e"># Keep the jwtSecret consistent with the Host Cluster. Retrieve the jwtSecret by executing &#34;kubectl -n kubesphere-system get cm kubesphere-config -o yaml | grep -v &#34;apiVersion&#34; | grep jwtSecret&#34; on the Host Cluster.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">local_registry</span>: <span style="color:#e6db74">&#34;&#34;</span>  	<span style="color:#75715e"># Add your private registry address if it is needed.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># dev_tag: &#34;&#34;  	# Add your kubesphere image tag you want to install, by default it&#39;s same as ks-installer release version.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">etcd</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">monitoring</span>: <span style="color:#66d9ef">true</span>  	<span style="color:#75715e"># 启用或禁用 etcd 监控仪表板安装。 在启用之前，您必须为 etcd 创建一个 Secret， 启用修改为：true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">endpointIps</span>: <span style="color:#ae81ff">192.168.94.110</span>  	<span style="color:#75715e"># etcd 集群 EndpointIps。 这里可以是一堆IP。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">2379</span>  	<span style="color:#75715e"># etcd port.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tlsEnable</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">common</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">core</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">console</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">enableMultiLogin</span>: <span style="color:#66d9ef">true</span>  	<span style="color:#75715e"># Enable or disable simultaneous logins. It allows different users to log in with the same account at the same time.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">port</span>: <span style="color:#ae81ff">30880</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">type</span>: <span style="color:#ae81ff">NodePort</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># apiserver:  	# Enlarge the apiserver and controller manager&#39;s resource requests and limits for the large cluster</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#  resources: {}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># controllerManager:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#  resources: {}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">redis</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>  	<span style="color:#75715e"># 启用 Redis 功能，修改为：true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">enableHA</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumeSize</span>: <span style="color:#ae81ff">2Gi  	# Redis PVC size.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">openldap</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>  	<span style="color:#75715e"># 启用轻量级目录协议，修改为：true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumeSize</span>: <span style="color:#ae81ff">2Gi  	# openldap PVC size.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">minio</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumeSize</span>: <span style="color:#ae81ff">20Gi  	# Minio PVC size.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">monitoring</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># type: external  	# Whether to specify the external prometheus stack, and need to modify the endpoint at the next line.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">endpoint</span>: <span style="color:#ae81ff">http://prometheus-operated.kubesphere-monitoring-system.svc:9090</span> <span style="color:#75715e"># Prometheus endpoint to get metrics data.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">GPUMonitoring</span>:  	<span style="color:#75715e"># Enable or disable the GPU-related metrics. If you enable this switch but have no GPU resources, Kubesphere will set it to zero.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">gpu</span>:  	<span style="color:#75715e"># Install GPUKinds. The default GPU kind is nvidia.com/gpu. Other GPU kinds can be added here according to your needs.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">kinds</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">resourceName</span>: <span style="color:#e6db74">&#34;nvidia.com/gpu&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">resourceType</span>: <span style="color:#e6db74">&#34;GPU&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">default</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">es</span>:   <span style="color:#75715e"># Storage backend for logging, events and auditing.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># master:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#   volumeSize: 4Gi  # The volume size of Elasticsearch master nodes.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#   replicas: 1      # The total number of master nodes. Even numbers are not allowed.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#   resources: {}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># data:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#   volumeSize: 20Gi  # The volume size of Elasticsearch data nodes.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#   replicas: 1  	# The total number of data nodes.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#   resources: {}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">logMaxAge</span>: <span style="color:#ae81ff">7</span>  	<span style="color:#75715e"># Log retention time in built-in Elasticsearch. It is 7 days by default.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">elkPrefix</span>: <span style="color:#ae81ff">logstash  	# The string making up index names. The index name will be formatted as ks-&lt;elk_prefix&gt;-log.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">basicAuth</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">username</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">password</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">externalElasticsearchHost</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">externalElasticsearchPort</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">alerting:  	# (CPU: 0.1 Core, Memory</span>: <span style="color:#ae81ff">100</span> <span style="color:#ae81ff">MiB) It enables users to customize alerting policies to send messages to receivers in time with different time intervals and alerting levels to choose from.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>  	<span style="color:#75715e"># 启用或禁用 KubeSphere 警报系统，修改为：true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># thanosruler:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   replicas: 1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   resources: {}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">auditing</span>:  	<span style="color:#75715e"># Provide a security-relevant chronological set of records，recording the sequence of activities happening on the platform, initiated by different tenants.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>  	<span style="color:#75715e"># 启用或禁用 KubeSphere 审计日志系统，修改为：true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># operator:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   resources: {}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># webhook:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   resources: {}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">devops:  	# (CPU: 0.47 Core, Memory</span>: <span style="color:#ae81ff">8.6</span> <span style="color:#ae81ff">G) Provide an out-of-the-box CI/CD system based on Jenkins, and automated workflow tools including Source-to-Image &amp; Binary-to-Image.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>  	<span style="color:#75715e"># 启用或禁用 KubeSphere DevOps 系统，修改为：true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># resources: {}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">jenkinsMemoryLim</span>: <span style="color:#ae81ff">2Gi  	# Jenkins memory limit.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">jenkinsMemoryReq</span>: <span style="color:#ae81ff">1500Mi  	# Jenkins memory request.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">jenkinsVolumeSize</span>: <span style="color:#ae81ff">8Gi  	# Jenkins volume size.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">jenkinsJavaOpts_Xms</span>: <span style="color:#ae81ff">1200m  	# The following three fields are JVM parameters.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">jenkinsJavaOpts_Xmx</span>: <span style="color:#ae81ff">1600m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">jenkinsJavaOpts_MaxRAM</span>: <span style="color:#ae81ff">2g</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">events</span>:  	<span style="color:#75715e"># Provide a graphical web console for Kubernetes Events exporting, filtering and alerting in multi-tenant Kubernetes clusters.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>  	<span style="color:#75715e"># 启用或禁用 KubeSphere 事件系统，修改为：true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># operator:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   resources: {}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># exporter:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   resources: {}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ruler:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   enabled: true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   replicas: 2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   resources: {}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">logging:  	# (CPU: 57 m, Memory</span>: <span style="color:#ae81ff">2.76</span> <span style="color:#ae81ff">G) Flexible logging functions are provided for log query, collection and management in a unified console. Additional log collectors can be added, such as Elasticsearch, Kafka and Fluentd.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>  	<span style="color:#75715e"># 启用或禁用 KubeSphere 日志系统，修改为：true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">logsidecar</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># resources: {}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">metrics_server:  	# (CPU: 56 m, Memory</span>: <span style="color:#ae81ff">44.35</span> <span style="color:#ae81ff">MiB) It enables HPA (Horizontal Pod Autoscaler).</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>  	<span style="color:#75715e"># 启用或禁用监控指标服务器，从hub.docker官方拉取镜像，网络不好会报网络错误，如果已提前安装请忽略，修改为：true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">monitoring</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">storageClass</span>: <span style="color:#e6db74">&#34;&#34;</span>  	<span style="color:#75715e"># If there is an independent StorageClass you need for Prometheus, you can specify it here. The default StorageClass is used by default.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">node_exporter</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">port</span>: <span style="color:#ae81ff">9100</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># resources: {}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># kube_rbac_proxy:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   resources: {}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># kube_state_metrics:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   resources: {}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># prometheus:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   replicas: 1  # Prometheus replicas are responsible for monitoring different segments of data source and providing high availability.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   volumeSize: 20Gi  # Prometheus PVC size.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   resources: {}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   operator:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#     resources: {}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># alertmanager:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   replicas: 1  	# AlertManager Replicas.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   resources: {}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># notification_manager:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   resources: {}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   operator:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#     resources: {}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   proxy:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#     resources: {}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">gpu</span>:  	<span style="color:#75715e"># GPU monitoring-related plug-in installation.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nvidia_dcgm_exporter</span>:  	<span style="color:#75715e"># Ensure that gpu resources on your hosts can be used normally, otherwise this plug-in will not work properly.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>  	<span style="color:#75715e"># Check whether the labels on the GPU hosts contain &#34;nvidia.com/gpu.present=true&#34; to ensure that the DCGM pod is scheduled to these nodes.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># resources: {}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">multicluster</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">clusterRole</span>: <span style="color:#ae81ff">none  # host | member | none </span> <span style="color:#75715e"># You can install a solo cluster, or specify it as the Host or Member Cluster.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">network</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networkpolicy</span>: <span style="color:#75715e"># Network policies allow network isolation within the same cluster, which means firewalls can be set up between certain instances (Pods).</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># Make sure that the CNI network plugin used by the cluster supports NetworkPolicy. There are a number of CNI network plugins that support NetworkPolicy, including Calico, Cilium, Kube-router, Romana and Weave Net.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>  	<span style="color:#75715e"># 启用或禁用网络策略，修改为：true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ippool</span>: <span style="color:#75715e"># Use Pod IP Pools to manage the Pod network address space. Pods to be created can be assigned IP addresses from a Pod IP Pool.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">type</span>: <span style="color:#ae81ff">none</span> <span style="color:#75715e"># 如果 Calico 用作您的 CNI 插件，请为此字段指定“calico”。 “none”表示 Pod IP 池已禁用</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">topology</span>: <span style="color:#75715e"># Use Service Topology to view Service-to-Service communication based on Weave Scope.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">type</span>: <span style="color:#ae81ff">none</span> <span style="color:#75715e"># Specify &#34;weave-scope&#34; for this field to enable Service Topology. &#34;none&#34; means that Service Topology is disabled.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">openpitrix</span>: <span style="color:#75715e"># An App Store that is accessible to all platform tenants. You can use it to manage apps across their entire lifecycle.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">store</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>  	<span style="color:#75715e"># 启用或禁用 KubeSphere 应用商店，修改为：true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">servicemesh</span>:  	<span style="color:#75715e"># (0.3 Core, 300 MiB) Provide fine-grained traffic management, observability and tracing, and visualized traffic topology.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>  	<span style="color:#75715e"># 基础组件（试点）。 启用或禁用 KubeSphere 服务网格（基于 Istio）微服务治理功能，修改为：true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">istio</span>:  <span style="color:#75715e"># Customizing the istio installation configuration, refer to https://istio.io/latest/docs/setup/additional-setup/customize-installation/</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">components</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ingressGateways</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">istio-ingressgateway</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cni</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">edgeruntime</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>  	<span style="color:#75715e"># 将边缘节点添加到集群并在边缘节点上部署工作负载，启动边缘计算服务，修改为：true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubeedge</span>:  	<span style="color:#75715e"># kubeedge configurations</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cloudCore</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cloudHub</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">advertiseAddress</span>: <span style="color:#75715e"># At least a public IP address or an IP address which can be accessed by edge nodes must be provided.</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#e6db74">&#34;&#34;</span>            <span style="color:#75715e"># Note that once KubeEdge is enabled, CloudCore will malfunction if the address is not provided.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">cloudhubNodePort</span>: <span style="color:#e6db74">&#34;30000&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">cloudhubQuicNodePort</span>: <span style="color:#e6db74">&#34;30001&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">cloudhubHttpsNodePort</span>: <span style="color:#e6db74">&#34;30002&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">cloudstreamNodePort</span>: <span style="color:#e6db74">&#34;30003&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">tunnelNodePort</span>: <span style="color:#e6db74">&#34;30004&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># resources: {}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># hostNetWork: false</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">iptables-manager</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">mode</span>: <span style="color:#e6db74">&#34;external&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># resources: {}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># edgeService:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#   resources: {}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">gatekeeper</span>:        <span style="color:#75715e"># Provide admission policy and rule management, A validating (mutating TBA) webhook that enforces CRD-based policies executed by Open Policy Agent.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>   <span style="color:#75715e"># Enable or disable Gatekeeper.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># controller_manager:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   resources: {}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># audit:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   resources: {}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">terminal</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># image: &#39;alpine:3.15&#39; # There must be an nsenter program in the image</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">timeout</span>: <span style="color:#ae81ff">600</span>  	<span style="color:#75715e"># Container timeout, if set to 0, no timeout will be used. The unit is seconds</span></span></span></code></pre></div><ul>
<li>6.2 <!-- raw HTML omitted -->修改好配置后安装<!-- raw HTML omitted --><code>KubeSphere</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl apply -f kubesphere-installer.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl apply -f cluster-configuration.yaml</span></span></code></pre></div><ul>
<li>6.3 <!-- raw HTML omitted -->跟踪安装进度<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl logs -n kubesphere-system <span style="color:#66d9ef">$(</span>kubectl get pod -n kubesphere-system -l <span style="color:#e6db74">&#39;app in (ks-install, ks-installer)&#39;</span> -o jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{.items[0].metadata.name}&#39;</span><span style="color:#66d9ef">)</span> -f</span></span></code></pre></div><ul>
<li>6.4 查看所有<code>Pod</code>是否在<code>KubeSphere</code><!-- raw HTML omitted -->的相关命名空间中正常运行<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl get svc/ks-console -n kubesphere-system</span></span></code></pre></div><ul>
<li>6.5 解决<code>prometheus-k8s</code>的<code>pods</code><!-- raw HTML omitted -->因为证书不能启动<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl -n kubesphere-monitoring-system create secret generic kube-etcd-client-certs  --from-file<span style="color:#f92672">=</span>etcd-client-ca.crt<span style="color:#f92672">=</span>/etc/kubernetes/pki/etcd/ca.crt  --from-file<span style="color:#f92672">=</span>etcd-client.crt<span style="color:#f92672">=</span>/etc/kubernetes/pki/apiserver-etcd-client.crt  --from-file<span style="color:#f92672">=</span>etcd-client.key<span style="color:#f92672">=</span>/etc/kubernetes/pki/apiserver-etcd-client.key</span></span></code></pre></div><ul>
<li>6.6 <!-- raw HTML omitted -->使用浏览器访问<!-- raw HTML omitted --><code>KubeSphere</code>放行：<code>30880</code>端口</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted --><strong>默认用户名：</strong><!-- raw HTML omitted --><code>admin</code></li>
<li><!-- raw HTML omitted --><strong>默认密码：</strong><!-- raw HTML omitted --><code>P@88w0rd</code></li>
</ul>
</blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ http://IP:30880</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_k8s_harbor">Install_K8s_Harbor</h1>

<h2 id="安装harbor私有镜像库">安装<code>Harbor</code>私有镜像库</h2>
<blockquote>
<ul>
<li><!-- raw HTML omitted --><strong>默认用户名：</strong><!-- raw HTML omitted --><code>admin </code></li>
<li><!-- raw HTML omitted --><strong>默认密码：</strong><!-- raw HTML omitted --><code>Harbor12345</code></li>
<li><!-- raw HTML omitted --><strong>必须先安装</strong><!-- raw HTML omitted --><code>docker</code></li>
<li><code>Harbor</code><!-- raw HTML omitted --><strong>依赖</strong><!-- raw HTML omitted --><code>docker-compose</code></li>
</ul>
</blockquote>
<hr>
<h3 id="安装docker-compose">安装<code>docker-compose</code></h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ curl -L https://get.daocloud.io/docker/compose/releases/download/1.21.2/docker-compose-<span style="color:#e6db74">`</span>uname -s<span style="color:#e6db74">`</span>-<span style="color:#e6db74">`</span>uname -m<span style="color:#e6db74">`</span> &gt; /usr/local/bin/docker-compose
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 给予执行权限</span>
</span></span><span style="display:flex;"><span>$ chmod +x /usr/local/bin/docker-compose
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装Compose命令补全工具</span>
</span></span><span style="display:flex;"><span>$ curl -L https://raw.githubusercontent.com/docker/compose/<span style="color:#66d9ef">$(</span>docker-compose version --short<span style="color:#66d9ef">)</span>/contrib/completion/bash/docker-compose -o /etc/bash_completion.d/docker-compose
</span></span><span style="display:flex;"><span>$ systemctl daemon-reload <span style="color:#f92672">&amp;&amp;</span> systemctl restart docker</span></span></code></pre></div></blockquote>
<hr>
<h3 id="安装harbor">安装<code>Harbor</code></h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget https://github.com/goharbor/harbor/releases/download/v2.10.0/harbor-offline-installer-v2.10.0.tgz
</span></span><span style="display:flex;"><span>$ tar -zxvf harbor-offline-installer-v2.10.0.tgz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ vim harbor/harbor.yml
</span></span><span style="display:flex;"><span>hostname: reg.mydomain.com  	<span style="color:#75715e"># 修改主机名： my.harbor.com</span>
</span></span><span style="display:flex;"><span>port: <span style="color:#ae81ff">80</span>  	<span style="color:#75715e"># 修改http默认端口：8080</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># port: 443  	# 注释https协议端口</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ./install.sh</span></span></code></pre></div><ul>
<li><a href="https://goharbor.io/docs/2.0.0/install-config/configure-https/" rel="external" target="_self">配置对<code>Harbor</code>的<code>HTTPS</code>访问</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 生成 CA 证书私钥</span>
</span></span><span style="display:flex;"><span>$ openssl genrsa -out ca.key <span style="color:#ae81ff">4096</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成 CA 证书</span>
</span></span><span style="display:flex;"><span>$ openssl req -x509 -new -nodes -sha512 -days <span style="color:#ae81ff">3650</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> -subj <span style="color:#e6db74">&#34;/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=yourdomain.com&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> -key ca.key <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> -out ca.crt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成私钥</span>
</span></span><span style="display:flex;"><span>$ openssl genrsa -out yourdomain.com.key <span style="color:#ae81ff">4096</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成证书签名请求 (CSR)</span>
</span></span><span style="display:flex;"><span>$ openssl req -sha512 -new <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -subj <span style="color:#e6db74">&#34;/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=yourdomain.com&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -key yourdomain.com.key <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -out yourdomain.com.csr
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成 x509 v3 扩展文件</span>
</span></span><span style="display:flex;"><span>$ cat &gt; v3.ext <span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">authorityKeyIdentifier=keyid,issuer
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">basicConstraints=CA:FALSE
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">extendedKeyUsage = serverAuth
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">subjectAltName = @alt_names
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[alt_names]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DNS.1=yourdomain.com
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DNS.2=yourdomain
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DNS.3=hostname
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用该v3.ext文件为您的 Harbor 主机生成证书</span>
</span></span><span style="display:flex;"><span>$ openssl x509 -req -sha512 -days <span style="color:#ae81ff">3650</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -extfile v3.ext <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -CA ca.crt -CAkey ca.key -CAcreateserial <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -in yourdomain.com.csr <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -out yourdomain.com.crt</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol>
<li><code>docker</code><!-- raw HTML omitted -->登录<!-- raw HTML omitted --><code>Harbor</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ docker login http://192.168.80.225:8080</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->如果报错：<!-- raw HTML omitted --><code>Error response from daemon: Get  http: server gave HTTP response to HTTPS client</code></li>
</ol>
</li>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->修改配置文件(指定私有仓库，可忽略跳过)<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ tee /etc/docker/daemon.json <span style="color:#e6db74">&lt;&lt;-&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   &#34;storage-driver&#34;: &#34;overlay2&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   &#34;registry-mirrors&#34;:[&#34;https://r2hd8p9u.mirror.aliyuncs.com&#34;],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   &#34;insecure-registries&#34;:[&#34;*.*.*.*:5000&#34;,&#34;192.168.4.126&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ vim /etc/docker/daemon.json
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34;insecure-registries&#34;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;harbor服务器IP:端口&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>$ systemctl daemon-reload <span style="color:#f92672">&amp;&amp;</span> systemctl restart docker</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->报错：<!-- raw HTML omitted --><code>request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers) (Client.Timeout exceeded while awaiting headers)</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ vim /etc/hosts  	<span style="color:#75715e"># 修改hosts解析</span>
</span></span><span style="display:flex;"><span>本机服务IP my.harbodomain.com</span></span></code></pre></div></blockquote>
<hr>
<h3 id="推送镜像到harbor仓库">推送镜像到<code>Harbor</code>仓库</h3>
<blockquote>
<ul>
<li><code>SOURCE_IMAGE[:TAG]</code><!-- raw HTML omitted -->：原镜像名字和<!-- raw HTML omitted --><code>tag</code></li>
<li><code>test</code><!-- raw HTML omitted -->：<code>Harbor</code>项目名称<!-- raw HTML omitted --></li>
<li><code>IMAGE[:TAG]</code><!-- raw HTML omitted -->：自定义命名，以及版本标签<!-- raw HTML omitted --></li>
</ul>
<p>示例：</p>
<div class="highlight wrap-code"><pre tabindex="0"><code class="language-she" data-lang="she"># 在项目中标记镜像
$ docker tag SOURCE_IMAGE[:TAG] 192.168.35.128:9527/test/IMAGE[:TAG]

# 推送镜像到当前项目
$ docker push 192.168.35.128:9527/test/IMAGE[:TAG]</code></pre></div></blockquote>
<hr>
<h3 id="font-colorred其他服务器拉取fontharborfont-colorred仓库镜像font"><!-- raw HTML omitted -->其他服务器拉取<!-- raw HTML omitted --><code>Harbor</code><!-- raw HTML omitted -->仓库镜像<!-- raw HTML omitted --></h3>
<ul>
<li>
<ol>
<li><code>/etc/hosts</code><!-- raw HTML omitted -->做好解析<!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="2">
<li><code>daemon.json</code><!-- raw HTML omitted -->文件中添加私人仓库参数<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat /etc/docker/daemon.json
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;insecure-registries&#34;</span>:<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;192.168.80.210:8080&#34;</span><span style="color:#f92672">]</span>,</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->拉取私人仓库镜像，前提仓库是公开类型，然后获取拉取命令<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<p><a href="#R-image-b04d4584bdcc9823890464f9912abc4b" class="lightbox-link"><img alt="拉取私人仓库命令" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Harbor/Snipaste_2022-06-07_21-19-25.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-b04d4584bdcc9823890464f9912abc4b"><img alt="拉取私人仓库命令" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Harbor/Snipaste_2022-06-07_21-19-25.png"></a></p>
</blockquote>
<hr>
<h3 id="配置k8s使用harbor镜像仓库">配置<code>K8S</code>使用<code>Harbor</code>镜像仓库</h3>
<blockquote>
<ul>
<li><code>docker-harbor</code>：<code>secret</code><!-- raw HTML omitted -->名称自定义<!-- raw HTML omitted --></li>
<li><code>--docker-server</code>：<code>Harbor</code><!-- raw HTML omitted -->仓库地址<!-- raw HTML omitted --></li>
<li><code>--docker-username</code>：<code>Harbor</code><!-- raw HTML omitted -->登录用户名<!-- raw HTML omitted --></li>
<li><code>--docker-password</code>：<code>Harbor</code><!-- raw HTML omitted -->仓库登录密码<!-- raw HTML omitted --></li>
<li><code>--docker-email</code><!-- raw HTML omitted -->：邮箱地址<!-- raw HTML omitted --></li>
<li><code>--namespace</code><!-- raw HTML omitted -->：指定命名空间，不指定默认为：<!-- raw HTML omitted --><code>default</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl create secret docker-registry docker-harbor --docker-server<span style="color:#f92672">=</span>192.168.80.210:8080 --docker-username<span style="color:#f92672">=</span>admin --docker-password<span style="color:#f92672">=</span>Harbor12345 --docker-email<span style="color:#f92672">=</span>xxx@xxx.com --namespace<span style="color:#f92672">=</span>harbor</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->将机密数据转换为可读格式<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl get secret docker-harbor --output<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;jsonpath={.data.\.dockerconfigjson}&#34;</span> | base64 --decode
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 输入以下内容</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span><span style="color:#e6db74">&#34;auths&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;192.168.80.210:8080&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;username&#34;</span>:<span style="color:#e6db74">&#34;admin&#34;</span>,<span style="color:#e6db74">&#34;password&#34;</span>:<span style="color:#e6db74">&#34;Harbor12345&#34;</span>,<span style="color:#e6db74">&#34;email&#34;</span>:<span style="color:#e6db74">&#34;xxx@xxx.com&#34;</span>,<span style="color:#e6db74">&#34;auth&#34;</span>:<span style="color:#e6db74">&#34;YWRtaW46SGFyYm9yMTIzNDU=&#34;</span><span style="color:#f92672">}}}</span></span></span></code></pre></div><ul>
<li>将<code>base64</code><!-- raw HTML omitted -->编码的数据转换为可读格式<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;YWRtaW46SGFyYm9yMTIzNDU=&#34;</span> | base64 --decode
</span></span><span style="display:flex;"><span>admin:Harbor12345  	<span style="color:#75715e"># 输出结果</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->生成<!-- raw HTML omitted --><code>yaml</code><!-- raw HTML omitted -->文件，并在<!-- raw HTML omitted --><code>spec.containers</code><!-- raw HTML omitted -->字段中修改私人镜像参数<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>生成<code>Deployment</code>的<code>yaml</code>文件并应用</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl create deployment java-demo --image<span style="color:#f92672">=</span>192.168.80.210:8080/test/tomcat-demo:v1 --dry-run<span style="color:#f92672">=</span>client -o yaml &gt;/tmp/deploy.yaml</span></span></code></pre></div><ul>
<li><code>192.168.80.210:8080</code><!-- raw HTML omitted -->：指定使用私人仓库地址，域名或者IP地址加端口号<!-- raw HTML omitted --></li>
<li><code>test</code><!-- raw HTML omitted -->：私人仓库库房名称<!-- raw HTML omitted --></li>
<li><code>tomcat-demo</code><!-- raw HTML omitted -->：使用私人仓库的镜像<!-- raw HTML omitted --></li>
<li><code>v1</code><!-- raw HTML omitted -->：必须指定要使用私人仓库镜像的版本号<!-- raw HTML omitted --></li>
<li><code>name: tomcat-demo</code><!-- raw HTML omitted -->：指定使用的镜像名字<!-- raw HTML omitted --></li>
<li><code>imagePullSecrets:</code><!-- raw HTML omitted -->：指定使用其他镜像地址<!-- raw HTML omitted --></li>
<li><code>- name: docker-harbor</code><!-- raw HTML omitted -->：指定定义的私人仓库名字<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">java-demo</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">name</span>: <span style="color:#ae81ff">java-demo</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">app</span>: <span style="color:#ae81ff">java-demo</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">app</span>: <span style="color:#ae81ff">java-demo</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>                - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">192.168.80.210</span>:<span style="color:#ae81ff">8080</span><span style="color:#ae81ff">/test/tomcat-demo:v1 </span> <span style="color:#75715e"># 需修改处</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">tomcat-demo  	# 默认生成</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">imagePullSecrets</span>:  	<span style="color:#75715e"># 手动添加字段</span>
</span></span><span style="display:flex;"><span>                - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">docker-harbor  	# 指定使用的secret库房名称</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->创建<!-- raw HTML omitted --><code>Service</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>yaml</code><!-- raw HTML omitted -->文件，应用并访问<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl expose deployment java-demo --port<span style="color:#f92672">=</span><span style="color:#ae81ff">80</span> --target-port<span style="color:#f92672">=</span><span style="color:#ae81ff">8080</span> --type<span style="color:#f92672">=</span>NodePort --dry-run<span style="color:#f92672">=</span>client -o yaml &gt;/opt/yaml/java-demo-svc.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;&gt;/opt/yaml/java-demo-svc.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Service
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  app: java-demo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name: java-demo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ports:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - port: 8080  	# Service 集群端口
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          protocol: TCP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          targetPort: 8080  	# Pod 本身服务端口，比如Nginx：80，Tomcat：8080
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          nodePort: 30001  	# 外网访问端口
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        selector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            app: java-demo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        type: NodePort
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl create -f java-demo-svc.yaml
</span></span><span style="display:flex;"><span>$ kubectl get service
</span></span><span style="display:flex;"><span>$ http://192.168.80.210:30001/  	<span style="color:#75715e"># 浏览器访问地址</span></span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_k8s_dashboard">Install_K8s_Dashboard</h1>

<h2 id="部署dashboard端口映射可以用于web访问">部署<code>Dashboard</code>(端口映射，可以用于<code>web</code>访问)</h2>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/kubernetes/dashboard" rel="external" target="_self"><code>Kubernetes Dashboard</code></a></td>
<td>官方可视化界面</td>
</tr>
<tr>
<td><a href="https://kubesphere.io/zh/" rel="external" target="_self"><code>KubeSphere</code></a></td>
<td>青云</td>
</tr>
<tr>
<td><a href="https://www.rancher.com/" rel="external" target="_self"><code>Rancher</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://kuboard.cn/" rel="external" target="_self"><code>Kuboard</code></a></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li><code>kubernetes</code>官方开发了一个基于<code>web</code>的用户界面<code>DashBoard</code>。用户可以使用<code>DashBoard</code>部署容器化的应用，而且还可以监控应用的状态，执行故障排查以及管理<code>kubernetes</code>中的各种资源。</li>
</ul>
</blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->下载用于部署<!-- raw HTML omitted --><code>DashBoard</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>yaml</code><!-- raw HTML omitted -->文件修改并运行<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>下载部署文件</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /opt/kubernetes/cfg/
</span></span><span style="display:flex;"><span>$ wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>recommended.yaml</code><!-- raw HTML omitted -->文件的<!-- raw HTML omitted --><code>Service</code><!-- raw HTML omitted -->类型<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">kubernetes-dashboard</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubernetes-dashboard</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kubernetes-dashboard</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span> - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">443</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">8443</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">nodePort</span>: <span style="color:#ae81ff">30001</span>       <span style="color:#75715e"># 此处新增</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">type</span>: <span style="color:#ae81ff">NodePort      		# 此处新增</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">kubernetes-dashboard</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->部署<!-- raw HTML omitted --><code>DashBoard</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl create -f recommended.yaml</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->查看<!-- raw HTML omitted --><code>namespace</code><!-- raw HTML omitted -->下名为<!-- raw HTML omitted --><code>kubernetes-dashboard</code><!-- raw HTML omitted -->下的资源<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl get pods,svc -n kubernetes-dashboard
</span></span><span style="display:flex;"><span>NAME                                             READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pod/dashboard-metrics-scraper-694557449d-mvnc8   1/1     Running   <span style="color:#ae81ff">0</span>          21s
</span></span><span style="display:flex;"><span>pod/kubernetes-dashboard-9774cc786-fm748         1/1     Running   <span style="color:#ae81ff">0</span>          21s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                                TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>         AGE
</span></span><span style="display:flex;"><span>service/dashboard-metrics-scraper   ClusterIP   10.0.0.248   &lt;none&gt;        8000/TCP        21s
</span></span><span style="display:flex;"><span>service/kubernetes-dashboard        NodePort    10.0.0.15    &lt;none&gt;        443:30001/TCP   22s</span></span></code></pre></div><ul>
<li><code>dashboard-admin.yaml</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">name</span>: <span style="color:#ae81ff">dashboard-admin</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kubernetes-dashboard</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubernetes-dashboard</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRoleBinding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">name</span>: <span style="color:#ae81ff">dashboard-admin</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">name</span>: <span style="color:#ae81ff">cluster-admin</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">name</span>: <span style="color:#ae81ff">dashboard-admin</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kubernetes-dashboard</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->创建<!-- raw HTML omitted --><code>service account</code><!-- raw HTML omitted -->并绑定默认<!-- raw HTML omitted --><code>cluster-admin</code><!-- raw HTML omitted -->管理员集群角色：<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl create serviceaccount dashboard-admin -n kubernetes-dashboard</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->授权：<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl create clusterrolebinding dashboard-admin <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--clusterrole<span style="color:#f92672">=</span>cluster-admin <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--serviceaccount<span style="color:#f92672">=</span>kubernetes-dashboard:dashboard-admin</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->获取账号<!-- raw HTML omitted --><code>token</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 第一种方式</span>
</span></span><span style="display:flex;"><span>$ kubectl describe secrets -n kubernetes-dashboard <span style="color:#66d9ef">$(</span>kubectl -n kubernetes-dashboard get secret | awk <span style="color:#e6db74">&#39;/dashboard-admin/{print $1}&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 第二种方式</span>
</span></span><span style="display:flex;"><span>$ kubectl get secrets -n kubernetes-dashboard | grep dashboard-admin
</span></span><span style="display:flex;"><span>$ kubectl describe secrets dashboard-admin-token-b992l -n kubernetes-dashboard</span></span></code></pre></div></blockquote>
<hr>
<h2 id="通过浏览器访问dashboard的ui">通过浏览器访问<code>DashBoard</code>的<code>UI</code></h2>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->打开浏览器访问：<!-- raw HTML omitted --><code>https://NodeIP:30001</code></li>
<li><!-- raw HTML omitted -->打开谷歌浏览器提示：<!-- raw HTML omitted --><code>NET::ERR_CERT_INVALID</code></li>
<li><!-- raw HTML omitted -->在<!-- raw HTML omitted --><code>chrome</code><!-- raw HTML omitted -->该页面上，直接键盘敲入这12个字符：<!-- raw HTML omitted --><code>thisisunsafe</code></li>
<li><!-- raw HTML omitted --><strong>注意：</strong><!-- raw HTML omitted -->鼠标点击当前页面任意位置，让页面处于最上层即可输入</li>
<li><!-- raw HTML omitted -->复制创建<!-- raw HTML omitted --><code>cluster-admin</code><!-- raw HTML omitted -->生成的<!-- raw HTML omitted --><code>token</code><!-- raw HTML omitted -->到浏览器登录<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_k8s_coredns">Install_K8s_CoreDNS</h1>

<h2 id="安装coredns">安装<code>CoreDNS</code></h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->去官网下载<!-- raw HTML omitted --><a href="https://github.com/coredns/deployment/tree/master/kubernetes" rel="external" target="_self"><code>CoreDNS</code></a><code>deploy.sh</code><!-- raw HTML omitted -->和<!-- raw HTML omitted --><code>coredns.yam.sed</code><!-- raw HTML omitted -->两个文件<!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="2">
<li><a href="https://kaerser.github.io/2019/03/11/coredns%E9%85%8D%E7%BD%AE/" rel="external" target="_self"><code>CoreDNS</code>配置</a></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget https://github.com/coredns/deployment/blob/08c2b11241ef67b5d22d2020c00001ce0baec566/kubernetes/deploy.sh
</span></span><span style="display:flex;"><span>$ wget https://github.com/coredns/deployment/blob/08c2b11241ef67b5d22d2020c00001ce0baec566/kubernetes/coredns.yaml.sed
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看帮助</span>
</span></span><span style="display:flex;"><span>$ ./deploy.sh -h</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><code>REVERSE_CIDRS=&quot;10.254.0.0/16&quot;</code><!-- raw HTML omitted -->：配置<!-- raw HTML omitted --><code>kubernetes svc</code><!-- raw HTML omitted -->网段<!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="4">
<li><code>CLUSTER_DNS_IP=&quot;10.254.0.2&quot;</code><!-- raw HTML omitted -->：配置<!-- raw HTML omitted --><code>kubernetes DNS IP</code></li>
</ol>
</li>
<li>
<ol start="5">
<li><code>CLUSTER_DOMAIN=&quot;cluster.local&quot;</code><!-- raw HTML omitted -->：配置<!-- raw HTML omitted --><code>kubernetes</code><!-- raw HTML omitted -->的域名<!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="6">
<li><!-- raw HTML omitted -->-r<!-- raw HTML omitted -->：<code>kubernetes svc</code>网段、<!-- raw HTML omitted -->-i<!-- raw HTML omitted -->：<code>kubernetes DNS IP</code>、<!-- raw HTML omitted -->-d<!-- raw HTML omitted -->：<code>kubernetes</code>的域名</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$  ./deploy.sh -s -r 10.254.0.0/16 -i 10.254.0.10 -d cluster.local &gt; coredns.yaml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改前后对比</span>
</span></span><span style="display:flex;"><span>$ diff coredns.yaml coredns.yaml.sed
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动Coredns</span>
</span></span><span style="display:flex;"><span>$ kubectl apply -f coredns.yaml</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_k8s_argo_cd">Install_K8s_Argo_CD</h1>

<h2 id="argo-cd介绍"><code>Argo CD</code>介绍</h2>
<blockquote>
<ul>
<li><code>Argo CD</code>是一个为<code>Kubernetes</code>而生的，遵循声明式<code>GitOps</code>理念的持续部署<code>CD</code>工具。<code>Argo CD</code>可在<code>Git</code>存储库更改时自动同步和部署应用程序</li>
<li>应用定义、配置和环境信息是声明式的，并可以进行版本控制</li>
<li>应用部署和生命周期管理是全自动化的、是可审计的，清晰易懂</li>
</ul>
</blockquote>
<hr>
<h2 id="安装argo-cd">安装<code>Argo CD</code></h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->创建<!-- raw HTML omitted --><code>ArgoCD</code><!-- raw HTML omitted -->命名空间<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl create namespace argocd</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->下载并启动<!-- raw HTML omitted --><code>ArgoCD</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml  </span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>NodePort</code><!-- raw HTML omitted -->方式暴露<!-- raw HTML omitted --><code>argocd ui</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl patch service -n argocd argocd-server -p <span style="color:#e6db74">&#39;{&#34;spec&#34;: {&#34;type&#34;: &#34;NodePort&#34;}}&#39;</span>  </span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->获取<!-- raw HTML omitted --><code>ArgoCD</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>admin</code><!-- raw HTML omitted -->登陆密码<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{.data.password}&#34;</span> | base64 -d</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>cli：CLI</code><!-- raw HTML omitted -->是用于管理<!-- raw HTML omitted --><code>Argo CD</code><!-- raw HTML omitted -->的命令行工具<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ curl -sSL -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/download/v2.3.3/argocd-linux-amd64 <span style="color:#f92672">&amp;&amp;</span> chmod +x /usr/local/bin/argocd</span></span></code></pre></div></blockquote>
<ol start="6">
<li><!-- raw HTML omitted -->查看<!-- raw HTML omitted --><code>argocd-server</code><!-- raw HTML omitted -->暴露端口<!-- raw HTML omitted --></li>
</ol>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl get svc -n argocd</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="configure_k8s_storage">Configure_K8s_Storage</h1>

<h1 id="kubernetes数据存储"><code>Kubernetes</code>数据存储</h1>
<ul>
<li>
<ol>
<li>都知道容器的生命周期可能很短，会被频繁的创建和销毁。那么容器在销毁的时候，保存在容器中的数据也会被清除。这种结果对用户来说，在某些情况下是不乐意看到的。为了持久化保存容器中的数据，<code>kubernetes</code>引入了<code>Volume</code>的概念</li>
</ol>
</li>
<li>
<ol start="2">
<li><code>Volume</code>是<code>Pod</code>中能够被多个容器访问的共享目录，它被定义在<code>Pod</code>上，然后被一个<code>Pod</code>里面的多个容器挂载到具体的文件目录下，<code>kubernetes</code>通过<code>Volume</code>实现同一个<code>Pod</code>中不同容器之间的数据共享以及数据的持久化存储。<code>Volume</code>的生命周期不和<code>Pod</code>中的单个容器的生命周期有关，当容器终止或者重启的时候，<code>Volume</code>中的数据也不会丢失</li>
</ol>
</li>
<li>
<ol start="3">
<li><code>kubernetes</code>的<code>Volume</code>支持多种类型，比较常见的有下面的几个：</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->简单存储<!-- raw HTML omitted -->：<code>EmptyDir</code>、<code>HostPath</code>、<code>NFS</code></li>
<li><!-- raw HTML omitted -->高级存储<!-- raw HTML omitted -->：<code>PV</code>、<code>PVC</code></li>
<li><!-- raw HTML omitted -->配置存储<!-- raw HTML omitted -->：<code>ConfigMap</code>、<code>Secret</code></li>
</ul>
</blockquote>
<hr>
<h2 id="简单存储">简单存储</h2>
<h3 id="emptydir"><code>EmptyDir</code></h3>
<ul>
<li>
<ol>
<li><code>EmptyDir</code>是最基础的<code>Volume</code>类型，一个<code>EmptyDir</code>就是<code>Host</code>上的一个空目录</li>
</ol>
</li>
<li>
<ol start="2">
<li><code>EmptyDir</code>是在<code>Pod</code>被分配到<code>Node</code>时创建的，它的初始内容为空，并且无须指定宿主机上对应的目录文件，因为<code>kubernetes</code>会自动分配一个目录，当<code>Pod</code>销毁时，<code>EmptyDir</code>中的数据也会被永久删除。</li>
</ol>
</li>
<li>
<ol start="3">
<li><code>EmptyDir</code>的用途如下</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->临时空间<!-- raw HTML omitted -->例如用于某些应用程序运行时所需的临时目录，且无须永久保留</li>
<li><!-- raw HTML omitted -->多容器共享目录<!-- raw HTML omitted -->一个容器需要从另一个容器中获取数据的目录</li>
</ul>
</blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->接下来，通过一个容器之间的共享案例来使用描述一个<!-- raw HTML omitted --><code>EmptyDir</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->在一个<code>Pod</code>中准备两个容器<!-- raw HTML omitted --><code>nginx</code>和<code>busybox</code>然后声明一个<code>volume</code>分别挂载到两个容器的目录中，然后<code>nginx</code>容器负责向<code>volume</code>中写日志，<code>busybox</code>中通过命令将日志内容读到控制台</li>
<li><a href="https://raw.githubusercontent.com/usermice/imgs/master/Kubernetes_Server/Template/Storage/kubernetes-emptydir-template.yaml" rel="external" target="_self"><code>Kubernetes Emptydir Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod  </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">emptydir-volume-template       </span> <span style="color:#75715e"># 定义名称</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:   <span style="color:#75715e"># 必选，Pod中容器的详细定义</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:   <span style="color:#75715e"># 必选，Pod中容器列表</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;bash&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;for i in {1..100};do echo $i &gt;&gt;/tmp/hello.txt;sleep 1;done&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:       <span style="color:#75715e"># 将logs-volume挂载到nginx容器中的目录路径</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/tmp</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">readOnly</span>: <span style="color:#66d9ef">false</span>   <span style="color:#75715e"># 是否只读，默认false</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;bash&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;tail -f /tmp/hello.txt&#34;</span>]     <span style="color:#75715e"># 初始命令，动态读取指定文件</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:       <span style="color:#75715e"># 将logs-volume挂载到busybox容器中的目录路径</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/tmp</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:      <span style="color:#75715e"># 声明volume，name为logs-volume，类型为emptyDir</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume  </span> <span style="color:#75715e"># 共享存储卷名称 （volumes类型有很多种）</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">emptyDir</span>: {<span style="color:#f92672">}        # 类型为emtyDir的存储卷，与Pod同生命周期的一个临时目录。为空值，使用 emptyDir</span>: {} <span style="color:#ae81ff">表使用默认值</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e"># medium: string   # 存储介质，支持Memory和空字符串(默认)</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e"># sizeLimit: string        # 大小限制，默认不限制。一般在使用Memory时会限制</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="hostpath"><code>HostPath</code></h3>
<ul>
<li>
<ol>
<li>已经知道<code>EmptyDir</code>中的数据不会被持久化，它会随着<code>Pod</code>的结束而销毁，如果想要简单的将数据持久化到主机中，可以选择<!-- raw HTML omitted --><code>HostPath</code><!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="2">
<li><code>HostPath</code>就是将<code>Node</code>主机中的一个实际目录挂载到<code>Pod</code>中，以供容器使用，这样的设计就可以保证<code>Pod</code>销毁了，但是数据依旧可以保存在<code>Node</code>主机上</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl explain Pod.spec.volumes.hostPath.type  	<span style="color:#75715e"># 类型声明</span></span></span></code></pre></div><ul>
<li><code>Directory</code><!-- raw HTML omitted -->：目录，必须存在<!-- raw HTML omitted --></li>
<li><code>DirectoryOrCreate</code><!-- raw HTML omitted -->：目录存在就使用，不存在就先创建后使用<!-- raw HTML omitted --></li>
<li><code>File</code><!-- raw HTML omitted -->：文件，必须存在<!-- raw HTML omitted --></li>
<li><code>FileOrCreate</code><!-- raw HTML omitted -->：文件存在就使用，不存在就先创建后使用<!-- raw HTML omitted --></li>
<li><code>Socket</code><!-- raw HTML omitted -->：<code>unix</code>套接字，必须存在<!-- raw HTML omitted --></li>
<li><code>CharDevice</code><!-- raw HTML omitted -->：字符设备，必须存在<!-- raw HTML omitted --></li>
<li><code>BlockDevice</code><!-- raw HTML omitted -->：块设备，必须存在<!-- raw HTML omitted --></li>
<li><a href="https://raw.githubusercontent.com/usermice/imgs/master/Kubernetes_Server/Template/Storage/kubernetes-hostpath-template.yaml" rel="external" target="_self"><code>Kubernetes HostPath Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">hostpath-volume-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:       <span style="color:#75715e"># 将logs-volume挂载到nginx容器中的目录目录路径</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/log/nginx</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;tail -f /logs/access.log&#34;</span>]        <span style="color:#75715e"># 初始命令，动态读取指定文件</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:       <span style="color:#75715e"># 将logs-volume挂载到busybox容器中的目录目录路径</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/logs</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:      <span style="color:#75715e"># 声明volume，name为logs-volume，类型为hostPath</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hostPath</span>:   <span style="color:#75715e"># 类型为hostPath的存储卷，表示挂载Pod所在宿主机的目录</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/opt/logs  </span> <span style="color:#75715e"># Pod所在宿主机的目录，将被用于同期中mount的目录</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">type</span>: <span style="color:#ae81ff">DirectoryOrCreate  </span> <span style="color:#75715e"># 目录存在就使用，不存在就先创建再使用</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="nfs"><code>NFS</code></h3>
<blockquote>
<ul>
<li><code>HostPath</code>虽然可以解决数据持久化的问题，但是一旦<code>Node</code>节点故障了，<code>Pod</code>如果转移到别的<code>Node</code>节点上，又会出现问题，此时需要准备单独的网络存储系统，比较常用的是<code>NFS</code>和<code>CIFS</code></li>
<li><code>NFS</code>是一个网络文件存储系统，可以搭建一台<code>NFS</code>服务器，然后将<code>Pod</code>中的存储直接连接到<code>NFS</code>系统上，这样，无论<code>Pod</code>在节点上怎么转移，只要<code>Node</code>和<code>NFS</code>的对接没有问题，数据就可以成功访问</li>
</ul>
</blockquote>
<hr>
<h4 id="font-colorred编辑fontnfs-volumeyamlfont-colorred文件挂载fontnfs"><!-- raw HTML omitted -->编辑<!-- raw HTML omitted --><code>nfs-volume.yaml</code><!-- raw HTML omitted -->文件挂载<!-- raw HTML omitted --><code>NFS</code></h4>
<blockquote>
<ul>
<li><a href="https://raw.githubusercontent.com/usermice/imgs/master/Kubernetes_Server/Template/Storage/kubernetes-nfs-template.yaml" rel="external" target="_self"><code>Kubernetes NFS Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-volume-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:       <span style="color:#75715e"># 将logs-volume挂载到nginx容器中的目录路径</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/log/nginx</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;tail -f /logs/access.log&#34;</span>]        <span style="color:#75715e"># 初始命令，动态读取指定文件</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:       <span style="color:#75715e"># 将logs-volume挂载到busybox容器中的目录路径</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/logs</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:      <span style="color:#75715e"># 声明volume</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nfs</span>:        <span style="color:#75715e"># 存储类型，和底层正则的存储对应</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">server</span>: <span style="color:#ae81ff">192.168.18.100</span>    <span style="color:#75715e"># NFS服务器地址</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/opt/data/nfs     </span> <span style="color:#75715e"># 共享文件路径</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">readOnly</span>: <span style="color:#66d9ef">false</span>   <span style="color:#75715e"># 是否只读，默认false</span></span></span></code></pre></div></blockquote>
<hr>
<h2 id="高级存储">高级存储</h2>
<h3 id="pv持久卷"><code>PV</code>持久卷</h3>
<ul>
<li>
<ol>
<li><code>PV(Persistent Volume)</code><!-- raw HTML omitted -->是持久化卷的意思，是对底层的共享存储的一种抽象。一般情况下<code>PV</code>由<code>kubernetes</code>管理员进行创建和配置，它和底层具体的共享存储技术有关，并通过插件完成和共享存储的对接<!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="2">
<li><code>pv</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><!-- raw HTML omitted -->关键配置<!-- raw HTML omitted --><!-- raw HTML omitted -->参数说明<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->存储类型：<!-- raw HTML omitted -->底层实际存储的类型，<code>kubernetes</code>支持多种存储类型，每种存储类型的配置有所不同</li>
<li>
<ol start="2">
<li><code>capacity</code><!-- raw HTML omitted -->(存储能力)：<!-- raw HTML omitted -->目前只支持存储空间的设置<code>storage=1Gi</code>，不过未来可能会加入<code>IOPS</code>、吞吐量等指标的配置</li>
</ol>
</li>
<li>
<ol start="3">
<li><code>accessModes</code><!-- raw HTML omitted -->(访问模式)：<!-- raw HTML omitted -->用来描述用户应用对存储资源的访问权限，访问权限包括下面几种方式</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>
<p><!-- raw HTML omitted -->需要注意的是：底层不同的存储类型可能支持的访问模式不同<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>ReadWriteOnce(RWO)</code><!-- raw HTML omitted -->：读写权限，<!-- raw HTML omitted -->但是只能被单个节点挂载</p>
</li>
<li>
<p><code>ReadOnlyMany(ROX)</code><!-- raw HTML omitted -->：只读权限，<!-- raw HTML omitted -->可以被多个节点挂载</p>
</li>
<li>
<p><code>ReadWriteMany(RWX)</code><!-- raw HTML omitted -->：读写权限，<!-- raw HTML omitted -->可以被多个节点挂载</p>
</li>
</ul>
</blockquote>
<ul>
<li>
<ol start="4">
<li><code>persistentVolumeReclaimPolicy</code><!-- raw HTML omitted -->(回收策略)：<!-- raw HTML omitted -->当<code>PV</code>不再被使用之后，对其的处理方式，目前支持三种策略</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>
<p><!-- raw HTML omitted -->需要注意的是：底层不同的存储类型可能支持的回收策略不同<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>Retain</code><!-- raw HTML omitted -->(保留)：<!-- raw HTML omitted -->保留数据，需要管理员手动清理数据</p>
</li>
<li>
<p><code>Recycle</code><!-- raw HTML omitted -->(回收)：<!-- raw HTML omitted -->清除<code>PV</code>中的数据，效果相当于<code>rm -rf /volume/*</code></p>
</li>
<li>
<p><code>Delete</code><!-- raw HTML omitted -->(删除)：<!-- raw HTML omitted -->和<code>PV</code>相连的后端存储完成<code>volume</code>的删除操作，常见于云服务器厂商的存储服务</p>
</li>
</ul>
</blockquote>
<ul>
<li>
<ol start="5">
<li><code>storageClassName</code><!-- raw HTML omitted -->(存储类别)：<!-- raw HTML omitted --><code>PV</code>可以通过<code>storageClassName</code>参数指定一个存储类别</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>具有特定类型的<code>PV</code>只能和请求了该类别的<code>PVC</code>进行绑定</li>
<li>未设定类别的<code>PV</code>只能和不请求任何类别的<code>PVC</code>进行绑定</li>
</ul>
</blockquote>
<ul>
<li>
<ol start="6">
<li><code>status</code><!-- raw HTML omitted -->(状态)：<!-- raw HTML omitted -->一个<code>PV</code>的生命周期，可能会处于4种不同的阶段</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>Available</code><!-- raw HTML omitted -->(可用)：<!-- raw HTML omitted -->表示可用状态，还未被任何<code>PVC</code>绑定</li>
<li><code>Bound</code><!-- raw HTML omitted -->(已绑定)：<!-- raw HTML omitted -->表示<code>PV</code>已经被<code>PVC</code>绑定</li>
<li><code>Released</code><!-- raw HTML omitted -->(已释放)：<!-- raw HTML omitted -->表示<code>PVC</code>被删除，但是资源还没有被集群重新释放</li>
<li><code>Failed</code><!-- raw HTML omitted -->(失败)：<!-- raw HTML omitted -->表示该<code>PV</code>的自动回收失败</li>
</ul>
</blockquote>
<ul>
<li><code>PV</code>：<code>kubernetes</code><!-- raw HTML omitted -->管理员维护<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<h4 id="构建font-colorred静态fontpv存储卷">构建<!-- raw HTML omitted -->静态<!-- raw HTML omitted --><code>PV</code>存储卷</h4>
<blockquote>
<ul>
<li><a href="https://raw.githubusercontent.com/usermice/imgs/master/Kubernetes_Server/Template/Storage/kubernetes-pv-template.yaml" rel="external" target="_self"><code>Kubernetes PV Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e">##########   定义Redis的静态 PV持久卷   ##########</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolume</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis-pv-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis-pv-template</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">capacity</span>:     <span style="color:#75715e"># 存储能力，目前只支持存储空间的设置</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">10Gi      </span> <span style="color:#75715e"># 限制容量为 10G</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumeMode</span>: <span style="color:#ae81ff">Filesystem   </span> <span style="color:#75715e"># 存储类型为文件系统</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">accessModes</span>:          <span style="color:#75715e"># 访问模式</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ReadWriteMany      </span> <span style="color:#75715e"># Read：读、Write：写、Once：单节点、Many：代表多节点，Only：只读只写</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">persistentVolumeReclaimPolicy</span>: <span style="color:#ae81ff">Retain  </span> <span style="color:#75715e"># 回收策略：Retain：保留、Recycle：回收、Delete：删除</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">storageClassName</span>: <span style="color:#ae81ff">nfs        </span> <span style="color:#75715e"># 创建 PV 的存储类的自定义名字，PVC需要于此相同，存储类型，分别为： NFS、CephFS、iSCSI</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">mountOptions</span>:         <span style="color:#75715e"># 加载配置</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">hard</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">nfsvers=4.1        </span> <span style="color:#75715e"># NFS 版本</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nfs</span>:          <span style="color:#75715e"># 存储类型，和storageClassName的存储类别对应</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/opt/data/redis      </span> <span style="color:#75715e"># nfs 授权目录</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span>: <span style="color:#ae81ff">192.168.186.110</span>     <span style="color:#75715e"># nfs 所在服务器PV持久卷</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>--- <span style="color:#75715e"># 分隔符可以定义多个</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##########   定义Nginx的静态 PV持久卷   ##########</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolume</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-pv-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-pv-template</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">capacity</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">10Gi</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumeMode</span>: <span style="color:#ae81ff">Filesystem</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">accessModes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ReadWriteMany</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">persistentVolumeReclaimPolicy</span>: <span style="color:#ae81ff">Retain</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">storageClassName</span>: <span style="color:#ae81ff">nfs</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">mountOptions</span>:         <span style="color:#75715e"># 加载配置</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">hard</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">nfsvers=4.1        </span> <span style="color:#75715e"># NFS 版本</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nfs</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/opt/data/nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span>: <span style="color:#ae81ff">192.168.186.110</span></span></span></code></pre></div></blockquote>
<hr>
<h4 id="构建font-colorred动态fontpv存储卷">构建<!-- raw HTML omitted -->动态<!-- raw HTML omitted --><code>PV</code>存储卷</h4>
<ul>
<li>
<ol>
<li><a href="https://kubernetes.io/zh-cn/docs/concepts/storage/storage-classes/" rel="external" target="_self"><code>StorageClass</code>动态资源存储</a></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><a href="https://raw.githubusercontent.com/usermice/imgs/master/Kubernetes_Server/Template/Storage/kubernetes-storageclass-template.yaml" rel="external" target="_self"><code>Kubernetes StorageClass Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">storage.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">StorageClass   </span> <span style="color:#75715e"># 创建动态存储类</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-storage-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">storageclass.kubernetes.io/is-default-class</span>: <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">provisioner</span>: <span style="color:#ae81ff">fuseim.pri/ifs    </span> <span style="color:#75715e"># 外部制备器提供者，编写为提供者的名称，k8s-sigs.io/nfs-subdir-external-provisioner</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">allowVolumeExpansion</span>: <span style="color:#66d9ef">true</span>      <span style="color:#75715e"># 动态调整持久卷大小</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">parameters</span>:     <span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">archiveOnDelete</span>: <span style="color:#e6db74">&#34;true&#34;</span>       <span style="color:#75715e"># 是否存档，false：表示不存档，会删除oldPath下面的数据，true：表示存档，会重命名路径</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">reclaimPolicy</span>: <span style="color:#ae81ff">Retain  </span> <span style="color:#75715e"># 回收策略，默认为：Delete，</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">volumeBindingMode</span>: <span style="color:#ae81ff">Immediate   </span> <span style="color:#75715e"># 默认为：Immediate，表示创建 PVC立即进行绑定，只有：azuredisk和：AWSelasticblockstore 支持其他值</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->创建权限，<!-- raw HTML omitted --><a href="https://raw.githubusercontent.com/usermice/imgs/master/Kubernetes_Server/Template/Permissions/kubernetes-permissions-template.yaml" rel="external" target="_self"><code>Kubernetes Permissions Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount   </span> <span style="color:#75715e"># 权限管理</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole  </span> <span style="color:#75715e"># 创建集群角色</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-client-provisioner-runner</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">apiGroups</span>: [<span style="color:#e6db74">&#34;&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;nodes&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;get&#34;</span>, <span style="color:#e6db74">&#34;list&#34;</span>, <span style="color:#e6db74">&#34;watch&#34;</span>]
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">apiGroups</span>: [<span style="color:#e6db74">&#34;&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;persistentvolumes&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;get&#34;</span>, <span style="color:#e6db74">&#34;list&#34;</span>, <span style="color:#e6db74">&#34;watch&#34;</span>, <span style="color:#e6db74">&#34;create&#34;</span>, <span style="color:#e6db74">&#34;delete&#34;</span>]
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">apiGroups</span>: [<span style="color:#e6db74">&#34;&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;persistentvolumeclaims&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;get&#34;</span>, <span style="color:#e6db74">&#34;list&#34;</span>, <span style="color:#e6db74">&#34;watch&#34;</span>, <span style="color:#e6db74">&#34;update&#34;</span>]
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">apiGroups</span>: [<span style="color:#e6db74">&#34;storage.k8s.io&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;storageclasses&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;get&#34;</span>, <span style="color:#e6db74">&#34;list&#34;</span>, <span style="color:#e6db74">&#34;watch&#34;</span>]
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">apiGroups</span>: [<span style="color:#e6db74">&#34;&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;events&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;create&#34;</span>, <span style="color:#e6db74">&#34;update&#34;</span>, <span style="color:#e6db74">&#34;patch&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRoleBinding   </span> <span style="color:#75715e"># 绑定集群角色</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">run-nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-client-provisioner-runner</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Role   </span> <span style="color:#75715e"># 创建普通角色</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">leader-locking-nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">apiGroups</span>: [<span style="color:#e6db74">&#34;&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;endpoints&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;get&#34;</span>, <span style="color:#e6db74">&#34;list&#34;</span>, <span style="color:#e6db74">&#34;watch&#34;</span>, <span style="color:#e6db74">&#34;create&#34;</span>, <span style="color:#e6db74">&#34;update&#34;</span>, <span style="color:#e6db74">&#34;patch&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">RoleBinding  </span> <span style="color:#75715e"># 绑定普通角色</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">leader-locking-nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Role</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">leader-locking-nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->创建适用与<!-- raw HTML omitted --><code>provisioner</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>Deployment</code><a href="https://raw.githubusercontent.com/usermice/imgs/master/Kubernetes_Server/Template/Storage/kubernetes-deployment-provisioner-nfs-template.yaml" rel="external" target="_self"><code>Kubernetes Deployment Provisioner NFS Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>apiVersion: apps/v1
</span></span><span style="display:flex;"><span>kind: Deployment
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: nfs-client-provisioner
</span></span><span style="display:flex;"><span>  namespace: default
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    app: nfs-client-provisioner
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  replicas: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>  strategy:
</span></span><span style="display:flex;"><span>    type: Recreate      <span style="color:#75715e"># Recreate:不滚动更新，</span>
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    matchLabels:
</span></span><span style="display:flex;"><span>      app: nfs-client-provisioner
</span></span><span style="display:flex;"><span>  template:
</span></span><span style="display:flex;"><span>    metadata:
</span></span><span style="display:flex;"><span>      labels:
</span></span><span style="display:flex;"><span>        app: nfs-client-provisioner
</span></span><span style="display:flex;"><span>    spec:
</span></span><span style="display:flex;"><span>      hostNetwork: true
</span></span><span style="display:flex;"><span>      serviceAccountName: nfs-client-provisioner        <span style="color:#75715e"># 关联：nfs-client-provisioner 账号授与账户权限</span>
</span></span><span style="display:flex;"><span>      containers:
</span></span><span style="display:flex;"><span>      - name: nfs-client-provisioner
</span></span><span style="display:flex;"><span>        image: registry.cn-beijing.aliyuncs.com/pylixm/nfs-subdir-external-provisioner:v4.0.0
</span></span><span style="display:flex;"><span>        resources:
</span></span><span style="display:flex;"><span>          limits:
</span></span><span style="display:flex;"><span>            cpu: 200m
</span></span><span style="display:flex;"><span>            memory: 128Mi
</span></span><span style="display:flex;"><span>          requests:
</span></span><span style="display:flex;"><span>            cpu: 50m
</span></span><span style="display:flex;"><span>            memory: 64Mi
</span></span><span style="display:flex;"><span>        volumeMounts:
</span></span><span style="display:flex;"><span>        - name: nfs-client-root
</span></span><span style="display:flex;"><span>          mountPath: /persistentvolumes
</span></span><span style="display:flex;"><span>        env:
</span></span><span style="display:flex;"><span>        - name: PROVISIONER_NAME
</span></span><span style="display:flex;"><span>          value: fuseim.pri/ifs   <span style="color:#75715e"># 必须和StorageClass的外部制备器提供者名字相同</span>
</span></span><span style="display:flex;"><span>        - name: NFS_SERVER
</span></span><span style="display:flex;"><span>          value: 192.168.186.110        <span style="color:#75715e"># 指定自己nfs服务器地址</span>
</span></span><span style="display:flex;"><span>        - name: NFS_PATH  
</span></span><span style="display:flex;"><span>          value: /opt/data/redis        <span style="color:#75715e"># nfs服务器共享的目录</span>
</span></span><span style="display:flex;"><span>      volumes:
</span></span><span style="display:flex;"><span>      - name: nfs-client-root
</span></span><span style="display:flex;"><span>        nfs:
</span></span><span style="display:flex;"><span>          server: 192.168.186.110
</span></span><span style="display:flex;"><span>          path: /opt/data/redis</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->创建<!-- raw HTML omitted --><code>Service</code>、<code>StatefulSet</code>、<code>PVC</code><!-- raw HTML omitted -->申请动态存储卷<!-- raw HTML omitted --><a href="https://raw.githubusercontent.com/usermice/imgs/master/Kubernetes_Server/Template/Storage/kubernetes-svc-statefulset-storage-nfs-template.yaml" rel="external" target="_self"><code>Kubernetes Service StatefulSet NFS Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">name</span>: <span style="color:#ae81ff">service-template</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">statefulset-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">NodePort</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>    <span style="color:#75715e"># Service的端口</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">80</span>      <span style="color:#75715e"># StatefulSet 的Pod端口</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">StatefulSet</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">statefulset-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">service-template  </span> <span style="color:#75715e"># 使用那个Service管理DNS</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">updateStrategy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate        </span> <span style="color:#75715e"># 滚动更新，OnDelete：删除更新</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>:      <span style="color:#75715e"># 如果更新的策略是OnDelete，那么rollingUpdate就失效</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">partition</span>: <span style="color:#ae81ff">2</span>      <span style="color:#75715e"># 表示从第2个分区开始更新，默认是0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">statefulset-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">statefulset-template</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-pvc-test  	# 关联 PVC 名字，以便使用</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/usr/share/nginx/html</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumeClaimTemplates</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-pvc-test   </span> <span style="color:#75715e"># 定义：PVC 名字</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">storageClassName</span>: <span style="color:#ae81ff">nfs-storage-template   </span> <span style="color:#75715e"># 存储类名字，必须和StorageClass的pods名字相同</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">accessModes</span>:      <span style="color:#75715e"># 访问模式</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">ReadWriteMany  </span> <span style="color:#75715e"># 多节点读写</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">resources</span>:        <span style="color:#75715e"># 期望资源</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">2Gi         </span> <span style="color:#75715e"># 期望的空间容量</span></span></span></code></pre></div><ul>
<li><code>StatefulSet</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>Pods</code><!-- raw HTML omitted -->处于<!-- raw HTML omitted --><code>Pending</code><!-- raw HTML omitted -->状态，<!-- raw HTML omitted --><code>describe</code><!-- raw HTML omitted -->命令查看有以下报错<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>0/3 nodes are available: pod has unbound immediate PersistentVolumeClaims. preemption: 0/3 nodes are available: 3 No preemption victims found for incoming pod..</code></li>
<li><code>quay.io/external_storage/nfs-client-provisioner:latest</code><!-- raw HTML omitted -->官方镜像需要用到<!-- raw HTML omitted --><code>K8S</code><!-- raw HTML omitted -->里的<!-- raw HTML omitted --><code>SelfLink</code><!-- raw HTML omitted -->参数<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->解决方法<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 方法一：更换镜像，建议使用此方法</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 镜像一</span>
</span></span><span style="display:flex;"><span>gcr.io/k8s/staging-sig-storage/nfs-subdir-external-provisioner:v4.0.0
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 镜像二</span>
</span></span><span style="display:flex;"><span>registry.cn-beijing.aliyuncs.com/pylixm/nfs-subdir-external-provisioner:v4.0.0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 更换镜像后重新应用</span>
</span></span><span style="display:flex;"><span>$ kubectl replace -f kubernetes-deployment-provisioner-nfs-template.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 方法二：解决官方不支持方式</span>
</span></span><span style="display:flex;"><span>$ sudo cat &gt;&gt;/etc/kubernetes/manifests/kube-apiserver.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - command:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - kube-apiserver
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --feafure-gates=RemoveSelfLink=false  	# 新增参数，默认是：true 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 重新应用</span>
</span></span><span style="display:flex;"><span>$ kubectl apply -f /etc/kubernetes/manifests/kube-apiserver.yaml</span></span></code></pre></div></blockquote>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>PVC</code> <!-- raw HTML omitted -->方式申请动态<!-- raw HTML omitted --><code>StorageClass</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolumeClaim</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pvc-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">accessModes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ReadWriteMany</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">200Mi</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">storageClassName</span>: <span style="color:#ae81ff">nfs-storage-template   </span> <span style="color:#75715e"># 存储类名字，必须和StorageClass的pods名字相	</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="pvc持久卷申请书"><code>PVC</code>持久卷申请书</h3>
<ul>
<li>
<ol>
<li><code>PVC(Persistent Volume Claim)</code>是持久化卷声明的意思，是用户对于存储需求的一种声明。换言之，PVC其实就是用户向<code>kubernetes</code>系统发出的一种资源需求申请</li>
</ol>
</li>
<li>
<ol start="2">
<li><code>PVC</code>：<code>kubernetes</code>用户维护</li>
</ol>
</li>
<li>
<ol start="3">
<li><code>PVC</code>是资源的申请，用来声明对存储空间、访问模式、存储类别需求信息</li>
</ol>
</li>
<li>
<ol start="4">
<li><code>PVC</code><!-- raw HTML omitted -->的关键配置参数说明<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>accessModes</code>(访客模式)：用于描述用户应用对存储资源的访问权限</li>
</ul>
<blockquote>
<ul>
<li><code>selector</code>(选择条件)：通过<code>Label Selector</code>的设置，可使<code>PVC</code>对于系统中已存在的<code>PV</code>进行筛选</li>
<li><code>storageClassName</code>(存储类别)：<code>PVC</code>在定义时可以设定需要的后端存储的类别，只有设置了该<code>class</code>的<code>pv</code>才能被系统选出</li>
<li><code>resources</code>(资源请求)：描述对存储资源的请求</li>
</ul>
</blockquote>
<ul>
<li><a href="https://raw.githubusercontent.com/usermice/imgs/master/Kubernetes_Server/Template/Storage/kubernetes-pvc-template.yaml" rel="external" target="_self"><code>Kubernetes PVC Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e">##########   定义Redis的PVC申请书，用于申请 Redis的PV   ##########</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolumeClaim</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis-pvc-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis-pvc-template</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumeMode</span>: <span style="color:#ae81ff">Filesystem       </span> <span style="color:#75715e"># 文件系统也需要与 PV相同才能使用</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">accessModes</span>:          <span style="color:#75715e"># 访问模式</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ReadWriteMany      </span> <span style="color:#75715e"># 权限需要与对应的PV 相同，才可以使用，Read：读、Write：写、Once：单节点、Many：代表多节点，Only：只读只写</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">storageClassName</span>: <span style="color:#ae81ff">nfs        </span> <span style="color:#75715e"># 需要与PV名字相同，Block:代表块存储、Filesystem:代表文件系统、nfs</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:    <span style="color:#75715e"># 请求空间</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">5Gi     </span> <span style="color:#75715e"># 对PV申请 5G 的存储空间</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e">##########   定义Nginx的PVC申请书，用于申请 Redis的PV   ##########</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolumeClaim</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-pvc-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-pvc-template</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumeMode</span>: <span style="color:#ae81ff">Filesystem</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">accessModes</span>:          <span style="color:#75715e"># 访问模式</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ReadWriteMany      </span> <span style="color:#75715e"># Read:代表可读、Write:代表写、Many:代表多节点</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">storageClassName</span>: <span style="color:#ae81ff">nfs        </span> <span style="color:#75715e"># 存储类型 ，Block:代表块存储、Filesystem:代表文件系统、nfs</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:    <span style="color:#75715e"># 请求空间</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">5Gi     </span> <span style="color:#75715e"># 对PV申请 5G 的存储空间</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e">##########      创建 Deployment 访问 PVC 类型存储   ##########</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis-pod-pvc-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis-pod-pvc-template</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">revisionHistoryLimit</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">progressDeadlineSeconds</span>: <span style="color:#ae81ff">600</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">strategy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>:      <span style="color:#75715e"># 当type为RollingUpdate的时候生效，用于为rollingUpdate设置参数</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">30</span><span style="color:#ae81ff">%      </span> <span style="color:#75715e"># 用来指定在升级过程中不可用的Pod的最大数量，默认为25%。</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxSurge</span>: <span style="color:#ae81ff">30</span><span style="color:#ae81ff">%    </span> <span style="color:#75715e"># 用来指定在升级过程中可以超过期望的Pod的最大数量，默认为25%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate        </span> <span style="color:#75715e"># 更新策略、支持 Recreate, RollingUpdate。默认RollingUpdate</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:     <span style="color:#75715e"># 选择器，通过它指定该控制器管理哪些pod </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:        <span style="color:#75715e"># Labels匹配规则，matchExpressions：Expressions匹配规则 </span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis-pvc-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:     <span style="color:#75715e"># 模板，当副本数量不足时，会根据下面的模板创建pod副本 </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:   <span style="color:#75715e"># Pod 的标签</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis-pvc-template</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#  nodeSelector:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    kubernetes.io/hostname: kube-01     # 指定节点</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">reids</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">redis:6.2.7</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;while true;do echo pod1 &gt;&gt; /root/out.txt; sleep 10; done;&#34;</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis-data       </span> <span style="color:#75715e"># 必须与volume定义的名称相同</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/opt/redis/conf       </span> <span style="color:#75715e"># 容器内路径</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis-data   </span> <span style="color:#75715e"># 自定义名称</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">persistentVolumeClaim</span>:      <span style="color:#75715e"># 关联 PVC</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">claimName</span>: <span style="color:#ae81ff">redis-pvc-template    </span> <span style="color:#75715e"># 关联 PVC，必须和定义PVC名称相同且，必须和当前pod在同一个命名空间</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">readOnly</span>: <span style="color:#66d9ef">false</span>   <span style="color:#75715e"># 是否只读，默认false</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="pvfont-colorred和fontpvc"><code>PV</code><!-- raw HTML omitted -->和<!-- raw HTML omitted --><code>PVC</code></h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->创建<!-- raw HTML omitted --><code>PVC</code><!-- raw HTML omitted -->后一直绑定不了<!-- raw HTML omitted --><code>PV</code><!-- raw HTML omitted -->的原因<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<p>① <code>PVC</code><!-- raw HTML omitted -->的空间申请大小比<!-- raw HTML omitted --><code>PV</code><!-- raw HTML omitted -->的空间要大<!-- raw HTML omitted --></p>
<p>② <code>PVC</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>storageClassName</code><!-- raw HTML omitted -->和<!-- raw HTML omitted --><code>PV</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>storageClassName</code><!-- raw HTML omitted -->不一致<!-- raw HTML omitted --></p>
<p>③ <code>PVC</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>accessModes</code><!-- raw HTML omitted -->和<!-- raw HTML omitted --><code>PV</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>accessModes</code><!-- raw HTML omitted -->不一致<!-- raw HTML omitted --></p>
</blockquote>
<ul>
<li>
<ol start="2">
<li><code>PVC</code><!-- raw HTML omitted -->和<!-- raw HTML omitted --><code>PV</code><!-- raw HTML omitted -->是一一对应，<!-- raw HTML omitted --><code>PV</code><!-- raw HTML omitted -->和<!-- raw HTML omitted --><code>PVC</code><!-- raw HTML omitted -->之间的相互作用遵循如下生命周期<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->资源供应：<!-- raw HTML omitted -->管理员手动创建底层存储和<code>PV</code></li>
<li><!-- raw HTML omitted -->资源绑定<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>用户创建<code>PVC</code>，<code>kubernetes</code>负责根据<code>PVC</code>声明去寻找<code>PV</code>，并绑定在用户定义好<code>PVC</code>之后，系统将根据<code>PVC</code>对存储资源的请求在以存在的<code>PV</code>中选择一个满足条件的</li>
</ul>
<blockquote>
<ul>
<li>一旦找到就将该<code>PV</code>和用户定义的<code>PVC</code>进行绑定，用户的应用就可以使用这个<code>PVC</code>了</li>
<li>如果找不到<code>PVC</code>就会无限期的处于<code>Pending</code>状态，直到系统管理员创建一个符合其要求的<code>PV</code></li>
</ul>
</blockquote>
<ul>
<li><code>PV</code>一旦绑定到某个<code>PVC</code>上就会被这个<code>PVC</code>独占，不能再和其他的<code>PVC</code>进行绑定了</li>
</ul>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->资源使用：<!-- raw HTML omitted -->用户可以在<code>Pod</code>中像<code>volume</code>一样使用<code>PVC</code>，<code>Pod</code>使用<code>Volume</code>的定义，将<code>PVC</code>挂载到容器内的某个路径进行使用</li>
<li><!-- raw HTML omitted -->资源释放<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>用户删除<code>PVC</code>来释放<code>PV</code></li>
<li>当存储资源使用完毕后，用户可以删除<code>PVC</code>，和该<code>PVC</code>绑定的<code>PV</code>将会标记为<!-- raw HTML omitted -->已释放<!-- raw HTML omitted -->但是还不能立刻和其他的<code>PVC</code>进行绑定。通过之前<code>PVC</code>写入的数据可能还留在存储设备上，只有在清除之后该<code>PV</code>才能再次使用</li>
</ul>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->资源回收<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>kubernetes</code>根据<code>PV</code>设置的回收策略进行资源的回收</li>
<li>对于<code>PV</code>，管理员可以设定回收策略，用于设置与之绑定的<code>PVC</code>释放资源之后如何处理遗留数据的问题。只有<code>PV</code>的存储空间完成回收，才能供新的<code>PVC</code>绑定和使用</li>
</ul>
</blockquote>
</blockquote>
<hr>
<h2 id="配置文件存储管理">配置文件存储管理</h2>
<h3 id="configmapfont-colorredfontsecretfont-colorred覆盖fontmark热更新mark"><code>ConfigMap</code><!-- raw HTML omitted -->&amp;<!-- raw HTML omitted --><code>Secret</code><!-- raw HTML omitted -->覆盖<!-- raw HTML omitted --><!-- raw HTML omitted -->热更新<!-- raw HTML omitted --></h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->注意事项<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>SubPath</code><!-- raw HTML omitted -->解决<!-- raw HTML omitted --><code>ConfigMap</code><!-- raw HTML omitted -->&amp;&amp;<!-- raw HTML omitted --><code>Secret</code><!-- raw HTML omitted -->目录覆盖问题，<!-- raw HTML omitted --><code>SubPath</code><!-- raw HTML omitted -->不支持热更新<!-- raw HTML omitted --></li>
<li>如果<code>ConfigMap</code>和<code>Secret</code>是以<code>subPath</code>的形式挂载的，那么<code>Pod</code>是不会感知到<code>ConfigMap</code>和<code>Secret</code>的更新的</li>
<li>如果<code>Pod</code>的变量来自<code>ConfigMap</code>和<code>Secret</code>中定义的内容，那么<code>ConfigMap</code>和<code>Secret</code>更新后，也不会更新<code>Pod</code>中的变量</li>
<li><code>immutable: true</code><!-- raw HTML omitted -->：禁止修改<!-- raw HTML omitted --><code>ConfigMap</code>、<code>Secret</code></li>
</ul>
</blockquote>
<hr>
<h3 id="configmap配置类型"><code>ConfigMap</code>配置类型</h3>
<h4 id="configmap简介以及注意事项"><code>ConfigMap</code>简介以及注意事项</h4>
<blockquote>
<ul>
<li><code>ConfigMap</code><!-- raw HTML omitted -->：是一个比较特殊的存储卷，它的主要作用是用来存储配置信息的<!-- raw HTML omitted --></li>
<li><code>ConfigMap</code>中的<code>key</code>映射为一个文件，<code>value</code>映射为文件中的内容。如果更新了<code>ConfigMap</code>中的内容，容器中的值也会动态更新</li>
<li><code>ConfigMap</code>是一种<code>API</code>对象，<!-- raw HTML omitted -->用来将非加密数据保存到键值对中。可以用作环境变量、命令行参数或者存储卷中的配置文件<!-- raw HTML omitted --></li>
<li><code>ConfigMap</code><!-- raw HTML omitted -->可以将环境变量配置信息和容器镜像解耦，便于应用配置的修改。如果需要存储加密信息时可以使用<!-- raw HTML omitted --><code>Secret</code>对象</li>
<li>使用<code>ConfigMap</code><!-- raw HTML omitted -->有以下几个限制条件：<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>ConfigMap</code><!-- raw HTML omitted -->必须<!-- raw HTML omitted -->在<code>pod</code>之前创建</li>
<li><code>ConfigMap</code>受<code>namespace</code>的限制，<!-- raw HTML omitted -->只能<!-- raw HTML omitted -->相同<code>namespace</code>的<code>pod</code>才可以引用</li>
</ul>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->注意事项<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>ConfigMap</code><!-- raw HTML omitted -->在设计上不是用来保存大量数据的<!-- raw HTML omitted -->在<code>ConfigMap</code>中保存的数据不可超过<code>1 MiB</code></li>
<li>如果需要保存超出此尺寸限制的数据，需要考虑挂载存储卷或者使用独立的数据库或者文件服务</li>
</ul>
</blockquote>
</blockquote>
<hr>
<h4 id="configmap使用以及配置"><code>ConfigMap</code>使用以及配置</h4>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->获取使用帮助<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl create configmap -h  	<span style="color:#75715e"># 查看使用帮助  </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl create configmap &lt;map-name&gt; &lt;data-source&gt;  	<span style="color:#75715e"># 命令使用方式  </span></span></span></code></pre></div><ul>
<li>从<!-- raw HTML omitted -->目录<!-- raw HTML omitted -->中创建<code>ConfigMap</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -pv /opt/yaml/configmap/config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;&gt;/opt/yaml/configmap/config/db.properties<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">port=3306
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">username=root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">host=127.0.0.1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">password=password
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;&gt;/opt/yaml/configmap/config/redis.properties<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">port=6379
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">host=127.0.0.1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">password=password
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --from-file：目录下的所有文件都会被用在ConfigMap里面创建一个键值对，键的名字就是文件名，值就是文件的内容，  </span>
</span></span><span style="display:flex;"><span>$ kubectl create configmap configmap-template --from-file<span style="color:#f92672">=</span>/opt/yaml/configmap/config/</span></span></code></pre></div><ul>
<li>从<!-- raw HTML omitted -->文件<!-- raw HTML omitted -->中创建<code>ConfigMap</code><!-- raw HTML omitted -->，并自定义<!-- raw HTML omitted --><code>ConfigMap</code><!-- raw HTML omitted -->中<!-- raw HTML omitted --><code>key</code><!-- raw HTML omitted -->的名称<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># --from-file，可以使用多次，同样键为文件名，值为文件中的内容</span>
</span></span><span style="display:flex;"><span>$ kubectl create configmap configmap-template-2 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> --from-file<span style="color:#f92672">=</span>rename1<span style="color:#f92672">=</span>/opt/yaml/configmap/config/db.properties <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> --from-file<span style="color:#f92672">=</span>rename2<span style="color:#f92672">=</span>/opt/yaml/configmap/config/redis.properties  </span></span></code></pre></div><ul>
<li><code>--from-literal=key=value</code><!-- raw HTML omitted -->键值对方式<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 使用：literal(key:value)，方式，--from-literal=key1=123 --from-literal=key2=234</span>
</span></span><span style="display:flex;"><span>$ kubectl create configmap configmap-template-3 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> --from-literal<span style="color:#f92672">=</span>key-1<span style="color:#f92672">=</span>value-1 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> --from-literal<span style="color:#f92672">=</span>key-2<span style="color:#f92672">=</span>value-2</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->从环境变量文件创建<!-- raw HTML omitted --><code>ConfigMap</code></li>
</ul>
<blockquote>
<ul>
<li>
<p><!-- raw HTML omitted -->注意：<!-- raw HTML omitted -->当<code>--from-env-file</code>从多个数据源创建<code>ConfigMap</code>的时候，仅仅最后一个<code>env</code>文件有效</p>
</li>
<li>
<p><!-- raw HTML omitted -->语法规则：<!-- raw HTML omitted --></p>
<p><code>env</code>文件中的每一行必须为<code>VAR = VAL</code>格式</p>
<p>以<code>＃</code>开头的行(即注释)将被忽略</p>
<p>空行将被忽略</p>
<p>引号没有特殊处理(即它们将成为<code>ConfigMap</code>值的一部分)</p>
</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl create configmap configmap-template-3 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --from-literal<span style="color:#f92672">=</span>password<span style="color:#f92672">=</span>passwd123 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --from-literal<span style="color:#f92672">=</span>APP_NAME<span style="color:#f92672">=</span>springboot-test <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --from-literal<span style="color:#f92672">=</span>JAVA_OPTS_TEST<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Xms512m -Xmx512&#39;</span>  </span></span></code></pre></div><ul>
<li><a href="https://raw.githubusercontent.com/usermice/imgs/master/Kubernetes_Server/Template/Storage/kubernetes-configmap-env-template.yaml" rel="external" target="_self"><code>Kubernetes ConfigMap ENV Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">configmap-env-test</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">revisionHistoryLimit</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">progressDeadlineSeconds</span>: <span style="color:#ae81ff">600</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>: 
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">name</span>: <span style="color:#ae81ff">configmap-env-test</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">strategy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxSurge</span>: <span style="color:#ae81ff">25</span><span style="color:#ae81ff">%</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">25</span><span style="color:#ae81ff">%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">configmap-env-test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">env-test</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">command</span>: [ <span style="color:#e6db74">&#34;/bin/sh&#34;</span>, <span style="color:#e6db74">&#34;-c&#34;</span>, <span style="color:#e6db74">&#34;env;sleep 3600&#34;</span> ]
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">env</span>:          <span style="color:#75715e"># 定义环境变量</span>
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">APP_ENV_TEST_CM      </span> <span style="color:#75715e"># 定义环境变量名</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">configMapKeyRef</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">name</span>: <span style="color:#ae81ff">configmap-template-3     </span> <span style="color:#75715e"># ConfigMap 的名字</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">key</span>: <span style="color:#ae81ff">APP_NAME  </span> <span style="color:#75715e"># 表示从 name的ConfigMap中获取名字为Key 的value，将其赋值给容器内本地的环境变量 APP_ENV_TEST_CM</span>
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">JAVA_ENV_TEST_CM</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">configMapKeyRef</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">name</span>: <span style="color:#ae81ff">configmap-template-3     </span> <span style="color:#75715e"># ConfigMap 的名字</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">key</span>: <span style="color:#ae81ff">JAVA_OPTS_TEST    </span> <span style="color:#75715e"># ConfigMap 的 key</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">volumeMounts</span>:   <span style="color:#75715e"># 加载数据卷</span>
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">passwd-config  </span> <span style="color:#75715e"># 表示加载 volumes 属性中那个数据卷</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">mountPath</span>: <span style="color:#e6db74">&#34;/opt/&#34;</span>    <span style="color:#75715e"># 想要将数据卷中的文件加载到那个目录下</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">readOnly</span>: <span style="color:#66d9ef">true</span>    <span style="color:#75715e"># 是否只读</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumes</span>: <span style="color:#75715e"># 依数据卷方式挂载 ConfigMap Secret</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">passwd-config  </span> <span style="color:#75715e"># 自定义名字</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">configMap</span>:    <span style="color:#75715e"># 数据卷类型为：ConfigMap</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">configmap-template-3   </span> <span style="color:#75715e"># ComfigMap 的名字，必须和加载的ConfigMap相同</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">items</span>:    <span style="color:#75715e"># 对 ConfigMap中的Key进行映射，如果不指定，默认会将ConfigMap中所有Key全部转换为一个个同名文件</span>
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">key</span>: <span style="color:#e6db74">&#34;password&#34;</span>   <span style="color:#75715e"># ConfigMap中的Key</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#34;password&#34;</span>    <span style="color:#75715e"># 将该Key的值转换为文件  </span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">restartPolicy</span>: <span style="color:#ae81ff">Always</span></span></span></code></pre></div><div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;&gt;/opt/yaml/configmap/config/env-file.properties<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">enemies=aliens
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">lives=3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">allowed=&#34;true&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl create cm configmap-template-3 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --from-env-file<span style="color:#f92672">=</span>/opt/yaml/configmap/config/env-file.properties
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;&gt;env.txt<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 其中，env.txt的文件格式为:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">key1=***
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">key2=***
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl create configmap configmap名 --from-env-file<span style="color:#f92672">=</span>env.txt </span></span></code></pre></div></blockquote>
<ul>
<li><code>ConfigMap</code><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>nginx.conf</code><!-- raw HTML omitted -->配置文件进行替换<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;&gt;nginx.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#user  nobody;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">worker_processes  1;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">events {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> worker_connections  1024;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#########   我是测试配置文件   ##########
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">http {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> include       mime.types;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> default_type  application/octet-stream;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> sendfile        on;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> keepalive_timeout  65;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> server {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     listen       80;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     server_name  localhost;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     location / {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         root   html;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         index  index.html index.htm;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     error_page   500 502 503 504  /50x.html;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     location = /50x.html {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         root   html;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>nginx.conf</code><!-- raw HTML omitted -->创建<!-- raw HTML omitted --><code>ConfigMap</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl create configmap nginxconf-cm-template --from-file<span style="color:#f92672">=</span>nginx.conf</span></span></code></pre></div><ul>
<li><a href="https://raw.githubusercontent.com/usermice/imgs/master/Kubernetes_Server/Template/Storage/kubernetes-configmap-template.yaml" rel="external" target="_self"><code>Kubernetes configmap Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e">##########   配置 Deployment 引用 ConfigMap 创建的文件   ##########</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-configmap-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">revisionHistoryLimit</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">progressDeadlineSeconds</span>: <span style="color:#ae81ff">600</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>: 
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-cm-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">strategy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxSurge</span>: <span style="color:#ae81ff">25</span><span style="color:#ae81ff">%</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">25</span><span style="color:#ae81ff">%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-cm-template</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">200m</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">128Mi</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">50m</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">128Mi</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-config   </span> <span style="color:#75715e"># 引用定义的 vulumes 名称</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#e6db74">&#39;/etc/nginx/nginx.conf&#39;</span>    <span style="color:#75715e"># 文件全路径</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">subPath</span>: <span style="color:#ae81ff">etc/nginx/nginx.conf  </span> <span style="color:#75715e"># subPath：要覆盖文件的相对路径，只覆盖必要文件，如果缺少此配置，将清空原有的所有文件和目录，不需要最前面的：/</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">restartPolicy</span>: <span style="color:#ae81ff">Always</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">terminationGracePeriodSeconds</span>: <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-config   </span> <span style="color:#75715e"># 定义 volumes 的名称</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">configMap</span>: <span style="color:#75715e"># 类型为configMap的存储卷，挂载预定义的configMap对象到容器内部</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginxconf-cm-template     </span> <span style="color:#75715e"># ConfigMap名称，使用名称进行关联 ConfigMap</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">items</span>:   <span style="color:#75715e"># 将configMap中的Key进行映射，如果不指定，默认会将configMap中所有Key全部转为一个个同名文档</span>
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">nginx.conf   </span> <span style="color:#75715e"># configMap中的Key</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">etc/nginx/nginx.conf  </span> <span style="color:#75715e"># 将该Key的值转为文件，最前面不需要：/</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted --> 进入<code>Pod</code>中查看<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl exec -it nginx-configmap-pod --  /bin/sh
</span></span><span style="display:flex;"><span>$ more /etc/nginx/nginx.conf</span></span></code></pre></div></blockquote>
<ul>
<li><a href="https://raw.githubusercontent.com/usermice/imgs/master/Kubernetes_Server/Template/Storage/kubernetes-configmap-simple-template.yaml" rel="external" target="_self"><code>Kubernetes ConfigMap Simple Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ConfigMap</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">configmap-template   </span> <span style="color:#75715e"># ConfigMap</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">data</span>:   <span style="color:#75715e"># &lt;map[string]string&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">info</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">username:admin</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">password:123456</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##########   挂载数据方式   ##########</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">stream.conf</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    stream.conf {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      server {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        listen 1550;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        proxy_pass  192.168.3.125:16303;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }</span>    
</span></span><span style="display:flex;"><span><span style="color:#75715e">##########   挂载数据方式   ##########</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">listen-port</span>: <span style="color:#e6db74">&#34;8080&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">server-name</span>: <span style="color:#ae81ff">www.erge.com</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">default-vhost: |      # 此内容传给 Pod 中 items: 下 path</span>: <span style="color:#ae81ff">路径中</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">server {</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">listen 8080 default;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">location / {</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">return 200 &#34;default-vhost!\r\n&#34;;</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">blog-vhosts</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    server {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      listen 8080;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      server_name blog.erge.com;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      location / {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        return 200 &#34;blog-vhosts!\r\n&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }</span>    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e">##########   配置env引用方式 pod-configmap   ##########</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">configmap-pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tier</span>: <span style="color:#ae81ff">configmap</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">role</span>: <span style="color:#ae81ff">slb</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">mountPath</span>: <span style="color:#e6db74">&#39;/etc/nginx&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">LISTEN_PORT</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">configMapKeyRef</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">slb-vhosts-config</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">key</span>: <span style="color:#ae81ff">listen-port</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">SERVER_NAME</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">configMapKeyRef</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">slb-vhosts-config</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">key</span>: <span style="color:#ae81ff">server-name</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config  	# 定义 volumes 的名称</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">configMap</span>: <span style="color:#75715e"># 类型为configMap的存储卷，挂载预定义的configMap对象到容器内部</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">configmap-template </span> <span style="color:#75715e"># ConfigMap生成的Pod 名称，使用名称关联</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e"># items:   # 将configMap中的Key进行映射，如果不指定，默认会将configMap中所有Key全部转为一个个同名文档</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e"># - key: nginx.conf    # configMap中的Key</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">#   path: etc/nginx/nginx.conf   # 将该Key的值转为文件</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e">##########   配置volume引用方式 pod-configmap   ########## </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-configmap</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/configmap/config     </span> <span style="color:#75715e"># 没有则会自动创建,目录下有文件则会覆盖掉</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-config</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-config         </span> <span style="color:#75715e"># 此名称和 volumeMounts定义name名称一样</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">configMap</span>:          <span style="color:#75715e"># 类型为configMap的存储卷，挂载预定义的configMap对象到容器内部</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">configmap  </span> <span style="color:#75715e"># 配置为 configMap 容器的名称</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">defaultMode</span>: <span style="color:#ae81ff">integer      </span> <span style="color:#75715e"># 挂载到Pod中后，文件权限，如0444</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">items</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">default-vhost       </span> <span style="color:#75715e"># configMap中data下的key</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">default.conf       </span> <span style="color:#75715e"># 挂载路径，获取Configmap中data关键字下 定义配置文件名传给 volumeMounts 下的mountPath中</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mode</span>: <span style="color:#ae81ff">integer    </span> <span style="color:#75715e"># 文件权限</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">blog-vhosts</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">blog.conf</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">optional</span>: <span style="color:#66d9ef">true</span>      <span style="color:#75715e"># 当key不存在时是否报错，默认true</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="secret密码令牌类型"><code>Secret</code>密码令牌类型</h3>
<h4 id="secret简介以及注意事项"><code>Secret</code>简介以及注意事项</h4>
<blockquote>
<ul>
<li><code>Secret</code><!-- raw HTML omitted -->：在<!-- raw HTML omitted --><code>kubernetes</code><!-- raw HTML omitted -->中，还存在一种和<!-- raw HTML omitted --><code>ConfigMap</code><!-- raw HTML omitted -->非常类似的对象，称为<!-- raw HTML omitted --><code>Secret</code><!-- raw HTML omitted -->对象，它主要用来存储敏感信息，例如密码、密钥、证书等等<!-- raw HTML omitted --></li>
<li><code>imagePullSecret</code><!-- raw HTML omitted -->：<code>Pod</code>拉取私有镜像仓库的时使用的账户密码，会传递给<!-- raw HTML omitted --><code>kubelet</code><!-- raw HTML omitted -->，然后<!-- raw HTML omitted --><code>kubelet</code><!-- raw HTML omitted -->就可以拉取有密码的仓库里面的镜像<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->如果同时使用<!-- raw HTML omitted --><code>data</code><!-- raw HTML omitted -->和<!-- raw HTML omitted --><code>stringData</code><!-- raw HTML omitted -->，那么<!-- raw HTML omitted --><code>data</code><!-- raw HTML omitted -->会被忽略<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<hr>
<h4 id="secret使用以及配置"><code>Secret</code>使用以及配置</h4>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->获取使用帮助<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl create secret -h  	<span style="color:#75715e"># 查看使用帮助</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl create secret <span style="color:#f92672">[</span>flags<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>options<span style="color:#f92672">]</span>  	<span style="color:#75715e"># 命令使用方式  	</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>base64</code><!-- raw HTML omitted -->对准备的数据进行编码：对用户名、密码进行编码<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo -n <span style="color:#e6db74">&#39;user_name&#39;</span> | base64  		<span style="color:#75715e"># 特殊字符使用：&#39;&#39;(单引号)</span>
</span></span><span style="display:flex;"><span>$ echo -n <span style="color:#e6db74">&#39;password&#39;</span> | base64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 解码使用：--decode</span>
</span></span><span style="display:flex;"><span>$ echo -n <span style="color:#e6db74">&#39;dXNlcl9uYW1l&#39;</span> | base64 --decode</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->从命令行创建<!-- raw HTML omitted --><code>Secret</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl create secret generic secret-name <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> --from-literal<span style="color:#f92672">=</span>username<span style="color:#f92672">=</span>admin <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> --from-literal<span style="color:#f92672">=</span>password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;passwd@!3-&#39;</span>  	<span style="color:#75715e"># 特殊字符使用：&#39;&#39;(单引号)</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->创建<!-- raw HTML omitted --><code>Secret</code><!-- raw HTML omitted -->连接<!-- raw HTML omitted --><code>Harbor</code><!-- raw HTML omitted -->私人仓库<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>docker-harbor-registrykey</code>：<code>Secret</code>的<code>Pods</code><!-- raw HTML omitted -->名称，自定义<!-- raw HTML omitted --></li>
<li><code>--docker-server</code><!-- raw HTML omitted -->：镜像仓库地址<!-- raw HTML omitted --></li>
<li><code>--docker-username</code><!-- raw HTML omitted -->：镜像仓库用户名<!-- raw HTML omitted --></li>
<li><code>--docker-password</code><!-- raw HTML omitted -->：镜像仓库密码<!-- raw HTML omitted --></li>
<li><code>--docker-email</code><!-- raw HTML omitted -->：邮箱地址<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 获取 docker-registry 使用帮助</span>
</span></span><span style="display:flex;"><span>$ kubectl create secret docker-registry -h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建一个ImagePullSecret</span>
</span></span><span style="display:flex;"><span>$ kubectl create secret docker-registry docker-harbor-registrykey <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --docker-server<span style="color:#f92672">=</span>192.168.18.119:85:8080 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --docker-username<span style="color:#f92672">=</span>admin <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --docker-password<span style="color:#f92672">=</span>Harbor12345 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --docker-email<span style="color:#f92672">=</span>xxxxx@qq.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看是否创建成功</span>
</span></span><span style="display:flex;"><span>$ kubectl get secret docker-harbor-registrykey</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->创建<!-- raw HTML omitted --><code>redis.yaml</code><!-- raw HTML omitted -->文件，获取<!-- raw HTML omitted --><code>Harbor</code><!-- raw HTML omitted -->仓库镜像<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">imagePullSecrets</span>:  	<span style="color:#75715e"># 配置登录 docker registry 的 secret 仓库</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">docker-harbor-registrykey  	# 引用Secret的Pods，容器名称</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">192.168.18.119</span>:<span style="color:#ae81ff">85</span><span style="color:#ae81ff">/yuncloud/redis</span> <span style="color:#75715e"># 这是Harbor的镜像私有仓库地址</span></span></span></code></pre></div></blockquote>
<ul>
<li>准备<code>volumes-secret</code><!-- raw HTML omitted -->资源清单<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Secret</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">secret</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">Opaque</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">data</span>:  	<span style="color:#75715e"># 提前编码使用：data、使用Kubernetes进行编码使用：stringData</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">username</span>: <span style="color:#ae81ff">YWRtaW4=  	# 使用kubernetes进行编码写，原数据：admin</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">password</span>: <span style="color:#ae81ff">MTIzNDU2  	# 使用kubernetes进行编码写，原数据：123456</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e">##########   配置 secret-pod   ##########</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">secret-pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/secret/config</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">secret</span>:  	<span style="color:#75715e"># 类型为secret的存储卷，挂载集群与定义的secret对象到容器内部</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">secretName</span>: <span style="color:#ae81ff">secret</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">items</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">string</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">string</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted --> 查看编码后的目录以及信息<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 将nginx.conf导出到本地</span>
</span></span><span style="display:flex;"><span>$ kubectl exec -it nginx -- cat /etc/nginx/nginx.conf &gt; nginx.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl exec -it secret-pod-name -n default -- /bin/sh
</span></span><span style="display:flex;"><span>$ ls /secret/config
</span></span><span style="display:flex;"><span>$ more /secret/config/username
</span></span><span style="display:flex;"><span>$ more /secret/config/password</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="configure_k8s_rancher">Configure_K8s_Rancher</h1>

<h2 id="rancher服务宕机情况下使用kubernetes-cluster"><code>Rancher</code>服务宕机情况下使用<code>Kubernetes Cluster</code></h2>
<ul>
<li>
<ol>
<li><a href="https://docs.rancher.cn/docs/rancher2/cluster-admin/cleaning-cluster-nodes/_index/" rel="external" target="_self"><code>Rancher</code>清理节点</a></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>KUBE_SVC<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kube-scheduler
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kube-proxy
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kube-controller-manager
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kube-apiserver
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> kube_svc in <span style="color:#e6db74">${</span>KUBE_SVC<span style="color:#e6db74">}</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e"># 停止服务</span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">`</span>systemctl is-active <span style="color:#e6db74">${</span>kube_svc<span style="color:#e6db74">}</span><span style="color:#e6db74">`</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;active&#39;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        systemctl stop <span style="color:#e6db74">${</span>kube_svc<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e"># 禁止服务开机启动</span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">`</span>systemctl is-enabled <span style="color:#e6db74">${</span>kube_svc<span style="color:#e6db74">}</span><span style="color:#e6db74">`</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;enabled&#39;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        systemctl disable <span style="color:#e6db74">${</span>kube_svc<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 停止所有容器</span>
</span></span><span style="display:flex;"><span>docker stop <span style="color:#66d9ef">$(</span>docker ps -aq<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除所有容器</span>
</span></span><span style="display:flex;"><span>docker rm -f <span style="color:#66d9ef">$(</span>docker ps -qa<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除所有容器卷</span>
</span></span><span style="display:flex;"><span>docker volume rm <span style="color:#66d9ef">$(</span>docker volume ls -q<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 卸载mount目录</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> mount in <span style="color:#66d9ef">$(</span>mount | grep tmpfs | grep <span style="color:#e6db74">&#39;/var/lib/kubelet&#39;</span> | awk <span style="color:#e6db74">&#39;{ print $3 }&#39;</span><span style="color:#66d9ef">)</span> /var/lib/kubelet /var/lib/rancher;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>   umount $mount;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 备份目录</span>
</span></span><span style="display:flex;"><span>mv /etc/kubernetes /etc/kubernetes-bak-<span style="color:#66d9ef">$(</span>date +<span style="color:#e6db74">&#34;%Y%m%d%H%M&#34;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>mv /var/lib/etcd /var/lib/etcd-bak-<span style="color:#66d9ef">$(</span>date +<span style="color:#e6db74">&#34;%Y%m%d%H%M&#34;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>mv /var/lib/rancher /var/lib/rancher-bak-<span style="color:#66d9ef">$(</span>date +<span style="color:#e6db74">&#34;%Y%m%d%H%M&#34;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>mv /opt/rke /opt/rke-bak-<span style="color:#66d9ef">$(</span>date +<span style="color:#e6db74">&#34;%Y%m%d%H%M&#34;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除残留路径</span>
</span></span><span style="display:flex;"><span>rm -rf /etc/ceph <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> /etc/cni <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> /opt/cni <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> /run/secrets/kubernetes.io <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> /run/calico <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> /run/flannel <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> /var/lib/calico <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> /var/lib/cni <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> /var/lib/kubelet <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> /var/log/containers <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> /var/log/kube-audit <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> /var/log/pods <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> /var/run/calico <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> /usr/libexec/kubernetes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 清理网络接口</span>
</span></span><span style="display:flex;"><span>no_del_net_inter<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">lo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">eth
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ens
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">bond
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>network_interface<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>ls /sys/class/net<span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> net_inter in $network_interface;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">if</span> ! echo <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>no_del_net_inter<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> | grep -qE <span style="color:#e6db74">${</span>net_inter:0:3<span style="color:#e6db74">}</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        ip link delete $net_inter
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 清理残留进程</span>
</span></span><span style="display:flex;"><span>port_list<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">80
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">443
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">6443
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">2376
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">2379
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">2380
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">8472
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">9099
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">10250
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">10254
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> port in $port_list;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>   pid<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>netstat -atlnup | grep $port | awk <span style="color:#e6db74">&#39;{print $7}&#39;</span> | awk -F <span style="color:#e6db74">&#39;/&#39;</span> <span style="color:#e6db74">&#39;{print $1}&#39;</span> | grep -v - | sort -rnk2 | uniq<span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> -n $pid <span style="color:#f92672">]]</span>;<span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        kill -9 $pid
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kube_pid<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>ps -ef | grep -v grep | grep kube | awk <span style="color:#e6db74">&#39;{print $2}&#39;</span><span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> -n $kube_pid <span style="color:#f92672">]]</span>;<span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>   kill -9 $kube_pid
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 清理Iptables表</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 注意：如果节点Iptables有特殊配置，以下命令请谨慎操作</span>
</span></span><span style="display:flex;"><span>sudo iptables --flush
</span></span><span style="display:flex;"><span>sudo iptables --flush --table nat
</span></span><span style="display:flex;"><span>sudo iptables --flush --table filter
</span></span><span style="display:flex;"><span>sudo iptables --table nat --delete-chain
</span></span><span style="display:flex;"><span>sudo iptables --table filter --delete-chain
</span></span><span style="display:flex;"><span>systemctl restart docker</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted --><code>Rancher Server</code>是上游中心管理角色，控制或创建旗下<code>N</code>个<code>Kubernetes Cluster</code>集群，不管是测试中的单个节点或者是<code>Kubernetes Cluster</code>集群失效都无法读取，运维仍需要对下游所有<code>Kubernetes Cluster</code>集群管控<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>服务器</th>
<th>IP</th>
<th>CPU</th>
<th>内存</th>
</tr>
</thead>
<tbody>
<tr>
<td>master</td>
<td>192.168.35.128</td>
<td>8<code>core</code></td>
<td>8G</td>
</tr>
<tr>
<td>node-1</td>
<td>192.168.35.129</td>
<td>4<code>core</code></td>
<td>4G</td>
</tr>
<tr>
<td>node-2</td>
<td>192.168.35.130</td>
<td>4<code>core</code></td>
<td>4G</td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>
<ol start="3">
<li>前提条件</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>3.1 <!-- raw HTML omitted -->所有机器都是<code>CentOS 7</code><!-- raw HTML omitted --></li>
<li>3.2 <!-- raw HTML omitted --><code>Rancher Server</code>是以<code>Docker</code>方式单独建立<!-- raw HTML omitted --></li>
<li>3.3 <!-- raw HTML omitted --><code>test-cluster Kubernetes Cluster</code>集群是以<code>Rancher Server</code>自定义方式创建<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->模拟<code>Racnher Server</code>服务失效对<code>Kubernetes Cluster</code>集群进行管控<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>4.1 <!-- raw HTML omitted -->点击创建集群名称<!-- raw HTML omitted --></li>
</ul>
<p><a href="#R-image-d8d57bac1361f3189b85aab4957b165d" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-20_15-47-45.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-d8d57bac1361f3189b85aab4957b165d"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-20_15-47-45.png"></a></p>
<ul>
<li>4.2 <!-- raw HTML omitted -->提前下载<code>Kubernetesfig</code>文件<!-- raw HTML omitted --></li>
</ul>
<p><a href="#R-image-c8198e7e3fafd524e3cbbb98dfe5c1b3" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-20_15-49-19.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-c8198e7e3fafd524e3cbbb98dfe5c1b3"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-20_15-49-19.png"></a></p>
<p><a href="#R-image-f7e0313d37d038d55e0fe71a002c08a6" class="lightbox-link"><img alt="下k8s file" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-20_16-16-23.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-f7e0313d37d038d55e0fe71a002c08a6"><img alt="下k8s file" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-20_16-16-23.png"></a></p>
</blockquote>
<hr>
<h2 id="模拟rancher服务宕机">模拟<code>Rancher</code>服务宕机</h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->停止<code>Rancher Server</code>服务<code>docker stop rancher</code><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>1.1 <!-- raw HTML omitted --><code>查看Kubernetes</code>集群版本号<!-- raw HTML omitted --></li>
</ul>
<p><a href="#R-image-2df7aadca9b7a0efb5c7f0fd2d4ee0e6" class="lightbox-link"><img alt="查看<code>Rancher</code>安装<code>Kubernetes</code>集群版本" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-25_20-04-18.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-2df7aadca9b7a0efb5c7f0fd2d4ee0e6"><img alt="查看<code>Rancher</code>安装<code>Kubernetes</code>集群版本" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-25_20-04-18.png"></a></p>
</blockquote>
<h3 id="安装kubectl">安装<code>Kubectl</code></h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->在能连接<code>test-kubernetes-cluster</code>集群中任意一个节点部署<code>Kubectl</code><!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="2">
<li><!-- raw HTML omitted --><code>Kubectl</code>版本需和<code>test-cluster-cluster</code>版本相同或者高于<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/yum.repos.d/kubernetes.repo<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[kubernetes] 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name=Kubernetes 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">enabled=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgcheck=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">repo_gpgcheck=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ yum -y install kubectl-1.23.6-0</span></span></code></pre></div></blockquote>
<h3 id="创建kube目录修改文件">创建<code>.kube</code>目录修改文件</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->并且将下载的<code>Kubernetesfig</code>文件改名为<code>config</code>，然后放到<code>${HOME}/.kube/</code>目录中<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir <span style="color:#e6db74">${</span>HOME<span style="color:#e6db74">}</span>/.kube
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ mv <span style="color:#e6db74">${</span>HOME<span style="color:#e6db74">}</span>/.kube/test-kubernetes-cluster.yaml <span style="color:#e6db74">${</span>HOME<span style="color:#e6db74">}</span>/.kube/config</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted --><code>${HOME}/.kube/config</code>文件没修改前<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat <span style="color:#e6db74">${</span>HOME<span style="color:#e6db74">}</span>/.kube/config
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Config
</span></span><span style="display:flex;"><span>clusters:
</span></span><span style="display:flex;"><span>- name: <span style="color:#e6db74">&#34;test-kubernetes-cluster&#34;</span>
</span></span><span style="display:flex;"><span>  cluster:
</span></span><span style="display:flex;"><span>    server: <span style="color:#e6db74">&#34;https://192.168.80.210:4443/k8s/clusters/c-gwknl&#34;</span>
</span></span><span style="display:flex;"><span>    certificate-authority-data: <span style="color:#e6db74">&#34;LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJwekNDQ\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      VUyZ0F3SUJBZ0lCQURBS0JnZ3Foa2pPUFFRREFqQTdNUnd3R2dZRFZRUUtFeE5rZVc1aGJXbGoKY\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      kdsemRHVnVaWEl0YjNKbk1Sc3dHUVlEVlFRREV4SmtlVzVoYldsamJHbHpkR1Z1WlhJdFkyRXdIa\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      GNOTWpJdwpOVEkxTVRFeE9UUXhXaGNOTXpJd05USXlNVEV4T1RReFdqQTdNUnd3R2dZRFZRUUtFe\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      E5rZVc1aGJXbGpiR2x6CmRHVnVaWEl0YjNKbk1Sc3dHUVlEVlFRREV4SmtlVzVoYldsamJHbHpkR\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      1Z1WlhJdFkyRXdXVEFUQmdjcWhrak8KUFFJQkJnZ3Foa2pPUFFNQkJ3TkNBQVJTb3NwRzE4OHJBQ\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      mZabTAwQnRqcjAyL29udnZGVnppU09wZUdVd09SUApoSHpUbk1acTRmazVpRFhPV2lIUy9iQ0hvT\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      WQra1VtYkx6QVRPNkd2azdtSm8wSXdRREFPQmdOVkhROEJBZjhFCkJBTUNBcVF3RHdZRFZSMFRBU\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      UgvQkFVd0F3RUIvekFkQmdOVkhRNEVGZ1FVZ1YzR1g0Z2tXN3hPZVZWQURWem0KVEpxSW95b3dDZ\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      1lJS29aSXpqMEVBd0lEU0FBd1JRSWdlTHh3WTVGcGkweDBGNXhBQUNZMnNPbVQ4aHBqNjVCWApUc\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      1lsQk1sOGx0RUNJUURkNmlONTJmbG9hVzZybXpvWXRLQy9nOEJRRW00b2UrcGN0YldCaGY0UENRP\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      T0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQ==&#34;</span>
</span></span><span style="display:flex;"><span>- name: <span style="color:#e6db74">&#34;test-kubernetes-cluster-node-1-80-211&#34;</span>
</span></span><span style="display:flex;"><span>  cluster:
</span></span><span style="display:flex;"><span>    server: <span style="color:#e6db74">&#34;https://192.168.80.211:6443&#34;</span>
</span></span><span style="display:flex;"><span>    certificate-authority-data: <span style="color:#e6db74">&#34;LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUM0VENDQ\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      WNtZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFTTVJBd0RnWURWUVFERXdkcmRXSmwKT\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      FdOaE1CNFhEVEl5TURVeU5URXhNek0xTUZvWERUTXlNRFV5TWpFeE16TTFNRm93RWpFUU1BNEdBM\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      VVFQXhNSAphM1ZpWlMxallUQ0NBU0l3RFFZSktvWklodmNOQVFFQkJRQURnZ0VQQURDQ0FRb0NnZ\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      0VCQUtJSzVRVy84eHB3CkRHUzMrN0M2Q0lobS8zcWFUUENvVmdFeU91YkVtR1EzbnAvYk9qTUJKY\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      3Ayck05cW5CV2M4ZmtUUWhCNHZsL24Kay8zSkUrMkdta1RBbVAwaGpLa3d6d1JiT2lrYzdYVEtnd\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      ElTQ3I2cjRkOWhZTElERElzTTJtUzZYYnhNdGd1SApoamk3MTJYQmNoZ3lEamxjREl3S1k5WXRYc\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      3lDY3hPejdFNXN4YmpLTk1nb2sxK3VZSTlHaHhYYUlGcGp0VWFUClJXUW00dE9JOFplWWlUWG9aT\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      nJldTU1SVkyZ3pQVjZ1dURTWGQybFRHMEtmVng0Y1FYSDJIekdSODJ4NWZkK3kKS01HY0M1N21DN\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      HpiM3pET1Z2NVNEdmxOZEhyQ0g3QmpVYzh0MlFpU2JyQUwrQ216NnhMVFF4dlp1YkVLejU2TApKe\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      ElKUGFhNkdSY0NBd0VBQWFOQ01FQXdEZ1lEVlIwUEFRSC9CQVFEQWdLa01BOEdBMVVkRXdFQi93U\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      UZNQU1CCkFmOHdIUVlEVlIwT0JCWUVGSkN3bmVCVXZUMUtoeWtCUjF6bmxWQ2I1T2RnTUEwR0NTc\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      UdTSWIzRFFFQkN3VUEKQTRJQkFRQnRwa0doRDJ1RFdYTmZaSUhaa0NNclNpSkZXaGxIUGNPa2VPZ\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      TJwcmp1UEZ0bzFWMVpyNlloWWVpcQp1cGxRdWlpenBwbEthZncxR1lpSnY4SCsrcHpjUFZoS3JTM\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      2F5Ykp1T2hxdnFyYUVZbzJDbjVVbkFpVWxBb2g1CnRqY1lNcVFKdkVzODd5UlFtUVhMSVNEMkdYb\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      3UwN24ySy9wTVZXQWpHYjRsUTk0VmpHcjI3dHppSlhIYkh2L04KbHNNZklJV2czbTFKSW9SMlBNa\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      3gvY1FpcGl6a3JRVHRpalhMbW0xbUFGOEtMR2JZcnNaTk1sMFdITWZWWjdXcgplemRBVjhVNDdsb\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      GowKzUzQ0FkZk0rYWpiSk5uMUtYMWF1Sm8rb1JXVTJjVno0SkYydUllMnBjcFcxUUplY1NPCmZ2U\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      ysyOU9FK09GZW5tenRINTdZTStTWk1jRE8KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>users:
</span></span><span style="display:flex;"><span>- name: <span style="color:#e6db74">&#34;test-kubernetes-cluster&#34;</span>
</span></span><span style="display:flex;"><span>  user:
</span></span><span style="display:flex;"><span>    token: <span style="color:#e6db74">&#34;kubeconfig-user-j85xz8pbjt:ls679hfqpvf9c25nswd5gdfm2hf4qtxj2kvqmj6kzzrjkj48lwwlpd&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>contexts:
</span></span><span style="display:flex;"><span>- name: <span style="color:#e6db74">&#34;test-kubernetes-cluster&#34;</span>
</span></span><span style="display:flex;"><span>  context:
</span></span><span style="display:flex;"><span>    user: <span style="color:#e6db74">&#34;test-kubernetes-cluster&#34;</span>
</span></span><span style="display:flex;"><span>    cluster: <span style="color:#e6db74">&#34;test-kubernetes-cluster&#34;</span>
</span></span><span style="display:flex;"><span>- name: <span style="color:#e6db74">&#34;test-kubernetes-cluster-node-1-80-211&#34;</span>
</span></span><span style="display:flex;"><span>  context:
</span></span><span style="display:flex;"><span>    user: <span style="color:#e6db74">&#34;test-kubernetes-cluster&#34;</span>
</span></span><span style="display:flex;"><span>    cluster: <span style="color:#e6db74">&#34;test-kubernetes-cluster-node-1-80-211&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>current-context: <span style="color:#e6db74">&#34;test-kubernetes-cluster&#34;</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted --><code>${HOME}/.kube/config</code>文件修改后<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat <span style="color:#e6db74">${</span>HOME<span style="color:#e6db74">}</span>/.kube/config
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Config
</span></span><span style="display:flex;"><span>clusters:
</span></span><span style="display:flex;"><span>- name: <span style="color:#e6db74">&#34;test-kubernetes-cluster-rke-master&#34;</span>
</span></span><span style="display:flex;"><span>  cluster:
</span></span><span style="display:flex;"><span>    server: <span style="color:#e6db74">&#34;https://192.168.80.211:6443&#34;</span>
</span></span><span style="display:flex;"><span>    certificate-authority-data: <span style="color:#e6db74">&#34;LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUM0VENDQ\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      WNtZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFTTVJBd0RnWURWUVFERXdkcmRXSmwKT\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      FdOaE1CNFhEVEl5TURVeU5URXhNek0xTUZvWERUTXlNRFV5TWpFeE16TTFNRm93RWpFUU1BNEdBM\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      VVFQXhNSAphM1ZpWlMxallUQ0NBU0l3RFFZSktvWklodmNOQVFFQkJRQURnZ0VQQURDQ0FRb0NnZ\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      0VCQUtJSzVRVy84eHB3CkRHUzMrN0M2Q0lobS8zcWFUUENvVmdFeU91YkVtR1EzbnAvYk9qTUJKY\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      3Ayck05cW5CV2M4ZmtUUWhCNHZsL24Kay8zSkUrMkdta1RBbVAwaGpLa3d6d1JiT2lrYzdYVEtnd\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      ElTQ3I2cjRkOWhZTElERElzTTJtUzZYYnhNdGd1SApoamk3MTJYQmNoZ3lEamxjREl3S1k5WXRYc\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      3lDY3hPejdFNXN4YmpLTk1nb2sxK3VZSTlHaHhYYUlGcGp0VWFUClJXUW00dE9JOFplWWlUWG9aT\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      nJldTU1SVkyZ3pQVjZ1dURTWGQybFRHMEtmVng0Y1FYSDJIekdSODJ4NWZkK3kKS01HY0M1N21DN\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      HpiM3pET1Z2NVNEdmxOZEhyQ0g3QmpVYzh0MlFpU2JyQUwrQ216NnhMVFF4dlp1YkVLejU2TApKe\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      ElKUGFhNkdSY0NBd0VBQWFOQ01FQXdEZ1lEVlIwUEFRSC9CQVFEQWdLa01BOEdBMVVkRXdFQi93U\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      UZNQU1CCkFmOHdIUVlEVlIwT0JCWUVGSkN3bmVCVXZUMUtoeWtCUjF6bmxWQ2I1T2RnTUEwR0NTc\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      UdTSWIzRFFFQkN3VUEKQTRJQkFRQnRwa0doRDJ1RFdYTmZaSUhaa0NNclNpSkZXaGxIUGNPa2VPZ\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      TJwcmp1UEZ0bzFWMVpyNlloWWVpcQp1cGxRdWlpenBwbEthZncxR1lpSnY4SCsrcHpjUFZoS3JTM\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      2F5Ykp1T2hxdnFyYUVZbzJDbjVVbkFpVWxBb2g1CnRqY1lNcVFKdkVzODd5UlFtUVhMSVNEMkdYb\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      3UwN24ySy9wTVZXQWpHYjRsUTk0VmpHcjI3dHppSlhIYkh2L04KbHNNZklJV2czbTFKSW9SMlBNa\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      3gvY1FpcGl6a3JRVHRpalhMbW0xbUFGOEtMR2JZcnNaTk1sMFdITWZWWjdXcgplemRBVjhVNDdsb\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      GowKzUzQ0FkZk0rYWpiSk5uMUtYMWF1Sm8rb1JXVTJjVno0SkYydUllMnBjcFcxUUplY1NPCmZ2U\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      ysyOU9FK09GZW5tenRINTdZTStTWk1jRE8KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>users:
</span></span><span style="display:flex;"><span>- name: <span style="color:#e6db74">&#34;test-kubernetes-cluster-rke-master&#34;</span>
</span></span><span style="display:flex;"><span>  user:
</span></span><span style="display:flex;"><span>    token: <span style="color:#e6db74">&#34;kubeconfig-user-j85xz8pbjt:ls679hfqpvf9c25nswd5gdfm2hf4qtxj2kvqmj6kzzrjkj48lwwlpd&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>contexts:
</span></span><span style="display:flex;"><span>- name: <span style="color:#e6db74">&#34;test-kubernetes-cluster-rke-master&#34;</span>
</span></span><span style="display:flex;"><span>  context:
</span></span><span style="display:flex;"><span>    user: <span style="color:#e6db74">&#34;test-kubernetes-cluster-rke-master&#34;</span>
</span></span><span style="display:flex;"><span>    cluster: <span style="color:#e6db74">&#34;test-kubernetes-cluster-rke-master&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>current-context: <span style="color:#e6db74">&#34;test-kubernetes-cluster-rke-master&#34;</span></span></span></code></pre></div></blockquote>
<h3 id="使用kubectl控制kubernetes-cluster集群">使用<code>Kubectl</code>控制<code>Kubernetes Cluster</code>集群</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl --kubeconfig <span style="color:#e6db74">${</span>HOME<span style="color:#e6db74">}</span>/.kube/config get pods -n kube-system
</span></span><span style="display:flex;"><span>$ kubectl create ns dev</span></span></code></pre></div></blockquote>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="configure_k8s_jcr">Configure_K8s_Jcr</h1>

<h2 id="安装配置jfrog-artifactory">安装配置<code>JFrog Artifactory</code></h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->下载最新<!-- raw HTML omitted --><code>JFrog Artifactory</code>社区版镜像</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ docker pull docker.bintray.io/jfrog/artifactory-jcr:latest</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->为私有镜像仓库做持久化存储<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -p /opt/docker/volume/artifactory
</span></span><span style="display:flex;"><span>$ chmod <span style="color:#ae81ff">777</span> -R /opt/docker
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 切换到上述目录后执行数据卷创建命令</span>
</span></span><span style="display:flex;"><span>$ cd /opt/docker/volume/artifactory
</span></span><span style="display:flex;"><span>$ docker volume create data</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->启动镜像<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>3.1 <!-- raw HTML omitted -->默认用户名：<!-- raw HTML omitted --><code>admin</code></li>
<li>3.2 <!-- raw HTML omitted -->默认密码：<!-- raw HTML omitted --><code>password</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ docker run --name jfrog-artifactory -d -v /opt/docker/volume/artifactory:/var/opt/jfrog/artifactory -p 8081:8081 -p 8082:8082 docker.bintray.io/jfrog/artifactory-jcr:latest</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->打开浏览器访问<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>http://ip:8082  	<span style="color:#75715e"># 或者配置Nginx域名</span></span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="configure_k8s_helm">Configure_K8s_Helm</h1>

<h1 id="使用helm配置管理k8s">使用<code>Helm</code>配置管理<code>K8s</code></h1>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/bitnami/" rel="external" target="_self"><code>Bitnami</code>模板库</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/bitnami/charts/tree/main/bitnami" rel="external" target="_self"><code>Kubernetes</code>的<code>Bitnami</code>库</a></td>
<td><code>Helm</code>安装<code>Kubernetes</code>服务<code>Zabbix</code>、<code>Redis</code>、<code>Mysql</code>模板</td>
</tr>
<tr>
<td><a href="https://github.com/bitnami/charts-docs/tree/main/charts" rel="external" target="_self"><code>Kubernetes</code>的<code>Charts-docs</code>库</a></td>
<td><code>Helm</code>安装<code>Kubernetes</code>服务<code>Zabbix</code>、<code>Redis</code>、<code>Mysql</code>模板</td>
</tr>
<tr>
<td><a href="https://artifacthub.io/" rel="external" target="_self">查找、安装和发布<code>Kubernetes</code>包</a></td>
<td><code>Helm</code>安装<code>Kubernetes</code>服务<code>Zabbix</code>、<code>Redis</code>、<code>Mysql</code>模板</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>
<ol>
<li><code>kubernetes</code>上的应用对象，都是由特定的资源描述组成，包括<code>Deployment</code>、<code>Service</code>等，都保存在各自文件中或者集中写在一个配置文件，然后通过<code>kubectl apply -f </code>部署。如果应用只由一个或几个这样的服务组成，上面的部署方式就足够了。但是对于一个复杂的应用，会有很多类似上面的资源描述文件，例如微服务架构应用，组成应用的服务可能多达几十、上百个，如果有更新或回滚应用的需求，可能要修改和维护所涉及到大量的资源文件，而这种组织和管理应用的方式就显得力不从心了。并且由于缺少对发布过的应用进行版本管理和控制，使得<code>kubernetes</code>上的应用维护和更新面临诸多的挑战，主要面临以下的问题：</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>如何将这些服务作为一个整体管理？</li>
<li>这些资源文件如何高效复用？</li>
<li>应用级别的版本如何管理？</li>
</ul>
</blockquote>
<ul>
<li>
<ol start="2">
<li><code>Helm</code><!-- raw HTML omitted -->是一个<!-- raw HTML omitted --><code>kubernetes</code><!-- raw HTML omitted -->的包管理工具，就像<!-- raw HTML omitted --><code>Linux</code><!-- raw HTML omitted -->下的包管理器，如<!-- raw HTML omitted --><code>yum</code>、<code>apt</code><!-- raw HTML omitted -->等，可以很方便的将之前打包好的<!-- raw HTML omitted --><code>yaml</code><!-- raw HTML omitted -->文件部署到<!-- raw HTML omitted --><code>kubernetes</code>上</li>
</ol>
</li>
<li>
<ol start="3">
<li><code>Helm</code><!-- raw HTML omitted -->有3个重要概念<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>helm</code><!-- raw HTML omitted -->：一个命令行客户端工具，主要用于<!-- raw HTML omitted --><code>kubernetes</code>应用<code>chart</code>的创建、打包、发布和管理</li>
<li><code>chart</code><!-- raw HTML omitted -->：应用描述，一系列用于描述<!-- raw HTML omitted --><code>kubernetes</code>资源相关文件的集合，类似<code>Ansible</code>的<code>Playbook</code>剧本</li>
<li><code>release</code><!-- raw HTML omitted -->：基于<!-- raw HTML omitted --><code>chart</code><!-- raw HTML omitted -->的部署实体，一个<!-- raw HTML omitted --><code>chart</code>被<code>Helm</code>运行后将会生成对应的一个<code>release</code>，将在<code>kubernetes</code>中创建出真实运行的资源对象</li>
</ul>
</blockquote>
<ul>
<li>
<ol start="4">
<li><code>Helm v3</code><!-- raw HTML omitted -->变化<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>最明显变化删除<code>Tiller</code>组件</li>
<li><code>release</code>名称可以在不同的命名空间重用。</li>
<li>支持将<code>chart</code>推动到<code>Docker</code>镜像仓库中</li>
<li>使用<code>JSONSchema</code>验证<code>chart values</code></li>
</ul>
</blockquote>
<hr>
<h2 id="helm常用命令"><code>Helm</code>常用命令</h2>
<blockquote>
<table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>get</code></td>
<td>下载一个<code>release</code>。可用的子命令：<code>all</code>、<code>hooks</code>、<code>manifest</code>、<code>note</code>、<code>values</code></td>
</tr>
<tr>
<td><code>repo</code></td>
<td>添加、列出、移除、更新和索引<code>chart</code>仓库。可用的子命令：<code>add</code>、<code>index</code>、<code>list</code>、<code>remove</code>、<code>update</code></td>
</tr>
<tr>
<td><code>list</code></td>
<td>列出<code>release</code></td>
</tr>
<tr>
<td><code>pull</code></td>
<td>从远程仓库中下载<code>chart</code>并解压到本地。比如：<code>helm install stable/mysql --untar</code></td>
</tr>
<tr>
<td><code>show</code></td>
<td>查看<code>chart</code>的详细信息。可用的子命令：<code>all</code>、<code>chart</code>、<code>readme</code>、<code>values</code></td>
</tr>
<tr>
<td><code>search</code></td>
<td>根据关键字搜索<code>chart</code>。可用的子命令：<code>all</code>、<code>chart</code>、<code>readme</code>、<code>values</code></td>
</tr>
<tr>
<td><code>create</code></td>
<td>创建一个<code>chart</code>并指定名字</td>
</tr>
<tr>
<td><code>install</code></td>
<td>安装一个<code>chart</code></td>
</tr>
<tr>
<td><code>status</code></td>
<td>显示已命名版本的状态</td>
</tr>
<tr>
<td><code>upgrade</code></td>
<td>更新升级一个<code>release</code></td>
</tr>
<tr>
<td><code>history</code></td>
<td>获取<code>release</code>历史</td>
</tr>
<tr>
<td><code>package</code></td>
<td>将<code>chart</code>目录打包到<code>chart</code>存档文件中</td>
</tr>
<tr>
<td><code>template</code></td>
<td>本地呈现模板</td>
</tr>
<tr>
<td><code>rollback</code></td>
<td>从之前的版本回退</td>
</tr>
<tr>
<td><code>uninstall</code></td>
<td>卸载一个<code>release</code></td>
</tr>
<tr>
<td><code>dependency</code></td>
<td>管理<code>chart</code>依赖</td>
</tr>
<tr>
<td><code>version</code></td>
<td>查看<code>Helm</code>客户端版本</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h2 id="font-colorred安装fonthelm"><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>Helm</code></h2>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->使用二进制安装<!-- raw HTML omitted --><code>Helm</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget https://get.helm.sh/helm-v3.9.0-linux-amd64.tar.gz  
</span></span><span style="display:flex;"><span>$ tar -zxvf helm-v3.9.0-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>$ mv linux-amd64/helm /usr/local/bin/helm</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->脚本安装<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
</span></span><span style="display:flex;"><span>$ chmod <span style="color:#ae81ff">700</span> get_helm.sh
</span></span><span style="display:flex;"><span>$ ./get_helm.sh</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->源代码安装<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git clone https://github.com/helm/helm.git
</span></span><span style="display:flex;"><span>$ cd helm
</span></span><span style="display:flex;"><span>$ make</span></span></code></pre></div></blockquote>
<hr>
<h2 id="配置chart仓库">配置<code>chart</code>仓库</h2>
<blockquote>
<ul>
<li><code>Helm</code><!-- raw HTML omitted -->添加仓库方式<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm repo add 仓库名 仓库地址</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->使用官方仓库<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm repo add helm https://hub.kubeapps.com/charts/incubator</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->添加其它仓库<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># Bitnami</span>
</span></span><span style="display:flex;"><span>$ helm repo add bitnami https://charts.bitnami.com/bitnami
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用微软仓库</span>
</span></span><span style="display:flex;"><span>$ helm repo add microsoft http://mirror.azure.cn/kubernetes/charts
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 国内添加阿里云、微软仓库</span>
</span></span><span style="display:flex;"><span>$ helm repo add aliyun https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->更新仓库命令<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm repo update</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->删除存储库<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm repo remove 仓库名</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->获取配置的存储库<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm repo list</span></span></code></pre></div></blockquote>
<hr>
<h2 id="helm基本使用"><code>Helm</code>基本使用</h2>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->根据关键字搜索<!-- raw HTML omitted --><code>chart</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm search repo | hub chart名称
</span></span><span style="display:flex;"><span>$ helm search repo redis    <span style="color:#75715e"># 示例</span>
</span></span><span style="display:flex;"><span>  DEPRECATED  	<span style="color:#75715e"># 表示已过期</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->查看<!-- raw HTML omitted --><code>chart</code><!-- raw HTML omitted -->信息<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm show chart 仓库名/chart名称
</span></span><span style="display:flex;"><span>$ helm show chart bitnami/redis</span></span></code></pre></div><ul>
<li><code>readme</code><!-- raw HTML omitted -->查看安装文档说明<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm show readme bitnami/redis</span></span></code></pre></div></blockquote>
<hr>
<h3 id="font-colorred安装fontchartfont-colorred形成fontrelease"><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>chart</code><!-- raw HTML omitted -->，形成<!-- raw HTML omitted --><code>release</code></h3>
<ul>
<li>
<ol>
<li>自定义选项是因为并不是所有的<code>chart</code>都能按照默认配置运行成功，可能会需要一些环境依赖，例如<code>PV</code>。</li>
</ol>
</li>
<li>
<ol start="2">
<li>所以需要自定义<code>chart</code>配置选项，安装过程中有两种方法可以传递配置数据：</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>--values</code><!-- raw HTML omitted -->：的使用(麻烦、不推荐)<!-- raw HTML omitted --></li>
<li><code>--set</code><!-- raw HTML omitted -->：在命令行上指定替代。如果两种都用，那么<!-- raw HTML omitted --><code>--set</code>的优先级高</li>
<li><code>--values 或 -f</code><!-- raw HTML omitted -->：指定带有覆盖的<!-- raw HTML omitted --><code>YAML</code>文件。这里可以多次指定，最右边的文件优先</li>
</ul>
</blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->安装可能报错，需要自己手动安装<!-- raw HTML omitted --><code>PV</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->先将修改的变量写到一个文件中，并修改此文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm show values stable/mysql &gt; config.yaml</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>config.yaml</code><!-- raw HTML omitted -->文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>-- <span style="color:#ae81ff">修改部分</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">persistence</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">accessMode</span>: <span style="color:#ae81ff">ReadWriteOnce</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">size</span>: <span style="color:#ae81ff">8Gi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">mysqlUser</span>: <span style="color:#e6db74">&#34;k8s&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">mysqlPassword</span>: <span style="color:#e6db74">&#34;123456&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">mysqlDatabase</span>: <span style="color:#e6db74">&#34;k8s&#34;</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>-f</code><!-- raw HTML omitted -->来替换默认的配置<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm install -f config.yaml self-mysql stable/mysql</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->推荐使用命令行替代变量<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm install db --set persistence.storageClass<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;managed-nfs-storage&#34;</span> stable/mysql</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>chart</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm install 安装之后的名称 仓库名/chart的名称<span style="color:#f92672">(</span>即搜索之后的应用名称<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>$ helm install k8s_ui stable/weave-scope  	<span style="color:#75715e"># 安装 stable/weave-scope，并将其命名为 k8s_ui</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看当前的 release 列表</span>
</span></span><span style="display:flex;"><span>$ helm list
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看已命名 release 的状态</span>
</span></span><span style="display:flex;"><span>$ helm status k8s_ui 安装之后的名称</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="6">
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>Helm</code><!-- raw HTML omitted -->构建一个<!-- raw HTML omitted --><code>Chart</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>helm create</code><!-- raw HTML omitted -->创建<!-- raw HTML omitted --><code>chart</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm create mychart  <span style="color:#75715e"># chart名称</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->进入自定义<!-- raw HTML omitted --><code>chart</code><!-- raw HTML omitted -->目录的<!-- raw HTML omitted --><code>templates</code><!-- raw HTML omitted -->目录中，修改其中的<!-- raw HTML omitted --><code>deployment.yaml</code>和<code>service.yaml</code><!-- raw HTML omitted -->等文件<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>charts</code><!-- raw HTML omitted -->：该目录保存其他依赖的<!-- raw HTML omitted --><code>chart(子chart)</code></li>
<li><code>Chart.yaml</code><!-- raw HTML omitted -->：定义当前<!-- raw HTML omitted --><code>Chart</code><!-- raw HTML omitted -->属性信息<!-- raw HTML omitted --></li>
<li><code>templates</code><!-- raw HTML omitted -->：<code>chart</code>配置模板，目录存放所有<!-- raw HTML omitted --><code>yaml</code><!-- raw HTML omitted -->文件<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>Deployment.yaml</code><!-- raw HTML omitted -->：<!-- raw HTML omitted --></li>
<li><code>_helpers.tpl</code><!-- raw HTML omitted -->：<!-- raw HTML omitted --></li>
<li><code>hpa.yaml</code><!-- raw HTML omitted -->：<!-- raw HTML omitted --></li>
<li><code>ingress.yaml</code><!-- raw HTML omitted -->：<!-- raw HTML omitted --></li>
<li><code>NOTES.txt</code><!-- raw HTML omitted -->：用于介绍<code>Chart</code>的帮助信息，<code>Helm install</code>部署后展示给用户<!-- raw HTML omitted --></li>
<li><code>serviceaccount.yaml</code><!-- raw HTML omitted -->：<!-- raw HTML omitted --></li>
<li><code>service.yaml</code><!-- raw HTML omitted -->：<!-- raw HTML omitted --></li>
<li><code>tests</code><!-- raw HTML omitted -->：<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>tests-connection.yaml</code><!-- raw HTML omitted -->：<!-- raw HTML omitted --></li>
</ul>
</blockquote>
</blockquote>
<ul>
<li><code>values.yaml</code><!-- raw HTML omitted -->：定义所有<!-- raw HTML omitted --><code>yaml</code><!-- raw HTML omitted -->全局变量<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd chart名称/templates</span></span></code></pre></div><p><a href="#R-image-047832c37600ebd7b4d2ebba89e7ec62" class="lightbox-link"><img alt="Chart中的信息" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Helm/Chart%E4%B8%AD%E7%9A%84%E4%BF%A1%E6%81%AF.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-047832c37600ebd7b4d2ebba89e7ec62"><img alt="Chart中的信息" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Helm/Chart%E4%B8%AD%E7%9A%84%E4%BF%A1%E6%81%AF.png"></a></p>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->通过刚才创建的<!-- raw HTML omitted --><code>chart</code><!-- raw HTML omitted -->目录，将其部署<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm install web mychart  <span style="color:#75715e"># web:自定义名称，chart名称</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->打包<!-- raw HTML omitted --><code>chart</code><!-- raw HTML omitted -->，让别人共享<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm package mychart  <span style="color:#75715e"># chart名称</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="font-colorred查看fontservicefont-colorred并将其改为fontnodeport"><!-- raw HTML omitted -->查看<!-- raw HTML omitted --><code>Service</code><!-- raw HTML omitted -->，并将其改为<!-- raw HTML omitted --><code>NodePort</code></h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl edit svc xxx
</span></span><span style="display:flex;"><span>$ kubectl edit svc ui-weave-scope</span></span></code></pre></div></blockquote>
<hr>
<h3 id="font-colorred应用示例font"><!-- raw HTML omitted -->应用示例<!-- raw HTML omitted --></h3>
<ul>
<li>
<ol>
<li><code>root</code><!-- raw HTML omitted -->目录下操作的<!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="2">
<li>创建<code>chart</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm create nginx</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->进入<!-- raw HTML omitted --><code>chart</code><!-- raw HTML omitted -->目录，修改<!-- raw HTML omitted --><code>values.yaml</code><!-- raw HTML omitted -->文件，内容如下<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo cat &gt;&gt;nginx/values.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">replicas: 3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">image: nginx 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">tag: 1.17 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">serviceport: 80 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">targetport: 80 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">label: nginx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->删除<!-- raw HTML omitted --><code>templates</code><!-- raw HTML omitted -->目录中的文件和文件夹<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rm -rf emplates/*</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>deployment.yaml</code><!-- raw HTML omitted -->文件，内容如下<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo cat &gt;&gt;deployment.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: apps/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Deployment
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     app: {{ .Values.label }} 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> name: {{ .Release.Name }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> replicas: {{ .Values.replicas }} 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> selector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     matchLabels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         app: {{ .Values.label }} 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> strategy: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> template:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">             app: {{ .Values.label }} 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - image: {{ .Values.image }}:{{ .Values.tag }} 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          name: {{ .Values.image }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="6">
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>service.yaml</code><!-- raw HTML omitted -->文件，内容如下：<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo cat &gt;&gt;service.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion:   v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Service
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     app: {{ .Values.label }} 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> name:  {{ .Release.Name }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> ports:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        -  port: {{ .Values.serviceport }} 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">           protocol: TCP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">           targetPort: {{ .Values.targetport }} 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    selector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        app: {{ .Values.label }} 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    type: NodePort
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="7">
<li><!-- raw HTML omitted -->切换到<!-- raw HTML omitted --><code>chart</code><!-- raw HTML omitted -->目录的上一层目录、并且安装<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd ~
</span></span><span style="display:flex;"><span>$ helm install nginx nginx/</span></span></code></pre></div></blockquote>
<hr>
<h3 id="font-colorred调试font"><!-- raw HTML omitted -->调试<!-- raw HTML omitted --></h3>
<ul>
<li>
<ol>
<li><code>Helm</code>也提供了<code>--dry-run</code>和<code>--debug</code>调试参数，帮助你验证模板的正确性。在执行<code>helm install</code>的时候带上这两个参数就可以把对应的<code>values</code>值和渲染的资源清单打印出来，而不是真正的做部署一个<code>release</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm install nginx nginx/ --dry-run --debug</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->一些常用的内置对象：<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>内置对象</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Release.Name</code></td>
<td><code>release</code>的名称</td>
</tr>
<tr>
<td><code>Release.Namespace</code></td>
<td><code>release</code>的命名空间</td>
</tr>
<tr>
<td><code>Release.Service</code></td>
<td><code>release</code>的服务的名称</td>
</tr>
<tr>
<td><code>Release.Revision</code></td>
<td><code>release</code>的修订版本号，从1开始累加</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h3 id="font-colorredvaluesfont"><!-- raw HTML omitted --><code>Values</code><!-- raw HTML omitted --></h3>
<ul>
<li>
<ol>
<li><code>Values</code>对象是为<code>Chart</code>模板提供值，这个对象的值有<code>4</code>个来源：</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>chart</code>包中的<code>values.yaml</code>文件</li>
<li>父<code>chart</code>包的<code>values.yaml</code>文件</li>
<li>通过<code>helm install</code>或者<code>helm upgrade</code>的<code>-f</code>或者<code>--values</code>参数传入的自定义的<code>yaml</code>文件</li>
<li>通过<code>--set</code>参数传入的值</li>
</ul>
</blockquote>
<ul>
<li>
<ol start="2">
<li><code>Chart</code>的<code>values.yaml</code>提供的值可以被用户提供的<code>values</code>文件覆盖，而该文件同样可以被<code>--set</code>参数所覆盖，换言之，<code>--set</code>参数的优先级高</li>
</ol>
</li>
</ul>
<hr>
<h2 id="升级回滚和卸载发行版本">升级、回滚和卸载发行版本</h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->升级<!-- raw HTML omitted -->发布新版本的<code>chart</code>时，或者当我们需要更改发布的配置，可以使用<code>helm upgrade</code>命令</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm upgrade --set imageTag<span style="color:#f92672">=</span>1.18 nginx nginx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ helm upgrade web mychart  <span style="color:#75715e"># web:自定义名称，chart名称</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ helm upgrade -f values.yaml nginx nginx</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->回滚<!-- raw HTML omitted -->如果在发布后没有达到预期的效果，则可以使用<code>helm rollback</code>回滚到之前的版本</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm history redis -n default  	<span style="color:#75715e"># 查看历史版本</span>
</span></span><span style="display:flex;"><span>$ helm rollback nginx <span style="color:#ae81ff">1</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->卸载<!-- raw HTML omitted -->可以使用<code>helm uninstall</code>命令</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm uninstall nginx</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted --> 查看历史版本配置信息<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm get all --revision <span style="color:#ae81ff">1</span> nginx</span></span></code></pre></div></blockquote>
<hr>
<h2 id="管道函数">管道、函数</h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->管道<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>quote</code>  <code>.Values.label.app</code><!-- raw HTML omitted -->将后面的值作为参数传递过<!-- raw HTML omitted --><code>quote</code><!-- raw HTML omitted -->函数<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->模板函数调用语法为：<!-- raw HTML omitted --><code>functionName arg1 arg2...</code></li>
<li>在上面的案例中，其实是将值传递给模板引擎进行渲染，模板引擎还支持对拿到的数据进行二次处理，示例：从<code>.Values</code>中读取的值变成字符串，可以使用<code>quote</code>函数实现</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat templates/deployment.yaml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 略...</span>
</span></span><span style="display:flex;"><span>app: <span style="color:#f92672">{{</span> quote  .Values.label.app    <span style="color:#f92672">}}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 略...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ helm install --dry-run nginx ../nginx/ app:<span style="color:#e6db74">&#34;nginx&#34;</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->函数<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>default</code><!-- raw HTML omitted -->函数运行在模板中指定默认值，以防止该值会忽略掉。如果忘记定义，执行<!-- raw HTML omitted --><code>helm install</code><!-- raw HTML omitted -->的时候会因为缺少字段而无法创建资源，这时就可以定义一个默认值了，示例：<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo cat &gt;&gt;templates/deployment.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: apps/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Deployment
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        app: {{ .Values.label }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: {{ .Release.Name }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    replicas: {{ .Values.replicas }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    selector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        matchLabels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            app: {{ .Values.label }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    strategy: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    template:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                app: {{ .Values.label }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            - image: {{ .Values.image| default &#34;nginx&#34; }}:{{ .Values.tag }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              name: {{ .Values.image }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->缩进函数：<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>{{ <span style="color:#ae81ff">.Values.resources | indent 12 }}</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->大写函数<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>{{ <span style="color:#ae81ff">upper .Values.resources }}</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->首字母大写函数<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>{{ <span style="color:#ae81ff">title .Values.resources }}</span></span></span></code></pre></div></blockquote>
<hr>
<h2 id="流程控制">流程控制</h2>
<ul>
<li>
<ol>
<li>流程控制是为模板提供了一种能力，满足更复杂的数据逻辑处理</li>
</ol>
</li>
<li>
<ol start="2">
<li><code>Helm</code>模板语言提供以下流程控制语句：</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>if/else</code><!-- raw HTML omitted -->条件块<!-- raw HTML omitted --></li>
<li><code>with</code><!-- raw HTML omitted -->指定范围<!-- raw HTML omitted --></li>
<li><code>range</code><!-- raw HTML omitted -->循环块<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li>
<ol start="3">
<li><code>if/else</code><!-- raw HTML omitted -->：块是用于在模板有条件的包含文本块的方法<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->条件判断：<!-- raw HTML omitted -->就是判断条件是否为真，如果值为以下几种情况则为<code>false</code>，否则为<code>true</code>：</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->一个布尔类型的<!-- raw HTML omitted --><code>false</code></li>
<li><!-- raw HTML omitted -->一个数字<!-- raw HTML omitted --><code>0</code></li>
<li><!-- raw HTML omitted -->一个空的字符串<!-- raw HTML omitted --></li>
<li>一个空的集合(<code>map</code>、<code>slice</code>、<code>tuple</code>、<code>dict</code>、<code>array</code>)</li>
</ul>
</blockquote>
<ul>
<li>还可以使用<code>ne</code>、<code>lt</code>、<code>gt</code>、<code>and</code>、<code>or</code>等运算符</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>{{ <span style="color:#ae81ff">if 条件表达式 }}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># xxx</span>
</span></span><span style="display:flex;"><span>{{ <span style="color:#ae81ff">else if 条件表达式 }}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># xxx</span>
</span></span><span style="display:flex;"><span>{{ <span style="color:#ae81ff">else }}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># xxx</span>
</span></span><span style="display:flex;"><span>{{ <span style="color:#ae81ff">end }}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 示例</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: {{ <span style="color:#ae81ff">.Values.label }}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: {{ <span style="color:#ae81ff">.Release.Name }}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">replicas</span>: {{ <span style="color:#ae81ff">.Values.replicas }}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">app</span>: {{ <span style="color:#ae81ff">.Values.label }}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">strategy</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">app</span>: {{ <span style="color:#ae81ff">.Values.label }}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">image</span>: {{ <span style="color:#ae81ff">.Values.image| default &#34;nginx&#34; }}:{{ .Values.tag }}</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">name</span>: {{ <span style="color:#ae81ff">.Values.image }}</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>                  {{ <span style="color:#ae81ff">if eq .Values.devops &#34;k8s&#34; }}</span>
</span></span><span style="display:flex;"><span>              - <span style="color:#f92672">name </span>: <span style="color:#ae81ff">hello</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;123&#34;</span>
</span></span><span style="display:flex;"><span>                {{ <span style="color:#ae81ff">else }}</span>
</span></span><span style="display:flex;"><span>              - <span style="color:#f92672">name </span>: <span style="color:#ae81ff">hello</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;456&#34;</span>
</span></span><span style="display:flex;"><span>                {{ <span style="color:#ae81ff">end }}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 模板引擎渲染一下，会得到如下的结果：</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">$ helm install --dry-run nginx nginx</span></span></span></code></pre></div><ul>
<li>可以看到渲染出来会有多余的空行，这是因为当模板引擎运行的时候，会将控制指令删除，所以之前占的位置也就空白了，需要使用<code>{{- if ...}}</code>的方式消除此空行</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: {{ <span style="color:#ae81ff">.Values.label }}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: {{ <span style="color:#ae81ff">.Release.Name }}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">replicas</span>: {{ <span style="color:#ae81ff">.Values.replicas }}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">app</span>: {{ <span style="color:#ae81ff">.Values.label }}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">strategy</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">app</span>: {{ <span style="color:#ae81ff">.Values.label }}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>                - <span style="color:#f92672">image</span>: {{ <span style="color:#ae81ff">.Values.image| default &#34;nginx&#34; }}:{{ .Values.tag }}</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">name</span>: {{ <span style="color:#ae81ff">.Values.image }}</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>                      {{- <span style="color:#ae81ff">if eq .Values.devops &#34;k8s&#34; }}</span>
</span></span><span style="display:flex;"><span>                - <span style="color:#f92672">name </span>: <span style="color:#ae81ff">hello</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;123&#34;</span>
</span></span><span style="display:flex;"><span>                  {{- <span style="color:#ae81ff">else }}</span>
</span></span><span style="display:flex;"><span>                - <span style="color:#f92672">name </span>: <span style="color:#ae81ff">hello</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;456&#34;</span>
</span></span><span style="display:flex;"><span>                  {{- <span style="color:#ae81ff">end }}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 通过模板引擎渲染，会得到如下的结果</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">$ helm install --dry-run nginx nginx</span></span></span></code></pre></div><ul>
<li>如果使用<code>{{- if ... -}}</code>那么就需要谨慎，比如：</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: {{ <span style="color:#ae81ff">.Values.label }}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: {{ <span style="color:#ae81ff">.Release.Name }}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">replicas</span>: {{ <span style="color:#ae81ff">.Values.replicas }}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">app</span>: {{ <span style="color:#ae81ff">.Values.label }}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">strategy</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">app</span>: {{ <span style="color:#ae81ff">.Values.label }}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>                - <span style="color:#f92672">image</span>: {{ <span style="color:#ae81ff">.Values.image| default &#34;nginx&#34; }}:{{ .Values.tag }}</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">name</span>: {{ <span style="color:#ae81ff">.Values.image }}</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>                      {{- <span style="color:#ae81ff">if eq .Values.devops &#34;k8s&#34; -}}</span>
</span></span><span style="display:flex;"><span>                  - <span style="color:#f92672">name </span>: <span style="color:#ae81ff">hello</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;123&#34;</span>
</span></span><span style="display:flex;"><span>                    {{- <span style="color:#ae81ff">else }}</span>
</span></span><span style="display:flex;"><span>                  - <span style="color:#f92672">name </span>: <span style="color:#ae81ff">hello</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;456&#34;</span>
</span></span><span style="display:flex;"><span>                    {{- <span style="color:#ae81ff">end }}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 通过模板引擎渲染，会得到如下的结果：</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">$ helm install --dry-run nginx nginx</span></span></span></code></pre></div><ul>
<li>相当于下面这种格式</li>
</ul>
<blockquote>
<ul>
<li>当然不对，因为<code>{{- if ... -}}</code>删除了双方的换行符</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">NAME</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">LAST DEPLOYED</span>: <span style="color:#ae81ff">Mon Jan 11 20:46:10 2021</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">NAMESPACE</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">STATUS</span>: <span style="color:#ae81ff">pending-install</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">REVISION</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">TEST SUITE</span>: <span style="color:#ae81ff">None</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">HOOKS</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">MANIFEST</span>:
</span></span><span style="display:flex;"><span>---  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Source: nginx/templates/service.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>:   <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>:  <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>: 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        -  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span> 
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">80</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">NodePort</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Source: nginx/templates/deployment.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">strategy</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>                - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">env: - name: hello value</span>: <span style="color:#ae81ff">123</span></span></span></code></pre></div></blockquote>
</blockquote>
<ul>
<li>
<ol start="4">
<li><code>range</code><!-- raw HTML omitted -->循环块<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>在<code>Helm</code>模板语言中，使用<code>range</code>关键字来进行循环操作</li>
<li>在<code>values.yaml</code>中添加一个变量列表：</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">test</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">1</span> 
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">2</span> 
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">3</span></span></span></code></pre></div><ul>
<li>4.3 循环打印该列表：</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1 </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ConfigMap </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>:    {{   <span style="color:#ae81ff">.Release.Name    }} </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">data</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">test</span>:    
</span></span><span style="display:flex;"><span>        {{- <span style="color:#ae81ff">range . Values.test }}</span>
</span></span><span style="display:flex;"><span>            {{   <span style="color:#ae81ff">.    }}</span>
</span></span><span style="display:flex;"><span>        {{-   <span style="color:#ae81ff">end   }}</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><code>with</code><!-- raw HTML omitted -->指定范围<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>with</code><!-- raw HTML omitted -->可以用来控制变量作用域<!-- raw HTML omitted --></li>
<li>前面我们使用<code>{{ .Release.xxx }}</code>或者<code>{{ .Values.xxx }}</code>，其中.就是表示对当前范围的引用，<code>.values</code>就是告诉模板在当前范围中查找Values对象的值</li>
<li><code>with</code><!-- raw HTML omitted -->语句就可以用来控制变量的作用域范围，其语法和一个简单的if语句类似：<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>{{ <span style="color:#ae81ff">with 条件表达式 }}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># xxx</span>
</span></span><span style="display:flex;"><span>{{ <span style="color:#ae81ff">end }}</span></span></span></code></pre></div><ul>
<li><code>with</code><!-- raw HTML omitted -->语句可以允许将当前范围的.设置为特定的对象，比如我们前面一直使用的<code>.Values.label</code>，我们可以使用with来将.范围指向<!-- raw HTML omitted --><code>.Values.label</code>示例：<code>values.yaml</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">nodeSelector</span>: 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">team</span>: <span style="color:#ae81ff">a </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">gpu</span>:   <span style="color:#66d9ef">yes</span></span></span></code></pre></div><ul>
<li><code>deployment.yaml</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>:   <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>:   <span style="color:#ae81ff">Deployment </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: {{ <span style="color:#ae81ff">.Release.Name }}-deployment </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">matchLabels</span>: 
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">template</span>: 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">labels</span>: 
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>            {{- <span style="color:#ae81ff">with .Values.nodeSelector }}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">nodeSelector</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">team</span>: {{  <span style="color:#ae81ff">.team }}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">gpu</span>: {{  <span style="color:#ae81ff">.gpu  }}</span>
</span></span><span style="display:flex;"><span>            {{- <span style="color:#ae81ff">end }}</span></span></span></code></pre></div></blockquote>
<hr>
<h2 id="命名模板">命名模板</h2>
<ul>
<li>
<ol>
<li>需要复用代码的地方可以使用命名模板</li>
</ol>
</li>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->命名模板：<!-- raw HTML omitted -->使用<code>define</code>定义，<code>template</code>引入，在<code>templates</code>目录中默认下划线开头的文件为公共模板,比如：<code>_helpers.tpl</code>。</li>
</ol>
</li>
<li>
<ol start="3">
<li>示例：<code> _helpers.tpl</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>{{-   <span style="color:#ae81ff">define   &#34;demo.fullname&#34;   -}}</span>
</span></span><span style="display:flex;"><span>{{- <span style="color:#ae81ff">.Chart.Name -}}-{{ .Release.Name }}</span>
</span></span><span style="display:flex;"><span>{{-   <span style="color:#ae81ff">end   -}}</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><code>deployment.yaml</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>:   <span style="color:#ae81ff">apps/v1 </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>:   <span style="color:#ae81ff">Deployment </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">name</span>:  {{   <span style="color:#ae81ff">template&#34;demo.fullname&#34;   .    }}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 其他略</span></span></span></code></pre></div><ul>
<li><code>template</code><!-- raw HTML omitted -->指令是将一个模板包含在另一个模板中的方法。但是，<code>template</code>函数不能用于<code>Go</code>模板管道，为了解决该问题，增加了<code>include</code>功能<!-- raw HTML omitted --></li>
<li><code>_helpers.tpl：</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>{{-   <span style="color:#ae81ff">define   &#34;demo.labels&#34;    -}}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">app</span>:   {{   <span style="color:#ae81ff">template&#34;demo.fullname&#34;   .   }}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">chart</span>:   <span style="color:#e6db74">&#34;{{   .Chart.Name   }}-{{    .Chart.Version   }}&#34;</span> 
</span></span><span style="display:flex;"><span><span style="color:#f92672">release</span>:   <span style="color:#e6db74">&#34;{{   .Release.Name   }}&#34;</span>
</span></span><span style="display:flex;"><span>{{-   <span style="color:#ae81ff">end   -}}</span></span></span></code></pre></div><ul>
<li>4.3 <code>deployment.yaml</code></li>
</ul>
<blockquote>
<p>下面包含一个名为<code>demo.labels</code>的模板，然后将值  . 传递给模板，最后将该模板的 输出传递给<code>nindent</code>函数。</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>:   <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>:   <span style="color:#ae81ff">Deployment </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">name</span>:    {{   <span style="color:#ae81ff">include&#34;demo.fullname&#34;   .    }} </span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        {{-   <span style="color:#ae81ff">include   &#34;demo.labels&#34;   .    |   nindent   4    }}</span>
</span></span><span style="display:flex;"><span>...</span></span></code></pre></div></blockquote>
</blockquote>

<pre class="mermaid align-center zoomable">graph LR
A(创建模板) --&gt;B(修改Chart.yaml Values.yaml文件&lt;br&gt;添加常用变量&lt;br&gt;)
    B --&gt; C(在Templates目录下创建部署镜像所需的yaml文件&lt;br&gt;并且使用变量&lt;br&gt;引用yaml文件里面的常变动字段&lt;br&gt;)
    
    C --&gt;|a=1| D{暂未启用}
    C --&gt;|a=2| E[暂未启用]
    F[开发自己的chart]</pre><hr>
<h2 id="使用helm安装jenkins">使用<code>Helm</code>安装<code>Jenkins</code></h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->获取更新仓库信息<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm repo add jenkins https://charts.jenkins.io
</span></span><span style="display:flex;"><span>$ helm repo update</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->查看已经添加的<!-- raw HTML omitted --><code>helm</code><!-- raw HTML omitted -->仓库<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm repo list</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->搜索仓库中的<!-- raw HTML omitted --><code>Jenkins</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm search repo jenkins
</span></span><span style="display:flex;"><span>NAME           	CHART VERSION	APP VERSION	DESCRIPTION                                       
</span></span><span style="display:flex;"><span>jenkins/jenkins	4.2.5        	2.361.1    	Jenkins - Build great things at any scale! The ...</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted --> 查看、下载<!-- raw HTML omitted --><code>Jenkins</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm show values jenkins/jenkins
</span></span><span style="display:flex;"><span>$ helm pull jenkins/jenkins  	<span style="color:#75715e"># 下载 Jenkins 安装包</span>
</span></span><span style="display:flex;"><span>$ tar -zxvf jenkins-3.5.9.tgz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sed -i -e <span style="color:#e6db74">&#39;/#/d;/^$/d&#39;</span> values.yaml  	<span style="color:#75715e"># 去掉注释和空行后修改</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->安装以及查看登录名和密码<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm install jenkins ./jenkins
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看登录的用户名</span>
</span></span><span style="display:flex;"><span>$  kubectl exec jenkins-0 -- cat /run/secrets/chart-admin-username
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看登录的密码</span>
</span></span><span style="display:flex;"><span>$  kubectl exec jenkins-0 -- cat /run/secrets/chart-admin-password</span></span></code></pre></div></blockquote>
<hr>
<h2 id="使用helm安装redis">使用<code>Helm</code>安装<code>Redis</code></h2>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->添加<!-- raw HTML omitted --><code>Bitnami</code><!-- raw HTML omitted -->仓库<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm repo add bitnami https://charts.bitnami.com/bitnami
</span></span><span style="display:flex;"><span>$ helm repo list
</span></span><span style="display:flex;"><span>$ helm search repo redis</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->下载、配置安装包<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm pull bitnami/redis
</span></span><span style="display:flex;"><span>$ tar xvf redis-18.8.0.tgz</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>values.yaml</code></li>
</ul>
<blockquote>
<ul>
<li><code>StorageClass</code><!-- raw HTML omitted -->的名字，如果<!-- raw HTML omitted --><code>storageClass</code><!-- raw HTML omitted -->不正常，<!-- raw HTML omitted --><code>redis</code><!-- raw HTML omitted -->启动不了<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">imageRegistry</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">imagePullSecrets</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">storageClass</span>: <span style="color:#e6db74">&#34;nfs-storage-template&#34;</span>    <span style="color:#75715e"># StorageClass 的名字，如果storageClass不正常，redis启动不了</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">redis</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">password</span>: <span style="color:#e6db74">&#34;Password&#34;</span>    <span style="color:#75715e"># redis 连接密码</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kubeVersion</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">nameOverride</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">fullnameOverride</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">namespaceOverride</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">commonLabels</span>: {}
</span></span><span style="display:flex;"><span><span style="color:#f92672">commonAnnotations</span>: {}
</span></span><span style="display:flex;"><span><span style="color:#f92672">secretAnnotations</span>: {}
</span></span><span style="display:flex;"><span><span style="color:#f92672">clusterDomain</span>: <span style="color:#ae81ff">cluster.local</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">extraDeploy</span>: []
</span></span><span style="display:flex;"><span><span style="color:#f92672">useHostnames</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">nameResolutionThreshold</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">nameResolutionTimeout</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">diagnosticMode</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">command</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">sleep</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">args</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">infinity</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">image</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">registry</span>: <span style="color:#ae81ff">docker.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">repository</span>: <span style="color:#ae81ff">bitnami/redis</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tag</span>: <span style="color:#ae81ff">7.2.4</span>-<span style="color:#ae81ff">debian-11-r2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">digest</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">pullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">pullSecrets</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">debug</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">architecture</span>: <span style="color:#ae81ff">replication  </span> <span style="color:#75715e"># standalone:单节点部署，replication：一主三从配置</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">auth</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">sentinel</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">password</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">existingSecret</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">existingSecretPasswordKey</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">usePasswordFiles</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">commonConfiguration</span>: |-<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  appendonly yes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  save &#34;&#34;</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">existingConfigmap</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">master</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">count</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">configuration</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">disableCommands</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">FLUSHDB</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">FLUSHALL</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">command</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">args</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enableServiceLinks</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">preExecCmds</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraFlags</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraEnvVars</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraEnvVarsCM</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraEnvVarsSecret</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containerPorts</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">redis</span>: <span style="color:#ae81ff">6379</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">startupProbe</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">livenessProbe</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">readinessProbe</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">customStartupProbe</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">customLivenessProbe</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">customReadinessProbe</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">limits</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">requests</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podSecurityContext</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">fsGroupChangePolicy</span>: <span style="color:#ae81ff">Always</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sysctls</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">supplementalGroups</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">fsGroup</span>: <span style="color:#ae81ff">1001</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containerSecurityContext</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">seLinuxOptions</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">runAsUser</span>: <span style="color:#ae81ff">1001</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">runAsGroup</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">runAsNonRoot</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">allowPrivilegeEscalation</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">seccompProfile</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RuntimeDefault</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">capabilities</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">drop</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">ALL</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">StatefulSet</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">schedulerName</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">updateStrategy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">minReadySeconds</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">priorityClassName</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">automountServiceAccountToken</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hostAliases</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podLabels</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podAnnotations</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">shareProcessNamespace</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podAffinityPreset</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podAntiAffinityPreset</span>: <span style="color:#ae81ff">soft</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nodeAffinityPreset</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">key</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">values</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">affinity</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nodeSelector</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tolerations</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">topologySpreadConstraints</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">dnsPolicy</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">dnsConfig</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">lifecycleHooks</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraVolumes</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraVolumeMounts</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">sidecars</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">initContainers</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">persistence</span>:    <span style="color:#75715e"># 持久化配置</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>   <span style="color:#75715e"># 默认启用</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">medium</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sizeLimit</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/data  </span> <span style="color:#75715e"># 存储目录</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">subPath</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">subPathExpr</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">storageClass</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">accessModes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">ReadWriteOnce</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">size</span>: <span style="color:#ae81ff">2Gi  </span> <span style="color:#75715e"># Master 主节点默认使用空间</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">selector</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">dataSource</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">existingClaim</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">persistentVolumeClaimRetentionPolicy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">whenScaled</span>: <span style="color:#ae81ff">Retain</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">whenDeleted</span>: <span style="color:#ae81ff">Retain</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">service</span>:    <span style="color:#75715e"># 服务端口配置</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">redis</span>: <span style="color:#ae81ff">6379</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nodePorts</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">redis</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">externalTrafficPolicy</span>: <span style="color:#ae81ff">Cluster</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">extraPorts</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">internalTrafficPolicy</span>: <span style="color:#ae81ff">Cluster</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">clusterIP</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">loadBalancerIP</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">loadBalancerClass</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">loadBalancerSourceRanges</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">externalIPs</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sessionAffinity</span>: <span style="color:#ae81ff">None</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sessionAffinityConfig</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">terminationGracePeriodSeconds</span>: <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">serviceAccount</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">create</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">automountServiceAccountToken</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>: {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">replica</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">StatefulSet</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicaCount</span>: <span style="color:#ae81ff">2</span>  	<span style="color:#75715e"># 从节点副本数量</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">configuration</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">disableCommands</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">FLUSHDB</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">FLUSHALL</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">command</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">args</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enableServiceLinks</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">preExecCmds</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraFlags</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraEnvVars</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraEnvVarsCM</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraEnvVarsSecret</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">externalMaster</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">host</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">6379</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containerPorts</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">redis</span>: <span style="color:#ae81ff">6379</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">startupProbe</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">22</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">livenessProbe</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">readinessProbe</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">customStartupProbe</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">customLivenessProbe</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">customReadinessProbe</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">limits</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   cpu: 250m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   memory: 256Mi</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">requests</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   cpu: 250m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   memory: 256Mi</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podSecurityContext</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">fsGroupChangePolicy</span>: <span style="color:#ae81ff">Always</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sysctls</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">supplementalGroups</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">fsGroup</span>: <span style="color:#ae81ff">1001</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containerSecurityContext</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">seLinuxOptions</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">runAsUser</span>: <span style="color:#ae81ff">1001</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">runAsGroup</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">runAsNonRoot</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">allowPrivilegeEscalation</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">seccompProfile</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RuntimeDefault</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">capabilities</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">drop</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">ALL</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">schedulerName</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">updateStrategy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">minReadySeconds</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">priorityClassName</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podManagementPolicy</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">automountServiceAccountToken</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hostAliases</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podLabels</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podAnnotations</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">shareProcessNamespace</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podAffinityPreset</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podAntiAffinityPreset</span>: <span style="color:#ae81ff">soft</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nodeAffinityPreset</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">key</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">values</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">affinity</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nodeSelector</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tolerations</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">topologySpreadConstraints</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">dnsPolicy</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">dnsConfig</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">lifecycleHooks</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraVolumes</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraVolumeMounts</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">sidecars</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">initContainers</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">persistence</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">medium</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sizeLimit</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/data</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">subPath</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">subPathExpr</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">storageClass</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">accessModes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">ReadWriteOnce</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">size</span>: <span style="color:#ae81ff">2Gi  	# 从节点使用磁盘空间</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">selector</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">dataSource</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">existingClaim</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">persistentVolumeClaimRetentionPolicy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">whenScaled</span>: <span style="color:#ae81ff">Retain</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">whenDeleted</span>: <span style="color:#ae81ff">Retain</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">redis</span>: <span style="color:#ae81ff">6379</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nodePorts</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">redis</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">externalTrafficPolicy</span>: <span style="color:#ae81ff">Cluster</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">internalTrafficPolicy</span>: <span style="color:#ae81ff">Cluster</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">extraPorts</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">clusterIP</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">loadBalancerIP</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">loadBalancerClass</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">loadBalancerSourceRanges</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sessionAffinity</span>: <span style="color:#ae81ff">None</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sessionAffinityConfig</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">terminationGracePeriodSeconds</span>: <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">autoscaling</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">minReplicas</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">maxReplicas</span>: <span style="color:#ae81ff">11</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetCPU</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetMemory</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">serviceAccount</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">create</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">automountServiceAccountToken</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>: {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">sentinel</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">image</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">registry</span>: <span style="color:#ae81ff">docker.io</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">repository</span>: <span style="color:#ae81ff">bitnami/redis-sentinel</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tag</span>: <span style="color:#ae81ff">7.2.4</span>-<span style="color:#ae81ff">debian-11-r3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">digest</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">pullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">pullSecrets</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">debug</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">annotations</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">masterSet</span>: <span style="color:#ae81ff">mymaster</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">quorum</span>: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">getMasterTimeout</span>: <span style="color:#ae81ff">90</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">automateClusterRecovery</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">redisShutdownWaitFailover</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">downAfterMilliseconds</span>: <span style="color:#ae81ff">60000</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">failoverTimeout</span>: <span style="color:#ae81ff">180000</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">parallelSyncs</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">configuration</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">command</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">args</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enableServiceLinks</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">preExecCmds</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraEnvVars</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraEnvVarsCM</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraEnvVarsSecret</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">externalMaster</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">host</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">6379</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containerPorts</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sentinel</span>: <span style="color:#ae81ff">26379</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">startupProbe</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">22</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">livenessProbe</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">readinessProbe</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">customStartupProbe</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">customLivenessProbe</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">customReadinessProbe</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">persistence</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">storageClass</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">accessModes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">ReadWriteOnce</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">size</span>: <span style="color:#ae81ff">100Mi</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">selector</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">dataSource</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">medium</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sizeLimit</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">persistentVolumeClaimRetentionPolicy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">whenScaled</span>: <span style="color:#ae81ff">Retain</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">whenDeleted</span>: <span style="color:#ae81ff">Retain</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">limits</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">requests</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containerSecurityContext</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">seLinuxOptions</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">runAsUser</span>: <span style="color:#ae81ff">1001</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">runAsGroup</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">runAsNonRoot</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">allowPrivilegeEscalation</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">seccompProfile</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RuntimeDefault</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">capabilities</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">drop</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">ALL</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">lifecycleHooks</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraVolumes</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraVolumeMounts</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">redis</span>: <span style="color:#ae81ff">6379</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">sentinel</span>: <span style="color:#ae81ff">26379</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nodePorts</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">redis</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">sentinel</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">externalTrafficPolicy</span>: <span style="color:#ae81ff">Cluster</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">extraPorts</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">clusterIP</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">loadBalancerIP</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">loadBalancerClass</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">loadBalancerSourceRanges</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sessionAffinity</span>: <span style="color:#ae81ff">None</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sessionAffinityConfig</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">headless</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">annotations</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">terminationGracePeriodSeconds</span>: <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">serviceBindings</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">networkPolicy</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">allowExternal</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraIngress</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraEgress</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ingressNSMatchLabels</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ingressNSPodMatchLabels</span>: {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">metrics</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">allowExternal</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ingressNSMatchLabels</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ingressNSPodMatchLabels</span>: {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">podSecurityPolicy</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">create</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rbac</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">create</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>: []
</span></span><span style="display:flex;"><span><span style="color:#f92672">serviceAccount</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">create</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">automountServiceAccountToken</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">annotations</span>: {}
</span></span><span style="display:flex;"><span><span style="color:#f92672">pdb</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">create</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">minAvailable</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">maxUnavailable</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">tls</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">authClients</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">autoGenerated</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">existingSecret</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">certificatesSecret</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">certFilename</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">certKeyFilename</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">certCAFilename</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">dhParamsFilename</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metrics</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">image</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">registry</span>: <span style="color:#ae81ff">docker.io</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">repository</span>: <span style="color:#ae81ff">bitnami/redis-exporter</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tag</span>: <span style="color:#ae81ff">1.56.0</span>-<span style="color:#ae81ff">debian-11-r1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">digest</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">pullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">pullSecrets</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">startupProbe</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">livenessProbe</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">readinessProbe</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">customStartupProbe</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">customLivenessProbe</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">customReadinessProbe</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">command</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">redisTargetHost</span>: <span style="color:#e6db74">&#34;localhost&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraArgs</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraEnvVars</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containerSecurityContext</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">seLinuxOptions</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">runAsUser</span>: <span style="color:#ae81ff">1001</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">runAsGroup</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">runAsNonRoot</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">allowPrivilegeEscalation</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">seccompProfile</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RuntimeDefault</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">capabilities</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">drop</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">ALL</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraVolumes</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraVolumeMounts</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">limits</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">requests</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podLabels</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podAnnotations</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">prometheus.io/scrape</span>: <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">prometheus.io/port</span>: <span style="color:#e6db74">&#34;9121&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">9121</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">externalTrafficPolicy</span>: <span style="color:#ae81ff">Cluster</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">extraPorts</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">loadBalancerIP</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">loadBalancerClass</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">loadBalancerSourceRanges</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">clusterIP</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">serviceMonitor</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">namespace</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">interval</span>: <span style="color:#ae81ff">30s</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scrapeTimeout</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabellings</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metricRelabelings</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">honorLabels</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">additionalLabels</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">podTargetLabels</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sampleLimit</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetLimit</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podMonitor</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">namespace</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">interval</span>: <span style="color:#ae81ff">30s</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scrapeTimeout</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabellings</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metricRelabelings</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">honorLabels</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">additionalLabels</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">podTargetLabels</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sampleLimit</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetLimit</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">prometheusRule</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">namespace</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">additionalLabels</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rules</span>: []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">volumePermissions</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">image</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">registry</span>: <span style="color:#ae81ff">docker.io</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">repository</span>: <span style="color:#ae81ff">bitnami/os-shell</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tag</span>: <span style="color:#ae81ff">11</span>-<span style="color:#ae81ff">debian-11-r94</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">digest</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">pullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">pullSecrets</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">limits</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">requests</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containerSecurityContext</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">seLinuxOptions</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">runAsUser</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">sysctl</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">image</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">registry</span>: <span style="color:#ae81ff">docker.io</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">repository</span>: <span style="color:#ae81ff">bitnami/os-shell</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tag</span>: <span style="color:#ae81ff">11</span>-<span style="color:#ae81ff">debian-11-r94</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">digest</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">pullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">pullSecrets</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">command</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">mountHostSys</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">limits</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">requests</span>: {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">useExternalDNS</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">suffix</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">annotationKey</span>: <span style="color:#ae81ff">external-dns.alpha.kubernetes.io/</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">additionalAnnotations</span>: {}</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>Redis</code><!-- raw HTML omitted -->形成<!-- raw HTML omitted --><code>Release</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm install release-name project-dir -n namespace
</span></span><span style="display:flex;"><span>$ helm install redis ./redis/ -n default</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->登录<!-- raw HTML omitted --><code>Redis</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl exec --tty -i redis-master-0 --namespace default -- bash
</span></span><span style="display:flex;"><span>$ kubectl exec --tty -i redis-replicas-1 --namespace default -- bash</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->升级<!-- raw HTML omitted --><code>Redis</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm upgrade redis ./redis/ -n default</span></span></code></pre></div></blockquote>
<hr>
<h2 id="使用helm安装prometheus">使用<code>Helm</code>安装<code>Prometheus</code></h2>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/prometheus-operator/kube-prometheus" rel="external" target="_self"><code>kube-prometheus</code></a></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h2 id="使用helm安装elk">使用<code>Helm</code>安装<code>ELK</code></h2>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="configure_k8s_auth">Configure_K8s_Auth</h1>

<h2 id="安全控制">安全控制</h2>
<h3 id="访问控制">访问控制</h3>
<ul>
<li>
<ol>
<li><code>kubernetes</code>作为一个分布式集群的管理工具，保证集群的安全性是其一个重要的任务。所谓的安全性其实就是保证对<code>kubernetes</code>的各种客户端进行认证和授权操作</li>
</ol>
</li>
<li>
<ol start="2">
<li>在<code>kubernetes</code>集群中，客户端通常由两类：</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>User Account</code><!-- raw HTML omitted -->：一般是独立于<!-- raw HTML omitted --><code>kubernetes</code><!-- raw HTML omitted -->之外的其他服务管理的用户账号<!-- raw HTML omitted --></li>
<li><code>Service Account</code>：<code>kubernetes</code><!-- raw HTML omitted -->管理的账号，用于为<!-- raw HTML omitted --><code>Pod</code><!-- raw HTML omitted -->的服务进程在访问<!-- raw HTML omitted --><code>kubernetes</code><!-- raw HTML omitted -->时提供身份标识<!-- raw HTML omitted --></li>
</ul>

<pre class="mermaid align-center zoomable">graph LR
C1((用户)) --&gt; B1(User&lt;br&gt;Account) --&gt; A((Kubernetes))
C2((Pod)) --&gt; B2(Service&lt;br&gt;Account) --&gt; A((Kubernetes))</pre></blockquote>
<hr>
<h3 id="认证授权和准入控制">认证、授权和准入控制</h3>
<ul>
<li>
<ol>
<li><code>API Server</code><!-- raw HTML omitted -->是访问和管理资源对象的唯一入口。任何一个请求访问<!-- raw HTML omitted --><code>API Server</code>，<!-- raw HTML omitted -->都要经过下面的三个流程：<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>Authentication</code>(认证)<!-- raw HTML omitted -->：身份鉴别，只有正确的账号才能通过认证<!-- raw HTML omitted --></li>
<li><code>Authorization</code>(授权)<!-- raw HTML omitted -->：权限鉴别，判断用户是否有权限对访问的资源执行特定的动作<!-- raw HTML omitted --></li>
<li><code>Admission Control</code>(准入控制)<!-- raw HTML omitted -->：精细访问控制，用于补充授权机制以实现更加精细的访问控制功能<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->需要注意：<!-- raw HTML omitted -->在<code>Kubernetes</code>中不能通过<code>API</code>调用将普通用户添加到集群中</li>
</ul>
<blockquote>
<ul>
<li>普通账户是针对（人）用户的，服务账户针对<code>Pods</code>进程</li>
<li>普通账户是全局性，在集群所有<code>namespaces</code>中，名称具有唯一性</li>
<li>通常，集群的普通账户可以与企业数据库同步，新的普通账户创建需要特殊权限，服务账户创建目的是更轻量化，允许集群用户为特定任务创建服务账户</li>
<li>普通账户和服务账户的审核注意事项不同</li>
<li>对于复杂系统的配置包，可以包括对该系统的各种组件的服务账户的定义</li>
</ul>
</blockquote>

<pre class="mermaid align-center zoomable">graph LR
A((请求)) --&gt; B[Authentication&lt;br&gt;认证&lt;br&gt;身份鉴别&lt;br&gt;] --&gt; C[Authorization&lt;br&gt;授权&lt;br&gt;权限鉴别&lt;br&gt;] --&gt; D[Admission Control&lt;br&gt;注入控制&lt;br&gt;精细访问控制&lt;br&gt;] --&gt; E((Kubernetes&lt;br&gt;资源))</pre></blockquote>
<hr>
<h4 id="认证管理">认证管理</h4>
<h5 id="user-accounts普通账户"><code>User Accounts</code>(普通账户)</h5>
<hr>
<h5 id="service-accounts服务账户"><code>Service Accounts</code>(服务账户)</h5>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount   </span> <span style="color:#75715e"># 权限管理</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span></span></span></code></pre></div></blockquote>
<hr>
<h5 id="kubernetesfont-colorred的客户端fonthttpfont-colorred和fonthttpsfont-colorred身份认证方式font"><code>kubernetes</code><!-- raw HTML omitted -->的客户端<!-- raw HTML omitted --><code>http</code><!-- raw HTML omitted -->和<!-- raw HTML omitted --><code>https</code><!-- raw HTML omitted -->身份认证方式<!-- raw HTML omitted --></h5>
<ul>
<li>
<ol>
<li><code>kubernetes</code><!-- raw HTML omitted -->允许同时配置多种认证方式，<!-- raw HTML omitted -->只要其中任意一种方式认证通过即可</li>
</ol>
</li>
<li>
<ol start="2">
<li><code>kubernetes</code>集群安全的关键点在于如何识别并认证客户端身份，它提供了<code>3</code>种客户端身份认证方式</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>2.1 <code>HTTP Base</code><!-- raw HTML omitted -->认证：<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->通过用户名+密码的方式进行认证，<!-- raw HTML omitted -->这种方式是把<code>用户名:密码</code>用<code>BASE64</code>算法进行编码后的字符串放在<code>HTTP</code>请求中的<code>Header</code>的<code>Authorization</code>域里面发送给服务端。服务端收到后进行解码，获取用户名和密码，然后进行用户身份认证的过程</li>
</ul>
</blockquote>
<ul>
<li>2.2 <code>HTTP Token</code><!-- raw HTML omitted -->认证：<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->通过一个<code>Token</code>来识别合法用户，<!-- raw HTML omitted -->这种认证方式是用一个很长的难以被模仿的字符串<code>--Token</code>来表明客户端身份的一种方式。每个<code>Token</code>对应一个用户名，当客户端发起<code>API</code>调用请求的时候，需要在<code>HTTP</code>的<code>Header</code>中放入<code>Token</code>，<code>API Server</code>接受到<code>Token</code>后会和服务器中保存的<code>Token</code>进行比对，然后进行用户身份认证的过程。</li>
</ul>
</blockquote>
<ul>
<li>2.3 <code>HTTPS</code><!-- raw HTML omitted -->证书认证： <!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->基于<code>CA</code>根证书签名的双向数字证书认证方式，<!-- raw HTML omitted -->这种认证方式是安全性最高的一种方式，但是同时也是操作起来最麻烦的一种方式</li>
<li><!-- raw HTML omitted -->证书申请和下发：<!-- raw HTML omitted --><code>HTTPS</code>通信双方的服务器向<code>CA</code>机构申请证书，<code>CA</code>机构发根证书、服务端证书及私钥给申请者</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->客户端和服务器的双向认证<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<blockquote>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->客户端向服务端发起请求，<!-- raw HTML omitted -->服务端下发自己的证书给客户端。客户端收到证书后，通过私钥解密证书，在证书中获取服务端的私钥。客户端利用服务器端的公钥认证证书中的信息，如果一致，则认可这个服务器。</li>
<li><!-- raw HTML omitted -->客户端发送自己的证书给服务器端，<!-- raw HTML omitted -->服务端接收到证书后，通过私钥解密证书。在证书中获取客户端的公钥，并用该公钥认证证书信息，确认客户端是否合法。</li>
</ul>
</blockquote>
</blockquote>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->服务器端和客户端进行通信<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<blockquote>
<blockquote>
<ul>
<li>服务器端和客户端协商好加密方案后，客户端会产生一个随机的私钥并加密，然后发送到服务器端</li>
<li>服务器端接收到这个私钥后，双方接下来通信的所有内容都通过该随机私钥加密</li>
</ul>
</blockquote>
</blockquote>

<pre class="mermaid align-center zoomable">graph TB
A((CA机构)) -- 申请证书 --&gt;B((服务端))
A((CA机构)) -- 申请证书 --&gt; C((客户端))
B((服务端)) -- 下发证书 --&gt; A((CA机构))
C((客户端)) -- 下发证书 --&gt; A((CA机构))

B((服务端)) &lt;-- 双向身份认证 --&gt; C((客户端))
B((服务端)) &lt;-- 双向通信 --&gt; C((客户端))</pre></blockquote>
<hr>
<h4 id="授权管理">授权管理</h4>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->授权发生在认证成功之后，<!-- raw HTML omitted -->通过认证就可以知道请求用户是谁，然后<code>kubernetes</code>会根据事先定义的授权策略来决定用户是否有权限访问，这个过程就称为授权</li>
</ol>
</li>
<li>
<ol start="2">
<li>每个发送到<code>API Server</code>的请求都带上了用户和资源的信息：比如发送请求的用户、请求的路径、请求的动作等，授权就是根据这些信息和授权策略进行比较，如果符合策略，则认为授权通过，否则会返回错误。</li>
</ol>
</li>
<li>
<ol start="3">
<li><code>API Server</code>目前支持的几种授权策略</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>AlwaysDeny</code><!-- raw HTML omitted -->：表示拒绝所有请求，一般用于测试<!-- raw HTML omitted --></li>
<li><code>AlwaysAllow</code><!-- raw HTML omitted -->：允许接收所有的请求，相当于集群不需要授权流程（<code>kubernetes</code>默认的策略）<!-- raw HTML omitted --></li>
<li><code>ABAC</code><!-- raw HTML omitted -->：基于属性的访问控制，表示使用用户配置的授权规则对用户请求进行匹配和控制<!-- raw HTML omitted --></li>
<li><code>Webhook</code><!-- raw HTML omitted -->：通过调用外部<code>REST</code>服务对用户进行授权<!-- raw HTML omitted --></li>
<li><code>Node</code><!-- raw HTML omitted -->：是一种专用模式，用于对<code>kubelet</code>发出的请求进行访问控制<!-- raw HTML omitted --></li>
<li><code>RBAC</code><!-- raw HTML omitted -->：基于角色的访问控制（<code>kubeadm</code>安装方式下的默认选项）<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<hr>
<h5 id="rbac基于角色的访问控制"><code>RBAC</code>基于角色的访问控制</h5>
<blockquote>
<ul>
<li><code>RBAC</code><!-- raw HTML omitted -->基于角色的访问控制<!-- raw HTML omitted -->(<code>Role Based Access Control</code>)<!-- raw HTML omitted -->主要是在描述一件事情：给哪些对象授权了哪些权限<!-- raw HTML omitted --></li>
<li><code>RBAC</code>涉及到了下面几个概念：</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->对象：<!-- raw HTML omitted --><code>User</code>、<code>Groups</code>、<code>ServiceAccount</code>。</li>
<li><!-- raw HTML omitted -->角色：<!-- raw HTML omitted -->代表着一组定义在资源上的可操作的动作（权限）的集合</li>
<li><!-- raw HTML omitted -->绑定：<!-- raw HTML omitted -->将定义好的角色和用户绑定在一起</li>
</ul>
</blockquote>
<ul>
<li><code>RBAC</code>引入的<code>4</code>个顶级资源对象：</li>
</ul>
<blockquote>
<ul>
<li><code>Role</code>(角色)<!-- raw HTML omitted -->，用于指定一组权限<!-- raw HTML omitted --></li>
<li><code>ClusterRole</code>(集群角色)<!-- raw HTML omitted -->，用于指定一组权限<!-- raw HTML omitted --></li>
<li><code>RoleBinding</code>(角色绑定)<!-- raw HTML omitted -->，用于将角色（权限的集合）赋予给对象<!-- raw HTML omitted --></li>
<li><code>ClusterRoleBinding</code>(集群角色绑定)<!-- raw HTML omitted -->，用于将角色（权限的集合）赋予给对象<!-- raw HTML omitted --></li>
</ul>
</blockquote>

<pre class="mermaid align-center zoomable">graph TB
A1(Group) --- A[RoleBinding]
A2(User) --- A[RoleBinding]
A3(Service&lt;br&gt;Account) --- A[RoleBinding]

A[RoleBinding] --- B[Role]

B[Role] --- Pod --- |a=1|B1[List]
B[Role] --- Pod --- |a=2|B2[Get]
B[Role] --- Pod --- |a=3|B3[Watch]

B[Role] --- Deployment --- |b=1|B4[List]
B[Role] --- Deployment --- |b=2|B5[Get]
B[Role] --- Deployment --- |b=3|B6[Watch]</pre></blockquote>
<hr>
<h5 id="role普通角色"><code>Role</code>(普通角色)</h5>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->一个角色就是一组权限的集合，这里的权限都是许可形式的（白名单）<!-- raw HTML omitted --></li>
<li><code>Role</code><!-- raw HTML omitted -->只能对命名空间的资源进行授权，需要指定<!-- raw HTML omitted --><code>namespace</code></li>
</ul>
</blockquote>
<ul>
<li>
<ol>
<li><code>rules:</code><!-- raw HTML omitted -->中的参数说明：<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl explain role.rules.resources  	<span style="color:#75715e"># 显示 resources 使用方式</span></span></span></code></pre></div><ul>
<li>1.1 <code>apiGroups:</code></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->支持的<!-- raw HTML omitted --><code>API</code><!-- raw HTML omitted -->组列表，<!-- raw HTML omitted --><code>&quot;&quot;</code>,<code>&quot;apps&quot;</code>,<code>&quot;autoscaling</code>&quot;&quot;,<code>&quot;batch&quot;</code>。</li>
</ul>
</blockquote>
<ul>
<li>1.2 <code>resources:</code></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->支持的资源对象列表，<!-- raw HTML omitted --><code>&quot;namespaces&quot;</code>,<code>&quot;services&quot;</code>,<code>&quot;endpoints&quot;</code>,<code>&quot;pods&quot;</code>,<code>&quot;secrets&quot;</code>,<code>&quot;configmaps&quot;</code>,<code>&quot;crontabs&quot;</code>,<code>&quot;deployments&quot;</code>,<code>&quot;jobs&quot;</code>,<code>&quot;nodes&quot;</code>,<code>&quot;rolebindings&quot;</code>,<code>&quot;clusterroles&quot;</code>,<code>&quot;daemonsets&quot;</code>,<code>&quot;replicasets&quot;</code>,<code>&quot;statefulsets&quot;</code>,<code>&quot;horizontalpodautoscalers&quot;</code>,<code>&quot;replicationcontrollers&quot;</code>,<code>&quot;cronjobs&quot;</code></li>
</ul>
</blockquote>
<ul>
<li>1.3 <code>verbs:</code></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->对资源对象的操作方法列表，<!-- raw HTML omitted --><code>&quot;get&quot;</code>,<code> &quot;list&quot;</code>,<code> &quot;watch&quot;</code>,<code> &quot;create&quot;</code>,<code> &quot;update&quot;</code>,<code> &quot;patch&quot;</code>, <code>&quot;delete&quot;</code>,<code>&quot;exec&quot;</code></li>
</ul>
</blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Role</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">authorization-role</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">apiGroups</span>: [<span style="color:#e6db74">&#34;&#34;</span>]  	<span style="color:#75715e"># 支持的API组列表，&#34;&#34;空字符串，表示核心API群</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;pods&#34;</span>]  	<span style="color:#75715e"># 支持的资源对象列表</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;get&#34;</span>,<span style="color:#e6db74">&#34;watch&#34;</span>,<span style="color:#e6db74">&#34;list&#34;</span>]</span></span></code></pre></div></blockquote>
<hr>
<h5 id="rolebinding普通角色绑定"><code>RoleBinding</code>(普通角色绑定)</h5>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->角色绑定用来把一个角色绑定到一个目标对象上，绑定目标可以是<!-- raw HTML omitted --><code>User</code>、<code>Group</code>或者<code>ServiceAccount</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>RoleBinding</code>可以将同一<code>namespace</code>中的<code>subject</code>对象绑定到某个<code>Role</code>下，则此<code>Subject</code>具有该<code>Role</code>定义的权限</li>
<li><code>subjects:</code><!-- raw HTML omitted --><!-- raw HTML omitted --></li>
<li><code>roleRef:</code><!-- raw HTML omitted --><!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">RoleBinding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">authorization-role-binding</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">User  	# User，Group，ServiceAccoun  </span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">user-name</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io  </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Role</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">authorization-role</span></span></span></code></pre></div></blockquote>
<hr>
<h5 id="clusterrole集群角色"><code>ClusterRole</code>(集群角色)</h5>
<ul>
<li>
<ol>
<li><code>ClusterRole</code><!-- raw HTML omitted -->可以对集群范围内的资源、跨<code>namespace</code>的范围资源、非资源类型进行授权<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">name</span>: <span style="color:#ae81ff">authorization-clusterrole</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">apiGroups</span>: [<span style="color:#e6db74">&#34;&#34;</span>]  	<span style="color:#75715e"># 支持的API组列表，&#34;&#34;空字符串，表示核心API群</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;pods&#34;</span>]  	<span style="color:#75715e"># 支持的资源对象列表</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;get&#34;</span>,<span style="color:#e6db74">&#34;watch&#34;</span>,<span style="color:#e6db74">&#34;list&#34;</span>]</span></span></code></pre></div></blockquote>
<hr>
<h5 id="clusterrolebinding集群角色绑定"><code>ClusterRoleBinding</code>(集群角色绑定)</h5>
<blockquote>
<ul>
<li><code>ClusterRoleBinding</code>在整个集群级别和所有<code>namespaces</code>将特定的<code>subject</code>与<code>ClusterRole</code>绑定，授予权限</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRoleBinding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">authorization-clusterrole-binding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:  <span style="color:#75715e"># 应用什么类型的主体  </span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">User  	# User，Group，ServiceAccoun </span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">user-name  	# 对应的名字</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:  	<span style="color:#75715e"># 角色绑定 </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io  	# 对应的Api分组  </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole  	# 角色类型</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">authorization-clusterrole</span></span></span></code></pre></div></blockquote>
<hr>
<h4 id="准入控制">准入控制</h4>
<ul>
<li>
<ol>
<li>通过了前面的认证和授权之后，还需要经过准入控制通过之后，<code>API Server</code>才会处理这个请求。</li>
</ol>
</li>
<li>
<ol start="2">
<li>准入控制是一个可配置的控制器列表，可以通过在<code>API Server</code>上通过命令行设置选择执行哪些注入控制器。</li>
</ol>
</li>
<li>
<ol start="3">
<li>只有当所有的注入控制器都检查通过之后，<code>API Server</code>才会执行该请求，否则返回拒绝。</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,PersistentVolumeLabel,DefaultStorageClass,ResourceQuota,DefaultTolerationSeconds</span></span></code></pre></div></blockquote>
<hr>
<h5 id="admission-controlfont-colorred准入控制font"><code>Admission Control</code><!-- raw HTML omitted -->(准入控制)<!-- raw HTML omitted --></h5>
<blockquote>
<ul>
<li><code>AlwaysAdmit</code><!-- raw HTML omitted -->：允许所有请求<!-- raw HTML omitted --></li>
<li><code>AlwaysDeny</code><!-- raw HTML omitted -->：禁止所有请求，一般用于测试<!-- raw HTML omitted --></li>
<li><code>AlwaysPullImages</code><!-- raw HTML omitted -->：在启动容器之前总去下载镜像<!-- raw HTML omitted --></li>
<li><code>DenyExecOnPrivileged</code>：它会拦截所有想在<code>Privileged Container</code>上执行命令的请求</li>
<li><code>ImagePolicyWebhook</code>：这个插件将允许后端的一个<code>Webhook</code>程序来完成<code>admission controller</code>的功能</li>
<li><code>Service Account</code>：实现<code>ServiceAccount</code>实现了自动化</li>
<li><code>SecurityContextDeny</code>：这个插件将使用<code>SecurityContext</code>的<code>Pod</code>中的定义全部失效</li>
<li><code>ResourceQuota</code>：用于资源配额管理目的，观察所有请求，确保在<code>namespace</code>上的配额不会超标</li>
<li><code>LimitRanger</code>：用于资源限制管理，作用于<code>namespace</code>上，确保对<code>Pod</code>进行资源限制</li>
<li><code>InitialResources</code>：为未设置资源请求与限制的<code>Pod</code>，根据其镜像的历史资源的使用情况进行设置</li>
<li><code>NamespaceLifecycle</code>：如果尝试在一个不存在的<code>namespace</code>中创建资源对象，则该创建请求将被拒 绝。当删除一个<code>namespace</code>时，系统将会删除该<code>namespace</code>中所有对象</li>
<li><code>DefaultStorageClass</code>：为了实现共享存储的动态供应，为未指定<code>StorageClass</code>或<code>PV</code>的<code>PVC</code>尝试匹配默认<code>StorageClass</code>，尽可能减少用户在申请<code>PVC</code>时所需了解的后端存储细节</li>
<li><code>DefaultTolerationSeconds</code>：这个插件为那些没有设置<code>forgiveness tolerations</code>并具有<code>notready:NoExecute</code>和<code>unreachable:NoExecute</code>两种<code>taints</code>的<code>Pod</code>设置默认的<code>“容忍”</code>时间，为<code>5min</code></li>
<li><code>PodSecurityPolicy</code>：这个插件用于在创建或修改Pod时决定是否根据<code>Pod</code>的<code>security context</code>和可用的<code>PodSecurityPolicy</code>对<code>Pod</code>的安全策略进行控制</li>
</ul>
</blockquote>
<hr>
<h3 id="rbac实战"><code>RBAC</code>实战</h3>
<ul>
<li>
<ol>
<li>创建一个只能管理<code>dev</code>命名空间下<code>Pods</code>资源的账号。</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->创建密钥<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /etc/kubernetes/pki/
</span></span><span style="display:flex;"><span>$ <span style="color:#f92672">(</span>umask 077;openssl genrsa -out user-name.key 2048<span style="color:#f92672">)</span></span></span></code></pre></div><ul>
<li>用<code>API Server</code>的密钥去签署证书</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->证书申请：<!-- raw HTML omitted -->申请的用户是<code>user-name</code>，组是<code>group-name</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ openssl req -new -key user-name.key -out user-name.csr -subj <span style="color:#e6db74">&#34;/CN=user-name/O=group-name&#34;</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->签署证书<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ openssl x509 -req -in user-name.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out user-name.crt -days <span style="color:#ae81ff">3650</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->设置集群、用户、上下文信息：<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl config set-cluster kubernetes --embed-certs<span style="color:#f92672">=</span>true --certificate-authority<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca.crt --server<span style="color:#f92672">=</span>https://192.168.18.100:6443
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config set-credentials user-name --embed-certs<span style="color:#f92672">=</span>true --client-certificate<span style="color:#f92672">=</span>/etc/kubernetes/pki/user-name.crt --client-key<span style="color:#f92672">=</span>/etc/kubernetes/pki/user-name.key
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config set-context user-name@kubernetes --cluster<span style="color:#f92672">=</span>kubernetes --user<span style="color:#f92672">=</span>user-name</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->测试账户、切换<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->切换账号到<!-- raw HTML omitted --><code>user-name</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl config use-context user-name@kubernetes</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->查看<code>default</code>下的<code>Pod</code>，发现没有权限：<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl get pods -n default</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->切换到<code>admin</code>账户：<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl config use-context kubernetes-admin@kubernetes</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h4 id="rolebindingfont-colorred引用fontclusterrolefont-colorred进行授权font"><code>RoleBinding</code><!-- raw HTML omitted -->引用<!-- raw HTML omitted --><code>ClusterRole</code><!-- raw HTML omitted -->进行授权<!-- raw HTML omitted --></h4>
<ul>
<li>
<ol>
<li><code>RoleBinding</code>(角色绑定)可以引用<code>ClusterRole</code>(集群角色)，对属于同一命名空间内<code>ClusterRole</code>定义的资源主体进行授权。</li>
</ol>
</li>
<li>
<ol start="2">
<li>一种很常用的做法是，集群管理员为集群范围预定义好一组角色<code>ClusterRole</code>，然后在多个命名空间中重复使用这些<code>ClusterRole</code>。这样可以大幅度提高授权管理工作效率，也使得各个命名空间下的基础性授权规则和使用体验保持一致。</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>虽然<code>authorization-clusterrole</code>是一个集群角色，但是因为使用了<code>RoleBinding</code>，所以<code>xudaxian</code>只能读取<code>default</code>命名空间中的资源</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">RoleBinding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">authorization-clusterrole-binding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">xudaxian</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">User</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">authorization-clusterrole</span></span></span></code></pre></div></blockquote>
<hr>
<h4 id="font-colorred创建fontrolefont-colorred和fontrolebindingfont-colorred为fontuser-namefont-colorred授权font"><!-- raw HTML omitted -->创建<!-- raw HTML omitted --><code>Role</code><!-- raw HTML omitted -->和<!-- raw HTML omitted --><code>RoleBinding</code><!-- raw HTML omitted -->，为<!-- raw HTML omitted --><code>user-name</code><!-- raw HTML omitted -->授权<!-- raw HTML omitted --></h4>
<ul>
<li>
<ol>
<li>创建<code>dev-role.yaml</code>文件，内容如下：</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Role</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">name</span>: <span style="color:#ae81ff">dev-role</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">apiGroups</span>: [<span style="color:#e6db74">&#34;&#34;</span>]  	<span style="color:#75715e"># 支持的API组列表，&#34;&#34;空字符串，表示核心API群</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;pods&#34;</span>]  	<span style="color:#75715e"># 支持的资源对象列表</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;get&#34;</span>,<span style="color:#e6db74">&#34;watch&#34;</span>,<span style="color:#e6db74">&#34;list&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">RoleBinding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">name</span>: <span style="color:#ae81ff">authorization-role-binding </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">User</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">user-name</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Role </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">dev-role</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li>创建<code>Role</code>和<code>RoleBinding</code>：</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl create -f dev-role.yaml</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li>切换账户到<code>user-name</code>用户，再次验证：</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl config use-context user-name@kubernetes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 再次查看：</span>
</span></span><span style="display:flex;"><span>$ kubectl get pod -n default
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 切回admin账户：</span>
</span></span><span style="display:flex;"><span>$ kubectl config use-context kubernetes-admin@kubernetes</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          </section>
        </div>
      </main>
    </div>
    <script src="../../../js/clipboard.min.js?1722425299" defer></script>
    <script src="../../../js/perfect-scrollbar.min.js?1722425299" defer></script>
    <script src="../../../js/d3/d3-color.min.js?1722425299" defer></script>
    <script src="../../../js/d3/d3-dispatch.min.js?1722425299" defer></script>
    <script src="../../../js/d3/d3-drag.min.js?1722425299" defer></script>
    <script src="../../../js/d3/d3-ease.min.js?1722425299" defer></script>
    <script src="../../../js/d3/d3-interpolate.min.js?1722425299" defer></script>
    <script src="../../../js/d3/d3-selection.min.js?1722425299" defer></script>
    <script src="../../../js/d3/d3-timer.min.js?1722425299" defer></script>
    <script src="../../../js/d3/d3-transition.min.js?1722425299" defer></script>
    <script src="../../../js/d3/d3-zoom.min.js?1722425299" defer></script>
    <script src="../../../js/js-yaml.min.js?1722425299" defer></script>
    <script src="../../../js/mermaid.min.js?1722425299" defer></script>
    <script>
      window.themeUseMermaid = JSON.parse("{ \"securityLevel\": \"loose\" }");
    </script>
    <script src="../../../js/theme.js?1722425299" defer></script>
  </body>
</html>
