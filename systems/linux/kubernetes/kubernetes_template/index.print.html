<!DOCTYPE html>
<html lang="en" dir="ltr" itemscope itemtype="http://schema.org/Article">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.125.4">
    <meta name="generator" content="Relearn 6.0.0+tip">
    <meta name="robots" content="noindex, nofollow, noarchive, noimageindex">
    <meta name="description" content="资源控制器 graph LR A[思维导图] --&gt;B[1.前言] A[思维导图] --&gt;C[2.Namespace] A[思维导图] --&gt;D[3.Deployment] A[思维导图] --&gt;E[4.">
    <meta name="author" content="二哥">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://erge.blog/images/s2-1.png">
    <meta name="twitter:title" content="Kubernetes_Template :: Hugo Relearn Theme">
    <meta name="twitter:description" content="资源控制器 graph LR A[思维导图] --&gt;B[1.前言] A[思维导图] --&gt;C[2.Namespace] A[思维导图] --&gt;D[3.Deployment] A[思维导图] --&gt;E[4.">
    <meta property="og:url" content="https://erge.blog/systems/linux/kubernetes/kubernetes_template/">
    <meta property="og:site_name" content="Hugo Relearn Theme">
    <meta property="og:title" content="Kubernetes_Template :: Hugo Relearn Theme">
    <meta property="og:description" content="资源控制器 graph LR A[思维导图] --&gt;B[1.前言] A[思维导图] --&gt;C[2.Namespace] A[思维导图] --&gt;D[3.Deployment] A[思维导图] --&gt;E[4.">
    <meta property="og:locale" content="en">
    <meta property="og:type" content="article">
    <meta property="article:section" content="Systems">
    <meta property="article:published_time" content="2024-06-25T17:38:23+08:00">
    <meta property="article:modified_time" content="2024-06-25T17:38:23+08:00">
    <meta property="og:image" content="https://erge.blog/images/s2-1.png">
    <meta itemprop="name" content="Kubernetes_Template :: Hugo Relearn Theme">
    <meta itemprop="description" content="资源控制器 graph LR A[思维导图] --&gt;B[1.前言] A[思维导图] --&gt;C[2.Namespace] A[思维导图] --&gt;D[3.Deployment] A[思维导图] --&gt;E[4.">
    <meta itemprop="datePublished" content="2024-06-25T17:38:23+08:00">
    <meta itemprop="dateModified" content="2024-06-25T17:38:23+08:00">
    <meta itemprop="wordCount" content="3600">
    <meta itemprop="image" content="https://erge.blog/images/s2-1.png">
    <title>Kubernetes_Template :: Hugo Relearn Theme</title>
    <link href="../../../../images/favicon.ico?1721045974" rel="icon" type="image/x-icon" sizes="any">
    <link href="../../../../css/fontawesome-all.min.css?1721045975" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="../../../../css/fontawesome-all.min.css?1721045975" rel="stylesheet"></noscript>
    <link href="../../../../css/nucleus.css?1721045975" rel="stylesheet">
    <link href="../../../../css/auto-complete.css?1721045975" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="../../../../css/auto-complete.css?1721045975" rel="stylesheet"></noscript>
    <link href="../../../../css/perfect-scrollbar.min.css?1721045975" rel="stylesheet">
    <link href="../../../../css/fonts.css?1721045975" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="../../../../css/fonts.css?1721045975" rel="stylesheet"></noscript>
    <link href="../../../../css/theme.css?1721045975" rel="stylesheet">
    <link href="../../../../css/theme-relearn-auto.css?1721045975" rel="stylesheet" id="R-variant-style">
    <link href="../../../../css/chroma-relearn-auto.css?1721045975" rel="stylesheet" id="R-variant-chroma-style">
    <link href="../../../../css/variant.css?1721045975" rel="stylesheet">
    <link href="../../../../css/print.css?1721045975" rel="stylesheet" media="print">
    <link href="../../../../css/format-print.css?1721045975" rel="stylesheet">
    <script src="../../../../js/variant.js?1721045975"></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.relBasePath='..\/..\/..\/..';
      window.relearn.relBaseUri='..\/..\/..\/..';
      window.relearn.absBaseUri='https:\/\/erge.blog';
      window.index_js_url="../../../../index.search.js";
      // variant stuff
      window.variants && variants.init( [ 'relearn-auto', 'relearn-light', 'relearn-dark', 'relearn-bright', 'zen-auto', 'zen-light', 'zen-dark', 'retro-auto', 'neon', 'learn', 'blue', 'green', 'red', 'my-branding' ] );
      // translations
      window.T_Copy_to_clipboard = `Copy to clipboard`;
      window.T_Copied_to_clipboard = `Copied to clipboard!`;
      window.T_Copy_link_to_clipboard = `Copy link to clipboard`;
      window.T_Link_copied_to_clipboard = `Copied link to clipboard!`;
      window.T_Reset_view = `Reset view`;
      window.T_View_reset = `View reset!`;
      window.T_No_results_found = `No results found for "{0}"`;
      window.T_N_results_found = `{1} results found for "{0}"`;
    </script>Partial intended to be overwritten to add custom headers, like CSS or any other info
<style>
    
</style>


  </head>
  <body class="mobile-support print disableInlineCopyToClipboard" data-url="../../../../systems/linux/kubernetes/kubernetes_template/">
    <div id="R-body" class="default-animation">
      <div id="R-body-overlay"></div>
      <nav id="R-topbar">
        <div class="topbar-wrapper">
          <div class="topbar-sidebar-divider"></div>
          <div class="topbar-area topbar-area-start" data-area="start">
            <div class="topbar-button topbar-button-sidebar" data-content-empty="show" data-width-s="show" data-width-m="show" data-width-l="show"><button class="topbar-control" onclick="toggleNav()" type="button" title="Menu (CTRL&#43;ALT&#43;n)"><i class="fa-fw fas fa-bars"></i></button>
            </div>



          </div>
          <ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype="http://schema.org/BreadcrumbList"><li
            itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><a itemprop="item" href="../../../../systems/"><span itemprop="name">Systems</span></a><meta itemprop="position" content="1">&nbsp;>&nbsp;</li><li
            itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><a itemprop="item" href="../../../../systems/linux/"><span itemprop="name">Linux</span></a><meta itemprop="position" content="2">&nbsp;>&nbsp;</li><li
            itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><a itemprop="item" href="../../../../systems/linux/kubernetes/"><span itemprop="name">Kubernetes</span></a><meta itemprop="position" content="3">&nbsp;>&nbsp;</li><li
            itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><span itemprop="name">Kubernetes_Template</span><meta itemprop="position" content="4"></li>
          </ol>
          <div class="topbar-area topbar-area-end" data-area="end">


            <div class="topbar-button topbar-button-prev" data-content-empty="show" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="../../../../systems/linux/kubernetes/" title="Kubernetes (🡐)"><i class="fa-fw fas fa-chevron-left"></i></a>
            </div>

            <div class="topbar-button topbar-button-next" data-content-empty="show" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="../../../../systems/linux/kubernetes/kubernetes_command/" title="Kubernetes_Command (🡒)"><i class="fa-fw fas fa-chevron-right"></i></a>
            </div>



          </div>
        </div>
      </nav>
      <div id="R-main-overlay"></div>
      <main id="R-body-inner" class="highlightable default" tabindex="-1">
        <div class="flex-block-wrapper">
          <article class="default">
            <header class="headline">
            </header>

<h1 id="kubernetes_template">Kubernetes_Template</h1>

<h1 id="资源控制器">资源控制器</h1>
<blockquote>

<pre class="mermaid align-center zoomable">graph LR
A[思维导图] --&gt;B[1.前言]
A[思维导图] --&gt;C[2.Namespace]
A[思维导图] --&gt;D[3.Deployment]
A[思维导图] --&gt;E[4.StatefulSet]
A[思维导图] --&gt;F[5.DaemonSet]
A[思维导图] --&gt;G[6.HorizontalPodAutoscaler]
A[思维导图] --&gt;H[7.EndPoint]
A[思维导图] --&gt;I[8.Service]
A[思维导图] --&gt;J[9.Label标签/Selector选择器]
C[2.Namespace] --&gt;|a=1|C1[2.1概述]
C[2.Namespace] --&gt;|a=2|C2[2.2应用示例]
D[3.Deployment] --&gt;|a=1|D1[3.1概述]
D[3.Deployment] --&gt;|a=2|D2[3.2语法以及应用示例]
E[4.StatefulSet] --&gt;|a=1|E1[4.1概述]
E[4.StatefulSet] --&gt;|a=2|E2[4.2语法以及应用示例]
F[5.DaemonSet] --&gt;|a=1|F1[5.1概述]
F[5.DaemonSet] --&gt;|a=2|F2[5.2语法以及应用示例]
G[6.HorizontalPodAutoscaler] --&gt;|a=1|G1[6.1概述]
G[6.HorizontalPodAutoscaler] --&gt;|a=2|G2[6.2语法以及应用]
H[7.EndPoint] --&gt;|a=1|H1[7.1概述]
H[7.EndPoint] --&gt;|a=2|H2[7.2语法以及应用]
I[8.Service] --&gt;|a=1|I1[8.1概述]
I[8.Service] --&gt;|a=2|I2[8.2语法以及应用]
J[9.Label标签/Selector选择器] --&gt;|a=1|J1[9.1概述]
J[9.Label标签/Selector选择器] --&gt;|a=2|J2[9.2语法以及应用]

Z[横向流程图]</pre>
<pre class="mermaid align-center zoomable">graph TD
A[Deployment] --&gt; D[ReplicaSet]
B[CronJob] --&gt; E[Job]
C[DaemonSet] --&gt; G{{容器}}
D[ReplicaSet] --&gt; G{{容器}}
E[Job] --&gt; G{{容器}}
F[StatefulSet] --&gt; G{{容器}}

G{{容器}} --&gt; J[/Volume\]
G{{容器}} --&gt; H(Service服务)

J[/Volume\] --&gt; K[/configMap\]
J[/Volume\] --&gt; L[/PVC\]
J[/Volume\] --&gt; M[/Secret\]

Z[Kubernetes控制流程]</pre><ul>
<li><!-- raw HTML omitted -->标签选择器<!-- raw HTML omitted --></li>
</ul>

<pre class="mermaid align-center zoomable">graph LR
A[Deployment&lt;br&gt;seletor:env=dev] -.- C[Label&lt;br&gt;]  
B{Service&lt;br&gt;seletor:env=dev} --- C[Label&lt;br&gt;]
C[Label&lt;br&gt;] --- C1((Pod&lt;br&gt;labe:env=dev))
C[Label&lt;br&gt;] --- C2((Pod&lt;br&gt;labe:env=dev))
C[Label&lt;br&gt;] --- C3((Pod&lt;br&gt;labe:env=dev))
    Z[Service]</pre>
<pre class="mermaid align-center zoomable">graph TD

A[user containerN&lt;br&gt;user ImageN&lt;br&gt;user container1&lt;br&gt;user Image1&lt;br&gt;Pause&lt;br&gt;gcr.io/google_containers/pause-amd64&lt;br&gt;] 
    Z[Pod]</pre></blockquote>
<hr>
<h2 id="资源名称">资源名称</h2>
<blockquote>
<ul>
<li>
<ol>
<li><code>kubectl api-resources -o wide</code><!-- raw HTML omitted -->：获取参数定义命令<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<table>
<thead>
<tr>
<th><code>Name</code>(名称)</th>
<th><code>ShortNames</code>(简写)</th>
<th><code>apiVersion</code>(<code>API</code>版本)</th>
<th><code>NameSpaced</code>(命名空间)</th>
<th>kind(类型)</th>
<th>Verbs(可执行操作命令)</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>configmaps</code></td>
<td>cm</td>
<td>v1</td>
<td>true</td>
<td>ConfigMap</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>events</td>
<td>ev</td>
<td>v1</td>
<td>true</td>
<td>Event</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td><code>limitranges</code></td>
<td>limits</td>
<td>v1</td>
<td>true</td>
<td>LimitRange</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>pods</td>
<td>po</td>
<td>v1</td>
<td>true</td>
<td>Pod</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>serviceaccounts</td>
<td>sa</td>
<td>v1</td>
<td>true</td>
<td>ServiceAccount</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>services</td>
<td>svc</td>
<td>v1</td>
<td>true</td>
<td>Service</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>daemonsets</td>
<td>ds</td>
<td>apps/v1</td>
<td>true</td>
<td>DaemonSet</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>deployments</td>
<td>deploy</td>
<td>apps/v1</td>
<td>true</td>
<td>Deployment</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>replicasets</td>
<td>rs</td>
<td>apps/v1</td>
<td>true</td>
<td>ReplicaSet</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>statefulsets</td>
<td>sts</td>
<td>apps/v1</td>
<td>true</td>
<td>StatefulSet</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>horizontalpodautoscalers</td>
<td>hpa</td>
<td>autoscaling/v2</td>
<td>true</td>
<td>HorizontalPodAutoscaler</td>
<td>create,delete,deletecollection,get,list,patch,update,watch   all</td>
</tr>
<tr>
<td>cronjobs</td>
<td>cj</td>
<td>batch/v1</td>
<td>true</td>
<td>CronJob</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>jobs</td>
<td></td>
<td>batch/v1</td>
<td>true</td>
<td>Job</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>events</td>
<td>ev</td>
<td>events.k8s.io/v1</td>
<td>true</td>
<td>Event</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>ingresses</td>
<td>ing</td>
<td>networking.k8s.io/v1</td>
<td>true</td>
<td>Ingress</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>networkpolicies</td>
<td>netpol</td>
<td>networking.k8s.io/v1</td>
<td>true</td>
<td>NetworkPolicy</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>poddisruptionbudgets</td>
<td>pdb</td>
<td>policy/v1</td>
<td>true</td>
<td>PodDisruptionBudget</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
</tbody>
</table>
<ul>
<li><!-- raw HTML omitted -->资源控制器作用<!-- raw HTML omitted --></li>
</ul>
<table>
<thead>
<tr>
<th>资源分类</th>
<th>资源名称</th>
<th>缩写</th>
<th>资源作用</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Pod</code>资源控制器</td>
<td><code>replicasets</code></td>
<td><code>rs</code></td>
<td>保证指定数量的<code>Pod</code>运行，并支持<code>Pod</code>数量变更，镜像版本变更</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>deployments</code></td>
<td><code>deploy</code></td>
<td>通过控制<code>ReplicaSet</code>来控制<code>Pod</code>，并支持滚动升级、版本回退</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>daemonsets</code></td>
<td><code>ds</code></td>
<td>在集群中的指定<code>Node</code>上都运行一个副本，一般用于日志采集、监控、守护进程类的任务。</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>jobs</code></td>
<td>&mdash;</td>
<td>它创建出来的<code>Pod</code>只要完成任务就立即退出，用于执行一次性任务</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>cronjobs</code></td>
<td><code>cj</code></td>
<td>它创建的Pod会周期性的执行，用于执行周期性的任务</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>horizontalpodautoscalers</code></td>
<td><code>hpa</code></td>
<td>可以根据集群负载自动调整<code>Pod</code>的数量，实现削峰填谷</td>
</tr>
<tr>
<td><code>Pod</code>资源控制器</td>
<td><code>statefulsets</code></td>
<td><code>sts</code></td>
<td>管理有状态的应用。</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h2 id="资源控制器字段类型作用">资源控制器字段类型作用</h2>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>explain</code><!-- raw HTML omitted -->选项获取字段使用方式<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl explain deployment.metadata  	<span style="color:#75715e"># 获取 deployment的metadata使用方式， 还可以获取：spec、kind</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl explain deployment.spec.selector  <span style="color:#75715e"># 获取yaml基础格式命令 </span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->资源控制器<!-- raw HTML omitted --><!-- raw HTML omitted -->必选字段<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>参数名</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>version</code></td>
<td><code>String</code></td>
<td><code>Kubernetes API </code>的版本，可以用<code>kubectl api-versions</code>命令查询</td>
</tr>
<tr>
<td><code>kind</code></td>
<td><code>String</code></td>
<td>标明<code>YAML</code>定义的资源类型和角色，如<code>Pod</code>、<code>Deployment</code>等</td>
</tr>
<tr>
<td><code>metadata</code></td>
<td><code>String</code></td>
<td>元数据对象</td>
</tr>
<tr>
<td><code>metadata.name</code></td>
<td><code>String</code></td>
<td>元数据对象的名字，可自定义，比如命名<code>Pod</code>的名字</td>
</tr>
<tr>
<td><code>spec</code></td>
<td><code>Object</code></td>
<td>详细定义对象</td>
</tr>
<tr>
<td><code>spec.containers[]</code></td>
<td><code>List</code></td>
<td>容器列表定义</td>
</tr>
<tr>
<td><code>spec.containers[].name</code></td>
<td><code>String</code></td>
<td>定义容器的名字</td>
</tr>
<tr>
<td><code>spec.containers[].image</code></td>
<td><code>String</code></td>
<td>定义容器使用的镜像</td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>
<ol start="2">
<li><code>metadata</code><!-- raw HTML omitted -->字段选择<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>metadata.name</code></td>
<td></td>
<td><code>Pod</code>名称</td>
</tr>
<tr>
<td><code>metadata.uid</code></td>
<td></td>
<td><code>Pod</code>的<code>UID</code></td>
</tr>
<tr>
<td><code>metadata.namespace</code></td>
<td></td>
<td><code>Pod</code>名字空间</td>
</tr>
<tr>
<td><code>metadata.labels['&lt;KEY&gt;']</code></td>
<td></td>
<td><code>Pod</code>标签 <code>&lt;KEY&gt;</code> 的值 (例如<code>metadata.labels['mylabel']</code>）</td>
</tr>
<tr>
<td><code>metadata.annotations['&lt;KEY&gt;']</code></td>
<td></td>
<td><code>Pod</code>的注解 <code>&lt;KEY&gt;</code> 的值（例如, <code>metadata.annotations['myannotation']</code>）</td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>
<ol start="3">
<li><code>spec.containers</code><!-- raw HTML omitted -->字段定义<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>spec.containers[].name</td>
<td>String</td>
<td>定义容器的名字。</td>
</tr>
<tr>
<td>spec.containers[].image</td>
<td>String</td>
<td>定义容器使用的镜像。</td>
</tr>
<tr>
<td>spec.containers[].imagePullSecrets</td>
<td></td>
<td>要从私有仓库拉取镜像，<code>Kubernetes</code>需要凭证。 配置文件中的 <code>imagePullSecrets</code>字段表明<code>Kubernetes</code>应该通过名为 <code>regcred</code> 的 Secret 获取凭证</td>
</tr>
<tr>
<td>spec.containers[].imagePullPolicy</td>
<td>S</td>
<td>定镜像拉取有3个值可选:<!-- raw HTML omitted --> <!-- raw HTML omitted --><code>Always</code><!-- raw HTML omitted -->：总是从远程仓库拉取镜像、<!-- raw HTML omitted --><!-- raw HTML omitted --><code>IfNotPresent</code><!-- raw HTML omitted -->：本地有则使用本地镜像，本地没有则从远程仓库拉取镜像。如上面 3个值都没设置，默认是<code>Always</code><!-- raw HTML omitted --><!-- raw HTML omitted --><code>Never</code><!-- raw HTML omitted -->：仅使用本地镜像，本地没有就报错</td>
</tr>
<tr>
<td>spec.containers[].command[]</td>
<td>List</td>
<td>指定容器启动命令，因为是数组形式，所以可以指定多个启动命令，不指定则使用镜像打包时的启动命令。</td>
</tr>
<tr>
<td>spec.containers[].args[]</td>
<td>List</td>
<td>指定容器启动命令参数，因为是数组形式，所以可以指定多个参数。</td>
</tr>
</tbody>
</table>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spec</span>:   	<span style="color:#75715e"># 必选，Pod中容器的详细定义</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">imagePullSecrets</span>:  	<span style="color:#75715e"># 配置登录 docker registry 的 secret 仓库</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">docker-harbor  	# 指定使用的secret库房名称</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:   	<span style="color:#75715e"># 必选，Pod中容器列表，一个Pod中可以定义多个容器</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">tomcat-demo   	# 指定容器名称，不可更新</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">192.168.80.210</span>:<span style="color:#ae81ff">8080</span><span style="color:#ae81ff">/test/tomcat-demo:v1 </span> <span style="color:#75715e"># 镜像仓库地址</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">Always   	# 容器下载策略：Always|Never|IfNotPresent，不管本地存不存在，都从仓库拉取镜像</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: [<span style="color:#ae81ff">string]   	# 容器的启动命令列表，替代docker的ENTRYPOINT指令、如不指定，使用打包时使用的启动命令</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">args</span>:   	<span style="color:#75715e"># 容器的启动命令参数列表、替代docker的CMD指令</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">/bin/sh</span>
</span></span><span style="display:flex;"><span>    - -<span style="color:#ae81ff">c</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">touch /tmp/healthy; sleep 30; rm -fr /tmp/healthy; sleep 600</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><code>spec.containers.volumeMounts</code><!-- raw HTML omitted -->容器工作目录定义<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>spec.containers[].workingDir</td>
<td>String</td>
<td>指定容器的工作目录</td>
</tr>
<tr>
<td>spec.containers[].volumeMounts[]</td>
<td>List</td>
<td>指定容器内部的存储卷配置</td>
</tr>
<tr>
<td>spec.containers[].volumeMounts[].name</td>
<td>String</td>
<td>指定可以被容器挂载的存储卷的名称</td>
</tr>
<tr>
<td>spec.containers[].volumeMounts[].mountPath</td>
<td>String</td>
<td>指定可以被容器挂载的存储卷的路径。</td>
</tr>
<tr>
<td>spec.containers[].volumeMountsf].readOnly</td>
<td>String</td>
<td>设置存储卷路径的读写模式，true 或者 false，默认为读写模式。</td>
</tr>
</tbody>
</table>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spec</span>:   	<span style="color:#75715e"># 必选，Pod中容器的详细定义</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">containers</span>:   	<span style="color:#75715e"># 必选，Pod中容器列表</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">workingDir</span>: <span style="color:#ae81ff">string   	# 容器的工作目录、不指定则使用镜像默认值</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumeMounts</span>:   	<span style="color:#75715e"># 挂载到容器内部的存储卷配置</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">data   	# 引用pod定义的共享存储卷的名称，需用volumes[]部分定义的的卷名</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/opt/data   	# 存储卷在容器内mount的绝对路径，应少于512字符</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">readOnly</span>: <span style="color:#ae81ff">boolean   	# 是否为只读模式</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><code>spec.containers.ports</code><!-- raw HTML omitted -->容器端口定义<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl explain deployment.spec.containers.ports  	<span style="color:#75715e"># 获取端口使用方式</span></span></span></code></pre></div><table>
<thead>
<tr>
<th>参数名称</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>spec.containers[].ports[]</td>
<td>List</td>
<td>指定容器需要用到的端口列表。</td>
</tr>
<tr>
<td>spec.containers[].ports[].name</td>
<td>String</td>
<td>指定端口名称。</td>
</tr>
<tr>
<td>spec.containers[].ports[].containerPort</td>
<td>String</td>
<td>指定容器需要监听的端口号。</td>
</tr>
<tr>
<td>spec.containers[].ports[].hostPort</td>
<td>String</td>
<td>指定容器所在主机需要监听的端口号，默认和 spec.containers[].ports[].containerPort 相同。注意，设置了则同一台主机无法启动该容器的相同副本（主机的端口号不能相同，若相同，会引发冲突）。</td>
</tr>
<tr>
<td>spec.containers[].ports[].protocol</td>
<td>String</td>
<td>指定端口协议，支持 TCP 和 UDP，默认值为 TCP 。</td>
</tr>
</tbody>
</table>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spec</span>:  	<span style="color:#75715e"># 必选，Pod中容器的详细定义</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">containers</span>:  	<span style="color:#75715e"># 必选，Pod中容器列表</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:  	<span style="color:#75715e"># 容器暴露的端口</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http  	# 服务名称、该名称可以在service种被引用</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>  	<span style="color:#75715e"># 容器需要监听的端口号</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">hostPort</span>: <span style="color:#ae81ff">int  	# 容器所在主机需要监听的端口号，默认与Container相同</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP  	# 端口协议，支持TCP和UDP，默认TCP</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>  	<span style="color:#75715e"># 集群端口</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">80</span>  	<span style="color:#75715e"># Pod端口</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nodePort</span>: <span style="color:#ae81ff">30080</span>  	<span style="color:#75715e"># 节点对外端口</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="6">
<li><code>spec.containers.env</code><!-- raw HTML omitted -->容器变量定义<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>spec.containers[].env[]</td>
<td>List</td>
<td>指定容器运行前需要设置的环境变量列表。</td>
</tr>
<tr>
<td>spec.containers[].env[].name</td>
<td>String</td>
<td>指定环境变量名称。</td>
</tr>
<tr>
<td>spec.containers[].env[].value</td>
<td>String</td>
<td>指定环境变量值。</td>
</tr>
</tbody>
</table>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spec</span>:   	<span style="color:#75715e"># 必选，Pod中容器的详细定义</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">containers</span>:   	<span style="color:#75715e"># 必选，Pod中容器列表</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">env</span>:   	<span style="color:#75715e"># 容器运行前需设置的环境变量列表</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">JAVA_OPTS   	# 环境变量名称</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;-Xmx1g&#34;</span>   	<span style="color:#75715e"># 定义使用内存、环境变量的值</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="7">
<li><code>spec.containers.resources</code><!-- raw HTML omitted -->容器资源限制<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>spec.containers[].resources</td>
<td>Object</td>
<td>指定资源限制和资源请求的值（这里开始就是设置容器的资源上限）。</td>
</tr>
<tr>
<td>spec.containers[].resources.limits</td>
<td>Object</td>
<td>指定设置容器运行时资源的运行上限。</td>
</tr>
<tr>
<td>spec.containers[].resources.limits.cpu</td>
<td>String</td>
<td>指定<code>CPU</code>的限制，单位为<code>core</code>，是用于运行 <code>docker run --cpu-shares</code>命令的参数。</td>
</tr>
<tr>
<td>spec.containers[].resources.limits.memory</td>
<td>String</td>
<td>指定内存的限制，单位为 MiB 或 GiB。</td>
</tr>
<tr>
<td>spec.containers[].resources.requests</td>
<td>Object</td>
<td>指定容器启动和调度时的限制。</td>
</tr>
<tr>
<td>spec.containers[].resources.requests.cpu</td>
<td>String</td>
<td>CPU 请求，单位为 core，容器启动时初始化可用数量。</td>
</tr>
<tr>
<td>spec.containers[].resources.requests.memory</td>
<td>String</td>
<td>内存请求，单位为 MiB 或 GiB，容器启动的初始化可用数量。</td>
</tr>
</tbody>
</table>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># 设定默认request和limit</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Namespace</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">name</span>: <span style="color:#ae81ff">apps</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">LimitRange</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">name</span>: <span style="color:#ae81ff">limit-resource  	# 在一个名称空间不能重复</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default  	# 指定名称空间，默认defalut</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">labels</span>:      <span style="color:#ae81ff">&lt;map[string]string&gt;  	# 标签</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">annotations</span>: <span style="color:#ae81ff">&lt;map[string]string&gt;  	# 注释</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设定默认request和limit</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">default</span>:  	<span style="color:#75715e"># 默认的资源上限, limit</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">1024Mi</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">500m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">defaultRequest</span>:  	<span style="color:#75715e"># 默认的资源申请值, required</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">128Mi</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">100m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">max</span>:  	<span style="color:#75715e"># 声明的limit上限</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">2048Mi</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">1000m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">min</span>:  	<span style="color:#75715e"># 声明的required下线</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">64Mi</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">50m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">Container  	# 被限制的对象，Container</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">###############################################</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:   	<span style="color:#75715e"># Pod中容器的详细定义</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:   	<span style="color:#75715e"># Pod中容器列表</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>:   	<span style="color:#75715e"># 资源限制和请求的设置</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">limits</span>:   	<span style="color:#75715e"># 限定Pod最大使用硬件资源、通常设置cpu和memory</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cpu</span>: <span style="color:#e6db74">&#34;1&#34;</span>   	<span style="color:#75715e"># Cpu的限制，单位为core数</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">memory</span>: <span style="color:#e6db74">&#34;1Gi&#34;</span>   	<span style="color:#75715e"># 内存限制，单位可以为Mib/Gib</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">requests</span>:   	<span style="color:#75715e"># 最低资源要求，在scheduler中被用到，通常设置cpu和memory</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cpu</span>: <span style="color:#e6db74">&#34;0.5&#34;</span>   	<span style="color:#75715e"># 限定使用几个核心CPU、容器启动的初始可用数量</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">memory</span>: <span style="color:#e6db74">&#34;256Mi&#34;</span>   	<span style="color:#75715e"># 设定使用内存、容器启动的初始可用数量</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="8">
<li><!-- raw HTML omitted -->容器健康检查设置<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>
<p><code>startupProbe</code><!-- raw HTML omitted -->： 启动探测：<!-- raw HTML omitted -->容器启动完毕的配置，该配置与<code>readinessProbe</code>一致，在<code>lifecycle</code>和<code>Probe</code>之前运行，失败则重启</p>
<p><code>k8s1.16</code>版本后新加<code>startupProbe</code>探测方式，用于判断容器内应用程序是否已经启动，如果配置了<code>startuprobe</code>，就会先禁用其他的探测，直到它成功为止</p>
</li>
<li>
<p><code>liveness probe</code><!-- raw HTML omitted -->(存活探针)<!-- raw HTML omitted --><code>Kubelet</code> 使用<code>liveness probe</code>（存活探针）来确定何时重启容器。例如，当应用程序处于运行状态但无法做进一步操作，<code>liveness</code>探针将捕获到<code>deadlock</code>重启处于该状态下的容器，使应用程序在存在<code>bug</code>的情况下依然能够继续运行下去（谁的程序还没几个<code>bug</code>呢）</p>
</li>
<li>
<p><code>readiness probe</code><!-- raw HTML omitted -->(就绪探针)<!-- raw HTML omitted --><code>Kubelet</code>使用<code>readiness probe(就绪探针)</code>来确定容器是否已经就绪可以接受流量。只有当<code>Pod</code>中的容器都处于就绪状态时<code>kubelet</code>才会认定该<code>Pod</code>处于就绪状态。该信号的作用是控制哪些<code>Pod</code>应该作为<code>service</code>的后端。如果<code>Pod</code>处于非就绪状态，那么它们将会被从<code>service</code>的<code>load balancer</code>中移除</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>spec.containers[].livenessProbe(存活探针)</td>
<td>Object</td>
<td>指定<code>Pod</code>内容器健康检查的设置，当探测几次无响应后，系统将自动重启该容器。参数可以设置为<code>exec</code>、<code>httpGet</code>、<code>tcpSocket</code>。</td>
</tr>
<tr>
<td>spec.containers[].livenessProbe.exec</td>
<td>Object</td>
<td>指定<code>Pod</code>内容器健康检查的设置，确定是<code>exec</code>方式。</td>
</tr>
<tr>
<td>spec.containers[].livenessProbe.exec.command[]</td>
<td>String</td>
<td>指定<code>exec</code>方式后用这个参数设置需要指定的命令或者脚本。</td>
</tr>
<tr>
<td>spec.containers[].livenessProbe.httpGet</td>
<td>Object</td>
<td>指定 Pod 内容器健康检查的设置，确定是<code>httpGet</code>方式。</td>
</tr>
<tr>
<td>spec.containers[].livenessProbe.tcpSocket</td>
<td>Object</td>
<td>指定 Pod 内容器健康检查的设置，确定是 <code>tcpSocket</code>方式。</td>
</tr>
<tr>
<td>spec.containers[].livenessProbe.initialDelaySeconds</td>
<td>Number</td>
<td>指定容器启动完成后延迟多久开始首次探测的时间间隔，单位为秒。</td>
</tr>
<tr>
<td>spec.containers[].livenessProbe.timeoutSeconds</td>
<td>Number</td>
<td>容器健康检查的探测等待时间，单位为秒，默认为 1 秒。若超过该时间，则认为该次探测失败。</td>
</tr>
<tr>
<td>spec.containers[].livenessProbe.periodSeconds</td>
<td>Number</td>
<td>对容器健康检查的定期探测时间设置，单位为秒，默认每 10 秒探测一次。<code>Kubernetes</code>如果连续执行3次Liveness探测均失败，则会杀掉并重启容器</td>
</tr>
<tr>
<td>spec.containers[].livenessProbe.failureThreshold</td>
<td>Number</td>
<td>连续探测失败多少次才被认定为失败。默认是3。最小值是1</td>
</tr>
<tr>
<td>spec.containers[].livenessProbe.successThreshold</td>
<td>Number</td>
<td>连续探测成功多少次才被认定为成功。默认是1</td>
</tr>
</tbody>
</table>
<ul>
<li><code>infrastructure Container:</code><!-- raw HTML omitted -->基础容器，维护整个<code>Pod</code>网络空间<!-- raw HTML omitted --></li>
<li><code>initContainers:</code><!-- raw HTML omitted -->初始化容器，先于业务容器开始运行<!-- raw HTML omitted --></li>
<li><code>Containers:</code><!-- raw HTML omitted -->业务容器，并行启动<!-- raw HTML omitted --></li>
<li><code>Pod</code><!-- raw HTML omitted -->内所有容器公用一个<!-- raw HTML omitted --><code>ip</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">initc-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">initc-template</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">initContainers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">initc-template</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#39;sh&#39;</span>, <span style="color:#e6db74">&#39;-c&#39;</span>, <span style="color:#e6db74">&#39;sleep 10; echo &#34;Hello&#34; &gt;&gt;/tmp/hello.txt&#39;</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-container</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#39;sh&#39;</span>, <span style="color:#e6db74">&#39;-c&#39;</span>, <span style="color:#e6db74">&#39;echo The app is running! &amp;&amp; sleep 3600&#39;</span>]</span></span></code></pre></div><ul>
<li><code>exec</code><!-- raw HTML omitted -->命令：在容器内执行一次命令，如果命令执行的退出码为<code>0</code>，则认为程序正常，否则不正常<!-- raw HTML omitted --></li>
<li><code>Pod</code><!-- raw HTML omitted -->五种状态<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>Pending(挂起)</code>：<code>API Server</code><!-- raw HTML omitted -->已经创建了<code>Pod</code>资源对象，但它尚未被调度完成或者仍处于下载镜像的过程中<!-- raw HTML omitted --></li>
<li><code>Running(运行中)</code>：<code>Pod</code><!-- raw HTML omitted -->已经被调度到某节点，并且所有容器都已经被<code>kubelet</code>创建完成<!-- raw HTML omitted --></li>
<li><code>Succeeded(成功终止)</code>：<code>Pod</code><!-- raw HTML omitted -->中的所有容器都已经成功终止并且不会被重启<!-- raw HTML omitted --></li>
<li><code>Failed(失败)</code><!-- raw HTML omitted -->：所有容器都已经终止，但至少有一个容器终止失败，即容器返回了非<code>0</code>值的退出状态<!-- raw HTML omitted --></li>
<li><code>Unknown(未知)</code>：<code>API Server</code><!-- raw HTML omitted -->无法正常获取到<code>Pod</code>对象的状态信息，通常由于网络通信失败所导致<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spec</span>:   	<span style="color:#75715e"># 必选，Pod中容器的详细定义</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:   	<span style="color:#75715e"># 必选，Pod中容器列表</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">lifecycle</span>:   	<span style="color:#75715e"># 生命周期钩子</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">postStart</span>:  	<span style="color:#75715e"># 容器启动后立即执行此钩子,如果执行失败,会根据重启策略进行重启</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">exec</span>:  	<span style="color:#75715e"># 通过执行特定命令来探测容器健康状态</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;echo Hello from the postStart handler&gt; /usr/share/message&#34;</span>]
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">preStop</span>:  	<span style="color:#75715e"># 容器终止前执行此钩子,无论结果如何,容器都会终止</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">exec</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;nginx -s quit; while killall -0 nginx; do sleep 1; done&#34;</span>]
</span></span><span style="display:flex;"><span><span style="color:#75715e">#################  		启动探针	  #####################</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">startupProbe</span>:  	<span style="color:#75715e"># 容器启动完毕的配置，该配置与readinessProbe一致，在lifecycle和Probe之前运行，失败则重启</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">tcpSocket</span>:   		<span style="color:#75715e"># 使用TcpSocket、httpGet健康检查</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8010</span>   	<span style="color:#75715e"># 探测8010端口</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">5</span>  	<span style="color:#75715e"># 检测失败5次表示未就绪</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">60</span>   	<span style="color:#75715e"># 指定容器启动60s之后开始执行Liveness探测，</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>  	<span style="color:#75715e"># 两次探测的间隔多少秒，默认值为10</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>  	<span style="color:#75715e"># 连续多少次检测成功认为容器正常，默认值为1。不支持修改</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">3</span>  	<span style="color:#75715e"># 连续多少次检测失败认为容器异常，默认值为3</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span>  	<span style="color:#75715e"># 探测请求超时时间</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##################  	存活探针编写方式  	################</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">livenessprobe</span>:  	<span style="color:#75715e"># 存活探针检查,不通过不转发流量</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tcpSocket</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8010</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#####################  		就绪探针编写方式  		################</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">readinessProbe</span>:   	<span style="color:#75715e"># 就绪探针检查、不通过重建pod</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">tcpSocket</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8010</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">####################  		httpGet编写  		###########################</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">httpGet</span>:
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/  	# URI地址</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>  	<span style="color:#75715e"># 端口号,或者协议：http/https</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">host</span>: <span style="color:#ae81ff">192.168.109.100</span>  	<span style="color:#75715e"># 主机地址  </span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTP  	# 支持的协议，http或者https</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="9">
<li><code>spec.volumes</code><!-- raw HTML omitted -->挂载目录字段<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>参数名</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>spec.volumes[].name</td>
<td>String</td>
<td>定义<code>Pod</code>共享存储卷的名称，容器定义部分 <code>spec.containers[].volumeMounts[].name</code>的值和这里是一样的。</td>
</tr>
<tr>
<td>spec.volumes[].emptyDir</td>
<td>Object</td>
<td>指定<code>Pod</code>的临时目录，值为一个空对象：<code>emptyDir:{}</code></td>
</tr>
<tr>
<td>spec.volumes[].hostPath</td>
<td>Object</td>
<td>指定挂载<code>Pod</code>所在宿主机的目录。</td>
</tr>
<tr>
<td>spec.volumes[].hostPath.path</td>
<td>String</td>
<td>指定<code>Pod</code>所在主机的目录，将被用于容器中<code>mount</code>的目录。</td>
</tr>
<tr>
<td>spec.volumes.nfs</td>
<td></td>
<td></td>
</tr>
<tr>
<td>spec.volumes[]</td>
<td>Object</td>
<td>指定类型为<code>Secret</code>的存储卷，<code>Secret</code>意为私密、秘密，这很容易理解，它存储一些密码、密钥等敏感安全文件。挂载集群预定义的<code>Secret</code>对象到容器内部。</td>
</tr>
<tr>
<td>spec.volumes[].configMap</td>
<td>Object</td>
<td>指定类型为<code>ConfigMap</code>的存储卷，表示挂载集群预定义的<code>ConfigMap</code>对象到容器内部。</td>
</tr>
</tbody>
</table>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl explain deployment.spec.volumes  	<span style="color:#75715e"># 获取 deployment存储使用</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl explain deployment.spec.volumes.hostPath.type  	<span style="color:#75715e"># 类型声明  </span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->简单存储模式→<!-- raw HTML omitted --><code>volume-emptydir</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod  </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">name</span>: <span style="color:#ae81ff">volume-emptydir </span> <span style="color:#75715e"># 定义名称</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:   	<span style="color:#75715e"># 必选，Pod中容器的详细定义</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">containers</span>:  	<span style="color:#75715e"># 必选，Pod中容器列表</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumeMounts</span>: <span style="color:#75715e"># 将logs-volume挂载到nginx容器中对应的目录，该目录为/var/log/nginx</span>
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/log/nginx </span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30  	# 可以选择 1.28.4版本</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;tail -f /logs/access.log&#34;</span>] <span style="color:#75715e"># 初始命令，动态读取指定文件</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumeMounts</span>: <span style="color:#75715e"># 将logs-volume挂载到busybox容器中的对应目录，该目录为/logs</span>
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/logs</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:   	<span style="color:#75715e"># 声明volume，name为logs-volume，类型为emptyDir</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume  	# 共享存储卷名称 （volumes类型有很多种）</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">emptyDir</span>: {}   		<span style="color:#75715e"># 类型为emtyDir的存储卷，与Pod同生命周期的一个临时目录。为空值</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->简单存储模式→<!-- raw HTML omitted --><code>volume-HostPath</code></li>
</ul>
<blockquote>
<ul>
<li><code>DirectoryOrCreate</code><!-- raw HTML omitted -->：目录存在就使用，不存在就先创建后使用<!-- raw HTML omitted --></li>
<li><code>Directory</code><!-- raw HTML omitted -->：目录必须存在<!-- raw HTML omitted --></li>
<li><code>FileOrCreate</code><!-- raw HTML omitted -->：文件存在就使用，不存在就先创建后使用<!-- raw HTML omitted --></li>
<li><code>File</code><!-- raw HTML omitted -->：文件必须存在<!-- raw HTML omitted --></li>
<li><code>Socket</code><!-- raw HTML omitted -->：<code>unix</code>套接字必须存在<!-- raw HTML omitted --></li>
<li><code>CharDevice</code><!-- raw HTML omitted -->：字符设备必须存在<!-- raw HTML omitted --></li>
<li><code>BlockDevice</code><!-- raw HTML omitted -->：块设备必须存在<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">volume-hostpath</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumeMounts</span>: <span style="color:#75715e"># 将logs-volume挂载到nginx容器中对应的目录，该目录为/var/log/nginx</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/log/nginx</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;tail -f /logs/access.log&#34;</span>] <span style="color:#75715e"># 初始命令，动态读取指定文件</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumeMounts</span>: <span style="color:#75715e"># 将logs-volume挂载到busybox容器中的对应目录，该目录为/logs</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/logs</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>: <span style="color:#75715e"># 声明volume，name为logs-volume，类型为hostPath</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">hostPath</span>:  <span style="color:#75715e"># 类型为hostPath的存储卷，表示挂载Pod所在宿主机的目录</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/root/logs </span> <span style="color:#75715e"># Pod所在宿主机的目录，将被用于同期中mount的目录</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">type</span>: <span style="color:#ae81ff">DirectoryOrCreate</span> <span style="color:#75715e"># 目录存在就使用，不存在就先创建再使用 </span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->简单存储模式→<!-- raw HTML omitted --><code>volume-nfs</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">name</span>: <span style="color:#ae81ff">volume-nfs</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumeMounts</span>:  	<span style="color:#75715e"># 将logs-volume挂载到nginx容器中对应的目录，该目录为/var/log/nginx</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/log/nginx</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;tail -f /logs/access.log&#34;</span>]  	<span style="color:#75715e"># 初始命令，动态读取指定文件</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumeMounts</span>:  	<span style="color:#75715e"># 将logs-volume挂载到busybox容器中的对应目录，该目录为/logs</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/logs</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:  	<span style="color:#75715e"># 声明volume</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nfs</span>:  	<span style="color:#75715e"># 存储类型，和底层正则的存储对应</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server</span>: <span style="color:#ae81ff">192.168.18.100</span>  	<span style="color:#75715e"># NFS服务器地址</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/root/data/nfs  	# 共享文件路径</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->高级存储模式→<!-- raw HTML omitted --><code>volume-pv</code></li>
</ul>
<blockquote>
<ul>
<li><code>PV：kubernetes</code><!-- raw HTML omitted -->管理员维护<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolume</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pv2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">nfs</span>:  	<span style="color:#75715e"># 存储类型，和底层正则的存储对应</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/root/data/pv1</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">server</span>: <span style="color:#ae81ff">192.168.18.100</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">capacity</span>:  	<span style="color:#75715e"># 存储能力，目前只支持存储空间的设置</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">2Gi</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">accessModes</span>:  	<span style="color:#75715e"># 访问模式</span>
</span></span><span style="display:flex;"><span>   - <span style="color:#ae81ff">ReadWriteMany</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">storageClassName</span>:  	<span style="color:#75715e"># 存储类别</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">persistentVolumeReclaimPolicy</span>: <span style="color:#ae81ff">Retain  	# 回收策略</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->高级存储→<!-- raw HTML omitted --><code>volume-pvc</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolumeClaim</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pvc1</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">accessModes</span>:  	<span style="color:#75715e"># 访客模式</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">ReadWriteMany</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:  	<span style="color:#75715e"># 采用标签对PV选择</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">storageClassName</span>:  	<span style="color:#75715e"># 存储类别</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:  	<span style="color:#75715e"># 请求空间</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">1Gi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#################################################### 创建 Pod 访问 PVC 类型存储</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;while true;do echo pod1 &gt;&gt; /root/out.txt; sleep 10; done;&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">volume</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/root/</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">volume</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">persistentVolumeClaim</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">claimName</span>: <span style="color:#ae81ff">pvc1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">readOnly</span>: <span style="color:#66d9ef">false</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->配置存储→<!-- raw HTML omitted --><code>volumes-secret</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Secret</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">name</span>: <span style="color:#ae81ff">secret</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">type</span>: <span style="color:#ae81ff">Opaque</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">data</span>:  	<span style="color:#75715e"># 提前编码实名：data、使用Kubernetes进行编码使用：stringData</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">username</span>: <span style="color:#ae81ff">YWRtaW4=  	# 使用kubernetes进行编码写原数据：admin</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">password</span>: <span style="color:#ae81ff">MTIzNDU2  	# 使用kubernetes进行编码写原数据：123456</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">############################################## 配置 pod-secret</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-secret</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/secret/config</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">secret</span>:  	<span style="color:#75715e"># 类型为secret的存储卷，挂载集群与定义的secret对象到容器内部</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">secretName</span>: <span style="color:#ae81ff">secret</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">items</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">string</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">string</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="10">
<li><!-- raw HTML omitted -->额外的参数对象<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>参数名</th>
<th>参数类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>spec.restartPolicy</td>
<td>String</td>
<td>定义<code>Pod</code>的重启策略，可选值为<code>Always</code>、<code>OnFailure</code>，默认值为<code>Always</code>。<!-- raw HTML omitted -->(1) <!-- raw HTML omitted --><code>Always</code><!-- raw HTML omitted -->：<code>Pod</code>一旦终止运行，无论容器是如何终止的，<code>kubelet</code>服务都将重启它<!-- raw HTML omitted -->(2) <!-- raw HTML omitted --><code>OnFailure</code><!-- raw HTML omitted -->：只有<code>Pod</code>以非零退出码终止时，<code>kubelet</code>才会重启该容器，如果容器正常结束（退出码为 0），则<code>kubelet</code>将不会重启它<!-- raw HTML omitted --> (3)<!-- raw HTML omitted --><code>Never</code><!-- raw HTML omitted -->：<code>Pod</code>终止后，<code>kubelet</code>将退出码报告给<code>master</code>，不会重启该 <code>Pod</code></td>
</tr>
<tr>
<td>spec.nodeName</td>
<td></td>
<td>定向调度</td>
</tr>
<tr>
<td>spec.nodeSelector</td>
<td>Object</td>
<td>定向调度，定义节点的过滤标签（以<code>key:value</code>格式指定）。</td>
</tr>
<tr>
<td>pod.spec.affinity</td>
<td>亲和调度</td>
<td></td>
</tr>
<tr>
<td>pod.spec.affinity.nodeAffinity</td>
<td></td>
<td>（node亲和性）：以Node为目标，解决Pod可以调度到那些Node的问题。</td>
</tr>
<tr>
<td>pod.spec.affinity.podAffinity</td>
<td></td>
<td>（pod亲和性）：以Pod为目标，解决Pod可以和那些已存在的Pod部署在同一个拓扑域中的问题。</td>
</tr>
<tr>
<td>pod.spec.affinity.podAntiAffinity</td>
<td></td>
<td>（pod反亲和性）：以Pod为目标，解决Pod不能和那些已经存在的Pod部署在同一拓扑域中的问题。</td>
</tr>
<tr>
<td>pod.spec.tolerations</td>
<td>容忍调度</td>
<td>污点就是拒绝，容忍就是忽略，Node通过污点拒绝Pod调度上去，Pod通过容忍忽略拒绝</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>spec.imagePullSecrets</td>
<td>List</td>
<td>定义拉取镜像时使用<code>Secret</code>名称（以<code>name:secretkey</code>格式指定）。</td>
</tr>
<tr>
<td>spec.hostNetwork</td>
<td>Boolean</td>
<td>定义是否使用主机网络模式，默认值为 false。 设置 true 表示使用宿主机网络，不使用 Docker 网桥，同时设置了 true 将无法在同一台宿主机上启动第二个副本。</td>
</tr>
<tr>
<td>service.spec.type</td>
<td></td>
<td><code>type</code>确定服务的公开方式。 默认为<code>ClusterIP</code>。有效的选项是<code>ExternalName</code>、<code>ClusterIP</code>、<code>NodePort</code>和<code>LoadBalancer</code></td>
</tr>
<tr>
<td>service.spec.type.ClusterIP</td>
<td></td>
<td><code>ClusterIP</code>为负载均衡分配集群内部<code>IP</code>地址端点。 端点由选择器确定，或者如果不是通过手动构造<code>Endpoints</code>对象或<code>EndpointSlice</code>指定对象。 如果<code>clusterIP</code>为<code>None</code>，则不分配虚拟<code>IP</code>，并且端点作为一组端点而不是虚拟<code>IP</code>发布。</td>
</tr>
<tr>
<td>service.spec.type.NodePort</td>
<td></td>
<td><code>NodePort</code>建立在<code>ClusterIP</code>之上，并在每个节点上分配一个端口路由到与<code>clusterIP</code>相同的端点。</td>
</tr>
<tr>
<td>service.spec.type.LoadBalancer</td>
<td></td>
<td><code>LoadBalancer</code>建立在<code>NodePort</code>并创建一个外部负载均衡器（如果当前支持<code>cloud</code>) 路由到与<code>clusterIP</code>相同的端点。</td>
</tr>
<tr>
<td>service.spec.type.ExternalName</td>
<td></td>
<td><code>ExternalName</code>将此服务别名为指定的<code>externalName</code>。 其他几个领域不适用于<code>ExternalName</code>服务</td>
</tr>
</tbody>
</table>
<ul>
<li><code>tolerations</code><!-- raw HTML omitted -->(容忍)配置<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl explain deployment.spec.template.spec.tolerations</span></span></code></pre></div><ul>
<li><code>affinity</code><!-- raw HTML omitted -->(亲和性)配置<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl explain deployment.spec.template.spec.affinity  	<span style="color:#75715e"># 查看 Deployment 亲和性使用</span></span></span></code></pre></div><blockquote>
<ul>
<li><code>nodeAffinity</code><!-- raw HTML omitted -->节点亲和性<!-- raw HTML omitted --></li>
<li><code>requiredDuringSchedulingIgnoredDuringExecution:</code><!-- raw HTML omitted -->硬性要求，必须满足条件<!-- raw HTML omitted --></li>
<li><code>preferredDuringSchedulingIgnoredDuringExecution:</code><!-- raw HTML omitted -->软性要求，不强制满足<!-- raw HTML omitted --></li>
<li><code>In</code><!-- raw HTML omitted -->：满足条件之一<!-- raw HTML omitted --></li>
<li><code>NotIn</code><!-- raw HTML omitted -->：所有条件都不满足，反亲和性<!-- raw HTML omitted --></li>
<li><code>Exists</code><!-- raw HTML omitted -->：存在就满足<!-- raw HTML omitted --></li>
<li><code>DoesNotExist</code><!-- raw HTML omitted -->不存在就满足<!-- raw HTML omitted --></li>
<li><code>Gt</code><!-- raw HTML omitted -->大于节点上的数值就满足<!-- raw HTML omitted --></li>
<li><code>Lt</code><!-- raw HTML omitted -->小于节点上的数值就满足<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl explain deployment.spec.template.spec.affinity.nodeAffinity  	<span style="color:#75715e"># 查看Deployment nodes亲和性使用</span></span></span></code></pre></div><div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">with-affinity-anti-affinity</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">affinity</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nodeAffinity</span>:  	<span style="color:#75715e"># 节点亲和性  </span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">requiredDuringSchedulingIgnoredDuringExecution</span>:  	<span style="color:#75715e"># 必须满足条件</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">nodeSelectorTerms</span>:  	<span style="color:#75715e"># 选择器，nodeSelectorTerms：节点选择器，labelSelector：标签选择器</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">matchExpressions</span>:  	<span style="color:#75715e"># 表达式匹配</span>
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">kubernetes.io/os  	# 必须存在的Key</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">In  	# 在Key中满足一个条件，匹配类型：In、NotIn、Exists、DoesNotExist、Gt、Lt</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">values</span>:  	<span style="color:#75715e"># 下方 value 在 Key 中必须存在其中之一(value)</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">linux  	# 必须是Linux才部署  </span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">preferredDuringSchedulingIgnoredDuringExecution</span>:  	<span style="color:#75715e"># 软性要求，不强制满足，优先选择亲和性目标</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">weight</span>: <span style="color:#ae81ff">1</span>  	<span style="color:#75715e"># 权重，数值越大，优先部署</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">preference</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">matchExpressions</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">label-1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">In</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">values</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">key-1</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">weight</span>: <span style="color:#ae81ff">50</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">preference</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">matchExpressions</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">label-2</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">In</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">values</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">key-2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">with-node-affinity</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">registry.k8s.io/pause:2.0</span></span></span></code></pre></div><ul>
<li><code>podAffinity</code><!-- raw HTML omitted -->亲和性<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl explain pod.spec.affinity.podAffinity</span></span></code></pre></div><div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">with-pod-affinity</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">affinity</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">podAffinity</span>:  	<span style="color:#75715e"># Pod 亲和性</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">requiredDuringSchedulingIgnoredDuringExecution</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">labelSelector</span>:  	<span style="color:#75715e"># 选择器：</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">matchExpressions</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">security</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">In</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">values</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">S1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">topologyKey</span>: <span style="color:#ae81ff">topology.kubernetes.io/zone  	# 匹配节点标签亲和性</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">podAntiAffinity</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">preferredDuringSchedulingIgnoredDuringExecution</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">weight</span>: <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">podAffinityTerm</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">labelSelector</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">matchExpressions</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">security</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">In</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">values</span>:
</span></span><span style="display:flex;"><span>              - <span style="color:#ae81ff">S2</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">topologyKey</span>: <span style="color:#ae81ff">topology.kubernetes.io/zone</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">with-pod-affinity</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">registry.k8s.io/pause:2.0  </span></span></span></code></pre></div><ul>
<li><code>podAntiAffinity</code><!-- raw HTML omitted -->反亲和性<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl explain pod.spec.affinity.podAntiAffinity  </span></span></code></pre></div></blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spec</span>:  	<span style="color:#75715e"># 必选，Pod中容器的详细定义</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">2</span>  	<span style="color:#75715e"># 创建Pod个数</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">selector</span>:  	<span style="color:#75715e"># 标签选择器</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">matchLabels</span>:  	<span style="color:#75715e"># 标签选择方式:直接给定标签键值,这里是取交集的,也就是Pod必须满足下面两个标签才能被调度</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">project</span>: <span style="color:#ae81ff">ms</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">product  	# 此行以上定义控制器本身</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:  	<span style="color:#75715e"># 定义Deployment更新回滚</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>         - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">string</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">annotations</span>:  	<span style="color:#75715e"># 注释，不能作为被筛选</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hostAliases</span>:  	<span style="color:#75715e"># /etc/hosts/手动添加解析</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">ip</span>: <span style="color:#e6db74">&#34;192.168.4.110&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hostnames</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;k8s.com&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:   	<span style="color:#75715e"># 必选，Pod中容器列表</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">restartPolicy</span>: [<span style="color:#ae81ff">Always、Never、OnFailure] </span> <span style="color:#75715e">#默认K8S-Pod的重启策略,此容器退出后立即创建一个相同容器</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nodeName</span>: <span style="color:#ae81ff">k8s-node1</span> <span style="color:#75715e"># NodeName表示将该Pod调度到指定到名称的node节点上</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nodeSelector</span>: <span style="color:#ae81ff">obeject</span> <span style="color:#75715e"># nodeSelector用于将Pod调度到添加了指定标签的Node节点上</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">imagePullSecrets</span>:  	<span style="color:#75715e"># 配置登录 docker registry 的 secret 仓库</span>
</span></span><span style="display:flex;"><span>     - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">docker-harbor  	# 指定使用的secret库房名称</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">hostNetwork</span>: <span style="color:#66d9ef">false</span>   <span style="color:#75715e">#是否使用主机网络模式，默认为false，如果设置为true，表示使用宿主机网络</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="replicasetrs类型控制器"><code>ReplicaSet(RS)</code>类型控制器</h3>
<blockquote>
<ul>
<li><code>ReplicaSet</code><!-- raw HTML omitted -->：主要作用是保证一定数量的<code>Pod</code>能够正常运行，它会持续监听这些<code>Pod</code>的运行状态，一旦<code>Pod</code>发生故障，就会重启或重建。同时它还支持对<code>Pod</code>数量的扩缩容和版本镜像的升级<!-- raw HTML omitted --></li>
<li><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/ReplicaSet/kubernetes-replicaset-template.yaml" rel="external" target="_self"><code>Kubernetes replicaset Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1    </span> <span style="color:#75715e"># 版本号 </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ReplicaSet       </span> <span style="color:#75715e"># 类型 </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:       <span style="color:#75715e"># 元数据 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">replicaset-template    </span> <span style="color:#75715e"># 名称、在一个名称空间内不能重复</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default   </span> <span style="color:#75715e"># 指定名称空间、默认defalut</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:       <span style="color:#75715e"># 标签 </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">replicaset-template</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:   <span style="color:#75715e"># 详情描述 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>   <span style="color:#75715e"># 指定副本数量，是rs创建出来的Pod的数量，默认为1.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:     <span style="color:#75715e"># 选择器，它的作用是建立Pod控制器和Pod之间的关联关系，采用了Label Selector机制（在Pod模块上定义Label，在控制器上定义选择器，就可以表明当前控制器能管理哪些Pod了）</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:        <span style="color:#75715e"># Labels匹配规则，matchExpressions：Expressions匹配规则</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">replicaset-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:     <span style="color:#75715e"># 模块 当副本数据不足的时候，会根据下面的模板创建Pod副本</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">replicaset-template</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx    </span> <span style="color:#75715e"># 容器名称</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1    </span> <span style="color:#75715e"># 容器需要的镜像地址</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>     <span style="color:#75715e"># 容器所监听的端口</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">100m</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">128Mi</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">50m</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">128Mi</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="horizontalpodautoscaler类型"><code>HorizontalPodAutoscaler</code>类型</h3>
<blockquote>
<ul>
<li><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/HPA/kubernetes-hpa-template.yaml" rel="external" target="_self"><code>Kubernetes HorizontalPodAutoscaler Template</code>模板</a></li>
</ul>
<blockquote>
<ul>
<li><code>deployment</code><!-- raw HTML omitted -->：类型控制器<!-- raw HTML omitted --></li>
<li><code>deployment-name</code><!-- raw HTML omitted -->：<code>Pod</code>的名称<!-- raw HTML omitted --></li>
<li><code>--cpu-percent</code><!-- raw HTML omitted -->：使用<code>CPU</code>百分比<!-- raw HTML omitted --></li>
<li><code>--min</code><!-- raw HTML omitted -->：<code>Pod</code>最少数量<!-- raw HTML omitted --></li>
<li><code>--max</code><!-- raw HTML omitted -->：<code>Pod</code>最多数量<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl autoscale deployment deployment-name --cpu-percent<span style="color:#f92672">=</span><span style="color:#ae81ff">50</span> --min<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> --max<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span></span></span></code></pre></div></blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">autoscaling/v2   </span> <span style="color:#75715e"># 版本号</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">HorizontalPodAutoscaler  </span> <span style="color:#75715e"># 类型</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:   <span style="color:#75715e"># 元数据 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default   </span> <span style="color:#75715e"># 指定名称空间、默认default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">hpa-template</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">minReplicas</span>: <span style="color:#ae81ff">2</span>   <span style="color:#75715e"># 最小Pod数量</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">maxReplicas</span>: <span style="color:#ae81ff">10</span>    <span style="color:#75715e"># 最大Pod数量</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">metrics</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">resource</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cpu  	# 扩缩容名称</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">averageUtilization</span>: <span style="color:#ae81ff">30</span>  	<span style="color:#75715e"># 设置CPU使用百分比，超过就扩容</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">type</span>: <span style="color:#ae81ff">Utilization  	# 利用率：Utilization，平均值：AverageValue：1k、1M、1G</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">Resource</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scaleTargetRef</span>:    <span style="color:#75715e"># 指定要控制Pod、Deployment信息</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">deployment-template</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">name</span>: <span style="color:#ae81ff">service-template</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">deployment-nginx-template</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  clusterIP: None       # 将clusterIP设置为None，即可创建headliness Service</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">NodePort       </span> <span style="color:#75715e"># Pod使用的IP类型：ClusterIP、NodePort</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>    <span style="color:#75715e"># Service的端口</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">80</span>      <span style="color:#75715e"># StatefulSet 的Pod端口</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1    </span> <span style="color:#75715e"># 版本号 </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment       </span> <span style="color:#75715e"># 类型 </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:       <span style="color:#75715e"># 元数据 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">deployment-template    </span> <span style="color:#75715e"># deployment的名称</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default   </span> <span style="color:#75715e"># 指定名称空间、默认default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:       <span style="color:#75715e"># 标签 </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">deployment-nginx-template</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:   <span style="color:#75715e"># 详情描述 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>   <span style="color:#75715e"># 副本数量 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">revisionHistoryLimit</span>: <span style="color:#ae81ff">3</span>       <span style="color:#75715e"># 保留历史版本，默认为10 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">paused</span>: <span style="color:#66d9ef">false</span>         <span style="color:#75715e"># 暂停部署，默认是false </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">progressDeadlineSeconds</span>: <span style="color:#ae81ff">600</span>          <span style="color:#75715e"># 部署超时时间（s），默认是600</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">strategy</span>:     <span style="color:#75715e"># pod更新策略，即如何替换已有的pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate        </span> <span style="color:#75715e"># 更新策略、支持 Recreate, RollingUpdate。默认RollingUpdate</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>:      <span style="color:#75715e"># 当type为RollingUpdate的时候生效，用于为rollingUpdate设置参数</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">30</span><span style="color:#ae81ff">%      </span> <span style="color:#75715e"># 用来指定在升级过程中不可用的Pod的最大数量，默认为25%。</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxSurge</span>: <span style="color:#ae81ff">30</span><span style="color:#ae81ff">%    </span> <span style="color:#75715e"># 用来指定在升级过程中可以超过期望的Pod的最大数量，默认为25%</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:     <span style="color:#75715e"># 选择器，通过它指定该控制器管理哪些pod </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:        <span style="color:#75715e"># Labels匹配规则，matchExpressions：Expressions匹配规则 </span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">deployment-nginx-template </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:     <span style="color:#75715e"># 模板，当副本数量不足时，会根据下面的模板创建pod副本 </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:   <span style="color:#75715e"># Pod 的标签</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">deployment-nginx-template</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:   <span style="color:#75715e"># Pod 的期望信息</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:   <span style="color:#75715e"># Pod 容器描述</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx  </span> <span style="color:#75715e"># 镜像名称</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent  </span> <span style="color:#75715e"># IfNotPresent：如果镜像不存在就拉取</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">100m</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">128Mi</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">50m</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">128Mi</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">restartPolicy</span>: <span style="color:#ae81ff">Always  </span> <span style="color:#75715e"># 重启策略，Always：代表一直重启</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">terminationGracePeriodSeconds</span>: <span style="color:#ae81ff">30</span>   <span style="color:#75715e"># 删除操作宽限时间</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="deploymentdeploy无状态类型"><code>Deployment(deploy)</code>无状态类型</h3>

<pre class="mermaid align-center zoomable">graph TD
A[&lt;p&gt;Deployment&lt;br&gt;seletor:env=dev] --&gt; A1((&lt;p&gt;Pod&lt;br&gt;label:env=dev))
A[&lt;p&gt;Deployment&lt;br&gt;seletor:env=dev] --&gt; A2((&lt;p&gt;Pod&lt;br&gt;label:env=dev))
A[&lt;p&gt;Deployment&lt;br&gt;seletor:env=dev] --&gt; A3((&lt;p&gt;Pod&lt;br&gt;label:env=dev))
    Z[Deployment控制Pod]  </pre><blockquote>
<ul>
<li><code>Deployment</code><!-- raw HTML omitted -->：为了更好的解决服务编排的问题，<!-- raw HTML omitted --><code>kubernetes</code>在<code>v1.2</code>版本开始，引入了<code>Deployment</code>控制器。值得一提的是，<code>Deployment</code>控制器并不直接管理<code>Pod</code>，而是通过管理<code>ReplicaSet</code>来间接管理<code>Pod</code>，即：<code>Deployment</code>管理<code>ReplicaSet</code>，<code>ReplicaSet</code>管理<code>Pod</code>。所以<code>Deployment</code>的功能比<code>ReplicaSet</code>强大</li>
<li>支持<code>ReplicaSet</code>的所有功能</li>
<li><!-- raw HTML omitted -->支持发布的停止、继续<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->支持版本滚动更新和版本回退<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>
<p><code>Recreate</code><!-- raw HTML omitted -->重建更新：在创建出新的<code>Pod</code>之前会先杀掉所有已经存在的<!-- raw HTML omitted --><code>Pod</code></p>
</li>
<li>
<p><code>RollingUpdate</code><!-- raw HTML omitted -->滚动更新：杀死一部分，就启动一部分，在更新过程中存在两个版本的<!-- raw HTML omitted --><code>Pod</code>，当<code>type</code>为<code>RollingUpdate</code>的时候生效，用于为<code>rollingUpdate</code>设置参数，  支持两个属性：</p>
</li>
<li>
<p><code>maxSurge</code><!-- raw HTML omitted -->：用来指定在升级过程中可以超过期望的<code>Pod</code>的最大数量，默认为25%<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>maxUnavailable</code><!-- raw HTML omitted -->：用来指定在升级过程中不可用的<code>Pod</code>的最大数量，默认为25%<!-- raw HTML omitted --></p>
</li>
</ul>
</blockquote>
<ul>
<li><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/Deployment/kubernetes-deployment-template.yaml" rel="external" target="_self"><code>Kubernetes Deployment Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1  	# 版本号 </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment  	# 类型 </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:  	<span style="color:#75715e"># 元数据 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">deployment-template  	# deployment的名称</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default  	# 指定名称空间、默认defalut</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:  	<span style="color:#75715e"># 标签 </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">deployment-nginx-template</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:  	<span style="color:#75715e"># 详情描述 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>  	<span style="color:#75715e"># 副本数量 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">revisionHistoryLimit</span>: <span style="color:#ae81ff">3</span>  	<span style="color:#75715e"># 保留历史版本，默认为10 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">paused</span>: <span style="color:#66d9ef">false</span>  	<span style="color:#75715e"># 暂停部署，默认是false </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">progressDeadlineSeconds</span>: <span style="color:#ae81ff">600</span>  	<span style="color:#75715e"># 部署超时时间（s），默认是600</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">strategy</span>:  	<span style="color:#75715e"># pod更新策略，即如何替换已有的pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>:  	<span style="color:#75715e"># 当type为RollingUpdate的时候生效，用于为rollingUpdate设置参数</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">30</span><span style="color:#ae81ff">%  	# 用来指定在升级过程中不可用的Pod的最大数量，默认为25%。</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxSurge</span>: <span style="color:#ae81ff">30</span><span style="color:#ae81ff">%  	# 用来指定在升级过程中可以超过期望的Pod的最大数量，默认为25%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate  	# 更新策略、支持 Recreate, RollingUpdate。默认RollingUpdate</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:  	<span style="color:#75715e"># 选择器，通过它指定该控制器管理哪些pod </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:  	<span style="color:#75715e"># Labels匹配规则，matchExpressions：Expressions匹配规则 </span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">deployment-nginx-template </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:  	<span style="color:#75715e"># 模板，当副本数量不足时，会根据下面的模板创建pod副本 </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:   <span style="color:#75715e"># Pod 的标签</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">deployment-nginx-template</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:   <span style="color:#75715e"># Pod 的期望信息</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:   <span style="color:#75715e"># Pod 容器描述</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx  </span> <span style="color:#75715e"># 镜像名称</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1    </span> <span style="color:#75715e"># fxgxxxxx/nginx:v1 在所有节点登录自己的 hub.docker.com 账户</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent  </span> <span style="color:#75715e"># IfNotPresent：如果镜像不存在就拉取</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">volumeMounts</span>:   <span style="color:#75715e"># 挂载到容器内部的存储卷配置</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx_vhosts   </span> <span style="color:#75715e"># 引用pod定义的共享存储卷的名称，需用volumes[]部分定义的的卷名</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/usr/local/nginx/conf/vhosts  </span> <span style="color:#75715e"># 存储卷在容器内mount的绝对路径，应少于512字符</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx_logs</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/usr/local/nginx/logs</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx_html</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">resources</span>:      <span style="color:#75715e"># 资源限制和请求的设置</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">limits</span>:   <span style="color:#75715e"># 限定Pod最大使用硬件资源、通常设置cpu和memory</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#e6db74">&#34;6&#34;</span>    <span style="color:#75715e"># Cpu的限制，单位为core数，将用于docker run --cpu-shares参数，1000m等于一个核心</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#e6db74">&#34;128Mi&#34;</span>     <span style="color:#75715e"># 内存限制，单位可以为Mib/Gib，将用于docker run --memory参数</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">requests</span>:     <span style="color:#75715e"># 最低资源要求，在scheduler中被用到，通常设置cpu和memory</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#e6db74">&#34;3&#34;</span>    <span style="color:#75715e"># 限定使用几个核心CPU、容器启动的初始可用数量</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#e6db74">&#34;64Mi&#34;</span>      <span style="color:#75715e"># 设定使用内存、容器启动的初始可用数量</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">restartPolicy</span>: <span style="color:#ae81ff">Always  </span> <span style="color:#75715e"># 重启策略，Always：代表一直重启</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">terminationGracePeriodSeconds</span>: <span style="color:#ae81ff">30</span>   <span style="color:#75715e"># 删除操作宽限时间</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumes</span>:      <span style="color:#75715e"># 在该pod上定义共享存储卷列表</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx_vhosts    </span> <span style="color:#75715e"># 共享存储卷名称 （volumes类型有很多种） </span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">hostPath</span>:   <span style="color:#75715e"># 类型为hostPath的存储卷，表示挂载Pod所在宿主机的目录</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/opt/data/nginx/vhosts</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">type</span>: <span style="color:#ae81ff">DirectoryOrCreate  </span> <span style="color:#75715e"># 目录存在就使用，不存在就先创建再使用</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx_logs</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">hostPath</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/opt/data/nginx/logs</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">type</span>: <span style="color:#ae81ff">DirectoryOrCreate</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx_html</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">hostPath</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/opt/data/nginx/html</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">type</span>: <span style="color:#ae81ff">DirectoryOrCreate</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">status</span>: {}</span></span></code></pre></div></blockquote>
<hr>
<h3 id="statefulset有状态类型"><code>StatefulSet</code>有状态类型</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->无状态应用定义<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>认为<code>Pod</code>都是一样的</li>
<li>没有顺序要求</li>
<li>不用考虑在哪个<code>Node</code>节点上运行</li>
<li>随意进行伸缩和扩展</li>
</ul>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->有状态应用定义<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>有顺序要求</li>
<li>认为每个<code>Pod</code>都是不一样的</li>
<li>需要考虑在哪个<code>Node</code>节点上运行</li>
<li>需要按照顺序进行伸缩和扩展</li>
<li>让每个<code>Pod</code>都是独立的，保持<code>Pod</code>启动顺序和唯一性</li>
</ul>
</blockquote>
<ul>
<li><code>StatefulSet</code> 是<code>Kubernetes</code><!-- raw HTML omitted -->提供的管理有状态应用的负载管理控制器<!-- raw HTML omitted --></li>
<li><code>StatefulSet</code><!-- raw HTML omitted -->常用来部署<!-- raw HTML omitted --><code>RabbitMQ</code>集群、<code>Zookeeper</code>集群、<code>MySQL</code>集群、<code>Eureka</code>集群等</li>
<li><code>StatefulSet</code><!-- raw HTML omitted -->部署需要<!-- raw HTML omitted --><code>HeadLinessService</code>（无头服务）</li>
</ul>
<blockquote>
<ul>
<li>在用<code>Deployment</code>时，每一个<code>Pod</code>名称是没有顺序的，是随机字符串，因此是<code>Pod</code>名称是无序的，但是在<code>StatefulSet</code>中要求必须是有序 ，每一个<code>Pod</code>不能被随意取代，<code>Pod</code>重建后<code>pod</code>名称还是一样的</li>
<li>而<code>Pod IP</code>是变化的，所以是以<code>Pod</code>名称来识别。<code>Pod</code>名称是<code>Pod</code>唯一性的标识符，必须持久稳定有效。这时候要用到<!-- raw HTML omitted -->无头服务<!-- raw HTML omitted -->，它可以给每个<code>Pod</code>一个唯一的名称</li>
</ul>
</blockquote>
<ul>
<li><code>Deployment</code>和<code>StatefulSet</code>区别：<code>Deployment</code><!-- raw HTML omitted -->没有唯一标识而<!-- raw HTML omitted --><code>StatefulSet</code>有唯一标识</li>
<li><code>StatefulSet</code><!-- raw HTML omitted -->唯一标识生成规则<!-- raw HTML omitted -->：  根据主机名+一定规则生成的：<!-- raw HTML omitted -->主机名.无头<!-- raw HTML omitted --><code>Service</code>名称.命名空间<code>.svc.cluster.local</code></li>
<li><code>StatefulSet</code><!-- raw HTML omitted -->控制器支持两种更新策略<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>OnDelete</code>： <code>OnDelete</code><!-- raw HTML omitted -->表示删除之后才更新<!-- raw HTML omitted --></li>
<li>(默认)<code>RollingUpdate</code>：<code>RollingUpdate</code><!-- raw HTML omitted -->表示滚动更新<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/StatefulSet/kubernetes-statefulset-template.yaml" rel="external" target="_self"><code>Kubernetes StatefulSet Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">name</span>: <span style="color:#ae81ff">service-template</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">statefulset-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">clusterIP</span>: <span style="color:#ae81ff">None      </span> <span style="color:#75715e"># 将clusterIP设置为None，即可创建headliness Service</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP  	# 类型：NodePort</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>    <span style="color:#75715e"># Service的端口</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">80</span>      <span style="color:#75715e"># StatefulSet 的Pod端口</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">StatefulSet</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">statefulset-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">service-template  </span> <span style="color:#75715e"># 使用那个Service管理DNS</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">updateStrategy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate        </span> <span style="color:#75715e"># 滚动更新，OnDelete：删除更新</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>:      <span style="color:#75715e"># 如果更新的策略是OnDelete，那么rollingUpdate就失效</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">partition</span>: <span style="color:#ae81ff">2</span>      <span style="color:#75715e"># 表示从第2个分区开始更新，默认是0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">statefulset-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">statefulset-template</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="daemonsetds守护进程类型"><code>DaemonSet(ds)</code>守护进程类型</h3>
<blockquote>
<ul>
<li>
<p><code>DaemonSet</code><!-- raw HTML omitted -->：控制器可以保证集群中的每一台（或指定）节点上都运行一个副本，一般适用于日志(<code>elk</code>)收集、节点监控(<code>zabbix</code>)等场景。也就是说，<!-- raw HTML omitted -->如果一个<code>Pod</code>提供的功能是节点级别的（每个节点都需要且只需要一个），那么这类<code>Pod</code>就适合使用<code>DaemonSet</code>类型的控制器创建</p>
</li>
<li>
<p><code>DaemonSet</code><!-- raw HTML omitted -->控制器的特点<!-- raw HTML omitted --></p>
<p><!-- raw HTML omitted -->  每向集群中添加一个节点的时候，<!-- raw HTML omitted -->指定的<code>Pod</code>副本也将添加到该节点上</p>
<p><!-- raw HTML omitted -->当节点从集群中移除的时候，<!-- raw HTML omitted --><code>Pod</code>也会被垃圾回收</p>
</li>
<li>
<p><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/DaemonSet/kubernetes-daemonset-template.yaml" rel="external" target="_self"><code>Kubernetes DaemonSet Template</code>模板</a></p>
</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1  </span> <span style="color:#75715e"># 版本号</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">DaemonSet        </span> <span style="color:#75715e"># 类型</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:       <span style="color:#75715e"># 元数据</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fluentd-daemonset      </span> <span style="color:#75715e"># Pod 名称</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default   </span> <span style="color:#75715e"># 指定名称空间、默认default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:       <span style="color:#75715e"># 标签</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#39;fluentd-es&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:   <span style="color:#75715e"># Pod 详情描述</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">revisionHistoryLimit</span>: <span style="color:#ae81ff">3</span>       <span style="color:#75715e"># 保留历史版本、默认为最大值(2^32)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">updateStrategy</span>:       <span style="color:#75715e"># 更新策略</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate        </span> <span style="color:#75715e"># 滚动更新策略</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>:      <span style="color:#75715e"># 滚动更新</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">1</span>         <span style="color:#75715e"># 最大不可用状态的Pod的最大值，可用为百分比，也可以为整数</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:     <span style="color:#75715e"># 选择器，通过它指定该控制器管理那些Pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels:        # Labels匹配规则，matchExpressions</span>: <span style="color:#ae81ff">匹配规则</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#39;fluentd-es&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:     <span style="color:#75715e"># 模板，当副本数量不足时，会根据下面的模板创建Pod模板</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#39;fluentd-es&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fluentd-es</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">agilestacks/fluentd-elasticsearch:v1.3.0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">env</span>:    <span style="color:#75715e"># 环境变量配置</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">FLUENTD_ARGS   </span> <span style="color:#75715e"># 环境变量的 key</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">value</span>: -<span style="color:#ae81ff">qq   </span> <span style="color:#75715e"># 环境变量的 value</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">volumeMounts</span>:   <span style="color:#75715e"># 加载数据卷 避免数据丢失</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">containers     </span> <span style="color:#75715e"># 数据卷名称</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/lib/docker/containers        </span> <span style="color:#75715e"># 将数据卷挂载到容器内那个目录</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">varlog</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/log</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumes</span>:          <span style="color:#75715e"># 定义数据卷</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">containers       </span> <span style="color:#75715e"># 定义数据卷的名称</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">hostPath</span>:       <span style="color:#75715e"># 数据卷类型，主机路径模式</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/var/lib/docker/containers     </span> <span style="color:#75715e"># node 中共享目录</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">varlog</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">hostPath</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/var/log</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="service类型控制器"><code>Service</code>类型控制器</h3>
<blockquote>
<ul>
<li>在<code>kubernetes</code>中，<code>Pod</code>是应用程序的载体，我们可以通过<code>Pod</code>的<code>IP</code>来访问应用程序，但是<code>Pod</code>的<code>IP</code>地址不是固定的，这就意味着不方便直接采用<code>Pod</code>的<code>IP</code>对服务进行访问</li>
<li>为了解决这个问题，<code>kubernetes</code>提供了<code>Service</code>资源，<code>Service</code>会对提供同一个服务的多个<code>Pod</code>进行聚合，并且提供一个统一的入口地址，通过访问<code>Service</code>的入口地址就能访问到后面的<code>Pod</code>服务</li>
<li><code>Service</code>在很多情况下只是一个概念：真正起作用的其实是<code>kube-proxy</code>服务进程，每个<code>Node</code>节点上都运行了一个<code>kube-proxy</code>的服务进程。当创建<code>Service</code>的时候会通过<code>API Server</code>向<code>etcd</code>写入创建的Service的信息，而<code>kube-proxy</code>会基于监听的机制发现这种<code>Service</code>的变化，然后它会将最新的<code>Service</code>信息转换为对应的访问规则</li>
<li>假如：<code>10.97.97.97:80</code>是<code>service</code>提供的访问入口：当访问这个入口的时候，可以发现后面有三个<code>pod</code>的服务在等待调用，<code>kube-proxy</code>会基于<code>rr</code>（轮询）的策略，将请求分发到其中一个<code>pod</code>上去，这个规则会同时在集群内的所有节点上都生成，所以在任何一个节点上访问都可以</li>
<li><code>ClusterIP</code><!-- raw HTML omitted -->默认值：它是<code>kubernetes</code>系统自动分配的虚拟<code>IP</code>(<code>VIP</code>)，只能在集群内部（所有<code>Node</code>节点）访问<!-- raw HTML omitted --></li>
<li><code>NodePort</code><!-- raw HTML omitted -->：将<code>Service</code>通过指定的<code>Node</code>上的端口暴露给外部，通过此方法，就可以在集群外部访问（使用浏览器域名或<code>IP</code>端口访问）服务<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>创建的<code>Service</code>的<code>IP</code>地址只能在集群内部才可以访问，如果希望<code>Service</code>暴露给集群外部使用，那么就需要使用到另外一种类型的<code>Service</code>，称为<code>NodePort</code>类型的<code>Service</code>。<code>NodePort</code>的工作原理就是将<code>Service</code>的端口映射到<code>Node</code>的一个端口上，然后就可以通过<code>NodeIP:NodePort</code>来访问<code>Service</code>了</li>
</ul>
</blockquote>
<ul>
<li><code>LoadBalancer</code><!-- raw HTML omitted -->：使用外接负载均衡器完成到服务的负载分发，注意此模式需要外部云环境的支持<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code> LoadBalancer</code>和<code>NodePort</code>很相似，目的都是向外部暴露一个端口，区别在于<code>LoadBalancer</code>会在集群的外部再来做一个负载均衡设备，而这个设备需要外部环境的支持，外部服务发送到这个设备上的请求，会被设备负载之后转发到集群中</li>
</ul>
</blockquote>
<ul>
<li><code>ExternalName</code><!-- raw HTML omitted -->：把集群外部的服务引入集群内部，直接使用<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>ExternalName</code>类型的<code>Service</code>用于引入集群外部的服务，它通过<code>externalName</code>属性指定一个服务的地址，然后在集群内部访问此<code>Service</code>就可以访问到外部的服务了</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl explain service.spec.type  	<span style="color:#75715e"># </span></span></span></code></pre></div></blockquote>
<ul>
<li><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/Service/kubernetes-service-template.yaml" rel="external" target="_self"><code>Kubernetes Service Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1         </span> <span style="color:#75715e"># 版本</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service  </span> <span style="color:#75715e"># 类型</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:       <span style="color:#75715e"># 元数据</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">service-template       </span> <span style="color:#75715e"># Service 名字</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default   </span> <span style="color:#75715e"># 命名空间</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx        </span> <span style="color:#75715e"># Service 自己本身的标签</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:     <span style="color:#75715e"># 标签选择器，用于确定当前Service代理那些Pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-deploymen      </span> <span style="color:#75715e"># 所有匹配到这些标签的Pod 都可以进行访问</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">NodePort       </span> <span style="color:#75715e"># 指定Service的类型访问方式、ClusterIP、NodePort、ExternalName，NodePort支持集群外部访问，启用ingress设置：ClusterIP</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">externalName</span>: <span style="color:#ae81ff">www.baidu.com  </span> <span style="color:#75715e"># 改成IP地址也可以,只有type类型为：ExternalName，域名配置才生效</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">clusterIP</span>: <span style="color:#ae81ff">10.64.0.47</span>        <span style="color:#75715e"># 定service IP，不指定就随机生成，启用ingress设置为：None</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">sessionAffinity</span>: <span style="color:#ae81ff">None     </span> <span style="color:#75715e"># 分发策略、session亲和性，支持ClientIP、None两个选项，默认值为None</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:        <span style="color:#75715e"># 端口映射信息</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>          <span style="color:#75715e"># Service 端口，在使用内网IP访问时使用</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP      </span> <span style="color:#75715e"># 协议</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort </span>: <span style="color:#ae81ff">80</span>     <span style="color:#75715e"># 目标Pod端口，例如：deployment、statefulset等，Nginx：80，Tomcat：8080</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nodePort</span>: <span style="color:#ae81ff">30002</span>     <span style="color:#75715e"># 绑定到node主机上的端口(端口使用范围：30000~32767)，如果不指定，会默认分配，启用ingress删除此行</span></span></span></code></pre></div><ul>
<li><code>kube-proxy</code>目前支持的三种工作模式</li>
<li><code>userspace</code><!-- raw HTML omitted -->模式<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>userspace</code>模式下，<code>kube-proxy</code>会为每一个<code>Service</code>创建一个监听端口，发向<code>Cluster IP</code>的请求被<code>iptables</code>规则重定向到<code>kube-proxy</code>监听的端口上，<code>kube-proxy</code>根据<code>LB</code>算法（负载均衡算法）选择一个提供服务的<code>Pod</code>并和其建立连接，以便将请求转发到<code>Pod</code>上</li>
<li><code>userspace</code>模式下，<code>kube-proxy</code>充当了一个四层负载均衡器的角色。由于<code>kube-proxy</code>运行在<code>userspace</code>中，在进行转发处理的时候会增加内核和用户空间之间的数据拷贝，虽然比较稳定，但是效率非常低下</li>
</ul>
</blockquote>
<ul>
<li><code>iptables</code><!-- raw HTML omitted -->模式<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>iptables</code>模式下，<code>kube-proxy</code>为<code>Service</code>后端的每个<code>Pod</code>创建对应的<code>iptables</code>规则，直接将发向<code>Cluster IP</code>的请求重定向到一个<code>Pod</code>的<code>IP</code>上</li>
<li><code>iptables</code>模式下<code>kube-proxy</code>不承担四层负载均衡器的角色，只负责创建<code>iptables</code>规则。该模式的优点在于较<code>userspace</code>模式效率更高，但是不能提供灵活的<code>LB</code>策略，当后端<code>Pod</code>不可用的时候无法进行重试</li>
</ul>
</blockquote>
<ul>
<li><code>ipvs</code><!-- raw HTML omitted -->模式<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>
<p><code>ipvs</code>模式和<code>iptables</code>类似，<code>kube-proxy</code>监控<code>Pod</code>的变化并创建相应的<code>ipvs</code>规则。<code>ipvs</code>相对<code>iptables</code>转发效率更高，除此之外，<code>ipvs</code>支持更多的<code>LB</code>算法</p>
</li>
<li>
<p><code>ipvs</code><!-- raw HTML omitted -->的映射规则，<code>rr</code>表示轮询<!-- raw HTML omitted --></p>
</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ipvsadm -Ln  	<span style="color:#75715e"># 查看kube-proxy工作模式</span></span></span></code></pre></div></blockquote>
<ul>
<li>对<code>Service</code>的访问被分发到了后端的<code>Pod</code>上去，目前<code>kubernetes</code>提供了<!-- raw HTML omitted -->两种负载分发<!-- raw HTML omitted -->策略</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->默认使用<code>kube-proxy</code>的策略，比如随机、轮询等<!-- raw HTML omitted --></li>
<li><code>sessionAffinity</code>：基于客户端地址的会话保持模式，即来自同一个客户端发起的所有请求都会转发到固定的一个<code>Pod</code>上，这对于传统基于<code>Session</code>的认证项目来说很友好，此模式可以在<code>spec</code>中添加<code>sessionAffinity: ClusterIP</code>选项</li>
</ul>
</blockquote>
<ul>
<li><code>HeadLiness</code>类型负载均的<code>Service</code></li>
</ul>
<blockquote>
<ul>
<li>在某些场景中，开发人员可能不想使用<code>Service</code>提供的负载均衡功能，而希望自己来控制负载均衡策略，针对这种情况，<code>kubernetes</code>提供了<code>HeadLinesss Service</code>，这类<code>Service不</code>会分配<code>Cluster IP</code>，如果想要访问<code>Service</code>，只能通过<code>Service</code>的域名进行查询</li>
<li><code>clusterIP: None</code>：将<code>clusterIP</code>设置为<code>None</code>，即可创建<code>headliness Service</code></li>
</ul>
</blockquote>
</blockquote>
<hr>
<h3 id="endpoint类型控制器"><code>Endpoint</code>类型控制器</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->实际中使用的不多<!-- raw HTML omitted --></li>
<li><code>Endpoint</code>：是<code>kubernete</code>中的一个资源对象，存储在<code>etcd</code>中，用来记录一个<code>service</code>对应的所有<code>Pod</code>的访问地址，它是根据<code>service</code>配置文件中的<code>selector</code>描述产生的</li>
<li>一个<code>service</code>由一组<code>Pod</code>组成，这些<code>Pod</code>通过<code>Endpoints</code>暴露出来，<code>Endpoints</code>是实现实际服务的端点集合。换言之<code>servic</code>和<code>Pod</code>之间的联系是通过<code>Endpoints</code>实现的</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl describe svc nginx-service -n app  
</span></span><span style="display:flex;"><span>$ kubectl get endpoints -n dev -o wide  </span></span></code></pre></div><ul>
<li><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/EndPoint/kubernetes-endpoint-template.yaml" rel="external" target="_self"><code>Kubernetes Endpoint Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Endpoints</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">endpoints-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx        </span> <span style="color:#75715e"># 标签和Service 里的labels一致</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subsets</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">addresses</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">ip</span>: <span style="color:#ae81ff">23.41.187.94</span>    <span style="color:#75715e"># 目标IP地址</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:        <span style="color:#75715e"># 与 Service一致</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1         </span> <span style="color:#75715e"># 版本</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service  </span> <span style="color:#75715e"># 类型</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:       <span style="color:#75715e"># 元数据</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">service-template       </span> <span style="color:#75715e"># Service 名字</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default   </span> <span style="color:#75715e"># 命名空间</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx        </span> <span style="color:#75715e"># Service 自己本身的标签</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP       </span> <span style="color:#75715e"># 指定Service的类型访问方式、ClusterIP、NodePort、ExternalName</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">sessionAffinity</span>: <span style="color:#ae81ff">None        </span> <span style="color:#75715e"># 分发策略、session亲和性，支持ClientIP、None两个选项，默认值为None</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:        <span style="color:#75715e"># 端口映射信息</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>          <span style="color:#75715e"># Service 端口，在使用内网IP访问时使用</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP      </span> <span style="color:#75715e"># 协议</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort </span>: <span style="color:#ae81ff">80</span>     <span style="color:#75715e"># 目标Pod端口，例如：deployment、statefulset等</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="job类型控制器"><code>Job</code>类型控制器</h3>
<blockquote>
<ul>
<li><code>Job</code><!-- raw HTML omitted -->主要用于负责批量处理短暂的一次性任务<!-- raw HTML omitted --></li>
<li><code>Job</code><!-- raw HTML omitted -->特点<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>当<code>Job</code>创建的<code>Pod</code>执行成功结束时，<code>Job</code>将记录成功结束的<code>Pod</code>数量</li>
<li>当成功结束的<code>Pod</code>达到指定的数量时，<code>Job</code>将完成执行</li>
</ul>
</blockquote>
<ul>
<li><code>Job</code><!-- raw HTML omitted -->模板使用重启策略定义<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->设置为：<!-- raw HTML omitted --><code>OnFailure</code>，<code> Job</code>会在<code>Pod</code>出现故障的时候重启容器，而不是创建<code>Pod</code>，<code>failed</code>次数不变</li>
<li><!-- raw HTML omitted -->设置为：<!-- raw HTML omitted --><code>Never</code>，<code>Job</code>会在<code>Pod</code>出现故障的时候创建新的<code>Pod</code>，并且故障<code>Pod</code>不会消失也不会重启，<code>failed</code>次数+1</li>
<li><!-- raw HTML omitted -->设置为：<!-- raw HTML omitted --><code>Always</code>，意味<code>Job</code>一直重启，意味<code>Pod</code>任务会重复执行，这和<code>Job</code>的定义冲突，所以不能设置为<code>Always</code></li>
</ul>
</blockquote>
<ul>
<li><code>Job</code><!-- raw HTML omitted -->资源清单<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">batch/v1  	# 版本号</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Job  	# 类型</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:  	<span style="color:#75715e"># 元数据</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">name</span>: <span style="color:#ae81ff">job-template  	# 名称</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">namespace</span>:  <span style="color:#ae81ff">default  	# 命名空间</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">labels</span>:  	<span style="color:#75715e"># 标签</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">controller</span>: <span style="color:#ae81ff">job</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:  	<span style="color:#75715e"># 详情描述</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">completions</span>: <span style="color:#ae81ff">1</span>  	<span style="color:#75715e"># 指定Job需要成功运行Pod的总次数，默认为1</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">parallelism</span>: <span style="color:#ae81ff">1</span>  	<span style="color:#75715e"># 指定Job在任一时刻应该并发运行Pod的数量，默认为1</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">activeDeadlineSeconds</span>: <span style="color:#ae81ff">30</span>  	<span style="color:#75715e"># 指定Job可以运行的时间期限，超过时间还没结束，系统将会尝试进行终止</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">backoffLimit</span>: <span style="color:#ae81ff">6</span>  	<span style="color:#75715e"># 指定Job失败后进行重试的次数，默认为6</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">manualSelector</span>: <span style="color:#66d9ef">true</span>  	<span style="color:#75715e"># 是否可以使用selector选择器选择Pod，默认为false</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">selector</span>:  	<span style="color:#75715e"># 选择器，通过它指定该控制器管理那些Pod</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">matchLabels</span>:  	<span style="color:#75715e"># Labels匹配规则</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">app</span>: <span style="color:#ae81ff">counter-pod</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">matchExpressions</span>:  	<span style="color:#75715e"># Expressions匹配规则</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">app</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">In</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">values</span>:
</span></span><span style="display:flex;"><span>              - <span style="color:#ae81ff">counter-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">template</span>:  	<span style="color:#75715e"># 模板，当副本数量不足时，会根据下面的模板创建Pod模板</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">app</span>: <span style="color:#ae81ff">counter-pod</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">restartPolicy</span>: <span style="color:#ae81ff">Never  	# 重启策略只能设置为Never或OnFailure</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>                - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">counter</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;for i in 9 8 7 6 5 4 3 2 1;do echo $i;sleep 20;done&#34;</span>]</span></span></code></pre></div></blockquote>
<hr>
<h3 id="cronjob类型控制器"><code>CronJob</code>类型控制器</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted --><code>CronJob</code>控制器<!-- raw HTML omitted -->：以<code>Job</code>控制器为其管控对象，并借助它管理<code>Pod</code>资源对象，<code>Job</code>控制器定义的作业任务在其控制器资源创建之后便会立即执行，但<code>CronJob</code>可以以类似<code>Linux</code>操作系统的周期性任务作业计划的方式控制器运行时间点及重复运行的方式，换言之，<code>CronJob</code>可以在特定的时间点反复去执行<code>Job</code>任务</li>
<li><code>schedule：cron</code><!-- raw HTML omitted -->表达式，用于指定任务的执行时间<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>/1  *</code><!-- raw HTML omitted -->：表示分钟  小时  日  月份  星期<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->分钟值从<code>0</code>到<!-- raw HTML omitted --><code>59</code></li>
<li><!-- raw HTML omitted -->小时值从<code>0</code>到<!-- raw HTML omitted --><code>23</code></li>
<li><!-- raw HTML omitted -->日(天)的值从<code>1</code>到<!-- raw HTML omitted --><code>31</code></li>
<li><!-- raw HTML omitted -->月的值从<code>1</code>到<!-- raw HTML omitted --><code>12</code></li>
<li><!-- raw HTML omitted -->星期的值从<code>0</code>到<code>6</code>，<!-- raw HTML omitted --><code>0</code><!-- raw HTML omitted -->表示星期日<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->多个时间可以用逗号隔开，范围可以用连字符给出：* 可以作为通配符，/表示每&hellip;<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li><code>concurrencyPolicy</code><!-- raw HTML omitted -->并发执行策略<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>Allow</code><!-- raw HTML omitted -->：运行<code>Job</code>并发调度（默认）<!-- raw HTML omitted --></li>
<li><code>Forbid</code><!-- raw HTML omitted -->：禁止并发运行，如果之前的任务没完成，则跳过，直接执行新的<!-- raw HTML omitted --></li>
<li><code>Replace</code><!-- raw HTML omitted -->：替换，取消当前正在运行的作业并使用新作业替换它<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/kubernetes-cronjob-template.yaml" rel="external" target="_self"><code>Kubernetes CronJob Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">batch/v1   </span> <span style="color:#75715e"># 版本号</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">CronJob  </span> <span style="color:#75715e"># 类型</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:       <span style="color:#75715e"># 元数据</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cronjob-template       </span> <span style="color:#75715e"># 名称</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default   </span> <span style="color:#75715e"># 命名空间</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">controller</span>: <span style="color:#ae81ff">cronjob</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:   <span style="color:#75715e"># 详情描述</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">concurrencyPolicy</span>: <span style="color:#ae81ff">Allow   </span> <span style="color:#75715e"># 并发执行策略，Allow：并发调度，</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">failedJobsHistoryLimit</span>: <span style="color:#ae81ff">1</span>   <span style="color:#75715e"># 保留多少个失败的任务，默认为1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">successfulJobsHistoryLimit</span>: <span style="color:#ae81ff">3</span>   <span style="color:#75715e"># 保留多少个成功的任务，默认为3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># startingDeadlineSeconds: 30   # 间隔多长时间检测失败的任务并重新执行，时间不能小于：10</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">suspend</span>: <span style="color:#66d9ef">false</span>    <span style="color:#75715e"># 是否挂起任务，若为：true 则该任务不执行</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">schedule</span>: <span style="color:#e6db74">&#34;*/1 * * * * &#34;</span>    <span style="color:#75715e"># cron格式的作业调度运行时间点，用于控制任务任务时间执行</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">jobTemplate</span>:          <span style="color:#75715e"># job控制器模板，用于为cronjob控制器生成job对象，下面其实就是job的定义</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">completions</span>: <span style="color:#ae81ff">1</span>    <span style="color:#75715e"># 指定Job需要成功运行Pod的总次数，默认为1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">parallelism</span>: <span style="color:#ae81ff">1</span>    <span style="color:#75715e"># 指定Job在任一时刻应该并发运行Pod的数量，默认为1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">activeDeadlineSeconds</span>: <span style="color:#ae81ff">30</span>         <span style="color:#75715e"># 指定Job可以运行的时间期限，超过时间还没结束，系统将会尝试进行终止</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">backoffLimit</span>: <span style="color:#ae81ff">6</span>   <span style="color:#75715e"># 指定Job失败后进行重试的次数，默认为6</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">template</span>:         <span style="color:#75715e"># 模板，当副本数量不足时，会根据下面的模板创建Pod模板</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">restartPolicy</span>: <span style="color:#ae81ff">Never         </span> <span style="color:#75715e"># 重启策略只能设置为Never或OnFailure</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">container-name</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">command</span>: [ <span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;for i in 9 8 7 6 5 4 3 2 1;do echo $i;sleep 20;done&#34;</span> ]</span></span></code></pre></div></blockquote>
<hr>
<h3 id="模板详细描述">模板详细描述</h3>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/bitnami/" rel="external" target="_self"><code>Bitnami</code>模板库</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/bitnami/charts/tree/main/bitnami" rel="external" target="_self"><code>Kubernetes</code>的<code>Bitnami</code>库</a></td>
<td><code>Helm</code>安装<code>Kubernetes</code>服务<code>Zabbix</code>、<code>Redis</code>、<code>Mysql</code>模板</td>
</tr>
<tr>
<td><a href="https://github.com/bitnami/charts-docs/tree/main/charts" rel="external" target="_self"><code>Kubernetes</code>的<code>Charts-docs</code>库</a></td>
<td><code>Helm</code>安装<code>Kubernetes</code>服务<code>Zabbix</code>、<code>Redis</code>、<code>Mysql</code>模板</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/kubernetes-template.yaml" rel="external" target="_self"><code>Kubernetes Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1   </span> <span style="color:#75715e"># 版本号，例如v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment   </span> <span style="color:#75715e"># 资源类型，例如 Pod、Deployment、Service、ReplicaSet、StatefulSet</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:   <span style="color:#75715e"># POd相关的元数据，用于描述Pod数据</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">java-demo  </span> <span style="color:#75715e"># Pod名称、在同一个名称空间内不能重复</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">string  </span> <span style="color:#75715e"># Pod所属的命名空间,默认为&#34;default&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:   <span style="color:#75715e"># 定义Pod的标签，只能使用字符串类型：string</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">java-demo  </span> <span style="color:#75715e"># 自定义label标签，key(键)为：name，value(值)为：java-demo</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v1.1.0  </span> <span style="color:#75715e"># 自定义版本</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">annotations</span>:    <span style="color:#75715e"># 注释，不能作为被筛选</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">java-demo</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:   <span style="color:#75715e"># Pod中容器的详细定义</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>   <span style="color:#75715e"># 创建的副本数量</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">revisionHistoryLimit</span>: <span style="color:#ae81ff">10</span>    <span style="color:#75715e"># 滚动更新后保留的历史版本数</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:   <span style="color:#75715e"># 选择器，用于找到匹配的 ReplicaSet(副本)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:    <span style="color:#75715e"># 按照Labels标签匹配副本</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">java-demo  </span> <span style="color:#75715e"># 匹配的key，value</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v1.1.0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">strategy</span>:   <span style="color:#75715e"># 更新策略，StatefulSet更新使用：updateStrategy</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>:    <span style="color:#75715e"># 滚动更新配置</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">partition</span>: <span style="color:#ae81ff">3</span>    <span style="color:#75715e"># 实现灰度/金丝雀发布，按序号更新，更新大于等于3的序号，不和百分比共用</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxSurge</span>: <span style="color:#ae81ff">25</span><span style="color:#ae81ff">%  </span> <span style="color:#75715e"># 多少个/百分之多少Pods处于更新，数值越大更新越快，不稳定</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">25</span><span style="color:#ae81ff">%  </span> <span style="color:#75715e"># 多少个/百分之多少Pods处于关闭，数值越小更新慢，稳定</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate  </span> <span style="color:#75715e"># 更新类型选择器，采用滚动更新，OnDelete：方式更新，删除pods时更新</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:   <span style="color:#75715e"># Pod 模板</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:   <span style="color:#75715e"># Pod 的元信息</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:   <span style="color:#75715e"># Pod 的标签 </span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">java-demo</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v1.1.0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:   <span style="color:#75715e"># Pod的期望信息</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nodeName</span>: <span style="color:#ae81ff">k8s-node1  </span> <span style="color:#75715e"># 设置NodeName表示将该Pod调度到指定到名称的node节点上</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nodeSelector</span>: <span style="color:#ae81ff">obeject  </span> <span style="color:#75715e"># 设置NodeSelector表示将该Pod调度到包含这个label的node上</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">hostNetwork</span>: <span style="color:#66d9ef">false</span>    <span style="color:#75715e"># 是否使用主机网络模式，默认为false，如果设置为true，表示使用宿主机网络</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">tolerations</span>:  	<span style="color:#75715e"># 容忍配置</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">effect</span>: <span style="color:#e6db74">&#34;污点的类型&#34;</span>  <span style="color:#75715e"># Noschedule</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">key</span>: <span style="color:#e6db74">&#34;污点的Key&#34;</span>  	<span style="color:#75715e"># 污点的Key</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">operate</span>: <span style="color:#e6db74">&#34;Equal&#34;</span>  	<span style="color:#75715e"># Exists：匹配Key，Equal添加：value配置，</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;污点的value&#34;</span>  	<span style="color:#75715e"># 污点的value</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullSecrets</span>:   <span style="color:#75715e"># 配置登录 docker registry 的 secret 仓库</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">docker-harbor  </span> <span style="color:#75715e"># 指定使用的secret库房名称</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:   <span style="color:#75715e"># 对于 Pod中容器描述</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">tomcat-demo  </span> <span style="color:#75715e"># 指定容器名称，不可更新</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">192.168.80.210</span>:<span style="color:#ae81ff">8080</span><span style="color:#ae81ff">/test/tomcat-demo:v1   </span> <span style="color:#75715e"># 镜像仓库地址</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">imagePullPolicy</span>: [ <span style="color:#ae81ff">Always | Never | IfNotPresent ]   </span> <span style="color:#75715e"># 镜像拉取方式</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">command</span>: [<span style="color:#ae81ff">string]  </span> <span style="color:#75715e"># 以数组方式指定容器启动命令列表，如不指定，使用打包时使用的启动命令</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">args</span>:   <span style="color:#75715e"># 以数组方式指定容器启动命令参数列表，替代docker的CMD指令</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">/bin/sh</span>
</span></span><span style="display:flex;"><span>        - -<span style="color:#ae81ff">c</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">touch /tmp/healthy; sleep 30; rm -fr /tmp/healthy; sleep 600   </span> <span style="color:#75715e"># 不能超过探针执行时间</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">workingDir</span>: <span style="color:#ae81ff">string   </span> <span style="color:#75715e"># 容器启动后进入的工作目录，不指定则使用镜像默认值</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">volumeMounts</span>:   <span style="color:#75715e"># 挂载到容器内部的存储卷配置</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">data   </span> <span style="color:#75715e"># 引用pod定义的共享存储卷的名称，需用volumes[]部分定义的的卷名</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/opt/data   </span> <span style="color:#75715e"># 存储卷在容器内mount的绝对路径，应少于512字符</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">readOnly</span>: <span style="color:#ae81ff">boolean  </span> <span style="color:#75715e"># 是否为只读模式</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:    <span style="color:#75715e"># 需要暴露的端口库号列表</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http   </span> <span style="color:#75715e"># 为端口取名，该名称可以在service种被引用</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">int   </span> <span style="color:#75715e"># 容器需要监听的端口号</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">hostPort</span>: <span style="color:#ae81ff">int  </span> <span style="color:#75715e"># 容器所在主机需要监听的端口号，默认与Container相同</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP  </span> <span style="color:#75715e"># 端口协议，支持TCP和UDP，默认TCP</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">80</span>    <span style="color:#75715e"># Pod 本身服务端口，比如Nginx：80，Tomcat：8080</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">nodePort</span>: <span style="color:#ae81ff">30001</span>   <span style="color:#75715e"># 节点对外端口</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">env</span>:    <span style="color:#75715e"># 容器运行前需设置的环境变量列表</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">JAVA_OPTS  </span> <span style="color:#75715e"># 环境变量名称</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;-Xmx1g&#34;</span>   <span style="color:#75715e"># 环境变量的值</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">resources</span>:    <span style="color:#75715e"># 资源限制和请求的设置</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">limits</span>:   <span style="color:#75715e"># 限定Pod最大使用硬件资源、通常设置cpu和memory</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#e6db74">&#34;1&#34;</span>    <span style="color:#75715e"># Cpu的限制，单位为core数，将用于docker run --cpu-shares参数，1000m等于一个核心</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#e6db74">&#34;1Gi&#34;</span>   <span style="color:#75715e"># 内存限制，单位可以为Mib/Gib，将用于docker run --memory参数</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">requests</span>:   <span style="color:#75715e"># 最低资源要求，在scheduler中被用到，通常设置cpu和memory</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#e6db74">&#34;0.5&#34;</span>    <span style="color:#75715e"># 限定使用几个核心CPU、容器启动的初始可用数量</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#e6db74">&#34;256Mi&#34;</span>   <span style="color:#75715e"># 设定使用内存、容器启动的初始可用数量</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">lifecycle</span>:    <span style="color:#75715e"># 生命周期钩子</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">postStart</span>:    <span style="color:#75715e"># 容器启动后立即执行此钩子,如果执行失败,会根据重启策略进行重启</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">exec</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;echo Hello from the postStart handler &gt;/usr/share/message&#34;</span>]
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">preStop</span>:    <span style="color:#75715e"># 容器终止前执行此钩子,无论结果如何,容器都会终止</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">exec</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;nginx -s quit; while killall -0 nginx; do sleep 1; done&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">startupProbe</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">tcpSocket</span>:    <span style="color:#75715e"># 使用TcpSocket、httpGet健康检查</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8010</span>    <span style="color:#75715e"># 探测8010端口</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">5</span>   <span style="color:#75715e"># 检测失败5次表示未就绪</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">60</span>   <span style="color:#75715e"># 指定容器启动60s之后开始执行Liveness探测，</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>   <span style="color:#75715e"># 指定每10秒执行一次Liveness探测。</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>   <span style="color:#75715e"># 检查成功为2次表示就绪</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span>   <span style="color:#75715e"># 检测失败1次表示未就绪</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">livenessProbe</span>:    <span style="color:#75715e"># 对Pod内各容器健康检查的设置，当探测无响应几次后将自动重启该容器</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">exec</span>:   <span style="color:#75715e"># 对Pod容器内检查方式设置为exec方式</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">command</span>:    <span style="color:#75715e"># exec方式需要制定的命令或脚本</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">sh</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">c</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#e6db74">&#34;sleep 5; echo &#39;success&#39;;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">httpGet</span>:    <span style="color:#75715e"># 对Pod内个容器健康检查方法设置为HttpGet，需要制定Path、port</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/  </span> <span style="color:#75715e"># URI地址：http://:80/index.html</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8010</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">host</span>: <span style="color:#ae81ff">192.168.109.100</span>   <span style="color:#75715e"># 主机地址</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTP   </span> <span style="color:#75715e"># 支持的协议，http或者https</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">HttpHeaders</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">string</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">value</span>: <span style="color:#ae81ff">string(字符串)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">tcpSocket</span>:    <span style="color:#75715e"># 对Pod内个容器健康检查方式设置为tcpSocket方式</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8010</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">60</span>   <span style="color:#75715e"># 容器启动完成后首次探测的时间，单位为秒</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span>   <span style="color:#75715e"># 对容器健康检查探测等待响应的超时时间，单位秒，默认1秒</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>   <span style="color:#75715e"># 对容器监控检查的定期探测时间设置，单位秒，默认10秒一次</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>   <span style="color:#75715e"># 配置为：1，表示检查一次成功就成功，配置为：3，表示检查3次</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">5</span>   <span style="color:#75715e"># 失败次数，检查5次失败表示失败</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">securityContext</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">privileged</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">restartPolicy</span>: [<span style="color:#ae81ff">Always | Never | OnFailure]  </span> <span style="color:#75715e"># Pod的重启策略</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">terminationGracePeriodSeconds</span>: <span style="color:#ae81ff">30</span>   <span style="color:#75715e"># 删除pods、deployment后等待时间</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumes</span>:    <span style="color:#75715e"># 在该pod上定义共享存储卷列表</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume  </span> <span style="color:#75715e"># 共享存储卷名称 （volumes类型有很多种）</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">emptyDir</span>: {}    <span style="color:#75715e"># 类型为emtyDir的存储卷，与Pod同生命周期的一个临时目录。为空值</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">hostPath</span>:   <span style="color:#75715e"># 类型为hostPath的存储卷，表示挂载Pod所在宿主机的目录</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/root/logs   </span> <span style="color:#75715e"># Pod所在宿主机的目录，将被用于同期中mount的目录</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">type</span>: <span style="color:#ae81ff">DirectoryOrCreate  </span> <span style="color:#75715e"># 目录存在就使用，不存在就先创建再使用</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">secret</span>:   <span style="color:#75715e"># 类型为secret的存储卷，挂载集群与定义的secret对象到容器内部</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">scretname</span>: <span style="color:#ae81ff">secret</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">items</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">string</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">configMap</span>:    <span style="color:#75715e"># 类型为configMap的存储卷，挂载预定义的configMap对象到容器内部</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">configmap</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">items</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">string</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">string</span></span></span></code></pre></div></blockquote>
<hr>
<h4 id="编写适用java的yaml">编写适用<code>Java</code>的<code>yaml</code></h4>
<ul>
<li>
<ol>
<li>下载<code>java demo</code>代码</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git clone https://github.com/frankinbj/tomcat-java-demo.git     </span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->修改连接数据库配置文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;tomcat-java-demo/src/main/resources/application.yml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">datasource:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    url: jdbc:mysql://192.168.80.215:3306/test?characterEncoding=utf-8
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    username: admin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    password: admin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li>打包<code>java war</code>包</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /opt/tomcat-java-demo/
</span></span><span style="display:flex;"><span>$ mvn clean package -Dmaven.test.skip<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成war包</span>
</span></span><span style="display:flex;"><span>$ ll /opt/tomcat-java-demo/target/ly-simple-tomcat-0.0.1-SNAPSHOT.war</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->把数据导入数据库，创建授权连接用户<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mysql -uroot -p &lt; tomcat-java-demo/doc/db/tables_ly_tomcat.sql
</span></span><span style="display:flex;"><span>$ grant all privileges on *.* to admin@<span style="color:#e6db74">&#39;%&#39;</span> identified by <span style="color:#e6db74">&#39;admin&#39;</span>;</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><code>JDK</code>、<code>Maven</code><!-- raw HTML omitted -->配置环境变量<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;#####  	JDK 環境變數  	#####
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export JAVA_HOME=/usr/local/jdk
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export JRE_HOME=</span><span style="color:#e6db74">${</span>JAVA_HOME<span style="color:#e6db74">}</span><span style="color:#e6db74">/jre
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export CLASSPATH=</span><span style="color:#e6db74">${</span>JAVA_HOME<span style="color:#e6db74">}</span><span style="color:#e6db74">/lib:</span><span style="color:#e6db74">${</span>JAVA_HOME<span style="color:#e6db74">}</span><span style="color:#e6db74">/lib/tools.jar
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export PATH=</span><span style="color:#e6db74">${</span>PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">:</span><span style="color:#e6db74">${</span>JAVA_HOME<span style="color:#e6db74">}</span><span style="color:#e6db74">/bin:</span><span style="color:#e6db74">${</span>JAVA_HOME<span style="color:#e6db74">}</span><span style="color:#e6db74">/jre/bin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export PATH=</span><span style="color:#e6db74">${</span>PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">:/usr/local/maven/bin &#34;</span>&gt;&gt;/etc/profile</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="6">
<li>修改<code>Dockerfile</code>配置文件，<code>docker build</code>成镜像</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>6.1 使用<code>Tomcat</code>服务打包启动容器</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/tomcat-java-demo/Dockerfile<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">FROM lizhenliang/tomcat
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">RUN rm -rf /usr/local/tomcat/webapps/*
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ADD target/*.war /usr/local/tomcat/webapps/ROOT.war
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 声明时区
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">RUN ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp; echo &#39;Asia/Shanghai&#39; &gt;/etc/timezone
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li>6.2 使用<code>java -jar</code><!-- raw HTML omitted -->打包镜像，可以使用<!-- raw HTML omitted --><code>xxl-job</code>的<code>jar</code>包</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> openjdk</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">VOLUME</span><span style="color:#e6db74"> /tmp</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> ./target/live-server-1.0.0-SNAPSHOT.jar live-server-1.0.0-SNAPSHOT.jar<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> bash -c <span style="color:#e6db74">&#34;touch /live-server-1.0.0-SNAPSHOT.jar&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># 声明时区</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime <span style="color:#f92672">&amp;&amp;</span> echo <span style="color:#e6db74">&#39;Asia/Shanghai&#39;</span> &gt;/etc/timezone<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># 声明运行时容器提供服务端口，运行时不会开启这个端口的服务，需要把端口映射</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 8080</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [<span style="color:#e6db74">&#34;java&#34;</span>,<span style="color:#e6db74">&#34;-jar&#34;</span>,<span style="color:#e6db74">&#34;/live-server-1.0.0-SNAPSHOT.jar&#34;</span>]</span></span></code></pre></div><ul>
<li>6.3 生成<code>docker images：</code>镜像并推送到私人仓库</li>
</ul>
<blockquote>
<ul>
<li>
<p><code>-t,--tag list</code>：镜像名称</p>
</li>
<li>
<p><code>-f，--file string</code>：如果文件名不是<code>Dockerfile</code>，<code>-f</code>可以指定其他文件</p>
</li>
<li>
<p><code>192.168.80.210:8080</code>：私人仓库地址</p>
</li>
<li>
<p><code>test</code>：私人仓库名</p>
</li>
<li>
<p><code>tomcat-demo:v1</code>：定义镜像名称以及版本</p>
</li>
<li>
<p>如果打包报错：<code>epository does not exist,</code>更换<code>Dockerfile</code>的<code>FROM</code>源地址</p>
</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /opt/tomcat-java-demo/
</span></span><span style="display:flex;"><span>$ docker build -t 192.168.80.210:8080/test/tomcat-demo:v1 .  	<span style="color:#75715e"># 打包镜像</span>
</span></span><span style="display:flex;"><span>$ docker push 192.168.80.210:8080/test/tomcat-demo:v1  	<span style="color:#75715e"># 推送到私人仓库 </span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h4 id="部署elk日志服务">部署<code>ELK</code>日志服务</h4>
<blockquote>
<ul>
<li><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/devops/Logs/kubernetes-elasticsearch.yaml" rel="external" target="_self"><code>Kubernetes Elasticsearch Template</code>模板</a></li>
<li><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/devops/Logs/kubernetes-logstash.yaml" rel="external" target="_self"><code>Kubernetes Logstash Template</code>模板</a></li>
<li><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/devops/Logs/kubernetes-filebeat.yaml" rel="external" target="_self"><code>Kubernetes Filebeat Template</code>模板</a></li>
<li><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/devops/Logs/kubernetes-kibana.yaml" rel="external" target="_self"><code>Kubernetes Kibana Template</code>模板</a></li>
</ul>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

        </div>
      </main>
    </div>
    <script src="../../../../js/clipboard.min.js?1721045975" defer></script>
    <script src="../../../../js/perfect-scrollbar.min.js?1721045975" defer></script>
    <script src="../../../../js/d3/d3-color.min.js?1721045975" defer></script>
    <script src="../../../../js/d3/d3-dispatch.min.js?1721045975" defer></script>
    <script src="../../../../js/d3/d3-drag.min.js?1721045975" defer></script>
    <script src="../../../../js/d3/d3-ease.min.js?1721045975" defer></script>
    <script src="../../../../js/d3/d3-interpolate.min.js?1721045975" defer></script>
    <script src="../../../../js/d3/d3-selection.min.js?1721045975" defer></script>
    <script src="../../../../js/d3/d3-timer.min.js?1721045975" defer></script>
    <script src="../../../../js/d3/d3-transition.min.js?1721045975" defer></script>
    <script src="../../../../js/d3/d3-zoom.min.js?1721045975" defer></script>
    <script src="../../../../js/js-yaml.min.js?1721045975" defer></script>
    <script src="../../../../js/mermaid.min.js?1721045975" defer></script>
    <script>
      window.themeUseMermaid = JSON.parse("{ \"securityLevel\": \"loose\" }");
    </script>
    <script src="../../../../js/theme.js?1721045975" defer></script>
  </body>
</html>
