<!doctype html><html lang=zh-CN data-theme=light><head><meta charset=UTF-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: light)"><meta name=generator content="Hugo 0.125.4"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_16x16_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_32_32_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="Configure K8s Auth"><meta itemprop=description content="Configure-K8s-Auth"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://erge.blog/imgs/s2-1.jpg"><meta itemprop=keywords content="Kubernetes,Authenticating"><meta property="og:type" content="article"><meta property="og:title" content="Configure K8s Auth"><meta property="og:description" content="Configure-K8s-Auth"><meta property="og:image" content="/imgs/s2-1.jpg"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="https://erge.blog/systems/linux/kubernetes/configure-k8s-auth/"><meta property="og:site_name" content="二哥"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="二哥"><meta property="article:published_time" content="2022-05-30 17:46:41 +0800 CST"><meta property="article:modified_time" content="2022-11-14 17:46:41 +0800 CST"><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.css><link rel=stylesheet href=/css/main.min.0d420b6f564e6674edd4354ea71c0458a83f95ad464a75114b23d72515b1456c.css><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":true,"isHome":false,"isPage":true,"path":"configure-k8s-auth","permalink":"https://erge.blog/systems/linux/kubernetes/configure-k8s-auth/","title":"Configure K8s Auth","waline":{"js":[{"alias":"waline","alias_name":"@waline/client","file":"dist/pageview.js","name":"pageview","version":"2.13.0"},{"alias":"waline","alias_name":"@waline/client","file":"dist/comment.js","name":"comment","version":"2.13.0"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>Configure K8s Auth - 二哥</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>二哥</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>Linux、Kubernetes、Docker、Python、CI/CD、Jenkins、Mysql、Nginx、Gitlab、Ansible、Zabbix</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-Home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-categories"><a href=/categories/ class=hvr-icon-pulse rel=section><i class="fa fa-th hvr-icon"></i>分类</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档
<span class=badge>0</span></a></li><li class="menu-item menu-item-tags"><a href=/tags/ class=hvr-icon-pulse rel=section><i class="fa fa-tags hvr-icon"></i>标签</a></li><li class="menu-item menu-item-tools"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-tools hvr-icon"></i>工具</a></li><li class="menu-item menu-item-flinks"><a href=/flinks.html class=hvr-icon-pulse rel=section><i class="fa fa-thumbs-up hvr-icon"></i>站点示例</a></li><li class="menu-item menu-item-about"><a href=/about.html class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-Commonweal"><a href=/404.html class=hvr-icon-pulse rel=section><i class="fa fa-heartbeat hvr-icon"></i>公益 404</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#安全控制>安全控制</a><ul><li><a href=#访问控制>访问控制</a></li><li><a href=#认证授权和准入控制>认证、授权和准入控制</a><ul><li><a href=#认证管理>认证管理</a></li><li><a href=#授权管理>授权管理</a></li><li><a href=#准入控制>准入控制</a></li></ul></li><li><a href=#rbac实战><code>RBAC</code>实战</a><ul><li><a href=#rolebindingfont-colorred引用fontclusterrolefont-colorred进行授权font><code>RoleBinding</code><font color=red>引用</font><code>ClusterRole</code><font color=red>进行授权</font></a></li><li><a href=#font-colorred创建fontrolefont-colorred和fontrolebindingfont-colorred为fontuser-namefont-colorred授权font><font color=red>创建</font><code>Role</code><font color=red>和</font><code>RoleBinding</code><font color=red>，为</font><code>user-name</code><font color=red>授权</font></a></li></ul></li></ul></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=二哥 src=/imgs/img-lazy-loading.gif data-src=/imgs/s2-1.jpg><p class=site-author-name itemprop=name>二哥</p><div class=site-description itemprop=description>The man who has made up his mind to win will never say impossible – Napoleon Bonaparte</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>0</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>51</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>150</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=qq%e5%8f%b7 title="QQ → qq号" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-qq fa-fw hvr-icon"></i>
QQ
</a></span><span class=links-of-social-item><a href=https://www.zhihu.com/people/lisenhui title="知乎 → https://www.zhihu.com/people/lisenhui" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-book fa-fw hvr-icon"></i>
知乎
</a></span><span class=links-of-social-item><a href=qq@qq.com title="E-Mail → qq@qq.com" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-envelope fa-fw hvr-icon"></i>
E-Mail
</a></span><span class=links-of-social-item><a href=https://weibo.com/yourname title="Weibo → https://weibo.com/yourname" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-weibo fa-fw hvr-icon"></i>
Weibo
</a></span><span class=links-of-social-item><a href="https://www.youtube.com/watch?v=RgKAFK5djSk" title="Youtube → https://www.youtube.com/watch?v=RgKAFK5djSk" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-youtube fa-fw hvr-icon"></i>
Youtube
</a></span><span class=links-of-social-item><a href=https://github.com/elkan1788 title="Github → https://github.com/elkan1788" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Github</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=共享知识><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt=共享知识></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://gitee.com/hugo-next/hugo-theme-next title=https://gitee.com/hugo-next/hugo-theme-next target=_blank>Hugo-NexT</a></li><li class=links-of-blogroll-item><a href=https://lisenhui.cn title=https://lisenhui.cn target=_blank>凡梦星尘空间站</a></li></ul></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>网站资讯</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>已运行：</div><div class=item-count id=runTimes data-publishdate></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>总访客数：</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>页面浏览：</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>总字数：</div><div class=item-count id=wordsCount data-count></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>阅读约：</div><div class=item-count id=readTimes data-times></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>最后更新于：</div><div class=item-count id=last-push-date data-lastpushdate></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-comments class="button goto-comments" title=直达评论><i class="fas fa-comments"></i></div><div id=goto-gtranslate class=button title=多语言翻译><i class="fas fa-globe"></i></div><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a><a href=https://github.com/hugo-next rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg>
</a><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script><script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://erge.blog/systems/linux/kubernetes/configure-k8s-auth/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/s2-1.jpg"><meta itemprop=name content="二哥"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="二哥"><meta itemprop=description content="The man who has made up his mind to win will never say impossible – Napoleon Bonaparte"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="Configure K8s Auth"><meta itemprop=description content="Configure-K8s-Auth"></span><header class=post-header><h1 class=post-title itemprop="name headline">Configure K8s Auth
<a href=https://github.com/user-name/repo-name/tree/branch-name/subdirectory-name/Systems/Linux/Kubernetes/Configure-K8s-Auth.md rel="noopener external nofollow noreferrer" target=_blank class="exturl post-edit-link" title=编辑><i class="fa fa-pen-nib"></i></a></h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2022-05-30 17:46:41 +0800 CST" itemprop="dateCreated datePublished" datetime="2022-05-30 17:46:41 +0800 CST">2022-05-30
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar-check"></i>
</span><span class=post-meta-item-text title=更新于>更新于：
</span><time title=修改时间：2022-11-14T17:46:41+08:00 itemprop=dateModified datetime=2022-11-14T17:46:41+08:00>2022-11-14</time>
</span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i>
</span><span class=post-meta-item-text title=分类于>分类于：
</span><span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/kubernetes itemprop=url rel=index><span itemprop=name>Kubernetes</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="far fa-file-word"></i>
</span><span class=post-meta-item-text>字数：</span>
<span>5578</span>
</span><span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="far fa-clock"></i>
</span><span class=post-meta-item-text>阅读：&ap;</span>
<span>12分钟</span>
</span><span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="far fa-eye"></i>
</span><span class=post-meta-item-text>浏览：
</span><span id=busuanzi_value_page_pv data-path=/systems/linux/kubernetes/configure-k8s-auth/><i class="fa fa-sync fa-spin"></i>
</span></span><span class=post-meta-item title><span class=post-meta-item-icon><i class="far fa-comments"></i>
</span><span class=post-meta-item-text title=评论>评论：
</span><span id=comments-count class=waline-comment-count data-path=/systems/linux/kubernetes/configure-k8s-auth/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class="post-body autonumber" itemprop=articleBody><h2 id=安全控制>安全控制
<a class=header-anchor href=#%e5%ae%89%e5%85%a8%e6%8e%a7%e5%88%b6></a></h2><h3 id=访问控制>访问控制
<a class=header-anchor href=#%e8%ae%bf%e9%97%ae%e6%8e%a7%e5%88%b6></a></h3><div class="note info"><ul><li><ol><li><code>kubernetes</code>作为一个分布式集群的管理工具，保证集群的安全性是其一个重要的任务。所谓的安全性其实就是保证对<code>kubernetes</code>的各种客户端进行认证和授权操作</li></ol></li><li><ol start=2><li>在<code>kubernetes</code>集群中，客户端通常由两类：</li></ol></li></ul><blockquote><ul><li><code>User Account</code><font color=red>：一般是独立于</font><code>kubernetes</code><font color=red>之外的其他服务管理的用户账号</font></li><li><code>Service Account</code>：<code>kubernetes</code><font color=red>管理的账号，用于为</font><code>Pod</code><font color=red>的服务进程在访问</font><code>kubernetes</code><font color=red>时提供身份标识</font></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>graph LR
</span></span><span style=display:flex><span>C1((用户)) --&gt; B1(User&lt;br&gt;Account) --&gt; A((Kubernetes))
</span></span><span style=display:flex><span>C2((Pod)) --&gt; B2(Service&lt;br&gt;Account) --&gt; A((Kubernetes))
</span></span></code></pre></div></blockquote></div><h3 id=认证授权和准入控制>认证、授权和准入控制
<a class=header-anchor href=#%e8%ae%a4%e8%af%81%e6%8e%88%e6%9d%83%e5%92%8c%e5%87%86%e5%85%a5%e6%8e%a7%e5%88%b6></a></h3><div class="note info"><ul><li><ol><li><code>API Server</code><font color=red>是访问和管理资源对象的唯一入口。任何一个请求访问</font><code>API Server</code>，<font color=red>都要经过下面的三个流程：</font></li></ol></li></ul><blockquote><ul><li><code>Authentication</code>(认证)<font color=red>：身份鉴别，只有正确的账号才能通过认证</font></li><li><code>Authorization</code>(授权)<font color=red>：权限鉴别，判断用户是否有权限对访问的资源执行特定的动作</font></li><li><code>Admission Control</code>(准入控制)<font color=red>：精细访问控制，用于补充授权机制以实现更加精细的访问控制功能</font></li><li><font color=red>需要注意：</font>在<code>Kubernetes</code>中不能通过<code>API</code>调用将普通用户添加到集群中</li></ul><blockquote><ul><li>普通账户是针对（人）用户的，服务账户针对<code>Pods</code>进程</li><li>普通账户是全局性，在集群所有<code>namespaces</code>中，名称具有唯一性</li><li>通常，集群的普通账户可以与企业数据库同步，新的普通账户创建需要特殊权限，服务账户创建目的是更轻量化，允许集群用户为特定任务创建服务账户</li><li>普通账户和服务账户的审核注意事项不同</li><li>对于复杂系统的配置包，可以包括对该系统的各种组件的服务账户的定义</li></ul></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>graph LR
</span></span><span style=display:flex><span>A((请求)) --&gt; B[Authentication&lt;br&gt;认证&lt;br&gt;&lt;p&gt;身份鉴别&lt;br&gt;] --&gt; C[Authorization&lt;br&gt;授权&lt;br&gt;&lt;p&gt;权限鉴别&lt;br&gt;] --&gt; D[Admission Control&lt;br&gt;注入控制&lt;br&gt;&lt;p&gt;精细访问控制&lt;br&gt;] --&gt; E((Kubernetes&lt;br&gt;资源))
</span></span></code></pre></div></blockquote></div><h4 id=认证管理>认证管理
<a class=header-anchor href=#%e8%ae%a4%e8%af%81%e7%ae%a1%e7%90%86></a></h4><h5 id=user-accounts普通账户><code>User Accounts</code>(普通账户)
<a class=header-anchor href=#user-accounts%e6%99%ae%e9%80%9a%e8%b4%a6%e6%88%b7></a></h5><div class="note info"></div><h5 id=service-accounts服务账户><code>Service Accounts</code>(服务账户)
<a class=header-anchor href=#service-accounts%e6%9c%8d%e5%8a%a1%e8%b4%a6%e6%88%b7></a></h5><div class="note info"><blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ServiceAccount   </span> <span style=color:#75715e># 权限管理</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nfs-client-provisioner</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span></code></pre></div></blockquote></div><h5 id=kubernetesfont-colorred的客户端fonthttpfont-colorred和fonthttpsfont-colorred身份认证方式font><code>kubernetes</code><font color=red>的客户端</font><code>http</code><font color=red>和</font><code>https</code><font color=red>身份认证方式</font>
<a class=header-anchor href=#kubernetesfont-colorred%e7%9a%84%e5%ae%a2%e6%88%b7%e7%ab%affonthttpfont-colorred%e5%92%8cfonthttpsfont-colorred%e8%ba%ab%e4%bb%bd%e8%ae%a4%e8%af%81%e6%96%b9%e5%bc%8ffont></a></h5><div class="note info"><ul><li><ol><li><code>kubernetes</code><font color=red>允许同时配置多种认证方式，</font>只要其中任意一种方式认证通过即可</li></ol></li><li><ol start=2><li><code>kubernetes</code>集群安全的关键点在于如何识别并认证客户端身份，它提供了<code>3</code>种客户端身份认证方式</li></ol></li></ul><blockquote><ul><li>2.1 <code>HTTP Base</code><font color=red>认证：</font></li></ul><blockquote><ul><li><font color=red>通过用户名+密码的方式进行认证，</font>这种方式是把<code>用户名:密码</code>用<code>BASE64</code>算法进行编码后的字符串放在<code>HTTP</code>请求中的<code>Header</code>的<code>Authorization</code>域里面发送给服务端。服务端收到后进行解码，获取用户名和密码，然后进行用户身份认证的过程</li></ul></blockquote><ul><li>2.2 <code>HTTP Token</code><font color=red>认证：</font></li></ul><blockquote><ul><li><font color=red>通过一个<code>Token</code>来识别合法用户，</font>这种认证方式是用一个很长的难以被模仿的字符串<code>--Token</code>来表明客户端身份的一种方式。每个<code>Token</code>对应一个用户名，当客户端发起<code>API</code>调用请求的时候，需要在<code>HTTP</code>的<code>Header</code>中放入<code>Token</code>，<code>API Server</code>接受到<code>Token</code>后会和服务器中保存的<code>Token</code>进行比对，然后进行用户身份认证的过程。</li></ul></blockquote><ul><li>2.3 <code>HTTPS</code><font color=red>证书认证：</font></li></ul><blockquote><ul><li><p><font color=red>基于<code>CA</code>根证书签名的双向数字证书认证方式，</font>这种认证方式是安全性最高的一种方式，但是同时也是操作起来最麻烦的一种方式</p></li><li><p><font color=red>证书申请和下发：</font><code>HTTPS</code>通信双方的服务器向<code>CA</code>机构申请证书，<code>CA</code>机构发根证书、服务端证书及私钥给申请者</p></li><li><p><font color=red>客户端和服务器的双向认证</font></p></li></ul><blockquote><ul><li><font color=red>客户端向服务端发起请求，</font>服务端下发自己的证书给客户端。客户端收到证书后，通过私钥解密证书，在证书中获取服务端的私钥。客户端利用服务器端的公钥认证证书中的信息，如果一致，则认可这个服务器。</li><li><font color=red>客户端发送自己的证书给服务器端，</font>服务端接收到证书后，通过私钥解密证书。在证书中获取客户端的公钥，并用该公钥认证证书信息，确认客户端是否合法。</li></ul></blockquote><ul><li><font color=red>服务器端和客户端进行通信</font></li></ul><blockquote><ul><li>服务器端和客户端协商好加密方案后，客户端会产生一个随机的私钥并加密，然后发送到服务器端</li><li>服务器端接收到这个私钥后，双方接下来通信的所有内容都通过该随机私钥加密</li></ul></blockquote></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>graph TB
</span></span><span style=display:flex><span>A((CA机构)) -- 申请证书 --&gt;B((服务端))
</span></span><span style=display:flex><span>A((CA机构)) -- 申请证书 --&gt; C((客户端))
</span></span><span style=display:flex><span>B((服务端)) -- 下发证书 --&gt; A((CA机构))
</span></span><span style=display:flex><span>C((客户端)) -- 下发证书 --&gt; A((CA机构))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>B((服务端)) &lt;-- 双向身份认证 --&gt; C((客户端))
</span></span><span style=display:flex><span>B((服务端)) &lt;-- 双向通信 --&gt; C((客户端))
</span></span></code></pre></div></blockquote></div><h4 id=授权管理>授权管理
<a class=header-anchor href=#%e6%8e%88%e6%9d%83%e7%ae%a1%e7%90%86></a></h4><div class="note info"><ul><li><ol><li><font color=red>授权发生在认证成功之后，</font>通过认证就可以知道请求用户是谁，然后<code>kubernetes</code>会根据事先定义的授权策略来决定用户是否有权限访问，这个过程就称为授权</li></ol></li><li><ol start=2><li>每个发送到<code>API Server</code>的请求都带上了用户和资源的信息：比如发送请求的用户、请求的路径、请求的动作等，授权就是根据这些信息和授权策略进行比较，如果符合策略，则认为授权通过，否则会返回错误。</li></ol></li><li><ol start=3><li><code>API Server</code>目前支持的几种授权策略</li></ol></li></ul><blockquote><ul><li><code>AlwaysDeny</code><font color=red>：表示拒绝所有请求，一般用于测试</font></li><li><code>AlwaysAllow</code><font color=red>：允许接收所有的请求，相当于集群不需要授权流程（<code>kubernetes</code>默认的策略）</font></li><li><code>ABAC</code><font color=red>：基于属性的访问控制，表示使用用户配置的授权规则对用户请求进行匹配和控制</font></li><li><code>Webhook</code><font color=red>：通过调用外部<code>REST</code>服务对用户进行授权</font></li><li><code>Node</code><font color=red>：是一种专用模式，用于对<code>kubelet</code>发出的请求进行访问控制</font></li><li><code>RBAC</code><font color=red>：基于角色的访问控制（<code>kubeadm</code>安装方式下的默认选项）</font></li></ul></blockquote></div><h5 id=rbac基于角色的访问控制><code>RBAC</code>基于角色的访问控制
<a class=header-anchor href=#rbac%e5%9f%ba%e4%ba%8e%e8%a7%92%e8%89%b2%e7%9a%84%e8%ae%bf%e9%97%ae%e6%8e%a7%e5%88%b6></a></h5><div class="note info"><blockquote><ul><li><code>RBAC</code><font color=red>基于角色的访问控制</font>(<code>Role Based Access Control</code>)<font color=red>主要是在描述一件事情：给哪些对象授权了哪些权限</font></li><li><code>RBAC</code>涉及到了下面几个概念：</li></ul><blockquote><ul><li><font color=red>对象：</font><code>User</code>、<code>Groups</code>、<code>ServiceAccount</code>。</li><li><font color=red>角色：</font>代表着一组定义在资源上的可操作的动作（权限）的集合</li><li><font color=red>绑定：</font>将定义好的角色和用户绑定在一起</li></ul></blockquote><ul><li><code>RBAC</code>引入的<code>4</code>个顶级资源对象：</li></ul><blockquote><ul><li><code>Role</code>(角色)<font color=red>，用于指定一组权限</font></li><li><code>ClusterRole</code>(集群角色)<font color=red>，用于指定一组权限</font></li><li><code>RoleBinding</code>(角色绑定)<font color=red>，用于将角色（权限的集合）赋予给对象</font></li><li><code>ClusterRoleBinding</code>(集群角色绑定)<font color=red>，用于将角色（权限的集合）赋予给对象</font></li></ul></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>graph TB
</span></span><span style=display:flex><span>A1(Group) --- A[RoleBinding]
</span></span><span style=display:flex><span>A2(User) --- A[RoleBinding]
</span></span><span style=display:flex><span>A3(Service&lt;br&gt;Account) --- A[RoleBinding]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>A[RoleBinding] --- B[Role]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>B[Role] --- Pod --- |a=1|B1[List]
</span></span><span style=display:flex><span>B[Role] --- Pod --- |a=2|B2[Get]
</span></span><span style=display:flex><span>B[Role] --- Pod --- |a=3|B3[Watch]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>B[Role] --- Deployment --- |b=1|B4[List]
</span></span><span style=display:flex><span>B[Role] --- Deployment --- |b=2|B5[Get]
</span></span><span style=display:flex><span>B[Role] --- Deployment --- |b=3|B6[Watch]
</span></span></code></pre></div></blockquote></div><h5 id=role普通角色><code>Role</code>(普通角色)
<a class=header-anchor href=#role%e6%99%ae%e9%80%9a%e8%a7%92%e8%89%b2></a></h5><div class="note info"><blockquote><ul><li><font color=red>一个角色就是一组权限的集合，这里的权限都是许可形式的（白名单）</font></li><li><code>Role</code><font color=red>只能对命名空间的资源进行授权，需要指定</font><code>namespace</code></li></ul></blockquote><ul><li><ol><li><code>rules:</code><font color=red>中的参数说明：</font></li></ol></li></ul><blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ kubectl explain role.rules.resources  	<span style=color:#75715e># 显示 resources 使用方式</span>
</span></span></code></pre></div><ul><li>1.1 <code>apiGroups:</code></li></ul><blockquote><ul><li><font color=red>支持的</font><code>API</code><font color=red>组列表，</font><code>""</code>,<code>"apps"</code>,<code>"autoscaling</code>"",<code>"batch"</code>。</li></ul></blockquote><ul><li>1.2 <code>resources:</code></li></ul><blockquote><ul><li><font color=red>支持的资源对象列表，</font><code>"namespaces"</code>,<code>"services"</code>,<code>"endpoints"</code>,<code>"pods"</code>,<code>"secrets"</code>,<code>"configmaps"</code>,<code>"crontabs"</code>,<code>"deployments"</code>,<code>"jobs"</code>,<code>"nodes"</code>,<code>"rolebindings"</code>,<code>"clusterroles"</code>,<code>"daemonsets"</code>,<code>"replicasets"</code>,<code>"statefulsets"</code>,<code>"horizontalpodautoscalers"</code>,<code>"replicationcontrollers"</code>,<code>"cronjobs"</code></li></ul></blockquote><ul><li>1.3 <code>verbs:</code></li></ul><blockquote><ul><li><font color=red>对资源对象的操作方法列表，</font><code>"get"</code>,<code> "list"</code>,<code> "watch"</code>,<code> "create"</code>,<code> "update"</code>,<code> "patch"</code>, <code>"delete"</code>,<code>"exec"</code></li></ul></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Role</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>authorization-role</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span><span style=color:#f92672>rules</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>apiGroups</span>: [<span style=color:#e6db74>&#34;&#34;</span>]  	<span style=color:#75715e># 支持的API组列表，&#34;&#34;空字符串，表示核心API群</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>resources</span>: [<span style=color:#e6db74>&#34;pods&#34;</span>]  	<span style=color:#75715e># 支持的资源对象列表</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>verbs</span>: [<span style=color:#e6db74>&#34;get&#34;</span>,<span style=color:#e6db74>&#34;watch&#34;</span>,<span style=color:#e6db74>&#34;list&#34;</span>]
</span></span></code></pre></div></blockquote></div><h5 id=rolebinding普通角色绑定><code>RoleBinding</code>(普通角色绑定)
<a class=header-anchor href=#rolebinding%e6%99%ae%e9%80%9a%e8%a7%92%e8%89%b2%e7%bb%91%e5%ae%9a></a></h5><div class="note info"><ul><li><ol><li><font color=red>角色绑定用来把一个角色绑定到一个目标对象上，绑定目标可以是</font><code>User</code>、<code>Group</code>或者<code>ServiceAccount</code></li></ol></li></ul><blockquote><ul><li><code>RoleBinding</code>可以将同一<code>namespace</code>中的<code>subject</code>对象绑定到某个<code>Role</code>下，则此<code>Subject</code>具有该<code>Role</code>定义的权限</li><li><code>subjects:</code><font color=red></font></li><li><code>roleRef:</code><font color=red></font></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>RoleBinding</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>authorization-role-binding</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span><span style=color:#f92672>subjects</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>User  	# User，Group，ServiceAccoun  </span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>user-name</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>apiGroup</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io  </span>
</span></span><span style=display:flex><span><span style=color:#f92672>roleRef</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>apiGroup</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Role</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>authorization-role</span>
</span></span></code></pre></div></blockquote></div><h5 id=clusterrole集群角色><code>ClusterRole</code>(集群角色)
<a class=header-anchor href=#clusterrole%e9%9b%86%e7%be%a4%e8%a7%92%e8%89%b2></a></h5><div class="note info"><ul><li><ol><li><code>ClusterRole</code><font color=red>可以对集群范围内的资源、跨<code>namespace</code>的范围资源、非资源类型进行授权</font></li></ol></li></ul><blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ClusterRole</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>authorization-clusterrole</span>
</span></span><span style=display:flex><span><span style=color:#f92672>rules</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>apiGroups</span>: [<span style=color:#e6db74>&#34;&#34;</span>]  	<span style=color:#75715e># 支持的API组列表，&#34;&#34;空字符串，表示核心API群</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>resources</span>: [<span style=color:#e6db74>&#34;pods&#34;</span>]  	<span style=color:#75715e># 支持的资源对象列表</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>verbs</span>: [<span style=color:#e6db74>&#34;get&#34;</span>,<span style=color:#e6db74>&#34;watch&#34;</span>,<span style=color:#e6db74>&#34;list&#34;</span>]
</span></span></code></pre></div></blockquote></div><h5 id=clusterrolebinding集群角色绑定><code>ClusterRoleBinding</code>(集群角色绑定)
<a class=header-anchor href=#clusterrolebinding%e9%9b%86%e7%be%a4%e8%a7%92%e8%89%b2%e7%bb%91%e5%ae%9a></a></h5><div class="note info"><blockquote><ul><li><code>ClusterRoleBinding</code>在整个集群级别和所有<code>namespaces</code>将特定的<code>subject</code>与<code>ClusterRole</code>绑定，授予权限</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ClusterRoleBinding</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>authorization-clusterrole-binding</span>
</span></span><span style=display:flex><span><span style=color:#f92672>subjects</span>:  <span style=color:#75715e># 应用什么类型的主体  </span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>User  	# User，Group，ServiceAccoun </span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>user-name  	# 对应的名字</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>apiGroup</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io</span>
</span></span><span style=display:flex><span><span style=color:#f92672>roleRef</span>:  	<span style=color:#75715e># 角色绑定 </span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>apiGroup</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io  	# 对应的Api分组  </span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ClusterRole  	# 角色类型</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>authorization-clusterrole</span>
</span></span></code></pre></div></blockquote></div><h4 id=准入控制>准入控制
<a class=header-anchor href=#%e5%87%86%e5%85%a5%e6%8e%a7%e5%88%b6></a></h4><div class="note info"><ul><li><ol><li>通过了前面的认证和授权之后，还需要经过准入控制通过之后，<code>API Server</code>才会处理这个请求。</li></ol></li><li><ol start=2><li>准入控制是一个可配置的控制器列表，可以通过在<code>API Server</code>上通过命令行设置选择执行哪些注入控制器。</li></ol></li><li><ol start=3><li>只有当所有的注入控制器都检查通过之后，<code>API Server</code>才会执行该请求，否则返回拒绝。</li></ol></li></ul><blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span>--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,PersistentVolumeLabel,DefaultStorageClass,ResourceQuota,DefaultTolerationSeconds
</span></span></code></pre></div></blockquote></div><h5 id=admission-controlfont-colorred准入控制font><code>Admission Control</code><font color=red>(准入控制)</font>
<a class=header-anchor href=#admission-controlfont-colorred%e5%87%86%e5%85%a5%e6%8e%a7%e5%88%b6font></a></h5><div class="note info"><blockquote><ul><li><code>AlwaysAdmit</code><font color=red>：允许所有请求</font></li><li><code>AlwaysDeny</code><font color=red>：禁止所有请求，一般用于测试</font></li><li><code>AlwaysPullImages</code><font color=red>：在启动容器之前总去下载镜像</font></li><li><code>DenyExecOnPrivileged</code>：它会拦截所有想在<code>Privileged Container</code>上执行命令的请求</li><li><code>ImagePolicyWebhook</code>：这个插件将允许后端的一个<code>Webhook</code>程序来完成<code>admission controller</code>的功能</li><li><code>Service Account</code>：实现<code>ServiceAccount</code>实现了自动化</li><li><code>SecurityContextDeny</code>：这个插件将使用<code>SecurityContext</code>的<code>Pod</code>中的定义全部失效</li><li><code>ResourceQuota</code>：用于资源配额管理目的，观察所有请求，确保在<code>namespace</code>上的配额不会超标</li><li><code>LimitRanger</code>：用于资源限制管理，作用于<code>namespace</code>上，确保对<code>Pod</code>进行资源限制</li><li><code>InitialResources</code>：为未设置资源请求与限制的<code>Pod</code>，根据其镜像的历史资源的使用情况进行设置</li><li><code>NamespaceLifecycle</code>：如果尝试在一个不存在的<code>namespace</code>中创建资源对象，则该创建请求将被拒 绝。当删除一个<code>namespace</code>时，系统将会删除该<code>namespace</code>中所有对象</li><li><code>DefaultStorageClass</code>：为了实现共享存储的动态供应，为未指定<code>StorageClass</code>或<code>PV</code>的<code>PVC</code>尝试匹配默认<code>StorageClass</code>，尽可能减少用户在申请<code>PVC</code>时所需了解的后端存储细节</li><li><code>DefaultTolerationSeconds</code>：这个插件为那些没有设置<code>forgiveness tolerations</code>并具有<code>notready:NoExecute</code>和<code>unreachable:NoExecute</code>两种<code>taints</code>的<code>Pod</code>设置默认的<code>“容忍”</code>时间，为<code>5min</code></li><li><code>PodSecurityPolicy</code>：这个插件用于在创建或修改Pod时决定是否根据<code>Pod</code>的<code>security context</code>和可用的<code>PodSecurityPolicy</code>对<code>Pod</code>的安全策略进行控制</li></ul></blockquote></div><h3 id=rbac实战><code>RBAC</code>实战
<a class=header-anchor href=#rbac%e5%ae%9e%e6%88%98></a></h3><div class="note info"><ul><li><ol><li>创建一个只能管理<code>dev</code>命名空间下<code>Pods</code>资源的账号。</li></ol></li></ul><blockquote><ul><li><font color=red>创建密钥</font></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ cd /etc/kubernetes/pki/
</span></span><span style=display:flex><span>$ <span style=color:#f92672>(</span>umask 077;openssl genrsa -out user-name.key 2048<span style=color:#f92672>)</span>
</span></span></code></pre></div><ul><li>用<code>API Server</code>的密钥去签署证书</li></ul><blockquote><ul><li><font color=red>证书申请：</font>申请的用户是<code>user-name</code>，组是<code>group-name</code></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ openssl req -new -key user-name.key -out user-name.csr -subj <span style=color:#e6db74>&#34;/CN=user-name/O=group-name&#34;</span>
</span></span></code></pre></div><ul><li><font color=red>签署证书</font></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ openssl x509 -req -in user-name.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out user-name.crt -days <span style=color:#ae81ff>3650</span>
</span></span></code></pre></div></blockquote><ul><li><font color=red>设置集群、用户、上下文信息：</font></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ kubectl config set-cluster kubernetes --embed-certs<span style=color:#f92672>=</span>true --certificate-authority<span style=color:#f92672>=</span>/etc/kubernetes/pki/ca.crt --server<span style=color:#f92672>=</span>https://192.168.18.100:6443
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl config set-credentials user-name --embed-certs<span style=color:#f92672>=</span>true --client-certificate<span style=color:#f92672>=</span>/etc/kubernetes/pki/user-name.crt --client-key<span style=color:#f92672>=</span>/etc/kubernetes/pki/user-name.key
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl config set-context user-name@kubernetes --cluster<span style=color:#f92672>=</span>kubernetes --user<span style=color:#f92672>=</span>user-name
</span></span></code></pre></div><ul><li><font color=red>测试账户、切换</font></li></ul><blockquote><ul><li><font color=red>切换账号到</font><code>user-name</code></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ kubectl config use-context user-name@kubernetes
</span></span></code></pre></div><ul><li><font color=red>查看<code>default</code>下的<code>Pod</code>，发现没有权限：</font></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ kubectl get pods -n default
</span></span></code></pre></div><ul><li><font color=red>切换到<code>admin</code>账户：</font></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ kubectl config use-context kubernetes-admin@kubernetes
</span></span></code></pre></div></blockquote></blockquote></div><h4 id=rolebindingfont-colorred引用fontclusterrolefont-colorred进行授权font><code>RoleBinding</code><font color=red>引用</font><code>ClusterRole</code><font color=red>进行授权</font>
<a class=header-anchor href=#rolebindingfont-colorred%e5%bc%95%e7%94%a8fontclusterrolefont-colorred%e8%bf%9b%e8%a1%8c%e6%8e%88%e6%9d%83font></a></h4><div class="note info"><ul><li><ol><li><code>RoleBinding</code>(角色绑定)可以引用<code>ClusterRole</code>(集群角色)，对属于同一命名空间内<code>ClusterRole</code>定义的资源主体进行授权。</li></ol></li><li><ol start=2><li>一种很常用的做法是，集群管理员为集群范围预定义好一组角色<code>ClusterRole</code>，然后在多个命名空间中重复使用这些<code>ClusterRole</code>。这样可以大幅度提高授权管理工作效率，也使得各个命名空间下的基础性授权规则和使用体验保持一致。</li></ol></li></ul><blockquote><ul><li>虽然<code>authorization-clusterrole</code>是一个集群角色，但是因为使用了<code>RoleBinding</code>，所以<code>xudaxian</code>只能读取<code>default</code>命名空间中的资源</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>RoleBinding</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>authorization-clusterrole-binding</span>
</span></span><span style=display:flex><span><span style=color:#f92672>subjects</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>xudaxian</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>User</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>apiGroup</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io</span>
</span></span><span style=display:flex><span><span style=color:#f92672>roleRef</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>apiGroup</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ClusterRole</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>authorization-clusterrole</span>
</span></span></code></pre></div></blockquote></div><h4 id=font-colorred创建fontrolefont-colorred和fontrolebindingfont-colorred为fontuser-namefont-colorred授权font><font color=red>创建</font><code>Role</code><font color=red>和</font><code>RoleBinding</code><font color=red>，为</font><code>user-name</code><font color=red>授权</font>
<a class=header-anchor href=#font-colorred%e5%88%9b%e5%bb%bafontrolefont-colorred%e5%92%8cfontrolebindingfont-colorred%e4%b8%bafontuser-namefont-colorred%e6%8e%88%e6%9d%83font></a></h4><div class="note info"><ul><li><ol><li>创建<code>dev-role.yaml</code>文件，内容如下：</li></ol></li></ul><blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Role</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>dev-role</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span><span style=color:#f92672>rules</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>apiGroups</span>: [<span style=color:#e6db74>&#34;&#34;</span>]  	<span style=color:#75715e># 支持的API组列表，&#34;&#34;空字符串，表示核心API群</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>resources</span>: [<span style=color:#e6db74>&#34;pods&#34;</span>]  	<span style=color:#75715e># 支持的资源对象列表</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>verbs</span>: [<span style=color:#e6db74>&#34;get&#34;</span>,<span style=color:#e6db74>&#34;watch&#34;</span>,<span style=color:#e6db74>&#34;list&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>RoleBinding</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>   <span style=color:#f92672>name</span>: <span style=color:#ae81ff>authorization-role-binding </span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span><span style=color:#f92672>subjects</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>User</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>user-name</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>apiGroup</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io </span>
</span></span><span style=display:flex><span><span style=color:#f92672>roleRef</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Role </span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>dev-role</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>apiGroup</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io</span>
</span></span></code></pre></div></blockquote><ul><li><ol start=2><li>创建<code>Role</code>和<code>RoleBinding</code>：</li></ol></li></ul><blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ kubectl create -f dev-role.yaml
</span></span></code></pre></div></blockquote><ul><li><ol start=3><li>切换账户到<code>user-name</code>用户，再次验证：</li></ol></li></ul><blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ kubectl config use-context user-name@kubernetes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 再次查看：</span>
</span></span><span style=display:flex><span>$ kubectl get pod -n default
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 切回admin账户：</span>
</span></span><span style=display:flex><span>$ kubectl config use-context kubernetes-admin@kubernetes
</span></span></code></pre></div></blockquote></div></div><footer class=post-footer><div class=post-tags><a href=/tags/kubernetes>Kubernetes
</a><a href=/tags/authenticating>Authenticating</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=reward-container><div><i class="fa-solid fa-mug-hot"></i>请我喝杯咖啡吧 ヾ(^▽^*)))</div><button>
赞赏</button><div class=post-reward><div class=post-reward-item><img src=/imgs/img-lazy-loading.gif data-src=/imgs/ali-pay.png alt="二哥 - 支付宝">
<span>支付宝</span></div><div class=post-reward-item><img src=/imgs/img-lazy-loading.gif data-src=/imgs/wechat-pay.png alt="二哥 - 微信">
<span>微信</span></div></div></div><div class=post-copyright><img src=/imgs/cc/cc.svg width=75 height=75 align=right alt=共享知识><ul><li class=post-copyright-title><strong>文章标题：</strong>
Configure K8s Auth</li><li class=post-copyright-author><strong>本文作者： </strong>二哥</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=https://erge.blog/systems/linux/kubernetes/configure-k8s-auth/ title="Configure K8s Auth">https://erge.blog/systems/linux/kubernetes/configure-k8s-auth/</a></li><li class=post-copyright-license><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class=followme><span>欢迎关注我的其它发布渠道</span><div class=social-list><div class=social-item><a target=_blank class=social-link href=/images/wechat_channel.jpg><span class=icon><i class="fab fa-weixin"></i>
</span><span class=label>WeChat</span></a></div><div class=social-item><a target=_blank class=social-link href=/atom.xml><span class=icon><i class="fa fa-rss"></i>
</span><span class=label>RSS</span></a></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/systems/linux/kubernetes/configure-k8s-ingress/ rel=next title="Configure K8s Ingress"><i class="fa fa-chevron-left"></i> Configure K8s Ingress</a></div><div class="post-nav-prev post-nav-item"><a href=/systems/linux/kubernetes/configure-k8s-helm/ rel=prev title="Configure K8s Helm">Configure K8s Helm
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div id=comments class=post-comments><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i>
<span>评论交流</span></div><div class=comment-switch><span class=first-comment>Giscus</span>
<span class=switch-btn></span>
<span class=second-comment>Waline</span></div></div><div class=comment-wrap><div><div class=comment-loading><i class="fa fa-sync fa-spin"></i></div><div class=giscus-container></div></div><div><div class=comment-loading><i class="fa fa-sync fa-spin"></i></div><div class=waline-container></div></div></div></div></div></main><footer class=footer><div class=footer-inner><div id=gtranslate class=google-translate><i class="fa fa-language"></i><div id=google_translate_element></div></div><div class=copyright>&copy;
<span itemprop=copyrightYear>2010 - 2024
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>二哥</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.125.4 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.5.3 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div><div class=beian><a href=https://beian.miit.gov.cn target=_blank>粤ICP备 18047355-1 号</a>
<img src=/imgs/gongan.png alt=沪公网安备>
<a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=31011402009770" target=_blank>沪公网安备 31011402009770 号</a></div><div class=vendors-list><a target=_blank href=https://vercel.com title=Vercel><img src=/imgs/img-lazy-loading.gif data-src=/imgs/vendors/vercel.svg alt=Vercel>
</a><a target=_blank href=https://upyun.com title=又拍云><img src=/imgs/img-lazy-loading.gif data-src=/imgs/vendors/upyun.png alt=又拍云>
</a><a target=_blank href=https://webify.cloudbase.net title=Webify>Webify
</a><span>提供CDN/云资源支持</span></div></div></footer><script type=text/javascript src=https://cdn.staticfile.org/animejs/3.2.1/anime.min.js defer></script><script type=text/javascript src=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.js defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"copybtn":true,"darkmode":false,"giscus":{"cfg":{"category":"Comments","categoryid":null,"emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"username/repo-name","repoid":null,"theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"https://erge.blog/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"limit":1e3,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":true,"plugin":"waline"},"views":{"enable":true,"plugin":"busuanzi"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"vendor":{"plugins":"qiniu","router":"https://cdn.staticfile.org"},"version":"4.5.3","waline":{"cfg":{"emoji":false,"imguploader":false,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"serverurl":null,"sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"waline","file":"dist/waline.css","name":"@waline/client","version":"2.13.0"},"js":{"alias":"waline","file":"dist/waline.js","name":"@waline/client","version":"2.13.0"}}}</script><script type=text/javascript src=/js/main.min.b0c78e5a4df586ee46d02716ffa91a4a322e56763e04e91eb2ba052c9469ed02.js defer></script></body></html>