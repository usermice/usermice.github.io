<!DOCTYPE html>
<html lang="en" dir="ltr" itemscope itemtype="http://schema.org/Article">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.125.4">
    <meta name="generator" content="Relearn 6.0.0+tip">
    <meta name="robots" content="noindex, nofollow, noarchive, noimageindex">
    <meta name="description" content="">
    <meta name="author" content="二哥">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://usermice.github.io/images/hero.png">
    <meta name="twitter:title" content="Linux :: Hugo Relearn Theme">
    <meta property="og:url" content="https://usermice.github.io/systems/linux/">
    <meta property="og:site_name" content="Hugo Relearn Theme">
    <meta property="og:title" content="Linux :: Hugo Relearn Theme">
    <meta property="og:locale" content="en">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://usermice.github.io/images/hero.png">
    <meta itemprop="name" content="Linux :: Hugo Relearn Theme">
    <meta itemprop="datePublished" content="2024-06-13T00:17:01+08:00">
    <meta itemprop="dateModified" content="2024-06-13T00:17:01+08:00">
    <meta itemprop="image" content="https://usermice.github.io/images/hero.png">
    <title>Linux :: Hugo Relearn Theme</title>
    <link href="../../images/favicon.ico?1727790689" rel="icon" type="image/x-icon" sizes="any">
    <link href="../../css/fontawesome-all.min.css?1727790691" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="../../css/fontawesome-all.min.css?1727790691" rel="stylesheet"></noscript>
    <link href="../../css/nucleus.css?1727790691" rel="stylesheet">
    <link href="../../css/auto-complete.css?1727790691" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="../../css/auto-complete.css?1727790691" rel="stylesheet"></noscript>
    <link href="../../css/perfect-scrollbar.min.css?1727790691" rel="stylesheet">
    <link href="../../css/fonts.css?1727790691" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="../../css/fonts.css?1727790691" rel="stylesheet"></noscript>
    <link href="../../css/theme.css?1727790691" rel="stylesheet">
    <link href="../../css/theme-relearn-auto.css?1727790691" rel="stylesheet" id="R-variant-style">
    <link href="../../css/chroma-relearn-auto.css?1727790691" rel="stylesheet" id="R-variant-chroma-style">
    <link href="../../css/variant.css?1727790691" rel="stylesheet">
    <link href="../../css/print.css?1727790691" rel="stylesheet" media="print">
    <link href="../../css/format-print.css?1727790691" rel="stylesheet">
    <script src="../../js/variant.js?1727790691"></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.relBasePath='..\/..';
      window.relearn.relBaseUri='..\/..';
      window.relearn.absBaseUri='https:\/\/usermice.github.io';
      window.index_js_url="../../index.search.js";
      // variant stuff
      window.variants && variants.init( [ 'relearn-auto', 'relearn-light', 'relearn-dark', 'relearn-bright', 'zen-auto', 'zen-light', 'zen-dark', 'retro-auto', 'neon', 'learn', 'blue', 'green', 'red', 'my-branding' ] );
      // translations
      window.T_Copy_to_clipboard = `Copy to clipboard`;
      window.T_Copied_to_clipboard = `Copied to clipboard!`;
      window.T_Copy_link_to_clipboard = `Copy link to clipboard`;
      window.T_Link_copied_to_clipboard = `Copied link to clipboard!`;
      window.T_Reset_view = `Reset view`;
      window.T_View_reset = `View reset!`;
      window.T_No_results_found = `No results found for "{0}"`;
      window.T_N_results_found = `{1} results found for "{0}"`;
    </script>Partial intended to be overwritten to add custom headers, like CSS or any other info
<style>
    
</style>


  </head>
  <body class="mobile-support print disableInlineCopyToClipboard" data-url="../../systems/linux/">
    <div id="R-body" class="default-animation">
      <div id="R-body-overlay"></div>
      <nav id="R-topbar">
        <div class="topbar-wrapper">
          <div class="topbar-sidebar-divider"></div>
          <div class="topbar-area topbar-area-start" data-area="start">
            <div class="topbar-button topbar-button-sidebar" data-content-empty="show" data-width-s="show" data-width-m="show" data-width-l="show"><button class="topbar-control" onclick="toggleNav()" type="button" title="Menu (CTRL&#43;ALT&#43;n)"><i class="fa-fw fas fa-bars"></i></button>
            </div>



          </div>
          <ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype="http://schema.org/BreadcrumbList"><li
            itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><a itemprop="item" href="../../systems/"><span itemprop="name">Systems</span></a><meta itemprop="position" content="1">&nbsp;>&nbsp;</li><li
            itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><span itemprop="name">Linux</span><meta itemprop="position" content="2"></li>
          </ol>
          <div class="topbar-area topbar-area-end" data-area="end">


            <div class="topbar-button topbar-button-prev" data-content-empty="show" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="../../systems/black-macos/" title="Black MacOs (🡐)"><i class="fa-fw fas fa-chevron-left"></i></a>
            </div>

            <div class="topbar-button topbar-button-next" data-content-empty="show" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="../../systems/linux/ansible/" title="Ansible (🡒)"><i class="fa-fw fas fa-chevron-right"></i></a>
            </div>



          </div>
        </div>
      </nav>
      <div id="R-main-overlay"></div>
      <main id="R-body-inner" class="highlightable default" tabindex="-1">
        <div class="flex-block-wrapper">
          <article class="default">
            <header class="headline">
            </header>

<h1 id="linux">Linux</h1>


            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Linux</h1>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="ansible">Ansible</h1>


            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Ansible</h1>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="use_slatstack">Use_Slatstack</h1>


            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="use_ansible">Use_Ansible</h1>

<h2 id="使用ansible">使用<code>Ansible</code></h2>
<blockquote>
<table>
<thead>
<tr>
<th>地址</th>
<th>名称</th>
<th>简介</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://www.jianshu.com/p/7c4c47aa6b5a" rel="external" target="_self"><code>ansible</code>总结</a></td>
<td>&mdash;</td>
<td>&mdash;-</td>
</tr>
<tr>
<td><a href="https://www.kancloud.cn/louis1986/ansible/587918" rel="external" target="_self"><code>Ansible</code>指南</a></td>
<td>&mdash;-</td>
<td>&mdash;-</td>
</tr>
<tr>
<td><a href="http://docs.ansible.com/ansible/latest/become.html" rel="external" target="_self">关于<code>become</code>属性</a></td>
<td>&mdash;-</td>
<td>&mdash;-</td>
</tr>
<tr>
<td><a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_intro.html" rel="external" target="_self"><code>Ansible</code>剧本的语法</a></td>
<td>&mdash;-</td>
<td>&mdash;-</td>
</tr>
<tr>
<td><a href="http://docs.ansible.com/ansible/latest/list_of_all_modules.html" rel="external" target="_self"><code>Ansible</code>的内置模块列表</a></td>
<td>&mdash;-</td>
<td>&mdash;-</td>
</tr>
<tr>
<td><a href="https://juejin.im/entry/5ba6e5e4e51d450e51628272" rel="external" target="_self"><code>Ansible</code>批量自动化管理工具<code>roles</code>标准化</a></td>
<td>&mdash;-</td>
<td>&mdash;</td>
</tr>
<tr>
<td><a href="https://blog.csdn.net/wh211212/article/details/82763493" rel="external" target="_self"><code>ansible-playbook</code>调用<code>zabbix-api</code>自动添加主机</a></td>
<td>&mdash;-</td>
<td>&mdash;-</td>
</tr>
<tr>
<td><a href="https://blog.csdn.net/wu2700222/article/details/80816988" rel="external" target="_self"><code>Ansible</code>批量安装<code>zabbix-agent</code>并使用<code>zabbix</code>自动添加主机</a></td>
<td>&mdash;-</td>
<td>&mdash;-</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th><strong>选项</strong></th>
<th><strong>描述</strong></th>
<th>详解</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-a MODULE_ARGS</code>, <!-- raw HTML omitted -->  <code>--args=MODULE_ARGS</code></td>
<td>模块参数</td>
<td></td>
</tr>
<tr>
<td><code>-C</code>, <code>--check</code>、</td>
<td>运行检查，不执行任何操作</td>
<td></td>
</tr>
<tr>
<td><code>-e EXTRA_VARS</code>, <!-- raw HTML omitted --> <code>--extra-vars=EXTRA_VARS</code></td>
<td>设置附加变量<code>key=value</code></td>
<td></td>
</tr>
<tr>
<td><code>-f FORKS</code>, <code>--forks=FORKS</code></td>
<td>指定并行进程数量，默认5</td>
<td></td>
</tr>
<tr>
<td><code>-i INVENTORY</code>,<!-- raw HTML omitted --> <code>--inventory=INVENTORY</code></td>
<td>指定主机清单文件路径</td>
<td></td>
</tr>
<tr>
<td><code>--list-hosts</code></td>
<td>输出匹配的主机列表，不执行任何操作</td>
<td></td>
</tr>
<tr>
<td><code>-m MODULE_NAME</code>,<!-- raw HTML omitted --> <code>--module-name=MODULE_NAME</code></td>
<td>执行的模块名，默认<code>command</code></td>
<td></td>
</tr>
<tr>
<td><code>-o</code></td>
<td>简洁输出法</td>
<td></td>
</tr>
<tr>
<td><code>--syntax-check</code></td>
<td>语法检查<code>playbook</code>文件，不执行任何操作</td>
<td></td>
</tr>
<tr>
<td><code>-t TREE</code>, <code>--tree=TREE</code></td>
<td>将日志输出到此目录</td>
<td></td>
</tr>
<tr>
<td><code>-v</code>, <code>--verbose</code></td>
<td>详细信息：<code>-vvv</code>，更多：<code>-vvvv debug</code></td>
<td></td>
</tr>
<tr>
<td><code>--version</code></td>
<td>查看程序版本</td>
<td></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th><strong>连接选项</strong></th>
<th><strong>控制谁连接主机和如何连接</strong></th>
<th>详解</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-k, --ask-pass</code></td>
<td>请求连接密码</td>
<td></td>
</tr>
<tr>
<td><code>--private-key=PRIVATE_KEY_FILE</code>, <!-- raw HTML omitted --><code>--key-file=PRIVATE_KEY_FILE</code></td>
<td>私钥文件</td>
<td></td>
</tr>
<tr>
<td><code>-u REMOTE_USER</code>，<!-- raw HTML omitted --><code>--user=REMOTE_USER</code></td>
<td>连接用户，默认<code>None</code></td>
<td></td>
</tr>
<tr>
<td><code>-T TIMEOUT</code>，<!-- raw HTML omitted --><code>--timeout=TIMEOUT</code></td>
<td>覆盖连接超时时间，默认10秒</td>
<td></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th><strong>提权选项</strong></th>
<th><strong>控制在目标主机以什么用户身份运行</strong></th>
<th>详解</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-b, --become</code></td>
<td>以另一个用户身份操作</td>
<td></td>
</tr>
<tr>
<td><code>--become-method=BECOME_METHOD</code></td>
<td>提权方法，默认<code>sudo</code></td>
<td></td>
</tr>
<tr>
<td><code>--become-user=BECOME_USER</code></td>
<td>提权后的用户身份，默认<code>root</code></td>
<td></td>
</tr>
<tr>
<td><code>-K, --ask-become-pass</code></td>
<td>提权密码</td>
<td></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th><strong>配置文件指令</strong></th>
<th><strong>描述</strong></th>
<th>详解</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ansible_ssh_host</code></td>
<td>指定主机别名对应的真实<code>IP</code></td>
<td></td>
</tr>
<tr>
<td><code>ansible_ssh_port</code></td>
<td>指定连接到这个主机的<code>ssh</code>端口，默认<code>22</code></td>
<td></td>
</tr>
<tr>
<td><code>ansible_ssh_user</code></td>
<td>连接到该主机的<code>ssh</code>用户</td>
<td></td>
</tr>
<tr>
<td><code>ansible_ssh_pass</code></td>
<td>连接到该主机的<code>ssh</code>密码(连<code>-k</code>选项都省了)，安全考虑还是建议使用私钥或在命令行指定<code>-k</code>选项输入</td>
<td></td>
</tr>
<tr>
<td><code>ansible_sudo_pass</code></td>
<td><code>sudo</code>密码</td>
<td></td>
</tr>
<tr>
<td><code>ansible_sudo_exe</code>(<code>v1.8+</code>的新特性)</td>
<td><code>sudo</code>命令路径</td>
<td></td>
</tr>
<tr>
<td><code>ansible_ssh_private_key_file</code></td>
<td>私钥文件路径</td>
<td></td>
</tr>
<tr>
<td><code>ansible_nodename</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>ansible_connection</code></td>
<td>连接类型，可以是<code>local</code>、<code>ssh</code>或<code>paramiko</code>，<code>ansible1.2</code>之前默认为<code>paramiko</code></td>
<td></td>
</tr>
<tr>
<td><code>ansible_os_family</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>ansible_pkg_mgr</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>ansible_shell_type</code></td>
<td>目标系统的<code>shell</code>类型，默认为<code>sh</code>,如果设置<code>csh/fish</code>，那么命令需要遵循它们语法</td>
<td></td>
</tr>
<tr>
<td><code>ansible_processor</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>ansible_processor_cores</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>ansible_python_interpreter</code></td>
<td><code>python</code>解释器路径，默认是<code>/usr/bin/python</code>，但是如要要连<code>*BSD</code>系统的话，就需要该指令修改<code>python</code>路径</td>
<td></td>
</tr>
<tr>
<td><code>ansible_*_interpreter</code></td>
<td>这里的<code>*</code>可以是<code>ruby</code>或<code>perl</code>或其他语言的解释器，作用和<code>ansible_python_interpreter</code>类似</td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h3 id="主配置文件">主配置文件</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted --><!-- raw HTML omitted -->主机名<!-- raw HTML omitted -->不能使用<!-- raw HTML omitted -->下划线<!-- raw HTML omitted --><!-- raw HTML omitted --><code>_</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/ansible/ansible.cfg<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[defaults] 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">inventory      = /etc/ansible/hosts
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># library        = /usr/share/my_modules/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># module_utils   = /usr/share/my_module_utils/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># remote_tmp     = ~/.ansible/tmp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># local_tmp      = ~/.ansible/tmp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># plugin_filters_cfg = /etc/ansible/plugin_filters.yml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">forks          = 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># poll_interval  = 15
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># sudo_user      = root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ask_sudo_pass = True
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ask_pass      = True
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># transport      = smart
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">remote_port    = 22
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># module_lang    = C
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># module_set_locale = False
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">become = root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">host_key_checking = False
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">timeout = 10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">log_path = /var/log/ansible.log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">private_key_file = /root/.ssh/id_rsa
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># gathering = implicit
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># gather_subset = all
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># gather_timeout = 10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># inject_facts_as_vars = True
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># remote_user = root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># roles_path    = /etc/ansible/roles
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># module_name = command
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># uncomment this to disable SSH key host checking
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">host_key_checking = False
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># executable = /bin/sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># stdout_callback = skippy  	# 修改为 json
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># callback_whitelist = timer, mail  # timer：计算整个playbook运行时间
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># task_includes_static = False
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># handler_includes_static = False
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># error_on_missing_handler = True
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># sudo_exe = sudo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># sudo_flags = -H -S -n
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># hash_behaviour = replace
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># private_role_vars = yes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># jinja2_extensions = jinja2.ext.do,jinja2.ext.i18n
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># private_key_file = /path/to/file
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># vault_password_file = /path/to/vault_password_file
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ansible_managed = Ansible managed
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># display_skipped_hosts = True
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># display_args_to_stdout = False
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># error_on_undefined_vars = False
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># system_warnings = True
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># deprecation_warnings = True
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># command_warnings = False
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># set plugin path directories here, separate with colons
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># action_plugins     = /usr/share/ansible/plugins/action
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># become_plugins     = /usr/share/ansible/plugins/become
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># cache_plugins      = /usr/share/ansible/plugins/cache
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># callback_plugins   = /usr/share/ansible/plugins/callback
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># connection_plugins = /usr/share/ansible/plugins/connection
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># lookup_plugins     = /usr/share/ansible/plugins/lookup
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># inventory_plugins  = /usr/share/ansible/plugins/inventory
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># vars_plugins       = /usr/share/ansible/plugins/vars
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># filter_plugins     = /usr/share/ansible/plugins/filter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># test_plugins       = /usr/share/ansible/plugins/test
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># terminal_plugins   = /usr/share/ansible/plugins/terminal
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># strategy_plugins   = /usr/share/ansible/plugins/strategy
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># strategy = free
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># bin_ansible_callbacks = False
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># nocows = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># cow_selection = default
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># cow_selection = random
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># cow_whitelist=bud-frogs,bunny,cheese,daemon,default,dragon,elephant-in-snake,elephant,eyes,\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#              hellokitty,kitty,luke-koala,meow,milk,moofasa,moose,ren,sheep,small,stegosaurus,\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#              stimpy,supermilker,three-eyes,turkey,turtle,tux,udder,vader-koala,vader,www
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># nocolor = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># fact_caching = memory
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># For the redis plugin, the value is a host:port:database triplet: fact_caching_connection = localhost:6379:0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># fact_caching_connection=/tmp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># retry_files_enabled = False
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># retry_files_save_path = ~/.ansible-retry
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># squash_actions = apk,apt,dnf,homebrew,pacman,pkgng,yum,zypper
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># no_log = False
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># no_target_syslog = False
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># allow_world_readable_tmpfiles = False
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># var_compression_level = 9
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># module_compression = &#39;ZIP_DEFLATED&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># max_diff_size = 1048576
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># merge_multiple_cli_flags = True
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># show_custom_stats = True
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># inventory_ignore_extensions = ~, .orig, .bak, .ini, .cfg, .retry, .pyc, .pyo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># network_group_modules=eos, nxos, ios, iosxr, junos, vyos
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># allow_unsafe_lookups = False
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># any_errors_fatal = False
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[inventory]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># enable inventory plugins, default: &#39;host_list&#39;, &#39;script&#39;, &#39;auto&#39;, &#39;yaml&#39;, &#39;ini&#39;, &#39;toml&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># enable_plugins = host_list, virtualbox, yaml, constructed
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ignore_extensions = .pyc, .pyo, .swp, .bak, ~, .rpm, .md, .txt, ~, .orig, .ini, .cfg, .retry
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ignore_patterns=
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># unparsed_is_failed=False
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[privilege_escalation]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># become=True
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># become_method=sudo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># become_user=root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># become_ask_pass=False
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[paramiko_connection]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># record_host_keys=False
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># pty=False
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># look_for_keys = False
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># host_key_auto_add = True
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[ssh_connection]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ssh_args = -C -o ControlMaster=auto -o ControlPersist=60s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># control_path_dir = /tmp/.ansible/cp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># control_path_dir = ~/.ansible/cp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># control_path = %(directory)s/%%h-%%r
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># control_path =
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># pipelining = False
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># scp_if_ssh = smart
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># transfer_method = smart
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># sftp_batch_mode = False
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># usetty = True
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># retries = 3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[persistent_connection]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># connect_timeout = 30
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># command_timeout = 30
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[accelerate]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># accelerate_port = 5099
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># accelerate_timeout = 30
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># accelerate_connect_timeout = 5.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># accelerate_daemon_timeout = 30
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># accelerate_multi_key = yes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[selinux]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># special_context_filesystems=nfs,vboxsf,fuse,ramfs,9p,vfat
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># libvirt_lxc_noseclabel = yes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[colors]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># highlight = white
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># verbose = blue
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># warn = bright purple
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># error = red
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># debug = dark gray
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># deprecate = purple
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># skip = cyan
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># unreachable = red
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ok = green
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># changed = yellow
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># diff_add = green
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># diff_remove = red
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># diff_lines = cyan
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[diff]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># context = 3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 示例1：未分组的主机
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">green.example.com
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">blue.example.com
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.100.1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.100.10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 示例2：属于webservers组主机集合
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[webservers]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">alpha.example.org
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">beta.example.org
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.1.100
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.1.110
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">www[001:006].example.com 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 示例3：属于dbservers组主机集合
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[dbservers]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">db01.intranet.mydomain.net
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">db02.intranet.mydomain.net
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">10.25.1.56
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">10.25.1.57
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">db-[99:101]-node.example.com
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 主机和主机组变量：
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[webservers:vars]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">http_port=8080
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">server_name=www.ctnrs.com
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ansible_ssh_user=&#34;username&#34; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ansible_ssh_pass=&#34;password&#34; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ansible_ssh_port=&#34;port&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 子组，children：为固定写法
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[father:children]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">webservers
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">dbservers
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># SSH密码认证
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[webservers]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.1.10 ansible_ssh_user=root ansible_ssh_pass=&#39;123456’ http_port=80
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.1.11 ansible_ssh_user=root ansible_ssh_pass=&#39;123456’ http_port=80
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># SSH密钥对认证
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[webservers]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.1.10:22 ansible_ssh_user=root ansible_ssh_key=/root/.ssh/id_rsa
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[master]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">k8s-master ansible_ssh_user=&#34;username&#34; ansible_ssh_pass=&#34;password&#34; ansible_ssh_port=&#34;port&#34; ansible_ssh_host=&#34;IP&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[node]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">k8s-node-1 ansible_ssh_user=&#34;username&#34; ansible_ssh_pass=&#34;password&#34; ansible_ssh_port=&#34;port&#34; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 应用示例
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">aws_host ansible_ssh_private_key_file=/home/example/.ssh/aws.pem
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">freebsd_host ansible_python_interpreter=/usr/local/bin/python
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ruby_module_host ansible_ruby_interpreter=/usr/bin/ruby.1.9.3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>sshd</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rpm -iUvh https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sed  -i <span style="color:#e6db74">&#39;s/^#host_key_checking/host_key_checking/g&#39;</span> /etc/ansible/ansible.cfg
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s/PasswordAuthentication[ \t]*no/PasswordAuthentication yes/&#39;</span> /etc/ssh/sshd_config
</span></span><span style="display:flex;"><span>$ systemctl restart sshd</span></span></code></pre></div></blockquote>
<hr>
<h3 id="子配置文件">子配置文件</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->对主机有效配置<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>/etc/ansible/host_vars/all  	<span style="color:#75715e"># host_vars 目录用于存放 host 变量，all文件对所有主机有效</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/etc/ansible/host_vars/foosball  	<span style="color:#75715e"># 文件foosball要和hosts里面定义的主机名一样，表示只对 foosball主机有效</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->对组有效配置<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>/etc/ansible/group_vars/all  	<span style="color:#75715e"># group_vars目录用于存放 group 变量，all文件对所有组有效</span>
</span></span><span style="display:flex;"><span>/etc/ansible/group_vars/raleigh  	<span style="color:#75715e"># 文件 raleigh 要和 hosts 里面定义的组名一样，表示对raleigh组下的所有主机有效</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;/etc/ansible/group_vars/webservers.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">http_port: 8080
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">server_name: www.ctnrs.com
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="命令使用">命令使用</h3>
<blockquote>
<ul>
<li><code>ansible-doc --help</code><!-- raw HTML omitted -->：获取使用帮助<!-- raw HTML omitted --></li>
<li><code>ansible-playbook --help</code><!-- raw HTML omitted -->：获取剧本使用帮助<!-- raw HTML omitted --></li>
<li><a href="https://docs.ansible.com/ansible/latest/module_plugin_guide/index.html" rel="external" target="_self">使用<code>Ansible</code>模块和插件</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 列出所有模块</span>
</span></span><span style="display:flex;"><span>$ ansible-doc -l 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看其中某一个模块使用方式，找到其中的：EXAMPLES(例子)</span>
</span></span><span style="display:flex;"><span>$ ansible-doc copy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看某个模块简单实用方式</span>
</span></span><span style="display:flex;"><span>$ ansible-doc -s copy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看回调插件列表</span>
</span></span><span style="display:flex;"><span>$ ansible-doc -t callback -l</span></span></code></pre></div><table>
<thead>
<tr>
<th><strong><a href="https://docs.ansible.com/ansible/latest/command_guide/intro_adhoc.html" rel="external" target="_self">常用模块</a></strong></th>
<th>**描述 **</th>
<th>详解</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code>、<code>shell</code></td>
<td>执行<code>shell</code>命令，<code>shell</code>支持管道符等字符</td>
<td></td>
</tr>
<tr>
<td><code>script</code></td>
<td>脚本模块</td>
<td></td>
</tr>
<tr>
<td><code>copy</code>、<code>file</code>、<code>synchronize</code></td>
<td>文件传输，<code>copy{src,dest,mode}</code>，<code>file</code>模块可以直接操作远程服务器，<code>synchronize</code></td>
<td></td>
</tr>
<tr>
<td><code>yum</code></td>
<td>管理软件包</td>
<td></td>
</tr>
<tr>
<td><code>user</code></td>
<td>用户和组</td>
<td></td>
</tr>
<tr>
<td><code>git</code></td>
<td>从源代码管理系统部署</td>
<td></td>
</tr>
<tr>
<td><code>service</code></td>
<td>管理服务</td>
<td></td>
</tr>
<tr>
<td><code>setup</code></td>
<td>收集目标主机信息</td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li>参数解释</li>
</ul>
<blockquote>
<ul>
<li><code>-i</code><!-- raw HTML omitted -->指定<!-- raw HTML omitted --><code>Ansible</code><!-- raw HTML omitted -->主机清单，可以指定外部<!-- raw HTML omitted --></li>
<li><code>-m</code><!-- raw HTML omitted -->指定要执行的模块，比如：<!-- raw HTML omitted --><code>ping</code>、<code>shell</code>、<code>copy</code></li>
<li><code>-a</code><!-- raw HTML omitted -->指定模块的参数， 例如：<!-- raw HTML omitted --><code>cppy</code>里的<code>src</code>、<code>dest</code></li>
<li><code>-o</code><!-- raw HTML omitted -->简洁输出法<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li><code>ping</code><!-- raw HTML omitted -->测试<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ansible all -m ping
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 以bruce身份 ping 所有主机</span>
</span></span><span style="display:flex;"><span>$ ansible all -m ping -u bruce
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 用bruce用户 以root身份 ping</span>
</span></span><span style="display:flex;"><span>$ ansible all -m ping -u bruce --sudo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 用bruce用户 sudo到 batman用户 ping</span>
</span></span><span style="display:flex;"><span>$ ansible all -m ping -u bruce --sudo --sudo-user batman
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在所有节点上执行命令</span>
</span></span><span style="display:flex;"><span>$ ansible all -a <span style="color:#e6db74">&#34;/bin/echo hello&#34;</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->并行性和<!-- raw HTML omitted --><code>shell</code><!-- raw HTML omitted -->命令<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 重启 altanta 主机组的所有机器，每次重启 10 台</span>
</span></span><span style="display:flex;"><span>$ ansible atlanta -a <span style="color:#e6db74">&#34;/sbin/reboot&#34;</span> -f <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 以 geekwolf 用户身份在 atlanta 组的所有主机运行 foo 命令</span>
</span></span><span style="display:flex;"><span>$ ansible atlanta -a <span style="color:#e6db74">&#34;/usr/bin/foo&#34;</span> -u geekwolf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 以 geekwolf 用户身份 sudo 执行命令 foo（--ask-sudo-pass (-K) 如果有 sudo 密码请使用此参数）</span>
</span></span><span style="display:flex;"><span>$ ansible atlanta -a <span style="color:#e6db74">&#34;/usr/bin/foo&#34;</span> -u geekwolf --sudo <span style="color:#f92672">[</span>--ask-sudo-pass<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 也可以 sudo 到其他用户执行命令非 root</span>
</span></span><span style="display:flex;"><span>$ ansible atlanta -a <span style="color:#e6db74">&#34;/usr/bin/foo&#34;</span> -u username -U otheruser <span style="color:#f92672">[</span>--ask-sudo-pass<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 默认情况下，ansible 使用的 module 是 command，这个模块并不支持 shell 变量和管道等，若想使用shell 来执行模块，请使用-m 参数指定 shell 模块</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用 shell 模块在远程主机执行命令</span>
</span></span><span style="display:flex;"><span>$ ansible raleigh -m shell -a <span style="color:#960050;background-color:#1e0010">&#39;</span>echo $TERM</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->传输文件<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>copy</code>模块</li>
</ul>
<blockquote>
<ul>
<li><code>src</code><!-- raw HTML omitted -->源<!-- raw HTML omitted --></li>
<li><code>dest</code><!-- raw HTML omitted -->目的地<!-- raw HTML omitted --></li>
<li><code>mode</code><!-- raw HTML omitted -->权限<!-- raw HTML omitted --></li>
<li><code>owner</code><!-- raw HTML omitted -->属主<!-- raw HTML omitted --></li>
<li><code>group</code><!-- raw HTML omitted -->属组<!-- raw HTML omitted --></li>
<li><code>backup</code><!-- raw HTML omitted -->备份<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 把本地/etc/hosts文件拷贝到 atlanta主机组所有主机的/tmp/hosts(空目录除外),如果使用playbooks 则可以充分利用 template 模块</span>
</span></span><span style="display:flex;"><span>$ ansible atlanta -m copy -a <span style="color:#e6db74">&#34;src=../../etc/hosts dest=/tmp/hosts&#34;</span></span></span></code></pre></div></blockquote>
<ul>
<li><code>file</code>模块</li>
</ul>
<blockquote>
<ul>
<li></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># file 模块允许更改文件的用户及权限</span>
</span></span><span style="display:flex;"><span>$ ansible webservers -m file -a <span style="color:#e6db74">&#34;dest=/srv/foo/a.txt mode=600&#34;</span>
</span></span><span style="display:flex;"><span>$ ansible webservers -m file -a <span style="color:#e6db74">&#34;dest=/srv/foo/b.txt mode=600 owner=mdehaan group=mdehaan&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用 file 模块创建目录，类似 mkdir -p</span>
</span></span><span style="display:flex;"><span>$ ansible webservers -m file -a <span style="color:#e6db74">&#34;dest=/path/to/c mode=755 owner=mdehaan group=mdehaan state=directory&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用 file 模块删除文件或者目录</span>
</span></span><span style="display:flex;"><span>$ ansible webservers -m file -a <span style="color:#e6db74">&#34;dest=/path/to/c state=absent&#34;</span></span></span></code></pre></div></blockquote>
<ul>
<li><code>synchronize</code></li>
</ul>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->管理软件包<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>注释：<code>Ansible</code>支持很多操作系统的软件包管理，使用时<code>-m</code>指定相应的软件包管理工具模块，如果没有这样的模块，可以自己定义类似的模块或者使用<code>command</code>模块来安装软件包</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># present 确认安装， 但不更新</span>
</span></span><span style="display:flex;"><span>$ ansible webservers -m apt -a <span style="color:#e6db74">&#34;name=nginx state=present&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 确认安装一个特定版本</span>
</span></span><span style="display:flex;"><span>$ ansible webservers -m apt -a <span style="color:#e6db74">&#34;name=nginx-1.5 state=present&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># installed 确认安装</span>
</span></span><span style="display:flex;"><span>$ ansible webservers -m apt -a <span style="color:#e6db74">&#34;name=nginx state=installed&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># latest 确认安装包为最新</span>
</span></span><span style="display:flex;"><span>$ ansible webservers -m apt -a <span style="color:#e6db74">&#34;name=nginx state=latest&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># absent 和 removed 确认删除</span>
</span></span><span style="display:flex;"><span>$ ansible webservers -m apt -a <span style="color:#e6db74">&#34;name=nginx state=absent&#34;</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->用户和用户组<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 使用 user 或者 group 模块对于创建新用户和更改、删除已存在用户非常方便</span>
</span></span><span style="display:flex;"><span>$ ansible all -m user -a <span style="color:#e6db74">&#34;name=foo password=&lt;crypted password here&gt;&#34;</span>
</span></span><span style="display:flex;"><span>$ ansible all -m group -a <span style="color:#e6db74">&#34;name=foo state=absent&#34;</span></span></span></code></pre></div></blockquote>
<ul>
<li><code>systemd</code>、<code>service</code><!-- raw HTML omitted -->服务管理<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>daemon_reload</code><!-- raw HTML omitted -->重新载入<!-- raw HTML omitted --><code>systemd</code></li>
<li><code>enabled</code><!-- raw HTML omitted -->是否开机启动<!-- raw HTML omitted --><code>yes|no</code></li>
<li><code>name</code><!-- raw HTML omitted -->服务名称<!-- raw HTML omitted --><code>httpd|sshd|nginx</code></li>
<li><code>state</code><!-- raw HTML omitted -->对当前服务操作， 例如：  启动、停止<!-- raw HTML omitted --><code>started</code>、<code>stopped</code>、<code>restarted</code>、<code>reloaded</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 确保 webservers 组所有主机的 httpd 是启动的</span>
</span></span><span style="display:flex;"><span>$ ansible webservers -m service -a <span style="color:#e6db74">&#34;name=httpd state=started&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 重启 webservers 组所有主机的 httpd 服务</span>
</span></span><span style="display:flex;"><span>$ ansible webservers -m service -a <span style="color:#e6db74">&#34;name=httpd state=restarted&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 确保 webservers 组所有主机的 httpd 是关闭的</span>
</span></span><span style="display:flex;"><span>$ ansible webservers -m service -a <span style="color:#e6db74">&#34;name=httpd state=stopped&#34;</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->后台运行<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>长时间运行的操作可以放到后台执行，<code>ansible</code>会检查任务的状态；在主机上执行的同一个任务会分配同一个<code>job ID</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 后台执行命令 3600s，-B 表示后台执行的时间</span>
</span></span><span style="display:flex;"><span>$ ansible all -B <span style="color:#ae81ff">3600</span> -a <span style="color:#e6db74">&#34;/usr/bin/long_running_operation --do-stuff&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 检查任务的状态</span>
</span></span><span style="display:flex;"><span>$ ansible all -m async_status -a <span style="color:#e6db74">&#34;jid=123456789&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 后台执行命令最大时间是 1800s 即 30 分钟，-P 每 60s 检查下状态默认 15s</span>
</span></span><span style="display:flex;"><span>$ ansible all -B <span style="color:#ae81ff">1800</span> -P <span style="color:#ae81ff">60</span> -a <span style="color:#e6db74">&#34;/usr/bin/long_running_operation --do-stuff&#34;</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->搜集系统信息<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>gather_facts: no</code><!-- raw HTML omitted -->关闭<!-- raw HTML omitted --><code>Facts</code><!-- raw HTML omitted -->变量<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># Facts 在 playbooks 一章中会有详细的描述，这里只通过命令获取所有的系统信息搜集主机的所有系统信息</span>
</span></span><span style="display:flex;"><span>$ ansible all -m setup
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 搜集系统信息并以主机名为文件名分别保存在/tmp/facts 目录</span>
</span></span><span style="display:flex;"><span>$ ansible all -i localhost, -m setup --tree /tmp/facts.txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 搜集和内存相关的信息</span>
</span></span><span style="display:flex;"><span>$ ansible all -i localhost, -m setup -a <span style="color:#e6db74">&#39;filter=ansible_*_mb&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 搜集网卡信息 ansible_default_ipv4</span>
</span></span><span style="display:flex;"><span>$ ansible all -i localhost, -m setup -a <span style="color:#e6db74">&#39;filter=ansible_all_ipv4_addresses&#39;</span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="使用galaxy">使用<code>Galaxy</code></h3>
<blockquote>
<ul>
<li>从<a href="https://galaxy.ansible.com/ui/" rel="external" target="_self"><code>Galaxy</code></a>和<code>Github</code>获得第三方的角色</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 初始化项目，生成默认目录</span>
</span></span><span style="display:flex;"><span>$ ansible-galaxy init nginx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用galaxy 安装服务</span>
</span></span><span style="display:flex;"><span>$ ansible-galaxy install -p roles darkraiden.ansible-pip
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ansible-galaxy install -p roles git+https://github.com/avinetworks/ansible-role-docker,master</span></span></code></pre></div></blockquote>
<hr>
<h3 id="配置playbook">配置<code>Playbook</code></h3>
<ul>
<li>
<ol>
<li><code>Ansible-Playbook</code><!-- raw HTML omitted -->目录、字段定义<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://docs.ansible.com/ansible/latest/tips_tricks/ansible_tips_tricks.html" rel="external" target="_self"><code>Ansible</code>官网文档</a></td>
<td><code>Ansible Playbook</code>官方文档</td>
</tr>
<tr>
<td><a href="https://github.com/ansible/ansible-examples" rel="external" target="_self"><code>Ansible</code>示例参考</a></td>
<td>示例参考网址</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ansible-playbook -i /etc/ansible/hosts example.yml -C  	<span style="color:#75715e"># -C 模拟运行查看流程是否会出错</span>
</span></span><span style="display:flex;"><span>$ ansible-playbook -i /etc/ansible/hosts example.yml --syntax-check  	<span style="color:#75715e"># 校验PlayBook脚本语法</span>
</span></span><span style="display:flex;"><span>$ ansible-playbook -i /etc/ansible/hosts example.yml --tags <span style="color:#e6db74">&#34;configuration,install&#34;</span>  	<span style="color:#75715e"># 指定安装</span>
</span></span><span style="display:flex;"><span>$ ansible-playbook -i /etc/ansible/hosts example.yml --skip-tags <span style="color:#e6db74">&#34;install&#34;</span>  <span style="color:#75715e"># 跳过 Install 步骤 </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 校验yaml文件</span>
</span></span><span style="display:flex;"><span>$ pip3 install pyyaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用sys标准输入验证</span>
</span></span><span style="display:flex;"><span>$ python3 -c <span style="color:#e6db74">&#39;import yaml,sys; print(yaml.safe_load(sys.stdin))&#39;</span>  &lt; my_yaml.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 其中，-i inventory_file 指定了你的 Ansible inventory 文件或者直接指定主机名</span>
</span></span><span style="display:flex;"><span>$ ansible-playbook -i inventory_file execute_local_script.yaml</span></span></code></pre></div><ul>
<li>执行时动态传入主机参数</li>
</ul>
<blockquote>
<ul>
<li><code>your_playbook.yaml</code> 是你的<code>Ansible playbook</code>文件名。</li>
<li><code>target_hosts</code> 是一个变量，可以根据需要设定为具体的主机组名称，比如 <code>web_servers</code>。</li>
<li><code>-l your_target_hosts</code> 是用来指定要执行的主机组的选项，指定执行目标为单个主机 <code>hostname</code>，指定执行目标为多个主机 <code>host1,host2</code>，使用模式匹配选择所有主机名以 <code>web*</code> 开头的主机</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ansible-playbook your_playbook.yaml -e <span style="color:#e6db74">&#34;target_hosts=your_target_hosts&#34;</span> -l your_target_hosts</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h4 id="roles角色"><code>Roles</code>角色</h4>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>playbook-roles/
</span></span><span style="display:flex;"><span>└── roles  <span style="color:#75715e"># 剧本</span>
</span></span><span style="display:flex;"><span>├── mysql
</span></span><span style="display:flex;"><span>│   ├── defaults
</span></span><span style="display:flex;"><span>│   │   └── main.yaml
</span></span><span style="display:flex;"><span>│   ├── files
</span></span><span style="display:flex;"><span>│   ├── handlers
</span></span><span style="display:flex;"><span>│   │   └── main.yaml
</span></span><span style="display:flex;"><span>│   ├── meta
</span></span><span style="display:flex;"><span>│   │   └── main.yaml
</span></span><span style="display:flex;"><span>│   ├── README.md
</span></span><span style="display:flex;"><span>│   ├── tasks
</span></span><span style="display:flex;"><span>│   │   └── main.yaml
</span></span><span style="display:flex;"><span>│   ├── templates
</span></span><span style="display:flex;"><span>│   ├── tests
</span></span><span style="display:flex;"><span>│   │   ├── inventory
</span></span><span style="display:flex;"><span>│   │   └── test.yaml
</span></span><span style="display:flex;"><span>│   └── vars
</span></span><span style="display:flex;"><span>│       └── main.yml
</span></span><span style="display:flex;"><span>├── nginx  	<span style="color:#75715e"># Nginx的角色剧本</span>
</span></span><span style="display:flex;"><span>│   ├── defaults/  	<span style="color:#75715e"># 存放默认变量文件</span>
</span></span><span style="display:flex;"><span>│   │   └── main.yaml
</span></span><span style="display:flex;"><span>│   ├── files/  	<span style="color:#75715e"># 存放需要传输的静态文件</span>
</span></span><span style="display:flex;"><span>│   │   └── index.html
</span></span><span style="display:flex;"><span>│   ├── handlers/  	<span style="color:#75715e"># 触发器目录，在变更时执行操作</span>
</span></span><span style="display:flex;"><span>│   │   └── main.yaml
</span></span><span style="display:flex;"><span>│   ├── meta/  	<span style="color:#75715e"># 存放 role 的元数据文件</span>
</span></span><span style="display:flex;"><span>│   │   └── main.yaml
</span></span><span style="display:flex;"><span>│   ├── README.md  	<span style="color:#75715e"># 用于描述 role 的 README 文件</span>
</span></span><span style="display:flex;"><span>│   ├── tasks/  	<span style="color:#75715e"># 存放主要任务文件，用来安装程序服务</span>
</span></span><span style="display:flex;"><span>│   │   └── main.yaml
</span></span><span style="display:flex;"><span>│   ├── templates/  	<span style="color:#75715e"># 存放模板文件</span>
</span></span><span style="display:flex;"><span>│   │   └── nginx.conf.j2
</span></span><span style="display:flex;"><span>│   ├── tests/  	<span style="color:#75715e"># 存放测试相关文件</span>
</span></span><span style="display:flex;"><span>│   │   ├── inventory
</span></span><span style="display:flex;"><span>│   │   └── test.yaml
</span></span><span style="display:flex;"><span>│   └── vars/  	<span style="color:#75715e"># 存放其他变量文件</span>
</span></span><span style="display:flex;"><span>│       └── main.yaml
</span></span><span style="display:flex;"><span>└── site.yaml  	<span style="color:#75715e"># 定义那个节点或者那组服务器执行，可以定义多个角色剧本</span></span></span></code></pre></div><ul>
<li><code>playbook-roles</code>→<code>site.yaml</code></li>
</ul>
<blockquote>
<ul>
<li><code>name</code><!-- raw HTML omitted -->：每个<!-- raw HTML omitted --><code>play</code><!-- raw HTML omitted -->名字<!-- raw HTML omitted --></li>
<li><code>hosts</code><!-- raw HTML omitted -->：每个<!-- raw HTML omitted --><code>play</code><!-- raw HTML omitted -->涉及被管理的服务器，同<!-- raw HTML omitted --><code>ad-hoc</code><!-- raw HTML omitted -->中的资产选择器<!-- raw HTML omitted --></li>
<li><code>tasks</code><!-- raw HTML omitted -->：每个<!-- raw HTML omitted --><code>play</code><!-- raw HTML omitted -->中具体要完成的任务，以列表的形式表达<!-- raw HTML omitted -->，<code>register: </code><!-- raw HTML omitted -->注册变量<!-- raw HTML omitted --></li>
<li><code>become</code><!-- raw HTML omitted -->：如果需要提权，则加上<!-- raw HTML omitted --><code>become</code><!-- raw HTML omitted -->相关属性<!-- raw HTML omitted --></li>
<li><code>become_user</code><!-- raw HTML omitted -->：若要提权的话，提权到那个用户上<!-- raw HTML omitted --></li>
<li><code>remote_user</code><!-- raw HTML omitted -->：指定连接到远程节点的用户，就是在远程服务器上执行具体操作的用户吗，若不指定，则默认使用当前执行<!-- raw HTML omitted --><code>ansible-playbook</code><!-- raw HTML omitted -->的用户<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->进阶剧本语法<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>when</code><!-- raw HTML omitted -->逻辑判断：<!-- raw HTML omitted --><code>==</code>、<code>!=</code>、<code>&gt; &gt;=</code>、<code>&lt; &lt;=</code>、<code>is defined</code>、<code>is not defined</code>、<code>true/false</code>、<code>and or</code>、</li>
<li><code>include</code><!-- raw HTML omitted -->剧本引用<!-- raw HTML omitted --></li>
<li><code>Handlers</code><!-- raw HTML omitted -->触发器<!-- raw HTML omitted --></li>
</ul>
</blockquote>
</blockquote>
<hr>
<h5 id="rolesnginx"><code>Roles</code>→<code>Nginx</code></h5>
<ul>
<li>
<ol>
<li><code>Roles</code>→<code>Nginx</code><!-- raw HTML omitted -->目录下文件夹配置<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>Files</code><!-- raw HTML omitted -->存放需要传输的静态文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/ansible-playbook/roles/nginx/files/index.html<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">TEST
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><code>Handlers</code><!-- raw HTML omitted -->触发器目录<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/ansible-playbook/roles/nginx/handlers/main.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- name: restart nginx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  service: name=nginx state=restarted
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><code>Tasks</code><!-- raw HTML omitted -->存放主要任务文件，用来安装程序服务<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/ansible-playbook/roles/nginx/tasks/main.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--- # 声明
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- hosts: webservers
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  vars:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    hello: Ansible
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  tasks:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - name: Add repo 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    yum_repository:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      name: nginx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      description: nginx repo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      baseurl: http://nginx.org/packages/centos/7/$basearch/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      gpgcheck: no
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      enabled: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    register: reposyntsx  	# 检测值
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# 定义执行项目名称，安装服务
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - name: Install Nginx packge
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	yum: name={{ item }} state=lates # item 为内置变量
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	with_items:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	- epel-release
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	- nginx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	debug: var=reposyntsx  	# 判断是否成功
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	when: reposyntsx.rc == 0  	# 等于0 代表成功
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# 拷贝文件
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - name: Copy index.html
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	copy: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	  src: index.html
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	  dest: /usr/local/nginx/html/index.html
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# 拷贝文件
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - name: Copy nginx.conf Teplate
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	temlate: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	  src: nginx.conf.j2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	  dest: /usr/local/nginx/conf/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	notify: restart nginx  # nginx.conf.j2 文件拷贝成功，通知handlers(触发器) 重启使之生效
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# 启动服务
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - name: make sure nginx service running
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	service: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	  name: nginx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	  state: started
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	  enabled: yes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# 创建项目目录
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - name: Create wwwroot directory
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	file:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	  dest: /var/www/html
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	  state: directory
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# 创建一个索引文件  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - name: Create test page index.html
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	shell: echo &#34;hello {{hello}}&#34; &gt; /var/www/html/index.html
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><code>Templates</code><!-- raw HTML omitted -->模板目录<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/ansible-playbook/roles/nginx/templates/nginx.conf.j2<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">user  nobody;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">worker_processes {{ ansible_processor_cores }};  	# 服务内置变量
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{# 我是注释 #}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">events {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    worker_connections {{ worker_connections }};  	# 自定义变量
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">http {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    include       mime.types;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    default_type  application/octet-stream;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    sendfile        on;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    keepalive_timeout  65;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    server {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        listen       80;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        server_name  localhost;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        location / {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            root   html;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            index  index.html index.htm;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        error_page   500 502 503 504  /50x.html;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        location = /50x.html {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            root   html;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><code>vars</code><!-- raw HTML omitted -->自定义变量目录<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/ansible-playbook/roles/nginx/vars/main.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">worker_connections: 10240;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><code>site.conf</code>目录</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;site.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">server {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	listen 80;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	server_name www.ctnrs.com;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	location / {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		root /var/www/html;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		index index.html;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>Ansible-Playbook</code><!-- raw HTML omitted -->下<!-- raw HTML omitted --><code>Roles</code><!-- raw HTML omitted -->目录下<!-- raw HTML omitted --><code>site.yaml</code>文件</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>site.yaml</code><!-- raw HTML omitted -->文件，定义那个节点或者那组服务器执行什么程序<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/ansible-playbook/roles/site.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- hosts: web
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  roles:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - nginx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- hosts: mysql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  roles:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - mysql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<hr>
<h4 id="-playbook完整剧本示例"><code> Playbook</code>完整剧本示例</h4>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/ansible-playbook/nginx.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- hosts: web_server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">vars:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    app_path: &#34;{{ base_path }}/app&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    http_port: 80
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    max_clients: 256
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  become: true  	# 需要目标主机的用户具有sudo权限
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  tasks:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - name: ensure apache is at the latest version
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    yum: name=httpd state=latest
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - name: ensure apahech is running
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    service: name=httpd state=started
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - name:  	# 创建或修改文件&amp;目录
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    file:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      path: /tmp/demo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      state: directory
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      mode: 0755
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - name:  	# 拷贝文件到目标主机
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    copy:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      src: /etc/hostname
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      dest: /tmp/demo/hostname
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - name: disable selinux
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    command: /sbin/setenforce 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - name: run this command and ignore the result
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    shell: /usr/bin/somecommand || /bin/true 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ignore_errors: True  	# 忽略报错信息
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - name:  	# 用模板生成配置文件
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    template:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      src: demo.j2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      dest: &#34;{{ ansible_user_dir }}/demo.cfg&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  handlers
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - name: restart apache
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      service: name=httpd state=restart
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat <span style="color:#e6db74">&lt;&lt;EOF &gt;roles/demo-role/tasks/main.yml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- include: yum.yml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  when: (ansible_distribution|lower == &#39;redhat&#39;) or (ansible_distribution|lower == &#39;centos&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- include: apt.yml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  when: (ansible_distribution|lower == &#39;debian&#39;) or (ansible_distribution|lower == &#39;ubuntu&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat <span style="color:#e6db74">&lt;&lt;EOF &gt;roles/demo-role/tasks/yum.yml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- name:  	# 使用Yum安装Apache服务
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  yum:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: &#34;{{ redhat_app }}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    state: &#34;{{ app_state }}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  notify:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - done
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat <span style="color:#e6db74">&lt;&lt;EOF &gt;roles/demo-role/tasks/apt.yml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- name:  	# 使用Apt安装Apache服务
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  apt:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: &#34;{{ debian_app }}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    state: &#34;{{ app_state }}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  notify:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - done
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat <span style="color:#e6db74">&lt;&lt;EOF &gt;roles/demo-role/vars/main.yml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">redhat_app: httpd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">debian_app: apache2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat <span style="color:#e6db74">&lt;&lt;EOF &gt;roles/demo-role/handlers/main.yml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- name: done
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  debug:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    msg: &#34;Apache服务已部署&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->自动部署<!-- raw HTML omitted --><code>Tomcat</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">hosts</span>: <span style="color:#ae81ff">webservers </span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">gather_facts</span>: <span style="color:#66d9ef">no</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">vars</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">tomcat_version</span>: <span style="color:#ae81ff">8.5.34</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">tomcat_install_dir</span>: <span style="color:#ae81ff">/usr/local</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>	- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Install jdk1.8</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">yum</span>: <span style="color:#ae81ff">name=java-1.8.0-openjdk state=present</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Download tomcat</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#f92672">get_url</span>: <span style="color:#ae81ff">url=http://mirrors.hust.edu.cn/apache/tomcat/tomcat-</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8</span><span style="color:#ae81ff">/v{{ tomcat_version }}/bin/apache-tomcat-{{ tomcat_version }}.tar.gz dest=/tmp</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Unarchive tomcat-{{ tomcat_version }}.tar.gz</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#f92672">unarchive</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">src</span>: <span style="color:#ae81ff">/tmp/apache-tomcat-{{ tomcat_version }}.tar.gz </span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">dest</span>: <span style="color:#e6db74">&#34;{{ tomcat_install_dir }}&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">copy</span>: <span style="color:#66d9ef">no</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Start tomcat </span>
</span></span><span style="display:flex;"><span>	  <span style="color:#f92672">shell</span>: <span style="color:#ae81ff">cd {{ tomcat_install_dir }} &amp;&amp;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">mv apache-tomcat-{{ tomcat_version }} tomcat8 &amp;&amp;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">cd tomcat8/bin &amp;&amp; nohup ./startup.sh &amp;</span></span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_slatstack">Install_Slatstack</h1>

<h2 id="slatstack"><code>Slatstack</code></h2>
<blockquote>
<ul>
<li><a href="https://blog.51cto.com/u_14316149/2421229" rel="external" target="_self"><code>Saltstack</code>基本命令,模块,组件详解</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ salt <span style="color:#e6db74">&#34;*&#34;</span> sys.doc &gt; /tmp/saltstack-status.txt</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_ansible">Install_Ansible</h1>

<h2 id="mark控制机mark和mark目标机mark"><!-- raw HTML omitted -->控制机<!-- raw HTML omitted -->和<!-- raw HTML omitted -->目标机<!-- raw HTML omitted --></h2>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->控制机：<!-- raw HTML omitted -->安装<code>Python</code>、<code>Docker</code>、<code>Pip</code>和<code>Sshpass</code></li>
<li><!-- raw HTML omitted -->目标机：<!-- raw HTML omitted -->安装<code>Python</code></li>
</ul>
<table>
<thead>
<tr>
<th>地址</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://blog.51cto.com/lizhenliang" rel="external" target="_self">阿良老师博客</a></td>
<td></td>
<td></td>
</tr>
<tr>
<td><a href="https://releases.ansible.com/ansible/" rel="external" target="_self"><code>Ansible</code>安装包</a></td>
<td><code>Ansible</code>官网</td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/ansible/ansible" rel="external" target="_self"><code>Github-Ansible</code>原代码</a></td>
<td><code>Github Ansible</code>原代码</td>
<td></td>
</tr>
<tr>
<td><a href="https://docs.ansible.com/ansible/latest/installation_guide/index.html" rel="external" target="_self"><code>Install Ansible</code></a></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h3 id="安装控制端程序">安装控制端程序</h3>
<h4 id="font-colorred安装fontansible"><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>Ansible</code></h4>
<blockquote>
<ul>
<li><code>yum</code><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>Ansible</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rpm -Uvh http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm
</span></span><span style="display:flex;"><span>$ rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-6
</span></span><span style="display:flex;"><span>$ yum -y install epel-release
</span></span><span style="display:flex;"><span>$ sudo yum -y install ansible</span></span></code></pre></div><ul>
<li><code>apt</code><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>Ansible</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo apt-get install python-dev
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;/etc/apt/source.list<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">deb http://ppa.launchpad.net/ansible/ansible/ubuntu trusty main
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">deb-src http://ppa.launchpad.net/ansible/ansible/ubuntu trusty main
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo apt-get install software-properties-common
</span></span><span style="display:flex;"><span>$ sudo apt-add-repository ppa:ansible/ansible
</span></span><span style="display:flex;"><span>$ sudo apt-get update
</span></span><span style="display:flex;"><span>$ sudo apt-get install ansible</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>Python</code>的<code>pip</code><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>Ansible</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ pip install ansible
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ curl https://raw.githubusercontent.com/mitsuhiko/pipsi/master/get-pipsi.py | <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>python
</span></span><span style="display:flex;"><span>$ pipsi install ansible</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->源码安装<!-- raw HTML omitted --><code>Ansible</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git clone git://github.com/ansible/ansible.git
</span></span><span style="display:flex;"><span>$ cd ./ansible
</span></span><span style="display:flex;"><span>$ make rpm
</span></span><span style="display:flex;"><span>$ sudo rpm -Uvh ~/rpmbuild/ansible-*.noarch.rpm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ git clone git://github.com/ansible/ansible.git --recursive
</span></span><span style="display:flex;"><span>$ cd ./ansible
</span></span><span style="display:flex;"><span>$ source ./hacking/env-setup
</span></span><span style="display:flex;"><span>$ sudo easy_install pip
</span></span><span style="display:flex;"><span>$ sudo pip install paramiko PyYAML Jinja2 httplib2</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->升级<!-- raw HTML omitted --><code>Ansible</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git pull --rebase
</span></span><span style="display:flex;"><span>$ git submodule update --init --recursive</span></span></code></pre></div></blockquote>
<hr>
<h4 id="font-colorred安装fontpython"><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>Python</code></h4>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum install python-pip python3  	<span style="color:#75715e"># 安装python 3</span>
</span></span><span style="display:flex;"><span>$ python3.6 -m pip install --upgrade --force pip  	<span style="color:#75715e"># 通过 python 3 安装pip3</span></span></span></code></pre></div></blockquote>
<hr>
<h4 id="font-colorred安装fontdocker"><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>Docker</code></h4>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ yum makecache fast
</span></span><span style="display:flex;"><span>$ yum list docker-ce  --showduplicates|sort -r
</span></span><span style="display:flex;"><span>$ yum install -y docker-ce-20.10.4 docker-ce-cli-20.10.4 containerd.io docker-compose-plugin
</span></span><span style="display:flex;"><span>$ systemctl enable docker <span style="color:#f92672">&amp;&amp;</span> systemctl start docker</span></span></code></pre></div></blockquote>
<hr>
<h4 id="font-colorred安装fontsshpass"><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>Sshpass</code></h4>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install sshpass</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          </section>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="backend">Backend</h1>


            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Backend</h1>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="tomcat">Tomcat</h1>


            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Tomcat</h1>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="configure_tomcat">Configure_Tomcat</h1>

<h2 id="配置tomcat">配置<code>Tomcat</code></h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->清理<!-- raw HTML omitted --><code>Tomcat</code><!-- raw HTML omitted -->日志<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->清理超过七天以上的日<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;#!/bin/bash/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">tomdate=&#34;</span><span style="color:#66d9ef">$(</span>date +<span style="color:#e6db74">&#34;%Y%m%d%s&#34;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">tomlog=&#39;/opt/logs/tomcat*&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo </span>$tomdate<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># echo </span>$tomlog<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">find </span>$tomlog<span style="color:#e6db74">/*.log  -type f -ctime +7 -exec  rm  -f  {}  \;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">find </span>$tomlog<span style="color:#e6db74">/*.txt  -type f -ctime +7 -exec  rm  -f  {}  \; &#34;</span>&gt;/opt/scripts/DEL_TOMLOG.sh</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->清理日志脚本添加到计划任务<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;### tomcat超過七天log刪除
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">1 0 * * * /bin/bash /opt/scripts/DEL_TOMLOG.sh &gt;&gt; ~/del_tom.log 2&gt;&amp;1&#34;</span> &gt;&gt; /var/spool/cron/myadmin</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->日志做每日切割<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;/opt/data/logs/tomcat/catalina.out{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">copytruncate
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">daily
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rotate 7
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">missingok
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">compress
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">size 100k
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">su root root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">} &#34;</span>&gt;&gt; /etc/logrotate.d/tomcat  </span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->安全设置规范<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>  telnet</code><!-- raw HTML omitted -->管理端口保护（强制）<!-- raw HTML omitted --></li>
</ul>
<table>
<thead>
<tr>
<th>类别</th>
<th>配置内容及说明</th>
<th>标准配置</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>telnet</code>管理端口保护</td>
<td>1.修改默认的<code>8005</code>管理端口为不易猜测的端口（大于1024）；  <!-- raw HTML omitted -->2.修改<code>SHUTDOWN</code>指令为其他字符串；</td>
<td><!-- raw HTML omitted --></td>
<td>1.以上配置项的配置内容只是建议配置，可以按照服务实际情况进行合理配置，但要求端口配置在<strong>8000~8999</strong>之间；</td>
</tr>
</tbody>
</table>
<ul>
<li><code>ajp</code><!-- raw HTML omitted -->连接端口保护（推荐）<!-- raw HTML omitted --></li>
</ul>
<table>
<thead>
<tr>
<th>类别</th>
<th>配置内容及说明</th>
<th>标准配置</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>Ajp  连接端口保护</td>
<td>1.修改默认的<code>ajp 8009</code>端口为不易冲突的大于1024端口；  2.通过<code>iptables</code>规则限制<code>ajp</code>端口访问的权限仅为线上机器；</td>
<td><!-- raw HTML omitted --></td>
<td>以上配置项的配置内容仅为建议配置，请按照服务实际情况进行合理配置，但要求端口配置在<strong>8000~8999</strong>之间；；  保护此端口的目的在于防止线下的测试流量被<code>mod_jk</code>转发至线上<code>tomcat</code>服务器；</td>
</tr>
</tbody>
</table>
<ul>
<li><!-- raw HTML omitted -->禁用管理端（强制）<!-- raw HTML omitted --></li>
</ul>
<table>
<thead>
<tr>
<th>类别</th>
<th>配置内容及说明</th>
<th>标准配置</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>禁用管理端</td>
<td>1. 删除默认的{<code>Tomcat</code>安装目录}<code>/conf/tomcat-users.xml</code>文件，重启<code>tomcat</code>后将会自动生成新的文件；  2. 删除{<code>Tomcat</code>安装目录}<code>/webapps</code>下默认的所有目录和文件；  3.将<code>tomcat</code>应用根目录配置为<code>tomcat</code>安装目录以外的目录；</td>
<td><!-- raw HTML omitted --></td>
<td>对于前段<code>web</code>模块，<code>Tomcat</code>管理端属于<code>tomcat</code>的高危安全隐患，一旦被攻破，黑客通过上传<code>web shell</code>的方式将会直接取得服务器的控制权，后果极其严重；</td>
</tr>
</tbody>
</table>
<ul>
<li><!-- raw HTML omitted -->降权启动（强制）<!-- raw HTML omitted --></li>
</ul>
<table>
<thead>
<tr>
<th>类别</th>
<th>配置内容及说明</th>
<th>标准配置</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>降权启动</td>
<td>1.<code>tomcat</code>启动用户权限必须为非<code>root</code>权限，尽量降低<code>tomcat</code>启动用户的目录访问权限； <!-- raw HTML omitted --> 2.如需直接对外使用<code>80</code>端口，可通过普通账号启动后，配置<code>iptables</code>规则进行转发；</td>
<td>-</td>
<td>避免一旦<code>tomcat</code>服务被入侵，黑客直接获取高级用户权限危害整个<code>server</code>的安全；</td>
</tr>
</tbody>
</table>
<ul>
<li><!-- raw HTML omitted --> 文件列表访问控制（强制）<!-- raw HTML omitted --></li>
</ul>
<table>
<thead>
<tr>
<th>类别</th>
<th>配置内容及说明</th>
<th>标准配置</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>文件列表访问控制</td>
<td>1.<code>conf/web.xml</code>文件中<code>default</code>部分<code>listings</code>的配置必须为<code>false</code>；</td>
<td><!-- raw HTML omitted -->  <!-- raw HTML omitted --><strong>listings</strong><!-- raw HTML omitted -->  <!-- raw HTML omitted --><strong>false</strong><!-- raw HTML omitted -->  <!-- raw HTML omitted --></td>
<td><code>false</code>为不列出目录文件，<code>true</code>为允许列出，默认为<code>false</code>；</td>
</tr>
</tbody>
</table>
<ul>
<li><!-- raw HTML omitted -->版本信息隐藏（强制）<!-- raw HTML omitted --></li>
</ul>
<table>
<thead>
<tr>
<th>类别</th>
<th>配置内容及说明</th>
<th>标准配置</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>版本信息隐藏</td>
<td>1.修改<code>conf/web.xml</code>，重定向<code>403</code>、<code>404</code>以及<code>500</code>等错误到指定的错误页面；  2.也可以通过修改应用程序目录下的<code>WEB-INF/web.xml</code>下的配置进行错误页面的重定向；</td>
<td><!-- raw HTML omitted -->  <!-- raw HTML omitted --><strong>403</strong><!-- raw HTML omitted -->  <!-- raw HTML omitted --><strong>/forbidden.jsp</strong><!-- raw HTML omitted -->  <!-- raw HTML omitted -->  <!-- raw HTML omitted -->  <!-- raw HTML omitted --><strong>404</strong><!-- raw HTML omitted -->  <!-- raw HTML omitted --><strong>/notfound.jsp</strong><!-- raw HTML omitted -->  <!-- raw HTML omitted -->  <!-- raw HTML omitted -->  <!-- raw HTML omitted --><strong>500</strong><!-- raw HTML omitted -->  <!-- raw HTML omitted --><strong>/systembusy.jsp</strong><!-- raw HTML omitted -->  <!-- raw HTML omitted --></td>
<td>在配置中对一些常见错误进行重定向，避免当出现错误时tomcat默认显示的错误页面暴露服务器和版本信息；  必须确保程序根目录下的错误页面已经存在；</td>
</tr>
</tbody>
</table>
<ul>
<li>2.7 <!-- raw HTML omitted --><code>  Server header</code>重写（推荐）<!-- raw HTML omitted --></li>
</ul>
<table>
<thead>
<tr>
<th>类别</th>
<th>配置内容及说明</th>
<th>标准配置</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Server header</code>重写</td>
<td>在<code>HTTP Connector</code>配置中加入<code>server</code>的配置；</td>
<td>server=&quot;<strong>webserver</strong>&quot;</td>
<td>当<code>tomcat HTTP</code>端口直接提供<code>web</code>服务时此配置生效，加入此配置，将会替换<code>http</code> 响应<code>Server header</code>部分的默认配置，默认是<code>Apache-Coyote/1.1</code></td>
</tr>
</tbody>
</table>
<ul>
<li><!-- raw HTML omitted --> 访问限制（可选）<!-- raw HTML omitted --></li>
</ul>
<table>
<thead>
<tr>
<th>类别</th>
<th>配置内容及说明</th>
<th>标准配置或操作</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>访问限制</td>
<td>通过配置，限定访问的<code>ip</code>来源</td>
<td><!-- raw HTML omitted -->  &lt;Valve  className=&ldquo;org.apache.catalina.valves.RemoteAddrValve&rdquo; <strong>allow=&ldquo;61.148.18.138,61.135.165.*&rdquo;  deny=&quot;*.*.*.*&quot;</strong>/&gt;  <!-- raw HTML omitted --></td>
<td>通过配置信任<code>ip</code>的白名单，拒绝非白名单<code>ip</code>的访问，此配置主要是针对高保密级别的系统，一般产品线不需要；</td>
</tr>
</tbody>
</table>
<ul>
<li><!-- raw HTML omitted -->起停脚本权限回收（推荐）<!-- raw HTML omitted --></li>
</ul>
<table>
<thead>
<tr>
<th>类别</th>
<th>配置内容及说明</th>
<th>标准配置或操作</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>起停脚本权限回收</td>
<td>去除其他用户对<code>Tomcat</code>的<code>bin</code>目录下<code>shutdown.sh</code>、<code>startup.sh</code>、<code>catalina.sh</code>的可执行权限；</td>
<td>chmod -R 744 tomcat/bin/*</td>
<td>防止其他用户有起停线上<code>Tomcat</code>的权限；</td>
</tr>
</tbody>
</table>
<ul>
<li><!-- raw HTML omitted -->访问日志格式规范（推荐）<!-- raw HTML omitted --></li>
</ul>
<table>
<thead>
<tr>
<th>类别</th>
<th>配置内容及说明</th>
<th>标准配置或操作</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>访问日志格式规范</td>
<td>开启<code>Tomcat</code>默认访问日志中的<code>Referer</code>和<code>User-Agent</code>记录</td>
<td><!-- raw HTML omitted --></td>
<td>开启<code>Referer</code>和<code>User-Agent</code>是为了一旦出现安全问题能够更好的根据日志进行问题排查；</td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->建议配置及标准执行方案<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->配置部分<!-- raw HTML omitted --><code>${CATALINA_HOME}conf/server.xml</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;<span style="color:#e6db74">${</span>CATALINA_HOME<span style="color:#e6db74">}</span>conf/server.xml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;Server port=&#34;8527&#34; shutdown=&#34; dangerous&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;!-- Define a non-SSL HTTP/1.1 Connector on port 8080 --&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;Connector port=&#34;8080&#34; server=&#34;webserver&#34;/&gt; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;!-- Define an AJP 1.3 Connector on port 8528 --&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;!--Define an accesslog --&gt; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;Valve className=&#34;org.apache.catalina.valves.AccessLogValve&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                 directory=&#34;logs&#34;  prefix=&#34;localhost_access_log.&#34; suffix=&#34;.txt&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                 pattern=&#34;%h %l %u %t %r %s %b %{Referer}i %{User-Agent}i %D&#34; resolveHosts=&#34;false&#34;/&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &lt;Connector port=&#34;8528&#34; protocol=&#34;AJP/1.3&#34; /&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;Context path=&#34;&#34; docBase=&#34;/home/work/local/tomcat_webapps&#34; debug=&#34;0&#34; reloadable=&#34;false&#34; crossContext=&#34;true&#34;/&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->配置部分<!-- raw HTML omitted --><code>${CATALINA_HOME}conf/web.xml</code><!-- raw HTML omitted -->或者<!-- raw HTML omitted --><code>WEB-INF/web.xml</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;<span style="color:#e6db74">${</span>CATALINA_HOME<span style="color:#e6db74">}</span>conf/web.xml或者WEB-INF/web.xml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;init-param&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	&lt;param-name&gt;listings&lt;/param-name&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	&lt;param-value&gt;false&lt;/param-value&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;/init-param&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;error-page&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	&lt;error-code&gt;403&lt;/error-code&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	&lt;location&gt;/forbidden.jsp&lt;/location&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;/error-page&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;error-page&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	&lt;error-code&gt;404&lt;/error-code&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	&lt;location&gt;/notfound.jsp&lt;/location&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;/error-page&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;error-page&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	&lt;error-code&gt;500&lt;/error-code&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	&lt;location&gt;/systembusy.jsp&lt;/location&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;/error-page&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->删除如下<code>tomcat</code>的默认目录和默认文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rm -rf tomcat/webapps/*
</span></span><span style="display:flex;"><span>$ rm -rf tomcat/conf/tomcat-user.xml</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->去除其他用户对<code>tomcat</code>起停脚本的执行权限<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ chmod <span style="color:#ae81ff">744</span> –R tomcat/bin/*</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_tomcat">Install_Tomcat</h1>

<h2 id="部署tomcat服务">部署<code>Tomcat</code>服务</h2>
<blockquote>
<ul>
<li>
<ol>
<li><a href="https://tomcat.apache.org/" rel="external" target="_self"><code>Tomcat</code>官网</a></li>
</ol>
</li>
<li>
<ol start="2">
<li><a href="https://archive.apache.org/dist/tomcat/tomcat-8/v8.5.35/bin/" rel="external" target="_self"><code>8.3.x</code>版本<code>Tomcat</code>安装包</a></li>
</ol>
</li>
</ul>
</blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>Tomcat</code><!-- raw HTML omitted -->前准备<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->创建<!-- raw HTML omitted --><code>Tomcat</code><!-- raw HTML omitted -->启动用户<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ groupadd myadmin <span style="color:#f92672">&amp;&amp;</span> useradd -g myadmin myadmin  
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;20210627@123&#34;</span>|passwd --stdin myadmin &amp;&gt;/dev/null
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;#########Start/Stop Service###############
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Cmnd_Alias MYADMIN_START_SERVICES = /etc/init.d/nginx, /etc/init.d/tomcat, /opt/* /usr/bin/kill
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">myadmin ALL=(ALL)NOPASSWD:MYADMIN_START_SERVICES&#34;</span> &gt; /etc/sudoers.d/myadmin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ chmod <span style="color:#ae81ff">660</span> /etc/sudoers.d/myadmin  </span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->创建<!-- raw HTML omitted --><code>Tomcat</code><!-- raw HTML omitted -->部署目录<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -p /opt/<span style="color:#f92672">{</span>data,apps,src,deploy,scripts,logs/tomcat<span style="color:#f92672">}</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->检测<!-- raw HTML omitted --><code>JDK</code><!-- raw HTML omitted -->环境<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum list |grep openjdk  	<span style="color:#75715e"># 包有 @ 代表安装</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;#######JDK環境變數########################  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export JAVA_HOME=/opt/data/jdk  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export JRE_HOME=</span>$JAVA_HOME<span style="color:#e6db74">/jre  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export CLASSPATH=</span>$JAVA_HOME<span style="color:#e6db74">/lib:</span>$JAVA_HOME<span style="color:#e6db74">/lib/tools.jar  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export PATH=</span>$PATH<span style="color:#e6db74">:</span>$JAVA_HOME<span style="color:#e6db74">/bin:</span>$JAVA_HOME<span style="color:#e6db74">/jre/bin    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">CATALINA_HOME=/opt/data/tomcat  	# 部署多实例启动脚本应用    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export CATALINA_HOME &#34;</span>&gt;&gt;/home/myadmin/.bash_profile
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ source /home/myadmin/.bash_profile
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ln -s /opt/data/jdk/bin/java /sbin/java  	<span style="color:#75715e"># 使jar包可以直接运行,后面做软连接,授权  </span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->下载安装<!-- raw HTML omitted --><code>Tomcat</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->下载<!-- raw HTML omitted --><code>Tomcat</code><!-- raw HTML omitted -->安装包<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget -P /opt/src/ https://archive.apache.org/dist/tomcat/tomcat-8/v8.5.35/bin/apache-tomcat-8.5.35.tar.gz 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ wget -P /opt/src/ https://archive.apache.org/dist/tomcat/tomcat-8/v8.5.35/bin/apache-tomcat-8.5.35.tar.gz.sha512</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->检测安装包完整性<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># md5sum -c apache-tomcat-6.0.35.tgz.md5</span>
</span></span><span style="display:flex;"><span>$ sha512sum -c apache-tomcat-8.5.35.tar.gz.sha512</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->解压以及更改权限<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># ln -s /opt/lucky/apache-tomcat-8.5.35 /opt/data/tomcat  	# 可做软连接</span>
</span></span><span style="display:flex;"><span>$ tar -zxvf /opt/src/apache-tomcat-8.5.35.tar.gz -C /opt/data/</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>Tomcat</code><!-- raw HTML omitted -->主配置文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;s/8080/8000/g&#34;</span> /opt/data/tomcat/conf/server.xml 
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s/logs/\/opt\/data\/logs\/tomcat/g&#39;</span> /opt/data/tomcat/conf/server.xml</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>Tomcat</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>Cataline.sh</code><!-- raw HTML omitted -->文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;/# OS specific support/iJAVA_OPTS=&#34;-Dfile.encoding=UTF-8 -server -Xms2048m -Xmx2048m -Xmn1024m -XX:SurvivorRatio=10 -XX:MaxTenuringThreshold=15 -XX:NewRatio=2 -XX:+DisableExplicitGC&#34;&#39;</span> /opt/data/tomcat/bin/catalina.sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s/&#34;$CATALINA_BASE&#34;\/logs\/catalina.out/\/opt\/data\/logs\/tomcat\/catalina.out/g&#39;</span> /opt/data/tomcat/bin/catalina.sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># sed -i &#39;/      &lt;\/Host&gt;/i\        &lt;Context path=&#34;/&#34; docBase=&#34;/opt/lucky/publish-luckybackend&#34; reloadable=&#34;true&#34;&gt;&lt;\/Context&gt;&#39; /opt/data/tomcat/conf/server.xml</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s/${catalina.base}\/logs/\/opt\/data\/logs\/tomcat/g&#39;</span> /opt/data/tomcat/conf/logging.properties</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->防火墙开放端口<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>
<p><code>8005</code><!-- raw HTML omitted -->：端口是<!-- raw HTML omitted --><code>tomcat</code><!-- raw HTML omitted -->本身管理端口，修改一个不易猜到<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>8080</code><!-- raw HTML omitted -->：端口是<!-- raw HTML omitted --><code>tomcat</code><!-- raw HTML omitted -->负责建立<!-- raw HTML omitted --><code>HTTP</code><!-- raw HTML omitted -->连接。在通过浏览器访问<!-- raw HTML omitted --><code>tomcat</code><!-- raw HTML omitted -->服务器的<!-- raw HTML omitted --><code>web</code><!-- raw HTML omitted -->应用时，使用的就是这个端口<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>8009</code>：<code>tomcat</code><!-- raw HTML omitted -->负责和其他的<!-- raw HTML omitted --><code>HTTP</code><!-- raw HTML omitted -->服务器建立连接，如<!-- raw HTML omitted --><code>nginx</code>和<code>apache</code><!-- raw HTML omitted -->互通使用<!-- raw HTML omitted --></p>
</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ firewall-cmd --permanent --new-ipset<span style="color:#f92672">=</span>tomcat_whitelist --type<span style="color:#f92672">=</span>hash:ip  
</span></span><span style="display:flex;"><span>$ firewall-cmd --permanent --add-rich-rule<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;rule family=&#39;ipv4&#39; source ipset=&#39;tomcat_whitelist&#39; port prot=&#39;7000-7007&#39; protocol=&#39;tcp&#39; accept&#34;</span>  
</span></span><span style="display:flex;"><span>$ firewall-cmd --reload </span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->网站根目录以及连接数据库<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 默认网站的主目录</span>
</span></span><span style="display:flex;"><span>$ ls /usr/local/tomcat/webapps/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;/usr/local/tomcat/webapps/ROOT/WEB-INF/config/jdbc.properties<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># jdbc.url=jdbc:mysql://192.168.213.50:16303/jspgou?characterEncoding=UTF-8  	# jspgou代表数据库
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># jdbc.username=root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># jdbc.password=123
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->启动<!-- raw HTML omitted --><code>Tomcat</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /opt/data/tomcat/bin/startup.sh </span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->编写<!-- raw HTML omitted --><code>Tomcat</code><!-- raw HTML omitted -->启动文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;tomcat.sh<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">TOMCAT_PATH=/usr/local/tomcat
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">usage(){
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo &#34;Usage: $0 [start|stop|status|restart]&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">status_tomcat(){
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ps aux | grep java | grep tomcat | grep -v &#39;grep&#39; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">start_tomcat(){
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/usr/local/tomcat/bin/startup.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">stop_tomcat(){
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">TPID=$(ps aux | grep java | grep tomcat | grep -v &#39;grep&#39; | awk &#39;{print $2}&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kill -9 $TPID
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sleep 5;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">TSTAT=$(ps aux | grep java | grep tomcat | grep -v &#39;grep&#39; | awk &#39;{print $2}&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> if [ -z $TSTAT ];then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   echo &#34;tomcat stop&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> else
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   kill -9 $TSTAT
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">cd $TOMCAT_PATH
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rm temp/* -rf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rm work/* -rf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">main(){
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">case $1 in
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">start)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   start_tomcat;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">stop)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   stop_tomcat;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">status)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   status_tomcat;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">restart)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   stop_tomcat &amp;&amp; start_tomcat;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> *)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   usage;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">esac
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">main $1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->多端口启动<!-- raw HTML omitted --><code>Tomcat</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;tomcat<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 此脚本用来启动停止以及查看tomcat多实例
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 2021/04/18	author：Neek
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export JAVA_HOME=/opt/lucky/jdk
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export JRE_HOME=$JAVA_HOME/jre
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export CLASSPATH=$JAVA_HOME/lib:$JAVA_HOME/lib/tools.jar
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export PATH=$PATH:$JAVA_HOME/bin:$JAVA_HOME/jre/bin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 目录
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">CATALINA_BASE=&#39;/opt/lucky/tomcat/&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WEBAPPS_PATH=&#39;/opt/lucky/tomcat/webapps&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">CATALINA_HOME=&#39;/opt/lucky/tomcat/&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">. /etc/init.d/functions
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">read -p &#34;请输入要启动的的端口号，8080,6000，7000~7007，8818：&#34; port
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">case $port in
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> 8080)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  export CATALINA_BASE=&#34;/opt/lucky/tomcat&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  read -p &#34;启动停止tomcat以及查看状态，确定请输入操作指令(start/stop/restart/status)：&#34; port_st
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  case &#34;$port_st&#34; in
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   start)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/startup.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   stop)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/shutdown.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   restart)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/shutdown.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    sleep 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/startup.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   status)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	tomcat_status=$(ss -unplt |egrep 8080 |egrep -i listen)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        [ -z &#34;$tomcat_status&#34; ] &amp;&amp; echo -e &#34;\ntomcat\033[31m start failed ...\033[0m\n&#34; || echo -e &#34;\ntomcat\033[32m is running ...\033[0m\n&#34; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  esac;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> 6000)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  export CATALINA_BASE=&#34;/opt/lucky/tomcat/6000/&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  read -p &#34;启动停止tomcat以及查看状态，确定请输入操作指令(start/stop/restart/status)：&#34; port_st
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  case &#34;$port_st&#34; in
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   start)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/startup.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   stop)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/shutdown.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   restart)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/shutdown.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    sleep 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/startup.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   status)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	tomcat_status=$(ss -unplt |egrep 6000 |egrep -i listen)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        [ -z &#34;$tomcat_status&#34; ] &amp;&amp; echo -e &#34;\ntomcat\033[31m start failed ...\033[0m\n&#34; || echo -e &#34;\ntomcat\033[32m is running ...\033[0m\n&#34; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  esac;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> 7000)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  export CATALINA_BASE=&#34;/opt/lucky/tomcat/7000/&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  read -p &#34;启动停止tomcat确定吗？确定请输入操作指令(start/stop/restart)：&#34; port_st
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  case &#34;$port_st&#34; in
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   start)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/startup.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   stop)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/shutdown.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   restart)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/shutdown.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    sleep 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/startup.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   status)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	tomcat_status=$(ss -unplt |egrep 7000 |egrep -i listen)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        [ -z &#34;$tomcat_status&#34; ] &amp;&amp; echo -e &#34;\ntomcat\033[31m start failed ...\033[0m\n&#34; || echo -e &#34;\ntomcat\033[32m is running ...\033[0m\n&#34; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   esac;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> 7001)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  export CATALINA_BASE=&#34;/opt/lucky/tomcat/7001/&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  read -p &#34;启动停止tomcat以及查看状态，确定请输入操作指令(start/stop/restart/status)：&#34; port_st
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  case &#34;$port_st&#34; in
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   start)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/startup.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   stop)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/shutdown.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   restart)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/shutdown.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    sleep 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/startup.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   status)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	tomcat_status=$(ss -unplt |egrep 7001 |egrep -i listen)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        [ -z &#34;$tomcat_status&#34; ] &amp;&amp; echo -e &#34;\ntomcat\033[31m start failed ...\033[0m\n&#34; || echo -e &#34;\ntomcat\033[32m is running ...\033[0m\n&#34; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   esac;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> 7002)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  export CATALINA_BASE=&#34;/opt/lucky/tomcat/7002/&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  read -p &#34;启动停止tomcat以及查看状态，确定请输入操作指令(start/stop/restart/status)：&#34; port_st
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  case &#34;$port_st&#34; in
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   start)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/startup.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   stop)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/shutdown.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   restart)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/shutdown.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    sleep 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/startup.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   status)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	tomcat_status=$(ss -unplt |egrep 7002 |egrep -i listen)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        [ -z &#34;$tomcat_status&#34; ] &amp;&amp; echo -e &#34;\ntomcat\033[31m start failed ...\033[0m\n&#34; || echo -e &#34;\ntomcat\033[32m is running ...\033[0m\n&#34; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   esac;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> 7003)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  export CATALINA_BASE=&#34;/opt/lucky/tomcat/7003/&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  read -p &#34;启动停止tomcat以及查看状态，确定请输入操作指令(start/stop/restart/status)：&#34; port_st
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  case &#34;$port_st&#34; in
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   start)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/startup.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   stop)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/shutdown.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   restart)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/shutdown.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    sleep 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/startup.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   status)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	tomcat_status=$(ss -unplt |egrep 7003 |egrep -i listen)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        [ -z &#34;$tomcat_status&#34; ] &amp;&amp; echo -e &#34;\ntomcat\033[31m start failed ...\033[0m\n&#34; || echo -e &#34;\ntomcat\033[32m is running ...\033[0m\n&#34; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   esac;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> 7004)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  export CATALINA_BASE=&#34;/opt/lucky/tomcat/7004/&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  read -p &#34;启动停止tomcat以及查看状态，确定请输入操作指令(start/stop/restart/status)：&#34; port_st
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  case &#34;$port_st&#34; in
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   start)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/startup.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   stop)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/shutdown.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   restart)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/shutdown.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    sleep 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/startup.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   status)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	tomcat_status=$(ss -unplt |egrep 7004 |egrep -i listen)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        [ -z &#34;$tomcat_status&#34; ] &amp;&amp; echo -e &#34;\ntomcat\033[31m start failed ...\033[0m\n&#34; || echo -e &#34;\ntomcat\033[32m is running ...\033[0m\n&#34; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   esac;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> 7005)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  export CATALINA_BASE=&#34;/opt/lucky/tomcat/7005/&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  read -p &#34;启动停止tomcat以及查看状态，确定请输入操作指令(start/stop/restart/status)：&#34; port_st
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  case &#34;$port_st&#34; in
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   start)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/startup.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   stop)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/shutdown.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   restart)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/shutdown.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    sleep 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/startup.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   status)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	tomcat_status=$(ss -unplt |egrep 7005 |egrep -i listen)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        [ -z &#34;$tomcat_status&#34; ] &amp;&amp; echo -e &#34;\ntomcat\033[31m start failed ...\033[0m\n&#34; || echo -e &#34;\ntomcat\033[32m is running ...\033[0m\n&#34; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   esac;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> 7006)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  export CATALINA_BASE=&#34;/opt/lucky/tomcat/7006/&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  read -p &#34;启动停止tomcat以及查看状态，确定请输入操作指令(start/stop/restart/status)：&#34; port_st
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  case &#34;$port_st&#34; in
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   start)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/startup.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   stop)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/shutdown.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   restart)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/shutdown.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    sleep 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/startup.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   status)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	tomcat_status=$(ss -unplt |egrep 7006 |egrep -i listen)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        [ -z &#34;$tomcat_status&#34; ] &amp;&amp; echo -e &#34;\ntomcat\033[31m start failed ...\033[0m\n&#34; || echo -e &#34;\ntomcat\033[32m is running ...\033[0m\n&#34; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   esac;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> 7007)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  export CATALINA_BASE=&#34;/opt/lucky/tomcat/7007/&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  read -p &#34;启动停止tomcat以及查看状态，确定请输入操作指令(start/stop/restart/status)：&#34; port_st
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  case &#34;$port_st&#34; in
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   start)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/startup.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   stop)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/shutdown.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   restart)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/shutdown.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    sleep 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/startup.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   status)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	tomcat_status=$(ss -unplt |egrep 7007 |egrep -i listen)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        [ -z &#34;$tomcat_status&#34; ] &amp;&amp; echo -e &#34;\ntomcat\033[31m start failed ...\033[0m\n&#34; || echo -e &#34;\ntomcat\033[32m is running ...\033[0m\n&#34; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   esac;; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> 8818)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  export CATALINA_BASE=&#34;/opt/lucky/tomcat/8818/&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  read -p &#34;启动停止tomcat以及查看状态，确定请输入操作指令(start/stop/restart/status)：&#34; port_st
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  case &#34;$port_st&#34; in
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   start)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/startup.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   stop)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/shutdown.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   restart)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/shutdown.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    sleep 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    $CATALINA_HOME/bin/startup.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   status)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	tomcat_status=$(ss -unplt |egrep 8818 |egrep -i listen)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        [ -z &#34;$tomcat_status&#34; ] &amp;&amp; echo -e &#34;\ntomcat\033[31m start failed ...\033[0m\n&#34; || echo -e &#34;\ntomcat\033[32m is running ...\033[0m\n&#34; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   esac;;   
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">esac
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export JAVA_OPTS=&#39;-Xms64m -Xmx128m&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          </section>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="php">PHP</h1>


            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of PHP</h1>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="configure_php_expand">Configure_PHP_Expand</h1>

<h2 id="安装配置php扩展">安装配置<code>PHP</code>扩展</h2>
<h3 id="font-colorred安装fontphp-redisfont-colorred扩展font"><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>PHP-redis</code><!-- raw HTML omitted -->扩展<!-- raw HTML omitted --></h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->下载、安装<!-- raw HTML omitted --><code>PHP-redis</code><!-- raw HTML omitted -->扩展<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /usr/local/src
</span></span><span style="display:flex;"><span>$ curl -O https://pecl.php.net/get/redis-4.0.0.tgz
</span></span><span style="display:flex;"><span>$ tar zxvf /usr/local/src/redis-4.0.0.tgz -C /usr/local/src
</span></span><span style="display:flex;"><span>$ cd /usr/local/src/redis-4.0.0
</span></span><span style="display:flex;"><span>$ /usr/local/php/bin/phpize
</span></span><span style="display:flex;"><span>$ ./configure --with-php-config<span style="color:#f92672">=</span>/usr/local/php/bin/php-config
</span></span><span style="display:flex;"><span>$ make <span style="color:#f92672">&amp;&amp;</span> make install</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>PHP</code><!-- raw HTML omitted -->启用<!-- raw HTML omitted --><code>PHP-Redis</code><!-- raw HTML omitted -->扩展<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;N;736iextension =/usr/local/php/lib/php/extensions/no-debug-non-zts20170718/redis.so&#39;</span> /usr/local/php/etc/php.ini  	<span style="color:#75715e"># 修改配置文件启用redis模块</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 重启php使之生效</span>
</span></span><span style="display:flex;"><span>$ systemctl restart php-fpm
</span></span><span style="display:flex;"><span><span style="color:#75715e"># /etc/init.d/php-fpm restart</span>
</span></span><span style="display:flex;"><span>$ php -m|grep redis
</span></span><span style="display:flex;"><span>$ php --ri redis  	<span style="color:#75715e"># 查看redis扩展版本</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="font-colorred安装fontphp-swoolefont-colorred扩展font"><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>php-swoole</code><!-- raw HTML omitted -->扩展<!-- raw HTML omitted --></h3>
<blockquote>
<ul>
<li><a href="https://github.com/swoft-cloud/swoft/blob/master/Dockerfile" rel="external" target="_self"><code>docker install swoft</code></a></li>
</ul>
</blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->下载、安装<!-- raw HTML omitted --><code>php-swoole</code><!-- raw HTML omitted -->扩展<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /usr/local/src
</span></span><span style="display:flex;"><span>$ git clone https://github.com/swoole/swoole-src.git
</span></span><span style="display:flex;"><span>$ cd /usr/local/src/swoole-src/
</span></span><span style="display:flex;"><span>$ git checkout v4.4.7  	<span style="color:#75715e"># 切换指定版本</span>
</span></span><span style="display:flex;"><span>$ git branch  	<span style="color:#75715e"># 查看当前版本</span>
</span></span><span style="display:flex;"><span>$ phpize
</span></span><span style="display:flex;"><span>$ ./configure
</span></span><span style="display:flex;"><span>$ make -j4 <span style="color:#f92672">&amp;&amp;</span> make install</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>PHP</code><!-- raw HTML omitted -->启用<!-- raw HTML omitted --><code>PHP-Swoole</code><!-- raw HTML omitted -->扩展<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;N;736iextension =/usr/local/php/lib/php/extensions/no-debug-non-zts20170718/swoole.so&#39;</span> /usr/local/php/etc/php.ini  	<span style="color:#75715e"># 修改配置文件启用swoole模块</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># sed -i &#39;N;736iswoole.enable_coroutine = Off&#39; /usr/local/php/etc/php.ini</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ systemctl restart php-fpm
</span></span><span style="display:flex;"><span><span style="color:#75715e"># /etc/init.d/php-fpm restart</span>
</span></span><span style="display:flex;"><span>$ php -m|grep swoole
</span></span><span style="display:flex;"><span>$ php --ri swoole</span></span></code></pre></div></blockquote>
<hr>
<h3 id="font-colorred安装fontphp-freetypefont-colorred扩展font"><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>PHP-Freetype</code><!-- raw HTML omitted -->扩展<!-- raw HTML omitted --></h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->下载、安装<!-- raw HTML omitted --><code>PHP-Freetype</code><!-- raw HTML omitted -->扩展<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget -P /usr/local/src https://download.savannah.gnu.org/releases/freetype/freetype-2.9.tar.gz
</span></span><span style="display:flex;"><span><span style="color:#75715e"># https://mirror.hostiran.ir/gnu/releases/freetype/freetype-2.12.1.tar.gz</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ tar zxvf /usr/local/src/freetype-2.9.tar.gz -C /usr/local/src/
</span></span><span style="display:flex;"><span>$ cd /usr/local/src/freetype-2.9/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ./configure --prefix<span style="color:#f92672">=</span>/usr/local/freetype
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ make -j4 <span style="color:#f92672">&amp;&amp;</span> make install</span></span></code></pre></div><ul>
<li><code>Debian</code><!-- raw HTML omitted -->系统安装<!-- raw HTML omitted --><code>FreeType</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 进入php中的gd 目录</span>
</span></span><span style="display:flex;"><span>$ cd /opt/src/php-7.2.22/ext/gd/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 利用phpize</span>
</span></span><span style="display:flex;"><span>$ /opt/php/bin/phpize
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 清理之前的安装配置</span>
</span></span><span style="display:flex;"><span>$ make clean
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 检查参数</span>
</span></span><span style="display:flex;"><span>$ ./configure --with-php-config<span style="color:#f92672">=</span>/opt/php/bin/php-config --with-jpeg-dir --with-png-dir --with-freetype-dir<span style="color:#f92672">=</span>/opt/php/freetype --with-zlib-dir --with-gd
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 编译安装</span>
</span></span><span style="display:flex;"><span>$ make -j4 &amp; make install
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改 php.ini文件</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/opt/php/etc/php.ini<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">extension=/opt/php/lib/php/extensions/no-debug-non-zts-20170718/gd.so
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>PHP</code><!-- raw HTML omitted -->加入扩展路径<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ php -i  	<span style="color:#75715e"># 查看configure中使用参数</span>
</span></span><span style="display:flex;"><span>$ ./configure --prefix<span style="color:#f92672">=</span>/usr/local/php --with-freetype-dir<span style="color:#f92672">=</span>/usr/local/freetype  	<span style="color:#75715e"># --with-freetype-dir=/usr/local/freetype 启用此扩展</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="font-colorred安装fontphp-amqpfont-colorred扩展font"><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>PHP-Amqp</code><!-- raw HTML omitted -->扩展<!-- raw HTML omitted --></h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->第一种方式安装<!-- raw HTML omitted --><code>PHP-amqp</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /usr/local/php/bin/pecl install amqp</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->第二种方式安装<!-- raw HTML omitted --><code>PHP-amqp</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->下载、安装<!-- raw HTML omitted --><code>PHP-amqp</code><!-- raw HTML omitted -->扩展<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget -P /usr/local/src/ https://pecl.php.net/get/amqp-1.9.4.tgz
</span></span><span style="display:flex;"><span>$ tar -xvf /usr/local/src/amqp-1.9.4.tgz -C /usr/local/src
</span></span><span style="display:flex;"><span>$ cd /usr/local/src/amqp-1.9.4
</span></span><span style="display:flex;"><span>$ /usr/local/php/bin/phpize
</span></span><span style="display:flex;"><span>$ ./configure --with-php-config<span style="color:#f92672">=</span>/usr/local/php/bin/php-config</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->如果安装中报错处理方式<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget -P /usr/local/src https://github.com/alanxz/rabbitmq-c/releases/download/v0.7.1/rabbitmq-c0.7.1.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ tar zxvf /usr/local/src/rabbitmq-c-0.7.1.tar.gz -C /usr/local/src/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cd /usr/local/src/rabbitmq-c-0.7.1
</span></span><span style="display:flex;"><span>$ ./configure --prefix<span style="color:#f92672">=</span>/usr/local/rabbitmq-c-0.7.1
</span></span><span style="display:flex;"><span>$ make <span style="color:#f92672">&amp;&amp;</span> make install</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->重新配置编译安装<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /usr/local/src/amqp-1.9.4
</span></span><span style="display:flex;"><span>$ ./configure --with-php-config<span style="color:#f92672">=</span>/usr/local/php/bin/php-config --with-amqp --withlibrabbitmq-dir<span style="color:#f92672">=</span>/usr/local/rabbitmq-c-0.7.1
</span></span><span style="display:flex;"><span>$ make <span style="color:#f92672">&amp;&amp;</span> make install</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>PHP</code><!-- raw HTML omitted -->启用<!-- raw HTML omitted --><code>PHP-amqp</code><!-- raw HTML omitted -->扩展<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;N;736iextension =/usr/local/php/lib/php/extensions/no-debug-non-zts20170718/amqp.so&#39;</span> /usr/local/php/etc/php.ini  	<span style="color:#75715e"># 修改配置文件启用php-amqp模块</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 重启php使之生效</span>
</span></span><span style="display:flex;"><span>$ systemctl restart php-fpm
</span></span><span style="display:flex;"><span><span style="color:#75715e"># /etc/init.d/php-fpm restart</span>
</span></span><span style="display:flex;"><span>$ php -m|grep amqp
</span></span><span style="display:flex;"><span>$ php --ri amqp</span></span></code></pre></div></blockquote>
<hr>
<h2 id="php-fastcgi"><code>PHP-FastCGI</code></h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->什么是<!-- raw HTML omitted --><code>CGI</code></li>
</ol>
</li>
</ul>
<blockquote>
<p><code>CGI</code>的全称为<!-- raw HTML omitted -->通用网关接口(Common Gateway Interface)<!-- raw HTML omitted -->，为<code>HTTP</code>服务器与其他机器上的程序 服务通信交流的一种工具，<code>CGI</code>程序须运行在网络服务器上。 传统<code>CGI</code>接口方式的主要缺点是性能较差，因为每次<code>HTTP</code>服务器遇到动态程序时都需要重新启动解析器 来执行解析，之后结果才会被返回给<code>HTTP</code>服务器。这在处理高并发访问时几乎是不可用的，因此就诞生 了<code>FastCGI</code>。另外，传统的<code>CGI</code>接口方式安全性也很差，故而现在已经很少被使用了。</p>
</blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->什么是<!-- raw HTML omitted --><code>FastCGI</code></li>
</ol>
</li>
</ul>
<blockquote>
<p><code>FastCGI</code>是一个可伸缩地、高速地在<code>HTTP</code>服务器和动态脚本语言间通信的接口（在<code>Linux</code>下，<code>FastCG</code>接 口即为<code>socket</code>，这个<code>socket</code>可以是文件<code>socket</code>，也可以是<code>IP socket</code>），主要优点是把动态语言和<code>HTTP</code>服务器分离开来。多数流行的<code>HTTP</code>服务器都支持<code>FastCGI</code>，包括<code>Apache</code>、<code>Nginx</code>和<code>Lighttpd</code>等。 同时，<code>FastCGI</code>也被许多脚本语言所支持，例如当前比较流行的脚本语言<code>PHP</code>。<code>FastCGI</code>接口采用的是<code>C/S </code>架构，它可以将<code>HTTP</code>服务器和脚本解析服务器分开，同时还能在脚本解析服务器上启动一个或多个脚本 来解析守护进程。当<code>HTTP</code>服务器遇到动态程序时，可以将其直接交付给<code>FastCGI</code>进程来执行，然后将得 到的结果返回给浏览器。这种方式可以让<code>HTTP</code>服务器专一地处理静态请求，或者将动态脚本服务器的结 果返回给客户端，这在很大程度上提高了整个应用系统的性能。</p>
</blockquote>
<ul>
<li>
<ol start="3">
<li><code>FastCGI</code><!-- raw HTML omitted -->的重要特点如下：<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>
<p><code>HTTP</code><!-- raw HTML omitted -->服务器和动态脚本语言间通信的接口或工具<!-- raw HTML omitted --></p>
</li>
<li>
<p><!-- raw HTML omitted -->可把动态语言解析和<!-- raw HTML omitted --><code>HTTP</code><!-- raw HTML omitted -->服务器分离开<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>Nginx、Apache、Lighttpd</code><!-- raw HTML omitted -->以及多数动态语言都支持<!-- raw HTML omitted --><code>FastCGI</code></p>
</li>
<li>
<p><code>FastCGI</code><!-- raw HTML omitted -->接口方式采用<code>C/S</code>结构，分为客户端：<code>HTTP</code>服务器，和服务器端：<!-- raw HTML omitted --><!-- raw HTML omitted -->动态语言解析服务器<!-- raw HTML omitted --></p>
</li>
<li>
<p><!-- raw HTML omitted -->动态语言服务器端可以启动多个<code>FastCGI</code>的守护进程，例如：<!-- raw HTML omitted --><code>php-fpm(fcgi process mangement)</code></p>
</li>
<li>
<p><code>HTTP</code><!-- raw HTML omitted -->服务器通过，例如：<!-- raw HTML omitted --><code>Nginx fastcgi_pass。FastCGI</code><!-- raw HTML omitted -->客户端和动态语言<!-- raw HTML omitted --><code>FastCGI</code><!-- raw HTML omitted -->服务器端通信，例如：<!-- raw HTML omitted --><code>php-fpm</code></p>
</li>
</ul>
</blockquote>
<p><a href="#R-image-908714b71b2f00a6187107029789e704" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Php_Server/Snipaste_2022-08-14_14-44-29.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-908714b71b2f00a6187107029789e704"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Php_Server/Snipaste_2022-08-14_14-44-29.png"></a></p>
<hr>
<h3 id="阿里云epel">阿里云<code>epel</code></h3>
<ul>
<li>
<ol>
<li><a href="https://developer.aliyun.com/mirror/epel" rel="external" target="_self">阿里云<code>epel</code>简介</a></li>
</ol>
</li>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->设定阿里云<code>epel</code>源<!-- raw HTML omitted --><a href="https://mirrors.aliyun.com/epel/" rel="external" target="_self">阿里云<code>epel</code>下载</a></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 备份其他epel源</span>
</span></span><span style="display:flex;"><span>$ mv /etc/yum.repos.d/epel.repo /etc/yum.repos.d/epel.repo.backup
</span></span><span style="display:flex;"><span>$ mv /etc/yum.repos.d/epel-testing.repo /etc/yum.repos.d/epel-testing.repo.backup
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ wget -O /etc/yum.repos.d/epel.repo https://mirrors.aliyun.com/repo/epel-7.repo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ yum -y install mhash
</span></span><span style="display:flex;"><span>$ yum -y install mcrypt
</span></span><span style="display:flex;"><span>$ yum -y install libmcrypt-devel
</span></span><span style="display:flex;"><span>$ yum install zlib-devel libxml2-devel libjpeg-devel libjpeg-turbo-devel libiconv-devel -y
</span></span><span style="display:flex;"><span>$ yum install freetype-devel libpng-devel gd-devel libcurl-devel libxslt-devel libxslt-devel -y</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->下载安装<!-- raw HTML omitted --><code>libiconv</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget -P /usr/local/src http://ftp.gnu.org/pub/gnu/libiconv/libiconv-1.14.tar.gz
</span></span><span style="display:flex;"><span>$ tar -zxf /usr/local/src/libiconv-1.14.tar.gz -C /usr/local/src
</span></span><span style="display:flex;"><span>cd /usr/local/src/libiconv-1.14
</span></span><span style="display:flex;"><span>$ ./configure --prefix<span style="color:#f92672">=</span>/usr/local/libiconv
</span></span><span style="display:flex;"><span>$ make
</span></span><span style="display:flex;"><span>$ make install</span></span></code></pre></div><ul>
<li>3.1 <!-- raw HTML omitted -->配置<code>PHP</code>启用<!-- raw HTML omitted --><code>libiconv</code></li>
</ul>
<blockquote>
<ul>
<li><code>--prefix=/application/php5.5.32</code><!-- raw HTML omitted -->： 表示指定<code>PHP</code>的安装路径<!-- raw HTML omitted --></li>
<li><code>--with-mysql=/application/mysql</code><!-- raw HTML omitted -->：表示需要指定<code>MySQL</code>的安装路径，安装<code>PHP需</code>要<code>MySQL</code>的相关内容，当然如果没有<code>MySQL</code>安装包也可以不单独安装，这样情况下使用<!-- raw HTML omitted --><code>--with-mysql=mysqlnd</code>替代<code>--with-mysql=/application/mysql</code>，因为<code>PHP</code>软件自带连接<code>MySQL</code>客户工具</li>
<li><code>--with-fpm-user=nginx</code><!-- raw HTML omitted -->：表示指定<code>PHP-FPM</code>进程管理用户为<code>Nginx</code>，此处最好和<code>Nginx</code>服务用户统一<!-- raw HTML omitted --></li>
<li><code>--with-fpm-group=nginx</code><!-- raw HTML omitted -->：表示指定<code>PHP-FPM</code>进程管理组为<code>Nginx</code>，此处最好和<code>Nginx</code>服务用户组统一<!-- raw HTML omitted --></li>
<li><code>--enable-fpm</code><!-- raw HTML omitted -->:表示激活<code>PHP-FPM</code>方式服务，即<code>FastCGIF</code>方式运行<code>PHP</code>服务<!-- raw HTML omitted --></li>
<li>可以通过执行<code>./configure --help</code><!-- raw HTML omitted -->命令来详细查看以上各参数用途<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /usr/local/src/php5.5.32
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ./configure <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--prefix<span style="color:#f92672">=</span>/application/php5.5.32 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-iconv-dir<span style="color:#f92672">=</span>/usr/local/libiconv <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-mysql<span style="color:#f92672">=</span>mysqlnd --with-libxml-dir<span style="color:#f92672">=</span>/usr <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-freetype-dir --with-jpeg-dir --with-png-dir <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-zlib --enable-xml --disable-rpath --enable-safe-mode <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--enable-bcmath --enable-shmop --enable-sysvsem --with-curl <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--enable-inline-optimization --with-curlwrappers --enable-fpm <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--enable-mbregex --enable-mbstring --with-mcrypt --with-gd <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--enable-gd-native-ttf --with-openssl --with-mhash --enable-pcntl <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--enable-sockets --with-xmlrpc --enable-zip --enable-soap <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--enable-short-tags --enable-zend-multibyte --enable-ftp <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--enable-static --with-xsl --enable-opcache<span style="color:#f92672">=</span>no --with-fpm-user<span style="color:#f92672">=</span>www <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-fpm-group<span style="color:#f92672">=</span>www
</span></span><span style="display:flex;"><span>$ ln -s /application/mysql/lib/libmysqlclient.so.18 /usr/lib64/
</span></span><span style="display:flex;"><span>$ touch ext/phar/phar.phar
</span></span><span style="display:flex;"><span>$ make <span style="color:#f92672">&amp;&amp;</span> make install</span></span></code></pre></div></blockquote>
</blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->在<code>Nginx</code>的<code>conf</code>配置中字段<code>server</code>编写<code>php</code>的<!-- raw HTML omitted --><code>location</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>location ~ .*<span style="color:#ae81ff">\.</span><span style="color:#f92672">(</span>php|php5<span style="color:#f92672">)</span>?$ <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>root html/blog;
</span></span><span style="display:flex;"><span>fastcgi_pass 127.0.0.1:9000;  	<span style="color:#75715e"># 或者使用：unix:/tmp/php-cgi-56.sock;</span>
</span></span><span style="display:flex;"><span>fastcgi_index index.php;
</span></span><span style="display:flex;"><span>fastcgi_split_path_info ^<span style="color:#f92672">((</span>?U<span style="color:#f92672">)</span>.+<span style="color:#ae81ff">\.</span>php<span style="color:#f92672">)(</span>/?.+<span style="color:#f92672">)</span>$;
</span></span><span style="display:flex;"><span>fastcgi_param PATH_INFO $fastcgi_path_info;
</span></span><span style="display:flex;"><span>include fastcgi_params;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># include fastcgi.conf</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->配置<code>fastcgi.conf</code>文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;fastcgi.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fastcgi_param  SCRIPT_FILENAME    $document_root$fastcgi_script_name;# 脚本文件请求的路径
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fastcgi_param  QUERY_STRING       $query_string;  	 # 请求的参数;如?app=123
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fastcgi_param  REQUEST_METHOD     $request_method;  	# 请求的动作(GET,POST)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fastcgi_param  CONTENT_TYPE       $content_type;  	# 请求头中的Content-Type字段
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fastcgi_param  CONTENT_LENGTH     $content_length;  	 # 请求头中的Content-length字段
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fastcgi_param  SCRIPT_NAME        $fastcgi_script_name;  	# 脚本名称
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fastcgi_param  REQUEST_URI        $request_uri;  	# 请求的地址不带参数
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fastcgi_param  DOCUMENT_URI       $document_uri;  	# 与document_uri; #与uri相同
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fastcgi_param  DOCUMENT_ROOT      $document_root;  	# 网站的根目录。在server配置中root指令中指定的值
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fastcgi_param  SERVER_PROTOCOL    $server_protocol;  	# 请求使用的协议，通常是HTTP/1.0或HTTP/1.1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fastcgi_param  REQUEST_SCHEME     $scheme;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fastcgi_param  HTTPS              $https if_not_empty;  	# https 如果value非空才进行设置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fastcgi_param  GATEWAY_INTERFACE  CGI/1.1;  	# cgi 版本
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fastcgi_param  SERVER_SOFTWARE    nginx/$nginx_version;  	# nginx 版本号，可修改、隐藏
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fastcgi_param  REMOTE_ADDR        $remote_addr;  	 # 客户端IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fastcgi_param  REMOTE_PORT        $remote_port;  	# 客户端端口
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fastcgi_param  SERVER_ADDR        $server_addr;  	# 服务器IP地址
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fastcgi_param  SERVER_PORT        $server_port;  	# 服务器端口
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fastcgi_param  SERVER_NAME        $server_name;  	# 服务器名，域名在server配置中指定的server_name
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## GeoIP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#fastcgi_param GEOIP_ADDR $remote_addr;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#fastcgi_param GEOIP_COUNTRY_CODE $geoip_country_code;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#fastcgi_param GEOIP_COUNTRY_NAME $geoip_country_name;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#fastcgi_param GEOIP_REGION $geoip_region;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#fastcgi_param GEOIP_REGION_NAME $geoip_region_name;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#fastcgi_param GEOIP_CITY $geoip_city;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#fastcgi_param GEOIP_AREA_CODE $geoip_area_code;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#fastcgi_param GEOIP_LATITUDE $geoip_latitude;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#fastcgi_param GEOIP_LONGITUDE $geoip_longitude;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#fastcgi_param GEOIP_POSTAL_CODE $geoip_postal_code;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#fastcgi_param GEOIP_ORGANIZATION $geoip_org;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># PHP only, required if PHP was built with --enable-force-cgi-redirect
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fastcgi_param  REDIRECT_STATUS    200;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><code>nginx -t</code><!-- raw HTML omitted -->检查语法成功，重启<!-- raw HTML omitted --><code>nginx</code>，写一个<code>PHP</code>页面</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&lt;?php phpinfo<span style="color:#f92672">()</span>； ?&gt;</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->测试<code>PHP</code>连接<!-- raw HTML omitted --><code>mysql</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&lt;?php
</span></span><span style="display:flex;"><span>$link_id<span style="color:#f92672">=</span>mysql_connect<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;localhost&#39;</span>,<span style="color:#e6db74">&#39;root&#39;</span>,<span style="color:#e6db74">&#39;oldboy123&#39;</span><span style="color:#f92672">)</span> or mysql_error<span style="color:#f92672">()</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>$link_id<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;mysql successful by oldboy !&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span><span style="color:#66d9ef">else</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>echo mysql_error<span style="color:#f92672">()</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>?&gt;</span></span></code></pre></div></blockquote>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_php">Install_PHP</h1>

<h2 id="安装php">安装<code>PHP</code></h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->安装依赖<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 修整优化</span>
</span></span><span style="display:flex;"><span>$ yum -y install epel-release
</span></span><span style="display:flex;"><span>$ yum -y install gcc gcc-c++ wget libxml2-devel sqlite-devel bzip2-devel <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>libpng-devel libwebp-devel libjpeg-devel libXpm-devel freetype-devel <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>oniguruma oniguruma-devel ncurses-devel readline-devel openssl-devel <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>libcurl-devel
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># yum安装版本不够高， 手动安装libzip</span>
</span></span><span style="display:flex;"><span>$ wget https://mirrors.oneinstack.com/oneinstack-repo/7/x86_64/libzip-0.11.2-6.el7.psychotic.x86_64.rpm
</span></span><span style="display:flex;"><span>$ wget https://mirrors.oneinstack.com/oneinstack-repo/7/x86_64/libzip-devel-0.11.2-6.el7.psychotic.x86_64.rpm
</span></span><span style="display:flex;"><span>$ yum localinstall libzip-0.11.2-6.el7.psychotic.x86_64.rpm
</span></span><span style="display:flex;"><span>$ yum localinstall libzip-devel-0.11.2-6.el7.psychotic.x86_64.rpm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Debian系统</span>
</span></span><span style="display:flex;"><span>$ sudo apt-get install libxml2 libxml2-dev libbz2-dev libjpeg-dev libtool pkgconf <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>libpng-dev libfreetype6-dev libreadline-dev build-essential autoconf automake <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>bison flex re2c gdb php-gd libcurl4-openssl-dev gcc make libssl-dev libsqlite3-dev <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>libwebp-dev oniguruma-dev libzip-dev libXpm-dev</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->下载安装包配置<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->下载解压安装包<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ useradd -s /sbin/nologin php-fpm  	<span style="color:#75715e"># 添加程序用户</span>
</span></span><span style="display:flex;"><span>$ cd /usr/local/src/
</span></span><span style="display:flex;"><span>$ curl -O https://www.php.net/distributions/php-7.4.30.tar.gz
</span></span><span style="display:flex;"><span>$ tar -zxvf /usr/local/src/php-7.4.30.tar.gz -C /usr/local/src/</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->配置，<!-- raw HTML omitted --><code>Debian</code><!-- raw HTML omitted -->系统不要使用默认<!-- raw HTML omitted --><code>--wiht-gd</code>，<code>CentOS</code><!-- raw HTML omitted -->不使用<!-- raw HTML omitted --><code> --with-curl</code></li>
<li><a href="https://www.php.net/manual/zh/funcref.php" rel="external" target="_self">函数参考</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /usr/local/src/php-7.4.30  	<span style="color:#75715e"># 切换到解压目录</span>
</span></span><span style="display:flex;"><span>$ ./configure --prefix<span style="color:#f92672">=</span>/usr/local/php --sysconfdir<span style="color:#f92672">=</span>/usr/local/php/etc <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-config-file-path<span style="color:#f92672">=</span>/usr/local/php/etc/ --with-fpm-user<span style="color:#f92672">=</span>php-fpm <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-fpm-group<span style="color:#f92672">=</span>php-fpm --enable-fpm --with-libxml-dir --with-xmlrpc <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-pdo-mysql<span style="color:#f92672">=</span>mysqlnd --with-mysqli<span style="color:#f92672">=</span>mysqlnd --with-mhash <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-zlib --with-bz2 --with-gd --with-jpeg-dir --with-png-dir <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-iconv-dir --with-pcre-dir --with-pear --enable-mbstring <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--enable-sockets --enable-zip --enable-session --enable-xml <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--enable-gd-jis-conv --enable-shared --enable-soap --enable-bcmath <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--enable-sysvmsg --enable-sysvsem --enable-sysvshm --enable-mbregex <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--enable-pcntl --with-gettext --enable-exif --with-readline --enable-ftp <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-freetype-dir<span style="color:#f92672">=</span>/usr/local/freetype
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># php 7.4.X以上版本  </span>
</span></span><span style="display:flex;"><span>$ ./configure --prefix<span style="color:#f92672">=</span>/usr/local/php --sysconfdir<span style="color:#f92672">=</span>/usr/local/php/etc <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-config-file-path<span style="color:#f92672">=</span>/usr/local/php/etc/ --enable-fpm <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-fpm-user<span style="color:#f92672">=</span>php-fpm --with-fpm-group<span style="color:#f92672">=</span>php-fpm --with-xmlrpc <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-pdo-mysql<span style="color:#f92672">=</span>mysqlnd --with-mysqli<span style="color:#f92672">=</span>mysqlnd --with-mhash <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-zip --with-zlib --with-bz2 --enable-gd --with-jpeg <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-xpm --with-webp --with-freetype --with-pear --with-openssl <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--enable-mbstring --enable-sockets --enable-gd-jis-conv <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--enable-shared --enable-soap --enable-bcmath --enable-sysvmsg <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--enable-sysvsem --enable-sysvshm --enable-mbregex --enable-pcntl <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-gettext --enable-exif --with-readline --enable-ftp --with-openssl</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->编译安装<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ make -j4 <span style="color:#f92672">&amp;&amp;</span> make install</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->拷贝配置文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cp /usr/local/src/php-7.4.30/php.ini-production /usr/local/php/etc/php.ini  	<span style="color:#75715e"># 拷贝PHP解析器配置文件</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 拷贝启动文件</span>
</span></span><span style="display:flex;"><span>$ cp /usr/local/src/php-7.4.30/sapi/fpm/init.d.php-fpm   /etc/init.d/php-fpm 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cp /usr/local/php/etc/php-fpm.conf.default /usr/local/php/etc/php-fpm.conf
</span></span><span style="display:flex;"><span>$ cp /usr/local/php/etc/php-fpm.d/www.conf.default /usr/local/php/etc/php-fpm.d/www.conf</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->拷贝改名<!-- raw HTML omitted --><code>PHP-FPM</code><!-- raw HTML omitted -->进程管理器配置文件，以及根据<!-- raw HTML omitted --><code>CPU</code><!-- raw HTML omitted -->、内存性能优化<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mv /usr/local/php/etc/php-fpm.conf.default   /usr/local/php/etc/php-fpm.conf
</span></span><span style="display:flex;"><span>pm <span style="color:#f92672">=</span> static  	<span style="color:#75715e"># 静态_子进程固定数量</span>
</span></span><span style="display:flex;"><span>pm <span style="color:#f92672">=</span> dynamic  	<span style="color:#75715e"># 动态_子进程数量</span>
</span></span><span style="display:flex;"><span>pm.max_children <span style="color:#f92672">=</span> <span style="color:#ae81ff">500</span>  	<span style="color:#75715e"># 最小等待处理的子进程</span>
</span></span><span style="display:flex;"><span>pm.start_servers <span style="color:#f92672">=</span> <span style="color:#ae81ff">200</span>  	<span style="color:#75715e"># 启动时创建子进程数</span>
</span></span><span style="display:flex;"><span>pm.min_spare_servers <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>  	<span style="color:#75715e"># 最小处于等待处理子进程数</span>
</span></span><span style="display:flex;"><span>pm.max_spare_servers <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span>  	<span style="color:#75715e"># 最大处于等待处理子进程数</span>
</span></span><span style="display:flex;"><span>pm.max_requests <span style="color:#f92672">=</span> <span style="color:#ae81ff">10000</span>
</span></span><span style="display:flex;"><span>request_terminate_timeout <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>PHP</code><!-- raw HTML omitted -->通信方式<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># Unix socket，Nginx和php-fpm在同一台服务器上，使用这种方式效率要比tcp socket高，需要再nginx配置文件中填写php-fpm的pid文件位置，</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/usr/local/php/etc/php-fpm.d/www.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">listen = /usr/local/php/logs/php7.sock  	# 自定义添加
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># tcp socket的优点是可以跨服务器，当Nginx和php-fpm不在同一台机器上时，只能使用这种方式</span>
</span></span><span style="display:flex;"><span>$ listen <span style="color:#f92672">=</span> 127.0.0.1:9000</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->修改权限启动服务<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 修改权限</span>
</span></span><span style="display:flex;"><span>$ chmod <span style="color:#ae81ff">755</span> /etc/init.d/php-fpm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 添加到启动项</span>
</span></span><span style="display:flex;"><span>$ chkconfig --add php-fpm 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 开机自启</span>
</span></span><span style="display:flex;"><span>$ chkconfig php-fpm on
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动服务</span>
</span></span><span style="display:flex;"><span>$ service php-fpm start
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 重启配置</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;N;56iexport PATH=/usr/local/php/bin:</span>$PATH<span style="color:#e6db74">&#34;</span> /etc/profile
</span></span><span style="display:flex;"><span>$ source /etc/profile
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 写入测试文件</span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;&lt;?php
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">phpinfo();
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">?&gt;&#39;</span> &gt;/usr/local/nginx/html/index.php
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改配置nginx文件</span>
</span></span><span style="display:flex;"><span>$ nginxconf<span style="color:#f92672">=</span>/usr/local/nginx/conf/nginx.conf
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;45s/index.html/index.php index.html/&#39;</span> $nginxconf
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;65,71s/#//&#39;</span> $nginxconf
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;70s/fastcgi_params/fastcgi.conf/&#39;</span> $nginxconf
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;69d&#39;</span> $nginxconf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 重启nginx</span>
</span></span><span style="display:flex;"><span>$ /usr/local/nginx/sbin/nginx -s reload
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ php -v
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看端口号</span>
</span></span><span style="display:flex;"><span>$ netstat -nuplt | grep :9000</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>systemctl</code><!-- raw HTML omitted -->启动<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=php-fpm
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=syslog.target network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Type=forking
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/usr/local/php/sbin/php-fpm
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecReload=/bin/kill -USR2 $MAINPID
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">PrivateTmp=true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target&#39;</span> &gt; /usr/lib/systemd/system/php-fpm.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改权限</span>
</span></span><span style="display:flex;"><span>$ chmod <span style="color:#ae81ff">755</span> /usr/lib/systemd/system/php-fpm.service
</span></span><span style="display:flex;"><span>$ chmod <span style="color:#ae81ff">755</span> /etc/init.d/php-fpm
</span></span><span style="display:flex;"><span>$ systemctl daemon-reload <span style="color:#f92672">&amp;&amp;</span> systemctl enable php-fpm
</span></span><span style="display:flex;"><span>$ systemctl start php-fpm
</span></span><span style="display:flex;"><span>$ systemctl status php-fpm</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          </section>
          </section>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="cdn">CDN</h1>


            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="codes">Codes</h1>


            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Codes</h1>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="configure_sonarqube">Configure_SonarQube</h1>

<h2 id="配置sonarqube">配置<code>SonarQube</code></h2>
<blockquote>
<ul>
<li>
<ol>
<li><a href="https://openai.com/blog/openai-codex/" rel="external" target="_self"><code>OpenAI Codex</code></a></li>
</ol>
</li>
<li>
<ol start="2">
<li><a href="https://github.com/features/copilot/" rel="external" target="_self"><code>Github copilot</code></a></li>
</ol>
</li>
</ul>
</blockquote>
<ul>
<li>
<ol>
<li>配置<code>SonarQube</code>中文</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>搜索<code>Chinese Pack</code>中文插件</li>
</ul>
<p><a href="#R-image-abfeb69e4c4cd939891a14cb90318925" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/SonarQube_Server/Snipaste_2022-11-22_15-01-44.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-abfeb69e4c4cd939891a14cb90318925"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/SonarQube_Server/Snipaste_2022-11-22_15-01-44.png"></a></p>
<ul>
<li>
<p>1.2 如果匹配<code>Gitlab</code>不成功可能是版本不对， 需要更新版本</p>
</li>
<li>
<p>1.3 配置<code>sonar-scanner</code>的<code>sonar-project.properties</code>文件</p>
</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/php/project/sonar-project.properties<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 必须指定projectKey
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sonar.projectKey=php:admin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 定义检测后展示名称
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sonar.projectName=Project NAME
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 指定版本
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sonar.projectVersion=4.7 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 项目代码存放目录 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sonar.sources=/opt/admin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 项目代码使用的开发语言
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sonar.language=php 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sonar.dynamicAnalysis=false 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># Encoding of the source files 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sonar.sourceEncoding=UTF-8
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 切换项目目录下执行</span>
</span></span><span style="display:flex;"><span>$ /opt/sonar-scanner/bin/sonar-scanner -Dsonar.login<span style="color:#f92672">=</span>admin -Dsonar.password<span style="color:#f92672">=</span>password  -Dsonar.host.url<span style="color:#f92672">=</span>http://sonarqube.erge.com</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_sonarqube">Install_SonarQube</h1>

<h2 id="安装sonarqube代码质量管理系统">安装<code>SonarQube</code>代码质量管理系统</h2>
<blockquote>
<ul>
<li>
<ol>
<li><a href="https://github.com/anchore/grype" rel="external" target="_self"><code> grype Docker 镜像扫描</code></a></li>
</ol>
</li>
<li>
<ol start="2">
<li><a href="https://archerydms.com/installation/manual/" rel="external" target="_self"><code>Archery</code>代码检查服务</a></li>
</ol>
</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>
<ol>
<li><code>SonarQube</code>是一个用于管理代码质量的开放平台，可以快速的定位代码中潜在的或者明显的错误。目前支持<code>java</code>、<code>C#</code>、<code>C/C++</code>、<code>Python</code>、<code>PL/SQL</code>、<code>Cobol</code>、<code>JavaScrip</code>、<code>Groovy</code>等二十几种编程语言的代码质量管理与检测</li>
</ol>
</li>
<li>
<ol start="2">
<li>从七个维度检测代码质量</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>复杂度分布(<code>complexity</code>):代码复杂度过高将难以理解</li>
<li>重复代码(<code>duplications</code>):程序中包含大量复制、粘贴的代码而导致代码臃肿，<code>sonar</code>可以展示源码中重复严重的地方</li>
<li>单元测试统计(<code>unit tests</code>):统计并展示单元测试覆盖率，开发或测试可以清楚测试代码的覆盖情况</li>
<li>代码规则检查(<code>coding rules</code>):通过<code>Findbugs</code>、<code>PMD</code>、<code>CheckStyle</code>等检查代码是否符合规范</li>
<li>注释率(<code>comments</code>):若代码注释过少，特别是人员变动后，其他人接手比较难接手；若过多，又不利于阅读</li>
<li>潜在的<code>Bug</code>(<code>potential bugs</code>):通过<code>Findbugs</code>、<code>PMD</code>、<code>CheckStyle</code>等检测潜在的<code>bug</code></li>
<li>结构与设计(<code>architecture &amp; design</code>):找出循环，展示包与包、类与类之间的依赖、检查程序之间耦合度</li>
</ul>
</blockquote>
<ul>
<li>
<ol start="3">
<li>安装要求</li>
</ol>
</li>
</ul>
<table>
<thead>
<tr>
<th>环境要求</th>
<th>版本</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>postgresql</code></td>
<td><code>9.7</code></td>
<td></td>
</tr>
<tr>
<td><code>JDK</code></td>
<td><code>11</code></td>
<td></td>
</tr>
<tr>
<td><code>SonarQube</code></td>
<td><code>9.7.1</code></td>
<td></td>
</tr>
<tr>
<td><code>Elasticsearch</code></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>
<ol>
<li>使用<code>PostgreSQL</code>创建<code>SonarQube</code>数据库</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 创建sonar用户</span>
</span></span><span style="display:flex;"><span>$ ./bin/createuser sonar  	<span style="color:#75715e"># 创建新用户 sonar，create user sonar;</span>
</span></span><span style="display:flex;"><span>$ ./bin/psql -d template1  	<span style="color:#75715e"># 进入命令行模式</span>
</span></span><span style="display:flex;"><span>$ ALTER USER sonar WITH ENCRYPTED password <span style="color:#e6db74">&#39;sonar@123!&#39;</span>;  	<span style="color:#75715e"># 设置sonar用户密码(否则会导致连不上数据库)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建sonar数据库  </span>
</span></span><span style="display:flex;"><span>$ CREATE DATABASE sonar WITH ENCODING <span style="color:#e6db74">&#39;UTF8&#39;</span> OWNER sonar TEMPLATE<span style="color:#f92672">=</span>template0;  	<span style="color:#75715e"># create database sonar;  </span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><a href="https://binaries.sonarsource.com/" rel="external" target="_self">下载<code>SonarQube</code></a></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><a href="https://binaries.sonarsource.com/" rel="external" target="_self"><code>SonarQube</code></a>→<code>Distribution</code>→<code>SonarQube</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ curl -O https://binaries.sonarsource.com/Distribution/sonarqube/sonarqube-9.6.1.59531.zip
</span></span><span style="display:flex;"><span>$ yum -y install unzip
</span></span><span style="display:flex;"><span>$ unzip sonarqube-9.6.1.59531.zip -d /opt/
</span></span><span style="display:flex;"><span>$ mv sonarqube-9.6.1.59531 /opt/sonarqube</span></span></code></pre></div><ul>
<li>配置<code>sonar.properties</code>文件</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ vim /opt/sonarqube/conf/sonar.properties
</span></span><span style="display:flex;"><span>sonar.jdbc.username<span style="color:#f92672">=</span>sonar
</span></span><span style="display:flex;"><span>sonar.jdbc.password<span style="color:#f92672">=</span>sonar
</span></span><span style="display:flex;"><span>sonar.jdbc.url<span style="color:#f92672">=</span>jdbc:postgresql://localhost/sonar
</span></span><span style="display:flex;"><span><span style="color:#75715e"># WEB SERVER</span>
</span></span><span style="display:flex;"><span>sonar.web.host<span style="color:#f92672">=</span>0.0.0.0
</span></span><span style="display:flex;"><span>sonar.web.port<span style="color:#f92672">=</span><span style="color:#ae81ff">9000</span></span></span></code></pre></div><ul>
<li><code>SonarQube</code>不能通过<code>root</code>用户执行，新建用户</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ useradd sonar
</span></span><span style="display:flex;"><span>$ chown -R sonar. /opt/sonarqube
</span></span><span style="display:flex;"><span>$ su - sonar
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ulimit -n <span style="color:#ae81ff">65535</span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;* soft nofile 65536
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* hard nofile 65536
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* soft nproc 32000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* hard nproc 32000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* hard memlock unlimited
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* soft memlock unlimited &#34;</span>&gt;&gt;/etc/security/limits.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;vm.max_map_count=655360&#34;</span> &gt;&gt;/etc/sysctl.conf</span></span></code></pre></div><ul>
<li>启动<code>SonarQube</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /opt/sonarqube/
</span></span><span style="display:flex;"><span>$ ./bin/linux-x86-64/sonar.sh start</span></span></code></pre></div><ul>
<li>登录<code>SonarQube</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ http://IP:9000  	<span style="color:#75715e"># 默认用户名密码：admin/admin</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="安装扫描客户端">安装扫描客户端</h3>
<ul>
<li>
<ol>
<li><a href="https://docs.sonarqube.org/latest/analysis/scan/sonarscanner/" rel="external" target="_self">下载**<code>SonarScanner</code>**</a></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.7.0.2747-linux.zip
</span></span><span style="display:flex;"><span>$ unzip sonar-scanner-cli-4.7.0.2747-linux.zip 
</span></span><span style="display:flex;"><span>$ mv sonar-scanner-4.7.0.2747-linux /opt/sonar-scanner</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          </section>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="crontab">Crontab</h1>


            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Crontab</h1>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="install-xxl-job">Install Xxl Job</h1>

<h2 id="安装xxl-job">安装<code>xxl-job</code></h2>
<blockquote>
<ul>
<li>
<ol>
<li><a href="https://www.xuxueli.com/xxl-job/#1.5%20%E4%B8%8B%E8%BD%BD" rel="external" target="_self">官方下载部署文档</a></li>
</ol>
</li>
<li>
<ol start="2">
<li><code>Maven3+</code></li>
</ol>
</li>
<li>
<ol start="3">
<li><code>Jdk1.8+</code></li>
</ol>
</li>
<li>
<ol start="4">
<li><code>Mysql5.7+</code></li>
</ol>
</li>
</ul>
</blockquote>
<hr>
<h3 id="安装maven">安装<code>Maven</code></h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->下载<!-- raw HTML omitted --><code>Maven</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget https://dlcdn.apache.org/maven/maven-3/3.8.5/binaries/apache-maven-3.8.5-bin.tar.gz</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->配置环境变量<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;export PATH=/opt/apache-maven-3.8.5/bin:$PATH&#39;</span> &gt;&gt;/etc/profile</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->国内配置阿里云<!-- raw HTML omitted --><code>Maven</code><!-- raw HTML omitted -->源<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><a href="http://dblab.xmu.edu.cn/blog/2758/" rel="external" target="_self">将<code>Maven</code>源改为国内阿里云仓库</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/usr/local/maven/conf/settings.xml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;settings xmlns=&#34;http://maven.apache.org/SETTINGS/1.0.0&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          xmlns:xsi=&#34;http://www.w3.org/2001/XMLSchema-instance&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          xsi:schemaLocation=&#34;http://maven.apache.org/SETTINGS/1.0.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                      http://maven.apache.org/xsd/settings-1.0.0.xsd&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;mirrors&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &lt;mirror&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;id&gt;aliyunmaven&lt;/id&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;name&gt;阿里云公共仓库&lt;/name&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;url&gt;https://maven.aliyun.com/repository/public&lt;/url&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &lt;/mirror&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &lt;mirror&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;id&gt;aliyunmaven&lt;/id&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;name&gt;阿里云谷歌仓库&lt;/name&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;url&gt;https://maven.aliyun.com/repository/google&lt;/url&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &lt;/mirror&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &lt;mirror&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;id&gt;aliyunmaven&lt;/id&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;name&gt;阿里云阿帕奇仓库&lt;/name&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;url&gt;https://maven.aliyun.com/repository/apache-snapshots&lt;/url&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &lt;/mirror&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &lt;mirror&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;id&gt;aliyunmaven&lt;/id&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;name&gt;阿里云spring仓库&lt;/name&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;url&gt;https://maven.aliyun.com/repository/spring&lt;/url&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &lt;/mirror&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &lt;mirror&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;id&gt;aliyunmaven&lt;/id&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;name&gt;阿里云spring插件仓库&lt;/name&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;url&gt;https://maven.aliyun.com/repository/spring-plugin&lt;/url&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &lt;/mirror&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;/mirrors&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;/settings&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="安装xxl-job-1">安装<code>xxl-job</code></h3>
<ul>
<li>
<ol>
<li><code>/xxl-job/doc/db/tables_xxl_job.sql</code><!-- raw HTML omitted -->：初始化数据库<!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->修改配置文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ vim /xxl-job/xxl-job-admin/src/main/resources/application.properties
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">### 调度中心JDBC链接：链接地址请保持和 2.1章节 所创建的调度数据库的地址一致</span>
</span></span><span style="display:flex;"><span>spring.datasource.url<span style="color:#f92672">=</span>jdbc:mysql://127.0.0.1:3306/xxl_job?useUnicode<span style="color:#f92672">=</span>true&amp;characterEncoding<span style="color:#f92672">=</span>UTF-8&amp;autoReconnect<span style="color:#f92672">=</span>true&amp;serverTimezone<span style="color:#f92672">=</span>Asia/Shanghai
</span></span><span style="display:flex;"><span>spring.datasource.username<span style="color:#f92672">=</span>root
</span></span><span style="display:flex;"><span>spring.datasource.password<span style="color:#f92672">=</span>root_pwd
</span></span><span style="display:flex;"><span>spring.datasource.driver-class-name<span style="color:#f92672">=</span>com.mysql.jdbc.Driver
</span></span><span style="display:flex;"><span><span style="color:#75715e">### 报警邮箱</span>
</span></span><span style="display:flex;"><span>spring.mail.host<span style="color:#f92672">=</span>smtp.qq.com
</span></span><span style="display:flex;"><span>spring.mail.port<span style="color:#f92672">=</span><span style="color:#ae81ff">25</span>
</span></span><span style="display:flex;"><span>spring.mail.username<span style="color:#f92672">=</span>xxx@qq.com
</span></span><span style="display:flex;"><span>spring.mail.password<span style="color:#f92672">=</span>xxx
</span></span><span style="display:flex;"><span>spring.mail.properties.mail.smtp.auth<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span>spring.mail.properties.mail.smtp.starttls.enable<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span>spring.mail.properties.mail.smtp.starttls.required<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span>spring.mail.properties.mail.smtp.socketFactory.class<span style="color:#f92672">=</span>javax.net.ssl.SSLSocketFactory
</span></span><span style="display:flex;"><span><span style="color:#75715e">### 调度中心通讯TOKEN [选填]：非空时启用；</span>
</span></span><span style="display:flex;"><span>xxl.job.accessToken<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">### 调度中心国际化配置 [必填]： 默认为 &#34;zh_CN&#34;/中文简体, 可选范围为 &#34;zh_CN&#34;/中文简体, &#34;zh_TC&#34;/中文繁体 and &#34;en&#34;/英文；</span>
</span></span><span style="display:flex;"><span>xxl.job.i18n<span style="color:#f92672">=</span>zh_CN
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 调度线程池最大线程配置【必填】</span>
</span></span><span style="display:flex;"><span>xxl.job.triggerpool.fast.max<span style="color:#f92672">=</span><span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>xxl.job.triggerpool.slow.max<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">### 调度中心日志表数据保存天数 [必填]：过期日志自动清理；限制大于等于7时生效，否则, 如-1，关闭自动清理功能；</span>
</span></span><span style="display:flex;"><span>xxl.job.logretentiondays<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 执行打包，install包含了 package的所有阶段</span>
</span></span><span style="display:flex;"><span>$ mvn package
</span></span><span style="display:flex;"><span>$ mvn clean install</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><code>xxl-job-admin/target</code><!-- raw HTML omitted -->：目录下生成：<!-- raw HTML omitted --><code>xxl-job-admin-2.3.0.jar</code></li>
</ol>
</li>
<li>
<ol start="4">
<li><code>java -jar xxl-job-admin-2.3.0.jar</code><!-- raw HTML omitted -->：启动<!-- raw HTML omitted --><code>xxl-job</code></li>
</ol>
</li>
</ul>
<hr>

            <footer class="footline">
            </footer>
          </article>

          </section>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="daemon">Daemon</h1>


            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Daemon</h1>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_supervisord">Install_Supervisord</h1>

<h2 id="安装supervisord进程守护服务">安装<code>Supervisord</code>进程守护服务</h2>
<h3 id="安装supervisord">安装<code>supervisord</code></h3>
<blockquote>
<ul>
<li>
<ol>
<li><a href="http://supervisord.org/" rel="external" target="_self"><code>Supervisord</code>官网</a></li>
</ol>
</li>
<li>
<ol start="2">
<li><a href="https://www.artacode.com/posts/supervisor/" rel="external" target="_self"><code>Supervisord</code>安装与使用</a></li>
</ol>
</li>
<li>
<ol start="3">
<li><a href="https://www.jianshu.com/p/9abffc905645" rel="external" target="_self"><code>supervisord</code>初体验</a></li>
</ol>
</li>
<li>
<ol start="4">
<li><a href="https://blog.wangmao.me/supervisor-with-php-fpm.html" rel="external" target="_self">使用<code>Supervisord</code>守护<code>php-fpm</code>进程</a></li>
</ol>
</li>
<li>
<ol start="5">
<li><a href="https://baiyongjie.com/?p=385" rel="external" target="_self"><code>Supervisord</code>管理<code>redis</code>进程</a></li>
</ol>
</li>
<li>
<ol start="6">
<li><a href="https://my.oschina.net/xinxingegeya/blog/659095" rel="external" target="_self">使用<code>Supervisord</code>管理<code>Redis</code>进程</a></li>
</ol>
</li>
</ul>
</blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->安装扩展，下载安装包<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum install python-setuptools -y  	<span style="color:#75715e"># 安装python程序开发过程库</span>
</span></span><span style="display:flex;"><span>$ cd /usr/local/src/
</span></span><span style="display:flex;"><span>$ wget https://pypi.python.org/packages/7b/17/88adf8cb25f80e2bc0d18e094fcd7ab300632ea00b601cbbbb84c2419eae/supervisor-3.3.2.tar.gz  	<span style="color:#75715e"># 下载安装包</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># https://files.pythonhosted.org/packages/0a/ba/52611dc8278828eb9ec339e6914a0f865f9e2af967214905927835dfac0a/setuptools-63.2.0.tar.gz  	# 新的下载地址</span>
</span></span><span style="display:flex;"><span>$ tar -zxvf supervisor-3.3.2.tar.gz  	<span style="color:#75715e"># 解压安装包</span>
</span></span><span style="display:flex;"><span>$ cd supervisor-3.3.2  	<span style="color:#75715e"># 进入程序目录</span>
</span></span><span style="display:flex;"><span>$ python setup.py install  	<span style="color:#75715e"># 执行安装脚本</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->修改配置文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo_supervisord_conf &gt;/etc/supervisord.conf  	<span style="color:#75715e"># 执行命令生成配置文件</span>
</span></span><span style="display:flex;"><span>$ mkdir /etc/supervisor  	<span style="color:#75715e"># 创建需要守护的进程目录</span>
</span></span><span style="display:flex;"><span>$ vim /etc/supervisord.conf
</span></span><span style="display:flex;"><span>	;<span style="color:#f92672">[</span>include<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>	;files <span style="color:#f92672">=</span> relative/directory/*.ini
</span></span><span style="display:flex;"><span>	修改为:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">[</span>include<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>	files<span style="color:#f92672">=</span>/etc/supervisor/*.conf <span style="color:#f92672">(</span>注意去掉分号,第一次安装的时候就因为没去掉分号出现了问题!<span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>$ supervisord -c /etc/supervisord.conf  	<span style="color:#75715e"># 启动服务</span>
</span></span><span style="display:flex;"><span>$ supervisorctl reload  	<span style="color:#75715e"># 重新载入</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="编写服务进程守护配置文件">编写服务进程守护配置文件</h3>
<ul>
<li>
<ol>
<li><code>Redis</code><!-- raw HTML omitted -->进程守护配置文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>program:redisd<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>command<span style="color:#f92672">=</span>bash -c <span style="color:#e6db74">&#34;sleep 1 &amp;&amp; /usr/local/redis/bin/redis-server  /usr/local/redis/redis.conf&#34;</span>    <span style="color:#75715e">#启动supervisor会自动运行这个command  </span>
</span></span><span style="display:flex;"><span>directory <span style="color:#f92672">=</span> /Users/xinxingegeya/IDE/redis/redis_7000 <span style="color:#75715e">#程序的启动目录</span>
</span></span><span style="display:flex;"><span>process_name<span style="color:#f92672">=</span>%<span style="color:#f92672">(</span>program_name<span style="color:#f92672">)</span>s   <span style="color:#75715e">#调用流程名称</span>
</span></span><span style="display:flex;"><span>autostart<span style="color:#f92672">=</span>true      <span style="color:#75715e">#当程序跑出exit的时候，这个program会自动重启</span>
</span></span><span style="display:flex;"><span>autorestart<span style="color:#f92672">=</span>true    <span style="color:#75715e">#程序重启时候停留在runing状态的秒数</span>
</span></span><span style="display:flex;"><span>startretries<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>  <span style="color:#75715e">#启动 5 秒后没有异常退出，就当作已经正常启动了</span>
</span></span><span style="display:flex;"><span>startretries <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>     <span style="color:#75715e">#启动失败自动重试次数，默认是 3</span>
</span></span><span style="display:flex;"><span>user <span style="color:#f92672">=</span> xinxingegeya          <span style="color:#75715e">#用哪个用户启动</span>
</span></span><span style="display:flex;"><span>exitcodes<span style="color:#f92672">=</span>0,2,70    <span style="color:#75715e">#退出码</span>
</span></span><span style="display:flex;"><span>stopsignal<span style="color:#f92672">=</span>QUIT     <span style="color:#75715e">#停止信号:QUIT(放弃)</span>
</span></span><span style="display:flex;"><span>stopwaitsecs<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>      <span style="color:#75715e">#停止等待秒数</span>
</span></span><span style="display:flex;"><span>stdout_logfile<span style="color:#f92672">=</span>/var/log/supervisor/redis.log
</span></span><span style="display:flex;"><span>stdout_logfile_maxbytes<span style="color:#f92672">=</span>1MB
</span></span><span style="display:flex;"><span>stdout_logfile_backups<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><code>php-fpm</code><!-- raw HTML omitted -->进程守护配置文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>program:php-fpm<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>command<span style="color:#f92672">=</span>bash -c <span style="color:#e6db74">&#34;sleep 1 &amp;&amp; /usr/local/php/sbin/php-fpm --fpm-config /usr/local/php/etc/php-fpm.conf --pid /usr/local/php/var/run/php-fpm.pid&#34;</span>
</span></span><span style="display:flex;"><span>process_name<span style="color:#f92672">=</span>%<span style="color:#f92672">(</span>program_name<span style="color:#f92672">)</span>s
</span></span><span style="display:flex;"><span>autostart<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span>autorestart<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span>startretries<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>exitcodes<span style="color:#f92672">=</span>0,2,70
</span></span><span style="display:flex;"><span>stopsignal<span style="color:#f92672">=</span>QUIT 
</span></span><span style="display:flex;"><span>stopwaitsecs<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>stdout_logfile<span style="color:#f92672">=</span>/var/log/supervisord/php-fpm.log</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->其他配置项<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>redirect_stderr<span style="color:#f92672">=</span>true ; <span style="color:#f92672">(</span>max main logfile bytes b4 rotation;default 50MB<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>logfile<span style="color:#f92672">=</span>/web/crontab_agent/Logs/swcAgent.log ;
</span></span><span style="display:flex;"><span>logfile_maxbytes<span style="color:#f92672">=</span>500MB ; <span style="color:#f92672">(</span>num of main logfile rotation backups;default 10<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>logfile_backups<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span> ;
</span></span><span style="display:flex;"><span>loglevel<span style="color:#f92672">=</span>info ;
</span></span><span style="display:flex;"><span>stdout_logfile<span style="color:#f92672">=</span>/web/crontab_agent/Logs/swcAgent.log ; stdout log path, NONE <span style="color:#66d9ef">for</span> none; default AUTO
</span></span><span style="display:flex;"><span>stdout_logfile_maxbytes<span style="color:#f92672">=</span>500MB   ; max <span style="color:#75715e"># logfile bytes b4 rotation (default 50MB)</span>
</span></span><span style="display:flex;"><span>stdout_logfile_backups<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>     ; <span style="color:#75715e"># of stdout logfile backups (default 10)</span>
</span></span><span style="display:flex;"><span>stderr_logfile<span style="color:#f92672">=</span>/web/crontab_agent/Logs/swcAgent.log ; stderr log path, NONE <span style="color:#66d9ef">for</span> none; default AUTO
</span></span><span style="display:flex;"><span>stderr_logfile_maxbytes<span style="color:#f92672">=</span>500MB   ; max <span style="color:#75715e"># logfile bytes b4 rotation (default 50MB)</span>
</span></span><span style="display:flex;"><span>stderr_logfile_backups<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>     ; <span style="color:#75715e"># of stderr logfile backups (default 10)</span></span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          </section>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="databases">Databases</h1>


            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Databases</h1>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_clickhouse">Install_ClickHouse</h1>

<h2 id="clickhouse部署"><code>ClickHouse</code>部署</h2>
<blockquote>
<ul>
<li><a href="https://clickhouse.com/docs/en/getting-started/quick-start" rel="external" target="_self"><code>ClickHouse</code></a></li>
</ul>
</blockquote>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="update_mysql5-7_to_mysql8">Update_Mysql5 7_To_Mysql8</h1>

<h2 id="mysql-57-升级到mysql-8"><code>Mysql 5.7 </code>升级到<code>Mysql 8</code></h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->下载解压<code>Mysql 8</code>安装包<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget https://dev.mysql.com/get/Downloads/MySQL-8.0/mysql-8.0.21-linux-glibc2.12-x86_64.tar.xz -P /usr/local/src/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ tar -xvf /usr/local/src/mysql-8.0.21-linux-glibc2.12-x86_64.tar.xz -C  /usr/local/src/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ mv /usr/local/src/mysql-8.0.21-linux-glibc2.12-x86_64  /usr/local/mysql8</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->修改<code>Mysql</code>的<code>cnf</code>文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<p><!-- raw HTML omitted -->只更改工作目录，不更改 data 数据目录<!-- raw HTML omitted --></p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sed  -i <span style="color:#e6db74">&#34;s#/usr/local/mysql#/usr/local/mysql8#g&#34;</span> /etc/my.cnf
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s/sql_mode/#sql_mode/g&#39;</span> /etc/my.cnf
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;20i sql_mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION&#39;</span> /etc/my.cnf
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;20i default_authentication_plugin=mysql_native_password&#39;</span> /etc/my.cnf
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s/query_cache_size/#query_cache_size/g&#39;</span> /etc/my.cnf
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s/query_cache_limit/#query_cache_limit/g&#39;</span> /etc/my.cnf</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->备份<code>Mysql</code>数据、目录，停止现有<!-- raw HTML omitted --><code>Mysql</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /usr/local/mysql/bin/mysql -uroot -p<span style="color:#e6db74">&#39;password&#39;</span> -S /opt/data/data_16303/mysql.sock -e <span style="color:#e6db74">&#34;set global innodb_fast_shutdown=0;&#34;</span>
</span></span><span style="display:flex;"><span>$ mysql -uroot -p<span style="color:#e6db74">&#39;password&#39;</span> -S /opt/data/data_16303/mysql.sock -e <span style="color:#e6db74">&#34;shutdown;&#34;</span>
</span></span><span style="display:flex;"><span>$ cp -r /usr/local/mysql/data<span style="color:#f92672">{</span>,.bak<span style="color:#f92672">}</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->启动<!-- raw HTML omitted --><code>Mysql 8</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /usr/local/mysql8/bin/mysqld --defaults-file<span style="color:#f92672">=</span>/etc/my.cnf --user<span style="color:#f92672">=</span>mysql &amp;
</span></span><span style="display:flex;"><span>$ mv /usr/local/mysql  /usr/local/src/mysql-5.7-<span style="color:#e6db74">`</span>date +%F<span style="color:#e6db74">`</span>.bak</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->检查数据库是否升级成功<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /usr/local/mysql8/bin/mysql -uroo -p<span style="color:#e6db74">&#39;password&#39;</span> -S /tmp/mysql.sock -e <span style="color:#e6db74">&#34;select version();&#34;</span> | tail -1<span style="color:#e6db74">`</span></span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_ydb">Install_Ydb</h1>

<h2 id="部署ydb单节点数据库">部署<code>Ydb</code>单节点数据库</h2>
<blockquote>
<ol>
<li><code>Ydb</code><!-- raw HTML omitted -->使用端口<!-- raw HTML omitted --></li>
</ol>
<table>
<thead>
<tr>
<th>端口</th>
<th>协议</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>2135~2136</td>
<td><code>TCP</code></td>
<td>用于客户端-集群交互的<code>GRPC</code></td>
</tr>
<tr>
<td>19001~19002</td>
<td><code>TCP</code></td>
<td>集群内节点交互互连</td>
</tr>
<tr>
<td>8765~8766</td>
<td><code>TCP</code></td>
<td>集群监控的<code>HTTP</code>接口</td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>
<ol>
<li><a href="https://ydb.tech/" rel="external" target="_self"><code>Ydb</code></a>数据库、<a href="https://github.com/ydb-platform/ydb" rel="external" target="_self"><code>Github-Ydb</code></a></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->系统要求<!-- raw HTML omitted --><code>Ubuntu 20.04、Debian 11、Fedora34</code><!-- raw HTML omitted -->等以上版本系统<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -p /opt/<span style="color:#f92672">{</span>ydb,ydb-cli<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>$ cd /opt/ydb/
</span></span><span style="display:flex;"><span>$ curl https://binaries.ydb.tech/local_scripts/install.sh | bash</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->启动、停止<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 磁盘启动使用，磁盘最少不能低于 80G</span>
</span></span><span style="display:flex;"><span>$ ./start.sh disk
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 内存启动，内存启动服务器重启数据丢失</span>
</span></span><span style="display:flex;"><span>$ ./start.sh ram
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 停止</span>
</span></span><span style="display:flex;"><span>$ ./stop.sh</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->部署<!-- raw HTML omitted --><code>Ydb-cli</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ curl -sSL https://storage.yandexcloud.net/yandexcloud-ydb/install.sh | bash
</span></span><span style="display:flex;"><span>$ source /root/.bashrc</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>Ydb-cli</code>查询</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ydb -e grpc://localhost:2136 -d /Root/test scheme ls
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ydb -e grpc://nodeip:2136 -d /Root/testdb workload stock init
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动YDB Web页面</span>
</span></span><span style="display:flex;"><span>$ ydb -e grpc://nodeip:2136 -d /Root/testdb workload stock run add-rand-order -s <span style="color:#ae81ff">600</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ydb -e grpc://192.168.88.112:2136 -d /Root/testdb topic read orders/updates -c ilnaz --wait --format<span style="color:#f92672">=</span>newline-delimited</span></span></code></pre></div></blockquote>
<hr>
<h2 id="部署集群模式">部署集群模式</h2>
<h3 id="安装前准备">安装前准备</h3>
<blockquote>
<ol>
<li><a href="https://ydb.tech/en/docs/deploy/manual/deploy-ydb-on-premises" rel="external" target="_self">在虚拟或裸机服务器上部署<code>YDB</code>集群</a></li>
</ol>
</blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->虚拟机系统安装好后，重新添加<!-- raw HTML omitted --><code>NVMe(v)</code>类型磁盘</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->准备环境、用户<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo groupadd ydb
</span></span><span style="display:flex;"><span>$ sudo useradd ydb -g ydb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo usermod -aG disk ydb  	<span style="color:#75715e"># 为了确保YDB可以访问块磁盘来运行，您需要将进程所有者添加到disk组中</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ apt install sudo  	<span style="color:#75715e"># 使用root用户安装sudo</span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;name  ALL=(ALL:ALL) ALL&#34;</span> &gt;&gt;/etc/sudoers
</span></span><span style="display:flex;"><span>$ sudo apt install curl parted</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->在所选磁盘上创建分区<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo parted /dev/nvme0n1 mklabel gpt -s
</span></span><span style="display:flex;"><span>$ sudo parted -a optimal /dev/nvme0n1 mkpart primary 0% 100%
</span></span><span style="display:flex;"><span>$ sudo parted /dev/nvme0n1 name <span style="color:#ae81ff">1</span> ydb_disk_ssd_01
</span></span><span style="display:flex;"><span>$ sudo partx --u /dev/nvme0n1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo parted /dev/nvme0n2 mklabel gpt -s
</span></span><span style="display:flex;"><span>$ sudo parted -a optimal /dev/nvme0n2 mkpart primary 0% 100%
</span></span><span style="display:flex;"><span>$ sudo parted /dev/nvme0n2 name <span style="color:#ae81ff">1</span> ydb_disk_ssd_02
</span></span><span style="display:flex;"><span>$ sudo partx --u /dev/nvme0n2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo parted /dev/nvme0n3 mklabel gpt -s
</span></span><span style="display:flex;"><span>$ sudo parted -a optimal /dev/nvme0n3 mkpart primary 0% 100%
</span></span><span style="display:flex;"><span>$ sudo parted /dev/nvme0n3 name <span style="color:#ae81ff">1</span> ydb_disk_ssd_03
</span></span><span style="display:flex;"><span>$ sudo partx --u /dev/nvme0n3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 系统上将出现一个标有磁盘的磁盘 </span>
</span></span><span style="display:flex;"><span>$ ll /dev/disk/by-partlabel/</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->下载并解压包含<code>ydbd</code>可执行文件和<code>YDB</code>运行所需库的存档<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo chown -R ydb:ydb /opt
</span></span><span style="display:flex;"><span>$ mkdir -p /opt/<span style="color:#f92672">{</span>ydb/<span style="color:#f92672">{</span>cfg,secure,certs,log<span style="color:#f92672">}</span>,ydbd-stable-linux-amd64<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ curl -L https://binaries.ydb.tech/ydbd-stable-linux-amd64.tar.gz | tar -xz --strip-component<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> -C /opt/ydbd-stable-linux-amd64</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->将可执行文件和库复制到适当的目录<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo cp -iR /opt/ydbd-stable-linux-amd64/bin /opt/ydb/
</span></span><span style="display:flex;"><span>$ sudo cp -iR /opt/ydbd-stable-linux-amd64/lib /opt/ydb/</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->使用以下内置命令格式化磁盘<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo LD_LIBRARY_PATH<span style="color:#f92672">=</span>/opt/ydb/lib /opt/ydb/bin/ydbd admin bs disk obliterate /dev/disk/by-partlabel/ydb_disk_ssd_01
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo LD_LIBRARY_PATH<span style="color:#f92672">=</span>/opt/ydb/lib /opt/ydb/bin/ydbd admin bs disk obliterate /dev/disk/by-partlabel/ydb_disk_ssd_02
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo LD_LIBRARY_PATH<span style="color:#f92672">=</span>/opt/ydb/lib /opt/ydb/bin/ydbd admin bs disk obliterate /dev/disk/by-partlabel/ydb_disk_ssd_03</span></span></code></pre></div></blockquote>
<hr>
<h3 id="准备证书使用保护模式">准备证书使用保护模式</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->准备<code>CA</code>文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/ydb/cfg/ca.cnf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[ ca ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">default_ca = CA_default
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[ CA_default ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">default_days = 365
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">database = /opt/ydb/secure/index.txt
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">serial = /opt/ydb/secure/serial.txt
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">default_md = sha256
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">copy_extensions = copy
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">unique_subject = no
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[ req ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">prompt=no
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">distinguished_name = distinguished_name
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">x509_extensions = extensions
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[ distinguished_name ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">organizationName = YDB
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">commonName = YDB CA
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[ extensions ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">keyUsage = critical,digitalSignature,nonRepudiation,keyEncipherment,keyCertSign
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">basicConstraints = critical,CA:true,pathlen:1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[ signing_policy ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">organizationName = supplied
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">commonName = optional
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[ signing_node_req ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">keyUsage = critical,digitalSignature,keyEncipherment
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">extendedKeyUsage = serverAuth,clientAuth
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># Used to sign client certificates. 用于签署客户端证书
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[ signing_client_req ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">keyUsage = critical,digitalSignature,keyEncipherment
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">extendedKeyUsage = clientAuth
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->创建<code>CA</code>密钥<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ openssl genrsa -out /opt/ydb/certs/ca.key <span style="color:#ae81ff">2048</span></span></span></code></pre></div><ul>
<li>2.1 <!-- raw HTML omitted -->创建私有证书颁发机构<code>CA</code>证书<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ openssl req -new -x509 -config /opt/ydb/cfg/ca.cnf -key /opt/ydb/certs/ca.key -out /opt/ydb/certs/ca.crt -days <span style="color:#ae81ff">1830</span> -batch</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->创建文本数据库和<code>OpenSSL</code>证书索引文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ touch /opt/ydb/secure/index.txt
</span></span><span style="display:flex;"><span>$ echo <span style="color:#ae81ff">01</span> &gt;/opt/ydb/secure/serial.txt</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->创建<code>node.cnf</code>具有以下内容的配置文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/ydb/cfg/node.cnf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># OpenSSL node configuration file
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[ req ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">prompt = no
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">distinguished_name = distinguished_name
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">req_extensions = extensions
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[ distinguished_name ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">organizationName = YDB
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[ extensions ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">subjectAltName = DNS:&lt;node&gt;.&lt;domain&gt;  	# 节点IP或者域名
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->创建证书密钥<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ openssl genrsa -out /opt/ydb/certs/node.key <span style="color:#ae81ff">2048</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->创建证书签名请求<code>CSR</code><!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ openssl req -new -sha256 -config /opt/ydb/cfg/node.cnf -key /opt/ydb/certs/node.key -out /opt/ydb/secure/node.csr -batch</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->创建节点证书<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ openssl ca -config /opt/ydb/cfg/ca.cnf <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> -keyfile /opt/ydb/certs/ca.key <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> -cert /opt/ydb/certs/ca.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> -policy signing_policy <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> -extensions signing_node_req <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> -out /opt/ydb/certs/node.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> -outdir /opt/ydb/certs/ <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> -in /opt/ydb/secure/node.csr -batch</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->将证书和节点密钥复制到安装文件夹<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo -u ydb cp certs/ca.crt certs/node.crt certs/node.key /opt/ydb/certs/</span></span></code></pre></div></blockquote>
<hr>
<h3 id="为ydb准备集群配置文件">为<code>YDB</code>准备集群配置文件</h3>
<blockquote>
<ul>
<li><a href="https://ydb.tech/en/docs/deploy/configuration/config" rel="external" target="_self">集群配置</a></li>
</ul>
</blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->集群类型、在集群每个节点中添加<!-- raw HTML omitted --><code>/opt/ydb/cfg/config.yaml</code>保存<code>YDB</code> 配置文件</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><a href="https://github.com/ydb-platform/ydb/blob/main/ydb/deploy/yaml_config_examples/block-4-2.yaml" rel="external" target="_self"><code>block-4-2</code></a><!-- raw HTML omitted -->用于单数据中心集群<!-- raw HTML omitted --></li>
<li><a href="https://github.com/ydb-platform/ydb/blob/main/ydb/deploy/yaml_config_examples/mirror-3dc-9-nodes.yaml" rel="external" target="_self"><code>mirror-3dc</code></a><!-- raw HTML omitted -->用于由 9 个节点组成的跨数据中心集群<!-- raw HTML omitted --></li>
<li><a href="https://github.com/ydb-platform/ydb/blob/main/ydb/deploy/yaml_config_examples/mirror-3dc-3-nodes.yaml" rel="external" target="_self"><code>mirror-3dc-3nodes</code></a><!-- raw HTML omitted -->用于由 3 个节点组成的跨数据中心集群<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->在<code>host_configs</code>部分中，指定每个群集节点上所有磁盘类型<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->可用磁盘种类：固态硬盘：<code>SSD</code>、<code>NVME</code>、<code>HDD</code><!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">host_configs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">drive</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/dev/disk/by-partlabel/ydb_disk_ssd_01</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">SSD  	# 可用磁盘种类：SSD、NVME、HDD</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">host_config_id</span>: <span style="color:#ae81ff">1</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->在该<code>hosts</code>部分中，指定每个节点的<code>FQDN</code>、它们的配置和在<code>data_center</code>或中的位置<code>rack</code><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->在<!-- raw HTML omitted --><code>/etc/hosts</code><!-- raw HTML omitted -->文件下做映射：<!-- raw HTML omitted --><code>IP:hostname</code><!-- raw HTML omitted -->避免不必要麻烦所有主机名必须都是小写字母<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">host</span>: <span style="color:#ae81ff">node1.ydb.tech</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">host_config_id</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">walle_location</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">body</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">data_center</span>: <span style="color:#e6db74">&#39;zone-a&#39;</span>  	<span style="color:#75715e"># 填写 hostname</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rack</span>: <span style="color:#e6db74">&#39;1&#39;</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">host</span>: <span style="color:#ae81ff">node2.ydb.tech</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">host_config_id</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">walle_location</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">body</span>: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">data_center</span>: <span style="color:#e6db74">&#39;zone-b&#39;</span>  	<span style="color:#75715e"># 填写 hostname</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rack</span>: <span style="color:#e6db74">&#39;1&#39;</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">host</span>: <span style="color:#ae81ff">node3.ydb.tech</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">host_config_id</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">walle_location</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">body</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">data_center</span>: <span style="color:#e6db74">&#39;zone-c&#39;</span>  	<span style="color:#75715e"># 填写 hostname</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rack</span>: <span style="color:#e6db74">&#39;1&#39;</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->启用用户身份验证<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->在<code>YDB</code>集群中启用认证和用户访问差异化特性，在<code>domains_config</code>部分添加以下参数<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">domains_config</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">security_config</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enforce_user_token_requirement</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">monitoring_allowed_sids</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;root&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;ADMINS&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;DATABASE-ADMINS&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">administration_allowed_sids</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;root&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;ADMINS&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;DATABASE-ADMINS&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">viewer_allowed_sids</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;root&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;ADMINS&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;DATABASE-ADMINS&#34;</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->在<code>YDB</code>配置文件中启用流量加密模式<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->在<code>interconnect_config</code>和<code>grpc_config</code>部分中，指定证书、密钥和<code>CA</code>证书的路径<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">interconnect_config</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">start_tcp</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">encryption_mode</span>: <span style="color:#ae81ff">OPTIONAL</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path_to_certificate_file</span>: <span style="color:#e6db74">&#34;/opt/ydb/certs/node.crt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path_to_private_key_file</span>: <span style="color:#e6db74">&#34;/opt/ydb/certs/node.key&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path_to_ca_file</span>: <span style="color:#e6db74">&#34;/opt/ydb/certs/ca.crt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">grpc_config</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">cert</span>: <span style="color:#e6db74">&#34;/opt/ydb/certs/node.crt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">key</span>: <span style="color:#e6db74">&#34;/opt/ydb/certs/node.key&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ca</span>: <span style="color:#e6db74">&#34;/opt/ydb/certs/ca.crt&#34;</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="6">
<li><!-- raw HTML omitted -->完整<!-- raw HTML omitted --><code>block-4-2</code>配置<!-- raw HTML omitted -->避免不必要麻烦所有主机名必须都是小写字母<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/ydb/cfg/config.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># YDB configuration options and their values
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># are described in documentaion https://ydb.tech/en/docs/deploy/configuration/config
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># static erasure is the parameter that
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># describes the fault tolerance mode of the
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># cluster. See docs for more details https://ydb.tech/en/docs/deploy/configuration/config#domains-blob
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">static_erasure: mirror-3-dc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">host_configs: # the list of available host configurations in the cluster.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- drive:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - path: /dev/disk/by-partlabel/ydb_disk_ssd_01    # path of the first disk in the host configration.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    type: NVME                                       # kind of the disk: available kinds are SSD, NVME, HDD
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - path: /dev/disk/by-partlabel/ydb_disk_ssd_02
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    type: NVME
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - path: /dev/disk/by-partlabel/ydb_disk_ssd_03
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    type: NVME
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  host_config_id: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">hosts:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- host: debian-1-88-110       # storage node DNS name
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  host_config_id: 1                 # numeric host configuration template identifier
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  walle_location:                   # this parameter describes where host is located.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    body: 1                         # string representing a host serial number.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    data_center: &#39;debian-1-88-110&#39;           # string representing the datacenter / availability zone where the host is located.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                    # if cluster is deployed using mirror-3-dc fault tolerance mode, all hosts must be distributed
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                    # across 3 datacenters.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    rack: &#39;1&#39;                       # string representing a rack identifier where the host is located.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                    # if cluster is deployed using block-4-2 erasure, all hosts should be distrubited
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                    # accross at least 8 racks.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- host: ubuntu-1-88-111
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  host_config_id: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  walle_location:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    body: 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    data_center: &#39;ubuntu-1-88-111&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    rack: &#39;2&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- host: ubuntu-2-88-112
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  host_config_id: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  walle_location:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    body: 3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    data_center: &#39;ubuntu-2-88-112&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    rack: &#39;3&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">domains_config:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # There can be only one root domain in a cluster. Domain name prefixes all scheme objects names, e.g. full name of a table table1 in database db1.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # in a cluster with domains_config.domain.name parameter set to Root would be equal to /Root/db1/table1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  domain:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - name: Root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    storage_pool_types:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - kind: nvme
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      pool_config:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        box_id: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        # fault tolerance mode name - none, block-4-2, or mirror-3-dc..
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        # See docs for more details https://ydb.tech/en/docs/deploy/configuration/config#domains-blob
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        erasure_species: mirror-3-dc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        kind: nvme
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        geometry:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          realm_level_begin: 10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          realm_level_end: 20
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          domain_level_begin: 10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          domain_level_end: 256
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        pdisk_filter:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - property:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          - type: NVME  # device type to match host_configs.drive.type
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        vdisk_kind: Default
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  state_storage:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - ring:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      node: [1, 2, 3]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      nto_select: 3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ssid: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">table_service_config:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  sql_version: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">actor_system_config:          # the configuration of the actor system which descibes how cores of the instance are distributed
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  executor:                   # accross different types of workloads in the instance.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - name: System              # system executor of the actor system. in this executor YDB launches system type of workloads, like system tablets
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                              # and reads from storage.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    threads: 2                # the number of threads allocated to system executor.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    type: BASIC
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - name: User                # user executor of the actor system. In this executor YDB launches user workloads, like datashard activities,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                              # queries and rpc calls.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    threads: 3                # the number of threads allocated to user executor.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    type: BASIC
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - name: Batch               # user executor of the actor system. In this executor YDB launches batch operations, like scan queries, table
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                              # compactions, background compactions.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    threads: 2                # the number of threads allocated to the batch executor.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    type: BASIC
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - name: IO                  # the io executor. In this executor launches sync operations and writes logs.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    threads: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    time_per_mailbox_micro_secs: 100
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    type: IO
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - name: IC                  # the interconnect executor which YDB uses for network communications accross different nodes of the cluster.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    spin_threshold: 10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    threads: 1                # the number of threads allocated to the interconnect executor.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    time_per_mailbox_micro_secs: 100
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    type: BASIC
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  scheduler:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    progress_threshold: 10000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    resolution: 256
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    spin_threshold: 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">blob_storage_config:         # configuration of static blobstorage group.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                             # YDB uses this group to store system tablets&#39; data, like SchemeShard
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  service_set:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    groups:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - erasure_species: mirror-3-dc # fault tolerance mode name for the static group
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      rings:          # in mirror-3-dc must have exactly 3 rings or availability zones
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - fail_domains:  # first record: fail domains of the static group describe where each vdisk of the static group should be located.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - vdisk_locations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          - node_id: debian-1-88-110
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            pdisk_category: NVME
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            path: /dev/disk/by-partlabel/ydb_disk_ssd_01
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - vdisk_locations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          - node_id: debian-1-88-110
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            pdisk_category: NVME
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            path: /dev/disk/by-partlabel/ydb_disk_ssd_02
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - vdisk_locations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          - node_id: debian-1-88-110
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            pdisk_category: NVME
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            path: /dev/disk/by-partlabel/ydb_disk_ssd_03
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - fail_domains: # second ring: fail domains of the static group describe where each vdisk of the static group should be located.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - vdisk_locations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          - node_id: ubuntu-1-88-111
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            pdisk_category: NVME
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            path: /dev/disk/by-partlabel/ydb_disk_ssd_01
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - vdisk_locations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          - node_id: ubuntu-1-88-111
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            pdisk_category: NVME
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            path: /dev/disk/by-partlabel/ydb_disk_ssd_02
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - vdisk_locations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          - node_id: ubuntu-1-88-111
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            pdisk_category: NVME
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            path: /dev/disk/by-partlabel/ydb_disk_ssd_03
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - fail_domains: # third ring: fail domains of the static group describe where each vdisk of the static group should be located.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - vdisk_locations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          - node_id: ubuntu-2-88-112
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            pdisk_category: NVME
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            path: /dev/disk/by-partlabel/ydb_disk_ssd_01
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - vdisk_locations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          - node_id: ubuntu-2-88-112
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            pdisk_category: NVME
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            path: /dev/disk/by-partlabel/ydb_disk_ssd_02
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - vdisk_locations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          - node_id: ubuntu-2-88-112
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            pdisk_category: NVME
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            path: /dev/disk/by-partlabel/ydb_disk_ssd_03
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">channel_profile_config:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  profile:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - channel:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - erasure_species: mirror-3-dc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      pdisk_category: 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      storage_pool_kind: nvme
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - erasure_species: mirror-3-dc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      pdisk_category: 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      storage_pool_kind: nvme
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - erasure_species: mirror-3-dc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      pdisk_category: 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      storage_pool_kind: nvme
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    profile_id: 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">interconnect_config:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    start_tcp: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    encryption_mode: OPTIONAL
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    path_to_certificate_file: &#34;/opt/ydb/certs/node.crt&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    path_to_private_key_file: &#34;/opt/ydb/certs/node.key&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    path_to_ca_file: &#34;/opt/ydb/certs/ca.crt&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">grpc_config:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    cert: &#34;/opt/ydb/certs/node.crt&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    key: &#34;/opt/ydb/certs/node.key&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ca: &#34;/opt/ydb/certs/ca.crt&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="启动数据库静态节点">启动数据库静态节点</h3>
<h4 id="手动方式启动">手动方式启动</h4>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->启动<code>/Root/testdb</code>数据库的<code>YDB</code>动态节点<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>&lt;nodeN.ydb.tech&gt;</code><!-- raw HTML omitted -->运行静态节点的服务器的<code>FQDN</code>在哪里<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->在其他服务器上运行额外的动态节点以确保数据库可用性<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo su - ydb
</span></span><span style="display:flex;"><span>$ cd /opt/ydb
</span></span><span style="display:flex;"><span>$ export LD_LIBRARY_PATH<span style="color:#f92672">=</span>/opt/ydb/lib
</span></span><span style="display:flex;"><span>/opt/ydb/bin/ydbd server --log-level <span style="color:#ae81ff">3</span> --tcp --yaml-config /opt/ydb/cfg/config.yaml --grpc-port <span style="color:#ae81ff">2135</span> --ic-port <span style="color:#ae81ff">19001</span> --mon-port <span style="color:#ae81ff">8765</span> --node static &gt;/opt/ydb/log/static-node.out 2&gt;/opt/ydb/log/static-node.err &amp;&gt;</span></span></code></pre></div></blockquote>
<hr>
<h4 id="使用systemd方式启动">使用<code>systemd</code>方式启动</h4>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->编写启动文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>/etc/systemd/system/ydbd-storage.service</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/systemd/system/ydbd-storage.service<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=YDB storage node
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network-online.target rc-local.service
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Wants=network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">StartLimitInterval=10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">StartLimitBurst=15
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=always
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">RestartSec=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=ydb  	# 根据用户修改
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">PermissionsStartOnly=true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">StandardOutput=/var/log/ydb.log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">StandardError=/var/log/ydb.log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SyslogIdentifier=ydbd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SyslogFacility=daemon
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SyslogLevel=err
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Environment=LD_LIBRARY_PATH=/opt/ydb/lib
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/ydb/bin/ydbd server --log-level 3 --syslog --tcp --yaml-config  /opt/ydb/cfg/config.yaml --grpc-port 2135 --ic-port 19001 --mon-port 8765 --node static
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LimitNOFILE=65536
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LimitCORE=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LimitMEMLOCK=3221225472
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->启动服务器、查看状态<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo systemctl start ydbd-storage
</span></span><span style="display:flex;"><span>$ sudo systemctl status ydbd-storage</span></span></code></pre></div></blockquote>
<hr>
<h3 id="初始化集群">初始化集群</h3>
<h4 id="不使用身份验证方式初始化集群">不使用身份验证方式初始化集群</h4>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->在其中一个集群节点上，运行命令<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ export LD_LIBRARY_PATH<span style="color:#f92672">=</span>/opt/ydb/lib
</span></span><span style="display:flex;"><span>/opt/ydb/bin/ydbd admin blobstorage config init --yaml-file  /opt/ydb/cfg/config.yaml
</span></span><span style="display:flex;"><span>$ echo $?</span></span></code></pre></div></blockquote>
<hr>
<h4 id="使用身份验证方式初始化集群">使用身份验证方式初始化集群</h4>
<blockquote>
<p>要在启用用户认证模式的集群中执行管理命令（包括集群初始化、数据库创建、磁盘管理等），您必须首先使用<code>YDB CLI</code>客户端<code>2.0.0</code>或更高版本获取认证令牌。<a href="https://ydb.tech/en/docs/reference/ydb-cli/install" rel="external" target="_self">您必须按照安装说明</a>将<code>YDB CLI</code>客户端安装在任何可以通过网络访问集群节点的计算机上（例如，在其中一个集群节点上）。</p>
</blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->第一次安装集群时，它只有一个<code>root</code>密码为空的帐户，因此获取令牌的命令<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->任何集群服务器都可以指定为连接服务器（<code>-e</code>或<code>--endpoint</code>参数）<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ydb -e grpc://&lt;node1.ydb.tech&gt;:2135 -d /Root --user root --no-password auth get-token --force &gt;token-file</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->如果启用了<!-- raw HTML omitted --><code>TLS</code>流量保护，请使用受保护的<code>grpcs</code>协议而不是<code>grpc</code>上面命令中的协议，并在参数中额外指定<code>CA</code>证书的路径<code>--ca-file</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ydb -e grpcs://&lt;node1.ydb.tech&gt;:2135 -d /Root --ca-file /opt/ydb/certs/ca.crt --user root --no-password auth get-token --force &gt;token-file</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->如果命令执行成功，身份验证令牌将被写入<code>token-file</code>. 只需要将此文件复制到稍后要运行集群初始化和数据库创建命令的集群节点。接下来，在此集群节点上运行命令<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ export LD_LIBRARY_PATH<span style="color:#f92672">=</span>/opt/ydb/lib
</span></span><span style="display:flex;"><span>/opt/ydb/bin/ydbd -f token-file admin blobstorage config init --yaml-file  /opt/ydb/cfg/config.yaml
</span></span><span style="display:flex;"><span>$ echo $?</span></span></code></pre></div></blockquote>
<hr>
<h3 id="创建数据库">创建数据库</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->要使用表，您需要至少创建一个数据库并运行一个进程来为该数据库提供服务（动态节点）不使用令牌<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>/Root</code><!-- raw HTML omitted -->: 根域的名称，必须与<!-- raw HTML omitted --><code>domains_config</code>. <code>domain</code>. <code>name</code><!-- raw HTML omitted -->在集群配置文件中设置<!-- raw HTML omitted --></li>
<li><code>testdb</code><!-- raw HTML omitted -->: 创建的数据库名称<!-- raw HTML omitted --></li>
<li><code>ssd:1</code><!-- raw HTML omitted -->：存储池的名称和池中块的编号。池名称通常表示数据存储设备的类型，并且必须与<!-- raw HTML omitted --><code>storage_pool_types</code>. <code>kind</code><!-- raw HTML omitted -->里面的设置<!-- raw HTML omitted --><code>domains_config</code>。<code>domain</code><!-- raw HTML omitted -->配置文件的元素<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ LD_LIBRARY_PATH<span style="color:#f92672">=</span>/opt/ydb/lib /opt/ydb/bin/ydbd admin database /Root/testdb create ssd:1</span></span></code></pre></div><ul>
<li>
<p><!-- raw HTML omitted -->使用令牌文件的数据库创建命令<!-- raw HTML omitted --></p>
<p>如果在集群中启用了用户认证模式，则必须将认证令牌传递给数据库创建命令。<a href="https://ydb.tech/en/docs/deploy/manual/deploy-ydb-on-premises#initialize-cluster" rel="external" target="_self">集群初始化</a>部分描述了获取令牌的过程</p>
</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ LD_LIBRARY_PATH<span style="color:#f92672">=</span>/opt/ydb/lib /opt/ydb/bin/ydbd -f token-file admin database /Root/testdb create ssd:1</span></span></code></pre></div></blockquote>
<hr>
<h3 id="启动数据库动态节点">启动数据库动态节点</h3>
<h4 id="手动方式启动-1">手动方式启动</h4>
<ul>
<li>
<ol>
<li>启动<code>/Root/testdb</code><!-- raw HTML omitted -->数据库的<code>YDB</code>动态节点<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>&lt;nodeN.ydb.tech&gt;</code><!-- raw HTML omitted -->运行静态节点的服务器的<code>FQDN</code>在哪里<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->在其他服务器上运行额外的动态节点以确保数据库可用性<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo su - ydb
</span></span><span style="display:flex;"><span>$ cd /opt/ydb
</span></span><span style="display:flex;"><span>$ export LD_LIBRARY_PATH<span style="color:#f92672">=</span>/opt/ydb/lib
</span></span><span style="display:flex;"><span>/opt/ydb/bin/ydbd server --grpc-port <span style="color:#ae81ff">2136</span> --ic-port <span style="color:#ae81ff">19002</span> --mon-port <span style="color:#ae81ff">8766</span> --yaml-config  /opt/ydb/cfg/config.yaml --tenant /Root/testdb --node-broker &lt;node1.ydb.tech&gt;:2135 --node-broker &lt;node2.ydb.tech&gt;:2135 --node-broker &lt;node3.ydb.tech&gt;:2135</span></span></code></pre></div></blockquote>
<hr>
<h4 id="使用systemd方式启动-1">使用<code>Systemd</code>方式启动</h4>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->编写启动文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->创建一个名为<!-- raw HTML omitted --><code>/etc/systemd/system/ydbd-testdb.service</code><!-- raw HTML omitted -->以下内容的配置文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/systemd/system/ydbd-testdb.service<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=YDB testdb dynamic node
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network-online.target rc-local.service
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Wants=network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">StartLimitInterval=10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">StartLimitBurst=15
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=always
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">RestartSec=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=ydb
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">PermissionsStartOnly=true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">StandardOutput=syslog
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">StandardError=syslog
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SyslogIdentifier=ydbd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SyslogFacility=daemon
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SyslogLevel=err
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Environment=LD_LIBRARY_PATH=/opt/ydb/lib
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/ydb/bin/ydbd server --grpc-port 2136 --ic-port 19002 --mon-port 8766 --yaml-config  /opt/ydb/cfg/config.yaml --tenant /Root/testdb --node-broker &lt;node1.ydb.tech&gt;:2135 --node-broker &lt;node2.ydb.tech&gt;:2135 --node-broker &lt;node3.ydb.tech&gt;:2135
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LimitNOFILE=65536
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LimitCORE=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LimitMEMLOCK=32212254720
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li>启动<code>/Root/testdb</code><!-- raw HTML omitted -->数据库的<code>YDB</code>动态节点<!-- raw HTML omitted --><!-- raw HTML omitted -->在其他服务器上运行额外的动态节点以确保数据库可用性<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo systemctl start ydbd-testdb</span></span></code></pre></div></blockquote>
<hr>
<h3 id="初始帐户设置">初始帐户设置</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->在集群配置文件中启用了身份验证模式，则必须在使用<code>YDB</code>集群之前完成初始帐户设置<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>
<p><code>YDB</code>集群的初始安装会自动创建一个<code>root</code>密码为空的帐户，以及<a href="https://ydb.tech/en/docs/cluster/access" rel="external" target="_self">访问管理</a>部分中描述的一组标准用户组</p>
</li>
<li>
<p>要在创建的<code>YDB</code>集群中执行初始帐户设置，<a href="https://ydb.tech/en/docs/reference/ydb-cli/install" rel="external" target="_self">按照文档</a>中的描述安装<code>YDB CLI</code></p>
</li>
<li>
<p><code>&lt;node.ydb.tech&gt;</code>是运行支持<code>/Root/testdb</code>数据库的动态节点的服务器的<code>FQDN</code></p>
</li>
<li>
<p>在运行帐户创建和组分配命令时，<code>YDB CLI</code>客户端将请求<code>root</code>用户密码。<a href="https://ydb.tech/en/docs/reference/ydb-cli/profile/" rel="external" target="_self">您可以按照<code>YDB CLI</code>文档</a>中的说明创建连接配置文件，从而避免输入多个密码</p>
</li>
<li>
<p>如果集群中启用了<code>TLS</code>流量保护，请使用受保护的<code>grpcs</code>协议而不是<code>grpc</code>上面命令中的协议，并在参数中指定<code>CA</code>证书的路径<code>--ca-file</code>（或将其保存在连接配置文件中）</p>
</li>
<li>
<p><code>root</code><!-- raw HTML omitted -->为账户设置密码<!-- raw HTML omitted --></p>
</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ydb -e grpc://&lt;node.ydb.tech&gt;:2136 -d /Root/testdb --user root --no-password yql -s <span style="color:#e6db74">&#39;ALTER USER root PASSWORD &#34;passw0rd&#34;&#39;</span>  	<span style="color:#75715e"># 将passw0rd值替换为自己定义密码  </span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->创建其他帐户<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ydb -e grpc://&lt;node.ydb.tech&gt;:2136 -d /Root/testdb --user root yql -s <span style="color:#e6db74">&#39;CREATE USER user1 PASSWORD &#34;passw0rd&#34;&#39;</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->通过将它们包含在集成组中来设置帐户权限<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ydb -e grpc://&lt;node.ydb.tech&gt;:2136 -d /Root/testdb --user root yql -s <span style="color:#e6db74">&#39;ALTER GROUP `ADMINS` ADD USER user1&#39;</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="测试创建的数据库">测试创建的数据库</h3>
<ul>
<li>
<ol>
<li><a href="https://ydb.tech/en/docs/reference/ydb-cli/install" rel="external" target="_self">按照文档</a>中的描述安装<code>YDB CLI</code>，创建一个<code>test_table</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>&lt;node.ydb.tech&gt;</code>运行支持<code>/Root/testdb</code>数据库的动态节点的服务器的<code>FQDN</code>在哪里</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ydb -e grpc://&lt;node.ydb.tech&gt;:2136 -d /Root/testdb scripting yql --script <span style="color:#e6db74">&#39;CREATE TABLE `testdir/test_table` (id Uint64, title Utf8, PRIMARY KEY (id));&#39;</span></span></span></code></pre></div><ul>
<li>集群开启了<code>TLS</code>流量保护或用户认证方式</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ydb -e grpcs://&lt;node.ydb.tech&gt;:2136 -d /Root/testdb --ca-file ydb-ca.crt --user root scripting yql --script <span style="color:#e6db74">&#39;CREATE TABLE `testdir/test_table` (id Uint64, title Utf8, PRIMARY KEY (id));&#39;</span></span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_postgresql">Install_PostgreSQL</h1>

<h2 id="安装postgresql数据库">安装<code>PostgreSQL</code>数据库</h2>
<ul>
<li>
<ol>
<li><a href="https://www.postgresql.org/ftp/source/" rel="external" target="_self"><code>PostgreSQL</code></a>、<a href="https://download.postgresql.org/pub/" rel="external" target="_self"><code>Download-PostgreSQL</code></a>、<a href="https://ftp.postgresql.org/pub/" rel="external" target="_self"><code>FTP-PostgreSQL</code></a></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install c++ gcc-c++ readline-devel zlib-devel
</span></span><span style="display:flex;"><span>$ curl -o /usr/local/src/postgresql-15.0.tar.gz  https://ftp.postgresql.org/pub/source/v15.0/postgresql-15.0.tar.gz
</span></span><span style="display:flex;"><span>$ tar -zxvf postgresql-15.0.tar.gz 
</span></span><span style="display:flex;"><span>$ cd postgresql-15.0
</span></span><span style="display:flex;"><span>$ view INSTALL</span></span></code></pre></div><ul>
<li>安装</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ./configure --prefix<span style="color:#f92672">=</span>/usr/local/postgresql
</span></span><span style="display:flex;"><span>$ make world
</span></span><span style="display:flex;"><span>$ make install-world
</span></span><span style="display:flex;"><span>$ adduser postgres  	<span style="color:#75715e"># 创建用户</span>
</span></span><span style="display:flex;"><span>$ mkdir -p /usr/local/postgresql/data
</span></span><span style="display:flex;"><span>$ chown -R postgres. /usr/local/postgresql/data
</span></span><span style="display:flex;"><span>$ su - postgres
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 初始化数据库</span>
</span></span><span style="display:flex;"><span>$ /usr/local/postgresql/bin/initdb -D /usr/local/postgresql/data
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动数据库</span>
</span></span><span style="display:flex;"><span>$ /usr/local/postgresql/bin/pg_ctl -D /usr/local/postgresql/data -l logfile start</span></span></code></pre></div><ul>
<li>配置<code>Postgresql</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ vim /usr/local/postgresql/data/postgresql.conf
</span></span><span style="display:flex;"><span>listen_addresses <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;192.168.88.0/24&#39;</span>  	<span style="color:#75715e"># 开启远程访问  </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ vim /usr/local/postgresql/data/pg_hba.conf
</span></span><span style="display:flex;"><span><span style="color:#75715e"># IPv4 local connections:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 信任远程连接,修改如下内容，信任指定服务器连接,ident修改为MD5</span>
</span></span><span style="display:flex;"><span>host    all            all      127.0.0.1/32      md5
</span></span><span style="display:flex;"><span>host    all            all      10.1.8.0/24        md5</span></span></code></pre></div><ul>
<li>使用<code>PostgreSQL</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ su - postgres  	<span style="color:#75715e"># 切换进去</span>
</span></span><span style="display:flex;"><span>$ psql  	<span style="color:#75715e"># 进入命令行模式</span>
</span></span><span style="display:flex;"><span>$ <span style="color:#ae81ff">\l</span>  	<span style="color:#75715e"># 列出数据库</span>
</span></span><span style="display:flex;"><span>$ <span style="color:#ae81ff">\d</span>u  	<span style="color:#75715e"># 列出用户</span>
</span></span><span style="display:flex;"><span>$ <span style="color:#ae81ff">\c</span> mydb  	<span style="color:#75715e"># 进入数据库</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 假定数据库名为gerericdb</span>
</span></span><span style="display:flex;"><span>$ /opt/pgsql/bin/createdb genericdb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 进入数据库内部</span>
</span></span><span style="display:flex;"><span>$ /opt/pgsql/bin/psql genericdb</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_otter">Install_Otter</h1>

<h2 id="otter数据搬运"><code>Otter</code>数据搬运</h2>
<blockquote>
<ul>
<li><a href="https://github.com/alibaba/otter" rel="external" target="_self"><code>Otter</code></a></li>
</ul>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_mysql_pxc">Install_Mysql_PXC</h1>

<h2 id="安装mysql-pxc">安装<code>Mysql-PXC</code></h2>
<blockquote>
<ul>
<li><a href="https://blog.51cto.com/sumongodb/1956086" rel="external" target="_self">企业主流<code>MySQL</code>高可用集群架构三部曲之<code>PXC</code></a></li>
<li><a href="https://www.percona.com/doc/percona-xtradb-cluster/LATEST/install/docker.html" rel="external" target="_self">在<code>Docker</code>容器中运行<code>Percona XtraDB</code>集群</a></li>
</ul>
</blockquote>
<ul>
<li>
<ol>
<li><code>docker</code><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>Mysql-PXC</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;install-mysql-pxc.sh<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sudo yum -y remove docker \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker-client \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker-client-latest \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker-common \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker-latest 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker-latest-logrotate 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker-logrotate \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker-engine  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sudo yum install -y yum-utils
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sudo yum-config-manager --add-repo \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">https://download.docker.com/linux/centos/docker-ce.repo  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sudo yum install -y docker-ce docker-ce-cli containerd.io
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sleep 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sudo systemctl start docker
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sudo systemctl enable docker
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">mkdir -p /opt/data/{data-3306.data-3307,data-3308}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker network create pxc-network  	# 创建网络
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker run -i -d -p 3306:3306 -v /etc/localtime:/etc/localtime -e MYSQL_ROOT_PASSWORD=root -e CLUSTER_NAME=cluster1 --name=node1 --privileged=true --net=pxc-network percona/percona-xtradb-cluster:5.7
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sleep 15
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker run -i -d -p 3307:3306 -v /etc/localtime:/etc/localtime -e MYSQL_ROOT_PASSWORD=root -e CLUSTER_NAME=cluster1 -e CLUSTER_JOIN=node1 --name=node2 --privileged=true --net=pxc-network percona/percona-xtradb-cluster:5.7
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sleep 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker run -i -d -p 3308:3306 -v /etc/localtime:/etc/localtime -e MYSQL_ROOT_PASSWORD=root -e CLUSTER_NAME=cluster1 -e CLUSTER_JOIN=node1 --name=node3 --privileged=true --net=pxc-network percona/percona-xtradb-cluster:5.7  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sleep 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker exec -it node1 /usr/bin/mysql -uroot -proot -e &#34;show status like &#39;wsrep%&#39;;&#34;  	# 登录数据库查看数据库状态, 修改密码
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># show status like &#39;wsrep%&#39;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>EOF</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><code>Yum</code><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>PXC</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>
<p><!-- raw HTML omitted -->最少准备三台服务器，在三台服务器上同步执行命令<!-- raw HTML omitted --></p>
</li>
<li>
<p><!-- raw HTML omitted -->先卸载系统自带数据库，防火墙开放同步端口：<!-- raw HTML omitted -->4567<!-- raw HTML omitted --><!-- raw HTML omitted --></p>
</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;pxc-install.sh<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">yum -y remove mariadb* 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">yum install -y https://repo.percona.com/yum/percona-release-latest.noarch.rpm  	# 安装 PXC 的 Yum 源
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">yum install Percona-XtraDB-Cluster-57 -y  	# 安装 PXC 数据库
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">systemctl enable mysql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">systemctl start mysql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">pass=`grep &#34;temporary password&#34; /var/log/mysqld.log |awk &#39;{print $11}&#39;` 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">password=`openssl rand -base64 14`  	# 生成随即密码  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">mysql -uroot -p$pass -e &#34;alter user &#39;root&#39;@&#39;localhost&#39; identified by &#39;$password&#39;;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">mysql -uroot -p$password -e &#34; flush privileges;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->关闭所有节点数据库、并修改配置文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl stop mysql</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>my.cnf</code><!-- raw HTML omitted -->配置文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/my.cnf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[mysqld]  	# 必须定义
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">!includedir /etc/my.cnf.d/  	# 原有不动
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">!includedir /etc/percona-xtradb-cluster.conf.d/  	# 原有不动
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">wsrep_provider=/usr/lib64/galera3/libgalera_smm.so  	# 提供程序的路径
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">wsrep_cluster_name=pxc-cluster  	# 定义的集群名称
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">wsrep_cluster_address=gcomm://192.168.2.11,192.168.2.12,192.168.2.13  # 所有的集群节点IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">wsrep_node_name=pxc1  	# 定义本机的名字
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">wsrep_node_address=192.168.2.11  	# 定义本机IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">wsrep_sst_method=xtrabackup-v2  	# 同步方式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">wsrep_sst_auth=sstuser:password  	# 提供同步密码
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">pxc_strict_mode=ENFORCING  	# 严格模式(强制执行)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">binlog_format=ROW  	# 行格式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">default_storage_engine=InnoDB  	# 默认存储引擎
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">innodb_autoinc_lock_mode=2  	# 自增锁定模式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->先启动主节点，确保主库数据同步到其他从节点<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>wsrep_cluster_size=1</code>表示集群中只有一个节点 已经连接并且状态时<code>primary</code>随时写入数据到集群，再加入其他两个节点之前，需要创建一个SST（State Snapshot Transfer）账号用于集群间通信，必须和主机<code>my.cnf</code>配置的参数一致</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl restart mysql@bootstrap.service
</span></span><span style="display:flex;"><span>$ mysql -uroot -p$password -e <span style="color:#e6db74">&#34;show status like &#39;wsrep%&#39;;&#34;</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->添加用户并且赋予权限 <!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mysql -uroot -p$password -e <span style="color:#e6db74">&#34;CREATE USER &#39;sstuser&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;password&#39;;&#34;</span>  
</span></span><span style="display:flex;"><span>$ mysql -uroot -p$password -e <span style="color:#e6db74">&#34;GRANT RELOAD, LOCK TABLES, PROCESS, REPLICATION CLIENT ON *.* TO &#39;sstuser&#39;@&#39;localhost&#39;;&#34;</span>
</span></span><span style="display:flex;"><span>$ mysql -uroot -p$password -e <span style="color:#e6db74">&#34;FLUSH PRIVILEGES;&#34;</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->在从节点依次启动<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl start mysql</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><code>PXC</code><!-- raw HTML omitted -->导出数据库<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mysqldump -uroot -p --skip_add_locks --skip-lock-tables  LY_report  &gt; /root/LY_report<span style="color:#e6db74">`</span>date +%F<span style="color:#e6db74">`</span>.sql</span></span></code></pre></div><ul>
<li><a href="http://www.dboracle.com/archivers/%E5%BC%BA%E8%A1%8C%E5%85%B3%E6%9C%BA%E4%B9%8B%E5%90%8E%EF%BC%8Cpercona-xtradb-cluster%E9%9B%86%E7%BE%A4%E6%97%A0%E6%B3%95%E5%90%AF%E5%8A%A8.html" rel="external" target="_self">强行关机之后，<code>PERCONA XTRADB CLUSTER</code>集群无法启动</a></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->查看<!-- raw HTML omitted --><code>grastate.dat</code><!-- raw HTML omitted -->文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/var/lib/mysql/grastate.dat<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># GALERA saved state
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">version: 2.1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">uuid:    8050b2ae-5de7-11ea-b72e-1b7d1643b17c
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">seqno:   975
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">safe_to_bootstrap: 0  	# 此值大的先启动、如果都是 0，找个修改成 1 即可
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li>4.1.2 <!-- raw HTML omitted -->修改配置文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>vim /etc/percona-xtradb-cluster.conf.d/my.cnf  
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>client<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>socket<span style="color:#f92672">=</span>/var/lib/mysql/mysql.sock
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>mysql<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>prompt<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;\u@db2 \R:\m:\s [\d]&gt; &#34;</span>
</span></span><span style="display:flex;"><span>no-auto-rehash
</span></span><span style="display:flex;"><span>server-id<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>  	<span style="color:#75715e"># server-id每个服务器唯一</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 这里定义数据目录和日志目录</span>
</span></span><span style="display:flex;"><span>datadir<span style="color:#f92672">=</span>/var/lib/mysql
</span></span><span style="display:flex;"><span>socket<span style="color:#f92672">=</span>/var/lib/mysql/mysql.sock
</span></span><span style="display:flex;"><span>log-error<span style="color:#f92672">=</span>/var/log/mysqld.log
</span></span><span style="display:flex;"><span>pid-file<span style="color:#f92672">=</span>/var/run/mysqld/mysqld.pid
</span></span><span style="display:flex;"><span>log-bin <span style="color:#f92672">=</span> /var/lib/mysql/mybinlog
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>log_slave_updates
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>bind-address <span style="color:#f92672">=</span> 0.0.0.0  	<span style="color:#75715e"># 监听地址</span>
</span></span><span style="display:flex;"><span>port <span style="color:#f92672">=</span> <span style="color:#ae81ff">3306</span>  	<span style="color:#75715e"># 监听端口</span>
</span></span><span style="display:flex;"><span>default_storage_engine<span style="color:#f92672">=</span>InnoDB  	<span style="color:#75715e"># 默认数据库引擎</span>
</span></span><span style="display:flex;"><span>character-set-server <span style="color:#f92672">=</span> utf8mb4  	<span style="color:#75715e"># 字符集</span>
</span></span><span style="display:flex;"><span>collation-server <span style="color:#f92672">=</span> utf8mb4_general_ci  	<span style="color:#75715e"># 排序规则</span>
</span></span><span style="display:flex;"><span>max_connections <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span>  	<span style="color:#75715e"># 最大连接数</span>
</span></span><span style="display:flex;"><span>open_files_limit <span style="color:#f92672">=</span> <span style="color:#ae81ff">65535</span>  	<span style="color:#75715e"># 限制打开文件数</span>
</span></span><span style="display:flex;"><span>default-time-zone <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;+8:00&#39;</span>  	<span style="color:#75715e"># 默认时区</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设置数据库事务隔离级别</span>
</span></span><span style="display:flex;"><span>transaction_isolation <span style="color:#f92672">=</span> REPEATABLE-READ
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 配置超时时间</span>
</span></span><span style="display:flex;"><span>interactive_timeout <span style="color:#f92672">=</span> <span style="color:#ae81ff">600</span>
</span></span><span style="display:flex;"><span>wait_timeout <span style="color:#f92672">=</span> <span style="color:#ae81ff">600</span>
</span></span><span style="display:flex;"><span>connect_timeout <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>lock_wait_timeout <span style="color:#f92672">=</span> <span style="color:#ae81ff">3600</span>
</span></span><span style="display:flex;"><span>max_allowed_packet <span style="color:#f92672">=</span> 64M  	<span style="color:#75715e"># 限制数据库服务器接收数据包的大小</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 配置排序和join的buffer大小</span>
</span></span><span style="display:flex;"><span>sort_buffer_size <span style="color:#f92672">=</span> 4M
</span></span><span style="display:flex;"><span>join_buffer_size <span style="color:#f92672">=</span> 4M
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 配置binlog</span>
</span></span><span style="display:flex;"><span>binlog_format<span style="color:#f92672">=</span>ROW
</span></span><span style="display:flex;"><span>expire_logs_days<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 开启binlog校验功能</span>
</span></span><span style="display:flex;"><span>binlog_checksum <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>binlog_cache_size <span style="color:#f92672">=</span> 4M
</span></span><span style="display:flex;"><span>sync_binlog <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>  	<span style="color:#75715e"># 每1次提交变更后立刻将binlog落盘</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 配置performance_schema</span>
</span></span><span style="display:flex;"><span>performance_schema <span style="color:#f92672">=</span> on
</span></span><span style="display:flex;"><span>performance_schema_instrument <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;%memory%=on&#39;</span>
</span></span><span style="display:flex;"><span>performance_schema_instrument <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;%lock%=on&#39;</span>
</span></span><span style="display:flex;"><span>skip-external-locking <span style="color:#f92672">=</span> on
</span></span><span style="display:flex;"><span>skip-name-resolve <span style="color:#f92672">=</span> on  	<span style="color:#75715e"># 禁用域名解析</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 禁用软链接</span>
</span></span><span style="display:flex;"><span>symbolic-links<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>back_log <span style="color:#f92672">=</span> <span style="color:#ae81ff">1024</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 慢日志查询配置</span>
</span></span><span style="display:flex;"><span>slow_query_log <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>long_query_time <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>slow_query_log_file <span style="color:#f92672">=</span> /var/log/mysqld/slow.log
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 配置每个EVENT都要执行刷盘操作</span>
</span></span><span style="display:flex;"><span>sync_master_info <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>sync_relay_log_info <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>sync_relay_log <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>log_slave_updates <span style="color:#f92672">=</span> on
</span></span><span style="display:flex;"><span>relay_log_recovery <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>relay_log_purge <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>master_info_repository <span style="color:#f92672">=</span> TABLE
</span></span><span style="display:flex;"><span>relay_log_info_repository <span style="color:#f92672">=</span> TABLE
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># InnoDB引擎配置</span>
</span></span><span style="display:flex;"><span>innodb_file_per_table <span style="color:#f92672">=</span> on
</span></span><span style="display:flex;"><span>innodb_checksums <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>innodb_checksum_algorithm <span style="color:#f92672">=</span> crc32
</span></span><span style="display:flex;"><span>innodb_status_file <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>innodb_status_output <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>innodb_status_output_locks <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>innodb_stats_on_metadata <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>innodb_open_files <span style="color:#f92672">=</span> <span style="color:#ae81ff">65535</span>
</span></span><span style="display:flex;"><span>innodb_flush_method <span style="color:#f92672">=</span> O_DIRECT
</span></span><span style="display:flex;"><span>innodb_flush_sync <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>innodb_flush_neighbors <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 每个事务提交后立即刷新binlog文件</span>
</span></span><span style="display:flex;"><span>innodb_flush_log_at_trx_commit <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>innodb_monitor_enable<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;module_innodb&#34;</span>
</span></span><span style="display:flex;"><span>innodb_monitor_enable<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;module_server&#34;</span>
</span></span><span style="display:flex;"><span>innodb_monitor_enable<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;module_dml&#34;</span>
</span></span><span style="display:flex;"><span>innodb_monitor_enable<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;module_ddl&#34;</span>
</span></span><span style="display:flex;"><span>innodb_monitor_enable<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;module_trx&#34;</span>
</span></span><span style="display:flex;"><span>innodb_monitor_enable<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;module_os&#34;</span>
</span></span><span style="display:flex;"><span>innodb_monitor_enable<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;module_purge&#34;</span>
</span></span><span style="display:flex;"><span>innodb_monitor_enable<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;module_log&#34;</span>
</span></span><span style="display:flex;"><span>innodb_monitor_enable<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;module_lock&#34;</span>
</span></span><span style="display:flex;"><span>innodb_monitor_enable<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;module_buffer&#34;</span>
</span></span><span style="display:flex;"><span>innodb_monitor_enable<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;module_index&#34;</span>
</span></span><span style="display:flex;"><span>innodb_monitor_enable<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;module_ibuf_system&#34;</span>
</span></span><span style="display:flex;"><span>innodb_monitor_enable<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;module_buffer_page&#34;</span>
</span></span><span style="display:flex;"><span>innodb_monitor_enable<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;module_adaptive_hash&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># SQL mode配置，这里是默认值</span>
</span></span><span style="display:flex;"><span>sql_mode <span style="color:#f92672">=</span> ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># GTID配置</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#gtid_mode = on</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#enforce_gtid_consistency = 1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># wsrep配置</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># This changes how InnoDB autoincrement locks are managed and is a requirement for Galera</span>
</span></span><span style="display:flex;"><span>innodb_autoinc_lock_mode<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>wsrep_cluster_name<span style="color:#f92672">=</span>pxc-cluster  	<span style="color:#75715e"># Cluster name集群名称</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>wsrep_cluster_address<span style="color:#f92672">=</span>gcomm://10.14.23.78:4567,10.14.23.180:4567,10.14.23.181:4567
</span></span><span style="display:flex;"><span>wsrep_provider<span style="color:#f92672">=</span>/usr/lib64/galera3/libgalera_smm.so
</span></span><span style="display:flex;"><span><span style="color:#75715e">#If wsrep_node_name is not specified,  then system hostname will be used</span>
</span></span><span style="display:flex;"><span>wsrep_node_name <span style="color:#f92672">=</span> db2
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Slave thread to use</span>
</span></span><span style="display:flex;"><span>wsrep_slave_threads<span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># SST method</span>
</span></span><span style="display:flex;"><span>wsrep_sst_method<span style="color:#f92672">=</span>xtrabackup-v2
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Node IP address</span>
</span></span><span style="display:flex;"><span>wsrep_node_address <span style="color:#f92672">=</span> 10.14.23.180
</span></span><span style="display:flex;"><span>wsrep_sst_receive_address <span style="color:#f92672">=</span> 10.14.23.180
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Authentication for SST method</span>
</span></span><span style="display:flex;"><span>wsrep_sst_auth<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;sstuser:sstuser_password&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># pxc_strict_mode allowed values: DISABLED,PERMISSIVE,ENFORCING,MASTER</span>
</span></span><span style="display:flex;"><span>pxc_strict_mode<span style="color:#f92672">=</span>ENFORCING
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>mysqld_safe<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>pid-file <span style="color:#f92672">=</span> /var/run/mysqld/mysqld.pid
</span></span><span style="display:flex;"><span>socket   <span style="color:#f92672">=</span> /var/lib/mysql/mysql.sock
</span></span><span style="display:flex;"><span>nice     <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>EOF</span></span></code></pre></div></blockquote>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_mysql_router">Install_MySQL_Router</h1>

<h2 id="mysql-router"><code>MySQL Router</code></h2>
<blockquote>
<ul>
<li><code>MySQL Router</code>是<code>MySQL</code>官方提供的路由器和负载均衡器</li>
<li>支持基于轮询或自动检测到的服务器状态的负载均衡，可以将读写请求路由到不同的<code>MySQL</code>服务器</li>
<li><code>MySQL Router</code>提供了简单的配置和管理接口，适合<code>MySQL</code>官方产品的环境</li>
<li><a href="https://dev.mysql.com/doc/mysql-router/8.0/en/" rel="external" target="_self"><code>MySQL Router</code></a></li>
</ul>
</blockquote>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_maxscale">Install_MaxScale</h1>

<h2 id="maxscale轻量级数据库代理"><code>MaxScale轻量级</code>数据库代理</h2>
<blockquote>
<ul>
<li><code>MaxScale</code>是<code>MariaDB</code>开发的一个轻量级的数据库代理和路由器</li>
<li>支持高级的查询路由和负载均衡功能，包括读写分离、故障切换和高可用性</li>
<li><code>MaxScale</code>提供了丰富的插件和模块化架构，可以轻松扩展其功能</li>
<li><a href="https://mariadb.com/kb/en/maxscale/" rel="external" target="_self"><code>MaxScale</code></a></li>
</ul>
</blockquote>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_proxysql">Install_ProxySQL</h1>

<h2 id="proxysql代理"><code>ProxySQL</code>代理</h2>
<blockquote>
<ul>
<li><code>ProxySQL</code>是一个高性能的<code>MySQL</code>代理，支持数据库连接池、查询缓存、负载均衡和读写分离</li>
<li>它可以根据<code>SQL</code>查询类型（读或写）将请求路由到不同的<code>MySQL</code>服务器</li>
<li><code>ProxySQL</code>提供了丰富的配置选项，可以根据需求调整负载均衡策略和连接池管理</li>
<li><a href="https://proxysql.com/" rel="external" target="_self"><code>ProxySQL</code></a></li>
</ul>
</blockquote>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_manticore_search">Install_Manticore_Search</h1>

<h2 id="manticoresearch"><code>manticoresearch</code></h2>
<blockquote>
<ul>
<li>易于使用的开源快速搜索数据库.</li>
<li><a href="https://manticoresearch.com/" rel="external" target="_self"><code>Manticore Search</code></a></li>
</ul>
</blockquote>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_canal">Install_Canal</h1>

<h2 id="canal数据库增量日志解析"><code>Canal</code>数据库增量日志解析</h2>
<blockquote>
<ul>
<li><a href="https://github.com/alibaba/canal" rel="external" target="_self"><code>Canal</code></a></li>
</ul>
</blockquote>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="use_mysql">Use_Mysql</h1>

<h1 id="数据库使用">数据库使用</h1>
<h2 id="数据结构可视化">数据结构可视化</h2>
<blockquote>
<ul>
<li><a href="https://www.cs.usfca.edu/~galles/visualization/" rel="external" target="_self">数据结构可视化</a></li>
</ul>
</blockquote>
<hr>
<h2 id="数据库连接工具">数据库连接工具</h2>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://downloads.mysql.com/archives/workbench/" rel="external" target="_self"><code>WorkBenCh</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://downloads.mysql.com/archives/community/" rel="external" target="_self"><code>MySQL</code>产品档案</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://mirrors.cloud.tencent.com/mysql/downloads/MySQL-8.0/" rel="external" target="_self">下载<code>MySQL-8.0</code>的索引</a></td>
<td></td>
</tr>
<tr>
<td><a href="http://www.notedeep.com/page/282" rel="external" target="_self"><code>Mysql</code>深入学习笔记</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://sqlyog.softonic.cn/" rel="external" target="_self"><code>SQLyog</code>数据库客户端连接工具</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://dbeaver.io/download/" rel="external" target="_self"><code>DBeaver</code>数据库客户端连接工具</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/pifeifei/mysql-workbench-zh-cn" rel="external" target="_self"><code>Mysql WorkBenCh</code>菜单中文汉化</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.jianshu.com/p/4113cd5ef139" rel="external" target="_self"><code>Navicat Premium 15</code>安装与激活</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://learnku.com/articles/67706" rel="external" target="_self"><code>Navicat Premium 16</code>下载与安装破解教程</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/8.0/en/binary-installation.html" rel="external" target="_self">使用通用二进制文件在<code>Unix/Linux </code>安装<code>MySQL</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.jianshu.com/p/523c132006aa" rel="external" target="_self"><code>Navicat Premium 15</code>永久破解激活工具及安装教程</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://atlasgo.io/declarative/inspect" rel="external" target="_self"><code>Atlas</code>阿特拉斯</a></td>
<td><code>Atlas</code>是一款独立于语言的工具，使用现代<code>DevOps</code>原则管理和迁移数据库架构</td>
</tr>
<tr>
<td><a href="https://github.com/ariga/atlas" rel="external" target="_self"><code>Atlas_Github</code></a></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h2 id="数据库常用命令">数据库常用命令</h2>
<blockquote>
<table>
<thead>
<tr>
<th>数据库命令</th>
<th>说明</th>
<th>举例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>select</code></td>
<td>从数据库中提取数据</td>
<td>查看用户数据：<code>select user,host from mysql.user \G;</code></td>
</tr>
<tr>
<td><code>update</code></td>
<td>更新数据库中的数据</td>
<td></td>
</tr>
<tr>
<td><code>delete</code></td>
<td>从数据库中删除数据</td>
<td></td>
</tr>
<tr>
<td><code>insert into</code></td>
<td>向数据库中插入数据</td>
<td>插入数据：<code>insert into tiantian.tt1 values(1,'lisi');</code></td>
</tr>
<tr>
<td><code>create database</code></td>
<td>创建新数据库</td>
<td>创建数据库：<code>create database tiantian;</code></td>
</tr>
<tr>
<td><code>alter database</code></td>
<td>更改数据库</td>
<td></td>
</tr>
<tr>
<td><code>create table</code></td>
<td>创建表</td>
<td>创建数据表：<code>create table tiantian.tt1(id int, name varchar(50));</code></td>
</tr>
<tr>
<td><code>alter table</code></td>
<td>更改表</td>
<td></td>
</tr>
<tr>
<td><code>drop table</code></td>
<td>删除表</td>
<td></td>
</tr>
<tr>
<td><code>create index</code></td>
<td>创建索引(搜索键)</td>
<td></td>
</tr>
<tr>
<td><code>drop index</code></td>
<td>删除索引</td>
<td></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th><code>Where</code>语句中的运算符</th>
<th>说明</th>
<th>举例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>=</code></td>
<td>等于</td>
<td></td>
</tr>
<tr>
<td><code>&lt;&gt;</code></td>
<td>不等于：在<code>SQL</code>的一些版本中，改操作符被写成<code>!=</code></td>
<td></td>
</tr>
<tr>
<td><code>&gt;</code></td>
<td>大于</td>
<td></td>
</tr>
<tr>
<td><code>&lt;</code></td>
<td>小于</td>
<td></td>
</tr>
<tr>
<td><code>&gt;=</code></td>
<td>大于等于</td>
<td></td>
</tr>
<tr>
<td><code>&lt;=</code></td>
<td>小于等于</td>
<td></td>
</tr>
<tr>
<td><code>BETWEEN</code></td>
<td>在某个范围内</td>
<td></td>
</tr>
<tr>
<td><code>LIKE</code></td>
<td>搜索某种模式</td>
<td></td>
</tr>
<tr>
<td><code>IN</code></td>
<td>指定针对某个列的多个可能值</td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h3 id="查询连接数">查询连接数</h3>
<blockquote>
<ul>
<li>
<!-- raw HTML omitted -->
</li>
<li><strong>查看当前活动线程状态</strong></li>
</ul>
<blockquote>
<ul>
<li><code>Threads_cached</code><!-- raw HTML omitted -->缓存的线程数量，这些线程处于睡眠状态以备复用<!-- raw HTML omitted --></li>
<li><code>Threads_connected</code><!-- raw HTML omitted -->当前打开的连接数<!-- raw HTML omitted --></li>
<li><code>Threads_created</code><!-- raw HTML omitted -->为处理连接而创建的线程数<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> status <span style="color:#66d9ef">like</span>  <span style="color:#e6db74">&#39;Threads%&#39;</span>; </span></span></code></pre></div><ul>
<li>如果<code>Threads_created</code>很大，您可能需要增加<code>thread_cache_size</code>的值。缓存失误率可以通过<code>Threads_created/Connections</code>计算</li>
</ul>
</blockquote>
<ul>
<li><strong>显示用户正在运行的线程</strong></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> full processlist;</span></span></code></pre></div></blockquote>
<ul>
<li><strong>查看最大链接数</strong></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> variables <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;%max_connections%&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 临时增加连接数，配置文件增加参数：max_connections=4000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">set</span> GLOBAL max_connections<span style="color:#f92672">=</span><span style="color:#ae81ff">4000</span>;</span></span></code></pre></div></blockquote>
<ul>
<li><strong>查看连接的用户和</strong><code>IP</code><strong>以及超时时间</strong></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#75715e"># 查看连接的用户和IP以及超时时间，或者使用：count(*) 统计总统连接数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> information_schema.processlist;</span></span></code></pre></div></blockquote>
<ul>
<li><strong>看连接的用户和每个</strong><code>IP</code><strong>的连接总数地址</strong></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span> <span style="color:#a6e22e">substring_index</span>(host, <span style="color:#e6db74">&#39;:&#39;</span>,<span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">AS</span> host_ip,<span style="color:#f92672">`</span><span style="color:#66d9ef">user</span><span style="color:#f92672">`</span>,db,state,<span style="color:#a6e22e">count</span>(<span style="color:#f92672">*</span>) <span style="color:#66d9ef">FROM</span> information_schema.processlist <span style="color:#66d9ef">GROUP</span> <span style="color:#66d9ef">BY</span> state,host_ip,<span style="color:#f92672">`</span><span style="color:#66d9ef">user</span><span style="color:#f92672">`</span>,db;</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="查询慢语句">查询慢语句</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#75715e"># 查询占用超时慢语句
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> information_schema.processlist <span style="color:#66d9ef">where</span> Command <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;Sleep&#39;</span> <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> <span style="color:#66d9ef">Time</span> <span style="color:#66d9ef">desc</span> <span style="color:#960050;background-color:#1e0010">\</span>G;</span></span></code></pre></div></blockquote>
<hr>
<h3 id="三种修改密码方式">三种修改密码方式</h3>
<blockquote>
<ul>
<li><strong>第一种修改方式，</strong><code>8.0</code><strong>用此方法</strong></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">alter</span> <span style="color:#66d9ef">user</span> <span style="color:#e6db74">&#39;root&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;localhost&#39;</span> <span style="color:#66d9ef">identified</span> <span style="color:#66d9ef">by</span> <span style="color:#e6db74">&#39;123&#39;</span>;
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">alter</span> <span style="color:#66d9ef">user</span> <span style="color:#e6db74">&#39;root&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;localhost&#39;</span> <span style="color:#66d9ef">identified</span> <span style="color:#66d9ef">with</span> mysql_native_password <span style="color:#66d9ef">by</span> <span style="color:#e6db74">&#39;newpassword&#39;</span>;</span></span></code></pre></div></blockquote>
<ul>
<li><strong>第二种修改方式</strong></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">set</span> password <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#39;root&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;localhost&#39;</span><span style="color:#f92672">=</span><span style="color:#a6e22e">password</span>(<span style="color:#e6db74">&#39;newpassword&#39;</span>);</span></span></code></pre></div></blockquote>
<ul>
<li><strong>第三种修改方式</strong></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">update</span> mysql.<span style="color:#66d9ef">user</span> <span style="color:#66d9ef">set</span> authentication_string<span style="color:#f92672">=</span><span style="color:#a6e22e">password</span>(<span style="color:#e6db74">&#39;123qwe&#39;</span>) <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">user</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;root&#39;</span> <span style="color:#66d9ef">and</span> Host <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;localhost&#39;</span>; </span></span></code></pre></div></blockquote>
<ul>
<li><strong>更改密码为</strong><code>123456</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">update</span> destoon_member <span style="color:#66d9ef">set</span> password<span style="color:#f92672">=</span><span style="color:#960050;background-color:#1e0010">’</span><span style="color:#ae81ff">14</span>e1b600b1fd579f47433b88e8d85291<span style="color:#960050;background-color:#1e0010">′</span> <span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>username<span style="color:#f92672">=</span><span style="color:#960050;background-color:#1e0010">’</span>admin<span style="color:#960050;background-color:#1e0010">’</span>;</span></span></code></pre></div></blockquote>
<ul>
<li><strong>忘记数据库密码</strong></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> cat <span style="color:#f92672">&gt;/</span>etc<span style="color:#f92672">/</span>my.cnf<span style="color:#f92672">&lt;&lt;-</span>EOF
</span></span><span style="display:flex;"><span>[mysqld]  	<span style="color:#75715e"># 在配置文件中最上面添加
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>skip<span style="color:#f92672">-</span><span style="color:#66d9ef">grant</span><span style="color:#f92672">-</span><span style="color:#66d9ef">tables</span>
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 重启mysql服务  直接使用 mysql -uroot -p 不输入密码直接回车进入 修改密码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">update</span> <span style="color:#66d9ef">user</span> <span style="color:#66d9ef">set</span> authentication_string<span style="color:#f92672">=</span><span style="color:#a6e22e">password</span>(<span style="color:#e6db74">&#39;root&#39;</span>);</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="数据库备份还原">数据库备份、还原</h3>
<h4 id="备份">备份</h4>
<ul>
<li>
<ol>
<li><strong>使用<code>mysqldump</code>备份数据库</strong></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><strong>手动备份</strong></li>
</ul>
<blockquote>
<ul>
<li><code>--all-databases</code><!-- raw HTML omitted -->备份所有数据库<!-- raw HTML omitted --></li>
<li><code>-B, --databases</code><!-- raw HTML omitted -->备份时指定数据库<!-- raw HTML omitted --></li>
<li><code>--tables</code><!-- raw HTML omitted -->备份时指定数据表<!-- raw HTML omitted --></li>
<li><code> --triggers</code><!-- raw HTML omitted -->在备份时包括触发器<!-- raw HTML omitted --></li>
<li><code>--routines</code><!-- raw HTML omitted -->在备份时包括存储过程<!-- raw HTML omitted --></li>
<li><code>--events</code><!-- raw HTML omitted -->在备份时包括事件<!-- raw HTML omitted --></li>
<li><code>-S, --socket</code><!-- raw HTML omitted -->服务器通信时要使用的套接字文件<!-- raw HTML omitted --></li>
<li><code>--flush-logs</code>参数用于在备份之前刷新<code>MySQL</code>的二进制日志，确保备份包含最新的数据更新</li>
<li><code>--skip-lock-tables</code>参数允许在导出<code>MySQL</code>数据库表时跳过对表的锁定操作，适用于需要最小化数据库停机时间或对导出过程影响较小的情况</li>
<li><code>--lock-tables=false</code><!-- raw HTML omitted -->：默认情况下，<!-- raw HTML omitted --><code>mysqldump</code> <!-- raw HTML omitted -->会锁定表，以确保备份的一致性。如果你不需要锁定表，可以使用<!-- raw HTML omitted --><code>--lock-tables=false</code><!-- raw HTML omitted -->参数<!-- raw HTML omitted --></li>
<li><code>--column-statistics=0</code><!-- raw HTML omitted -->：禁用统计信息，在<!-- raw HTML omitted --><code>MySQL8</code><!-- raw HTML omitted -->默认情况下，尝试收集每个列的统计信息，这些统计信息包括每个列的最大值、最小值、平均值和标准差等，以便优化查询计划和执行<!-- raw HTML omitted --></li>
<li><code>--no-autocommit</code> 参数禁用自动提交模式，在备份过程中使用事务来确保备份的一致性，并减少对数据库的锁定时间。</li>
<li><code>--master-data</code> 参数在备份输出中包含二进制日志文件名和位置信息，对于主从复制环境中的数据库恢复尤其有用</li>
<li><code>--single-transaction</code> 参数用于使用单个事务进行备份，适用于 InnoDB 存储引擎，避免了备份期间的锁表操作。</li>
<li><code>--set-gtid-purged=OFF</code><!-- raw HTML omitted -->：如果源库开启了<!-- raw HTML omitted --><code>GTID</code><!-- raw HTML omitted -->特性，使用<!-- raw HTML omitted --><code>mysqldump</code><!-- raw HTML omitted -->导出数据时，存在需要<!-- raw HTML omitted --><code>super</code><!-- raw HTML omitted -->权限执行的语句：<!-- raw HTML omitted --><code>SET @@SESSION.SQL_LOG_BIN= 0;</code>，<code>SET @@GLOBAL.GTID_PURGED=´18f9a804-343b-11e5-a21d-b083fed01601:1-2;</code></li>
<li><strong>备份用户权限</strong></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">GRANT</span> <span style="color:#66d9ef">SELECT</span>,RELOAD,<span style="color:#66d9ef">LOCK</span> <span style="color:#66d9ef">TABLES</span>,REPLICATION CLIENT,<span style="color:#66d9ef">SHOW</span> VIEW,EVENT,<span style="color:#66d9ef">TRIGGER</span>,PROCESS <span style="color:#66d9ef">ON</span> <span style="color:#f92672">*</span>.<span style="color:#f92672">*</span> <span style="color:#66d9ef">TO</span> <span style="color:#e6db74">&#39;backup&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;localhost&#39;</span> <span style="color:#66d9ef">identified</span> <span style="color:#66d9ef">BY</span> <span style="color:#e6db74">&#39;passwoord&#39;</span>;</span></span></code></pre></div></blockquote>
<ul>
<li><strong>备份多个数据库</strong></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /bin/mysql -u root -p<span style="color:#e6db74">&#39;password&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-S /tmp/mysqld.sock  -e <span style="color:#e6db74">&#39;show databases;&#39;</span>| <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>grep -E -v <span style="color:#e6db74">&#34;sys|mysql|information_schema|performance_schema|Database&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>|grep -E <span style="color:#e6db74">&#34;.*datebases1</span>$<span style="color:#e6db74">|.*datebases2</span>$<span style="color:#e6db74">&#34;</span> | <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>xargs /bin/mysqldump -u root -p<span style="color:#e6db74">&#39;password&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-S /tmp/mysqld.sock <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--single-transaction --no-autocommit <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--master-data<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> --skip-lock-tables --databases &gt;<span style="color:#e6db74">`</span>date +%F<span style="color:#e6db74">`</span>-datebases_name.sql</span></span></code></pre></div></blockquote>
<ul>
<li><strong>导出全部库</strong></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mysqldump -uroot -p<span style="color:#e6db74">&#39;passowrd&#39;</span> --all-databases &gt; /tmp/all_databases.sql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ /usr/local/mysql/bin/mysqldump -u root -p<span style="color:#e6db74">&#39;passowrd&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-S /tmp/mysqld.sock <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--all-databases --lock-tables<span style="color:#f92672">=</span>false <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--routines --single_transaction --flush-logs <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--skip-lock-tables --master-data<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>| gzip &gt;/tmp/mysql-all-<span style="color:#e6db74">`</span>date +%F_%H%M%S<span style="color:#e6db74">`</span>.sql.gz </span></span></code></pre></div></blockquote>
<ul>
<li><strong>导出单个库</strong></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mysqldump -uroot -p --databases databases_name &gt; /tmp/databases_name.sql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ /bin/mysqldump -uroot -p<span style="color:#e6db74">&#39;passowrd&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--set-gtid-purged<span style="color:#f92672">=</span>OFF --single-transaction <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--master-data<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> --flush-logs <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-S /tmp/mysqld.sock <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--databases database_name | gzip &gt;/tmp/database<span style="color:#e6db74">`</span>date +%F_%H%M%S<span style="color:#e6db74">`</span>.sql.gz</span></span></code></pre></div></blockquote>
<ul>
<li><strong>导出指定表</strong></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mysqldump -uroot -p --databases databases_name --tables tables_name &gt; /tmp/databases_name_tables_name.sql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ bin/mysql -u root -p<span style="color:#e6db74">&#39;password&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-S /tmp/mysqld.sock <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-e <span style="color:#e6db74">&#39;select table_name from information_schema.tables where table_schema like &#34;game\-center\_ali&#34;;&#39;</span>|egrep <span style="color:#e6db74">&#34;.*record&#34;</span> | xargs /bin/mysqldump -u root -p<span style="color:#e6db74">&#39;password&#39;</span> -S /tmp/mysqld.sock  --databases databases_name --tables tables_name &gt;/tmp/tables_name.sql</span></span></code></pre></div></blockquote>
<ul>
<li><strong>导出表结构加<code>-d</code>参数</strong></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /bin/mysqldump -d -uroot -p<span style="color:#e6db74">&#39;passowrd&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-S /opt/data/data_3306/mysql.sock --databases database_name &gt; database_name.sql</span></span></code></pre></div></blockquote>
</blockquote>
<ul>
<li><strong>使用<code>Mysql</code>脚本备份并通知<code>Telegram</code></strong></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/script/Backup_Mysql.sh<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DATA=$(date +%F_%H%M%S)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## set ff=unix # 修改换行符
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 定义备份目录
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MYSQL_BACKUP_PATH=/opt/backup/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 定义Telegram 机器人ID和报警组
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">TELEGRAM_BOT_ID=&#39;Telegram BOT_ID:BOT_Key&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">TELEGRAM_GROUP_ID=&#39;GROUP_ID&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 定义连接数据库 账户密码IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">USER_NAME=&#39;backup&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">USER_PASSWORD=&#39;pass&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DATABASES=&#39;databases name&#39;  	# 备份表用
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">USER_HOST_1=&#39;IP_1&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">USER_HOST_2=&#39;IP_2&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 过滤数据库, xargs和sed &#39;1d&#39;效果一样
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DATABASES_1=`/bin/mysql -u${USER_NAME} -p&#34;${USER_PASSWORD}&#34; -h&#34;${USER_HOST_1}&#34; -e &#39;show databases;&#39; | grep -E -v &#34;sys|mysql|information_schema|performance_schema|Database&#34; | /bin/xargs`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## DATABASES_2=`/bin/mysql -u${USER_NAME} -p&#34;${USER_PASSWORD}&#34; -h&#34;${USER_HOST_2}&#34; -e &#39;show databases;&#39; | grep -E -v &#34;sys|mysql|information_schema|performance_schema|Database&#34; | sed &#39;1d&#39;`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 检测备份目录是否存在，不存在就创建
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## /bin/test -d /opt/backup
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">function TEST_BACKUP_DIR() {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if [ ! -d ${MYSQL_BACKUP_PATH} ];then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	/bin/mkdir -p ${MYSQL_BACKUP_PATH}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 开始准备备份数据库
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">cd ${MYSQL_BACKUP_PATH}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/bin/curl -X POST &#34;https://api.telegram.org/bot${TELEGRAM_BOT_ID}/sendMessage&#34; -d &#34;chat_id=${TELEGRAM_GROUP_ID}&amp;text=开始备份：${DATABASES_1} ${DATABASES_2} 数据库&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">for i in ${DATABASES_1};do
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	/usr/local/mysql/bin/mysqldump -u${USER_NAME} -p&#34;${USER_PASSWORD}&#34; -h${USER_HOST_1} --single-transaction --no-autocommit --master-data=1 --skip-lock-tables ${i} &gt; ${MYSQL_BACKUP_PATH}${i}-`date +%F`.sql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">done
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if [ $? -eq 0 ];then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> /bin/tar -zcvf ${MYSQL_BACKUP_PATH}${i}-`date +%F`.tar.gz ${i}-`date +%F`.sql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	/bin/curl -X POST &#34;https://api.telegram.org/bot${TELEGRAM_BOT_ID}/sendMessage&#34; -d &#34;chat_id=${TELEGRAM_GROUP_ID}&amp;text=${DATABASES_1} ${DATABASES_2} 数据库备份完成&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">else
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	/bin/curl -X POST &#34;https://api.telegram.org/bot${TELEGRAM_BOT_ID}/sendMessage&#34; -d &#34;chat_id=${TELEGRAM_GROUP_ID}&amp;text=${DATABASES_1} ${DATABASES_2} 数据库备份失败&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/bin/rm -rf ${MYSQL_BACKUP_PATH}*.sql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 备份数据表
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">function BACKUP_MYSQL_TABLES() {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	cd ${MYSQL_BACKUP_PATH}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	for DATABASES in ${DATABASES_1};do
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	TABLES_1=$(/bin/mysql -u${USER_NAME} -p&#34;${USER_PASSWORD}&#34; -h&#34;${USER_HOST_1}&#34; ${DATABASES} -e &#34;show tables;&#34;|sed &#39;1d&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		for I in ${TABLES_1};do
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			/usr/local/mysql/bin/mysqldump -u${USER_NAME} -p&#34;${USER_PASSWORD}&#34; -h${USER_HOST_1} --single-transaction --no-autocommit --master-data=1 --skip-lock-tables ${I} &gt; ${MYSQL_BACKUP_PATH}${i}-`date +%F`.sql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		done
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		/bin/tar -zcvf ${MYSQL_BACKUP_PATH}${DATABASES}-`date +%F`.tar.gz *.sql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		/bin/rm -rf ${MYSQL_BACKUP_PATH}*.sql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	done	
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	if [ $? -eq 0 ];then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		/bin/curl -X POST &#34;https://api.telegram.org/bot${TELEGRAM_BOT_ID}/sendMessage&#34; -d &#34;chat_id=${TELEGRAM_GROUP_ID}&amp;text=${DATABASES_1} ${DATABASES_2} 数据库备份完成&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	else
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		/bin/curl -X POST &#34;https://api.telegram.org/bot${TELEGRAM_BOT_ID}/sendMessage&#34; -d &#34;chat_id=${TELEGRAM_GROUP_ID}&amp;text=${DATABASES_1} ${DATABASES_2} 数据库备份失败&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/bin/find ${MYSQL_BACKUP_PATH} -name &#34;databases-*&#34; -mtime +15 -exec  rm  {} \;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h4 id="还原">还原</h4>
<blockquote>
<ul>
<li><strong>数据库还原、导入</strong></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 第一种方式</span>
</span></span><span style="display:flex;"><span>$ /bin/mysql -u root -p<span style="color:#e6db74">&#39;passowrd&#39;</span> -S /opt/data/data_16303/mysql.sock &lt; /root/all.sql  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 第二种方式  </span>
</span></span><span style="display:flex;"><span>mysql&gt; use mysql;
</span></span><span style="display:flex;"><span>mysql&gt; source /root/databases.sql  	<span style="color:#75715e"># 当前目录绝对路径</span></span></span></code></pre></div></blockquote>
<ul>
<li><code>.qp</code><strong>文件数据库恢复</strong></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ xbstream -x -p <span style="color:#ae81ff">4</span> &lt; ./databases.qp -C /opt/mysql/backup</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h4 id="使用percona备份工具">使用<code>percona</code>备份工具</h4>
<blockquote>
<ul>
<li><a href="https://segmentfault.com/a/1190000019305858" rel="external" target="_self"><code>Linux</code>运维 <code>mysql</code>数据库的备份与恢复</a></li>
<li><a href="https://cloud.tencent.com/developer/article/1119183" rel="external" target="_self"><code>innobackupex</code>备份恢复<code>+</code>增量备份与恢复</a></li>
<li><code>innobackupex</code>：更多高级管理功能和自动化备份脚本</li>
<li><code>xtrabackup</code>：需要基本的物理备份和恢复功能，并且愿意手动管理备份流程</li>
<li>安装<a href="https://www.percona.com/software/mysql-database/percona-xtrabackup" rel="external" target="_self"><code>XtraBackup</code></a></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 添加yum源</span>
</span></span><span style="display:flex;"><span>$ wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-6.repo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装依赖包</span>
</span></span><span style="display:flex;"><span>$ yum -y install perl perl-devel libaio libaio-devel perl-Time-HiRes perl-DBD-MySQL
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 下载rpm包</span>
</span></span><span style="display:flex;"><span>$ wget https://downloads.percona.com/downloads/Percona-XtraBackup-2.4/Percona-XtraBackup-2.4.27/binary/redhat/7/x86_64/percona-xtrabackup-24-2.4.27-1.el7.x86_64.rpm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装</span>
</span></span><span style="display:flex;"><span>$ yum -y install percona-xtrabackup-24-2.4.27-1.el7.x86_64.rpm</span></span></code></pre></div></blockquote>
<ul>
<li><strong>手动备份</strong></li>
</ul>
<blockquote>
<ul>
<li><strong>完整以及增量备份</strong></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 完整备份</span>
</span></span><span style="display:flex;"><span>$ innobackupex --host<span style="color:#f92672">=</span>IP --user<span style="color:#f92672">=</span>name --password<span style="color:#f92672">=</span><span style="color:#ae81ff">123456</span> --prot<span style="color:#f92672">=</span><span style="color:#ae81ff">3306</span> --no-timestamp /opt/backup/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 增量备份  基于全量备份实现增量备份，增量备份只支持Innodb</span>
</span></span><span style="display:flex;"><span>$ innobackupex --host<span style="color:#f92672">=</span>IP --user<span style="color:#f92672">=</span>root --password<span style="color:#f92672">=</span><span style="color:#ae81ff">123456</span> --prot<span style="color:#f92672">=</span><span style="color:#ae81ff">3306</span> --no-timestamp --incremental /opt/backup/ --incremental-basedir<span style="color:#f92672">=</span>/opt/backup/<span style="color:#66d9ef">$(</span>date +%F_%T<span style="color:#66d9ef">)</span></span></span></code></pre></div></blockquote>
<ul>
<li><strong>数据库恢复流程</strong></li>
</ul>
<blockquote>
<ul>
<li><code>--decompress</code><!-- raw HTML omitted -->该选项表示解压<!-- raw HTML omitted --><code>--compress</code><!-- raw HTML omitted -->选项压缩文件<!-- raw HTML omitted --></li>
<li><code>--parallel</code><!-- raw HTML omitted -->该选项表示允许多个文件同时解压。为了解压，<!-- raw HTML omitted --><code>qpress</code><!-- raw HTML omitted -->工具必须有安装并且访问这个文件的权限。这个进程将在同一个位置移除原来的压缩/加密文件<!-- raw HTML omitted --></li>
<li><code>--apply-log</code><!-- raw HTML omitted -->该选项表示同<!-- raw HTML omitted --><code>xtrabackup</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>--prepare</code><!-- raw HTML omitted -->参数,一般情况下,在备份完成后，数据尚且不能用于恢复操作，因为备份的数据中可能会包含尚未提交的事务或已经提交但尚未同步至数据文件中的事务。因此，此时数据 文件仍处理不一致状态<!-- raw HTML omitted --></li>
<li><code>--apply-log</code><!-- raw HTML omitted -->的作用是通过回滚未提交的事务及同步已经提交的事务至数据文件使数据文件处于一致性状态<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 1.拷贝备份到data3306(只拷贝日期文件夹下面的文件)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2.cd /opt/data3306</span>
</span></span><span style="display:flex;"><span>$ innobackupex --defaults-file<span style="color:#f92672">=</span>/opt/conf/my_3306.cnf --decompress --parallel<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span> ./
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3.删除所有.qp文件</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 4.恢复数据库(全量)</span>
</span></span><span style="display:flex;"><span>$ cd /opt/data3306
</span></span><span style="display:flex;"><span>$ innobackupex --defaults-file<span style="color:#f92672">=</span>/opt/conf/my_3306.cnf --apply-log  --use-memory<span style="color:#f92672">=</span>4G ./</span></span></code></pre></div></blockquote>
<ul>
<li><strong>手动恢复</strong></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ service mysql stop
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 初始化全量备份</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ innobackupex --apply-log --redo-only /opt/backup/ --incremental-dir<span style="color:#f92672">=</span>/opt/backup/<span style="color:#66d9ef">$(</span>date +%F_%T<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 初始化整合增量备份</span>
</span></span><span style="display:flex;"><span>$ innobackupex --apply-log --redo-only /data/backup/2017-08-24_22-57-43 --incremental-dir<span style="color:#f92672">=</span>/data/backup/2017-08-24_23-10-21
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 把整合好的增量再次初始化</span>
</span></span><span style="display:flex;"><span>$ innobackupex --apply-log  /data/backup/2017-08-24_22-57-43
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 备份MySQL下data数据目录要恢复的数据库</span>
</span></span><span style="display:flex;"><span>$ mv  /usr/local/mysql/data/ceshi/  /opt/backup/<span style="color:#66d9ef">$(</span>date +%F_%T<span style="color:#66d9ef">)</span>/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 把整合后的全量备份目录下要恢复的数据库复制到MySQL下data目录</span>
</span></span><span style="display:flex;"><span>$ cp -a  /opt/backup/quanliang/ceshi /usr/local/mysql/data/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 重新赋予属组mysql权限</span>
</span></span><span style="display:flex;"><span>$ chown -R mysql.mysql   /usr/local/mysql/data/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动数据库</span>
</span></span><span style="display:flex;"><span>$ service mysql start</span></span></code></pre></div></blockquote>
<ul>
<li><strong>使用<code>--copy</code>参数实现备份恢复</strong></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ service mysql stop
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 把data数据目录下数据进行备份</span>
</span></span><span style="display:flex;"><span>$ cp -a  /usr/local/mysql/data/* /opt/backup/<span style="color:#66d9ef">$(</span>date +%F_%T<span style="color:#66d9ef">)</span>/
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 把要恢复的数据备份生成</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ innobackupex  --apply-log --redo-only /opt/backup/quanliang/ceshi_danku/  	<span style="color:#75715e"># 这个是单库备份目录</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># data目录必须为空</span>
</span></span><span style="display:flex;"><span>$ innobackupex  --copy-back /opt/backup/quanliang/ceshi_danku/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 重新赋予属组权限</span>
</span></span><span style="display:flex;"><span>$ chown -R mysql.mysql /usr/local/mysql/data/
</span></span><span style="display:flex;"><span>$ service mysql start</span></span></code></pre></div></blockquote>
<ul>
<li><strong>使用<code>Mysql</code>脚本备份并通知钉钉接口</strong></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/script/Backup_Mysql_innobackupex.sh<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## ***************************************************************#
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##  Create: DBA
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## ***************************************************************#
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## echo `hostname -I` |sed &#39;s/ /#/g&#39; -  &gt;/tmp/ipaddr.txt
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 定义Telegram 机器人ID和报警组
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">TELEGRAM_BOT_ID=&#39;Telegram bot_id:bot_key&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">TELEGRAM_GROUP_ID=&#39;GROUP_ID&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">IP_ADDRE=$(hostname -I |awk &#39;{print $1}&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">USER_NAME=&#39;backup&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">USER_PASSWORD=&#39;IvV8BhpvHb/7EA==&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DATABASES=&#39;databases name&#39; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">backup_time=`date +&#39;%Y%m%d%m&#39;`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">backup_base=&#34;/opt/backup/dbback&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">backup_dir=&#34;$backup_base/full&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">backup_log=&#34;$backup_base/log/xtra_${backup_time}.log&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">slave_days=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 钉钉接口
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">function SendToDingding_error(){
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> #Dingding_Url=&#34;https://oapi.dingtalk.com/robot/send?access_token=d5201a579163dc6045b6da6d8dbc1cdc1d935698050971ceddb5a8956e9507ee&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> Dingding_Url=&#34;https://api.telegram.org/bot${TELEGRAM_BOT_ID}/sendMessage?chat_id=${TELEGRAM_GROUP_ID}&amp;text=%22${IP_ADDRE}mysqlbak%20failure!Please check %22&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # 发送钉钉消息
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> curl &#34;${Dingding_Url}&#34; -H &#39;Content-Type: application/json&#39; -d &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     \&#34;actionCard\&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         \&#34;title\&#34;: \&#34;$1\&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         \&#34;text\&#34;: \&#34;$2\&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         \&#34;hideAvatar\&#34;: \&#34;0\&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         \&#34;btnOrientation\&#34;: \&#34;0\&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         \&#34;btns\&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">             {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                 \&#34;title\&#34;: \&#34;$1\&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                 \&#34;actionURL\&#34;: \&#34;\&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">             }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     \&#34;msgtype\&#34;: \&#34;actionCard\&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> }&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 安装备份工具 innobackupex 或 xtrabackup
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if [ ! -x /usr/bin/innobackupex ];then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     yum -y install  http://www.percona.com/downloads/percona-release/redhat/0.1-4/percona-release-0.1-4.noarch.rpm
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     yum -y install percona-xtrabackup-24 qpress
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 开始创建目录
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if [ ! -d ${backup_dir} ];then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> mkdir -p ${backup_dir}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if [ ! -d ${backup_base}/log ];then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> mkdir -p ${backup_base}/log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">start_time=`date +&#39;%Y%m%d_%H:%M:%S&#39;`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">start_file=`date +&#39;%Y-%m-%d_%H-%M-%S&#39;`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 开始备份数据库
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo -e &#34;`date +&#39;%Y-%m-%d %H:%M:%S&#39;` 开始物理备份数据库 ${ipaddr} ...&#34; &gt;&gt; ${backup_log}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/usr/bin/innobackupex --defaults-file=/opt/conf/my_16303.cnf --user=${backup_user} --password=${backup_password} --host=&#39;localhost&#39; --socket=/opt/data/data_16303/mysql.sock --use-memory=1G --compress --compress-threads=32 --parallel=3 --slave-info ${backup_dir} 2&gt;&gt;${backup_log}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if [ $? -ne 0 ];then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> echo -e &#34;`date +&#39;%Y%m%d_%H:%M:%S&#39;` 备份数据库发生错误,具体看日志&#34; &gt;&gt; ${backup_log}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> Subject=&#34;物理备份xtra备份失败&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> Body=&#34;&#39;${ipaddr}&#39;_物理备份失败,请参考日志:${backup_log}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> SendToDingding_error $Subject $Body
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> exit 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">cd ${backup_dir}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">file_time=`date +&#39;%Y-%m-%d&#39;`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">flie_name=`ls -l | grep &#34;$file_time&#34;|tail -n 1|awk &#39;{print $9}&#39;`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">tar -zcf ${file_time}.tar.gz ${flie_name}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rm -rf ${flie_name}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## rsync -avz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if [ ! -z &#34;`tail -1 ${backup_log} | grep &#39;completed OK&#39;`&#34; ]; then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> finish_time=`date +&#39;%Y%m%d_%H:%M:%S&#39;`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> file_size=`du -sm ${backup_dir} |awk &#39;{print $1}&#39;`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> echo -e &#34;${ipaddr}数据库xtrabackup物理备份工作完成!\n 开始时间：${start_time} 结束时间：${finish_time}\n 备份目录${backup_dir}\n
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">备份文件大小${file_size} MB&#34; &gt;&gt; ${backup_log}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # 删除以前的备份
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> echo -e &#34;`date +&#39;%Y%m%d_%H:%M:%S&#39;` 开始删除${slave_days}天以前的备份&#34; &gt;&gt; ${backup_log}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> cd ${backup_base}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> for tfile in $(/usr/bin/find ${backup_dir}  -mindepth 1 -maxdepth 1 -mtime +${slave_days})
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   do
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      cd ${backup_dir} &amp;&amp; rm -rf ${tfile} 2&gt;&gt;${backup_log}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      echo -e &#34;---- delete file :${file} -----&#34; &gt;&gt; ${backup_log}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   done
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> echo -e &#34;`date +&#39;%Y%m%d_%H%M%S&#39;` 删除${slave_days}天以前的备份-完成&#34; &gt;&gt; ${backup_log}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> find $backup_base/log  -mindepth 1 -maxdepth 1  -mtime +${slave_days} -type f |xargs  rm -f
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">else
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> echo -e &#34;`date +&#39;%Y%m%d_%H:%M:%S&#39;` 备份数据库发生错误,具体看日志&#34; &gt;&gt; ${backup_log}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> Subject=&#34;物理备份xtra备份失败&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> Body=&#34;${ipaddr}_物理备份失败,请参考日志:${backup_log}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> SendToDingding_error $Subject $Body
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">exit
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="查看导出清理binlog日志">查看、导出、清理<code>binlog</code>日志</h3>
<ul>
<li>
<ol>
<li><strong>查看<code>binlog</code></strong></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#75715e"># 指定查询 mysql-bin.000002这个文件，从pos点:624开始查起，偏移2行（即中间跳过2个），查询10条
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> binlog events <span style="color:#66d9ef">in</span> <span style="color:#e6db74">&#39;mysql-bin.000002&#39;</span> <span style="color:#66d9ef">from</span> <span style="color:#ae81ff">624</span> <span style="color:#66d9ef">limit</span> <span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">10</span><span style="color:#960050;background-color:#1e0010">\</span>G;</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><strong>导出数据库<code>binlog</code>日志</strong></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>--base64-output=</code>：<code>decode-rows</code><!-- raw HTML omitted -->将行事件解码为注释伪<!-- raw HTML omitted --><code>SQL</code><!-- raw HTML omitted -->语句<!-- raw HTML omitted --></li>
<li><code>--no-defaults</code></li>
<li><code>--database=&quot;数据库名&quot;</code>：<!-- raw HTML omitted -->仅列出此数据库的条目(仅限本地日志)<!-- raw HTML omitted --></li>
<li><code>--start-datetime=''</code>：<!-- raw HTML omitted --><!-- raw HTML omitted -->开始时间<!-- raw HTML omitted -->参数必须是本地时区的日期和时间，格式不限<code>MySQL</code>服务器接受<code>DATETIME</code>和<code>TIMESTAMP</code>类型，例如：<!-- raw HTML omitted --><code>2004-12-25 11:25:56</code></li>
<li><code>--stop-datetime=''</code>：<!-- raw HTML omitted --><!-- raw HTML omitted -->结束时间<!-- raw HTML omitted -->参数必须是本地时区的日期和时间，格式不限<code>MySQL</code>服务器接受<code>DATETIME</code>和<code>TIMESTAMP</code>类型，例如：<!-- raw HTML omitted --><code>2004-12-25 11:25:56</code></li>
<li><code>--start-position=875</code>：<!-- raw HTML omitted -->偏移量开始读取位置<!-- raw HTML omitted --></li>
<li><code>--stop-position=954</code>：<!-- raw HTML omitted -->偏移量停止读取位置<!-- raw HTML omitted --></li>
<li><code>-v</code>：<!-- raw HTML omitted -->从行事件中重建伪<!-- raw HTML omitted --><code>SQL</code><!-- raw HTML omitted -->语句，<!-- raw HTML omitted --><code>-vv</code><!-- raw HTML omitted -->添加对列数据类型的注释<!-- raw HTML omitted --></li>
<li><code>-r</code>：<!-- raw HTML omitted -->直接输出到给定的文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /bin/mysqlbinlog <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--base64-output<span style="color:#f92672">=</span>decode-rows <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--no-defaults --database<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;数据库名&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--start-datetime<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;2019-04-11 00:00:00&#39;</span> <span style="color:#ae81ff">\ </span> 	<span style="color:#75715e"># 开始时间</span>
</span></span><span style="display:flex;"><span>--stop-datetime<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;2019-04-11 15:00:00&#39;</span> <span style="color:#ae81ff">\ </span> 	<span style="color:#75715e"># 结束时间</span>
</span></span><span style="display:flex;"><span>-v /opt/data/mysql/mysql-bin.000007 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-r /opt/binlog<span style="color:#e6db74">`</span>date <span style="color:#e6db74">&#39;+%F&#39;</span><span style="color:#e6db74">`</span>.sql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 方法二</span>
</span></span><span style="display:flex;"><span>$ /bin/mysqlbinlog <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--no-defaults --database<span style="color:#f92672">=</span>db <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--start-datetime<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;2019-04-11 00:00:00&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--stop-datetime<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;2019-04-11 15:00:00&#39;</span> mysql-bin.000007 | more
</span></span><span style="display:flex;"><span>mysqlbinlog <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--base64-output<span style="color:#f92672">=</span>decode-rows <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--start-position<span style="color:#f92672">=</span><span style="color:#ae81ff">2966</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--stop-position<span style="color:#f92672">=</span><span style="color:#ae81ff">2966</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-v mysql-bin.000125</span></span></code></pre></div><ul>
<li><strong>从<code>binlog</code>日志中得<code>DELETE</code>删除换成<code>INSERT INTO</code>插入语句</strong></li>
</ul>
<blockquote>
<p><a href="https://www.cnblogs.com/yhq1314/p/13970044.html" rel="external" target="_self"><code>mysql binlg delete</code>语句解析为<code>insert</code>语句</a></p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ find /path/to/binlog/directory -name <span style="color:#e6db74">&#34;binlog.*&#34;</span> -printf <span style="color:#e6db74">&#34;%T@ %p\n&#34;</span> | sort -n | cut -d<span style="color:#e6db74">&#39; &#39;</span> -f2- | xargs mysqlbinlog &gt; combined_binlog.sql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ find ./ -name <span style="color:#e6db74">&#34;mysql-bin.266*&#34;</span> -printf <span style="color:#e6db74">&#34;%T@ %p\n&#34;</span> | sort -n | cut -d<span style="color:#e6db74">&#39; &#39;</span> -f2- | xargs /usr/local/mysql/bin/mysqlbinlog -vv  --base64-output<span style="color:#f92672">=</span>DECODE-ROWS --set-charset<span style="color:#f92672">=</span>UTF8 mysql-bin.266770 --database<span style="color:#f92672">=</span>databases_name -r new_binlog.sql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#####  	解析binlog并还原成插入语句  	#####</span>
</span></span><span style="display:flex;"><span>$ /usr/local/mysql/bin/mysqlbinlog -vv --base64-output<span style="color:#f92672">=</span>DECODE-ROWS --set-charset<span style="color:#f92672">=</span>UTF8 mysql-bin.merged.9 --database<span style="color:#f92672">=</span>databases_name &gt;&gt;/mnt/new_binlog.sql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 只过滤某个数据库中的某个表中的删除语句</span>
</span></span><span style="display:flex;"><span>$ cat new_binlog.sql | awk <span style="color:#e6db74">&#39;/DELETE FROM/ &amp;&amp; (/databases_name.tables_name/ || /`databases_name`.`tables_name`/) { while(1) { print $0; getline; if($0 !~ /^###/) { break; }; }}&#39;</span> &gt; new_binlog-1.sql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 去掉：###</span>
</span></span><span style="display:flex;"><span>$ cp new_binlog-1.sql new_binlog-2.sql
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s/^### //g&#39;</span> new_binlog-2.sql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除语句替换为插入语句</span>
</span></span><span style="display:flex;"><span>$ cp new_binlog-2.sql new_binlog-3.sql
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;s/^DELETE FROM/INSERT INTO/g&#34;</span> new_binlog-3.sql 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 条件替换为值</span>
</span></span><span style="display:flex;"><span>$ cp new_binlog-3.sql new_binlog-4.sql
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;s/^WHERE/VALUES(/g&#34;</span> new_binlog-4.sql 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># @21 这里要看解析后的具体行数， </span>
</span></span><span style="display:flex;"><span>$ cp new_binlog-4.sql new_binlog-5.sql
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;/@21=.*/a );&#39;</span> new_binlog-5.sql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat new_binlog-5.sql | awk -F<span style="color:#e6db74">&#34;=|/*&#34;</span> <span style="color:#e6db74">&#39;{ if($0 ~ /^INSERT|^VALUES|^);/) { print $0; } else { printf $2&#34;,&#34;; };}&#39;</span> &gt;new_binlog-6.sql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cp  new_binlog-6.sql new_binlog-7.sql
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;s/,);</span>$<span style="color:#e6db74">/);/g&#34;</span> new_binlog-7.sql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cp new_binlog-7.sql new_binlog-8.sql
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s/,INSERT/);INSERT/g&#39;</span> new_binlog-8.sql</span></span></code></pre></div></blockquote>
</blockquote>
<ul>
<li>
<ol start="3">
<li><strong>清理<code>binlog</code></strong></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><a href="https://www.cnblogs.com/xxoome/p/9802684.html" rel="external" target="_self"><code>mysql binlog</code>日志自动清理及手动删除</a>、<a href="https://developer.aliyun.com/article/712256" rel="external" target="_self"><code>Mysql</code>清理<code>binlog</code></a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#75715e"># 清除MySQL-bin.010日志
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">PURGE</span> MASTER LOGS <span style="color:#66d9ef">TO</span> <span style="color:#e6db74">&#39;MySQL-bin.010&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 清除2008-06-22 13:00:00前binlog日志
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">PURGE</span> MASTER LOGS <span style="color:#66d9ef">BEFORE</span> <span style="color:#e6db74">&#39;2008-06-22 13:00:00&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 清除3天前binlog日志BEFORE，变量的date自变量可以为&#39;YYYY-MM-DD hh:mm:ss&#39;格式。 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">PURGE</span> MASTER LOGS <span style="color:#66d9ef">BEFORE</span> <span style="color:#a6e22e">DATE_SUB</span>( <span style="color:#a6e22e">NOW</span>( ), <span style="color:#66d9ef">INTERVAL</span> <span style="color:#ae81ff">3</span> DAY);</span></span></code></pre></div></blockquote>
<hr>
<h3 id="创建授权删除用户">创建、授权、删除用户</h3>
<ul>
<li>
<ol>
<li><strong>创建、授权</strong></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><strong><code>5.7.*</code>一下创建以及授权</strong></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">grant</span> <span style="color:#66d9ef">all</span> <span style="color:#66d9ef">on</span> <span style="color:#f92672">*</span>.<span style="color:#f92672">*</span> <span style="color:#66d9ef">to</span> root<span style="color:#f92672">@</span><span style="color:#e6db74">&#39;10.14.23.%&#39;</span> <span style="color:#66d9ef">identified</span> <span style="color:#66d9ef">by</span> <span style="color:#e6db74">&#39;123456&#39;</span>;  	<span style="color:#75715e"># 192.168.%.% 表示网段
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">grant</span> <span style="color:#66d9ef">all</span> <span style="color:#66d9ef">privileges</span> <span style="color:#66d9ef">on</span> <span style="color:#66d9ef">database</span>.<span style="color:#66d9ef">tables</span> <span style="color:#66d9ef">to</span> <span style="color:#e6db74">&#39;user&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;localhost&#39;</span> <span style="color:#66d9ef">identified</span> <span style="color:#66d9ef">by</span> <span style="color:#e6db74">&#34;password&#34;</span>;</span></span></code></pre></div><ul>
<li><strong><code>Myslq 8.0</code>语句执行，<code>8.0</code>版本之后创建用户和授权分开了</strong></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#75715e"># 创建用户
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">USER</span> <span style="color:#e6db74">&#39;username&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;127.0.0.1&#39;</span> <span style="color:#66d9ef">IDENTIFIED</span> <span style="color:#66d9ef">BY</span> <span style="color:#e6db74">&#39;passowrd&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 授予权限
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">GRANT</span> <span style="color:#66d9ef">ALL</span> <span style="color:#66d9ef">ON</span> <span style="color:#f92672">*</span>.<span style="color:#f92672">*</span> <span style="color:#66d9ef">TO</span> <span style="color:#e6db74">&#39;username&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;127.0.0.1&#39;</span> <span style="color:#66d9ef">WITH</span> <span style="color:#66d9ef">GRANT</span> <span style="color:#66d9ef">OPTION</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除权限
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">REVOKE</span> <span style="color:#66d9ef">all</span> <span style="color:#66d9ef">privileges</span> <span style="color:#66d9ef">ON</span> databasename.tablename <span style="color:#66d9ef">FROM</span> <span style="color:#e6db74">&#39;username&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;host&#39;</span>; </span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><strong>创建从库用户并授复制权限</strong></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>MySQL<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">grant</span> replication slave, replication client <span style="color:#66d9ef">on</span> <span style="color:#f92672">*</span>.<span style="color:#f92672">*</span> <span style="color:#66d9ef">to</span> <span style="color:#e6db74">&#39;lisi&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;10.14.23.%&#39;</span> <span style="color:#66d9ef">identified</span> <span style="color:#66d9ef">by</span> <span style="color:#e6db74">&#39;123456&#39;</span>;</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><strong>撤销用户权限</strong></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">REVOKE</span> privilege <span style="color:#66d9ef">ON</span> databasename.tablename <span style="color:#66d9ef">FROM</span> <span style="color:#e6db74">&#39;username&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;host&#39;</span>;  </span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><strong>删除用户、数据</strong></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">drop</span> <span style="color:#66d9ef">user</span> <span style="color:#e6db74">&#39;username&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;host&#39;</span>;  	<span style="color:#75715e"># 如果是当前登陆用户用SET PASSWORD = PASSWORD(&#34;newpassword&#34;); 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">delete</span> <span style="color:#66d9ef">from</span> <span style="color:#960050;background-color:#1e0010">表名</span> <span style="color:#66d9ef">where</span> <span style="color:#960050;background-color:#1e0010">列名</span><span style="color:#f92672">=</span><span style="color:#960050;background-color:#1e0010">‘</span>xx<span style="color:#960050;background-color:#1e0010">’</span> <span style="color:#66d9ef">and</span> <span style="color:#960050;background-color:#1e0010">列名</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;xx&#39;</span>;  	<span style="color:#75715e"># 授权查看数据库用户（clint） 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">delete</span> <span style="color:#66d9ef">from</span> mysql.<span style="color:#66d9ef">user</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">user</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;slave&#34;</span> <span style="color:#66d9ef">and</span> host<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;10.14.23.%&#34;</span>;  </span></span></code></pre></div></blockquote>
<hr>
<h3 id="创建库表">创建库、表</h3>
<ul>
<li>
<ol>
<li><strong>创建库</strong></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">database</span> db2 <span style="color:#66d9ef">character</span> <span style="color:#66d9ef">set</span> utf8 <span style="color:#66d9ef">collate</span> utf8_general_ci;</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><strong>创建表</strong></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>NOT NULL</code>：<!-- raw HTML omitted -->每一行都必须含有值（不能为空），<code>null</code>值是不允许的<!-- raw HTML omitted --></li>
<li><code>DEFAULT value</code>：<!-- raw HTML omitted -->设置默认值<!-- raw HTML omitted --></li>
<li><code>UNSIGNED</code>：<!-- raw HTML omitted -->使用无符号数值类型，<!-- raw HTML omitted --><code>0</code><!-- raw HTML omitted -->及正数<!-- raw HTML omitted --></li>
<li><code>AUTO INCREMENT</code>：<!-- raw HTML omitted -->设置<!-- raw HTML omitted --><code>MySQL</code><!-- raw HTML omitted -->字段的值在新增记录时每次自动增长<!-- raw HTML omitted --><code>1</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> databases_name.<span style="color:#a6e22e">tables_name</span>(id <span style="color:#66d9ef">int</span> <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span>, name <span style="color:#66d9ef">varchar</span>(<span style="color:#ae81ff">50</span>)<span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span>);
</span></span><span style="display:flex;"><span>Query OK, <span style="color:#ae81ff">1</span> row <span style="color:#a6e22e">affected</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)  	<span style="color:#75715e"># not null 不为空
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设置数据表中每条记录的唯一标识。 通常列的 PRIMARY KEY 设置为 ID 数值，与AUTO_INCREMENT 一起使用。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> <span style="color:#f92672">`</span>databases_name<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>tables_name<span style="color:#f92672">`</span>(name) <span style="color:#66d9ef">values</span>(<span style="color:#e6db74">&#39;lisi&#39;</span>);
</span></span><span style="display:flex;"><span>Query OK, <span style="color:#ae81ff">1</span> row <span style="color:#a6e22e">affected</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)  	<span style="color:#75715e"># 不写id
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> <span style="color:#f92672">`</span>databases_name<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>tables_name<span style="color:#f92672">`</span>(id,content,add_time) <span style="color:#66d9ef">values</span>(<span style="color:#ae81ff">4</span>,<span style="color:#e6db74">&#39;Text&#39;</span>,<span style="color:#e6db74">&#39;2023-01-11 02:52:54&#39;</span>);</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><strong>按日期删除表</strong></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">USE</span> example_db;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span> table_name <span style="color:#66d9ef">FROM</span> information_schema.<span style="color:#66d9ef">tables</span> <span style="color:#66d9ef">WHERE</span> table_schema <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;example_db&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span> <span style="color:#a6e22e">CONCAT</span>(<span style="color:#e6db74">&#39;DROP TABLE IF EXISTS &#39;</span>, table_name, <span style="color:#e6db74">&#39;;&#39;</span>) <span style="color:#66d9ef">AS</span> sql_statement <span style="color:#66d9ef">FROM</span> information_schema.<span style="color:#66d9ef">tables</span> <span style="color:#66d9ef">WHERE</span> table_schema <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;example_db&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span> table_name <span style="color:#66d9ef">FROM</span> information_schema.<span style="color:#66d9ef">tables</span> <span style="color:#66d9ef">WHERE</span> table_name <span style="color:#66d9ef">LIKE</span> <span style="color:#e6db74">&#39;prefix_%&#39;</span> <span style="color:#66d9ef">AND</span> table_name <span style="color:#66d9ef">BETWEEN</span> <span style="color:#e6db74">&#39;prefix_2022-02-01&#39;</span> <span style="color:#66d9ef">AND</span> <span style="color:#e6db74">&#39;prefix_2022-03-01&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span> <span style="color:#a6e22e">CONCAT</span>(<span style="color:#e6db74">&#39;DROP TABLE IF EXISTS &#39;</span>, table_name, <span style="color:#e6db74">&#39;;&#39;</span>) <span style="color:#66d9ef">AS</span> sql_statement <span style="color:#66d9ef">FROM</span> information_schema.<span style="color:#66d9ef">tables</span> <span style="color:#66d9ef">WHERE</span> table_name <span style="color:#66d9ef">LIKE</span> <span style="color:#e6db74">&#39;prefix_%&#39;</span> <span style="color:#66d9ef">AND</span> table_name <span style="color:#66d9ef">BETWEEN</span> <span style="color:#e6db74">&#39;prefix_2022-02-01&#39;</span> <span style="color:#66d9ef">AND</span> <span style="color:#e6db74">&#39;prefix_2022-03-01&#39;</span>;</span></span></code></pre></div></blockquote>
<hr>
<h3 id="查询库表容量大小">查询库、表容量大小</h3>
<blockquote>
<ul>
<li><strong>查询所有库容量大小</strong></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span> 
</span></span><span style="display:flex;"><span>table_schema <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;数据库&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sum</span>(table_rows) <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;记录数&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sum</span>(<span style="color:#a6e22e">truncate</span>(data_length<span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span>, <span style="color:#ae81ff">2</span>)) <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;数据容量(MB)&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sum</span>(<span style="color:#a6e22e">truncate</span>(index_length<span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span>, <span style="color:#ae81ff">2</span>)) <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;索引容量(MB)&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sum</span>(<span style="color:#a6e22e">truncate</span>(DATA_FREE<span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span>, <span style="color:#ae81ff">2</span>)) <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;碎片占用(MB)&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">from</span> information_schema.<span style="color:#66d9ef">tables</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">group</span> <span style="color:#66d9ef">by</span> table_schema
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> <span style="color:#a6e22e">sum</span>(data_length) <span style="color:#66d9ef">desc</span>, <span style="color:#a6e22e">sum</span>(index_length) <span style="color:#66d9ef">desc</span>;</span></span></code></pre></div></blockquote>
<ul>
<li><strong>查看指定库的容量大小</strong></li>
</ul>
<blockquote>
<ul>
<li>查看<code>MySQL</code>「指定库」的容量大小：<code>database_name</code>更改为要查询的库</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span> 
</span></span><span style="display:flex;"><span>table_schema <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;数据库&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sum</span>(table_rows) <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;记录数&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sum</span>(<span style="color:#a6e22e">truncate</span>(data_length<span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span>, <span style="color:#ae81ff">2</span>)) <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;数据容量(MB)&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sum</span>(<span style="color:#a6e22e">truncate</span>(index_length<span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span>, <span style="color:#ae81ff">2</span>)) <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;索引容量(MB)&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sum</span>(<span style="color:#a6e22e">truncate</span>(DATA_FREE<span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span>, <span style="color:#ae81ff">2</span>)) <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;碎片占用(MB)&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">from</span> information_schema.<span style="color:#66d9ef">tables</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span> table_schema<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;database_name&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> data_length <span style="color:#66d9ef">desc</span>, index_length <span style="color:#66d9ef">desc</span>;</span></span></code></pre></div></blockquote>
<ul>
<li><strong>查看指定库中所有表的容量大小</strong></li>
</ul>
<blockquote>
<ul>
<li>查看<code>MySQL</code>「指定库」中「所有表」的容量大小</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span>
</span></span><span style="display:flex;"><span>table_schema <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;数据库&#39;</span>,
</span></span><span style="display:flex;"><span>table_name <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;表名&#39;</span>,
</span></span><span style="display:flex;"><span>table_rows <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;记录数&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">truncate</span>(data_length<span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span>, <span style="color:#ae81ff">2</span>) <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;数据容量(MB)&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">truncate</span>(index_length<span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span>, <span style="color:#ae81ff">2</span>) <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;索引容量(MB)&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">truncate</span>(DATA_FREE<span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span>, <span style="color:#ae81ff">2</span>) <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;碎片占用(MB)&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">from</span> information_schema.<span style="color:#66d9ef">tables</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span> table_schema<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;database_name&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> data_length <span style="color:#66d9ef">desc</span>, index_length <span style="color:#66d9ef">desc</span>;</span></span></code></pre></div></blockquote>
<ul>
<li><strong>查看指定库中指定表的容量大小</strong></li>
</ul>
<blockquote>
<ul>
<li>查看<code>MySQL</code>「指定库」中「指定表」的容量大小：将代码中<code>database_name</code>数据库名改为你要查询的数据库名，<code>tables_name</code>改为你要查询的表名</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span>
</span></span><span style="display:flex;"><span>table_schema <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;数据库&#39;</span>,
</span></span><span style="display:flex;"><span>table_name <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;表名&#39;</span>,
</span></span><span style="display:flex;"><span>table_rows <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;记录数&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">truncate</span>(data_length<span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span>, <span style="color:#ae81ff">2</span>) <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;数据容量(MB)&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">truncate</span>(index_length<span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span>, <span style="color:#ae81ff">2</span>) <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;索引容量(MB)&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">truncate</span>(DATA_FREE<span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span>, <span style="color:#ae81ff">2</span>) <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;碎片占用(MB)&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">from</span> information_schema.<span style="color:#66d9ef">tables</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span> table_schema<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;database_name&#39;</span><span style="color:#66d9ef">and</span> table_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;tables_name&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> data_length <span style="color:#66d9ef">desc</span>, index_length <span style="color:#66d9ef">desc</span>;</span></span></code></pre></div></blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#75715e"># 查询并且进行AES解码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#a6e22e">aes_decrypt</span>(<span style="color:#a6e22e">from_base64</span>(mobile),<span style="color:#e6db74">&#39;key&#39;</span>,<span style="color:#e6db74">&#39;加密掩码&#39;</span>) <span style="color:#66d9ef">from</span> yl_users <span style="color:#66d9ef">where</span> member <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><strong>排查<code>Mysql</code>占用内存原因</strong></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 查看MySQL的Pid</span>
</span></span><span style="display:flex;"><span>$ ps -ef | grep -i mysqld
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看MySQL实时操作系统线程Pid</span>
</span></span><span style="display:flex;"><span>$ top -p <span style="color:#e6db74">&#34;Mysql Pid&#34;</span> -H
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 数据库中查看Pid 具体操作内容</span>
</span></span><span style="display:flex;"><span>Mysql&gt; SELECT THREAD_ID,name ,PROCESSLIST_ID FROM <span style="color:#e6db74">`</span>performance_schema<span style="color:#e6db74">`</span>.threads WHERE THREAD_OS_ID <span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Mysql Pid&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 根据获取到MySQL中的 Thread_id 获取SQL</span>
</span></span><span style="display:flex;"><span>mysql&gt; SELECT SQL_TEXT FROM <span style="color:#e6db74">`</span>performance_schema<span style="color:#e6db74">`</span>.events_statements_current WHERE THREAD_ID <span style="color:#f92672">=</span> Thread_id;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">###########################</span>
</span></span><span style="display:flex;"><span>mysql&gt; SELECT VARIABLE_NAME,VARIABLE_VALUE, CONCAT<span style="color:#f92672">(</span>VARIABLE_VALUE/1024/1024,<span style="color:#e6db74">&#39; MB&#39;</span><span style="color:#f92672">)</span> AS VARIABLE_VALUE_MB FROM information_schema.SESSION_VARIABLES WHERE VARIABLE_NAME IN <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;innodb_buffer_pool_size&#39;</span>,<span style="color:#e6db74">&#39;innodb_log_buffer_size&#39;</span>,<span style="color:#e6db74">&#39;innodb_additional_mem_pool_size&#39;</span>,<span style="color:#e6db74">&#39;key_buffer_size&#39;</span>,<span style="color:#e6db74">&#39;query_cache_size&#39;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql&gt; SHOW VARIABLES LIKE <span style="color:#e6db74">&#39;%show_compatibility_56%&#39;</span>;
</span></span><span style="display:flex;"><span>mysql&gt; SET GLOBAL show_compatibility_56<span style="color:#f92672">=</span>on;</span></span></code></pre></div></blockquote>
<hr>
<h3 id="其他命令">其他命令</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted --><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#75715e"># MySQL-master,查看数据库偏移量
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> master status;
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> reset master;  <span style="color:#75715e"># 清理reset日志
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 从库执行，测试连接主库
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span><span style="color:#66d9ef">show</span> grants;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> mysql_secure_installation  	<span style="color:#75715e"># mysql安全配置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>Enter current password <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">root</span> (enter <span style="color:#66d9ef">for</span> none):  	<span style="color:#75715e"># 输入进入数据库密码，默认为空，按回车
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">Set</span> root password<span style="color:#f92672">?</span> [Y<span style="color:#f92672">/</span>n]  	<span style="color:#75715e"># 设置mysql数据库root用户的密码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>Remove anonymous users<span style="color:#f92672">?</span> [Y<span style="color:#f92672">/</span>n]  	<span style="color:#75715e"># 移除匿名用户Y
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>Disallow root login remotely<span style="color:#f92672">?</span> [Y<span style="color:#f92672">/</span>n]  	<span style="color:#75715e"># 不允许root用户远程登陆Y
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>Remove test <span style="color:#66d9ef">database</span> <span style="color:#66d9ef">and</span> access <span style="color:#66d9ef">to</span> it<span style="color:#f92672">?</span> [Y<span style="color:#f92672">/</span>n]  	<span style="color:#75715e"># 移除test数据库和访问Y
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>Reload privilege <span style="color:#66d9ef">tables</span> now<span style="color:#f92672">?</span> [Y<span style="color:#f92672">/</span>n]   
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 筛选数据不同值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">distinct</span> <span style="color:#960050;background-color:#1e0010">列名</span> <span style="color:#66d9ef">from</span> <span style="color:#960050;background-color:#1e0010">表名</span>;
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> <span style="color:#960050;background-color:#1e0010">表名</span> <span style="color:#66d9ef">where</span> <span style="color:#960050;background-color:#1e0010">列名</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">15</span> <span style="color:#66d9ef">and</span> (<span style="color:#960050;background-color:#1e0010">列名</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;选项&#39;</span> <span style="color:#66d9ef">or</span> <span style="color:#960050;background-color:#1e0010">列名</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;选项&#39;</span>);
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> <span style="color:#960050;background-color:#1e0010">表名</span> <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> <span style="color:#960050;background-color:#1e0010">列名、列名</span> <span style="color:#66d9ef">desc</span>(<span style="color:#960050;background-color:#1e0010">降序</span>)<span style="color:#960050;background-color:#1e0010">、</span><span style="color:#66d9ef">asc</span>(<span style="color:#960050;background-color:#1e0010">升序、默认升序</span>);
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> <span style="color:#960050;background-color:#1e0010">表名</span> <span style="color:#66d9ef">limit</span> <span style="color:#ae81ff">2</span>  	<span style="color:#75715e"># 查看前两条数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> <span style="color:#960050;background-color:#1e0010">表名</span> <span style="color:#66d9ef">where</span> <span style="color:#960050;background-color:#1e0010">列名</span> <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;首个关键字%&#39;</span>;  	<span style="color:#75715e"># %匹配所有
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> <span style="color:#960050;background-color:#1e0010">表名</span> <span style="color:#66d9ef">where</span> <span style="color:#960050;background-color:#1e0010">列名</span> <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;%xx%&#39;</span>;  	<span style="color:#75715e"># 反向查找
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> <span style="color:#960050;background-color:#1e0010">表名</span> <span style="color:#66d9ef">where</span> <span style="color:#960050;background-color:#1e0010">列名</span> <span style="color:#66d9ef">in</span> (<span style="color:#e6db74">&#39;关键字&#39;</span>,<span style="color:#960050;background-color:#1e0010">‘关键字’</span>)<span style="color:#960050;background-color:#1e0010">；</span>
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> <span style="color:#960050;background-color:#1e0010">表名</span> <span style="color:#66d9ef">where</span> <span style="color:#960050;background-color:#1e0010">列名</span> <span style="color:#66d9ef">between</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">and</span> <span style="color:#ae81ff">20</span>;  	<span style="color:#75715e"># 选取1到20之间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> <span style="color:#960050;background-color:#1e0010">表名</span> <span style="color:#66d9ef">where</span> <span style="color:#960050;background-color:#1e0010">列名</span> <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">between</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">and</span> <span style="color:#ae81ff">20</span>;  	<span style="color:#75715e"># 取反
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> <span style="color:#960050;background-color:#1e0010">表名</span> <span style="color:#66d9ef">where</span> (<span style="color:#960050;background-color:#1e0010">列名</span> <span style="color:#66d9ef">between</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">and</span> <span style="color:#ae81ff">20</span>) <span style="color:#66d9ef">and</span> <span style="color:#960050;background-color:#1e0010">列名</span> <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">in</span> (<span style="color:#e6db74">&#39;关键字&#39;</span>)<span style="color:#960050;background-color:#1e0010">；</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 更新、更改数据数据以及用户权限
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">update</span> <span style="color:#960050;background-color:#1e0010">表名</span> <span style="color:#66d9ef">set</span> <span style="color:#960050;background-color:#1e0010">列名</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;333&#39;</span>, <span style="color:#960050;background-color:#1e0010">列名</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;cn&#39;</span> <span style="color:#66d9ef">where</span> <span style="color:#960050;background-color:#1e0010">列名</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;xxx&#39;</span>;
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">update</span> <span style="color:#66d9ef">user</span> <span style="color:#66d9ef">set</span> host <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;%&#39;</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">user</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;root&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改数据库同步线程mysql
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">set</span> global sync_binlog<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>;
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">set</span> global innodb_flush_log_at_trx_commit<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改sql线程数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> STOP SLAVE SQL_THREAD;
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SET</span> GLOBAL slave_parallel_type<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;LOGICAL_CLOCK&#39;</span>;
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SET</span> GLOBAL slave_parallel_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span>;  	
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> START SLAVE SQL_THREAD;	</span></span></code></pre></div></blockquote>
<hr>
<h2 id="mysql查询锁表语句"><code>MySQL</code>查询锁表语句</h2>
<ul>
<li>
<ol>
<li><a href="https://www.cnblogs.com/better-farther-world2099/articles/14721482.html" rel="external" target="_self"><code>MySQL</code>查询锁表语句</a></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><strong>查询是否锁表</strong></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> OPEN <span style="color:#66d9ef">TABLES</span> <span style="color:#66d9ef">where</span> In_use <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>;</span></span></code></pre></div><ul>
<li><strong>查看正在锁的事务</strong></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> INFORMATION_SCHEMA.INNODB_LOCKS; </span></span></code></pre></div><ul>
<li><strong>查看等待锁的事务</strong></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> INFORMATION_SCHEMA.INNODB_LOCK_WAITS;</span></span></code></pre></div><ul>
<li><strong>查看当前的事务</strong></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> INFORMATION_SCHEMA.INNODB_TRX;</span></span></code></pre></div><ul>
<li><strong>查看当前锁定的事务</strong></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> INFORMATION_SCHEMA.INNODB_LOCKS;</span></span></code></pre></div><ul>
<li><strong>查看当前等锁的事务</strong></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> INFORMATION_SCHEMA.INNODB_LOCK_WAITS;</span></span></code></pre></div><ul>
<li><strong>查询死锁详情</strong></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span> r.trx_id waiting_trx_id,r.trx_mysql_thread_id waiting_thread,
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">TIMESTAMPADD</span>(SECOND,r.trx_wait_started,<span style="color:#66d9ef">CURRENT_TIMESTAMP</span>) wait_time,
</span></span><span style="display:flex;"><span>r.trx_query waiting_query,
</span></span><span style="display:flex;"><span>l.lock_table waiting_table_lock,
</span></span><span style="display:flex;"><span>b.trx_id blocking_trx_id,b.trx_mysql_thread_id blocking_thread,
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SUBSTRING</span>(p.<span style="color:#f92672">`</span>HOST<span style="color:#f92672">`</span>,<span style="color:#ae81ff">1</span>,<span style="color:#a6e22e">INSTR</span>(p.<span style="color:#f92672">`</span>HOST<span style="color:#f92672">`</span>,<span style="color:#e6db74">&#39;:&#39;</span>)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) blocking_host,
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SUBSTRING</span>(p.<span style="color:#f92672">`</span>HOST<span style="color:#f92672">`</span>,<span style="color:#a6e22e">INSTR</span>(p.<span style="color:#f92672">`</span>HOST<span style="color:#f92672">`</span>,<span style="color:#e6db74">&#39;:&#39;</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>) blocking_port,
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">IF</span>(p.COMMAND <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Sleep&#39;</span>,p.<span style="color:#66d9ef">TIME</span>,<span style="color:#ae81ff">0</span>) idle_in_trx,
</span></span><span style="display:flex;"><span>b.trx_query blocking_query
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">from</span> information_schema.INNODB_LOCK_WAITS w
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">INNER</span> <span style="color:#66d9ef">JOIN</span> information_schema.INNODB_TRX b <span style="color:#66d9ef">ON</span> b.trx_id <span style="color:#f92672">=</span> w.blocking_lock_id
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">INNER</span> <span style="color:#66d9ef">JOIN</span> information_schema.INNODB_TRX r <span style="color:#66d9ef">ON</span> r.trx_id <span style="color:#f92672">=</span> w.requesting_trx_id
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">INNER</span> <span style="color:#66d9ef">JOIN</span> information_schema.INNODB_LOCKS l <span style="color:#66d9ef">ON</span> l.lock_id <span style="color:#f92672">=</span> w.requested_lock_id
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">LEFT</span> <span style="color:#66d9ef">JOIN</span> information_schema.<span style="color:#f92672">`</span>PROCESSLIST<span style="color:#f92672">`</span> p <span style="color:#66d9ef">ON</span> p.id <span style="color:#f92672">=</span> b.trx_mysql_thread_id
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> wait_time <span style="color:#66d9ef">desc</span>;</span></span></code></pre></div></blockquote>
<hr>
<h2 id="配置数据库主从复制">配置数据库主从复制</h2>
<ul>
<li>
<ol>
<li><strong>主数据库配置以及授权</strong></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 修改ID</span>
</span></span><span style="display:flex;"><span>$ server_id<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>hostname -I |awk <span style="color:#e6db74">&#34;{print </span>$1<span style="color:#e6db74">}&#34;</span>|awk -F<span style="color:#e6db74">&#34;.&#34;</span> <span style="color:#e6db74">&#34;{print </span>$4<span style="color:#e6db74">}&#34;</span><span style="color:#e6db74">`</span>  
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;s/server-id = 16303110/server-id = 16303</span>$server_id<span style="color:#e6db74">/g&#34;</span> /etc/my.cnf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 授权从库连接账户密码</span>
</span></span><span style="display:flex;"><span>mysql&gt; grant replication slave on *.* to myuser@<span style="color:#e6db74">&#39;host IP&#39;</span> identified by <span style="color:#e6db74">&#39;password&#39;</span>;
</span></span><span style="display:flex;"><span>mysql&gt; flush privileges;
</span></span><span style="display:flex;"><span>mysql&gt; reset master; <span style="color:#e6db74">&#34;</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><strong>配置从库连接主库</strong></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 修改ID</span>
</span></span><span style="display:flex;"><span>$ server_id<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>hostname -I |awk <span style="color:#e6db74">&#39;{print $1}&#39;</span>|awk -F<span style="color:#e6db74">&#39;.&#39;</span> <span style="color:#e6db74">&#39;{print $4}&#39;</span><span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;s/server-id = 16303110/server-id = 16303</span>$server_id<span style="color:#e6db74">/g&#34;</span> /etc/my.cnf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 配置连接主库</span>
</span></span><span style="display:flex;"><span>$ /usr/local/mysql/bin/mysql -uroot -p -S /tmp/mysql.sock <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-e <span style="color:#e6db74">&#34;CHANGE MASTER TO MASTER_HOST=&#39;127.0.0.1&#39;, \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_USER=&#39;myuser&#39;, \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_PASSWORD=&#39;password&#39;, \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_PORT=16303, \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_LOG_FILE=&#39;mysql-bin.000001&#39;, \  	# 主机show master status;中的File
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_LOG_POS=154,MASTER_CONNECT_RETRY=15;&#34;</span>  	<span style="color:#75715e"># 主机show master status;中的Position.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ /usr/local/mysql/bin/mysql -uroot -p -S /tmp/mysql.sock -e <span style="color:#e6db74">&#34;start slave;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ /usr/local/mysql/bin/mysql -uroot -p -S /tmp/mysql.sock -e <span style="color:#e6db74">&#34;show slave status\G&#34;</span></span></span></code></pre></div><ul>
<li><strong>配置多源复制</strong></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /usr/local/mysql/bin/mysql -uroot -p -S /tmp/mysql.sock <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-e <span style="color:#e6db74">&#34;CHANGE MASTER TO MASTER_HOST=&#39;127.0.0.1&#39;, \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_USER=&#39;myuser&#39;, \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_PASSWORD=&#39;password&#39;, \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_PORT=16303, \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">master_auto_position=1  for  channel &#39;rep_master_1&#39;;&#34;</span>  	<span style="color:#75715e"># 协商、定义频道几个主机定义几次。</span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h2 id="数据库开启gtid流程">数据库开启<code>GTID</code>流程</h2>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 如果可以先暂停业务，查询是否还有业务连接</span>
</span></span><span style="display:flex;"><span>mysql&gt; show processlist;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 主从依次执行：主库执行好后，去从库执行 ，再执行下一个命令</span>
</span></span><span style="display:flex;"><span>mysql&gt; SET @@GLOBAL.ENFORCE_GTID_CONSISTENCY<span style="color:#f92672">=</span>WARN;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查询主从错误日志，看看是否有报错，在做下一步</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 主库执行好后，去从库执行 ，再执行下一个命令</span>
</span></span><span style="display:flex;"><span>mysql&gt; SET @@GLOBAL.ENFORCE_GTID_CONSISTENCY<span style="color:#f92672">=</span>ON;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 主库执行好后，去从库执行 ，再执行下一个命令</span>
</span></span><span style="display:flex;"><span>mysql&gt; SET @@GLOBAL.GTID_MODE<span style="color:#f92672">=</span>OFF_PERMISSIVE;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 主库执行好后，去从库执行 ，再执行下一个命令</span>
</span></span><span style="display:flex;"><span>mysql&gt; SET @@GLOBAL.GTID_MODE<span style="color:#f92672">=</span>ON_PERMISSIVE;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 从库查询：等待从库这个状态变为0</span>
</span></span><span style="display:flex;"><span>mysql&gt; show status like <span style="color:#e6db74">&#39;ONGOING_ANONYMOUS_TRANSACTION_COUNT&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 主从执行：</span>
</span></span><span style="display:flex;"><span>mysql&gt; SET @@GLOBAL.gtid_mode<span style="color:#f92672">=</span>on;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 从库执行：</span>
</span></span><span style="display:flex;"><span>mysql&gt; stop slave;
</span></span><span style="display:flex;"><span>mysql&gt; change master to master_auto_position<span style="color:#f92672">=</span>1;
</span></span><span style="display:flex;"><span>mysql&gt; start slave;</span></span></code></pre></div></blockquote>
<hr>
<h2 id="mysql开启日志审计"><code>Mysql</code>开启日志审计</h2>
<blockquote>
<ul>
<li></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 连接数据库执行语句：</span>
</span></span><span style="display:flex;"><span>mysql&gt; CREATE TABLE <span style="color:#e6db74">`</span>mysql<span style="color:#e6db74">`</span>.<span style="color:#e6db74">`</span>audit_login<span style="color:#e6db74">`</span> <span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">`</span>ID<span style="color:#e6db74">`</span> bigint NOT NULL AUTO_INCREMENT COMMENT <span style="color:#e6db74">&#39;自增ID&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">`</span>USER<span style="color:#e6db74">`</span> varchar<span style="color:#f92672">(</span>128<span style="color:#f92672">)</span>  NOT NULL COMMENT <span style="color:#e6db74">&#39;数据库中的用户&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">`</span>HOST<span style="color:#e6db74">`</span> varchar<span style="color:#f92672">(</span>64<span style="color:#f92672">)</span>  DEFAULT NULL COMMENT <span style="color:#e6db74">&#39;登录的IP&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">`</span>DB<span style="color:#e6db74">`</span> varchar<span style="color:#f92672">(</span>64<span style="color:#f92672">)</span>  DEFAULT NULL COMMENT <span style="color:#e6db74">&#39;访问的数据库&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">`</span>PROCESSLIST_ID<span style="color:#e6db74">`</span> bigint NOT NULL COMMENT <span style="color:#e6db74">&#39;用户连接&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">`</span>LOGIN_TIME<span style="color:#e6db74">`</span> datetime<span style="color:#f92672">(</span>3<span style="color:#f92672">)</span> DEFAULT CURRENT_TIMESTAMP<span style="color:#f92672">(</span>3<span style="color:#f92672">)</span> COMMENT <span style="color:#e6db74">&#39;登录时间&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">`</span>UPDATE_TIME<span style="color:#e6db74">`</span> datetime<span style="color:#f92672">(</span>3<span style="color:#f92672">)</span> DEFAULT CURRENT_TIMESTAMP<span style="color:#f92672">(</span>3<span style="color:#f92672">)</span> ON UPDATE CURRENT_TIMESTAMP<span style="color:#f92672">(</span>3<span style="color:#f92672">)</span> COMMENT <span style="color:#e6db74">&#39;记录这行数据上次被修改的时间,默认等于LOGIN_TIME&#39;</span>,
</span></span><span style="display:flex;"><span>PRIMARY KEY <span style="color:#f92672">(</span><span style="color:#e6db74">`</span>ID<span style="color:#e6db74">`</span><span style="color:#f92672">)</span>,
</span></span><span style="display:flex;"><span>KEY <span style="color:#e6db74">`</span>IDX_USER<span style="color:#e6db74">`</span> <span style="color:#f92672">(</span><span style="color:#e6db74">`</span>USER<span style="color:#e6db74">`</span><span style="color:#f92672">)</span>,
</span></span><span style="display:flex;"><span>KEY <span style="color:#e6db74">`</span>IDX_HOST<span style="color:#e6db74">`</span> <span style="color:#f92672">(</span><span style="color:#e6db74">`</span>HOST<span style="color:#e6db74">`</span><span style="color:#f92672">)</span>,
</span></span><span style="display:flex;"><span>KEY <span style="color:#e6db74">`</span>IDX_LOGIN_TIME<span style="color:#e6db74">`</span> <span style="color:#f92672">(</span><span style="color:#e6db74">`</span>LOGIN_TIME<span style="color:#e6db74">`</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span> ENGINE<span style="color:#f92672">=</span>InnoDB COMMENT <span style="color:#e6db74">&#34;用户登录审计日志表&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查询授权SQL，复制查询出来的SQL语句，执行授权</span>
</span></span><span style="display:flex;"><span>mysql&gt; <span style="color:#66d9ef">select</span> concat<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;grant select,insert on mysql.audit_login to &#39;&#34;</span>,user,<span style="color:#e6db74">&#34;&#39;@&#39;&#34;</span>,host,<span style="color:#e6db74">&#34;&#39;;&#34;</span><span style="color:#f92672">)</span> grants_sql from mysql.user where user not in <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;mysql.session&#39;</span>,<span style="color:#e6db74">&#39;mysql.sys&#39;</span><span style="color:#f92672">)</span> and Super_priv<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;N&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 执行：</span>
</span></span><span style="display:flex;"><span>mysql&gt; set global init_connect<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;insert into mysql.audit_login(USER,HOST,DB,PROCESSLIST_ID) values(current_user(),substring_index(user(),&#39;@&#39;,-1),database(),connection_id());&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 配置参数文件：</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>mysqld<span style="color:#f92672">]</span> 
</span></span><span style="display:flex;"><span>init_connect<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;insert into mysql.audit_login(USER,HOST,DB,PROCESSLIST_ID) values(current_user(),substring_index(user(),&#39;@&#39;,-1),database(),connection_id());&#34;</span>;  <span style="color:#75715e">#DBA add</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 最后执行看看有没有数据：</span>
</span></span><span style="display:flex;"><span>mysql&gt; <span style="color:#66d9ef">select</span> * from mysql.audit_login;</span></span></code></pre></div></blockquote>
<hr>
<h2 id="主从跳过复制错误">主从跳过复制错误</h2>
<blockquote>
<ul>
<li>
<ol>
<li><a href="https://blog.51cto.com/arthur376/1969935" rel="external" target="_self">主从跳过复制错误</a></li>
</ol>
</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#75715e"># 停止复制
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> slave stop;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设定跳过一个事务
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SET</span> GLOBAL SQL_SLAVE_SKIP_COUNTER <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 重新开启复制
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span>slave start
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 这样就正常了，但是，当然还是要把数据修改上去
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span><span style="color:#66d9ef">update</span> <span style="color:#66d9ef">tables</span> <span style="color:#66d9ef">set</span> <span style="color:#960050;background-color:#1e0010">。。。。。。。</span></span></span></code></pre></div></blockquote>
<hr>
<h2 id="sql优化审核平台工具"><code>SQL</code>优化、审核平台工具</h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->安装<a href="https://guide.yearning.io/install.html" rel="external" target="_self"><code>Yearning</code></a><code>SQL</code>审核工具<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->默认账号/密码：<!-- raw HTML omitted --><code>admin/Yearning_admin</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install wget unzip
</span></span><span style="display:flex;"><span>$ wget -P /opt/src/ https://github.com/cookieY/Yearning/releases/download/v3.1.0/Yearning-v3.1.0-linux-amd64.zip  
</span></span><span style="display:flex;"><span>$ unzip -d /opt/yearning /opt/src/Yearning-v3.1.0-linux-amd64.zip  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;s/Port = &#34;</span>3306<span style="color:#e6db74">&#34;/Port = &#34;</span>16303<span style="color:#e6db74">&#34;/g&#34;</span> /opt/apps/yearning/conf.toml  
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;s/Password = &#39;xxxx&#39;/Password = &#39;p@ssw0rd&#39;/g&#34;</span> /opt/apps/yearning/conf.toml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ /bin/mysql -uroot <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> -S /opt/data/data_16303/mysql.sock <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> -p -e <span style="color:#e6db74">&#34;create database Yearning DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ bin/mysql -uroot <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> -S /opt/data/data_16303/mysql.sock <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> -p -e <span style="color:#e6db74">&#34;grant all on *.* to root@&#39;127.0.0.1&#39; identified by &#34;</span>p@ssw0rd<span style="color:#e6db74">&#34;;&#34;</span>  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ./Yearning install  	<span style="color:#75715e"># 先初始化</span>
</span></span><span style="display:flex;"><span>$ ./Yearning run
</span></span><span style="display:flex;"><span>$ ./Yearning run --push <span style="color:#e6db74">&#34;域名、或者IP地址&#34;</span> --port <span style="color:#e6db74">&#34;8000&#34;</span>  	<span style="color:#75715e"># 指定域名端口方式启动</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->安装美团<code>SQL</code>优化工具<a href="https://github.com/Meituan-Dianping/SQLAdvisor/blob/master/doc/QUICK_START.md" rel="external" target="_self"><code>SQL-Advisor</code></a><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><a href="https://segmentfault.com/a/1190000022883633" rel="external" target="_self"><code>MySQL-SQLAdvisor</code>的简单安装使用</a></li>
<li><a href="https://tech.meituan.com/2017/03/09/sqladvisor-pr.html" rel="external" target="_self">美团点评<code>SQL</code>优化工具<code>SQLAdvisor</code>开源</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install git wget cmake libaio-devel libffi-devel glib2 glib2-devel  
</span></span><span style="display:flex;"><span>$ yum -y install --enablerepo<span style="color:#f92672">=</span>Percona56 Percona-Server-shared-56  
</span></span><span style="display:flex;"><span>$ git clone https://github.com/Meituan-Dianping/SQLAdvisor.git /opt/src/sqladvisor  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cd /opt/src/sqladvisor
</span></span><span style="display:flex;"><span>$ cmake -DBUILD_CONFIG<span style="color:#f92672">=</span>mysql_release <span style="color:#ae81ff">\ </span>
</span></span><span style="display:flex;"><span> -DCMAKE_BUILD_TYPE<span style="color:#f92672">=</span>debug <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> -DCMAKE_INSTALL_PREFIX<span style="color:#f92672">=</span>/usr/local/sqlparser ./
</span></span><span style="display:flex;"><span>$ make <span style="color:#f92672">&amp;&amp;</span> make install
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1. DCMAKE_INSTALL_PREFIX为sqlparser库文件和头文件的安装目录，其中lib目录包含库文件libsqlparser.so，include目录包含所需的所有头文件。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2. DCMAKE_INSTALL_PREFIX值尽量不要修改，后面安装依赖这个目录。  </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cd SQLAdvisor/sqladvisor/
</span></span><span style="display:flex;"><span>$ cmake -DCMAKE_BUILD_TYPE<span style="color:#f92672">=</span>debug ./
</span></span><span style="display:flex;"><span>$ make
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在本路径下生成一个sqladvisor可执行文件，这即是我们想要</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;sql.cnf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[sqladvisor]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">username=xx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">password=xx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">host=xx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">port=xx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">dbname=xx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># sqls=sql1;sql2;sql3....
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cmd: ./sqladvisor -f sql.cnf  -v 1</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><a href="https://www.justdojava.com/2021/07/20/canal/" rel="external" target="_self">监听<code>MySQL binlog</code>实现数据变化后的实时通知</a></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><a href="https://github.com/alibaba/canal" rel="external" target="_self"><code>Github Alibaba Canal</code></a></li>
</ul>
</blockquote>
<ul>
<li>
<ol start="4">
<li><code>explain</code><!-- raw HTML omitted -->的使用<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><a href="https://developer.aliyun.com/article/1104750#slide-12" rel="external" target="_self"><code>Mysql</code>优化高级篇</a></li>
<li><code>explain</code>+<code>sql</code>语句</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">explain</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> Tables_name;</span></span></code></pre></div><blockquote>
<ul>
<li><code>id</code>：表的读取顺序</li>
<li><code>select_type</code>：数据读取操作的操作类型</li>
<li><code>possible_keys</code>：哪些索引可以使用</li>
<li><code>key</code>：哪些索引被实际使用</li>
<li><code>ref</code>：表之间的引用</li>
<li><code>rows</code>：每张表有多少行被优化器查询</li>
</ul>
</blockquote>
</blockquote>
<ul>
<li>
<ol start="5">
<li><code>SQL</code>审计</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><a href="https://www.jianshu.com/p/513b7c95e1e8" rel="external" target="_self"><code>MySQL</code>审计插件介绍</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 进入数据库安装审计插件</span>
</span></span><span style="display:flex;"><span>mysql&gt; INSTALL PLUGIN server_audit SONAME <span style="color:#e6db74">&#39;server_audit.so&#39;</span>;
</span></span><span style="display:flex;"><span>Query OK, <span style="color:#ae81ff">0</span> rows affected <span style="color:#f92672">(</span>0.07 sec<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql&gt; show plugins;
</span></span><span style="display:flex;"><span>+----------------------------+--------+--------------------+-----------------+---------+
</span></span><span style="display:flex;"><span>| Name                       | Status | Type               | Library         | License |
</span></span><span style="display:flex;"><span>+----------------------------+--------+--------------------+-----------------+---------+
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>| SERVER_AUDIT               | ACTIVE | AUDIT              | server_audit.so | GPL     |
</span></span><span style="display:flex;"><span>+----------------------------+--------+--------------------+-----------------+---------+
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看 audit 初始参数配置</span>
</span></span><span style="display:flex;"><span>mysql&gt; show variables like <span style="color:#e6db74">&#39;%audit%&#39;</span>;
</span></span><span style="display:flex;"><span>+-------------------------------+-----------------------+
</span></span><span style="display:flex;"><span>| Variable_name                 | Value                 |
</span></span><span style="display:flex;"><span>+-------------------------------+-----------------------+
</span></span><span style="display:flex;"><span>| server_audit_events           |                       |
</span></span><span style="display:flex;"><span>| server_audit_excl_users       |                       |
</span></span><span style="display:flex;"><span>| server_audit_file_path        | server_audit.log      |
</span></span><span style="display:flex;"><span>| server_audit_file_rotate_now  | OFF                   |
</span></span><span style="display:flex;"><span>| server_audit_file_rotate_size | <span style="color:#ae81ff">1000000</span>               |
</span></span><span style="display:flex;"><span>| server_audit_file_rotations   | <span style="color:#ae81ff">9</span>                     |
</span></span><span style="display:flex;"><span>| server_audit_incl_users       |                       |
</span></span><span style="display:flex;"><span>| server_audit_loc_info         |                       |
</span></span><span style="display:flex;"><span>| server_audit_logging          | OFF                   |
</span></span><span style="display:flex;"><span>| server_audit_mode             | <span style="color:#ae81ff">1</span>                     |
</span></span><span style="display:flex;"><span>| server_audit_output_type      | file                  |
</span></span><span style="display:flex;"><span>| server_audit_query_log_limit  | <span style="color:#ae81ff">1024</span>                  |
</span></span><span style="display:flex;"><span>| server_audit_syslog_facility  | LOG_USER              |
</span></span><span style="display:flex;"><span>| server_audit_syslog_ident     | mysql-server_auditing |
</span></span><span style="display:flex;"><span>| server_audit_syslog_info      |                       |
</span></span><span style="display:flex;"><span>| server_audit_syslog_priority  | LOG_INFO              |
</span></span><span style="display:flex;"><span>+-------------------------------+-----------------------+
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在线开启审计</span>
</span></span><span style="display:flex;"><span>mysql&gt; set global server_audit_logging<span style="color:#f92672">=</span>on;
</span></span><span style="display:flex;"><span>Query OK, <span style="color:#ae81ff">0</span> rows affected <span style="color:#f92672">(</span>0.00 sec<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql&gt; set global server_audit_events<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;connect,table,query_ddl,query_dcl,query_dml_no_select&#39;</span>;
</span></span><span style="display:flex;"><span>Query OK, <span style="color:#ae81ff">0</span> rows affected <span style="color:#f92672">(</span>0.00 sec<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql&gt; set global server_audit_file_path <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/data/mysql/logs/server_audit.log&#39;</span>;
</span></span><span style="display:flex;"><span>Query OK, <span style="color:#ae81ff">0</span> rows affected <span style="color:#f92672">(</span>0.00 sec<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql&gt; set global server_audit_file_rotate_size<span style="color:#f92672">=</span>104857600;
</span></span><span style="display:flex;"><span>Query OK, <span style="color:#ae81ff">0</span> rows affected <span style="color:#f92672">(</span>0.01 sec<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># [mysqld]下添加以下配置 使得永久生效</span>
</span></span><span style="display:flex;"><span>server_audit<span style="color:#f92672">=</span>FORCE_PLUS_PERMANENT
</span></span><span style="display:flex;"><span>server_audit_logging<span style="color:#f92672">=</span>ON
</span></span><span style="display:flex;"><span>server_audit_file_path<span style="color:#f92672">=</span>/data/mysql/logs/server_audit.log         
</span></span><span style="display:flex;"><span>server_audit_events<span style="color:#f92672">=</span>connect,table,query_ddl,query_dcl,query_dml_no_select
</span></span><span style="display:flex;"><span>server_audit_file_rotate_size<span style="color:#f92672">=</span><span style="color:#ae81ff">104857600</span></span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_mysql">Install_Mysql</h1>

<h2 id="部署mysql-57">部署<code>Mysql 5.7</code></h2>
<blockquote>
<ul>
<li><a href="https://www.cnblogs.com/lyhabc/p/6136227.html" rel="external" target="_self">从0开始搭建<code>SQL Server AlwaysOn</code>第四篇-配置异地机房节点</a></li>
<li><a href="https://downloads.mysql.com/archives/" rel="external" target="_self"><code>Mysql</code>产品档案</a></li>
</ul>
</blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->安装扩展下载<code>Mysql</code>并解压安装包<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># Debian系统</span>
</span></span><span style="display:flex;"><span>$ sudo apt-get install build-essential cmake bison libncurses5-dev libssl-dev pkg-config g++ libaio1 libnuma1 libncurses5
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CentOS </span>
</span></span><span style="display:flex;"><span>$ yum -y remove mariadb* mariadb
</span></span><span style="display:flex;"><span>$ yum -y install numactl libaio* wget git epel-release
</span></span><span style="display:flex;"><span>$ yum -y install  https://mirrors.cloud.tencent.com/percona/release/7/RPMS/noarch/percona-release-0.1-4.noarch.rpm
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;s/gpgcheck = 1/gpgcheck = 0/g&#34;</span> /etc/yum.repos.d/percona-release.repo
</span></span><span style="display:flex;"><span>$ yum -y install percona-xtrabackup-24 qpress
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ wget -P /usr/local/src/ https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.28-linux-glibc2.12-x86_64.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ tar -zxvf /usr/local/src/mysql-5.7.28-linux-glibc2.12-x86_64.tar.gz -C /usr/local/src/
</span></span><span style="display:flex;"><span>$ cp -r /usr/local/src/mysql-5.7.28-linux-glibc2.12-x86_64 /usr/local/mysql</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->设置权限<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ groupadd mysql
</span></span><span style="display:flex;"><span>$ useradd -r -g mysql mysql
</span></span><span style="display:flex;"><span>$ cd /usr/local/
</span></span><span style="display:flex;"><span>$ chown -R mysql:mysql ./mysql</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->初始化数据库<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /usr/local/mysql/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ bin/mysqld --initialize --user<span style="color:#f92672">=</span>mysql --basedir<span style="color:#f92672">=</span>/usr/local/mysql --datadir<span style="color:#f92672">=</span>/usr/local/mysql/data
</span></span><span style="display:flex;"><span>$ bin/mysql_ssl_rsa_setup --datadir<span style="color:#f92672">=</span>/usr/local/mysql/data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ chown -R mysql:mysql /usr/local/mysql</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->修改配置文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mysqld --verbose --help  	<span style="color:#75715e"># 查看完整列表</span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;[mysqld]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">character_set_server=utf8
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">init_connect=&#39;</span>SET NAMES utf8<span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">basedir=/usr/local/mysql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">datadir=/usr/local/mysql/data  	# 数据目录最好外挂
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">socket=/tmp/mysql.sock
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 开启binlog
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">log-bin = mysql-bin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">binlog_format = ROW
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">expire_logs_days = 7
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">server-id=3306110  	# 端口加本机IP最后几位
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 不区分大小写 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">lower_case_table_names = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 不开启sql严格模式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sql_mode = &#34;STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">log-error=/usr/local/mysql/data/mysqld.log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">pid-file=/usr/local/mysql/data/mysqld.pid&#39;</span> &gt; /etc/my.cnf</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->修改启动文件配置参数并启动数据库<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mysqlconf<span style="color:#f92672">=</span>/etc/init.d/mysqld
</span></span><span style="display:flex;"><span>$ cp /usr/local/mysql/support-files/mysql.server  $mysqlconf
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;46s,basedir=,basedir=/usr/local/mysql,&#39;</span> $mysqlconf
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;47s,datadir=,datadir=/usr/local/mysql/data,&#39;</span> $mysqlconf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动数据库</span>
</span></span><span style="display:flex;"><span>$ service mysqld start
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 添加软连接</span>
</span></span><span style="display:flex;"><span>$ ln -s /usr/local/mysql/bin/mysql /usr/bin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看端口号</span>
</span></span><span style="display:flex;"><span>$ netstat -nuplt | grep :3306
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 防火墙开放端口</span>
</span></span><span style="display:flex;"><span>$ firewall-cmd --permanent --new-ipset<span style="color:#f92672">=</span>db_whitelist --type<span style="color:#f92672">=</span>hash:ip  
</span></span><span style="display:flex;"><span>$ firewall-cmd --permanent --add-rich-rule<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;rule family=&#39;ipv4&#39; source ipset=&#39;db_whitelist&#39; port port=&#39;16303&#39; protocol=&#39;tcp&#39; accept&#34;</span>  
</span></span><span style="display:flex;"><span>$ firewall-cmd --reload</span></span></code></pre></div></blockquote>
<hr>
<h2 id="安装mysql-8">安装<code>Mysql 8</code></h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->安装扩展下载<code>Mysql</code>并解压安装包<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y remove mariadb* mariadb
</span></span><span style="display:flex;"><span>$ yum -y install ncurses-compat-libs wget git epel-release
</span></span><span style="display:flex;"><span>$ yum -y install  https://mirrors.cloud.tencent.com/percona/release/7/RPMS/noarch/percona-release-0.1-4.noarch.rpm
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;s/gpgcheck = 1/gpgcheck = 0/g&#34;</span> /etc/yum.repos.d/percona-release.repo
</span></span><span style="display:flex;"><span>$ yum -y install percona-xtrabackup-24 qpress numactl libaio*
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ wget -P /usr/local/src/ https://dev.mysql.com/get/Downloads/MySQL-8.0/mysql-8.0.21-linux-glibc2.12-x86_64.tar.xz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ mkdir -p /usr/local/mysql <span style="color:#f92672">&amp;&amp;</span> tar -xvf /usr/local/src/mysql-8.0.21-linux-glibc2.12-x86_64.tar.xz -C /usr/local/mysql --strip-components <span style="color:#ae81ff">1</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->设置权限<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ groupadd mysql
</span></span><span style="display:flex;"><span>$ useradd -r -g mysql mysql
</span></span><span style="display:flex;"><span>$ cd /usr/local/
</span></span><span style="display:flex;"><span>$ chown -R mysql:mysql ./mysql</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->初始化数据库<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /usr/local/mysql/bin/mysqld --initialize --user<span style="color:#f92672">=</span>mysql --basedir<span style="color:#f92672">=</span>/usr/local/mysql --datadir<span style="color:#f92672">=</span>/usr/local/mysql/data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ /usr/local/mysql/bin/mysql_ssl_rsa_setup --datadir<span style="color:#f92672">=</span>/usr/local/mysql/data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ /usr/local/mysql/bin/mysqld_safe --datadir<span style="color:#f92672">=</span>/usr/local/mysql/data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ chown -R mysql:mysql /usr/local/mysql </span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->修改配置文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;[mysqld]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">character_set_server=utf8mb4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">init_connect=&#39;</span>SET NAMES utf8<span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">basedir=/usr/local/mysql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">datadir=/usr/local/mysql/data
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">socket=/tmp/mysql.sock
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 开启binlog
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">log-bin = mysql-bin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">binlog_format = ROW
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">expire_logs_days = 7
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">server-id=3306110  	# 端口加本机IP最后几位
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 不区分大小写 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">lower_case_table_names = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 不开启sql严格模式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## sql_mode = &#34;STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sql_mode=&#39;</span>STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION<span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">default_authentication_plugin= mysql_native_password
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">log-error=/var/log/mysqld.log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">pid-file=/usr/local/mysql/data/mysqld.pid&#39;</span> &gt;/etc/my.cnf</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->修改启动文件配置参数并启动数据库<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mysqlconf<span style="color:#f92672">=</span>/etc/init.d/mysqld
</span></span><span style="display:flex;"><span>$ cp /usr/local/mysql/support-files/mysql.server $mysqlconf
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;46s,basedir=,basedir=/usr/local/mysql,&#39;</span> $mysqlconf
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;47s,datadir=,datadir=/usr/local/mysql/data,&#39;</span> $mysqlconf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动数据库</span>
</span></span><span style="display:flex;"><span>$ service mysqld start
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 添加软连接</span>
</span></span><span style="display:flex;"><span>$ ln -s /usr/local/mysql/bin/mysql /usr/bin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看端口号</span>
</span></span><span style="display:flex;"><span>$ netstat -nuplt | grep :3306
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 防火墙开放端口</span>
</span></span><span style="display:flex;"><span>$ firewall-cmd --permanent --new-ipset<span style="color:#f92672">=</span>db_whitelist --type<span style="color:#f92672">=</span>hash:ip  
</span></span><span style="display:flex;"><span>$ firewall-cmd --permanent --add-rich-rule<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;rule family=&#39;ipv4&#39; source ipset=&#39;db_whitelist&#39; port port=&#39;16303&#39; protocol=&#39;tcp&#39; accept&#34;</span>  
</span></span><span style="display:flex;"><span>$ firewall-cmd --reload</span></span></code></pre></div></blockquote>
<hr>
<h2 id="普通用户部署mysql-8">普通用户部署<code>Mysql 8</code></h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->安装扩展<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># Linux8/Red Hat8(EL8)：这些平台默认不安装文件/lib64/libtinfo.so.5，MySQL客户端bin/mysql需要该文件来安装</span>
</span></span><span style="display:flex;"><span>$ yum -y install ncurses-compat-libs wget git epel-release
</span></span><span style="display:flex;"><span>$ yum -y install  http://www.percona.com/downloads/percona-release/redhat/0.1-4/percona-release-0.1-4.noarch.rpm  
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;s/gpgcheck = 1/gpgcheck = 0/g&#34;</span> /etc/yum.repos.d/percona-release.repo
</span></span><span style="display:flex;"><span>$ yum -y install percona-xtrabackup-24 qpress numactl libaio*
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ wget -P /usr/local/src/ https://dev.mysql.com/get/Downloads/MySQL-8.0/mysql-8.0.21-linux-glibc2.12-x86_64.tar.xz</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->创建用户以及程序使用目录<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ groupadd myadmin <span style="color:#f92672">&amp;&amp;</span> useradd -g myadmin myadmin  	<span style="color:#75715e"># 创建程序运行用户  </span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;password&#34;</span>|passwd --stdin myadmin &amp;&gt;/dev/null
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ mkdir -p /opt/<span style="color:#f92672">{</span>apps,conf,src,backup,scripts,data，logs<span style="color:#f92672">}</span> /opt/data/<span style="color:#f92672">{</span>data_16303,data_16304<span style="color:#f92672">}</span> /opt/logs/mysql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$echo <span style="color:#e6db74">&#34;#####  Start/Stop Service  #####
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Cmnd_Alias MYADMIN_START_SERVICES = /etc/init.d/mysql, /etc/init.d/mysql.server, /opt/*  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">swadmin ALL=(ALL)NOPASSWD:MYADMIN_START_SERVICES &#34;</span>&gt;/etc/sudoers.d/myadmin  
</span></span><span style="display:flex;"><span>$ chmod <span style="color:#ae81ff">660</span> /etc/sudoers.d/myadmin  </span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->编写配置文件，方便使用配置文件初始化数据库<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;[mysqld]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">character_set_server=utf8mb4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">init_connect=&#39;</span>SET NAMES utf8<span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">basedir=/opt/apps/mysql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">datadir=/opt/data/data_16303
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">socket=/tmp/mysql.sock
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 不区分大小写 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">lower_case_table_names = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 不开启sql严格模式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># sql_mode = &#34;STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">log-error=/opt/logs/mysql/mysqld.log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">pid-file=/opt/data/data_16303/mysqld.pid&#39;</span> &gt; /opt/conf/mysql/mysql_master_16303.cnf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ chown -R myadmin:myadmin /opt/*</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->使用普通用户下载安装<code>Mysql 8</code><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ su myadmin -c <span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">wget -P /opt/src/ https://dev.mysql.com/get/Downloads/MySQL-8.0/mysql-8.0.21-linux-glibc2.12-x86_64.tar.xz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">mkdir -p /opt/apps/mysql &amp;&amp; tar xvf /opt/src/mysql-8.0.21-linux-glibc2.12-x86_64.tar.xz -C /opt/apps/mysql --strip-components 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">chmod 750 /opt/apps/mysql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/opt/apps/mysql/bin/mysqld --defaults-file=/opt/conf/mysql/my.cnf --initialize-insecure --user=myadmin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sleep 8
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/opt/apps/mysql/bin/mysql_ssl_rsa_setup --defaults-file=/opt/conf/mysql/my.cnf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sleep 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/opt/apps/mysql/bin/mysqld_safe --defaults-file=/opt/conf/mysql/my.cnf --user=myadmin &amp;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sleep 8
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->修改启动文件配置参数并启动数据库<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mysqlconf<span style="color:#f92672">=</span>/etc/init.d/mysqld
</span></span><span style="display:flex;"><span>$ cp /opt/apps/mysql/support-files/mysql.serverr $mysqlconf
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;46s,basedir=,basedir=/opt/apps/mysql,&#39;</span> $mysqlconf
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;47s,datadir=,datadir=/opt/data/data_16303,&#39;</span> $mysqlconf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;alias nginx=&#39;sudo /etc/init.d/nginx&#39;  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">alias tomcat=&#39;sudo /etc/init.d/tomcat&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">alias mysqld=&#39;sudo /etc/init.d/mysqld&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">alias redis=&#39;sudo /etc/init.d/redis&#39; &#34;</span>&gt;&gt;/home/myadmin/.bashrc
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动数据库</span>
</span></span><span style="display:flex;"><span>$ service mysqld start
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 添加软连接</span>
</span></span><span style="display:flex;"><span>$ ln -s /usr/local/mysql/bin/mysql /usr/bin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看端口号</span>
</span></span><span style="display:flex;"><span>$ netstat -nuplt | grep :3306
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 防火墙开放端口</span>
</span></span><span style="display:flex;"><span>$ firewall-cmd --permanent --new-ipset<span style="color:#f92672">=</span>db_whitelist --type<span style="color:#f92672">=</span>hash:ip  
</span></span><span style="display:flex;"><span>$ firewall-cmd --permanent --add-rich-rule<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;rule family=&#39;ipv4&#39; source ipset=&#39;db_whitelist&#39; port port=&#39;16303&#39; protocol=&#39;tcp&#39; accept&#34;</span>  
</span></span><span style="display:flex;"><span>$ firewall-cmd --reload</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          </section>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="email">Email</h1>


            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Email</h1>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_iredmail">Install_iRedMail</h1>

<h2 id="ireadmail"><code>iReadMail</code></h2>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->服务器必须开通端口<!-- raw HTML omitted --><code>25</code></li>
<li><!-- raw HTML omitted -->硬件要求内存最少<!-- raw HTML omitted --><code>4G</code></li>
<li><!-- raw HTML omitted -->确保服务器中<!-- raw HTML omitted --><code>UID/GID</code><!-- raw HTML omitted -->没有使用<!-- raw HTML omitted --><code>2000、2001、2002</code></li>
<li><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>dig</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo apt-get install dnsutils
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ yum install bind-utils  </span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->确认服务器是否支持<!-- raw HTML omitted --><code>PTR Pointer Records</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ dig -x ip地址
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo nslookup set type<span style="color:#f92672">=</span>PTR ip地址</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol>
<li><a href="https://docs.iredmail.org/install.iredmail.on.debian.ubuntu.html#system-requirements" rel="external" target="_self">安装前准备、安装文档</a></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>设置主机名</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo hostnamectl set-hostname email_name</span></span></code></pre></div><ul>
<li>添加到<code>hosts</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/hosts<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">127.0.1.1	email.domain.com email
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ hostname <span style="color:#f92672">&amp;&amp;</span> hostname -f  	<span style="color:#75715e">#  确认是否修改</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li>下载安装包安装<code>iRedMail</code>服务</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo apt-get install -y gzip dialog  	<span style="color:#75715e"># 安装所需安装包</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ wget https://github.com/iredmail/iRedMail/archive/refs/tags/1.6.8.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ tar zxvf 1.6.8.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cd /opt/email/iRedMail-1.6.8/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo bash iRedMail.sh</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li>图形安装提示</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>欢迎并感谢您的使用</li>
</ul>
<p><a href="#R-image-d2267caf1d231098f5a1407f9d0dcd0c" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Email_Server/iRedMail/Snipaste_2024-03-27_18-40-52.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-d2267caf1d231098f5a1407f9d0dcd0c"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Email_Server/iRedMail/Snipaste_2024-03-27_18-40-52.png"></a></p>
<ul>
<li>
<p>指定存储所有邮箱的位置。默认为<code>/var/vmail/</code></p>
</li>
<li>
<p>是否使用<code>Web</code>服务</p>
</li>
</ul>
<p><a href="#R-image-da6d2cb0bb274a19ba597f819cae64ba" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Email_Server/iRedMail/Snipaste_2024-03-27_18-44-47.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-da6d2cb0bb274a19ba597f819cae64ba"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Email_Server/iRedMail/Snipaste_2024-03-27_18-44-47.png"></a></p>
<ul>
<li>选择安装数据库</li>
</ul>
<p><a href="#R-image-cb00dac67ca3898c9aaa0ed30e271293" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Email_Server/iRedMail/Snipaste_2024-03-27_18-46-17.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-cb00dac67ca3898c9aaa0ed30e271293"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Email_Server/iRedMail/Snipaste_2024-03-27_18-46-17.png"></a></p>
<ul>
<li>设置数据库密码</li>
</ul>
<p><a href="#R-image-a9c83e91aecd3201ff044469cdb2b5d9" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Email_Server/iRedMail/Snipaste_2024-03-27_18-48-13.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-a9c83e91aecd3201ff044469cdb2b5d9"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Email_Server/iRedMail/Snipaste_2024-03-27_18-48-13.png"></a></p>
<ul>
<li>添加您的第一个邮件域名</li>
</ul>
<p><a href="#R-image-7f98dd26cc83533003a1f826bb3dcb2e" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Email_Server/iRedMail/Snipaste_2024-03-27_18-49-34.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-7f98dd26cc83533003a1f826bb3dcb2e"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Email_Server/iRedMail/Snipaste_2024-03-27_18-49-34.png"></a></p>
<ul>
<li>创建管理员密码</li>
</ul>
<p><a href="#R-image-74294d247b806f77001717e6b0ea9fc7" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Email_Server/iRedMail/Snipaste_2024-03-27_18-51-25.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-74294d247b806f77001717e6b0ea9fc7"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Email_Server/iRedMail/Snipaste_2024-03-27_18-51-25.png"></a></p>
<ul>
<li>选择组件</li>
</ul>
<p><a href="#R-image-4c608c2fb79d68e08bc1fce8b014caa5" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Email_Server/iRedMail/Snipaste_2024-03-27_18-55-06.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-4c608c2fb79d68e08bc1fce8b014caa5"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Email_Server/iRedMail/Snipaste_2024-03-27_18-55-06.png"></a></p>
<ul>
<li>确认选项是否无误，</li>
</ul>
<p><a href="#R-image-2286d8ba2e8ed7c689c7e4e66ecb5a9f" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Email_Server/iRedMail/Snipaste_2024-03-27_18-56-22.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-2286d8ba2e8ed7c689c7e4e66ecb5a9f"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Email_Server/iRedMail/Snipaste_2024-03-27_18-56-22.png"></a></p>
<ul>
<li><code>web</code>访问地址以及用户名密码</li>
</ul>
<blockquote>
<ul>
<li><a href="https://email.domain.com/mail/" rel="external" target="_self">**<code>Roundcube</code>**网络邮件登录地址</a></li>
<li><a href="https://your_server/SOGo" rel="external" target="_self">**<code>SOGo</code>**组件</a></li>
<li><a href="https://your_server/iredadmin/" rel="external" target="_self">网络后台管理面板**<code>iRedAdmin</code>**</a></li>
<li><a href="https://email.domain.com/netdata/" rel="external" target="_self">**<code>netdata</code>**数据状态监控</a></li>
<li>用户名：<code>postmaster@domain.com</code></li>
<li>密码：<code>password</code></li>
</ul>
</blockquote>
</blockquote>
<ul>
<li>
<ol start="4">
<li>优化配置项</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->建议您获取<!-- raw HTML omitted --><code>SSL</code><!-- raw HTML omitted -->证书，<!-- raw HTML omitted -->以避免在通过<code>HTTPS/IMAPS/POP3/SMTPS</code>访问邮箱时在<code>Web</code>浏览器或邮件客户端中出现烦人的警告消息</li>
<li><!-- raw HTML omitted -->禁用<!-- raw HTML omitted --><code>iRedMail</code><!-- raw HTML omitted -->灰名单<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/iredapd/settings.py<span style="color:#e6db74">&lt;&lt;-EOF  	# 必须root 用户
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">plugins = [&#34;reject_null_sender&#34;, &#34;wblist_rdns&#34;, &#34;reject_sender_login_mismatch&#34;, &#34;greylisting&#34;, &#34;throttle&#34;, &#34;amavisd_wblist&#34;, &#34;sql_alias_access_policy&#34;, &#34;sql_ml_access_policy&#34;]  	# 删除：greylisting 选项
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo systemctl restart iredapd</span></span></code></pre></div><blockquote>
<ul>
<li><!-- raw HTML omitted -->解析<!-- raw HTML omitted --><code>A</code><!-- raw HTML omitted -->记录，<!-- raw HTML omitted -->解析名为：<code>email</code>，  解析值为：<code>iRedMail</code>服务所在的服务器<code>IP</code></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->检测<!-- raw HTML omitted --><code>A</code><!-- raw HTML omitted -->记录：<!-- raw HTML omitted --><code>nslookup email.domain.com</code>  	# 更换：<code>domain.com</code>为对应域名</li>
</ul>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->添加<!-- raw HTML omitted --><code>MX</code><!-- raw HTML omitted -->记录，<!-- raw HTML omitted -->解析名为：<code>@</code>，优先级值为：<code>10</code>，解析值为：<code>email.domain.com</code></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->检测<!-- raw HTML omitted --><code>MX</code><!-- raw HTML omitted -->记录：<!-- raw HTML omitted --><code>nslookup -type=mx domain.com</code></li>
</ul>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->设置<!-- raw HTML omitted --><code>SPF</code><!-- raw HTML omitted -->记录，<!-- raw HTML omitted -->选择：<code>TXT</code>，解析名为：<code>@</code>，解析值为：<code>v=spf1 mx ~all</code></li>
</ul>
<blockquote>
<p><!-- raw HTML omitted -->检测<!-- raw HTML omitted --><code>SPF</code><!-- raw HTML omitted -->记录：<!-- raw HTML omitted --><code>nslookup -type=txt domain.com</code></p>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->设置<!-- raw HTML omitted --><code>DKIM</code><!-- raw HTML omitted -->记录<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>查看安装包文件，复制过滤字段下方记录，<!-- raw HTML omitted -->去掉括号：<!-- raw HTML omitted --><code>()</code>，和<!-- raw HTML omitted -->双引号：<!-- raw HTML omitted --><code>&quot;&quot;</code>，<!-- raw HTML omitted -->使其变为一行<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat /opt/email/iRedMail-1.6.8/iRedMail.tips | grep -C <span style="color:#ae81ff">8</span> dkim._domainkey</span></span></code></pre></div><p>选择：<code>TXT</code>，解析值为：<code>dkim._domainkey</code>，解析值为：<code>v=DKIM1; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA5gFOvR/IiKwqxWeVQXSpWppiW/Gezd3Kgt3JlvhZTL2KI+Za4pSKcaQqkNH9aM5dyAZHYHLKkeVoD5tgaHvBZRaoKN8erL2X2xOfRbkLFpiqpHfgPZB0ADssuCHSK+pGgSz3tVUus9sGaXR7WZoWL50McJnfEKM74dYqhwJ+/EcLsabprKaV+C60TaQS8gqnDfOh4B5dE7B5sPEE/kG23qHGYQhYbIU2LDV1BFgjanJkMbZSNhah2OmQPnXPq4MshaQx1Xld8iLSyKna6KV9Tsi+MIiXSdCM2zoRx5wN4X4i//gNX4jHgaQ56RhSkEybGDCS+g+0oQvDE7XOj6vbHQIDAQAB</code></p>
<ul>
<li><!-- raw HTML omitted -->检测<!-- raw HTML omitted --><code>DKIM</code><!-- raw HTML omitted -->记录：<!-- raw HTML omitted --><code>nslookup -type=txt dkim._domainkey.domain.com</code></li>
</ul>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->设置<!-- raw HTML omitted --><code>DMARC</code><!-- raw HTML omitted -->记录，<!-- raw HTML omitted -->选择：<code>TXT</code>，解析名为：<code>_dmarc</code>，解析值为：<code>v=DMARC1; p=none; pct=100; rua=mailto:dmarc@domain.com</code>，<code>domain.com</code>换成对应域名</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->检测<!-- raw HTML omitted --><code>DMARC</code><!-- raw HTML omitted -->记录：<!-- raw HTML omitted --><code>nslookup -type=txt _dmarc.domain.com</code></li>
</ul>
</blockquote>
</blockquote>
</blockquote>
<ul>
<li>
<ol start="5">
<li>添加<code>iRedMail</code>用户</li>
</ol>
</li>
</ul>
<blockquote>
</blockquote>
<ul>
<li>
<ol start="6">
<li>测试<code>iRedMail</code>邮件服务</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><a href="https://www.mail-tester.com/" rel="external" target="_self">测试邮件垃圾匹配度</a></li>
</ul>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          </section>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="firewalld">Firewalld</h1>


            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Firewalld</h1>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="use_firewalld">Use_Firewalld</h1>

<h2 id="配置防火墙">配置防火墙</h2>
<h3 id="配置firewalld防火墙">配置<code>Firewalld</code>防火墙</h3>
<ul>
<li>
<ol>
<li><code>Linux</code><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>Firewalld</code><!-- raw HTML omitted -->防火墙的路由转发<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><a href="https://blog.csdn.net/github_36904248/article/details/82012579" rel="external" target="_self"><code>CentOS7</code>下<code>firewall</code>的<code>ipset</code>配置使用详解</a></li>
<li><a href="https://blog.csdn.net/qianye_111/article/details/78987161" rel="external" target="_self"><code>CentOS7</code>开启路由转发</a></li>
<li>常见失败原因：<!-- raw HTML omitted -->电脑本身没有开启虚拟化支持，需要在重启时进入BIOS里设置</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 临时开启路由转发</span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;1&#34;</span> &gt; /proc/sys/net/ipv4/ip_forward
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 永久开启路由转发</span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;net.ipv4.ip_forward = 1&#34;</span> &gt;&gt;/etc/sysctl.conf
</span></span><span style="display:flex;"><span>$ sysctl -p  	<span style="color:#75715e"># 加载一下</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sysctl -a |grep <span style="color:#e6db74">&#34;ip_forward&#34;</span>  	<span style="color:#75715e"># 查看一下</span>
</span></span><span style="display:flex;"><span>net.ipv4.ip_forward <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>net.ipv4.ip_forward_use_pmtu <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>Linux</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>Firewalld</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>配置<!-- raw HTML omitted --><code>Firewalld</code><!-- raw HTML omitted -->转发<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 外网卡</span>
</span></span><span style="display:flex;"><span>$ firewall-cmd --permanent --zone<span style="color:#f92672">=</span>external --change-interface<span style="color:#f92672">=</span>eth0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 内网网卡</span>
</span></span><span style="display:flex;"><span>$ firewall-cmd --permanent --zone<span style="color:#f92672">=</span>internal --change-interface<span style="color:#f92672">=</span>eth1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># IP地址伪装</span>
</span></span><span style="display:flex;"><span>$ firewall-cmd --zone<span style="color:#f92672">=</span>external --add-masquerade --permanent
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ firewall-cmd --permanent --direct --passthrough ipv4 -t nat POSTROUTING -o eth0# 外网卡 -j MASQUERADE -s 192.168.100.0/24# 内网网段
</span></span><span style="display:flex;"><span>$ firewall-cmd --reload</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>Firewalld</code><!-- raw HTML omitted -->访问规则<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ firewall-cmd --add-service<span style="color:#f92672">={</span>http,https<span style="color:#f92672">}</span> --permanent
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ firewall-cmd --permanent --new-ipset<span style="color:#f92672">=</span>ssh_whitelist --type<span style="color:#f92672">=</span>hash:ip
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ firewall-cmd --permanent --add-rich-rule<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;rule family=&#39;ipv4&#39; source ipset=&#39;ssh_whitelist port port=&#39;22&#39; protocol=&#39;tcp&#39; accept&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ firewall-cmd --permanent --add-rich-rule<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;rule family=&#39;ipv4&#39; source ipset=&#39;redis_whitelist&#39; port port=&#39;17693-17695&#39; protocol=&#39;tcp&#39; accept&#34;</span>  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ firewall-cmd --permanent --add-rich-rule<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;rule family=&#39;ipv4&#39; source ipset=&#39;redis_whitelist&#39; port port=&#39;27693-27695&#39; protocol=&#39;tcp&#39; accept&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 重新载入配置</span>
</span></span><span style="display:flex;"><span>$ firewall-cmd --reload &gt;/dev/null
</span></span><span style="display:flex;"><span>$ systemctl status firewalld &gt;/dev/null 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看已经开放端口</span>
</span></span><span style="display:flex;"><span>$ firewallport<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>firewall-cmd --zone<span style="color:#f92672">=</span>public --list-ports<span style="color:#e6db74">`</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="配置iptables防火墙">配置<code>Iptables</code>防火墙</h3>
<ul>
<li>
<ol>
<li><code>Linux</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>Iptables</code><!-- raw HTML omitted -->配置规则<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>Iptables</code><!-- raw HTML omitted -->规则4表<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>filter(过滤规则表)</code><!-- raw HTML omitted -->：控制数据包是否允许进出及转发，可以控制的链路有<!-- raw HTML omitted --><code>INPUT</code>、<code>OUTPUT</code>和<code>FORWARD</code></li>
<li><code>nat(地址转换规则表)</code><!-- raw HTML omitted -->：控制数据包中地址转换，可以控制的链路有<!-- raw HTML omitted --><code>INPUT</code>、<code>OUTPUT</code>、<code>PREROUTING</code>和<code>POSTROUTING</code></li>
<li><code>mangle(修改数据标记位规则表)</code><!-- raw HTML omitted -->：修改数据包中的原数据，可以控制的链路有<!-- raw HTML omitted --><code>INPUT</code>、<code>OUTPUT</code>、<code>FORWARD</code>、<code>PREROUTING</code>和<code>POSTROUTING</code></li>
<li><code>raw(跟踪数据表规则表)</code>：控制<code>nat</code><!-- raw HTML omitted -->表中连接追踪机制的启用状况，可以控制的链路有<!-- raw HTML omitted --><code>OUTPUT</code>、<code>PREROUTING</code></li>
</ul>
</blockquote>
<ul>
<li><code>Iptables</code><!-- raw HTML omitted -->规则5链<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>INPUT</code><!-- raw HTML omitted -->(入站数据过滤链)<!-- raw HTML omitted --></li>
<li><code>OUTPUT</code><!-- raw HTML omitted -->(出站数据过滤链)<!-- raw HTML omitted --></li>
<li><code>FORWARD</code><!-- raw HTML omitted -->(转发数据过滤链)<!-- raw HTML omitted --></li>
<li><code>PREROUTING</code><!-- raw HTML omitted -->(路由前过滤链)<!-- raw HTML omitted --></li>
<li><code>POSTROUTING</code><!-- raw HTML omitted -->(路由后过滤链)<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->选项参数<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>选项/参数</th>
<th>具体作用</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-A</code></td>
<td>在规则链的末尾加入新规则</td>
</tr>
<tr>
<td><code>-D</code></td>
<td>删除某一条规则</td>
</tr>
<tr>
<td><code>-I</code></td>
<td>在规则链的头部加入新规则</td>
</tr>
<tr>
<td><code>-F</code></td>
<td>清空规则链</td>
</tr>
<tr>
<td><code>-L</code></td>
<td>查看规则链</td>
</tr>
<tr>
<td><code>-R</code></td>
<td>替换防火墙规则</td>
</tr>
<tr>
<td><code>-Z</code></td>
<td>清空防火墙数据表统计信息</td>
</tr>
<tr>
<td><code>-P</code></td>
<td>设置默认策略:<code>iptables -P INPUT (DROP</code></td>
</tr>
<tr>
<td><code>-p</code></td>
<td>匹配协议，! 表示取反</td>
</tr>
<tr>
<td><code>-s</code></td>
<td>匹配源地址</td>
</tr>
<tr>
<td><code>--sport</code></td>
<td>匹配源端口</td>
</tr>
<tr>
<td><code>--sports</code></td>
<td>匹配源端口</td>
</tr>
<tr>
<td><code>--src-range</code></td>
<td>匹配目标地址范围</td>
</tr>
<tr>
<td><code>-d</code></td>
<td>匹配目标地址</td>
</tr>
<tr>
<td><code>--dport</code></td>
<td>匹配目标端口</td>
</tr>
<tr>
<td><code>--dports</code></td>
<td>匹配目标端口</td>
</tr>
<tr>
<td><code>--dst-range</code></td>
<td>匹配目标地址范围</td>
</tr>
<tr>
<td><code>-i</code></td>
<td>匹配入站网卡接口</td>
</tr>
<tr>
<td><code>-o</code></td>
<td>匹配出站网卡接口</td>
</tr>
<tr>
<td><code>--limit</code></td>
<td>四配数据表速率</td>
</tr>
<tr>
<td><code>--mac-cource</code></td>
<td>匹配源<code>MAC</code>地址</td>
</tr>
<tr>
<td><code>--stste</code></td>
<td>匹配状态（INVALID、ESTABLISHED、NEW、RELATED)</td>
</tr>
<tr>
<td><code>--string</code></td>
<td>匹配应用层字串</td>
</tr>
<tr>
<td><code>-m comment --comment &quot;我是注释&quot;</code></td>
<td>添加注释</td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->触发规则<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>触发动作</th>
<th>更能</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ACCEPT</code></td>
<td>允许数据包通过</td>
</tr>
<tr>
<td><code>DROP</code></td>
<td>丢弃数据包</td>
</tr>
<tr>
<td><code>REJECT</code></td>
<td>拒绝数据包通过</td>
</tr>
<tr>
<td><code>LOG</code></td>
<td>将数据包信息记录<code>syslog</code>曰志</td>
</tr>
<tr>
<td><code>DNAT</code></td>
<td>目标地址转换</td>
</tr>
<tr>
<td><code>SNAT</code></td>
<td>源地址转换</td>
</tr>
<tr>
<td><code>MASQUERADE</code></td>
<td>地址欺骗</td>
</tr>
<tr>
<td><code>REDIRECT</code></td>
<td>重定向</td>
</tr>
</tbody>
</table>
</blockquote>
</blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->命令选项输入顺序<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>-t</code><!-- raw HTML omitted -->：后面跟4表中的表名<!-- raw HTML omitted --></li>
<li><code>-A/I/D/R</code><!-- raw HTML omitted -->：后面跟5链中的链名<!-- raw HTML omitted --></li>
<li><code>-i/o</code><!-- raw HTML omitted -->：跟网卡名<!-- raw HTML omitted --></li>
<li><code>-p</code><!-- raw HTML omitted -->：协议名：<!-- raw HTML omitted --><code>tcp/udp</code></li>
<li><code>-s</code><!-- raw HTML omitted -->：源<code>IP</code>/源子网<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ iptables -t：表名<span style="color:#f92672">(</span>filter/nat/mangle/raw<span style="color:#f92672">)</span> -A/I/D/R：规则链名<span style="color:#f92672">[</span>规则号<span style="color:#f92672">]</span> -i/o：网卡名 -p：协议名<span style="color:#f92672">(</span>tcp/udp<span style="color:#f92672">)</span> -s：源IP/源子网 --sport：源端口 -d：目标IP/目标子网 --dport：目标端口 -j 动作<span style="color:#f92672">(</span>ACCEPT/DROP/DNAT/SNAT/...<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ service iptables save
</span></span><span style="display:flex;"><span>$ systemctl reload iptables</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>Iptables</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>INPUT</code>规则</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>放行端口，如果需要针对<code>IP</code>限制加：<code>-s</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ iptables -A INPUT -p tcp -m tcp --dport <span style="color:#ae81ff">21</span> -j ACCEPT  	<span style="color:#75715e"># 开放21端口</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;/etc/sysconfig/iptables<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-A INPUT -p tcp -m tcp --dport 21 -j ACCEPT
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>放行多端口，如果需要针对<code>IP</code>限制加：<code>-s</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ iptables -A INPUT -p tcp -m multiport --dports 3306,6379 -j ACCEPT 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;/etc/sysconfig/iptables<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-A INPUT -p tcp -m multiport --dports 3306,6379 -j ACCEPT
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>放行<code>IP</code>网段</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ iptables -A INPUT -s 192.168.0.0/32 -j ACCEPT
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;/etc/sysconfig/iptables<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-A INPUT -s 192.168.0.0/32 -j ACCEPT
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
</blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>Iptables</code><!-- raw HTML omitted -->转发规则<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ iptables -P FORWARDACCEPT  	<span style="color:#75715e"># 缺省允许IP转发</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 利用iptables 实现nat MASQUERADE 共享上网</span>
</span></span><span style="display:flex;"><span>$ iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ iptables -t nat -A PREROUTING -p tcp --dport <span style="color:#ae81ff">6379</span> -j DNAT --to-destination 目标IP:目标端口
</span></span><span style="display:flex;"><span>$ iptables -t nat -A POSTROUTING -p tcp -d 目标IP --dport 目标端口 -j SNAT --to-source 源IP  	<span style="color:#75715e"># 源IP需和目标IP同一网段</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-A PREROUTING -p tcp -m tcp --dport 6379 -j DNAT --to-destination 目标IP:目标端口
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-A POSTROUTING -p tcp -d 目标IP -m tcp --dport 目标端口 -j SNAT --to-source 源IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看现有转发规则</span>
</span></span><span style="display:flex;"><span>$ iptables -t nat -L</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->清除、修改规则<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>修改规则</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 修改规则,1代表第一行</span>
</span></span><span style="display:flex;"><span>$ iptables -R INPUT <span style="color:#ae81ff">1</span> -s IP -p tcp --dport 端口 -j DROP</span></span></code></pre></div></blockquote>
<ul>
<li>删除规则</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ iptables -L -n --line-number  	<span style="color:#75715e"># 查看规则行号</span>
</span></span><span style="display:flex;"><span>$ iptables -D INPUT <span style="color:#ae81ff">9</span>  	<span style="color:#75715e"># 按行号删除规则</span></span></span></code></pre></div></blockquote>
<ul>
<li>清除规则</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ iptables -F  	<span style="color:#75715e"># 清除所有</span>
</span></span><span style="display:flex;"><span>$ iptables-t nat -F  	<span style="color:#75715e"># 清除nat表所有 </span></span></span></code></pre></div></blockquote>
</blockquote>
<ul>
<li>
<ol start="5">
<li><code>Iptables</code><!-- raw HTML omitted -->防御规则<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->阻止<!-- raw HTML omitted --><code>Windows</code><!-- raw HTML omitted -->蠕虫的攻击<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ iptables -I INPUT -j DROP -p tcp -s 0.0.0.0/0 -m string --algo kmp --string <span style="color:#e6db74">&#34;cmd.exe&#34;</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->防止<!-- raw HTML omitted --><code>SYN</code><!-- raw HTML omitted -->洪水攻击<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ iptables -A INPUT -p tcp --syn -m limit --limit 5/second -j ACCEPT</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->添加<!-- raw HTML omitted --><code>SECMARK</code><!-- raw HTML omitted -->记录<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ iptables -t mangle -A INPUT -p tcp --src 192.168.1.2 --dport <span style="color:#ae81ff">443</span> -j SECMARK --selctx system_u:object_r:myauth_packet_t
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 向从 192.168.1.2:443 以TCP方式发出到本机的包添加MAC安全上下文 system_u:object_r:myauth_packet_t</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->防<!-- raw HTML omitted --><code>CC</code><!-- raw HTML omitted -->攻击<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ iptables -L -F -A -D <span style="color:#75715e"># list flush append delete</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 场景一</span>
</span></span><span style="display:flex;"><span>$ iptables -I INPUT -p tcp --dport <span style="color:#ae81ff">80</span> -j ACCEPT <span style="color:#75715e"># 允许 tcp 80 端口</span>
</span></span><span style="display:flex;"><span>$ iptables -I INPUT -p tcp --dport 10:22 -j ACCEPT <span style="color:#75715e"># 允许 tcp 10-22 端口</span>
</span></span><span style="display:flex;"><span>$ iptables -I INPUT -p icmp -j ACCEPT <span style="color:#75715e"># 允许 icmp</span>
</span></span><span style="display:flex;"><span>$ iptables -A INPUT -j REJECT <span style="color:#75715e"># 添加一条规则, 不允许所有</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 优化场景一</span>
</span></span><span style="display:flex;"><span>$ iptables -I INPUT -i lo -j ACCEPT <span style="color:#75715e"># 允许本机访问</span>
</span></span><span style="display:flex;"><span>$ iptables -I INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT <span style="color:#75715e"># 允许访问外网</span>
</span></span><span style="display:flex;"><span>$ iptables -I INPUT -p tcp --dport <span style="color:#ae81ff">80</span> -s 10.10.188.233 -j ACCEPT <span style="color:#75715e"># 只允许固定ip访问80</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 场景二</span>
</span></span><span style="display:flex;"><span>$ vi /etc/vsftpd/vsftpd.conf <span style="color:#75715e"># 使用 vsftpd 开启 ftp 主动模式</span>
</span></span><span style="display:flex;"><span>port_enable<span style="color:#f92672">=</span>yes
</span></span><span style="display:flex;"><span>connect_from_port_20<span style="color:#f92672">=</span>YES
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ iptables -I INPUT -p tcp --dport <span style="color:#ae81ff">21</span> -j ACCEPT
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ vi /etc/vsftpd/vsftpd.conf <span style="color:#75715e"># 建议使用 ftp 被动模式</span>
</span></span><span style="display:flex;"><span>pasv_min_port<span style="color:#f92672">=</span><span style="color:#ae81ff">50000</span>
</span></span><span style="display:flex;"><span>pasv_max_port<span style="color:#f92672">=</span><span style="color:#ae81ff">60000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ iptables -I INPUT -p tcp --dport <span style="color:#ae81ff">21</span> -j ACCEPT
</span></span><span style="display:flex;"><span>$ iptables -I INPUT -p tcp --dport 50000:60000 -j ACCEPT
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 还可以使用 iptables 模块追踪来自动开发对应的端口</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 场景三</span>
</span></span><span style="display:flex;"><span>$ iptables -I INPUT -i lo -j ACCEPT <span style="color:#75715e"># 允许本机访问</span>
</span></span><span style="display:flex;"><span>$ iptables -I INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT <span style="color:#75715e"># 允许访问外网</span>
</span></span><span style="display:flex;"><span>$ iptables -I INPUT -s 10.10.155.0/24 -j ACCEPT <span style="color:#75715e"># 允许内网访问</span>
</span></span><span style="display:flex;"><span>$ iptables -I INPUT -p tcp -m multiport --dports 80,1723 -j ACCEPT <span style="color:#75715e"># 允许端口, 80 -&gt; http, 1723 -&gt; vpn</span>
</span></span><span style="display:flex;"><span>$ iptables -A INPUT -j REJECT <span style="color:#75715e"># 添加一条规则, 不允许所有</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ iptables-save <span style="color:#75715e"># 保存设置到配置文件</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 场景四</span>
</span></span><span style="display:flex;"><span>$ iptables -t nat -L <span style="color:#75715e"># 查看 nat 配置</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ iptables -t nat -A POST_ROUTING -s 10.10.177.0/24 -j SNAT --to 10.10.188.232 <span style="color:#75715e"># SNAT</span>
</span></span><span style="display:flex;"><span>$ vi /etc/sysconfig/network <span style="color:#75715e"># 配置网关</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ iptables -t nat -A POST_ROUTING -d 10.10.188.232 -p tcp --dport <span style="color:#ae81ff">80</span> -j DNAT --to 10.10.177.232:80 <span style="color:#75715e"># DNAT</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#场景五</span>
</span></span><span style="display:flex;"><span>$ iptables -I INPUT -p tcp --syn --dport <span style="color:#ae81ff">80</span> -m connlimit --connlimit-above <span style="color:#ae81ff">100</span> -j REJECT <span style="color:#75715e"># 限制并发连接访问数</span>
</span></span><span style="display:flex;"><span>$ iptables -I INPUT -m limit --limit 3/hour --limit-burst <span style="color:#ae81ff">10</span> -j ACCEPT <span style="color:#75715e"># limit模块; --limit-burst 默认为5</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="配置ipset">配置<code>Ipset</code></h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>ipset</code><!-- raw HTML omitted -->提高<!-- raw HTML omitted --><code>iptables</code><!-- raw HTML omitted -->的控制效率<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>
<p><a href="https://www.cnblogs.com/faberbeta/p/ipset.html" rel="external" target="_self">使用<code>ipset</code>提高<code>iptables</code>的控制效率 </a></p>
</li>
<li>
<p><code>ipset</code><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>method</code><!-- raw HTML omitted -->(方法)<!-- raw HTML omitted --></p>
</li>
</ul>
<blockquote>
<ul>
<li>
<p><code>bitmap</code><!-- raw HTML omitted -->：使用固定大小的存储<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>hash</code><!-- raw HTML omitted -->：使用hash表来存储元素<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>list</code><!-- raw HTML omitted -->：使用固定大小的存储<!-- raw HTML omitted --></p>
</li>
</ul>
</blockquote>
<ul>
<li><code>ipset</code><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>datatype</code><!-- raw HTML omitted -->(数据类型)<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>ip</code><!-- raw HTML omitted -->：使用哈希存储<code>ip</code>主机地址(默认)或网络地址。零值<code>IP</code>地址不能存储在散列中<!-- raw HTML omitted --></li>
<li><code>net</code><!-- raw HTML omitted -->：使用集合存储不同大小的<code>IP</code>网络段。前缀大小为零的网络地址不能存储在这种类型的集合中<!-- raw HTML omitted --></li>
<li><code>mac</code></li>
<li><code>port</code><!-- raw HTML omitted -->：使用<code>hash</code>存储<code>IP</code>地址和端口号对。端口号与协议(默认<code>TCP</code>)一起，不能使用零协议号<!-- raw HTML omitted --></li>
<li><code>iface</code></li>
</ul>
</blockquote>
<ul>
<li><!-- raw HTML omitted --><code>create</code>创建<code>ipset</code>集合、<code>add</code>添加条目<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>timeout</code><!-- raw HTML omitted -->：超时时间，如果设置为0，表示永久生效，超时时间可以通过<code>-exist</code>来进行修改<!-- raw HTML omitted --></li>
<li><code>counters</code><!-- raw HTML omitted -->：支持<code>packets</code>包和<code>bytes</code>字节创建集合<!-- raw HTML omitted --></li>
<li><code>comment</code><!-- raw HTML omitted -->：备注，注释不能包含任何引号，通常的转义字符<code>()</code>没有任何意义<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ipset create SetName TypeName  	<span style="color:#75715e"># SetName：为自定义名称，TypeName：为method:datatype</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 举例说明</span>
</span></span><span style="display:flex;"><span>$ ipset create mysql hash:ip timeout <span style="color:#ae81ff">3600</span>
</span></span><span style="display:flex;"><span>$ ipset create php hash:ip,port
</span></span><span style="display:flex;"><span>$ ipset create Nginx hash:net
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 添加条目</span>
</span></span><span style="display:flex;"><span>$ ipset -exist add mysql 127.0.0.1 timeout <span style="color:#ae81ff">7200</span>
</span></span><span style="display:flex;"><span>$ ipset add php 127.0.0.1,9000
</span></span><span style="display:flex;"><span>$ ipset add Nginx 127.0.0.0/8</span></span></code></pre></div></blockquote>
<ul>
<li><code>list</code><!-- raw HTML omitted -->列出集合、<!-- raw HTML omitted --><code>test</code><!-- raw HTML omitted -->检查条目<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ipset list  	<span style="color:#75715e"># 列出所有集合</span>
</span></span><span style="display:flex;"><span>$ ipset list mysql  	<span style="color:#75715e"># 列出指定集合</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ipset test mysql 127.0.0.1</span></span></code></pre></div><ul>
<li><code>del</code><!-- raw HTML omitted -->某条，<!-- raw HTML omitted --><code>flush</code><!-- raw HTML omitted -->清空集合条目<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ipset del mysql 127.0.0.1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ipset flush Nginx</span></span></code></pre></div><ul>
<li><code>destroy</code><!-- raw HTML omitted -->删除集合<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ipset destroy  	<span style="color:#75715e"># 删除所有集合</span>
</span></span><span style="display:flex;"><span>$ ipset destroy mysql  	<span style="color:#75715e"># 删除指定集合</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->在<!-- raw HTML omitted --><code>iptables</code><!-- raw HTML omitted -->中使用<!-- raw HTML omitted --><code>ipse</code>，<!-- raw HTML omitted -->只要加上<!-- raw HTML omitted --><code>-m set --match-set</code><!-- raw HTML omitted -->即可<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->目的<!-- raw HTML omitted --><code>ip</code><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>ipset</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ iptables -I INPUT -s 192.168.88.110 -m set --match-set Nginx dst -j DROP</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->源<!-- raw HTML omitted --><code>ip</code><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>ipset</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ iptables -I INPUT -m set --match-set Nginx src -d 192.168.88.110  -j DROP</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->源和目的都使用<!-- raw HTML omitted --><code>ipset</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ iptables -I INPUT -m set --match-set Nginx src -m set --match-set mysql dst -j DROP</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="配置hostsallow和hostsdeny">配置<code>hosts.allow</code>和<code>hosts.deny</code></h3>
<ul>
<li>
<ol>
<li><code>/etc/hosts.allow</code>：文件配置</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>
<p><a href="https://www.cnblogs.com/EasonJim/p/8338931.html" rel="external" target="_self">使用<code>hosts.allow</code>和<code>hosts.deny</code>实现简单的防火墙</a></p>
</li>
<li>
<p><a href="https://cloud.tencent.com/developer/article/1533595" rel="external" target="_self"><code>SSH</code>之<code>hosts.allow</code>和<code>hosts.deny</code>文件</a></p>
</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/hosts.allow<span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># Jenkins
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sshd:IP:allow 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># jumpserver
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sshd:IP:allow 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># local 网段
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sshd:192.168.0.:allow
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 内连数据库
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sshd:IP:allow
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">nfsd:ALL
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sshd:all:deny
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          </section>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="gitlab">Gitlab</h1>


            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Gitlab</h1>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="use_gitrunner">Use_Gitrunner</h1>

<h2 id="登录安装好的gitlab配置git-runner">登录安装好的<code>gitlab</code>配置<code>git-runner</code></h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->获取注册使用的<!-- raw HTML omitted --><code>token</code></li>
</ol>
</li>
</ul>
<blockquote>
<p><a href="#R-image-23a9e4af34e6eaa5efaf28d1d891dd37" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Gitlab_Server/Snipaste_2022-04-22_21-57-46.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-23a9e4af34e6eaa5efaf28d1d891dd37"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Gitlab_Server/Snipaste_2022-04-22_21-57-46.png"></a></p>
</blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->注册<!-- raw HTML omitted --><code>git-runner</code><!-- raw HTML omitted -->到安装好的<!-- raw HTML omitted --><code>gitlab</code><!-- raw HTML omitted -->仓库<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>2.1 <!-- raw HTML omitted -->命令行执行命令<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>url</code><!-- raw HTML omitted -->：私有<!-- raw HTML omitted --><code>gitlab</code><!-- raw HTML omitted -->的路径<!-- raw HTML omitted --></li>
<li><code>token</code><!-- raw HTML omitted -->：项目的<!-- raw HTML omitted --><code>token</code><!-- raw HTML omitted -->，用于关联<!-- raw HTML omitted --><code>runner</code><!-- raw HTML omitted -->和项目<!-- raw HTML omitted --></li>
<li><code>name</code>：<code>runner</code><!-- raw HTML omitted -->的名字，用于区分<!-- raw HTML omitted --><code>runner</code></li>
<li><code>tags</code><!-- raw HTML omitted -->：用于匹配任务<!-- raw HTML omitted --><code>jobs</code><!-- raw HTML omitted -->和执行任务的设备<!-- raw HTML omitted --><code>runners</code></li>
<li><code>executor</code><!-- raw HTML omitted -->：执行环境<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ gitlab-ci-multi-runner register  	<span style="color:#75715e"># 执行注册命令， 然后输入gitlab浏览器地址、token</span>
</span></span><span style="display:flex;"><span>Enter the GitLab instance URL <span style="color:#f92672">(</span><span style="color:#66d9ef">for</span> example, https://gitlab.com/<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>http://192.168.35.130  	<span style="color:#75715e"># gitlab地址</span>
</span></span><span style="display:flex;"><span>Enter the registration token:
</span></span><span style="display:flex;"><span>LBsW7DfZdJN87yUAMVVh  	<span style="color:#75715e"># gitlab查看到的token</span>
</span></span><span style="display:flex;"><span>Enter a description <span style="color:#66d9ef">for</span> the runner:
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>node-2-35.130<span style="color:#f92672">]</span>: node-2-35.130  	<span style="color:#75715e"># 最好是本机的hostname、也可以为空</span>
</span></span><span style="display:flex;"><span>Enter tags <span style="color:#66d9ef">for</span> the runner <span style="color:#f92672">(</span>comma-separated<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>  	<span style="color:#75715e"># 在什么情况下触发，可以直接回车，后面在注册好的git-runner的Tags中添加，.gitlab-ci.yml文件中引用此tags</span>
</span></span><span style="display:flex;"><span>Enter optional maintenance note <span style="color:#66d9ef">for</span> the runner:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 没明白什么意思直接回车</span>
</span></span><span style="display:flex;"><span>Registering runner... succeeded                     runner<span style="color:#f92672">=</span>LBsW7DfZ
</span></span><span style="display:flex;"><span>Enter an executor: docker+machine, docker, shell, parallels, ssh, virtualbox, docker-ssh+machine, kubernetes, custom, docker-ssh:
</span></span><span style="display:flex;"><span>shell  	<span style="color:#75715e"># 选择使用执行器yum，rpm安装一般选择shell环境</span>
</span></span><span style="display:flex;"><span>Runner registered successfully. Feel free to start it, but <span style="color:#66d9ef">if</span> it<span style="color:#960050;background-color:#1e0010">&#39;</span>s running already the config should be automatically reloaded!</span></span></code></pre></div><p><a href="#R-image-a4370dc5349325d26de7a1022a750758" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Gitlab_Server/Snipaste_2022-04-22_22-50-14.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-a4370dc5349325d26de7a1022a750758"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Gitlab_Server/Snipaste_2022-04-22_22-50-14.png"></a></p>
</blockquote>
</blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>gitlab-runner</code><!-- raw HTML omitted -->用户环境变量<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->执行完成后<!-- raw HTML omitted --><code>gitlab-runner</code><!-- raw HTML omitted -->会自动修改<!-- raw HTML omitted --><code>/etc/gitlab-runner/config.toml</code><!-- raw HTML omitted -->文件，并重载<!-- raw HTML omitted --><code>daemon</code><!-- raw HTML omitted -->程序<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ su - gitlab-runner
</span></span><span style="display:flex;"><span>$ cp /etc/skel/.bashrc .  	<span style="color:#75715e"># 拷贝环境变量到当前用户家目录</span>
</span></span><span style="display:flex;"><span>$ cp /etc/skel/.bash_profile .  	<span style="color:#75715e"># 拷贝环境变量到当前用户家目录</span>
</span></span><span style="display:flex;"><span>$ cat /etc/gitlab-runner/config.toml  	<span style="color:#75715e"># 存放gitlab-runner配置的文件，可以有多个runner</span>
</span></span><span style="display:flex;"><span>concurrent <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>check_interval <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>session_server<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>  session_timeout <span style="color:#f92672">=</span> <span style="color:#ae81ff">1800</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[[</span>runners<span style="color:#f92672">]]</span>
</span></span><span style="display:flex;"><span>  name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;node-2-runner-1&#34;</span>
</span></span><span style="display:flex;"><span>  url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://192.168.35.130&#34;</span>
</span></span><span style="display:flex;"><span>  token <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;7Ganz-WjwqVwbiwuyPMu&#34;</span>
</span></span><span style="display:flex;"><span>  executor <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;shell&#34;</span>
</span></span><span style="display:flex;"><span>  shell <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bash&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">[</span>runners.custom_build_dir<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">[</span>runners.cache<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[</span>runners.cache.s3<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[</span>runners.cache.gcs<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[</span>runners.cache.azure<span style="color:#f92672">]</span></span></span></code></pre></div><ul>
<li><code>runner</code><!-- raw HTML omitted -->配置模板<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">listen_address = &#34;[::]:8090&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">concurrent = 16</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">check_interval = 1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[<span style="color:#ae81ff">session_server]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">listen_address = &#34;[::]:8093&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">advertise_address = &#34;&lt;ip_or_domain&gt;:8093&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">session_timeout = 1800</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[[<span style="color:#ae81ff">runners]]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">name = &#34;runner0&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">limit = 8</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">url = &#34;https://gitlab.example.com/&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">token = &#34;sKj-SjZAxxxxxxxxxxxx&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">executor = &#34;shell&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">shell = &#34;bash&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[[<span style="color:#ae81ff">runners]]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">name = &#34;runner1&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">url = &#34;https://gitlab.example.com/&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">token = &#34;z9y9YKkYxxxxxxxxxxxx&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">executor = &#34;shell&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">shell = &#34;bash&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[[<span style="color:#ae81ff">runners]]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">name = &#34;runner2&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">url = &#34;https://gitlab.example.com/&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">token = &#34;wPKY9ovsxxxxxxxxxxxx&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">executor = &#34;shell&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">shell = &#34;bash&#34;</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->新建一个测试代码库<!-- raw HTML omitted --><code>New Project</code></li>
</ol>
</li>
</ul>
<blockquote>
<p><a href="#R-image-3722f5a82c042918ab302522b4478a86" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Gitlab_Server/Snipaste_2022-04-22_21-38-43.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-3722f5a82c042918ab302522b4478a86"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Gitlab_Server/Snipaste_2022-04-22_21-38-43.png"></a></p>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="use_gitlab">Use_Gitlab</h1>

<h2 id="修改gitlab配置文件">修改gitlab配置文件</h2>
<ul>
<li>
<ol>
<li><a href="https://blog.csdn.net/A___LEi/article/details/110476531" rel="external" target="_self"><code>GitLab →</code> 搭建中常遇的问题与日常维护</a></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/gitlab/gitlab.rb<span style="color:#e6db74">&lt;&lt;-EOF  	# 修改gitlab默认端口
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">external_url &#39;http://185.167.13.45:12580&#39;  	# 修改链接地址，在32行左右
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">unicorn[&#39;port&#39;] = &#39;9092&#39;  	# 修改默认端口，在 995行左右，新版本改为：puma[&#39;port&#39;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<hr>
<h2 id="处理gitlab报错">处理gitlab报错</h2>
<ul>
<li>
<ol>
<li><a href="https://blog.csdn.net/fishinhouse/article/details/105131917" rel="external" target="_self"><code>gitlab runner 500</code>错误解决</a></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ docker exec -it gitlab cat /var/log/gitlab/gitlab-rails/production.log
</span></span><span style="display:flex;"><span>$ gitlab-rails console
</span></span><span style="display:flex;"><span>--------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>Ruby:         ruby 2.7.5p203 <span style="color:#f92672">(</span>2021-11-24 revision f69aeb8314<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>x86_64-linux<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>GitLab:       14.4.4 <span style="color:#f92672">(</span>838dea1cf23<span style="color:#f92672">)</span> FOSS
</span></span><span style="display:flex;"><span>GitLab Shell: 13.21.1
</span></span><span style="display:flex;"><span>PostgreSQL:   12.7
</span></span><span style="display:flex;"><span>--------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>Loading production environment <span style="color:#f92672">(</span>Rails 6.1.4.1<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>irb<span style="color:#f92672">(</span>main<span style="color:#f92672">)</span>:001:0&gt; ApplicationSetting.current.reset_runners_registration_token!
</span></span><span style="display:flex;"><span><span style="color:#f92672">=</span>&gt; true
</span></span><span style="display:flex;"><span>irb<span style="color:#f92672">(</span>main<span style="color:#f92672">)</span>:002:0&gt; exit
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ gitlab-rails dbconsole 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>-- Clear project tokens<span style="color:#f92672">(</span>清除项目令牌<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>UPDATE projects SET runners_token <span style="color:#f92672">=</span> null, runners_token_encrypted <span style="color:#f92672">=</span> null;
</span></span><span style="display:flex;"><span>-- Clear group tokens<span style="color:#f92672">(</span>清除组令牌<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>UPDATE namespaces SET runners_token <span style="color:#f92672">=</span> null, runners_token_encrypted <span style="color:#f92672">=</span> null;
</span></span><span style="display:flex;"><span>-- Clear instance tokens<span style="color:#f92672">(</span>清除实例令牌<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>UPDATE application_settings SET runners_registration_token_encrypted <span style="color:#f92672">=</span> null;
</span></span><span style="display:flex;"><span>-- Clear key used <span style="color:#66d9ef">for</span> JWT authentication<span style="color:#f92672">(</span>用于 JWT 身份验证的清除密钥<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>-- This may break the $CI_JWT_TOKEN job variable:
</span></span><span style="display:flex;"><span>-- https://gitlab.com/gitlab-org/gitlab/-/issues/325965
</span></span><span style="display:flex;"><span>UPDATE application_settings SET encrypted_ci_jwt_signing_key <span style="color:#f92672">=</span> null;
</span></span><span style="display:flex;"><span>-- Clear runner tokens<span style="color:#f92672">(</span>清除跑步者令牌<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>UPDATE ci_runners SET token <span style="color:#f92672">=</span> null, token_encrypted <span style="color:#f92672">=</span> null;</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->处理<!-- raw HTML omitted --><code>502</code><!-- raw HTML omitted -->报错<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->修改配置文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ vim /etc/gitlab/gitlab.rb  	<span style="color:#75715e"># 修改gitlab默认端口</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 报错502,下列取消注释</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># unicorn[&#39;port&#39;] = 8088</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># postgresql[&#39;shared_buffers&#39;] = &#34;256MB&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># postgresql[&#39;max_connections&#39;] = 200</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->然后重启<!-- raw HTML omitted --><code>gitlab</code><!-- raw HTML omitted -->以及做初始化<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ gitlab-ctl reconfigure  	<span style="color:#75715e"># 初始化gitlab</span>
</span></span><span style="display:flex;"><span>$ gitlab-ctl restart</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><code>gitlab 403 forbidden</code><!-- raw HTML omitted -->报错解决<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>gitlab</code>稳定运行有一年多了，今天研发部小伙伴跑来说，他的<code>gitlab</code>访问不了，不一会，还有几位小伙伴也一样的反馈查看他们的报错，为<code>403 forbidden</code>奇怪的是，我访问是正常的</li>
<li>排查过程</li>
<li>首先上服务器，查看各服务均正常<code>gitlab-ctl logs</code>查看日志，发现有一个<code>IP 172.17.2.254</code>访问被拒绝，而这个<code>IP</code>，是无线网段的网关。瞬间明白了，不能用的全是用无线上网的同学，只要是经过<code>2.254</code>的都不能用继续查看日志，有个<code>xiaoxiao</code>用户，有过几次登陆失败，之后就全都是<code>forbidden</code>看来<code>gitlab</code>是有防爆破机制，查看配置文档<code>gitlab.yml</code>，果然有<code>rack_attack</code>的配置，如图：</li>
</ul>
<p><a href="#R-image-46f5dd0928ebe546250e85d6abb9ede3" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Gitlab_Server/Snipaste_2022-10-11_20-13-40.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-46f5dd0928ebe546250e85d6abb9ede3"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Gitlab_Server/Snipaste_2022-10-11_20-13-40.png"></a></p>
<ul>
<li>解决方法，进入<code>redis</code>，删除被墙的<code>IP</code>地址即可以，命令如下：</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /opt/gitlab/embedded/bin/redis-cli -s /var/opt/gitlab/redis/redis.socket keys <span style="color:#e6db74">&#39;*&#39;</span> | grep <span style="color:#e6db74">&#39;rack::attack&#39;</span> | xargs /opt/gitlab/embedded/bin/redis-cli -s /var/opt/gitlab/redis/redis.socket DEL
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>integer<span style="color:#f92672">)</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 执行这命令 使用无线连接gitlab的电脑恢复正常。</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><code>postfix</code><!-- raw HTML omitted -->启动报错<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>修改<code>/etc/postfix/main.cf</code>中：<code>#myhostname = host.domain.tld </code></li>
<li>其中：<code>host.domain.tld</code>必须是：<code>xxx.xxxx.xxx</code></li>
</ul>
</blockquote>
<ul>
<li>
<ol start="5">
<li><code>gitlab8.0</code><!-- raw HTML omitted -->版本汉化<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->安装扩展插件以及下载汉化版本库<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install patch git
</span></span><span style="display:flex;"><span><span style="color:#75715e"># git clone https://gitlab.com/xhang/gitlab.git  	# 汉化版本库</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># git diff v10.0.2 v10.0.2-zh &gt; ../10.0.2-zh.diff  	# 版本对比</span>
</span></span><span style="display:flex;"><span>$ git clone https://gitlab.com/larryli/gitlab.git</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->配置汉化文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd gitlab
</span></span><span style="display:flex;"><span>$ git diff origin/8-0-stable..origin/8-0-zh &gt; patch.diff  	<span style="color:#75715e"># 生成:patch.diff文件</span>
</span></span><span style="display:flex;"><span>$ patch -d /opt/gitlab/embedded/service/gitlab-rails -p1 &lt; /tmp/patch.diff  	<span style="color:#75715e"># 把:patch.diff文件安装到gitlab安装目录下</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->重启<!-- raw HTML omitted --><code>gitlab</code><!-- raw HTML omitted -->以及做初始化<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ gitlab-ctl reconfigure
</span></span><span style="display:flex;"><span>$ gitlab-ctl restart  	<span style="color:#75715e"># 重启gitlab</span></span></span></code></pre></div><ul>
<li>
<p><!-- raw HTML omitted -->在打包补丁<!-- raw HTML omitted --><code>patch -d /opt/gitlab/embedded/service/gitlab-rails -p1 &lt; …/v10.8.4-zh.diff</code>
<!-- raw HTML omitted -->后可能会出来该情况，一路回车跳过即可<!-- raw HTML omitted --></p>
<p><a href="#R-image-bc3ff4019847ae7b2db9d250ab84e2fc" class="lightbox-link"><img alt="汉化" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Gitlab_Server/languge-zh.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-bc3ff4019847ae7b2db9d250ab84e2fc"><img alt="汉化" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Gitlab_Server/languge-zh.png"></a></p>
<p><a href="#R-image-4299e67a0fa5ae41ec930a80e5e6279d" class="lightbox-link"><img alt="汉化2" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Gitlab_Server/languge-zh-1.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-4299e67a0fa5ae41ec930a80e5e6279d"><img alt="汉化2" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Gitlab_Server/languge-zh-1.png"></a></p>
</li>
</ul>
</blockquote>
<hr>
<h2 id="修改gitlab管理员密码的三种方式">修改<code>gitlab</code>管理员密码的三种方式</h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->方法一，使用<!-- raw HTML omitted --><code>id</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>irb<span style="color:#f92672">(</span>main<span style="color:#f92672">)</span>:001:0&gt; user <span style="color:#f92672">=</span> User.where<span style="color:#f92672">(</span>id:<span style="color:#f92672">[</span>user<span style="color:#960050;background-color:#1e0010">&#39;</span>s register index<span style="color:#f92672">])</span>.first</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->方法二，使用邮箱<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>irb<span style="color:#f92672">(</span>main<span style="color:#f92672">)</span>:001:0&gt; user <span style="color:#f92672">=</span> User.where<span style="color:#f92672">(</span>email:<span style="color:#f92672">[</span>user<span style="color:#960050;background-color:#1e0010">&#39;</span>s register email<span style="color:#f92672">])</span>.first</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->方法三，使用用户名<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>irb<span style="color:#f92672">(</span>main<span style="color:#f92672">)</span>:001:0&gt; user <span style="color:#f92672">=</span> User.where<span style="color:#f92672">(</span>name:<span style="color:#f92672">[</span>user<span style="color:#960050;background-color:#1e0010">&#39;</span>s register name<span style="color:#f92672">])</span>.first</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->执行命令进入控制台：<!-- raw HTML omitted --><code>gitlab-rails console production</code><!-- raw HTML omitted -->，如果报错执行：<!-- raw HTML omitted --><code>gitlab-rails console -e production</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ gitlab-rails console -e production
</span></span><span style="display:flex;"><span>--------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>GitLab:       12.8.6 <span style="color:#f92672">(</span>5fc76a64537<span style="color:#f92672">)</span> FOSS
</span></span><span style="display:flex;"><span>GitLab Shell: 11.0.0
</span></span><span style="display:flex;"><span>PostgreSQL:   10.12
</span></span><span style="display:flex;"><span>--------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>Loading production environment <span style="color:#f92672">(</span>Rails 6.0.2<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>irb<span style="color:#f92672">(</span>main<span style="color:#f92672">)</span>:001:0&gt; user <span style="color:#f92672">=</span> User.where<span style="color:#f92672">(</span>id: 1<span style="color:#f92672">)</span>.first
</span></span><span style="display:flex;"><span><span style="color:#f92672">=</span>&gt; <span style="color:#75715e">#&lt;User id:1 @root&gt;</span>
</span></span><span style="display:flex;"><span>irb<span style="color:#f92672">(</span>main<span style="color:#f92672">)</span>:002:0&gt; user.password <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;12345678&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;12345678&#34;</span>
</span></span><span style="display:flex;"><span>irb<span style="color:#f92672">(</span>main<span style="color:#f92672">)</span>:003:0&gt; user.password_confirmation <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;12345678&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;12345678&#34;</span>
</span></span><span style="display:flex;"><span>irb<span style="color:#f92672">(</span>main<span style="color:#f92672">)</span>:004:0&gt; user.save!
</span></span><span style="display:flex;"><span>Enqueued ActionMailer::DeliveryJob <span style="color:#f92672">(</span>Job ID: b6aca58a-cfde-4890-aa22-a8f491290c96<span style="color:#f92672">)</span> to Sidekiq<span style="color:#f92672">(</span>mailers<span style="color:#f92672">)</span> with arguments: <span style="color:#e6db74">&#34;DeviseMailer&#34;</span>, <span style="color:#e6db74">&#34;password_change&#34;</span>, <span style="color:#e6db74">&#34;deliver_now&#34;</span>, <span style="color:#75715e">#&lt;GlobalID:0x00007f79cb5f5298 @uri=#&lt;URI::GID gid://gitlab/User/1&gt;&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">=</span>&gt; true
</span></span><span style="display:flex;"><span>irb<span style="color:#f92672">(</span>main<span style="color:#f92672">)</span>:005:0&gt; exit</span></span></code></pre></div></blockquote>
<hr>
<h2 id="gitlab配置邮箱"><code>Gitlab</code>配置邮箱</h2>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ vim /etc/gitlab/gitlab.ra
</span></span><span style="display:flex;"><span><span style="color:#75715e"># gitlab_rails[&#39;smtp_enable&#39;] = true</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># gitlab_rails[&#39;smtp_address&#39;] = &#34;smtp.server&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># gitlab_rails[&#39;smtp_port&#39;] = 465</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># gitlab_rails[&#39;smtp_user_name&#39;] = &#34;smtp user&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># gitlab_rails[&#39;smtp_password&#39;] = &#34;smtp password&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># gitlab_rails[&#39;smtp_domain&#39;] = &#34;example.com&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># gitlab_rails[&#39;smtp_authentication&#39;] = &#34;login&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># gitlab_rails[&#39;smtp_enable_starttls_auto&#39;] = true</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># gitlab_rails[&#39;smtp_tls&#39;] = false</span></span></span></code></pre></div><p><a href="#R-image-c259bfc8ca98267ed7584a4d5a3dace5" class="lightbox-link"><img alt="configure-git-email" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Gitlab_Server/configure-git-email.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-c259bfc8ca98267ed7584a4d5a3dace5"><img alt="configure-git-email" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Gitlab_Server/configure-git-email.png"></a></p>
</blockquote>
<hr>
<h2 id="gitlab版本升级"><code>Gitlab</code>版本升级</h2>
<blockquote>
<table>
<thead>
<tr>
<th>地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://docs.gitlab.com/ee/update/index.html#upgrade-paths" rel="external" target="_self"><code>Gitlab</code>升级</a></td>
<td>升级博客</td>
</tr>
<tr>
<td><a href="https://zhuanlan.zhihu.com/p/352342116" rel="external" target="_self"><code>Gitlab</code>版本升级</a></td>
<td>升级博客</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ curl -sS https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.rpm.sh | sudo bash
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ yum install -y gitlab-ce-9.5.10
</span></span><span style="display:flex;"><span>$ yum install -y gitlab-ce-10.8.7
</span></span><span style="display:flex;"><span>$ yum install -y gitlab-ce-11.11.8
</span></span><span style="display:flex;"><span>$ yum install -y gitlab-ce-12.0.12
</span></span><span style="display:flex;"><span>$ yum install -y gitlab-ce-12.1.17
</span></span><span style="display:flex;"><span>$ yum install -y gitlab-ce-12.10.14
</span></span><span style="display:flex;"><span>$ yum install -y gitlab-ce-13.0.14
</span></span><span style="display:flex;"><span>$ yum install -y gitlab-ce-13.1.11
</span></span><span style="display:flex;"><span>$ yum install -y gitlab-ce-13.8.8
</span></span><span style="display:flex;"><span>$ yum install -y gitlab-ce-13.12.15
</span></span><span style="display:flex;"><span>$ yum install -y gitlab-ce-14.0.12
</span></span><span style="display:flex;"><span>$ yum install -y gitlab-ce-14.1.1  	<span style="color:#75715e"># 14.1.1为过度必须版本</span>
</span></span><span style="display:flex;"><span>$ yum install -y gitlab-ce-14.2.1  	<span style="color:#75715e"># 14.2.1为过度必须版本</span>
</span></span><span style="display:flex;"><span>$ yum install -y gitlab-ce-14.3.6
</span></span><span style="display:flex;"><span>$ yum install -y gitlab-ce-14.9.5
</span></span><span style="display:flex;"><span>$ yum install -y gitlab-ce-14.10.Z
</span></span><span style="display:flex;"><span>$ yum install -y gitlab-ce-15.0.Z
</span></span><span style="display:flex;"><span>$ yum install -y gitlab-ce-15.1.Z
</span></span><span style="display:flex;"><span>$ yum install -y gitlab-ce-15.4.0</span></span></code></pre></div></blockquote>
<hr>
<h2 id="gitlab备份还原"><code>Gitlab</code>备份还原</h2>
<blockquote>
<table>
<thead>
<tr>
<th>地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://www.jianshu.com/p/a2600f8dffc2" rel="external" target="_self"><code>Gitlab</code>备份还原</a></td>
<td>备份还原博客</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li><!-- raw HTML omitted -->创建备份，创建后会在：<!-- raw HTML omitted --><code>/var/opt/gitlab/backups/</code><!-- raw HTML omitted -->目录下生成备份文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ gitlab-rake gitlab:backup:create</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->备份还原前先停止相关服务<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ gitlab-ctl stop unicorn  	<span style="color:#75715e"># docker exec -it gitlab gitlab-ctl stop unicorn</span>
</span></span><span style="display:flex;"><span>$ gitlab-ctl stop sidekiq  	<span style="color:#75715e"># docker exec -it gitlab gitlab-ctl stop sidekiq</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->从默认备份恢复，以及<!-- raw HTML omitted --><code>backups</code><!-- raw HTML omitted -->目录下有多个备份文件时，指定时间戳恢复<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ gitlab-rake gitlab:backup:restore BACKUP<span style="color:#f92672">=</span><span style="color:#ae81ff">1500809139</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 从默认备份恢复（backups目录下只有一个备份文件时）</span>
</span></span><span style="display:flex;"><span>$ gitlab-rake gitlab:backup:restore  	<span style="color:#75715e"># docker exec -it gitlab gitlab-rake gitlab:backup:restore</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->确认<!-- raw HTML omitted --><code>：gitlab-secrets.json</code><!-- raw HTML omitted -->文件是否有做备份，如果忘记做备份需要做清空处理<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ gitlab-rails dbconsole
</span></span><span style="display:flex;"><span>$ gitlab-psql -d gitlabhq_production
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 等待几分钟，会进入交互界面，进入后输入如下命令</span>
</span></span><span style="display:flex;"><span>$ SELECT * FROM public.<span style="color:#e6db74">&#34;ci_group_variables&#34;</span>;
</span></span><span style="display:flex;"><span>$ SELECT * FROM public.<span style="color:#e6db74">&#34;ci_variables&#34;</span>;
</span></span><span style="display:flex;"><span>$ DELETE FROM ci_group_variables;
</span></span><span style="display:flex;"><span>$ DELETE FROM ci_variables;
</span></span><span style="display:flex;"><span>$ UPDATE projects SET runners_token <span style="color:#f92672">=</span> null, runners_token_encrypted <span style="color:#f92672">=</span> null;
</span></span><span style="display:flex;"><span>$ UPDATE namespaces SET runners_token <span style="color:#f92672">=</span> null, runners_token_encrypted <span style="color:#f92672">=</span> null;
</span></span><span style="display:flex;"><span>$ UPDATE application_settings SET runners_registration_token_encrypted <span style="color:#f92672">=</span> null;
</span></span><span style="display:flex;"><span>$ UPDATE application_settings SET encrypted_ci_jwt_signing_key <span style="color:#f92672">=</span> null;
</span></span><span style="display:flex;"><span>$ UPDATE ci_runners SET token <span style="color:#f92672">=</span> null, token_encrypted <span style="color:#f92672">=</span> null;
</span></span><span style="display:flex;"><span>$ UPDATE ci_builds SET token <span style="color:#f92672">=</span> null, token_encrypted <span style="color:#f92672">=</span> null;
</span></span><span style="display:flex;"><span>$ TRUNCATE web_hooks CASCADE;</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->还原后启动<!-- raw HTML omitted --><code>Gitlab</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ gitlab-ctl start  	<span style="color:#75715e"># docker exec -it gitlab gitlab-ctl start</span>
</span></span><span style="display:flex;"><span>$ gitlab-ctl reconfigure  	<span style="color:#75715e"># docker exec -it gitlab gitlab-ctl reconfigure</span></span></span></code></pre></div></blockquote>
<hr>
<h2 id="gitlab恢复数据报错解决方法"><code>Gitlab</code>恢复数据报错解决方法</h2>
<blockquote>
<table>
<thead>
<tr>
<th>地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://www.jianshu.com/p/09a2b0c25ecd" rel="external" target="_self"><code>Gitlab</code>恢复数据报错解决方法</a></td>
<td>博客地址</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>postgresql</code><!-- raw HTML omitted -->配置<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ vim /var/opt/gitlab/postgresql/data/postgresql.conf
</span></span><span style="display:flex;"><span>listen_addresses <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;*&#39;</span>  	<span style="color:#75715e"># 中添加*符号</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 最下面新增两行</span>
</span></span><span style="display:flex;"><span>$ vim /var/opt/gitlab/postgresql/data/pg_hba.conf
</span></span><span style="display:flex;"><span>local   all         all                               trust
</span></span><span style="display:flex;"><span>host    all         all                               127.0.0.1/32 trust
</span></span><span style="display:flex;"><span>$ gitlab-ctl restart</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>gitlab</code><!-- raw HTML omitted -->账号为超级用户<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ su - gitlab-psql
</span></span><span style="display:flex;"><span>Last login: Fri Dec <span style="color:#ae81ff">24</span> 17:35:01 CST <span style="color:#ae81ff">2021</span> on pts/0
</span></span><span style="display:flex;"><span>-sh-4.2$ /opt/gitlab/embedded/bin/psql -h 127.0.0.1 gitlabhq_production
</span></span><span style="display:flex;"><span>psql <span style="color:#f92672">(</span>12.7<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>SSL connection <span style="color:#f92672">(</span>protocol: TLSv1.3, cipher: TLS_AES_256_GCM_SHA384, bits: 256, compression: off<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Type <span style="color:#e6db74">&#34;help&#34;</span> <span style="color:#66d9ef">for</span> help.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>gitlabhq_production<span style="color:#f92672">=</span><span style="color:#75715e"># ALTER USER gitlab WITH SUPERUSER;</span>
</span></span><span style="display:flex;"><span>ALTER ROLE
</span></span><span style="display:flex;"><span>gitlabhq_production<span style="color:#f92672">=</span><span style="color:#75715e"># \q</span></span></span></code></pre></div></blockquote>
<hr>
<h2 id="配置gitlab的nginx映射以及白名单">配置<code>Gitlab</code>的<code>Nginx</code>映射以及白名单</h2>
<blockquote>
<ul>
<li><code>Gitlab</code><!-- raw HTML omitted -->白名单<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/gitlab/gitlab.rb<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gitlab_rails[&#39;rack_attack_git_basic_auth&#39;] = {  	# 670 行左右
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #&#39;enabled&#39; =&gt; true,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   &#39;enabled&#39; =&gt; false,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   &#39;ip_whitelist&#39; =&gt; [&#34;IP&#34;,&#34;127.0.0.1&#34;],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   &#39;maxretry&#39; =&gt; 10,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   &#39;findtime&#39; =&gt; 60,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   &#39;bantime&#39; =&gt; 86400
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改展示<!-- raw HTML omitted --><code>Gitlab UI</code><!-- raw HTML omitted -->端的<!-- raw HTML omitted --><code>SSH</code><!-- raw HTML omitted -->端口<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/gitlab/gitlab.rb<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gitlab_rails[&#39;gitlab_shell_ssh_port&#39;] = 18082  	# 651 行左右，
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="use_git_command">Use_Git_Command</h1>

<h2 id="git命令"><code>git</code>命令</h2>
<blockquote>
<table>
<thead>
<tr>
<th>地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="http://git-scm.com/docs/git-submodule" rel="external" target="_self"><code>Git</code>官网</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://mirrors.edge.kernel.org/pub/software/scm/git/" rel="external" target="_self"><code>Git</code>命令工具下载地址</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://iphysresearch.github.io/blog/post/programing/git/git_submodule/" rel="external" target="_self"><code>Git: submodule</code>子模块简明教程</a></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->初始配置、获取仓库<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>
<p><!-- raw HTML omitted -->配置环境提交所用账户以及邮箱<!-- raw HTML omitted --></p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git config --global user.name <span style="color:#e6db74">&#34;name&#34;</span>
</span></span><span style="display:flex;"><span>$ git config --global user.emamil <span style="color:#e6db74">&#34;name@gmail.com&#34;</span>
</span></span><span style="display:flex;"><span>$ git config --global core.sshCommand <span style="color:#e6db74">&#34;ssh -i ~/.ssh/id_rsa&#34;</span>  	<span style="color:#75715e"># 配置密钥</span></span></span></code></pre></div></li>
<li>
<p><!-- raw HTML omitted -->克隆现有远程代码到本地开发<!-- raw HTML omitted --></p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git clone https://github.com/zabbix/zabbix.git
</span></span><span style="display:flex;"><span>$ git clone --recursive git@github.com:username/service.git  	<span style="color:#75715e"># 克隆带有子模块仓库</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除子模块</span>
</span></span><span style="display:flex;"><span>$ vim .gitmodules  	<span style="color:#75715e"># 删除文件内子模块配置</span>
</span></span><span style="display:flex;"><span>$ vim .git/config  	<span style="color:#75715e"># 删除文件内子模块配置</span>
</span></span><span style="display:flex;"><span>$ rm -rf .git/module/*  	<span style="color:#75715e"># 删除子模块下目录文件</span></span></span></code></pre></div></li>
<li>
<p><!-- raw HTML omitted -->本地创建仓库<!-- raw HTML omitted --></p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git init  	<span style="color:#75715e"># 初始化git本地仓库，初始化后在本地生成一个.git目录</span>
</span></span><span style="display:flex;"><span>$ git add .  	<span style="color:#75715e"># 把修改或者添加文件到索引中：-A：参数代表所有</span>
</span></span><span style="display:flex;"><span>$ git commit -m <span style="color:#e6db74">&#34;清除缓存&#34;</span>  	<span style="color:#75715e"># 声明本次修改或添加内容并且交到本地仓库</span></span></span></code></pre></div></li>
<li>
<p><!-- raw HTML omitted -->拉取推送仓库<!-- raw HTML omitted --></p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git pull -u origin master  	<span style="color:#75715e"># 拉取master分支到本地-f:强制拉取，</span>
</span></span><span style="display:flex;"><span>$ git push -u origin master  	<span style="color:#75715e"># 推送master分支到远程</span></span></span></code></pre></div></li>
<li>
<p><!-- raw HTML omitted -->提交时转换为<!-- raw HTML omitted --><code>LF</code><!-- raw HTML omitted -->检出时不转换<!-- raw HTML omitted --></p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git config --global core.autocrlf input</span></span></code></pre></div></li>
<li>
<p><!-- raw HTML omitted -->切换、查看、合并分支<!-- raw HTML omitted --></p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git fetch  	<span style="color:#75715e"># 查看线上分支,--all:查看线上所有分支</span>
</span></span><span style="display:flex;"><span>$ git branch -a  	<span style="color:#75715e"># -a：查看本地当前分支、dev：创建dev分支、-d：删除分支、-D：强制删除</span>
</span></span><span style="display:flex;"><span>$ git checkout dev  	<span style="color:#75715e"># 切换分支，dev：切换到dev分支</span>
</span></span><span style="display:flex;"><span>$ git checkout .  	<span style="color:#75715e"># 放弃本地所有修改</span>
</span></span><span style="display:flex;"><span>$ git merge -m <span style="color:#e6db74">&#39;合并dev分支到master&#39;</span> dev  	<span style="color:#75715e"># 先切换到master分支</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看当前版分支</span>
</span></span><span style="display:flex;"><span>$ git rev-parse --abbrev-ref HEAD
</span></span><span style="display:flex;"><span>$ git name-rev --name-only HEAD
</span></span><span style="display:flex;"><span>$ git branch --show-current  	<span style="color:#75715e"># 此方式需要git 2.22版本或者以上</span></span></span></code></pre></div></li>
<li>
<p><!-- raw HTML omitted -->回退版本<!-- raw HTML omitted --></p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git reset --hard  	<span style="color:#75715e"># 回退版本、可选择版本分支号回退</span>
</span></span><span style="display:flex;"><span>$ git reset --hard HEAD~3  	<span style="color:#75715e"># 解决代码冲突</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ git rm -r --cached .  <span style="color:#75715e"># 清楚本地缓存</span></span></span></code></pre></div></li>
<li>
<p>1.8 <!-- raw HTML omitted -->查看<!-- raw HTML omitted --><code>git</code><!-- raw HTML omitted -->仓库状态以及日志<!-- raw HTML omitted --></p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git status  	<span style="color:#75715e"># 命令查看当前git仓库的状态</span>
</span></span><span style="display:flex;"><span>$ git log -5  	<span style="color:#75715e"># 查看最近五次日志，v2.5.. Makefile fs/:找出所有从&#34;v2.5&#34;开始在fs目录下的所有Makefile的修改</span>
</span></span><span style="display:flex;"><span>$ git log --stat  	<span style="color:#75715e"># 显示在每个提交(commit)中哪些文件被修改, 这些文件分别添加或删除多少行内容</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ git diff --cached  	<span style="color:#75715e"># diff比较选项再加上 --cached参数，看看缓存区中哪些文件被修改</span>
</span></span><span style="display:flex;"><span>$ git diff --name-only --diff-filter<span style="color:#f92672">=</span>ACMRT old_commit new_commit
</span></span><span style="display:flex;"><span>$ git diff <span style="color:#e6db74">${</span>current_id<span style="color:#e6db74">}</span> <span style="color:#e6db74">${</span>commit_id<span style="color:#e6db74">}</span> --name-only | grep dist_prod
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ git rev-parse HEAD  	<span style="color:#75715e"># 获取当前版本commit id，参数： --short</span>
</span></span><span style="display:flex;"><span>$ git rev-list HEAD -2  	<span style="color:#75715e"># 查看历史commit id，-2：代表查看最近几次</span>
</span></span><span style="display:flex;"><span>$ git log --pretty<span style="color:#f92672">=</span>oneline  	<span style="color:#75715e"># 格式化日志输出。--pretty参数可以使用若干表现格式，</span>
</span></span><span style="display:flex;"><span>								<span style="color:#75715e"># 如oneline，--pretty=short，</span>
</span></span><span style="display:flex;"><span>								<span style="color:#75715e"># 也可用medium,full,fuller,email 或 raw，</span>
</span></span><span style="display:flex;"><span>								<span style="color:#75715e"># 也可以用--pretty=format参数定义格式，</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ git log --graph --pretty<span style="color:#f92672">=</span>oneline  	<span style="color:#75715e"># --graph 选项，</span>
</span></span><span style="display:flex;"><span>							<span style="color:#75715e"># 可以可视化你的提交图(commit graph)，</span>
</span></span><span style="display:flex;"><span>							<span style="color:#75715e"># 会用ASCII字符来画出一个很漂亮的提交历史(commit history)线：</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ git log --pretty<span style="color:#f92672">=</span>%s 3ff4f298f7a13ab0150e369f4bbcf43a553c05a5 -1  	<span style="color:#75715e"># 获取变更文件注释信息</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 测试网络 git ssh</span>
</span></span><span style="display:flex;"><span>$ ssh -T git.gitlab.com</span></span></code></pre></div></li>
<li>
<p><!-- raw HTML omitted -->缓存保存命令<!-- raw HTML omitted --><a href="https://www.jianshu.com/p/1c7ecc8d3dfb" rel="external" target="_self"><code>git-stash</code>用法小结</a></p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git stash save <span style="color:#e6db74">&#34;test-cmd-stash&#34;</span>
</span></span><span style="display:flex;"><span>$ git stash pop</span></span></code></pre></div></li>
</ul>
</blockquote>
<hr>
<h3 id="处理git文件过大">处理<code>git</code>文件过大</h3>
<ul>
<li>
<ol>
<li><a href="https://www.zhihu.com/question/29769130" rel="external" target="_self">解决<code>git</code>提交次数过多导致文件过大</a></li>
</ol>
</li>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->运行 <code>gc</code> ，生成 <code>pack</code> 文件（后面的 <code>--prune=now</code> 表示对之前的所有提交做修剪，有的时候仅仅 <code>gc</code> 一下<code>.git</code> 文件就会小很多）<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git gc --prune<span style="color:#f92672">=</span>now</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->找出最大的三个文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git verify-pack -v .git/objects/pack/*.idx | sort -k <span style="color:#ae81ff">3</span> -n | tail -3
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 示例输出：</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1debc758cf31a649c2fc5b0c59ea1b7f01416636 blob   4925660 3655422 14351</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># c43a8da9476f97e84b52e0b34034f8c2d93b4d90 blob   154188651 152549294 12546842</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2272096493d061489349e0a312df00dcd0ec19a2 blob   155414465 153754005 165096136</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->查看那些大文件究竟是谁（<code>c43a8da</code> 是上面大文件的<code>hash</code>码）<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git rev-list --objects --all | grep c43a8da
</span></span><span style="display:flex;"><span><span style="color:#75715e"># c43a8da9476f97e84b52e0b34034f8c2d93b4d90 data/bigfile</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->移除对该文件的引用（也就是 <code>data/bigfile</code>）<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git filter-branch --force --index-filter <span style="color:#e6db74">&#34;git rm --cached --ignore-unmatch &#39;data/bigfile&#39;&#34;</span>  --prune-empty --tag-name-filter cat -- --all</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="6">
<li><!-- raw HTML omitted -->进行 <code>repack</code><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git <span style="color:#66d9ef">for</span>-each-ref --format<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;delete %(refname)&#39;</span> refs/original | git update-ref --stdin
</span></span><span style="display:flex;"><span>$ git reflog expire --expire<span style="color:#f92672">=</span>now --all
</span></span><span style="display:flex;"><span>$ git gc --prune<span style="color:#f92672">=</span>now</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="7">
<li><!-- raw HTML omitted -->查看 <code>pack</code> 的空间使用情况<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git count-objects -v</span></span></code></pre></div></blockquote>
<hr>
<h3 id="lfs功能压缩大文件"><code>LFS</code>功能压缩大文件</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->开启<!-- raw HTML omitted --><code>LFS</code><!-- raw HTML omitted -->功能<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git lfs install</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->设置<!-- raw HTML omitted --><code>LFS</code><!-- raw HTML omitted -->要管理的文件类型<!-- raw HTML omitted --><code>pth、mmdb、pack、idx</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git lfs track <span style="color:#e6db74">&#34;*.pth&#34;</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->报<!-- raw HTML omitted --><code>LFS</code><!-- raw HTML omitted -->错，在执行上面的最后一步上传命令的时候可能会报两个错误<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->第一个错误：<!-- raw HTML omitted --><code>WARNING: Authentication error: Authentication required: LFS only supported repository in paid enterprise.</code><!-- raw HTML omitted -->。可以执行以下命令, 命令中的<!-- raw HTML omitted --><code>{your_gitee}/{your_repo}</code><!-- raw HTML omitted -->是你的远程仓库地址,根据自己情况替换<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git config lfs.https://gitee.com/<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>your_gitee<span style="color:#f92672">}</span>/<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>your_repo<span style="color:#f92672">}</span>.git/info/lfs.locksverify false</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->第二个错误：<!-- raw HTML omitted --><code>batch response: LFS only supported repository in paid enterprise.</code><!-- raw HTML omitted --> 。可以尝试删除<!-- raw HTML omitted --><code>./git/hooks/pre-push</code><!-- raw HTML omitted -->文件,最后重新<!-- raw HTML omitted --><code>push</code><!-- raw HTML omitted -->一下即可<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<hr>
<h3 id="git获取仓库指定目录或文件"><code>git</code>获取仓库指定目录或文件</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->此功能只在<!-- raw HTML omitted --><code>1.7.0</code><!-- raw HTML omitted -->以上版本提供<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir test <span style="color:#f92672">&amp;&amp;</span> cd test
</span></span><span style="display:flex;"><span>$ git init
</span></span><span style="display:flex;"><span>$ git remote add origin https://xxxx.com/xxx.git
</span></span><span style="display:flex;"><span>$ git config core.sparsecheckout true  	<span style="color:#75715e"># 使用Sparse checkout模式</span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;redis-conf/*&#34;</span> &gt;&gt; .git/info/sparse-checkout  	<span style="color:#75715e"># 将检出的目录或文件使用文件追加的形式写入到git的配置.git/info/sparse-checkout文件中，允许添加多行</span>
</span></span><span style="display:flex;"><span>$ git pull origin master  	<span style="color:#75715e"># 获取到需要的文件或目录</span>
</span></span><span style="display:flex;"><span>$ git checkout  	<span style="color:#75715e"># 在对配置文件.git/info/sparse-checkout的内容进行增、删、改操作之后，使用下面的命令重新修正目录和文件</span>
</span></span><span style="display:flex;"><span>$ git push origin master</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_gogs">Install_Gogs</h1>

<h2 id="gogs"><code>Gogs</code></h2>
<blockquote>
<ul>
<li><a href="https://gogs.io/" rel="external" target="_self"><code>Gogs</code>官网</a></li>
</ul>
</blockquote>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_gitlab">Install_Gitlab</h1>

<h2 id="gitlab简介以及安装"><code>gitlab</code>简介以及安装</h2>
<blockquote>
<ul>
<li><a href="https://packages.gitlab.com/gitlab/gitlab-ce" rel="external" target="_self"><code>gitlab</code>安装包库</a></li>
<li><a href="https://github.com/go-gitea/gitea/" rel="external" target="_self"><code>Gitea</code></a></li>
<li><code>GitLab</code>是管理<code>Git</code>存储库的平台。 <code>GitLab</code>提供免费的公共和私人存储库，问题跟踪和维基。 <code>GitLab</code>是<code>Git</code>之上的一个用户友好的<code>Web</code>界面层，它提高了使用<code>Git</code>的速度。 <code>GitLab</code>提供了自己的持续集成<code>CI</code>系统来管理项目，并提供用户界面以及<code>GitLab</code>的其他功能。</li>
<li><code>cat /etc/gitlab/initial_root_password | grep Password</code> 获取初始密码</li>
</ul>
</blockquote>
<hr>
<h3 id="安装前准备">安装前准备</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->安装扩展插件<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum install -y  make telnet  inotify-tools tree rdate ntp gcc gcc-c++ psmisc net-tools screen expect sysstat hdparm traceroute zip unzip pcre pcre-devel zlib zlib-devel openssl openssl-devel tcping libaio dig epel-release wget git
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ yum -y install lsof zeromq-devel policycoreutils openssh-server openssh-clients  policycoreutils-python postfix perl patch cronie</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->启动<!-- raw HTML omitted --><code>postfix</code><!-- raw HTML omitted -->并设置开机自启，<!-- raw HTML omitted --><code>gitlab</code><!-- raw HTML omitted -->需要<!-- raw HTML omitted --><code>postfix</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl enable postfix <span style="color:#f92672">&amp;&amp;</span> systemctl start postfix</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h4 id="yum按照gitlab"><code>yum</code>按照<code>Gitlab</code></h4>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>Gitlab</code></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>gitlab yum</code><!-- raw HTML omitted -->仓库，安装<!-- raw HTML omitted --><code>Gitlab</code><a href="https://about.gitlab.com/install/#centos-7" rel="external" target="_self"><code>yum</code>安装<code>Gitlab</code></a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ curl -s https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.rpm.sh | sudo bash
</span></span><span style="display:flex;"><span>$ yum list gitlab-ce*  	<span style="color:#75715e"># 列出要安装的版本</span>
</span></span><span style="display:flex;"><span>$ yum install gitlab-ce-14.9.3-ce.0.el7.x86_64  	<span style="color:#75715e"># 安装指定版本</span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h4 id="rpm包安装gitlabhttpspackagesgitlabcomgitlabgitlab-ce"><a href="https://packages.gitlab.com/gitlab/gitlab-ce" rel="external" target="_self"><code>rpm</code>包安装<code>gitlab</code></a></h4>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget --content-disposition https://packages.gitlab.com/gitlab/gitlab-ce/packages/el/7/gitlab-ce-14.9.3-ce.0.el7.x86_64.rpm/download.rpm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ rpm gitlab-ce-14.9.3-ce.0.el7.x86_64.rpm</span></span></code></pre></div></blockquote>
<hr>
<h3 id="初始化启动gitlab">初始化启动<code>Gitlab</code></h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ gitlab-ctl reconfigure  	<span style="color:#75715e"># 初始化gitlab</span>
</span></span><span style="display:flex;"><span>$ gitlab-ctl restart  	<span style="color:#75715e"># 重启完成</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="防火墙放行端口">防火墙放行端口</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ firewall-cmd --permanent --add-service<span style="color:#f92672">={</span>http,https<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>$ firewall-cmd --reload</span></span></code></pre></div></blockquote>
<hr>
<h3 id="docker安装gitlab"><code>docker</code>安装<code>gitlab</code></h3>
<ul>
<li>
<ol>
<li><code>Docker</code><!-- raw HTML omitted -->命令启动<!-- raw HTML omitted --><code>Gitlab</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -p /opt/gitlab/<span style="color:#f92672">{</span>config,logs,data<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>$ docker run --detach <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--publish 18081:80 --publish 18083:443 --publish 18082:22 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--name gitlab <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--restart always <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--volume /opt/gitlab/config:/etc/gitlab <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--volume /opt/gitlab/logs:/var/log/gitlab <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--volume /opt/gitlab/data:/var/opt/gitlab <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--env GITLAB_OMNIBUS_CONFIG<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;external_url &#39;https://gitlab.example.com/&#39;;&#34;</span>  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>gitlab/gitlab-ce:10.0.0-ce.0</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><code>docker-compose</code><!-- raw HTML omitted -->启动<!-- raw HTML omitted --><code>Gitlab</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -p /opt/gitlab/<span style="color:#f92672">{</span>config,logs,data<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;/opt/docker-compose/gitlab/docker-compose.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">version: &#34;3&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">services:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  gitlab:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    container_name: gitlab  # 启动后名称
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    image: &#39;gitlab/gitlab-ce:10.0.0-ce.0&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # image: &#39;gitlab/gitlab-ce:10.8.7-ce.0&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # image: &#39;gitlab/gitlab-ce:11.11.8-ce.0&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # image: &#39;gitlab/gitlab-ce:12.0.12-ce.0&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # image: &#39;gitlab/gitlab-ce:12.1.17-ce.0&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # image: &#39;gitlab/gitlab-ce:12.10.14-ce.0&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # image: &#39;gitlab/gitlab-ce:13.0.14-ce.0&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # image: &#39;gitlab/gitlab-ce:13.1.11-ce.0&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # image: &#39;gitlab/gitlab-ce:13.8.8-ce.0&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # image: &#39;gitlab/gitlab-ce:13.12.15-ce.0&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # image: &#39;gitlab/gitlab-ce:14.0.12-ce.0&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # image: &#39;gitlab/gitlab-ce:14.1.1-ce.0&#39;  	# 14.1.1为过度必须版本
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # image: &#39;gitlab/gitlab-ce:14.2.1-ce.0&#39;  	# 14.2.1为过度必须版本
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # image: &#39;gitlab/gitlab-ce:14.3.6-ce.0&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # image: &#39;gitlab/gitlab-ce:14.9.5-ce.0&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # image: &#39;gitlab/gitlab-ce:14.10.5-ce.0&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # image: &#39;gitlab/gitlab-ce:15.0.2-ce.0&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # image: &#39;gitlab/gitlab-ce:15.1.0-ce.0&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    restart: always
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    hostname: &#39;gitlab&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    environment:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      TZ: Asia/Shanghai
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      GITLAB_OMNIBUS_CONFIG: |
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        external_url &#39;http://gitlab.erge.com&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        gitlab_rails[&#39;gitlab_shell_ssh_port&#39;] = 18082
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ports:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &#39;18081:80&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &#39;18082:22&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &#39;18083:443&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    volumes:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &#39;/opt/gitlab/config:/etc/gitlab&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &#39;/opt/gitlab/logs:/var/log/gitlab&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &#39;/opt/gitlab/data:/var/opt/gitlab&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ docker-compose up -d</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_gitlab_runner">Install_Gitlab_Runner</h1>

<h2 id="git-runner"><code>Git Runner</code></h2>
<blockquote>
<ul>
<li>
<p><a href="https://packages.gitlab.com/runner/gitlab-runner" rel="external" target="_self"><code>git-runner</code>库</a></p>
</li>
<li>
<p><a href="https://gitlab.com/gitlab-org/gitlab-runner" rel="external" target="_self"><code>gitlab-runner</code></a></p>
</li>
<li>
<p><a href="https://docs.gitlab.com/runner/install/linux-manually.html" rel="external" target="_self"><code>Gitlab</code>配置<code>runner</code></a></p>
</li>
</ul>
</blockquote>
<hr>
<h3 id="yum安装git-runner"><code>yum</code>安装<code>git-runner</code></h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ curl -s https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.rpm.sh | sudo bash
</span></span><span style="display:flex;"><span>$ yum install gitlab-runner-14.9.1-1.x86_64</span></span></code></pre></div></blockquote>
<hr>
<h3 id="rpm安装git-runner"><code>rpm</code>安装<code>git-runner</code></h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget --content-disposition https://packages.gitlab.com/runner/gitlab-runner/packages/el/7/gitlab-runner-14.9.1-1.x86_64.rpm/download.rpm
</span></span><span style="display:flex;"><span><span style="color:#75715e"># curl -O https://gitlab-runner-downloads.s3.amazonaws.com/latest/rpm/gitlab-runner_amd64.rpm</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># rpm -ivh gitlab-runner_amd64.rpm</span>
</span></span><span style="display:flex;"><span>$ rpm -ivh gitlab-runner-14.9.1-1.x86_64.rpm</span></span></code></pre></div></blockquote>
<hr>
<h3 id="docker安装git-runner"><code>docker</code>安装<code>git-runner</code></h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ docker run -d --name gitlab-runner --restart always <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -v /opt/gitlab-runner/config:/etc/gitlab-runner <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -v /var/run/docker.sock:/var/run/docker.sock <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  gitlab/gitlab-runner:latest</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_gitea">Install_Gitea</h1>

<h2 id="heading"></h2>
<blockquote>
<ul>
<li><a href="https://about.gitea.com/" rel="external" target="_self"><code>Gitea</code>官网</a></li>
</ul>
</blockquote>

            <footer class="footline">
            </footer>
          </article>

          </section>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="haproxy">HAProxy</h1>


            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of HAProxy</h1>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_proxy">Install_Proxy</h1>

<h2 id="部署代理服务">部署代理服务</h2>
<h3 id="http代理privoxy"><code>HTTP</code>代理<code>privoxy</code></h3>
<blockquote>
<ul>
<li>部署依赖</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum install epel-release</span></span></code></pre></div></blockquote>
<ul>
<li>部署<code>privoxy</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum install privoxy</span></span></code></pre></div></blockquote>
<ul>
<li>修改配置</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/privoxy/config<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">listen-address 127.0.0.1:端口  	# 服务端口
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">keep-alive-timeout 5  	# 连接保持活动的时间为 5 秒，减少长时间空闲连接的占用。
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">max-client-connections 256  	# 限制最大链接数，防止资源耗尽
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">timeout 300  	# 超时时间可以防止超时请求占用太多时间
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">enable-edit-actions 0  	# 禁用不必要的功能以减少消耗
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">log-messages 2  	# 可减小到更小
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># forward-socks5 / 127.0.0.1:8889 . # 将 DNS查询转发到本地 SOCKS5代理，可以减少DNS查询的数量
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">permit-access 0.0.0.0/0 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>启动<code>privoxy</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl start privoxy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ systemctl enable privoxy</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="socket代理dante"><code>socket</code>代理<code>dante</code></h3>
<blockquote>
<ul>
<li>安装<code>dante</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum install dante-server</span></span></code></pre></div></blockquote>
<ul>
<li>调整配置</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/sockd.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">internal: 0.0.0.0 port=端口  # 服务端口
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">external: eth0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">socksmethod: none
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">clientmethod: none
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">client pass {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    from: 0.0.0.0/0 to: 0.0.0.0/0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">socks pass {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    from: 0.0.0.0/0 to: 0.0.0.0/0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>启动<code>sockd</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ service sockd restart</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="测试代理服务">测试代理服务</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->防火墙开放端口<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ curl -v -x http://ip:端口 https://www.baidu.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ curl -v -x socks://ip:端口 https://www.baidu.com</span></span></code></pre></div></blockquote>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_haproxy">Install_HAProxy</h1>

<h2 id="安装haproxy">安装<code>HAProxy</code></h2>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="http://www.haproxy.org/#desc" rel="external" target="_self"><code>HAProxy</code>官网</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.cnblogs.com/hh2737/p/8951872.html" rel="external" target="_self"><code>haproxy、nginx、proxy protocol</code>获得客户真实<code>IP</code>方法</a></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li>
<p><strong>负载均衡</strong></p>
<p><code>HAProxy</code>可以将入站请求分发到多个后端服务器，实现负载均衡。它支持多种负载均衡算法，如轮询<code>round-robin</code>、最小连接数<code>leastconn</code>、源IP哈希<code>source</code>、权重等</p>
</li>
<li>
<p><strong>高可用性</strong></p>
<p><code>HAProxy</code>支持健康检查<code>health checks</code>，可以定期检查后端服务器的状态，并根据检查结果动态调整负载均衡策略。当后端服务器出现故障或不可用时，<code>HAProxy</code>可以自动将流量转移到健康的服务器上，从而提高系统的可用性</p>
</li>
<li>
<p><strong>SSL/TLS 终端</strong></p>
<p><code>HAProxy</code>可以作为<code>SSL/TLS</code>的终端<code>Termination</code>，负责处理和管理传入和传出的加密流量。它支持<code>SSL</code>握手和证书管理，可以提供安全的<code>HTTPS</code>服务</p>
</li>
<li>
<p><strong>反向代理</strong></p>
<p><code>HAProxy</code>作为反向代理<code>reverse proxy</code>，可以隐藏后端服务器的实际<code>IP</code>地址和细节，提供更安全的服务访问接口。客户端请求首先到达<code>HAProxy</code>，再由<code>HAProxy</code>转发到后端服务器</p>
</li>
<li>
<p><strong><code>TCP</code>和<code>HTTP</code>支持</strong></p>
<p><code>HAProxy</code>不仅支持<code>HTTP</code>和<code>HTTPS</code>流量的负载均衡，还可以负责<code>TCP</code>流量的负载均衡。这使得它非常适合于支持<code>Web</code>应用程序、<code>API</code>和其他网络服务的高性能和高可用性部署</p>
</li>
<li>
<p><strong>灵活配置和动态更新</strong></p>
<p><code>HAProxy</code>的配置文件支持灵活的配置选项，可以根据需要调整负载均衡策略和参数。此外，<code>HAProxy</code>支持动态更新配置，可以在运行时重新加载配置文件，无需重启服务即可生效</p>
</li>
</ul>
</blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->安装配置<!-- raw HTML omitted --><code>HAProxy</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum install -y haproxy</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->举例：监控<!-- raw HTML omitted --><code>Rabbit</code><!-- raw HTML omitted -->消息队列服务配置<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/haproxy/haproxy.cfg<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">global
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # log /yougo/haproxy/home/log    local0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # log /yougo/haproxy/home/log    local1 notice
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # chroot /yougo/haproxy  	# 改变当前工作目录
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # stats socket /yougo/haproxy/home/admin.sock mode 660 level admin  	# 创建监控所用的套接字目录
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> pidfile  /var/run/haproxy.pid  	# haproxy的pid存放路径,启动进程的用户必须有权限访问此文件 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> maxconn  4000  	# 最大连接数，默认4000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> #  user   haproxy  	# 默认用户
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> #  group   haproxy  	# 默认用户组
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> daemon  	# 创建1个进程进入deamon模式运行。此参数要求将运行模式设置为&#34;daemon
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # Default SSL material locations
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # ca-base /etc/ssl/certs
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # crt-base /etc/ssl/private
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # Default ciphers to use on SSL-enabled listening sockets.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # For more information, see ciphers(1SSL). This list is from:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> #  https://hynek.me/articles/hardening-your-web-servers-ssl-ciphers/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # ssl-default-bind-ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AESGCM:RSA+AES:RSA+3DES:!aNULL:!MD5:!DSS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # ssl-default-bind-options no-sslv3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">###########默认配置#########
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">defaults
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> log global
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> mode    http  	# 默认的模式mode { tcp|http|health }，tcp是4层，http是7层，health只会返回OK
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> option  httplog  	# 采用http日志格式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> option  dontlognull  	# 启用该项，日志中将不会记录空连接。所谓空连接就是在上游的负载均衡器或者监控系统为了探测该服务是否存活可用时,需要定期的连接或者获取某一固定的组件或页面,或者探测扫描端口是否在监听或开放等动作被称为空连接;官方文档中标注，如果该服务上游没有其他的负载均衡器的话，建议不要使用该参数，因为互联网上的恶意扫描或其他动作就不会被记录下来
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> timeout connect 5000  	# 连接超时时间
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> timeout client  50000  	# 客户端连接超时时间
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> timeout server  50000  	# 服务器端连接超时时间
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> option  httpclose  	# 每次请求完毕后主动关闭http通道 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> option  httplog  	# 日志类别http日志格式 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> #option  forwardfor  	# 如果后端服务器需要获得客户端真实ip需要配置的参数，可以从Http Header中获得客户端ip  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> option  redispatch  	# serverId对应的服务器挂掉后,强制定向到其他健康的服务器
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> timeout connect 10000  	# default 10 second timeout if a backend is not found
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> maxconn     60000  	# 最大连接数
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> retries     3  	# 3次连接失败就认为服务不可用，也可以通过后面设置 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # errorfile 400 /yougo/haproxy/home/errors/400.http
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # errorfile 403 /yougo/haproxy/home/errors/403.http
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # errorfile 408 /yougo/haproxy/home/errors/408.http
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # errorfile 500 /yougo/haproxy/home/errors/500.http
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # errorfile 502 /yougo/haproxy/home/errors/502.http
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # errorfile 503 /yougo/haproxy/home/errors/503.http
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # errorfile 504 /yougo/haproxy/home/errors/504.http
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">listen http_front
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     bind 0.0.0.0:8888  	# HAProxy 服务端口  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     stats refresh 30s  	# 统计页面自动刷新时间  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     stats uri /haproxy?stats  	# 统计页面url  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     stats realm Haproxy Manager  	# 统计页面密码框上提示文本  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     stats auth admin:admin  	# 统计页面用户名和密码设置  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     #stats hide-version  	# 隐藏统计页面上HAProxy的版本信息
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##########  RabbitMQ的管理界面也放在HAProxy后面了 ################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#listen rabbitmq_admin 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#    bind 0.0.0.0:8004
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#   server node1 192.168.0.31:15672
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#    server node2 192.168.0.32:15672
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#    server node3 192.168.0.33:15672
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">listen rabbitmq_cluster
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> bind 0.0.0.0:8889  	# rabbitmq集群调用的端口
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> option tcplog
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> mode tcp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> timeout client  3h
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> timeout server  3h
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> option          clitcpka
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> balance roundrobin  	# 负载均衡算法（#banlance roundrobin 轮询，balance source 保存session值，支持static-rr，leastconn，first，uri等参数）
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # balance url_param userid
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # balance url_param session_id check_post 64
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # balance hdr(User-Agent)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # balance hdr(host)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # balance hdr(Host) use_domain_only
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # balance rdp-cookie
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # balance leastconn
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # balance source //ip
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> server   rabbitmq1  172.16.0.30:5672 check inter 5s rise 2 fall 3  	# check inter 2000 是检测心跳频率，rise 2是2次正确认为服务器可用，fall 3是3次失败认为服务器不可用
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> server   rabbitmq2  172.16.0.31:5672 check inter 5s rise 2 fall 3  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> server   rabbitmq3  172.16.0.32:5672 check inter 5s rise 2 fall 3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span> </span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->启动<!-- raw HTML omitted --><code>HAProxy</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl enable haproxy <span style="color:#f92672">&amp;&amp;</span> systemctl start haproxy</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          </section>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_system">Install_System</h1>


            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Install_System</h1>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_cobbler">Install_Cobbler</h1>

<h2 id="cobbler简介"><code>Cobbler</code>简介</h2>
<blockquote>
<ul>
<li><code>Cobbler</code>是一个快速网络安装<code>linux</code>的服务，而且在经过调整也可以支持网络安装<code>windows</code>。该工具使用<code>python</code>开发，小巧轻便（才<code>15k</code>行<code>python</code>代码），使用简单的命令即可完成<code>PXE</code>网络安装环境的配置，同时还可以管理<code>DHCP</code>、<code>DNS</code>、<code>TFTP</code>、<code>RSYNC</code>以及<code>yum</code>仓库、构造系统<code>ISO</code>镜像</li>
<li><code>Cobbler</code>支持命令行管理，<code>web</code>界面管理，还提供了<code>API</code>接口，可以方便二次开发使用</li>
<li><code>Cobbler</code>客户端<code>Koan</code>支持虚拟机安装和操作系统重新安装，使重装系统更便捷</li>
<li>运维自动化在生产环境中占据着举足轻重的地位，尤其是面对几百台，几千台甚至几万台的服务器时，仅仅是安装操作系统，如果不通过自动化来完成，根本是不可想象的。</li>
<li>面对生产环境中不同服务器的需求，该如何实现批量部署多版本的操作系统呢？<code>Cobbler</code>便可以的满足这一实际需求，实现多版本操作系统批量部署</li>
<li><code>Cobbler</code>各个组件之间关系</li>
</ul>
<blockquote>
<ul>
<li><code>distro</code>-&gt;<code>profile-system</code>(可选)</li>
</ul>
<p><a href="#R-image-060b31d9b6e1ee2fa2271f2ecb7ab86b" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Cobbler_Server/cobbler.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-060b31d9b6e1ee2fa2271f2ecb7ab86b"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Cobbler_Server/cobbler.png"></a></p>
</blockquote>
<ul>
<li><code>distro</code>发行版</li>
</ul>
<blockquote>
<ul>
<li>面对不同的操作系统</li>
<li>面对同一个操作系统不同的版本</li>
</ul>
</blockquote>
<ul>
<li><code>profile</code></li>
</ul>
<blockquote>
<ul>
<li>核心特性是通过<code>kickstart</code>来部署</li>
</ul>
</blockquote>
<ul>
<li><code>system</code></li>
</ul>
<blockquote>
<ul>
<li>主要目的配置网络接口</li>
</ul>
</blockquote>
</blockquote>
<hr>
<h3 id="cobbler功能"><code>Cobbler</code>功能</h3>
<blockquote>
<ul>
<li>使用<code>Cobbler</code>，您无需进行人工干预即可安装机器。<code>Cobbler</code>设置一个<code>PXE</code>引导环境（它还可使用<code>yaboot</code>支持<code>PowerPC</code>），并控制与安装相关的所有方面，比如网络引导服务（<code>DHCP</code>和<code>TFTP</code>）与存储库镜像。当希望安装一台新机器时，<code>Cobbler</code>可以：使用一个以前定义的模板来配置<code>DHCP</code>服务（如果启用了管理<code>DHCP</code>）将一个存储库（<code>yum</code>或<code>rsync</code>）建立镜像或解压缩一个媒介，以注册一个新操作系统，在<code>DHCP</code>配置文件中为需要安装的机器创建一个条目，并使用您指定的参数（<code>IP</code>和<code>MAC</code>地址），在<code>TFTFP</code>服务目录下创建适当的<code>PXE</code>文件，重新启动<code>DHCP</code>服务以反映更改，重新启动机器以开始安装（如果电源管理已启用）</li>
<li><code>Cobbler</code>支持众多的发行版：<code>Red Hat</code>、<code>Fedora</code>、<code>CentOS</code>、<code>Debian</code>、<code>Ubuntu</code>和<code>SuSE</code>。当添加一个操作系统（通常通过使用<code>ISO</code>文件）时，<code>Cobbler</code>知道如何解压缩合适的文件并调整网络服务，以正确引导机器。</li>
<li><code>Cobbler</code>可使用<code>kickstart</code>模板。基于<code>Red Hat</code>或<code>Fedora</code>的系统使用<code>kickstart</code>文件来自动化安装流程。通过使用模板，您就会拥有基本的<code>kickstart</code>模板，然后定义如何针对一种配置文件或机器配置而替换其中的变量。例如，一个模板可能包含两个变量<code>$domain</code>和<code>$machine_name</code>。在 <code>Cobbler</code>配置中，一个配置文件指定<code>domain=mydomain.com</code>，并且每台使用该配置文件的机器在<code>machine_name</code>变量中指定其名称。该配置文件中的所有机器都使用相同的<code>kickstart</code>安装且针对 <code>domain=mydomain.com</code>进行配置，但每台机器拥有其自己的机器名称。您仍然可以使用<code>kickstart</code>模板在不同的域中安装其他机器并使用不同的机器名称。</li>
<li>为了协助管理系统，Cobbler 可通过 fence scripts 连接到各种电源管理环境。</li>
<li><code>Cobbler</code>支持<code>apc_snmp</code>、<code>bladecenter</code>、<code>bullpap</code>、<code>drac</code>、<code>ether_wake</code>、<code>ilo</code>、<code>integrity</code>、<code>ipmilan</code>、<code>ipmitool</code>、<code>lpar</code>、<code>rsa</code>、<code>virsh</code>和<code>wti</code>。要重新安装一台机器，可运行<code>reboot system foo</code>命令，而且<code>Cobbler</code>会使用必要的凭据和信息来为您运行恰当的<code>fence scripts</code>（比如机器插槽数）</li>
<li>除了这些特性，还可使用一个配置管理系统 (<code>CMS</code>)。您有两种选择：该工具内的一个内部系统，或者集成一个现有的外部<code>CMS</code>，比如<code>Chef</code>或<code>Puppet</code>。借助内部系统，您可以指定文件模板，这些模板会依据配置参数进行处理（与<code>kickstart</code>模板的处理方式一样），然后复制到您指定的位置。如果必须自动将配置文件部署到特定机器，那么此功能很有用</li>
<li>使用<code>koan</code>客户端，<code>Cobbler</code>可从客户端配置虚拟机并重新安装系统。我不会讨论配置管理和<code>koan</code>特性，因为它们不属于本文的介绍范畴。但是，它们是值得研究的有用特性</li>
</ul>
</blockquote>
<hr>
<h3 id="cobbler自动部署"><code>Cobbler</code>自动部署</h3>
<h4 id="基础环境准备">基础环境准备</h4>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->提示：虚拟机网卡采用<!-- raw HTML omitted --><code>NAT</code><!-- raw HTML omitted -->模式，因为我们会搭建<!-- raw HTML omitted --><code>DHCP</code><!-- raw HTML omitted -->服务器，在同一局域网多个<!-- raw HTML omitted --><code>DHCP</code><!-- raw HTML omitted -->服务会有冲突，并且导致实践失败<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat /etc/redhat-release  	<span style="color:#75715e"># 系统版本</span>
</span></span><span style="display:flex;"><span>$ uname –r  	<span style="color:#75715e"># 内核版本</span>
</span></span><span style="display:flex;"><span>$ getenforce  	<span style="color:#75715e"># 检测selinux是否关闭(必须关闭)</span>
</span></span><span style="display:flex;"><span>$ systemctl stop firewalld  	<span style="color:#75715e"># 关闭防火墙</span>
</span></span><span style="display:flex;"><span>$ ifconfig eth0|awk -F <span style="color:#e6db74">&#39;[ :]+&#39;</span> <span style="color:#e6db74">&#39;NR==2 {print $3}&#39;</span>  	<span style="color:#75715e"># 查看IP地址</span>
</span></span><span style="display:flex;"><span>$ hostname  	<span style="color:#75715e"># 查看主机名</span>
</span></span><span style="display:flex;"><span>$ wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo  	<span style="color:#75715e"># cobbler安装必须使用到epel源</span></span></span></code></pre></div></blockquote>
<hr>
<h4 id="安装cobbler">安装<code>Cobbler</code></h4>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum install cobbler cobbler-web pykickstart httpd tftp dhcp xinetd
</span></span><span style="display:flex;"><span>cobbler  	<span style="color:#75715e"># cobbler程序包</span>
</span></span><span style="display:flex;"><span>cobbler-web  	<span style="color:#75715e"># cobbler的web服务包</span>
</span></span><span style="display:flex;"><span>pykickstart  	<span style="color:#75715e"># cobbler检查kickstart语法错误</span>
</span></span><span style="display:flex;"><span>httpd  	<span style="color:#75715e"># Apache web服务</span>
</span></span><span style="display:flex;"><span>tftp  	<span style="color:#75715e"># tftp服务</span>
</span></span><span style="display:flex;"><span>dhcp  	<span style="color:#75715e"># dhcp服务</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/etc/cobbler  	<span style="color:#75715e"># 配置文件目录</span>
</span></span><span style="display:flex;"><span>/etc/cobbler/settings  	<span style="color:#75715e"># cobbler主配置文件</span>
</span></span><span style="display:flex;"><span>/etc/cobbler/dhcp.template  	<span style="color:#75715e"># DHCP服务的配置模板</span>
</span></span><span style="display:flex;"><span>/etc/cobbler/tftpd.template  	<span style="color:#75715e"># tftp服务的配置模板</span>
</span></span><span style="display:flex;"><span>/etc/cobbler/rsync.template  	<span style="color:#75715e"># rsync服务的配置模板</span>
</span></span><span style="display:flex;"><span>/etc/cobbler/iso  	<span style="color:#75715e"># iso模板配置文件目录</span>
</span></span><span style="display:flex;"><span>/etc/cobbler/pxe  	<span style="color:#75715e"># pxe模板文件目录</span>
</span></span><span style="display:flex;"><span>/etc/cobbler/power  	<span style="color:#75715e"># 电源的配置文件目录</span>
</span></span><span style="display:flex;"><span>/etc/cobbler/users.conf  	<span style="color:#75715e"># Web服务授权配置文件</span>
</span></span><span style="display:flex;"><span>/etc/cobbler/users.digest  	<span style="color:#75715e"># web访问的用户名密码配置文件</span>
</span></span><span style="display:flex;"><span>/etc/cobbler/dnsmasq.template  	<span style="color:#75715e"># DNS服务的配置模板</span>
</span></span><span style="display:flex;"><span>/etc/cobbler/modules.conf  	<span style="color:#75715e"># Cobbler模块配置文件</span>
</span></span><span style="display:flex;"><span>/var/lib/cobbler  	<span style="color:#75715e"># Cobbler数据目录</span>
</span></span><span style="display:flex;"><span>/var/lib/cobbler/config  	<span style="color:#75715e"># 配置文件</span>
</span></span><span style="display:flex;"><span>/var/lib/cobbler/kickstarts  	<span style="color:#75715e"># 默认存放kickstart文件</span>
</span></span><span style="display:flex;"><span>/var/lib/cobbler/loaders  	<span style="color:#75715e"># 存放的各种引导程序</span>
</span></span><span style="display:flex;"><span>/var/www/cobbler  	<span style="color:#75715e"># 系统安装镜像目录</span>
</span></span><span style="display:flex;"><span>/var/www/cobbler/ks_mirror  	<span style="color:#75715e"># 导入的系统镜像列表</span>
</span></span><span style="display:flex;"><span>/var/www/cobbler/images  	<span style="color:#75715e"># 导入的系统镜像启动文件</span>
</span></span><span style="display:flex;"><span>/var/www/cobbler/repo_mirror  	<span style="color:#75715e"># yum源存储目录</span>
</span></span><span style="display:flex;"><span>/var/log/cobbler  	<span style="color:#75715e"># 日志目录</span>
</span></span><span style="display:flex;"><span>/var/log/cobbler/install.log  	<span style="color:#75715e"># 客户端系统安装日志</span>
</span></span><span style="display:flex;"><span>/var/log/cobbler/cobbler.log  	<span style="color:#75715e"># cobbler日志</span></span></span></code></pre></div></blockquote>
<hr>
<h4 id="检测cobbler">检测<code>Cobbler</code></h4>
<blockquote>
<ul>
<li>
<p><code>cobbler</code>的运行依赖于<code>dhcp</code>、<code>tftp</code>、<code>rsync</code>及<code>dns</code>服务，其中<code>dhcp</code>可由<code>dhcpd（isc）</code>提供，也可由<code>dnsmasq</code>提供；<code>tftp</code>可由<code>tftp-server</code>程序包提供，也可由<code>cobbler</code>功能提供，<code>rsync</code>有<code>rsync</code>程序包提供，<code>dns</code>可由<code>bind</code>提供，也可由<code>dnsmasq</code>提供</p>
</li>
<li>
<p><code>cobbler</code>可自行管理这些服务中的部分甚至是全部，但需要配置<code>/etc/cobbler/settings</code>文件中的<code>manange_dhcp</code>、<code>manager_tftpd</code>、<code>manager_rsync</code>、<code>manager_dns</code>分别来进行定义，另外，由于各种服务都有着不同的实现方式，如若需要进行自定义，需要通过修改<code>/etc/cobbler/modules.conf</code>配置文件中各服务的模块参数的值来实现</p>
</li>
<li>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl start httpd  	<span style="color:#75715e"># 启动apache服务</span>
</span></span><span style="display:flex;"><span>$ systemctl start cobblerd  	<span style="color:#75715e"># 启动cobbler程序</span></span></span></code></pre></div></li>
</ul>
<blockquote>
<ul>
<li>检查配置文件，需要在<code>cobblerd</code>和<code>httpd</code>启动的情况下检查</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl start httpd  	<span style="color:#75715e"># 启动apache服务</span>
</span></span><span style="display:flex;"><span>$ systemctl start cobblerd  	<span style="color:#75715e"># 启动cobbler程序</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 检查配置文件，需要在cobblerd和httpd启动的情况下检查</span>
</span></span><span style="display:flex;"><span>$ cobbler check  	<span style="color:#75715e"># 检查存在的问题,逐一解决</span>
</span></span><span style="display:flex;"><span>The following are potential configuration items that you may want to fix:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span> : The <span style="color:#e6db74">&#39;server&#39;</span> field in /etc/cobbler/settings must be set to something other than localhost, or kickstarting features will not work.  This should be a resolvable hostname or IP <span style="color:#66d9ef">for</span> the boot server as reachable by all machines that will use it.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span> : For PXE to be functional, the <span style="color:#e6db74">&#39;next_server&#39;</span> field in /etc/cobbler/settings must be set to something other than 127.0.0.1, and should match the IP of the boot server on the PXE network.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span> : change <span style="color:#e6db74">&#39;disable&#39;</span> to <span style="color:#e6db74">&#39;no&#39;</span> in /etc/xinetd.d/tftp
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4</span> : some network boot-loaders are missing from /var/lib/cobbler/loaders, you may run <span style="color:#e6db74">&#39;cobbler get-loaders&#39;</span> to download them, or, <span style="color:#66d9ef">if</span> you only want to handle x86/x86_64 netbooting, you may ensure that you have installed a *recent* version of the syslinux package installed and can ignore this message entirely.  Files in this directory, should you want to support all architectures, should include pxelinux.0, menu.c32, elilo.efi, and yaboot. The <span style="color:#e6db74">&#39;cobbler get-loaders&#39;</span> command is the easiest way to resolve these requirements.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">5</span> : enable and start rsyncd.service with systemctl
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">6</span> : debmirror package is not installed, it will be required to manage debian deployments and repositories
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">7</span> : The default password used by the sample templates <span style="color:#66d9ef">for</span> newly installed machines <span style="color:#f92672">(</span>default_password_crypted in /etc/cobbler/settings<span style="color:#f92672">)</span> is still set to <span style="color:#e6db74">&#39;cobbler&#39;</span> and should be changed, try: <span style="color:#e6db74">&#34;openssl passwd -1 -salt &#39;random-phrase-here&#39; &#39;your-password-here&#39;&#34;</span> to generate new one
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8</span> : fencing tools were not found, and are required to use the <span style="color:#f92672">(</span>optional<span style="color:#f92672">)</span> power management features. install cman or fence-agents to use them
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Restart cobblerd and <span style="color:#66d9ef">then</span> run <span style="color:#e6db74">&#39;cobbler sync&#39;</span> to apply changes.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 如上各问题的解决方法如下所示：</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1. 修改/etc/cobbler/settings文件中的server参数的值为提供cobbler服务的主机相应的IP地址或主机名，如server: 10.0.0.101；</span>
</span></span><span style="display:flex;"><span>$  sed -i <span style="color:#e6db74">&#39;s/server: 127.0.0.1/server: 10.0.0.101/&#39;</span> /etc/cobbler/settings
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2. 修改/etc/cobbler/settings文件中的next_server参数的值为提供PXE服务的主机相应的IP地址，如next_server: 10.0.0.101；</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s/next_server: 127.0.0.1/next_server: 10.0.0.101/&#39;</span> /etc/cobbler/settings
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3. 修改/etc/xinetd.d/tftp文件中的disable参数修改为 disable = no</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 4. 执行 cobbler get-loaders 命令即可；否则，需要安装syslinux程序包，而后复制/usr/share/syslinux/{pxelinux.0,memu.c32}等文件至/var/lib/cobbler/loaders/目录中；</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 5. 执行 systemctl enable rsyncd命令即可；</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 6. 如果有强迫症可以选择 yum –y install debmirror 然后根据错误进行解决,一般错误如下。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 注释/etc/dedmirror.conf文件中的  @dists=”sid”;  @arches=”i386”; </span>
</span></span><span style="display:flex;"><span>$ openssl passwd -1 -salt <span style="color:#e6db74">&#39;$(openssl rand -hex 4)&#39;</span> <span style="color:#e6db74">&#39;xuliangwei&#39;</span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># $1$$(openss$.wbDUBV/STL0YaNuAcusK/  	# 返回参数</span>
</span></span><span style="display:flex;"><span>$ grep <span style="color:#e6db74">&#34;default_password_crypted&#34;</span> /etc/cobbler/settings  	<span style="color:#75715e"># 替换/etc/cobbler/setting内的default_password_crypted default_password_crypted: &#34;$1$$(openss$.wbDUBV/STL0YaNuAcusK/&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 7. yum –y install cman fence-agents</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 最后重启Cobbler：systemctl restart cobblerd </span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h4 id="配置dhcp">配置<code>DHCP</code></h4>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s#manage_dhcp: 0#manage_dhcp: 1#g&#39;</span> /etc/cobbler/settings  	<span style="color:#75715e"># 使用cobbler管理dhcp</span>
</span></span><span style="display:flex;"><span>$ vim /etc/cobbler/dhcp.template  	<span style="color:#75715e"># 修改cobbler的dhcp模版，因为cobbler会替换。</span>
</span></span><span style="display:flex;"><span>subnet 10.0.0.0 netmask 255.255.255.0 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  option routers             10.0.0.2;
</span></span><span style="display:flex;"><span>  option domain-name-servers 10.0.0.2;
</span></span><span style="display:flex;"><span>  option subnet-mask         255.255.255.0;
</span></span><span style="display:flex;"><span>  range dynamic-bootp        10.0.0.200 10.0.0.250;
</span></span><span style="display:flex;"><span>  default-lease-time         21600;
</span></span><span style="display:flex;"><span>  max-lease-time             43200;
</span></span><span style="display:flex;"><span>  next-server                $next_server;</span></span></code></pre></div></blockquote>
<hr>
<h4 id="同步cobbler">同步<code>Cobbler</code></h4>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl restart xinetd  	<span style="color:#75715e"># 重启xinetd</span>
</span></span><span style="display:flex;"><span>$ systemctl restart cobblerd  	<span style="color:#75715e"># 重启cobbler</span>
</span></span><span style="display:flex;"><span>$ cobbler sync  	<span style="color:#75715e"># 同步最新cobbler配置，可以看具体做了哪些操作</span>
</span></span><span style="display:flex;"><span>task started: 2016-04-29_234117_sync
</span></span><span style="display:flex;"><span>task started <span style="color:#f92672">(</span>id<span style="color:#f92672">=</span>Sync, time<span style="color:#f92672">=</span>Fri Apr <span style="color:#ae81ff">29</span> 23:41:17 2016<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>running pre-sync triggers
</span></span><span style="display:flex;"><span>cleaning trees
</span></span><span style="display:flex;"><span>removing: /var/lib/tftpboot/pxelinux.cfg/default
</span></span><span style="display:flex;"><span>removing: /var/lib/tftpboot/grub/images
</span></span><span style="display:flex;"><span>removing: /var/lib/tftpboot/grub/grub-x86.efi
</span></span><span style="display:flex;"><span>removing: /var/lib/tftpboot/grub/grub-x86_64.efi
</span></span><span style="display:flex;"><span>removing: /var/lib/tftpboot/grub/efidefault
</span></span><span style="display:flex;"><span>removing: /var/lib/tftpboot/s390x/profile_list
</span></span><span style="display:flex;"><span>copying bootloaders
</span></span><span style="display:flex;"><span>trying hardlink /var/lib/cobbler/loaders/grub-x86.efi -&gt; /var/lib/tftpboot/grub/grub-x86.efi
</span></span><span style="display:flex;"><span>trying hardlink /var/lib/cobbler/loaders/grub-x86_64.efi -&gt; /var/lib/tftpboot/grub/grub-x86_64.efi
</span></span><span style="display:flex;"><span>copying distros to tftpboot
</span></span><span style="display:flex;"><span>copying images
</span></span><span style="display:flex;"><span>generating PXE configuration files
</span></span><span style="display:flex;"><span>generating PXE menu structure
</span></span><span style="display:flex;"><span>rendering DHCP files
</span></span><span style="display:flex;"><span>generating /etc/dhcp/dhcpd.conf
</span></span><span style="display:flex;"><span>rendering TFTPD files
</span></span><span style="display:flex;"><span>generating /etc/xinetd.d/tftp
</span></span><span style="display:flex;"><span>cleaning link caches
</span></span><span style="display:flex;"><span>running post-sync triggers
</span></span><span style="display:flex;"><span>running python triggers from /var/lib/cobbler/triggers/sync/post/*
</span></span><span style="display:flex;"><span>running python trigger cobbler.modules.sync_post_restart_services
</span></span><span style="display:flex;"><span>running: dhcpd -t -q
</span></span><span style="display:flex;"><span>received on stdout: 
</span></span><span style="display:flex;"><span>received on stderr: 
</span></span><span style="display:flex;"><span>running: service dhcpd restart
</span></span><span style="display:flex;"><span>received on stdout: 
</span></span><span style="display:flex;"><span>received on stderr: Redirecting to /bin/systemctl restart  dhcpd.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>running shell triggers from /var/lib/cobbler/triggers/sync/post/*
</span></span><span style="display:flex;"><span>running python triggers from /var/lib/cobbler/triggers/change/*
</span></span><span style="display:flex;"><span>running python trigger cobbler.modules.scm_track
</span></span><span style="display:flex;"><span>running shell triggers from /var/lib/cobbler/triggers/change/*
</span></span><span style="display:flex;"><span>*** TASK COMPLETE ***</span></span></code></pre></div></blockquote>
<hr>
<h4 id="管理cobbler">管理<code>Cobbler</code></h4>
<ul>
<li>
<ol>
<li>管理<code>distro</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>cobbler</code>变得可用的第一步为定义<code>distro</code>，其可以通过为其指定外部的安装引导内核及<code>ramdisk文</code>件的方式实现。如果已经有完成的安装树（如<code>os</code>的安装镜像）则推荐使用<code>improt</code>之间导入的方式进行</li>
<li>如果有<code>kickstart</code>文件，也可以使用<code>--kickstart=/path/to/kickstart_file</code>进行导入，因此<code>import</code>会自动为导入的<code>distro</code>生成一个<code>profile</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mount /dev/cdrom /mnt/  	<span style="color:#75715e"># 挂在ISO光盘至服务器</span>
</span></span><span style="display:flex;"><span>mount: /dev/sr0 is write-protected, mounting read-only
</span></span><span style="display:flex;"><span>$ cobbler import --path<span style="color:#f92672">=</span>/mnt/ --name<span style="color:#f92672">=</span>CentOS-7.1-x86_64-distro --arch<span style="color:#f92672">=</span>x86_64
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --path 镜像路径</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --name 为安装源定义一个名字</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --arch 指定安装源是32位、64位、ia64, 目前支持的选项有: x86│x86_64│ia64</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装源的唯一标示就是根据name参数来定义，本例导入成功后，安装源的唯一标示就是：CentOS-7.1-distro-x86_64。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 镜像存放目录，cobbler会将镜像中的所有安装文件拷贝到本地一份，放在/var/www/cobbler/ks_mirror下的CentOS-7.1-x86_64-distro-x86_64目录下。因此/var/www/cobbler目录必须具有足够容纳安装文件的空间。</span>
</span></span><span style="display:flex;"><span>task started: 2016-04-30_010122_import
</span></span><span style="display:flex;"><span>task started <span style="color:#f92672">(</span>id<span style="color:#f92672">=</span>Media import, time<span style="color:#f92672">=</span>Sat Apr <span style="color:#ae81ff">30</span> 01:01:22 2016<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Found a candidate signature: breed<span style="color:#f92672">=</span>redhat, version<span style="color:#f92672">=</span>rhel6
</span></span><span style="display:flex;"><span>Found a candidate signature: breed<span style="color:#f92672">=</span>redhat, version<span style="color:#f92672">=</span>rhel7
</span></span><span style="display:flex;"><span>Found a matching signature: breed<span style="color:#f92672">=</span>redhat, version<span style="color:#f92672">=</span>rhel7
</span></span><span style="display:flex;"><span>Adding distros from path /var/www/cobbler/ks_mirror/CentOS-7.1-x86_64-distro-x86_64:
</span></span><span style="display:flex;"><span>creating new distro: CentOS-7.1-distro-x86_64
</span></span><span style="display:flex;"><span>trying symlink: /var/www/cobbler/ks_mirror/CentOS-7.1-x86_64-distro-x86_64 -&gt; /var/www/cobbler/links/CentOS-7.1-distro-x86_64
</span></span><span style="display:flex;"><span>creating new profile: CentOS-7.1-distro-x86_64
</span></span><span style="display:flex;"><span>associating repos
</span></span><span style="display:flex;"><span>checking <span style="color:#66d9ef">for</span> rsync repo<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>checking <span style="color:#66d9ef">for</span> rhn repo<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>checking <span style="color:#66d9ef">for</span> yum repo<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>starting descent into /var/www/cobbler/ks_mirror/CentOS-7.1-x86_64-distro-x86_64 <span style="color:#66d9ef">for</span> CentOS-7.1-distro-x86_64
</span></span><span style="display:flex;"><span>processing repo at : /var/www/cobbler/ks_mirror/CentOS-7.1-x86_64-distro-x86_64
</span></span><span style="display:flex;"><span>need to process repo/comps: /var/www/cobbler/ks_mirror/CentOS-7.1-x86_64-distro-x86_64
</span></span><span style="display:flex;"><span>looking <span style="color:#66d9ef">for</span> /var/www/cobbler/ks_mirror/CentOS-7.1-x86_64-distro-x86_64/repodata/*comps*.xml
</span></span><span style="display:flex;"><span>Keeping repodata as-is :/var/www/cobbler/ks_mirror/CentOS-7.1-x86_64-distro-x86_64/repodata
</span></span><span style="display:flex;"><span>*** TASK COMPLETE ***
</span></span><span style="display:flex;"><span>$ cobbler distro list  	<span style="color:#75715e"># 列出所有的distro</span>
</span></span><span style="display:flex;"><span>   CentOS-7.1-distro-x86_64
</span></span><span style="display:flex;"><span>$ cobbler profile list  	<span style="color:#75715e"># 导入distro会自动生成profile</span>
</span></span><span style="display:flex;"><span>   CentOS-7.1-distro-x86_64</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li>管理<code>profile</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>cobbler</code>使用<code>profile</code>来为特定的需求类别提供锁需要安装的配置，即在<code>distro</code>的基础上通过提供<code>kiskstart</code>文件来生成一个特定的系统安装配置。<code>distro</code>的<code>profile</code>可以出现在<code>pxe</code>的引导菜单中作为安装的选择之一</li>
<li><code>Cobbler-CentOS-7.1-x86_64.cfg</code>配置文件我会上传至至附件，默认是有<code>kickstart</code>文件的，所以<code>edit</code>，如果没有<code>kickstart</code>文件可以<code>add</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cobbler profile edit --name<span style="color:#f92672">=</span>Centos7.1-distro-x86_64 --kickstart<span style="color:#f92672">=</span>/var/lib/cobbler/kickstarts/Cobbler-CentOS-7.1-x86_64.cfg  	<span style="color:#75715e"># 指定ks路径</span></span></span></code></pre></div><ul>
<li><code>CentOS7</code>系统网卡名变成<code>eno...</code>这种，为了运维标准化，我们需要修改为我们常用的<code>eth0</code>，使用下面的参数。但要注意是<code>CentOS7</code>才需要下面的步骤，<code>CentOS6</code>不需要</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cobbler profile edit --name<span style="color:#f92672">=</span>Centos7.1-distro-x86_64 --kopts<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;net.ifnames=0 biosdevname=0&#39;</span>  	<span style="color:#75715e"># 修改centos7内核</span></span></span></code></pre></div><ul>
<li>新部署机器安装<code>yum</code>源，并同步。建议使用内网<code>yum</code>源，在这里使用阿里云<code>yum</code>源</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cobbler repo add --name<span style="color:#f92672">=</span>base --mirror<span style="color:#f92672">=</span>http://mirrors.aliyun.com/centos/7/os/x86_64/Packages/ --arch<span style="color:#f92672">=</span>x86_64 --breed<span style="color:#f92672">=</span>yum  	<span style="color:#75715e"># 添加yum源</span>
</span></span><span style="display:flex;"><span>$ cobbler reposync  	<span style="color:#75715e"># 同步yum源</span>
</span></span><span style="display:flex;"><span>$ cobbler sync  	<span style="color:#75715e"># 每次修改profile都需要同步</span></span></span></code></pre></div></blockquote>
<hr>
<h4 id="署操作系统">署操作系统</h4>
<ul>
<li>
<ol>
<li>新建一台虚拟机，通过网络启动即可。（我这里虚拟机使用的是<code>NAT</code>模式,并且关闭<code>DHCP</code>功能）</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>用户：<code>root</code></li>
<li>密码：<code>xuliangwei</code></li>
<li><code>openssl</code>生成时指定</li>
</ul>
<p><a href="#R-image-02dc6a8b5f19461ce70e4f266aa33686" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Deploy_Server/Cobbler.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-02dc6a8b5f19461ce70e4f266aa33686"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Deploy_Server/Cobbler.png"></a></p>
</blockquote>
<ul>
<li>
<ol start="2">
<li>定制化安装</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>由于<code>kickstart</code>指定某台服务器使用某个<code>ks</code>文件比较复杂，所以引用<code>Cobbler</code>就很简单。通过物理<code>MAC</code>地址来区分</li>
<li>自定义安装：<code>system</code>主要目的配置网络接口，通过<code>system</code>来固定机器的<code>IP</code>、掩码、网关、<code>DNS</code>、主机名、等等实现基础环境标准化</li>
<li>根据机器的<code>MAC</code>地址，自动绑定<code>IP</code>，网关，<code>dns</code>等</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cobbler system add --name<span style="color:#f92672">=</span>xuliangwei-pc --mac<span style="color:#f92672">=</span>00:0C:29:6E:41:CB --profile<span style="color:#f92672">=</span>Centos7.1-profile-x86_64 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--ip-address<span style="color:#f92672">=</span>10.0.0.110 --subnet<span style="color:#f92672">=</span>255.255.255.0 --gateway<span style="color:#f92672">=</span>10.0.0.2 --interface<span style="color:#f92672">=</span>eth0 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--static<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> --hostname<span style="color:#f92672">=</span>xuliangwei.com --name-servers<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;114.114.114.114 8.8.8.8&#34;</span>
</span></span><span style="display:flex;"><span>$ cobbler sync
</span></span><span style="display:flex;"><span>$ cobbler system list
</span></span><span style="display:flex;"><span>   xuliangwei-pc</span></span></code></pre></div><p><a href="#R-image-dfd947cfd0c4799a2184e7deb8dbeb06" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Deploy_Server/Cobbler.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-dfd947cfd0c4799a2184e7deb8dbeb06"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Deploy_Server/Cobbler.png"></a></p>
</blockquote>
<ul>
<li>
<ol start="3">
<li>自定义登陆界面</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ grep <span style="color:#e6db74">&#34;xuliangwei&#34;</span> /etc/cobbler/pxe/pxedefault.template  	<span style="color:#75715e"># 自定义装机页面</span>
</span></span><span style="display:flex;"><span>MENU TITLE Xuliangwei | http://xuliangwei.com
</span></span><span style="display:flex;"><span>$ cobbler sync  	<span style="color:#75715e"># 同步</span></span></span></code></pre></div><p><a href="#R-image-961525b00b0d780ef8b530cbeb1b1c56" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Deploy_Server/xuliangwe.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-961525b00b0d780ef8b530cbeb1b1c56"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Deploy_Server/xuliangwe.png"></a></p>
</blockquote>
<ul>
<li>
<ol start="4">
<li><code>web</code>管理<code>Cobbler</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>
<p>新版<code>cobbler</code>的<code>web</code>界面使用的是<code>https</code>，登录https://10.0.0.7/cobbler_web</p>
<p><code>cobbler_web</code>支持多种认证方式，如<code>authn_configfil</code>、<code>authn_ldap</code>或<code>authn_pam</code>等，默认为<code>authn_denyall</code>即拒绝所有用户登陆，下面说明三种能认证用户登录<code>cobbler_web</code>的方式</p>
</li>
<li>
<p><strong>使用<code>authn_pam</code>模块认证<code>cobbler_web</code>用户</strong></p>
</li>
</ul>
<blockquote>
<ul>
<li>首先修改<code>modules</code>中的<code>authentication</code>段中的<code>module</code>参数的值为<code>authn_pam</code>
接着创建系统用户，并为用户设定密码而后将设定的系统用户添加至<code>cobbler_web</code>的<code>admin</code>组中，修改<code>/etc/cobbler/users.conf</code>文件，将设定的用户添加为<code>admin</code>参数的值即可</li>
</ul>
</blockquote>
<ul>
<li><strong>使用<code>authn_configfile</code>模块认证<code>cobbler_web</code>用户</strong></li>
</ul>
<blockquote>
<ul>
<li>首先修改<code>modules</code>中的<code>authentication</code>段中的<code>module</code>参数的值为<code>authn_configfile</code>
添加第一用户时，需要为<code>htdigest</code>命令使用<code>&quot;-c&quot; etc/cobbler/users.digest</code>，后续添加其他用户则不能再使用，同步<code>cobbler</code>重启<code>httpd</code>以及<code>cobbler</code></li>
</ul>
</blockquote>
<ul>
<li><strong>使用<code>cobbler</code>默认的<code>web</code>账号密码认证</strong></li>
</ul>
<blockquote>
<ul>
<li><code>user</code>：<code>cobbler</code></li>
<li><code>pass</code>：<code>cobbler</code></li>
</ul>
<p><a href="#R-image-901f52ab3f27a5bc47355ce1772b2e5d" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Deploy_Server/Cobbler_web.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-901f52ab3f27a5bc47355ce1772b2e5d"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Deploy_Server/Cobbler_web.png"></a></p>
<p><a href="#R-image-13a9c4f2fd0ad791249a4f12b0231fa7" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Deploy_Server/Cobbler_web_1.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-13a9c4f2fd0ad791249a4f12b0231fa7"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Deploy_Server/Cobbler_web_1.png"></a></p>
<p><a href="#R-image-0cc1e6dddfda8ca5483c8401f4ee0aad" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Deploy_Server/Cobbler_web_2.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-0cc1e6dddfda8ca5483c8401f4ee0aad"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Deploy_Server/Cobbler_web_2.png"></a></p>
<p><a href="#R-image-69afece93fa91c3478614376d8996987" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Deploy_Server/Cobbler_web_3.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-69afece93fa91c3478614376d8996987"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Deploy_Server/Cobbler_web_3.png"></a></p>
<p><a href="#R-image-a4be60b739fad8d8920ad5507d11daba" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Deploy_Server/Cobbler_web_4.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-a4be60b739fad8d8920ad5507d11daba"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Deploy_Server/Cobbler_web_4.png"></a></p>
<p><a href="#R-image-6526e48ff876f8a413361572948c30f7" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Deploy_Server/Cobbler_web_5.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-6526e48ff876f8a413361572948c30f7"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Deploy_Server/Cobbler_web_5.png"></a></p>
<p><a href="#R-image-8d2552605639c4f30110871814aa66c8" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Deploy_Server/Cobbler_web_6.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-8d2552605639c4f30110871814aa66c8"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Deploy_Server/Cobbler_web_6.png"></a></p>
</blockquote>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_kickstart">Install_Kickstart</h1>

<h2 id="kickstart无人值守"><code>KICKSTART</code>无人值守</h2>
<h3 id="指令作用介绍">指令作用介绍</h3>
<blockquote>
<ul>
<li>
<p><strong><code>pxe</code></strong></p>
<p><code>PXE</code>使用<code>DHCP</code>（动态主机配置协议）和<code>TFTP</code>（普通文件传送协议）从网络上查找并装载引导程序。<code>PXE</code>环境从<code>NIC</code>（<code>Network Interface Card</code>）上的<code>BIOS</code>装载。预引导服务使用<code>PXE</code>来发现设备是否存在为其指定的预引导服务工作，并向设备提供执行指派工作所需的文件。通过使用预引导服务，可以自动将映像放置到设备上，即使设备的硬盘为空</p>
</li>
<li>
<p><strong><code>pxelinux.0</code></strong></p>
<p>主要作用是装载执行指派的预引导工作所需的操作系统。<code>pxelinux.0</code>文件是<code>syslinux</code>这一开放源代码项目的一部分的改进版本。虽然<code>pxelinux.0</code>主要是<code>Linux</code>加载器，但它也可以装载其他操作系统。它的工作方式是使用位于<code>TFTP</code>服务器上的配置文件来提供引导指令</p>
</li>
<li>
<p><strong><code>vmlinuz</code></strong></p>
<p><code>vmlinuz</code>是<code>Linux</code>内核的镜像文件,可以被引导程序加载,从而启动<code>Linux</code>系统</p>
</li>
<li>
<p><strong><code>initrd</code></strong></p>
<p><code>initrd</code>&mdash;-<code>boot loader initialized RAM disk</code>(全称)，是一种启动<code>Linux</code>系统的方式，当前流行的<code>Linux</code>版本一般都采用模块化的内核,这种方式可以在不重新编译构建内核的情形下增加功能模块，但是如果你的<code>Linux</code>的<code>root</code>文件系统所在设备的驱动是一个模块(没有编译进内核映象),就不能被引导程序(例如<code>loadlin</code>)直接加载，这时会用到<code>initrd</code>方式来启动你的<code>Linux</code>系统</p>
<ul>
<li>这种方式包括两个阶段:</li>
</ul>
<blockquote>
<ol>
<li>在一个<code>RAM disk</code>上建立一个临时的<code>root</code>文件系统,在这个<code>RAM disk</code>上包含着你需要的驱动模块</li>
<li>载入所需驱动模块,挂载实际的<code>root</code>文件系统 ,启动<code>Linux</code></li>
</ol>
</blockquote>
</li>
<li>
<p><strong><code>initrd.img</code></strong></p>
<p>就是<code>RAM disk</code>的映象</p>
</li>
</ul>
</blockquote>
<hr>
<h3 id="pxekickstart工作流程"><code>PXE</code>+<code>Kickstart</code>工作流程</h3>
<blockquote>
<ul>
<li><code>Kickstart</code>是一种无人值守的安装方式。它的工作原理是在安装过程中记录典型的需要人工干预填写的各种参数，并生成一个名为<code>ks.cfg</code>的文件。如果在安装过程中（不只局限于生成<code>Kickstart</code>安装文件的机器）出现要填写参数的情况，安装程序首先会去查找<code>Kickstart</code>生成的文件，如果找到合适的参数，就采用所找到的参数；如果没有找到合适的参数，便需要安装者手工干预了。所以，如果<code>Kickstart</code>文件涵盖了安装过程中可能出现的所有需要填写的参数，那么安装者完全可以只告诉安装程序从何处取<code>ks.cfg</code>文件，然后就去忙自己的事情。等安装完毕，安装程序会根据<code>ks.cfg</code>中的设置重启系统，并结束安装</li>
<li><code>PXE</code>+<code>Kickstart</code>无人值守安装操作系统完整过程如下</li>
</ul>
<blockquote>
<p><a href="#R-image-68d4f207e6f2a7307fbe26c58199a726" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Deploy_Server/PXE+Kickstart.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-68d4f207e6f2a7307fbe26c58199a726"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Deploy_Server/PXE+Kickstart.png"></a></p>
</blockquote>
<ul>
<li>
<p>**<code>PXE Client</code>向<code>DHCP</code>发送请求 **</p>
<p><code>PXE Client</code>从自己的<code>PXE</code>网卡启动，通过<code>PXE BootROM</code>(自启动芯片)会以<code>UDP</code>(简单用户数据报协议)发送一个广播请求，向本网络中的<code>DHCP</code>服务器索取<code>IP</code></p>
</li>
<li>
<p><strong><code>DHCP</code>服务器提供信息</strong></p>
<p><code>DHCP</code>服务器收到客户端的请求，验证是否来至合法的<code>PXE Client</code>的请求，验证通过它将给客户端一个<code>提供</code>响应，这个<code>提供</code>响应中包含了为客户端分配的<code>IP</code>地址、<code>pxelinux</code>启动程序(<code>TFTP</code>)位置，以及配置文件所在位置</p>
</li>
<li>
<p><strong><code>PXE</code>客户端请求下载启动文件</strong></p>
<p>客户端收到服务器的<code>回应</code>后，会回应一个帧，以请求传送启动所需文件。这些启动文件包括：<code>pxelinux.0</code>、<code>pxelinux.cfg/default</code>、<code>vmlinuz</code>、<code>initrd.img</code>等文件</p>
</li>
<li>
<p><strong><code>Boot Server</code>响应客户端请求并传送文件</strong></p>
<p>当服务器收到客户端的请求后，他们之间之后将有更多的信息在客户端与服务器之间作应答, 用以决定启动参数。<code>BootROM</code>由<code>TFTP</code>通讯协议从<code>Boot Server</code>下载启动安装程序所必须的文件(<code>pxelinux.0</code>、<code>pxelinux.cfg/default</code>)。<code>default</code>文件下载完成后，会根据该文件中定义的引导顺序，启动<code>Linux</code>安装程序的引导内核</p>
</li>
<li>
<p><strong>请求下载自动应答文件</strong></p>
<p>客户端通过<code>pxelinux.cfg/default</code>文件成功的引导<code>Linux</code>安装内核后，安装程序首先必须确定你通过什么安装介质来安装<code>linux</code>，如果是通过网络安装(<code>NFS</code>, <code>FTP</code>, <code>HTTP</code>)，则会在这个时候初始化网络，并定位安装源位置。接着会读取<code>default</code>文件中指定的自动应答文件<code>ks.cfg</code>所在位置，根据该位置请求下载该文件</p>
</li>
<li>
<p><strong>客户端安装操作系统</strong></p>
<p>将<code>ks.cfg</code>文件下载回来后，通过该文件找到<code>OS Server</code>，并按照该文件的配置请求下载安装过程需要的软件包。</p>
<p><code>OS Server</code>和客户端建立连接后，将开始传输软件包，客户端将开始安装操作系统。安装完成后，将提示重新引导计算机</p>
</li>
</ul>
</blockquote>
<hr>
<h3 id="安装">安装</h3>
<blockquote>
<ul>
<li><code>Kickstart</code>的安装方式有多种组合，<code>Kickstart</code>+<code>DHCP</code>+<code>TFTP</code>+<code>HTTP/NFS/FTP</code>等，不管是<code>HTTP、NFS</code>或者<code>FTP</code>，都是为了寻找到系统引导后需要安装的包组等文件。下面的安装方式是<code>Kickstart</code>+<code>DHCP</code>+<code>TFTP</code>+<code>HTTP</code></li>
</ul>
</blockquote>
<hr>
<h4 id="dhcp安装配置"><code>DHCP</code>安装配置</h4>
<blockquote>
<ul>
<li>
<p><code>/etc/dhcp/dhcpd.conf </code></p>
</li>
<li>
<p><code>range 10.0.0.100 10.0.0.200;</code>  	# 可分配的起始<code>IP</code>-结束<code>IP</code></p>
</li>
<li>
<p><code>option subnet-mask 255.255.255.0;</code>  	# 设定<code>netmask</code></p>
</li>
<li>
<p><code>default-lease-time 21600;</code>  	# 设置默认的<code>IP</code>租用期限</p>
</li>
<li>
<p><code>max-lease-time 43200;</code>  	# 设置最大的<code>IP</code>租用期限</p>
</li>
<li>
<p><code>next-server 10.0.0.7;</code>       # 告知客户端<code>TFTP</code>服务器的<code>ip</code></p>
</li>
<li>
<p><code>filename &quot;/pxelinux.0&quot;;</code>      # 告知客户端从<code>TFTP</code>根目录下载<code>pxelinux.0</code>文件</p>
</li>
<li>
<p><strong>注意：</strong></p>
<p>如果机器数量过多的话，注意<code>dhcp</code>服务器的地址池，不要因为耗尽<code>IP</code>而导致<code>dhcpd</code>服务器没有<code>IP</code>地址<code>release</code>的情况</p>
<p>本来软件装完后都要加入开机自启动，但这个<code>Kickstart</code>系统就不能开机自启动，而且用完后服务都要关闭，防止未来重启服务器自动重装系统了</p>
</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install dhcp
</span></span><span style="display:flex;"><span>$ vim /etc/dhcp/dhcpd.conf
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># DHCP Server Configuration file.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  see /usr/share/doc/dhcp*/dhcpd.conf.sample</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  see &#39;man 5 dhcpd.conf&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>subnet 10.0.0.0 netmask 255.255.255.0 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>range 10.0.0.201 10.0.0.210;
</span></span><span style="display:flex;"><span>option subnet-mask 255.255.255.0;
</span></span><span style="display:flex;"><span>default-lease-time 21600;
</span></span><span style="display:flex;"><span>max-lease-time 43200;
</span></span><span style="display:flex;"><span>next-server 10.0.0.61;
</span></span><span style="display:flex;"><span>filename <span style="color:#e6db74">&#34;/pxelinux.0&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;/etc/dhcp/dhcpd.conf&#34;</span> 13L, 360C 已写入
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ /etc/init.d/dhcpd start
</span></span><span style="display:flex;"><span>正在启动 dhcpd：                      <span style="color:#f92672">[</span>确定<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>$ netstat -lntup|grep dhcp
</span></span><span style="display:flex;"><span>udp    <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span> 0.0.0.0:67         0.0.0.0:*                2040/dhcpd</span></span></code></pre></div></blockquote>
<hr>
<h4 id="tftp安装配置"><code>TFTP</code>安装配置</h4>
<blockquote>
<ul>
<li><code>TFTP</code>服务器提供文件使用简单文件传输协议。<code>TFTP</code>协议通常用于启动无盘工作站，下载配置文件到客户端，并开始对部分操作系统的安装过程</li>
<li><code>server_args</code> = <code>-s /var/lib/tftpboot</code>  	# 指定<code>boot</code>启动目录，保持默认</li>
<li><code>disable</code> = <code>yes</code>  # <code>no</code>改为<code>yes</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install tftp.server
</span></span><span style="display:flex;"><span>$ vim /etc/xinetd.d/tftp 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># default: off</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># description: The tftp server serves files using the trivial file transfer \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    protocol. The tftp protocol is often used to boot diskless \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    workstations, download configuration files to network-aware printers, \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    and to start the installation process for some operating systems.</span>
</span></span><span style="display:flex;"><span>service tftp
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span> socket_type       <span style="color:#f92672">=</span> dgram
</span></span><span style="display:flex;"><span> protocol        <span style="color:#f92672">=</span> udp
</span></span><span style="display:flex;"><span> wait          <span style="color:#f92672">=</span> yes
</span></span><span style="display:flex;"><span> user          <span style="color:#f92672">=</span> root
</span></span><span style="display:flex;"><span> server         <span style="color:#f92672">=</span> /usr/sbin/in.tftpd
</span></span><span style="display:flex;"><span> server_args       <span style="color:#f92672">=</span> -s /var/lib/tftpboot
</span></span><span style="display:flex;"><span> disable         <span style="color:#f92672">=</span> no
</span></span><span style="display:flex;"><span> per_source       <span style="color:#f92672">=</span> <span style="color:#ae81ff">11</span>
</span></span><span style="display:flex;"><span> cps           <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span> flags          <span style="color:#f92672">=</span> IPv4
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;/etc/xinetd.d/tftp&#34;</span> 18L, 517C 已写入
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ /etc/init.d/xinetd restart
</span></span><span style="display:flex;"><span>停止 xinetd：                       <span style="color:#f92672">[</span>确定<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>正在启动 xinetd：                     <span style="color:#f92672">[</span>确定<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ netstat -lntup|grep xinetd
</span></span><span style="display:flex;"><span>udp    <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span> 0.0.0.0:69         0.0.0.0:*                2066/xinetd</span></span></code></pre></div></blockquote>
<hr>
<h4 id="http安装配置"><code>HTTP</code>安装配置</h4>
<blockquote>
<ul>
<li><code>ServerName</code>指定<code>Nginx</code>用于识别自身的名字和端口号。通常这个值是自动指定的，但是我们推荐你显式的指定它以防止启动时出错。如果你为你的主机指定了一个无效的<code>DNS</code>名，<code>server-generated</code>重定向将不能工作</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;277i ServerName 127.0.0.1:80&#34;</span> /etc/httpd/conf/httpd.conf</span></span></code></pre></div></blockquote>
<ul>
<li>将<code>CentOS-6.7</code>挂载到<code>http</code>服务下</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mount /dev/cdrom /var/www/html/CentOS-6.7/</span></span></code></pre></div></blockquote>
<ul>
<li>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat extra/www.conf 
</span></span><span style="display:flex;"><span>server <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>listen    80;
</span></span><span style="display:flex;"><span>server_name www.ky.com;  	<span style="color:#75715e"># 域名设置</span>
</span></span><span style="display:flex;"><span>autoindex on;  	<span style="color:#75715e"># 不找首页文件，展示目录结构</span>
</span></span><span style="display:flex;"><span>location / <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>   root  /var/www/html/;  	<span style="color:#75715e"># 显示网页内容的文件目录路径</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></li>
<li>
<p>访问浏览器<code>10.0.0.61/CentOS-6.7/</code>查看配置是否正确</p>
</li>
</ul>
<blockquote>
<p><a href="#R-image-67b1568a3050a2462c18baac805483de" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Deploy_Server/Index.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-67b1568a3050a2462c18baac805483de"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Deploy_Server/Index.png"></a></p>
</blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install httpd
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;277i ServerName 127.0.0.1:80&#34;</span> /etc/httpd/conf/httpd.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ /etc/init.d/httpd start
</span></span><span style="display:flex;"><span>正在启动 httpd：                      <span style="color:#f92672">[</span>确定<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ netstat -lntup|grep <span style="color:#e6db74">&#34;httpd&#34;</span>
</span></span><span style="display:flex;"><span>tcp    <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span> :::80            :::*            LISTEN   2085/httpd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ mkdir /var/www/html/CentOS-6.7
</span></span><span style="display:flex;"><span>$ mount /dev/cdrom /var/www/html/CentOS-6.7/
</span></span><span style="display:flex;"><span>mount: block device /dev/sr0 is write-protected, mounting read-only
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ df -h
</span></span><span style="display:flex;"><span>Filesystem   Size Used Avail Use% Mounted on
</span></span><span style="display:flex;"><span>/dev/sda3    8.8G 1.5G 6.9G 18% /
</span></span><span style="display:flex;"><span>tmpfs      495M   <span style="color:#ae81ff">0</span> 495M  0% /dev/shm
</span></span><span style="display:flex;"><span>/dev/sda1    190M  36M 145M 20% /boot
</span></span><span style="display:flex;"><span>/dev/sr0    3.7G 3.7G   <span style="color:#ae81ff">0</span> 100% /var/www/html/CentOS-6.7
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat nginx.conf
</span></span><span style="display:flex;"><span>worker_processes 1;
</span></span><span style="display:flex;"><span>events <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>worker_connections 1024;
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>http <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>include    mime.types;
</span></span><span style="display:flex;"><span>default_type application/octet-stream;
</span></span><span style="display:flex;"><span>sendfile    on;
</span></span><span style="display:flex;"><span>keepalive_timeout 65;
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">\#</span>include set
</span></span><span style="display:flex;"><span>include extra/www.conf;
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat extra/www.conf 
</span></span><span style="display:flex;"><span>server <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span> listen    80;
</span></span><span style="display:flex;"><span> server_name www.ky.com;
</span></span><span style="display:flex;"><span> autoindex on;
</span></span><span style="display:flex;"><span> location / <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>   root  /var/www/html/;
</span></span><span style="display:flex;"><span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ fuser -k 80/tcp 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 杀死因前面开启httpd服务占用80的端口进程，然后就可以开启nginx服务</span></span></span></code></pre></div></blockquote>
<hr>
<h5 id="syslinux配置"><code>syslinux</code>配置</h5>
<blockquote>
<ul>
<li><code>syslinux</code>是一个功能强大的引导加载程序，而且兼容各种介质。<code>SYSLINUX</code>是一个小型的<code>Linux</code>操作系统，它的目的是简化首次安装<code>Linux</code>的时间，并建立修护或其它特殊用途的启动盘。如果没有找到<code>pxelinux.0</code>这个文件,可以安装一下</li>
<li>将<code>sysliunx</code>的<code>pxelinux.0</code>文件拷贝到<code>tftp</code>启动目录下</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cp /usr/share/syslinux/pxelinux.0 /var/lib/tftpboot/ </span></span></code></pre></div></blockquote>
<ul>
<li>将<code>/var/www/html/CentOS-6.7/isolinux/*</code>下的所有系统引导安装的文件拷贝到<code>tftp</code>启动目录下</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cp -a /var/www/html/CentOS-6.7/isolinux/* /var/lib/tftpboot/</span></span></code></pre></div></blockquote>
<ul>
<li>将<code>isolinux.cfg</code>文件拷贝到<code>tftp</code>启动目录下的<code>pxelinux.cfg</code>目录下并改名为<code>default</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -p /var/lib/tftpboot/pxelinux.cfg
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cp /var/www/html/CentOS-6.7/isolinux/isolinux.cfg /var/lib/tftpboot/pxelinux.cfg/default</span></span></code></pre></div></blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install syslinux
</span></span><span style="display:flex;"><span>$ cp /usr/share/syslinux/pxelinux.0 /var/lib/tftpboot/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cp -a /var/www/html/CentOS-6.7/isolinux/* /var/lib/tftpboot/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ mkdir -p /var/lib/tftpboot/pxelinux.cfg
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cp /var/www/html/CentOS-6.7/isolinux/isolinux.cfg /var/lib/tftpboot/pxelinux.cfg/default</span></span></code></pre></div><blockquote>
<ul>
<li><code>/var/www/html/CentOS-6.7/isolinux/isolinux.cfg</code>文件详解</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat /var/www/html/CentOS-6.7/isolinux/isolinux.cfg 
</span></span><span style="display:flex;"><span>default vesamenu.c32 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 默认加载一个菜单</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># prompt 1 </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 开启会显示命令行&#39;boot: &#39;提示符。prompt值为0时则不提示，将会直接启动&#39;default&#39;参数中指定的内容</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>timeout <span style="color:#ae81ff">600</span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># timeout时间是引导时等待用户手动选择的时间，设为1可直接引导，单位为1/10秒</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>display boot.msg 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 菜单背景图片、标题、颜色</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>menu background splash.jpg
</span></span><span style="display:flex;"><span>menu title Welcome to CentOS 6.7!
</span></span><span style="display:flex;"><span>menu color border <span style="color:#ae81ff">0</span> <span style="color:#75715e">#ffffffff #00000000</span>
</span></span><span style="display:flex;"><span>menu color sel <span style="color:#ae81ff">7</span> <span style="color:#75715e">#ffffffff #ff000000</span>
</span></span><span style="display:flex;"><span>menu color title <span style="color:#ae81ff">0</span> <span style="color:#75715e">#ffffffff #00000000</span>
</span></span><span style="display:flex;"><span>menu color tabmsg <span style="color:#ae81ff">0</span> <span style="color:#75715e">#ffffffff #00000000</span>
</span></span><span style="display:flex;"><span>menu color unsel <span style="color:#ae81ff">0</span> <span style="color:#75715e">#ffffffff #00000000</span>
</span></span><span style="display:flex;"><span>menu color hotsel <span style="color:#ae81ff">0</span> <span style="color:#75715e">#ff000000 #ffffffff</span>
</span></span><span style="display:flex;"><span>menu color hotkey <span style="color:#ae81ff">7</span> <span style="color:#75715e">#ffffffff #ff000000</span>
</span></span><span style="display:flex;"><span>menu color scrollbar <span style="color:#ae81ff">0</span> <span style="color:#75715e">#ffffffff #00000000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>label linux
</span></span><span style="display:flex;"><span><span style="color:#75715e"># label指定在boot:提示符下输入的关键字，比如boot:linux[ENTER]，这个会启动label linux下标记的kernel和initrd.img文件</span>
</span></span><span style="display:flex;"><span>menu label ^Install or upgrade an existing system
</span></span><span style="display:flex;"><span>menu default
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 一个标签就是前面图片的一行选项</span>
</span></span><span style="display:flex;"><span>kernel vmlinuz 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 指定要启动的内核。同样要注意路径，默认是/tftpboot目录</span>
</span></span><span style="display:flex;"><span>append initrd<span style="color:#f92672">=</span>initrd.img 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 指定追加给内核的参数，initrd.img是一个最小的linux系统</span>
</span></span><span style="display:flex;"><span>label vesa
</span></span><span style="display:flex;"><span>menu label Install system with ^basic video driver
</span></span><span style="display:flex;"><span>kernel vmlinuz
</span></span><span style="display:flex;"><span>append initrd<span style="color:#f92672">=</span>initrd.img nomodeset
</span></span><span style="display:flex;"><span>label rescue
</span></span><span style="display:flex;"><span>menu label ^Rescue installed system
</span></span><span style="display:flex;"><span>kernel vmlinuz
</span></span><span style="display:flex;"><span>append initrd<span style="color:#f92672">=</span>initrd.img rescue
</span></span><span style="display:flex;"><span>label local
</span></span><span style="display:flex;"><span>menu label Boot from ^local drive
</span></span><span style="display:flex;"><span>localboot 0xffff
</span></span><span style="display:flex;"><span>label memtest86
</span></span><span style="display:flex;"><span>menu label ^Memory test
</span></span><span style="display:flex;"><span>kernel memtest
</span></span><span style="display:flex;"><span>append -</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h5 id="编辑default">编辑<code>default</code></h5>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/var/lib/tftpboot/pxelinux.cfg/default<span style="color:#e6db74">&lt;&lt;-EOF  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">default ks
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">prompt 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">label ks
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kernel vmlinuz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">append initrd=initrd.img ks=http://10.0.0.61/ks_config/CentOS-6.7-ks.cfg ksdevice=eth0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li>这个文件就是实现下图这个界面的功能</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/var/lib/tftpboot/pxelinux.cfg/default<span style="color:#e6db74">&lt;&lt;-EOF  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">default ks
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">prompt 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">label linux
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kernel vmlinuz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">append initrd=initrd.img ks=http://10.0.0.61/ks_config/CentOS-6.7-ks.cfg ksdevice=eth0  	# 告诉安装程序ks.cfg文件在哪里，ksdevice=eth0代表当客户端有多块网卡的时候，设置从eth0安装
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><p><a href="#R-image-8f2d33cc0f5717bc1487f7d73261c8e7" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Deploy_Server/Install-Centos6.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-8f2d33cc0f5717bc1487f7d73261c8e7"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Deploy_Server/Install-Centos6.png"></a></p>
</blockquote>
</blockquote>
<hr>
<h4 id="kscfg文件"><code>ks.cfg</code>文件</h4>
<blockquote>
<ul>
<li>通常，我们在安装操作系统的过程中，需要大量的和服务器交互操作，为了减少这个交互过程，<code>kickstart</code>就诞生了。使用这种<code>kickstart</code>，只需事先定义好一个<code>Kickstart</code>自动应答配置文件<code>ks.cfg</code>（通常存放在安装服务器上），并让安装程序知道该配置文件的位置，在安装过程中安装程序就可以自己从该文件中读取安装配置，这样就避免了在安装过程中多次的人机交互，从而实现无人值守的自动化安装</li>
<li>生成<code>kickstart</code>配置文件的三种方法：</li>
</ul>
<blockquote>
<ul>
<li>方法1、 每安装好一台<code>Centos</code>机器，<code>Centos</code>安装程序都会创建一个<code>kickstart</code>配置文件，记录你的真实安装配置。如果你希望实现和某系统类似的安装，可以基于该系统的<code>kickstart</code>配置文件来生成你自己的<code>kickstart</code>配置文件。（生成的文件名字叫<code>anaconda-ks.cfg位于/root/anaconda-ks.cfg</code>）</li>
<li>方法2、<code>Centos</code>提供了一个图形化的<code>kickstart</code>配置工具。在任何一个安装好的<code>Linux</code>系统上运行该工具，就可以很容易地创建你自己的<code>kickstart</code>配置文件。<code>kickstart</code>配置工具命令为<code>redhat-config-kickstart</code>（<code>RHEL3</code>）或<code>system-config-kickstart</code>（<code>RHEL4</code>，<code>RHEL5</code>）.网上有很多用<code>CentOS</code>桌面版生成<code>ks</code>文件的文章，如果有现成的系统就没什么可说。但没有现成的，也没有必要去用桌面版，命令行也很简单</li>
<li>方法3、阅读<code>kickstart</code>配置文件的手册。用任何一个文本编辑器都可以创建你自己的<code>kickstart</code>配置文件</li>
</ul>
</blockquote>
<ul>
<li>编写<code>ks.cfg</code>文件</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ grub-crypt 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成一个密码</span>
</span></span><span style="display:flex;"><span>Password:
</span></span><span style="display:flex;"><span>Retype password: 
</span></span><span style="display:flex;"><span>$6$PqVOBDIH4wHJ.JyH$6/xoqOGnm3DnEJyyXgWxCdmscsWrGKbTmMYYE/lgVgzIep999j8z9s7Ci5V5TG16TALy/Grtk6Vh/jj2WLnEn1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat /var/www/html/ks_config/CentOS-6.7-ks.cfg
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Kickstart Configurator for CentOS 6.7 by ky</span>
</span></span><span style="display:flex;"><span>install
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 告知安装程序，这是一次全新安装，而不是升级upgrade</span>
</span></span><span style="display:flex;"><span>url --url<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://10.0.0.61/CentOS-6.7/&#34;</span>       
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 指定系统安装的包组等的路径</span>
</span></span><span style="display:flex;"><span>text 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 文本模式安装</span>
</span></span><span style="display:flex;"><span>lang en_US.UTF-8 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装使用的语言</span>
</span></span><span style="display:flex;"><span>keyboard us 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设置系统键盘类型</span>
</span></span><span style="display:flex;"><span>zerombr
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 清楚mbr引导信息</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>bootloader --location<span style="color:#f92672">=</span>mbr --driveorder<span style="color:#f92672">=</span>sda --append<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;crashkernel=auto rhgb quiet&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --location=,指定引导记录被写入的位置.有效的值如下:mbr(缺省),partition(在包含内核的分区的第一个扇区安装引导装载程序)或none(不安装引导装载程序；--driveorder,指定在BIOS引导顺序中居首的驱动器；--append=,指定内核参数.要指定多个参数,使用空格分隔它们</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>network --bootproto<span style="color:#f92672">=</span>dhcp --device<span style="color:#f92672">=</span>eth0 --onboot<span style="color:#f92672">=</span>yes --noipv6 --hostname<span style="color:#f92672">=</span>CentOS6
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 指定ip地址为dhcp分发，网卡eth0启动，是否在引导时启用该设备，禁用此设备的IPv6安装的系统的主机名</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>timezone --utc Asia/Shanghai
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设置系统时区</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>authconfig --enableshadow --passalgo<span style="color:#f92672">=</span>sha512
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 系统认证信息，设置密码加密方式为sha512 启用shadow文件</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rootpw --iscrypted $6$X20eRtuZhkHznTb4$dK0BJByOSAWSDD8jccLVFz0CscijS9ldMWwpoCw/ZE
</span></span><span style="display:flex;"><span>jYw2BTQYGWlgKsn945fFTjRC658UXjuocwJbAjVI5D6/
</span></span><span style="display:flex;"><span><span style="color:#75715e"># root密码</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>clearpart --all –initlabel
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 清空分区</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>part /boot --fstype<span style="color:#f92672">=</span>ext4 --asprimary --size<span style="color:#f92672">=</span><span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>part swap --size<span style="color:#f92672">=</span><span style="color:#ae81ff">800</span>
</span></span><span style="display:flex;"><span>part / --fstype<span style="color:#f92672">=</span>ext4 --grow --asprimary --size<span style="color:#f92672">=</span><span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --fstype=,为分区设置文件系统类型.有效的类型，--asprimary,强迫把分区分配为主分区,否则提示分区失败，--size=,以MB为单位的分区最小值.在此处指定一个整数值,如500.不要在数字后面加MB</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>firstboot –disable
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 负责协助配置redhat一些重要的信息</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>selinux --disabled
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>firewall –disabled
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 关闭selinux、防火墙</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>logging --level<span style="color:#f92672">=</span>info
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设置日志级别</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>reboot
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设定安装完成后重启,此选项必须存在，不然kickstart显示一条消息，并等待用户按任意键后才重新引导，也可以选择halt关机</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>%packages
</span></span><span style="display:flex;"><span>@base
</span></span><span style="display:flex;"><span>@compat-libraries
</span></span><span style="display:flex;"><span>@debugging
</span></span><span style="display:flex;"><span>@development
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 要安装的包组</span>
</span></span><span style="display:flex;"><span>tree
</span></span><span style="display:flex;"><span>nmap
</span></span><span style="display:flex;"><span>sysstat
</span></span><span style="display:flex;"><span>lrzsz
</span></span><span style="display:flex;"><span>telnet
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 要安装的软件</span>
</span></span><span style="display:flex;"><span>%end</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h4 id="无人值守安装系统">无人值守安装系统</h4>
<ul>
<li>
<ol>
<li>新建一个虚拟机加电，即可开始无人值守安装<code>linux</code>系统</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>Rpm</code>打包</li>
<li><code>Yum</code>仓库</li>
</ul>
<p><a href="#R-image-1e130552ab5d481120c87590c3429e8f" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Deploy_Server/configure.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-1e130552ab5d481120c87590c3429e8f"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Deploy_Server/configure.png"></a>
<a href="#R-image-5f79dfb04432f0e85178b1ea447969a9" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Deploy_Server/Retrieving.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-5f79dfb04432f0e85178b1ea447969a9"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Deploy_Server/Retrieving.png"></a>
<a href="#R-image-0c69170101251be3cb48a33d3498ac33" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Deploy_Server/Packages.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-0c69170101251be3cb48a33d3498ac33"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Deploy_Server/Packages.png"></a></p>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          </section>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="jdk">JDK</h1>


            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of JDK</h1>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_jdk_and_jar_run">Install_Jdk_And_Jar_Run</h1>

<h2 id="安装jdk">安装<code>JDK</code></h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>JDK</code></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://www.oracle.com/java/technologies/oracle-java-archive-downloads.html" rel="external" target="_self"><code>Oracle Java</code>存档</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://repo.huaweicloud.com/java/jdk/" rel="external" target="_self">华为<code>JDK</code>源</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://arthas.aliyun.com/" rel="external" target="_self"><code>Java</code>应用诊断利器</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://juejin.cn/post/6973808359614971918" rel="external" target="_self">运维：你们<code>JAVA</code>服务怎么又又又又出问题了！内存降不下来</a></td>
<td></td>
</tr>
</tbody>
</table>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install wget
</span></span><span style="display:flex;"><span>$ wget -P /usr/local/src/ http://83.103.170.157/apps/java/jdk_1.8/jdk/jdk-8u202-linux-x64.tar.gz
</span></span><span style="display:flex;"><span>$ tar -zxvf /usr/local/src/jdk-8u202-linux-x64.tar.gz -C /usr/local/src/
</span></span><span style="display:flex;"><span>$ ln -s /usr/local/src/jdk1.8.0_202 /usr/local/jdk
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;#######  	JDK環境變數  	############
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export JAVA_HOME=/usr/local/jdk
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export JRE_HOME=</span><span style="color:#e6db74">${</span>JAVA_HOME<span style="color:#e6db74">}</span><span style="color:#e6db74">/jre
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export CLASSPATH=</span><span style="color:#e6db74">${</span>JAVA_HOME<span style="color:#e6db74">}</span><span style="color:#e6db74">/lib:</span><span style="color:#e6db74">${</span>JAVA_HOME<span style="color:#e6db74">}</span><span style="color:#e6db74">/lib/tools.jar
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export PATH=</span><span style="color:#e6db74">${</span>PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">:</span><span style="color:#e6db74">${</span>JAVA_HOME<span style="color:#e6db74">}</span><span style="color:#e6db74">/bin:</span><span style="color:#e6db74">${</span>JAVA_HOME<span style="color:#e6db74">}</span><span style="color:#e6db74">/jre/bin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span>&gt;&gt; /etc/profile
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ source /etc/profile</span></span></code></pre></div></blockquote>
<hr>
<h2 id="jar包启动"><code>jar</code>包启动</h2>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->命令启动<!-- raw HTML omitted --><code>Jar</code><!-- raw HTML omitted -->包<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 将Spring boot安装为Linux服务启动 使jar包可以直接运行,后面做软连接</span>
</span></span><span style="display:flex;"><span>$ ln -s /opt/lucky/jdk/bin/java /sbin/java
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 授权指定用户可以运行jar包</span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">alias kg-business-anchor-backstage=&#39;sudo /etc/init.d/kg-business-anchor-backstage&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">alias kg-business-anchor-player=&#39;sudo /etc/init.d/kg-business-anchor-player&#39; &#34;</span>&gt;&gt;/home/myadmin/.bashrc
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ll /etc/init.d/  	<span style="color:#75715e"># 软连接</span>
</span></span><span style="display:flex;"><span>lrwxrwxrwx  <span style="color:#ae81ff">1</span> root root    <span style="color:#ae81ff">64</span> Mar <span style="color:#ae81ff">12</span> 14:49 kg-business-anchor-backstage -&gt; /opt/webapps/hsperfdata_ksadmin/kg-business-anchor-backstage.jar
</span></span><span style="display:flex;"><span>lrwxrwxrwx  <span style="color:#ae81ff">1</span> root root    <span style="color:#ae81ff">61</span> Mar <span style="color:#ae81ff">12</span> 14:49 kg-business-anchor-player -&gt; /opt/webapps/hsperfdata_ksadmin/kg-business-anchor-player.jar</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->脚本启动<!-- raw HTML omitted --><code>Jar</code><!-- raw HTML omitted -->包<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;java.sh<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">cd `dirname $0`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">CUR_SHELL_DIR=`pwd`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">CUR_SHELL_NAME=`basename ${BASH_SOURCE}`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 修改这里jar包名即可
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">JAR_NAME=&#34;red_admin-1.0.0-SNAPSHOT.jar&#34;  	# 修改为对应运行jar包
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">JAR_PATH=$CUR_SHELL_DIR/$JAR_NAME
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># JAVA_MEM_OPTS=&#34; -server -Xms1024m -Xmx1024m -XX:PermSize=128m&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">JAVA_MEM_OPTS=&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># SPRING_PROFILES_ACTIV=&#34;-Dspring.profiles.active=eureka2&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SPRING_PROFILES_ACTIV=&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LOG_DIR=$CUR_SHELL_DIR/log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LOG_PATH=$LOG_DIR/${JAR_NAME}.log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo_help()
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    echo -e &#34;syntax: sh $CUR_SHELL_NAME start|stop&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if [ -z $1 ];then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    echo_help
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    exit 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if [ ! -d &#34;$LOG_DIR&#34; ];then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mkdir &#34;$LOG_DIR&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if [ ! -f &#34;$LOG_PATH&#34; ];then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    touch &#34;$LOG_DIR&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if [ &#34;$1&#34; == &#34;start&#34; ];then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># check server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    PIDS=`ps --no-heading -C java -f --width 1000 | grep $JAR_NAME | awk &#39;{print $2}&#39;`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    if [ -n &#34;$PIDS&#34; ]; then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        echo -e &#34;ERROR: The $JAR_NAME already started and the PID is ${PIDS}.&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        exit 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo &#34;Starting the $JAR_NAME...&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # start
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    nohup java $JAVA_MEM_OPTS -jar $SPRING_PROFILES_ACTIV $JAR_PATH &gt;&gt; $LOG_PATH 2&gt;&amp;1 &amp;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    COUNT=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    while [ $COUNT -lt 1 ]; do
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        sleep 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        COUNT=`ps  --no-heading -C java -f --width 1000 | grep &#34;$JAR_NAME&#34; | awk &#39;{print $2}&#39; | wc -l`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        if [ $COUNT -gt 0 ]; then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            break
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    done
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    PIDS=`ps  --no-heading -C java -f --width 1000 | grep &#34;$JAR_NAME&#34; | awk &#39;{print $2}&#39;`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    echo &#34;${JAR_NAME} Started and the PID is ${PIDS}.&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    echo &#34;You can check the log file in ${LOG_PATH} for details.&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">elif [ &#34;$1&#34; == &#34;stop&#34; ];then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    PIDS=`ps --no-heading -C java -f --width 1000 | grep $JAR_NAME | awk &#39;{print $2}&#39;`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    if [ -z &#34;$PIDS&#34; ]; then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        echo &#34;ERROR:The $JAR_NAME does not started!&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        exit 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo -e &#34;Stopping the $JAR_NAME...&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    for PID in $PIDS; do
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        kill $PID &gt; /dev/null 2&gt;&amp;1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    done
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    COUNT=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    while [ $COUNT -lt 1 ]; do
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        sleep 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        COUNT=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        for PID in $PIDS ; do
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            PID_EXIST=`ps --no-heading -p $PID`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            if [ -n &#34;$PID_EXIST&#34; ]; then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                COUNT=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                break
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        done
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    done
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    echo -e &#34;${JAR_NAME} Stopped and the PID is ${PIDS}.&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">else
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    echo_help
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    exit 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="tomcat配置调整"><code>Tomcat</code>配置调整</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->为<!-- raw HTML omitted --><code>Tomcat</code><!-- raw HTML omitted -->指定<!-- raw HTML omitted --><code>JDK</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ vim bin/setclasspath.sh  
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在脚本开头的地方指定JAVA_HOME和JRE_HOME  </span>
</span></span><span style="display:flex;"><span>export JAVA_HOME<span style="color:#f92672">=</span>/usr/local/jdk1.8.0_40
</span></span><span style="display:flex;"><span>export JRE_HOME<span style="color:#f92672">=</span>/usr/local/jdk1.8.0_40/jre</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->为<!-- raw HTML omitted --><code>Tomcat</code><!-- raw HTML omitted -->设置内存大小<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ vim bin/catalina.sh  
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tomcat设置内存为8G</span>
</span></span><span style="display:flex;"><span>JAVA_OPTS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-server -Xms8192M -Xmx8192M -XX:PermSize=256M -XX:MaxPermSize=256M&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tomcat设置内存为4G</span>
</span></span><span style="display:flex;"><span>JAVA_OPTS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-server -Xms4096M -Xmx4096M -XX:PermSize=256M -XX:MaxPermSize=256M&#34;</span></span></span></code></pre></div><p><a href="#R-image-4f43b9fa730bb895b6090932aa7d5354" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Tomcat_Server/Snipaste_2022-08-12_13-52-02.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-4f43b9fa730bb895b6090932aa7d5354"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Tomcat_Server/Snipaste_2022-08-12_13-52-02.png"></a></p>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>maven</code><!-- raw HTML omitted -->打成<!-- raw HTML omitted --><code>war</code><!-- raw HTML omitted -->包<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mvn clean install 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ mvn clean package -Dmaven.test.skip<span style="color:#f92672">=</span>true</span></span></code></pre></div></blockquote>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          </section>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="jenkins">Jenkins</h1>


            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Jenkins</h1>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="use_jenkins">Use_Jenkins</h1>

<h2 id="配置jenkins">配置<code>Jenkins</code></h2>
<h3 id="升级jenkins">升级<code>Jenkins</code></h3>
<blockquote>
<ul>
<li>定位<code>jenkins.war</code>包所在目录</li>
</ul>
<blockquote>
<ul>
<li><a href="https://zeyangli.github.io/" rel="external" target="_self"><code>Jenkins</code>实践文档</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ps -ef|grep jenkins  	<span style="color:#75715e"># 定位jenkins.war包所在目录</span>
</span></span><span style="display:flex;"><span>root       <span style="color:#ae81ff">1773</span>      <span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">1</span> 09:06 ?        00:03:00 /usr/local/jdk1.8.0_221/bin/java -Djava.awt.headless<span style="color:#f92672">=</span>true -DJENKINS_HOME<span style="color:#f92672">=</span>/var/lib/jenkins -jar /usr/lib/jenkins/jenkins.war --logfile<span style="color:#f92672">=</span>/var/log/jenkins/jenkins.log --webroot<span style="color:#f92672">=</span>/var/cache/jenkins/war --httpPort<span style="color:#f92672">=</span><span style="color:#ae81ff">8080</span> --debug<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span> --handlerCountMax<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span> --handlerCountMaxIdle<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cd /usr/lib/jenkins/
</span></span><span style="display:flex;"><span>$ systemctl stop jenkins  	<span style="color:#75715e"># 停止Jenkins</span>
</span></span><span style="display:flex;"><span>$ mv jenkins.war jenkins.war.bak  	<span style="color:#75715e"># 备份</span>
</span></span><span style="display:flex;"><span>$ wget -P /usr/lib/jenkins/ http://mirrors.jenkins.io/war-stable/latest/jenkins.war
</span></span><span style="display:flex;"><span>$ systemctl start jenkins</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="汉化jenkins">汉化<code>Jenkins</code></h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->登录<!-- raw HTML omitted --><code>Jenkins</code><!-- raw HTML omitted -->页面选择：<!-- raw HTML omitted --><code>Manage Jenkins</code>→<code>Manage Plugins</code></li>
</ul>
<blockquote>
<p><a href="#R-image-e50e7f23ebdd77f4359ee2eec2b27750" class="lightbox-link"><img alt="选择插件" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_18-55-47.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-e50e7f23ebdd77f4359ee2eec2b27750"><img alt="选择插件" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_18-55-47.png"></a></p>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->在搜索框搜索：<!-- raw HTML omitted --><code>Locale</code><!-- raw HTML omitted -->选择安装并重启<!-- raw HTML omitted --><code>Jenkins</code><!-- raw HTML omitted -->页面<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->设置<!-- raw HTML omitted --><code>Local</code>：<code>Configure System</code><!-- raw HTML omitted -->(系统设置)→<!-- raw HTML omitted --><code> Locale</code><!-- raw HTML omitted -->(语言设置)→<!-- raw HTML omitted --><code>en_US</code><!-- raw HTML omitted -->(英文)、<!-- raw HTML omitted --><code>zh_CN</code><!-- raw HTML omitted -->(中文)<!-- raw HTML omitted --></li>
</ul>
<p><a href="#R-image-2162ea5ae2a5484ece57b241b7116d6a" class="lightbox-link"><img alt="安装汉化插件" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_18-57-40.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-2162ea5ae2a5484ece57b241b7116d6a"><img alt="安装汉化插件" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_18-57-40.png"></a></p>
</blockquote>
</blockquote>
<hr>
<h3 id="配置域名">配置域名</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>Nginx</code><!-- raw HTML omitted -->配置文件方便使用域名访问<!-- raw HTML omitted --><code>Jenkins</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/usr/local/nginx/conf/vhosts/jenkins.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">server {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> listen       80;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> server_name  jenkins.ken.io; #监听的域名
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> access_log  /var/log/nginx/jenkins.access.log main;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> error_log  /var/log/nginx/jenkins.error.log error;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> location / {  	# 转发或处理
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     proxy_pass http://127.0.0.1:8080; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> error_page   500 502 503 504  /50x.html;  	# 错误页
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> location = /50x.html {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     root   /usr/share/nginx/html;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="权限管理">权限管理</h3>
<blockquote>
<ul>
<li><a href="https://blog.51cto.com/wzlinux/2160778" rel="external" target="_self">持续集成之<code>Jenkins</code>配置基于角色的项目权限管理(五)</a></li>
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>Jenkins</code><!-- raw HTML omitted -->权限管理<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>Jenkins</code><!-- raw HTML omitted -->全局安装配置<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->系统管理→插件管理→安装插件:<!-- raw HTML omitted --><code>Role-based Authorization Strategy</code></li>
</ul>
<blockquote>
<ul>
<li><code>Role-based Authorization Strategy</code></li>
<li><code>Matrix Authorization Strategy</code></li>
<li><code>Authorize Project</code></li>
</ul>
<p><a href="#R-image-6f5eec598c26ddc96d604da5e258a474" class="lightbox-link"><img alt="搜索Role-based Authorization Strategy" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_19-18-26.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-6f5eec598c26ddc96d604da5e258a474"><img alt="搜索Role-based Authorization Strategy" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_19-18-26.png"></a></p>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->系统管理→全局安全配置勾选:<!-- raw HTML omitted --><code>Role-Based Strategy</code></li>
</ul>
<blockquote>
<p><a href="#R-image-64d6f9974e1e81dd89682c586e590fe4" class="lightbox-link"><img alt="选择全局安装配置" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_19-22-20.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-64d6f9974e1e81dd89682c586e590fe4"><img alt="选择全局安装配置" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_19-22-20.png"></a></p>
<p><a href="#R-image-b0e51817f8f84b7a200b251da9f236ee" class="lightbox-link"><img alt="选择：Role-Based Strategy" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_19-24-08.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-b0e51817f8f84b7a200b251da9f236ee"><img alt="选择：Role-Based Strategy" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_19-24-08.png"></a></p>
</blockquote>
</blockquote>
<ul>
<li><code>Jenkisn</code><!-- raw HTML omitted -->角色分配权限<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->系统管理→管理和分配角色：<!-- raw HTML omitted --><code>Manage and Assign Roles</code></li>
</ul>
<blockquote>
<p><a href="#R-image-acfcda11168babe71d33da807dba2058" class="lightbox-link"><img alt="配置Manage and Assign Roles" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_19-29-36.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-acfcda11168babe71d33da807dba2058"><img alt="配置Manage and Assign Roles" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_19-29-36.png"></a></p>
<p><a href="#R-image-9566661f814994dc78e9af7bd31cc2a6" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_19-31-29.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-9566661f814994dc78e9af7bd31cc2a6"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_19-31-29.png"></a></p>
</blockquote>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->先配置： 管理角色<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<p><a href="#R-image-e0a00ba15bb94ec62fb13edee56347cb" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_19-34-09.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-e0a00ba15bb94ec62fb13edee56347cb"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_19-34-09.png"></a></p>
<ul>
<li><!-- raw HTML omitted -->添加<!-- raw HTML omitted --><code>Jenkins</code><!-- raw HTML omitted -->全局项目角色<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<p><a href="#R-image-f30b6f1bd7fa68fff1ab6903f2d0d249" class="lightbox-link"><img alt="全局角色" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_19-38-52.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-f30b6f1bd7fa68fff1ab6903f2d0d249"><img alt="全局角色" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_19-38-52.png"></a></p>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->添加<!-- raw HTML omitted --><code>Jenkins</code><!-- raw HTML omitted -->项目角色<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>
<p><code>Role</code><!-- raw HTML omitted -->代表视图<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>Pattern</code><!-- raw HTML omitted -->代表视图下<!-- raw HTML omitted --><code>test*</code><!-- raw HTML omitted -->的任务名称<!-- raw HTML omitted --></p>
</li>
</ul>
<p><a href="#R-image-f45bdde26abdd07948c928b57959d337" class="lightbox-link"><img alt="项目角色" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_19-46-24.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-f45bdde26abdd07948c928b57959d337"><img alt="项目角色" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_19-46-24.png"></a></p>
</blockquote>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->给<!-- raw HTML omitted --><code>Jenkins</code><!-- raw HTML omitted -->角色分配执行权限<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<p><a href="#R-image-e9642ba965ea2d20c2a2c417c76a95ad" class="lightbox-link"><img alt="角色分配" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_19-54-57.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-e9642ba965ea2d20c2a2c417c76a95ad"><img alt="角色分配" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_19-54-57.png"></a></p>
<ul>
<li><code>Jenkins</code><!-- raw HTML omitted -->全局角色<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<p><a href="#R-image-884f846f08ca96846b016ded3372829d" class="lightbox-link"><img alt="分配全局角色" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_19-58-06.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-884f846f08ca96846b016ded3372829d"><img alt="分配全局角色" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_19-58-06.png"></a></p>
</blockquote>
<ul>
<li><code>Jenkins</code><!-- raw HTML omitted -->项目角色<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<p><a href="#R-image-c7b6720a2fd309ffd6d3c3d0583003ec" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_20-02-46.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-c7b6720a2fd309ffd6d3c3d0583003ec"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_20-02-46.png"></a></p>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
<hr>
<h3 id="jenkins配置邮箱"><code>Jenkins</code>配置邮箱</h3>
<blockquote>
<ul>
<li><a href="#R-image-ddf9dd9955dd8302f83375e5513753b5" class="lightbox-link"><img alt="配置Jenkins邮箱" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_22-57-50.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-ddf9dd9955dd8302f83375e5513753b5"><img alt="配置Jenkins邮箱" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_22-57-50.png"></a></li>
</ul>
</blockquote>
<hr>
<h3 id="jenkins服务器配置"><code>Jenkins</code>服务器配置</h3>
<h4 id="配置ssh管理服务器">配置<code>ssh</code>管理服务器</h4>
<blockquote>
<ul>
<li><code>Jenkins</code><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>ssh</code><!-- raw HTML omitted -->管理服务器<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->搜索<!-- raw HTML omitted --><code>ssh</code><!-- raw HTML omitted -->插件：系统管理→插件管理→搜索：<!-- raw HTML omitted --><code>Publish Over SSH</code></li>
</ul>
<blockquote>
<p><a href="#R-image-62d57b2047c3f993d94753be4b0269bd" class="lightbox-link"><img alt="搜索ssh插件" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_21-03-45.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-62d57b2047c3f993d94753be4b0269bd"><img alt="搜索ssh插件" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_21-03-45.png"></a></p>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>ssh</code><!-- raw HTML omitted -->插件：系统管理→系统配置→<!-- raw HTML omitted --><code>Publish over SSH</code>→<code>SSH Servers</code></li>
</ul>
<blockquote>
<p><a href="#R-image-28ec2ba6227e2cdd3c531e3a449f63e9" class="lightbox-link"><img alt="配置Publish over SSH插件" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_21-32-37.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-28ec2ba6227e2cdd3c531e3a449f63e9"><img alt="配置Publish over SSH插件" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_21-32-37.png"></a></p>
</blockquote>
</blockquote>
</blockquote>
<hr>
<h4 id="配置ansible管理服务器">配置<code>ansible</code>管理服务器</h4>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>ansible</code><!-- raw HTML omitted -->实现免密登录以便<!-- raw HTML omitted --><code>Jenkins</code><!-- raw HTML omitted -->批量处理<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->生成密钥对，拷贝公钥到目部主机<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /usr/bin/sed -i <span style="color:#e6db74">&#34;/host_key_checking/a\\host_key_checking = false&#34;</span> /etc/ansible/ansible.cfg  	<span style="color:#75715e"># 关闭主机密钥检查</span>
</span></span><span style="display:flex;"><span>$ sudo su -s /bin/bash jenkins  	<span style="color:#75715e"># 如果Jenkins用户不是root需要切换用户  </span>
</span></span><span style="display:flex;"><span>$ ssh-keygen  	<span style="color:#75715e"># 生成密钥对  </span>
</span></span><span style="display:flex;"><span>$ ssh-copy-id root@<span style="color:#e6db74">&#34;目标IP&#34;</span>  	<span style="color:#75715e"># 拷贝公钥到目标主机  </span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>Ansible</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>hosts</code><!-- raw HTML omitted -->文件<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/ansible/hosts<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">console # 自定义名称，  ansible_ssh_user=root # 用户， ansible_ssh_pass=&#34;a&#34; # 密码，ansible_ssh_port=22 # 端口， ansible_ssh_host=192.168.1.1 # 目部主机IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->登录<!-- raw HTML omitted --><code>Jenkins</code><!-- raw HTML omitted -->页面，到插件管理界面搜索安装<!-- raw HTML omitted --><code>Ansible</code><!-- raw HTML omitted -->插件<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<p><a href="#R-image-5ee36a8ff859c3232c46a6505f2705e2" class="lightbox-link"><img alt="搜索安装<code>ansible</code>插件" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_19-06-12.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-5ee36a8ff859c3232c46a6505f2705e2"><img alt="搜索安装<code>ansible</code>插件" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_19-06-12.png"></a></p>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->安装好<!-- raw HTML omitted --><code>Ansible</code><!-- raw HTML omitted -->插件后重启<!-- raw HTML omitted --><code>Jenkins</code><!-- raw HTML omitted -->页面<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<p><a href="#R-image-3d4528436299031c2e8e66a89264c6b8" class="lightbox-link"><img alt="安装好后重启页面" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_19-08-30.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-3d4528436299031c2e8e66a89264c6b8"><img alt="安装好后重启页面" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_19-08-30.png"></a></p>
</blockquote>
<ul>
<li>使用<code>Gitlab+Ansible</code>构建项目验证<code>Ansible</code>是否可用</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->选择：新建任务→输入任务名称：→选择：构建一个自由风格的软件项目→点击：确认<!-- raw HTML omitted --></li>
</ul>
<p><a href="#R-image-3893488d538885dd46bfab6a5f2dfd87" class="lightbox-link"><img alt="创建任务" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_21-54-08.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-3893488d538885dd46bfab6a5f2dfd87"><img alt="创建任务" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_21-54-08.png"></a></p>
<ul>
<li>添加<code>Ansible</code>构建</li>
</ul>
<blockquote>
<p><a href="#R-image-a96ff6974ce1b77c084c2b730f78fa12" class="lightbox-link"><img alt="添加构建Ansible" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_21-56-00.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-a96ff6974ce1b77c084c2b730f78fa12"><img alt="添加构建Ansible" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_21-56-00.png"></a></p>
</blockquote>
<ul>
<li>配置<code>Ansible</code>构建</li>
</ul>
<blockquote>
<p><a href="#R-image-29838cd7f1503b2800d597f88445f2a4" class="lightbox-link"><img alt="配置Jenkins的ansible" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_22-09-30.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-29838cd7f1503b2800d597f88445f2a4"><img alt="配置Jenkins的ansible" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_22-09-30.png"></a></p>
</blockquote>
<ul>
<li>测试<code>Ansible</code>构建</li>
</ul>
<blockquote>
<p><a href="#R-image-728e729087deb8ee0346e11b49f2f3f5" class="lightbox-link"><img alt="测试Ansible构建" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_22-13-24.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-728e729087deb8ee0346e11b49f2f3f5"><img alt="测试Ansible构建" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_22-13-24.png"></a></p>
</blockquote>
</blockquote>
</blockquote>
<hr>
<h3 id="jenkins部署插件"><code>Jenkins</code>部署插件</h3>
<blockquote>
<ul>
<li><a href="https://plugins.jenkins.io/" rel="external" target="_self">部署插件</a></li>
<li><code>General</code><!-- raw HTML omitted -->→<!-- raw HTML omitted --><a href="https://plugins.jenkins.io/gogs-webhook/" rel="external" target="_self"><code>Gogs</code></a></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->允许用户使用<!-- raw HTML omitted --><code>Gogs Webhook</code></li>
</ul>
<p><a href="#R-image-54b00bcd48cf9ecaddf67d66061b3f08" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-10-17_14-04-17.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-54b00bcd48cf9ecaddf67d66061b3f08"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-10-17_14-04-17.png"></a></p>
</blockquote>
<ul>
<li><code>General</code><!-- raw HTML omitted -->→<!-- raw HTML omitted --><code>This project is parameterized</code><!-- raw HTML omitted -->(参数化构建过程)→<!-- raw HTML omitted --><a href="https://plugins.jenkins.io/git-parameter/" rel="external" target="_self"><code>Git Parameter</code></a></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->该插件允许您在构建中分配<!-- raw HTML omitted --><code>Git</code><!-- raw HTML omitted -->分支、标签、拉取请求或修订号作为参数<!-- raw HTML omitted --></li>
</ul>
<p><a href="#R-image-f11a4fe6019b28a4ce2e7489db785c5b" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-10-17_14-09-44.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-f11a4fe6019b28a4ce2e7489db785c5b"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-10-17_14-09-44.png"></a></p>
</blockquote>
<ul>
<li><code>Build Triggers</code><!-- raw HTML omitted -->(构建触发器)→安装<!-- raw HTML omitted --><a href="https://plugins.jenkins.io/gitlab-plugin/" rel="external" target="_self"><code>GitLab Plugin</code></a><!-- raw HTML omitted -->或<!-- raw HTML omitted --><a href="https://plugins.jenkins.io/generic-webhook-trigger/" rel="external" target="_self"><code>Generic Webhook Trigger</code></a><!-- raw HTML omitted -->自动部署插件<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->此插件允许<!-- raw HTML omitted --><code>GitLab</code><!-- raw HTML omitted -->在提交代码或打开/更新合并请求时触发<!-- raw HTML omitted --><code>Jenkins</code><!-- raw HTML omitted -->中的构建。它还可以将构建状态发送回<!-- raw HTML omitted --><code>GitLab</code></li>
</ul>
<p><a href="#R-image-d906caf4046816c98948e129072ee275" class="lightbox-link"><img alt="GitLab webhook Plugin" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-25_15-36-23.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-d906caf4046816c98948e129072ee275"><img alt="GitLab webhook Plugin" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-25_15-36-23.png"></a></p>
</blockquote>
<ul>
<li><code>Build Environment</code><!-- raw HTML omitted -->(构建环境)→<!-- raw HTML omitted --><a href="https://plugins.jenkins.io/ansicolor/" rel="external" target="_self"><code>AnsiColor</code></a></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->这个插件增加了对标准<!-- raw HTML omitted --><code>ANSI</code><!-- raw HTML omitted -->转义序列的支持，包括颜色，到控制台输出。 该插件可<!-- raw HTML omitted --><a href="http://repo.jenkins-ci.org/releases/org/jenkins-ci/plugins/ansicolor/" rel="external" target="_self">在此处</a><!-- raw HTML omitted -->获得，并且在<!-- raw HTML omitted --><code>Jenkins Wiki</code><!-- raw HTML omitted -->上有<!-- raw HTML omitted --><a href="https://wiki.jenkins-ci.org/display/JENKINS/AnsiColor+Plugin" rel="external" target="_self">一个页面</a></li>
</ul>
<p><a href="#R-image-d79ce131beb62c0ba0c8fcf3a3e080cf" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-10-17_14-16-21.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-d79ce131beb62c0ba0c8fcf3a3e080cf"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-10-17_14-16-21.png"></a></p>
</blockquote>
<ul>
<li><code>Build Environment</code><!-- raw HTML omitted -->(构建环境)→<!-- raw HTML omitted --><a href="https://plugins.jenkins.io/build-user-vars-plugin/" rel="external" target="_self"><code>Set jenkins user build variables</code></a></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->描述启动构建的用户的一组<strong>环境变量</strong><!-- raw HTML omitted --></li>
</ul>
<p><a href="#R-image-3a56f8034caf559dab374081754c7dbb" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-10-17_14-24-17.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-3a56f8034caf559dab374081754c7dbb"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-10-17_14-24-17.png"></a></p>
</blockquote>
<ul>
<li><code>Post-build Actions</code><!-- raw HTML omitted -->(构建后操作)→<!-- raw HTML omitted --><a href="https://plugins.jenkins.io/postbuild-task/" rel="external" target="_self"><code>Post build task</code></a></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->此功能允许用户关联<!-- raw HTML omitted --><code>shell</code><!-- raw HTML omitted -->或批处理脚本，这些脚本根据构建日志输出在<!-- raw HTML omitted --><code>Jenkins</code><!-- raw HTML omitted -->上执行某些任务。如果日志文本在构建日志文件中的某个位置匹配，则脚本将执行并且构建后日志将附加到项目构建日志中。允许使用<!-- raw HTML omitted --><code>Java</code><!-- raw HTML omitted -->正则表达式<!-- raw HTML omitted --></li>
</ul>
<p><a href="#R-image-584dc72815d615f1885086e40ae7076b" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-10-17_14-46-20.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-584dc72815d615f1885086e40ae7076b"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-10-17_14-46-20.png"></a></p>
</blockquote>
</blockquote>
<hr>
<h3 id="jenkins回滚插件"><code>Jenkins</code>回滚插件</h3>
<blockquote>
<ul>
<li><code>General</code><!-- raw HTML omitted -->→<!-- raw HTML omitted --><code>This project is parameterized</code><!-- raw HTML omitted -->(参数化构建过程)→<!-- raw HTML omitted --><a href="https://plugins.jenkins.io/uno-choice/" rel="external" target="_self"><code>Active Choices</code></a></li>
</ul>
<blockquote>
<ul>
<li><code>Active Choices</code><!-- raw HTML omitted -->插件用于参数化的自由式<!-- raw HTML omitted --><code>Jenkins</code><!-- raw HTML omitted -->作业，以创建<strong>脚本化、动态和交互式作业参数</strong>。<!-- raw HTML omitted --><code>Active Choices</code><!-- raw HTML omitted --><strong>参数</strong>可以<strong>动态更新</strong>，并且可以<strong>呈现为组合框、复选框、单选按钮或丰富的<code>HTML UI</code>小部件</strong>。<!-- raw HTML omitted --><code>Active Choices</code>参数使用<code>Groovy</code>或（可选）<code>Scriptler Groovy</code>脚本编写脚本。这些自定义脚本支持使用<code>Jenkins Java API</code><!-- raw HTML omitted -->、系统环境变量、全局节点属性以及潜在的外部<code>Java</code>和<code>Javascript</code>库<!-- raw HTML omitted --></li>
</ul>
<p><a href="#R-image-4a5003621e9952b267ca544d8049c48a" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-10-17_15-17-51.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-4a5003621e9952b267ca544d8049c48a"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-10-17_15-17-51.png"></a></p>
</blockquote>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_jenkins">Install_Jenkins</h1>

<h2 id="jenkins安装"><code>Jenkins</code>安装</h2>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://www.jenkins.io/doc/book/installing/" rel="external" target="_self"><code>Jenkins</code>安装与升级</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.jenkins.io/doc/book/installing/linux/#red-hat-centos" rel="external" target="_self">官方文档</a></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li><!-- raw HTML omitted -->事先最好安装：<!-- raw HTML omitted --><code>jdk-8u221</code><!-- raw HTML omitted -->以上版本，最新版本需要<!-- raw HTML omitted --><code>Java 11</code><!-- raw HTML omitted -->并且配置好环境变量<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><a href="https://repo.huaweicloud.com/java/jdk/" rel="external" target="_self"><code>Huawei Java</code></a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;######### JDK环境变量  #######
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export JAVA_HOME=/usr/local/jdk
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export JRE_HOME=</span>$JAVA_HOME<span style="color:#e6db74">/jre
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export CLASSPATH=</span>$JAVA_HOME<span style="color:#e6db74">/lib:</span>$JAVA_HOME<span style="color:#e6db74">/lib/tools.jar
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export PATH=</span>$PATH<span style="color:#e6db74">:</span>$JAVA_HOME<span style="color:#e6db74">/bin:</span>$JAVA_HOME<span style="color:#e6db74">/jre/bin &#34;</span>&gt;&gt;/etc/profile
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ source /etc/profile
</span></span><span style="display:flex;"><span>$ ln -s /usr/local/jdk/bin/java /usr/bin/java  	<span style="color:#75715e"># 需要添加软连接</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ yum -y install avahi-libs copy-jdk-configs cups-libs fontconfig giflib <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>javapackages-tools libICE libSM libX11 libX11-common <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>libXau libXext libXi libXrender libXtst libfontenc <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>libjpeg-turbo libxcb libxslt lksctp-tools pcsc-lite-libs <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>python-javapackages python-lxml ttmkfdir tzdata-java <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>xorg-x11-font-utils xorg-x11-fonts-Type1</span></span></code></pre></div></blockquote>
<ul>
<li><code>yum</code><!-- raw HTML omitted -->方式部署<!-- raw HTML omitted --><code>Jenkins</code></li>
</ul>
<blockquote>
<ul>
<li><a href="https://pkg.jenkins.io/" rel="external" target="_self"><code>Jenkins</code>历史版本</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ yum -y install jenkins</span></span></code></pre></div></blockquote>
<ul>
<li><code>rpm</code><!-- raw HTML omitted -->方式部署<!-- raw HTML omitted --><code>Jenkins</code></li>
</ul>
<blockquote>
<ul>
<li><a href="https://pkg.jenkins.io/redhat-stable-rc/" rel="external" target="_self"><code>Jenkins</code>稳定版<code>rpm</code>安装包</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum install -y ca-certificates
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ wget https://pkg.jenkins.io/redhat/jenkins-2.219-1.1.noarch.rpm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ rpm -ivh jenkins-2.156-1.1.noarch.rpm</span></span></code></pre></div></blockquote>
<ul>
<li><code>war</code><!-- raw HTML omitted -->方式部署启动<!-- raw HTML omitted --><code>Jenkins</code></li>
</ul>
<blockquote>
<ul>
<li><a href="https://get.jenkins.io/war-stable/" rel="external" target="_self"><code>Jenkins</code>历史<code>war</code>包</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget https://get.jenkins.io/war-stable/2.319.3/jenkins.war
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ java -jar jenkins.war --httpPort<span style="color:#f92672">=</span><span style="color:#ae81ff">8080</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->通过<!-- raw HTML omitted --><code>Docker</code><!-- raw HTML omitted -->部署<!-- raw HTML omitted --><code>Jenkins</code></li>
</ul>
<blockquote>
<ul>
<li><a href="https://www.jenkins.io/doc/book/installing/docker/" rel="external" target="_self"><code>docker</code>部署<code>Jenkins</code></a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ docker run -d --name jenkins <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-p 18090:8080 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-p 50000:50000 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-v /opt/jenkins/data:/var/jenkins_home <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-v /var/run/docker.sock:/var/run/docker.sock <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--user root <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>jenkins/jenkins:jdk11</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>docker-compose</code><!-- raw HTML omitted -->构建启动<!-- raw HTML omitted --><code>Jenkins</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/docker-compose/jenkins/docker-compose.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">version: &#34;3&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">services:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  jenkins:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    hostname: &#39;jenkins&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    container_name: jenkins  # 启动后名称
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    image: &#39;jenkins/jenkins:jdk11&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    restart: always
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    environment:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      TZ: Asia/Shanghai
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ports:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &#39;18090:8080&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &#39;50000:50000&#39;  	# enkins-slave-agent服务端口
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    volumes:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &#39;/opt/apps/jenkins:/var/jenkins_home&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &#39;/var/run/docker.sock:/var/run/docker.sock&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="修改jenkins配置">修改<code>Jenkins</code>配置</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->修改启动脚本：在<!-- raw HTML omitted --><code>candidates=&quot; </code><!-- raw HTML omitted -->下添加<!-- raw HTML omitted --><code>jdk</code><!-- raw HTML omitted -->文件安装路径<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ vim /etc/init.d/jenkins  
</span></span><span style="display:flex;"><span>candidates<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;  	# 大概在 99 行左右
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/usr/local/jdk1.8.0_221/bin/java</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>Jenkins</code><!-- raw HTML omitted -->主配置文件<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ vim /etc/sysconfig/jenkins  
</span></span><span style="display:flex;"><span>JENKINS_USER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;root&#34;</span>  	<span style="color:#75715e"># 修改为root用户  </span>
</span></span><span style="display:flex;"><span>JENKINS_PORT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;8080&#34;</span>  	<span style="color:#75715e"># 修改监听端口</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>/usr/lib/systemd/system/jenkins.service</code><!-- raw HTML omitted -->文件下用户权限<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ vim /usr/lib/systemd/system/jenkins.service
</span></span><span style="display:flex;"><span>User<span style="color:#f92672">=</span>jenkins  	<span style="color:#75715e"># 修改为root</span>
</span></span><span style="display:flex;"><span>Group<span style="color:#f92672">=</span>jenkins  	<span style="color:#75715e"># 修改为root</span>
</span></span><span style="display:flex;"><span>Environment<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;JENKINS_PORT=8080&#34;</span>  	<span style="color:#75715e"># 端口修改</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>Jenkins</code><!-- raw HTML omitted -->目录权限<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ chown -R root:root /var/lib/jenkins
</span></span><span style="display:flex;"><span>$ chown -R root:root /var/cache/jenkins
</span></span><span style="display:flex;"><span>$ chown -R root:root /var/log/jenkins</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->启动<!-- raw HTML omitted --><code>Jenkins</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl enable jenkins <span style="color:#f92672">&amp;&amp;</span> systemctl start jenkins</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->修改防火墙规则放行<!-- raw HTML omitted --><code>Jenkins</code><!-- raw HTML omitted -->服务端口<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ firewall-cmd --add-port<span style="color:#f92672">=</span>8080/tcp --permanent
</span></span><span style="display:flex;"><span>$ firewall-cmd --reload</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="浏览器登录jenkins">浏览器登录<code>Jenkins</code></h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted --><code>http://IP:8080</code><!-- raw HTML omitted --></li>
</ul>
<blockquote>
<p><a href="#R-image-23c04d2022478eb8c30caf1859b25b73" class="lightbox-link"><img alt="浏览器访问" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_18-14-06.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-23c04d2022478eb8c30caf1859b25b73"><img alt="浏览器访问" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_18-14-06.png"></a></p>
</blockquote>
<ul>
<li><code>docker exec jenkins cat /var/jenkins_home/secrets/initialAdminPassword</code><!-- raw HTML omitted -->获取登录密码<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->登录后选择安装插件，默认即可<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<p><a href="#R-image-af0d4d9908eca3e2ae34d88db9a47adb" class="lightbox-link"><img alt="安装插件" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/doc_2022-07-19_18-16-07.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-af0d4d9908eca3e2ae34d88db9a47adb"><img alt="安装插件" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/doc_2022-07-19_18-16-07.png"></a></p>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->跳过创建用户界面<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<p><a href="#R-image-06a3785b8d4fb16388199c0a32279c2d" class="lightbox-link"><img alt="跳过创建用户界面" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_18-22-54.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-06a3785b8d4fb16388199c0a32279c2d"><img alt="跳过创建用户界面" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_18-22-54.png"></a></p>
</blockquote>
<ul>
<li><code>URL</code><!-- raw HTML omitted -->配置界面选择：保存并完成<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<p><a href="#R-image-0ce2f458eefa2f1ab8a48aad58d7847a" class="lightbox-link"><img alt="URL配置" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_18-23-18.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-0ce2f458eefa2f1ab8a48aad58d7847a"><img alt="URL配置" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_18-23-18.png"></a></p>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->选择：开始使用<!-- raw HTML omitted --><code>Jenkins</code><!-- raw HTML omitted -->安装完成<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<p><a href="#R-image-fd0b2ac304a3b0039338fea6b45db7e6" class="lightbox-link"><img alt="开始使用Jenkins" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_18-23-32.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-fd0b2ac304a3b0039338fea6b45db7e6"><img alt="开始使用Jenkins" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jenkins_Server/Snipaste_2022-07-19_18-23-32.png"></a></p>
</blockquote>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          </section>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="jumpserver">JumpServer</h1>


            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of JumpServer</h1>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="use_jumpserver">Use_JumpServer</h1>

<h2 id="配置jumpserver">配置<code>Jumpserver</code></h2>
<h3 id="配置nginx代理jumpserver">配置<code>Nginx</code>代理<code>Jumpserver</code></h3>
<blockquote>
<ul>
<li><code>Nginx</code><!-- raw HTML omitted -->配置文件代理<!-- raw HTML omitted --><code>Jumpserver</code><!-- raw HTML omitted --><strong>默认用户名密码都是：</strong><!-- raw HTML omitted --><code>admin</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/usr/local/nginx/conf/vhosts/jumpserver.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">server{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> listen 80;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> server_name jumpserver.com;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> location / {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     client_max_body_size 50m;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     proxy_redirect off;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     proxy_http_version 1.1;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     proxy_set_header Host $host;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     proxy_set_header X-Real-IP $remote_addr;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     proxy_set_header Upgrade $http_upgrade;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     proxy_set_header Connection &#34;upgrade&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     proxy_pass http://127.0.0.1:8888;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     index index.html index.htm;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> error_page 404 http://jumpserver.com;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> access_log  /usr/local/nginx/logs/jumpserver-access.log  main;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> error_log   /usr/local/nginx/logs/jumpserver-error.log  info;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="配置jumpserver配置文件">配置<code>Jumpserver</code>配置文件</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->修改上传默认目录为：<!-- raw HTML omitted --><code>/tmp</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/koko-2.24.2/config_example.yml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 项目名称, 会用来向Jumpserver注册, 识别而已, 不能重复
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># NAME: {{ Hostname }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># Jumpserver项目的url, api请求注册会使用
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">CORE_HOST: http://127.0.0.1:8080
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># Bootstrap Token, 预共享秘钥, 用来注册coco使用的service account和terminal
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 请和jumpserver 配置文件中保持一致，注册完成后可以删除
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">BOOTSTRAP_TOKEN: &lt;PleasgeChangeSameWithJumpserver&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 启动时绑定的ip, 默认 0.0.0.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># BIND_HOST: 0.0.0.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 监听的SSH端口号, 默认2222
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># SSHD_PORT: 2222
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 监听的HTTP/WS端口号，默认5000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># HTTPD_PORT: 5000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 设置日志级别 [DEBUG, INFO, WARN, ERROR, FATAL, CRITICAL]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># LOG_LEVEL: INFO
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># SSH连接超时时间 (default 15 seconds)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># SSH_TIMEOUT: 15
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 语言 [en,zh]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># LANGUAGE_CODE: zh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># SFTP的根目录, 可选 /tmp, Home其他自定义目录
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># SFTP_ROOT: /tmp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># SFTP是否显示隐藏文件
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># SFTP_SHOW_HIDDEN_FILE: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 是否复用和用户后端资产已建立的连接(用户不会复用其他用户的连接)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># REUSE_CONNECTION: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 资产加载策略, 可根据资产规模自行调整. 默认异步加载资产, 异步搜索分页; 如果为all, 则资产全部加载, 本地搜索分页.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ASSET_LOAD_POLICY:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># zip压缩的最大额度 (单位: M)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ZIP_MAX_SIZE: 1024M
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># zip压缩存放的临时目录 /tmp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ZIP_TMP_PATH: /tmp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 向 SSH Client 连接发送心跳的时间间隔 (单位: 秒)，默认为30, 0则表示不发送
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># CLIENT_ALIVE_INTERVAL: 30
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 向资产发送心跳包的重试次数，默认为3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># RETRY_ALIVE_COUNT_MAX: 3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 会话共享使用的类型 [local, redis], 默认local
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># SHARE_ROOM_TYPE: local
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># Redis配置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># REDIS_HOST: 127.0.0.1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># REDIS_PORT: 6379
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># REDIS_PASSWORD:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># REDIS_CLUSTERS:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># REDIS_DB_ROOM:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 是否开启本地转发 (目前仅对 vscode remote ssh 有效果)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ENABLE_LOCAL_PORT_FORWARD: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 是否开启 针对 vscode 的 remote-ssh 远程开发支持 (前置条件: 必须开启 ENABLE_LOCAL_PORT_FORWARD )
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ENABLE_VSCODE_SUPPORT: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="jumpserver界面配置"><code>Jumpserver</code>界面配置</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->系统用户配置<!-- raw HTML omitted --></li>
</ul>
<p><a href="#R-image-c1802a4a7b293341c5f7780efef28575" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jump_Server/Snipaste_2023-03-29_15-38-39.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-c1802a4a7b293341c5f7780efef28575"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jump_Server/Snipaste_2023-03-29_15-38-39.png"></a></p>
<ul>
<li><!-- raw HTML omitted -->权限管理配置<!-- raw HTML omitted --></li>
</ul>
<p><a href="#R-image-57841c534389c4427db57eba9e47ff92" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jump_Server/Snipaste_2023-03-29_15-42-52.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-57841c534389c4427db57eba9e47ff92"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jump_Server/Snipaste_2023-03-29_15-42-52.png"></a></p>
<ul>
<li><!-- raw HTML omitted -->其它系统设置<!-- raw HTML omitted --></li>
</ul>
<p><a href="#R-image-6bbef13c34db93f2caebcc49710c8935" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jump_Server/Snipaste_2023-03-29_15-50-02.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-6bbef13c34db93f2caebcc49710c8935"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Jump_Server/Snipaste_2023-03-29_15-50-02.png"></a></p>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_jumpserver">Install_JumpServer</h1>

<h2 id="center安装jumpserver堡垒机center"><!-- raw HTML omitted -->安装<code>Jumpserver</code>堡垒机<!-- raw HTML omitted --></h2>
<!-- raw HTML omitted -->
<ul>
<li>
<ol>
<li><code>jump server</code><!-- raw HTML omitted --><strong>简介</strong>、安装<!-- raw HTML omitted --><a href="https://docs.jumpserver.org/zh/master/dev/build/" rel="external" target="_self"><code>JumpServer</code></a></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->完全开源，使用<!-- raw HTML omitted --><code>GNU GPL v2.0</code><!-- raw HTML omitted -->开源协议，符合<!-- raw HTML omitted --><code>4A</code><!-- raw HTML omitted -->专业运维审计<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>Python/Django</code><!-- raw HTML omitted -->进行开发，遵循<!-- raw HTML omitted --><code>Web2.0</code><!-- raw HTML omitted -->规范<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->实现了跳板机基本功能，认证、授权、审计<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->集成了<!-- raw HTML omitted --><code>Ansible</code><!-- raw HTML omitted -->批量命令，支持<!-- raw HTML omitted --><code>web Terminal</code></li>
<li><!-- raw HTML omitted -->采纳分布式架构，支持多机房跨区域部署<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->现支持<!-- raw HTML omitted --><code>SSH、Telnet、RDP、VNC</code><!-- raw HTML omitted -->协议资产<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->自动收集硬件信息、录像回放、命令搜索、实时监控、批量上传下载<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->多租户：一套系统，多个子公司和部门同时使用<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->多应用支持：数据库，<!-- raw HTML omitted --><code>Windows</code><!-- raw HTML omitted -->远程应用<!-- raw HTML omitted --><code>Kubernetes</code></li>
<li><a href="https://www.jumpserver.org/video.html" rel="external" target="_self">官方视频</a></li>
</ul>
</blockquote>
<h3 id="基础配置环境要求">基础配置环境要求</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->安装环境要求，<strong>默认账号密码都是：</strong><!-- raw HTML omitted --><code>admin</code></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>系统/服务</th>
<th>版本</th>
<th>工具/数据库字符集</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>linux/amd64</code></td>
<td><code>&gt;= 4.0</code></td>
<td><code>wget curl tar gettext iptables python</code></td>
</tr>
<tr>
<td><code>MySQL</code></td>
<td><code>&gt;= 5.7</code></td>
<td><code>utf8、utf8_general_ci</code></td>
</tr>
<tr>
<td><code>MariaDB</code></td>
<td><code>&gt;= 10.2</code></td>
<td><code>utf8mb3、utf8mb3_general_ci</code></td>
</tr>
<tr>
<td><code>Redis</code></td>
<td><code>&gt;= 5.0</code></td>
<td><code>Sentinel</code>模式，使用<code>Redis</code>做<code>cache</code>和<code>celery broke</code></td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->生成随机加密密钥<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>Linux</code><!-- raw HTML omitted -->系统，生成随机加密密钥<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$SECRET_KEY<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span> SECRET_KEY<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>cat /dev/urandom | tr -dc A-Za-z0-9 | head -c 50<span style="color:#e6db74">`</span>; echo <span style="color:#e6db74">&#34;SECRET_KEY=</span>$SECRET_KEY<span style="color:#e6db74">&#34;</span> &gt;&gt; ~/.bashrc; echo $SECRET_KEY; <span style="color:#66d9ef">else</span> echo $SECRET_KEY; <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$BOOTSTRAP_TOKEN<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span> BOOTSTRAP_TOKEN<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>cat /dev/urandom | tr -dc A-Za-z0-9 | head -c 16<span style="color:#e6db74">`</span>; echo <span style="color:#e6db74">&#34;BOOTSTRAP_TOKEN=</span>$BOOTSTRAP_TOKEN<span style="color:#e6db74">&#34;</span> &gt;&gt; ~/.bashrc; echo $BOOTSTRAP_TOKEN; <span style="color:#66d9ef">else</span> echo $BOOTSTRAP_TOKEN; <span style="color:#66d9ef">fi</span></span></span></code></pre></div><ul>
<li><code>macOS</code><!-- raw HTML omitted -->系统，生成随机<!-- raw HTML omitted --><code>key</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$SECRET_KEY<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span> SECRET_KEY<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>LC_CTYPE<span style="color:#f92672">=</span>C tr -dc A-Za-z0-9 &lt; /dev/urandom | head -c 50<span style="color:#e6db74">`</span>; echo <span style="color:#e6db74">&#34;SECRET_KEY=</span>$SECRET_KEY<span style="color:#e6db74">&#34;</span> &gt;&gt; ~/.bash_profile; echo $SECRET_KEY; <span style="color:#66d9ef">else</span> echo $SECRET_KEY; <span style="color:#66d9ef">fi</span>  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$BOOTSTRAP_TOKEN<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span> BOOTSTRAP_TOKEN<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>LC_CTYPE<span style="color:#f92672">=</span>C tr -dc A-Za-z0-9 &lt; /dev/urandom | head -c 16<span style="color:#e6db74">`</span>; echo <span style="color:#e6db74">&#34;BOOTSTRAP_TOKEN=</span>$BOOTSTRAP_TOKEN<span style="color:#e6db74">&#34;</span> &gt;&gt; ~/.bash_profile; echo $BOOTSTRAP_TOKEN; <span style="color:#66d9ef">else</span> echo $BOOTSTRAP_TOKEN; <span style="color:#66d9ef">fi</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->创建数据库<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ DB_PASSWORD<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>cat /dev/urandom | tr -dc A-Za-z0-9 | head -c 24<span style="color:#66d9ef">)</span>  	<span style="color:#75715e"># 生成随机数据库密码</span>
</span></span><span style="display:flex;"><span>$ echo -e <span style="color:#e6db74">&#34;\033[31m 你的数据库密码是 </span>$DB_PASSWORD<span style="color:#e6db74"> \033[0m&#34;</span>
</span></span><span style="display:flex;"><span>$ mysql -uroot -e <span style="color:#e6db74">&#34;create database jumpserver default charset &#39;utf8&#39;; grant all on jumpserver.* to &#39;jumpserver&#39;@&#39;127.0.0.1&#39; identified by &#39;</span>$DB_PASSWORD<span style="color:#e6db74">&#39;; flush privileges;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建数据库以及编码类型</span>
</span></span><span style="display:flex;"><span>mysql &gt; create database jumpserver default charset <span style="color:#e6db74">&#39;utf8&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建用户以及授权</span>
</span></span><span style="display:flex;"><span>mysql &gt; grant all on jumpserver.* to <span style="color:#e6db74">&#39;jumpserver&#39;</span>@<span style="color:#e6db74">&#39;%&#39;</span> identified by <span style="color:#e6db74">&#39;password&#39;</span>;</span></span></code></pre></div></blockquote>
<hr>
<h3 id="docker安装jumpserver"><code>Docker</code>安装<code>JumpServer</code></h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->执行<!-- raw HTML omitted --><a href="https://github.com/jumpserver/Dockerfile/tree/master/allinone" rel="external" target="_self"><code>docker</code></a><!-- raw HTML omitted -->部署命令<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><a href="https://github.com/jumpserver/Dockerfile" rel="external" target="_self"><code>docker-compose</code></a><!-- raw HTML omitted -->标准部署<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git clone --depth<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> https://github.com/jumpserver/Dockerfile.git /opt/docker-compose/jumpserver</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改配置文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /opt/docker-compose/jumpserver/
</span></span><span style="display:flex;"><span>$ cp config_example.conf .env
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;/opt/docker-compose/jumpserver/.env<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 版本号可以自己根据项目的版本修改
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Version=v2.28.7
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 构建参数, 支持 amd64/arm64
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">TARGETARCH=amd64
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## Compose
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">COMPOSE_PROJECT_NAME=jms
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## COMPOSE_HTTP_TIMEOUT=3600
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## DOCKER_CLIENT_TIMEOUT=3600
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DOCKER_SUBNET=172.16.238.0/24
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 持久化存储
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">VOLUME_DIR=/opt/jumpserver
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## MySQL
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DB_HOST=mysql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DB_PORT=3306
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DB_USER=root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DB_PASSWORD=nu4x599Wq7u0Bn8EABh3J91G
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DB_NAME=jumpserver
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## Redis
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">REDIS_HOST=redis
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">REDIS_PORT=6379
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">REDIS_PASSWORD=8URXPL2x3HZMi7xoGTdk3Upj
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## Core
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SECRET_KEY=B3f2w8P2PfxIAS7s4URrD9YmSbtqX4vXdPUL217kL9XPUOWrmy
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">BOOTSTRAP_TOKEN=7Q11Vz6R2J6BLAdO
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DEBUG=FALSE
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LOG_LEVEL=ERROR
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## Web
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">HTTP_PORT=80
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SSH_PORT=2222
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MAGNUS_PORT=30000-30020
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## SECRET_KEY 保护签名数据的密匙, 首次安装请一定要修改并牢记, 后续升级和迁移不可更改, 否则将导致加密的数据不可解密。
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## BOOTSTRAP_TOKEN 为组件认证使用的密钥, 仅组件注册时使用。组件指 koko、guacamole
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->初始化数据库、启动<!-- raw HTML omitted --><code>jms_core</code><!-- raw HTML omitted -->容器<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ docker-compose -f docker-compose-network.yml -f docker-compose-init-db.yml up -d</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->处理数据库合并<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ docker exec -i jms_core bash -c <span style="color:#e6db74">&#39;./jms upgrade_db&#39;</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->构建启动<!-- raw HTML omitted --><code>Jumpserver</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ docker-compose -f docker-compose-network.yml -f docker-compose.yml up -d</span></span></code></pre></div></blockquote>
<hr>
<h3 id="hlem部署jump-server"><code>Hlem</code>部署<code>Jump Server</code></h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>Hlem</code><!-- raw HTML omitted -->部署<!-- raw HTML omitted --><code>Jumpserver</code><!-- raw HTML omitted -->到<!-- raw HTML omitted --><code>Kubernetes</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>Hlem</code><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>Jumpserver</code><!-- raw HTML omitted -->库<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm repo add jumpserver https://jumpserver.github.io/helm-charts
</span></span><span style="display:flex;"><span>$ helm repo list</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>Jumserver</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>yaml</code><!-- raw HTML omitted -->文件<!-- raw HTML omitted --><a href="https://github.com/jumpserver/helm-charts/blob/main/charts/jumpserver/values.yaml" rel="external" target="_self"><code>JumpServer</code>模板链接</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;values.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># Default values for jumpserver.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># This is a YAML-formatted file.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># Declare variables to be passed into your templates.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">nameOverride: &#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fullnameOverride: &#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## @param global.imageRegistry Global Docker image registry
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## @param global.imagePullSecrets Global Docker registry secret names as an array
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## @param global.storageClass Global StorageClass for Persistent Volume(s)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## @param global.redis.password Global Redis&amp;trade; password (overrides `auth.password`)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">global:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> imageRegistry: &#34;docker.io&#34;    # 国内可以使用华为云加速
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> imageTag: v2.26.0             # 版本号
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> ## E.g.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> #  imagePullSecrets:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> #    - name: harborsecret
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> #
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> #  storageClass: &#34;jumpserver-data&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> ##
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> imagePullSecrets: []
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # - name: yourSecretKey
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> storageClass: &#34;&#34;              # (*必填) NFS SC
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## Please configure your MySQL server first
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## Jumpserver will not start the external MySQL server.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">externalDatabase:               #  (*必填) 数据库相关设置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> engine: mysql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> host: localhost
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> port: 3306
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> user: root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> password: &#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> database: jumpserver
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## Please configure your Redis server first
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## Jumpserver will not start the external Redis server.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">externalRedis:                  #  (*必填) Redis 设置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> host: localhost
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> port: 6379
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> password: &#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">serviceAccount:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # Specifies whether a service account should be created
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> create: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # The name of the service account to use.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # If not set and create is true, a name is generated using the fullname template
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> name:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ingress:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> enabled: true                             # 不使用 ingress 可以关闭
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> annotations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # kubernetes.io/tls-acme: &#34;true&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   compute-full-forwarded-for: &#34;true&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   use-forwarded-headers: &#34;true&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   kubernetes.io/ingress.class: nginx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   nginx.ingress.kubernetes.io/configuration-snippet: |
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      proxy_set_header Upgrade &#34;websocket&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      proxy_set_header Connection &#34;Upgrade&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> hosts:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   - &#34;test.jumpserver.org&#34;                 # 对外域名
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> tls: []
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> #  - secretName: chart-example-tls
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> #    hosts:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> #      - chart-example.local
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">core:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   app.jumpserver.org/name: jms-core
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> config:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # Generate a new random secret key by execute `cat /dev/urandom | tr -dc A-Za-z0-9 | head -c 50`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # secretKey: &#34;B3f2w8P2PfxIAS7s4URrD9YmSbtqX4vXdPUL217kL9XPUOWrmy&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   secretKey: &#34;&#34;                            #  (*必填) 加密敏感信息的 secret_key, 长度推荐大于 50 位
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # Generate a new random bootstrap token by execute `cat /dev/urandom | tr -dc A-Za-z0-9 | head -c 16`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # bootstrapToken: &#34;7Q11Vz6R2J6BLAdO&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   bootstrapToken: &#34;&#34;                       #  (*必填) 组件认证使用的 token, 长度推荐大于 24 位
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # Enabled it for debug
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   debug: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   log:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     level: ERROR
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> replicaCount: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> image:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   registry: docker.io
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   repository: jumpserver/core
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   tag: v2.26.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   pullPolicy: IfNotPresent
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> command: []
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> env:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # See: https://docs.jumpserver.org/zh/master/admin-guide/env/#core
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   SESSION_EXPIRE_AT_BROWSER_CLOSE: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # SESSION_COOKIE_AGE: 86400
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # SECURITY_VIEW_AUTH_NEED_MFA: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> livenessProbe:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   failureThreshold: 30
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   httpGet:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     path: /api/health/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     port: web
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> readinessProbe:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   failureThreshold: 30
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   httpGet:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     path: /api/health/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     port: web
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> podSecurityContext: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # fsGroup: 2000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> securityContext: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # capabilities:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   drop:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   - ALL
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # readOnlyRootFilesystem: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # runAsNonRoot: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # runAsUser: 1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> service:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   type: ClusterIP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   web:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     port: 8080
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   ws:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     port: 8070
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> resources: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # We usually recommend not to specify default resources and to leave this as a conscious
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # choice for the user. This also increases chances charts run on environments with little
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # resources, such as Minikube. If you do want to specify resources, uncomment the following
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # lines, adjust them as necessary, and remove the curly braces after &#39;resources:&#39;.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # limits:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   cpu: 1000m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   memory: 2048Mi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # requests:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   cpu: 500m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   memory: 1024Mi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> persistence:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   storageClassName: jumpserver-data
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   accessModes:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     - ReadWriteMany
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   size: 100Gi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # annotations: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   finalizers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     - kubernetes.io/pvc-protection
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # subPath: &#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # existingClaim:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> volumeMounts: []
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> volumes: []
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> nodeSelector: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> tolerations: []
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> affinity: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">koko:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   app.jumpserver.org/name: jms-koko
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> config:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   log:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     level: ERROR
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> replicaCount: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> image:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   registry: docker.io
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   repository: jumpserver/koko
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   tag: v2.26.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   pullPolicy: IfNotPresent
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> command: []
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> env: []
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # See: https://docs.jumpserver.org/zh/master/admin-guide/env/#koko
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # LANGUAGE_CODE: zh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # REUSE_CONNECTION: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # ENABLE_LOCAL_PORT_FORWARD: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # ENABLE_VSCODE_SUPPORT: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> livenessProbe:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   failureThreshold: 30
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   httpGet:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     path: /koko/health/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     port: web
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> readinessProbe:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   failureThreshold: 30
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   httpGet:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     path: /koko/health/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     port: web
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> podSecurityContext: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # fsGroup: 2000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> securityContext:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   privileged: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # capabilities:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   drop:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   - ALL
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # readOnlyRootFilesystem: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # runAsNonRoot: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # runAsUser: 1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> service:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   type: ClusterIP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   web:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     port: 5000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   ssh:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     port: 2222
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> resources: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # We usually recommend not to specify default resources and to leave this as a conscious
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # choice for the user. This also increases chances charts run on environments with little
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # resources, such as Minikube. If you do want to specify resources, uncomment the following
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # lines, adjust them as necessary, and remove the curly braces after &#39;resources:&#39;.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # limits:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   cpu: 100m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   memory: 128Mi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # requests:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   cpu: 100m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   memory: 128Mi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> persistence:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   storageClassName: jumpserver-data
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   accessModes:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     - ReadWriteMany
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   size: 10Gi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # annotations: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   finalizers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     - kubernetes.io/pvc-protection
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> volumeMounts: []
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> volumes: []
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> nodeSelector: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> tolerations: []
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> affinity: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">lion:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   app.jumpserver.org/name: jms-lion
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> config:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   log:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     level: ERROR
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> replicaCount: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> image:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   registry: docker.io
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   repository: jumpserver/lion
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   tag: v2.26.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   pullPolicy: IfNotPresent
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> command: []
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> env:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # See: https://docs.jumpserver.org/zh/master/admin-guide/env/#lion
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   JUMPSERVER_ENABLE_FONT_SMOOTHING: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # JUMPSERVER_COLOR_DEPTH: 32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # JUMPSERVER_ENABLE_WALLPAPER: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # JUMPSERVER_ENABLE_THEMING: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # JUMPSERVER_ENABLE_FULL_WINDOW_DRAG: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # JUMPSERVER_ENABLE_DESKTOP_COMPOSITION: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # JUMPSERVER_ENABLE_MENU_ANIMATIONS: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> livenessProbe:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   failureThreshold: 30
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   httpGet:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     path: /lion/health/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     port: web
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> readinessProbe:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   failureThreshold: 30
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   httpGet:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     path: /lion/health/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     port: web
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> podSecurityContext: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # fsGroup: 2000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> securityContext: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # capabilities:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   drop:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   - ALL
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # readOnlyRootFilesystem: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # runAsNonRoot: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # runAsUser: 1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> service:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   type: ClusterIP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   web:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     port: 8081
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> resources: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # We usually recommend not to specify default resources and to leave this as a conscious
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # choice for the user. This also increases chances charts run on environments with little
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # resources, such as Minikube. If you do want to specify resources, uncomment the following
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # lines, adjust them as necessary, and remove the curly braces after &#39;resources:&#39;.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # limits:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   cpu: 100m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   memory: 512Mi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # requests:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   cpu: 100m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   memory: 512Mi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> persistence:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   storageClassName: jumpserver-data
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   accessModes:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     - ReadWriteMany
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   size: 50Gi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # annotations: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   finalizers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     - kubernetes.io/pvc-protection
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> volumeMounts: []
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> volumes: []
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> nodeSelector: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> tolerations: []
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> affinity: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">magnus:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   app.jumpserver.org/name: jms-magnus
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> config:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   log:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     level: ERROR
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> replicaCount: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> image:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   registry: docker.io
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   repository: jumpserver/magnus
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   tag: v2.21.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   pullPolicy: IfNotPresent
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> command: []
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> env: []
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> livenessProbe:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   failureThreshold: 30
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   tcpSocket:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     port: mysql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> readinessProbe:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   failureThreshold: 30
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   tcpSocket:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     port: mysql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> podSecurityContext: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # fsGroup: 2000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> securityContext: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # capabilities:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   drop:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   - ALL
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # readOnlyRootFilesystem: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # runAsNonRoot: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # runAsUser: 1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> service:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   type: ClusterIP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   mysql:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     port: 33060
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   mariadb:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     port: 33061
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   postgre:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     port: 54320
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> resources: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # We usually recommend not to specify default resources and to leave this as a conscious
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # choice for the user. This also increases chances charts run on environments with little
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # resources, such as Minikube. If you do want to specify resources, uncomment the following
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # lines, adjust them as necessary, and remove the curly braces after &#39;resources:&#39;.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # limits:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   cpu: 100m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   memory: 512Mi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # requests:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   cpu: 100m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   memory: 512Mi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> persistence:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   storageClassName: jumpserver-data
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   accessModes:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     - ReadWriteMany
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   size: 10Gi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # annotations: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   finalizers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     - kubernetes.io/pvc-protection
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> volumeMounts: []
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> volumes: []
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> nodeSelector: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> tolerations: []
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> affinity: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">xpack:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> enabled: false      # 企业版本打开此选项
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">omnidb:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   app.jumpserver.org/name: jms-omnidb
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> config:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   log:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     level: ERROR
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> replicaCount: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> image:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   registry: registry.fit2cloud.com
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   repository: jumpserver/omnidb
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   tag: v2.26.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   pullPolicy: IfNotPresent
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> command: []
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> env: []
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> livenessProbe:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   failureThreshold: 30
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   tcpSocket:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     port: web
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> readinessProbe:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   failureThreshold: 30
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   tcpSocket:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     port: web
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> podSecurityContext: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # fsGroup: 2000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> securityContext: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # capabilities:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   drop:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   - ALL
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # readOnlyRootFilesystem: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # runAsNonRoot: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # runAsUser: 1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> service:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   type: ClusterIP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   web:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     port: 8082
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> resources: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # We usually recommend not to specify default resources and to leave this as a conscious
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # choice for the user. This also increases chances charts run on environments with little
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # resources, such as Minikube. If you do want to specify resources, uncomment the following
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # lines, adjust them as necessary, and remove the curly braces after &#39;resources:&#39;.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # limits:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   cpu: 100m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   memory: 128Mi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # requests:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   cpu: 100m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   memory: 128Mi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> persistence:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   storageClassName: jumpserver-data
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   accessModes:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     - ReadWriteMany
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   size: 10Gi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # annotations: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   finalizers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     - kubernetes.io/pvc-protection
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> volumeMounts: []
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> volumes: []
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> nodeSelector: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> tolerations: []
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> affinity: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">razor:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   app.jumpserver.org/name: jms-razor
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> config:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   log:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     level: ERROR
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> replicaCount: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> image:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   registry: registry.fit2cloud.com
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   repository: jumpserver/razor
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   tag: v2.26.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   pullPolicy: IfNotPresent
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> command: []
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> env: []
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> livenessProbe:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   failureThreshold: 30
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   tcpSocket:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     port: rdp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> readinessProbe:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   failureThreshold: 30
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   tcpSocket:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     port: rdp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> podSecurityContext: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # fsGroup: 2000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> securityContext: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # capabilities:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   drop:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   - ALL
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # readOnlyRootFilesystem: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # runAsNonRoot: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # runAsUser: 1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> service:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   type: ClusterIP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   rdp:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     port: 3389
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> resources: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # We usually recommend not to specify default resources and to leave this as a conscious
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # choice for the user. This also increases chances charts run on environments with little
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # resources, such as Minikube. If you do want to specify resources, uncomment the following
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # lines, adjust them as necessary, and remove the curly braces after &#39;resources:&#39;.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # limits:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   cpu: 100m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   memory: 128Mi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # requests:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   cpu: 100m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   memory: 128Mi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> persistence:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   storageClassName: jumpserver-data
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   accessModes:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     - ReadWriteMany
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   size: 50Gi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # annotations: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   finalizers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     - kubernetes.io/pvc-protection
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> volumeMounts: []
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> volumes: []
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> nodeSelector: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> tolerations: []
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> affinity: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">web:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   app.jumpserver.org/name: jms-web
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> replicaCount: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> image:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   registry: docker.io
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   repository: jumpserver/web
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   tag: v2.26.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   pullPolicy: IfNotPresent
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> command: []
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> env: []
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # nginx client_max_body_size, default 4G
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # CLIENT_MAX_BODY_SIZE: 4096m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> livenessProbe:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   failureThreshold: 30
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   httpGet:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     path: /api/health/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     port: web
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> readinessProbe:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   failureThreshold: 30
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   httpGet:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     path: /api/health/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     port: web
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> podSecurityContext: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # fsGroup: 2000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> securityContext: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # capabilities:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   drop:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   - ALL
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # readOnlyRootFilesystem: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # runAsNonRoot: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # runAsUser: 1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> service:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   type: ClusterIP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   web:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     port: 80
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> resources: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # We usually recommend not to specify default resources and to leave this as a conscious
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # choice for the user. This also increases chances charts run on environments with little
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # resources, such as Minikube. If you do want to specify resources, uncomment the following
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # lines, adjust them as necessary, and remove the curly braces after &#39;resources:&#39;.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # limits:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   cpu: 100m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   memory: 128Mi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # requests:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   cpu: 100m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   #   memory: 128Mi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> persistence:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   storageClassName: jumpserver-data
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   accessModes:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     - ReadWriteMany
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   size: 1Gi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   # annotations: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   finalizers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     - kubernetes.io/pvc-protection
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> volumeMounts: []
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> volumes: []
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> nodeSelector: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> tolerations: []
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> affinity: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->安装、卸载命令<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 安装</span>
</span></span><span style="display:flex;"><span>$ helm install jms-k8s jumpserver/jumpserver -n jumpserver -f values.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 卸载</span>
</span></span><span style="display:flex;"><span>$ helm uninstall jms-k8s -n default</span></span></code></pre></div></blockquote>
<hr>
<h3 id="脚本安装jumpserver">脚本安装<code>Jumpserver</code></h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->安装完成后配置文件<!-- raw HTML omitted --><code>/opt/jumpserver/config/config.txt</code></li>
<li><a href="https://docs.jumpserver.org/zh/master/install/setup_by_fast/" rel="external" target="_self"><code>Jumpserver</code></a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ curl -sSL https://github.com/jumpserver/jumpserver/releases/download/v2.24.2/quick_start.sh | bash
</span></span><span style="display:flex;"><span>$ cd /opt/jumpserver-installer-v2.24.2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动</span>
</span></span><span style="display:flex;"><span>$ ./jmsctl.sh start -d  	<span style="color:#75715e"># 后台运行使用 -d 参数./jms start -d</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 停止</span>
</span></span><span style="display:flex;"><span>$ ./jmsctl.sh down
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 卸载</span>
</span></span><span style="display:flex;"><span>$ ./jmsctl.sh uninstall
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 帮助</span>
</span></span><span style="display:flex;"><span>$ ./jmsctl.sh -h</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          </section>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="keepalived">Keepalived</h1>


            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Keepalived</h1>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_keepalived">Install_Keepalived</h1>

<h2 id="keepalived简介"><code>Keepalived</code>简介</h2>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->标签： 高可用<!-- raw HTML omitted --><code>vrrp</code></li>
<li><code>Keepalived</code>啥软件起初是准尉<code>LVS</code>负载软件设计的，用来管理并监控<code>LVS</code>集群系统中各个服务节点的装阿提，后来加入了高可用的<code>VRRP</code>功能。 <code>VRRP</code>是<code>Virtual Router Redundancy Protocol(虚拟路由器冗余协议)</code>的缩写，为解决静态路由器单点故障问题，确保个别节点宕机时，真哥哥网络可以不间断地运行。 <code>Keepalived</code>另一方面具有配置配置管理<code>LVS</code>的功能，同时还具有对<code>LVS</code>下面节进行健康检查的功能。</li>
<li><code>VRRP</code>原理介绍</li>
</ul>
<blockquote>
<ul>
<li><code>VRRP</code>，全称<code>Virtual Router Redundancy Protocol</code>中文名为虚拟路由冗余协议，<code>VRRP</code>的出现是为了解决静态路由的单</li>
<li><code>keepalived</code>通过<code>vrrp</code>通信，通过竞选确定主备协议机制来将路由任务交给某台<code>VRRP</code>路由器的，主优先级高于备。因此，工作时主会获得所有资源，备节点处于等待状态，当主节点宕机，那么备节点启用接管程序接管主节点资源，顶替主节点提供服务。</li>
<li><code>VRRP</code>报文封装在<code>IP</code>报文中，只有一种<code>VRRP</code>通告报文， 只有处于<code>master</code>状态下的路由器会发送，<code>VRRP</code>用<code>IP</code>多播的方式（默认多播地址（224.0.0.18））实现高可用对之间通信。</li>
<li>在<code>Keepalived</code>服务对之间，只有作为主的服务器会一直发送<code>VRRP</code>广播包，告诉备它还活着，此时备不会抢占主，当主不可用时，即监听不到主发送的广播包时，就会启动相关服务接管资源，保证业务的连续性。接管速度最快可以小于1秒，备节点可以有多个，通过优先级竞选，但一般<code>Keepalived</code>系统运维工作中都是一对。</li>
<li><code>VRRP</code>使用了加密协议加密数据，但<code>Keepalived</code>官方目前还是推荐用明文的方式配置认证类型和密码。</li>
</ul>
<blockquote>
<ul>
<li><code>VRID</code>虚拟路由器表示，拥有相同<code>VRID</code>的一组路由器构成一个虚拟路由器，一个虚拟路由器可以拥有一个或多个虚拟<code>IP</code>地址</li>
<li>虚拟<code>MAC</code>地址<code>00-00-5E-00-01（VRID）</code></li>
<li>分为抢占和不抢占</li>
<li>优先级高的成为<code>master</code>路由器，范围是0-255，0表示路由器放弃<code>master</code>状态，255表示虚拟<code>IP</code>地址实际拥有者。默认为100</li>
<li><code>backup</code>路由器切换到<code>master</code>路由器的时间为<code>skew time=256-backup</code>路由器优先级/256</li>
<li><code>master</code>失效，<code>backup</code>转换成<code>master</code>需要的时间为<code>3*V</code>隔<code>RRP</code>报文间<code>Skew tim</code></li>
</ul>
</blockquote>
</blockquote>
<ul>
<li><code>Keepalived</code>服务的三个重要功能</li>
</ul>
<blockquote>
<ul>
<li>
<p><!-- raw HTML omitted -->管理<!-- raw HTML omitted --><code>LVS</code><!-- raw HTML omitted -->负载均衡软件<!-- raw HTML omitted --></p>
<p><code>Keepalived</code>软件起初是为了解决<code>LVS</code>的问题而诞生的。因此，<code>Keepalived</code>和<code>LVS</code>的感情很深，向夫妻一样可以紧密结合，愉快地工作。 <code>Keepalived</code>通过读取配置文件，实现通过更底层的接口直接管理<code>LVS</code>及控制服务器的启动、停止等功能，使得<code>LVS</code>应用更加简单方便。</p>
</li>
<li>
<p><!-- raw HTML omitted -->实现对<!-- raw HTML omitted --><code>LVS</code><!-- raw HTML omitted -->集群健康检查的功能<!-- raw HTML omitted --></p>
<p><code>Keepalived</code>可以通过在自身的<code>keepalived.conf</code>文件里配置<code>LVS</code>的节点<code>IP</code>和相关参数实现对<code>LVS</code>的直接管理；当故障的节点服务器被修复以后，<code>Keepalived</code>服务又会自动地把它们加入到正常转发队列中，对客户提供服务。</p>
</li>
<li>
<p><!-- raw HTML omitted -->作为系统网络服务的高可用<!-- raw HTML omitted --></p>
<p><code>Keepalived</code>可以实现任意两台主机之间，例如<code>Master</code>和<code>Backup</code>主机之间的故障转移和自动切换，这个主机可以是普通的不能停机的业务服务器，也可以是<code>LVS</code>负载均衡、<code>Nginx</code>反向代理这样的服务器。</p>
</li>
</ul>
</blockquote>
</blockquote>
<hr>
<h3 id="vip漂移实战"><code>VIP</code>漂移实战</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->服务器规划<!-- raw HTML omitted --></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">服务器</th>
<th style="text-align:left"><code>ip</code></th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>keepalived-01</code></td>
<td style="text-align:left">10.0.0.7</td>
<td style="text-align:left"><code>keepalived</code>主服务器</td>
</tr>
<tr>
<td style="text-align:left"><code>keepalived-02</code></td>
<td style="text-align:left">10.0.0.8</td>
<td style="text-align:left"><code>keepalived</code>备服务器</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">10.0.0.3</td>
<td style="text-align:left">VIP</td>
</tr>
</tbody>
</table>
<ul>
<li><!-- raw HTML omitted -->安装、配置<!-- raw HTML omitted --><code>Keepalived</code></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->两台<!-- raw HTML omitted -->服务器都安装<code>Keepalived</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum install keepalived -y</span></span></code></pre></div></blockquote>
<ul>
<li>修改<!-- raw HTML omitted -->主<!-- raw HTML omitted -->服务器<code>Keepalived</code>配置文件</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/keepalived/keepalived.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">! Configuration File for keepalived
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">global_defs {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# 设置的邮件报警，这部分一般由nagios、zabbix监控软件来负责，这里的内容很鸡肋。
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	notification_email {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		31333741@qq.com
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	notification_email_from  31333741@qq.com
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	smtp_server 192.168.200.1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	smtp_connect_timeout 30
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	router_id LVS_lb01  	# 主节点id 不能和备节点重名
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	vrrp_skip_check_adv_addr
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# 使用 unicast_src_ip 需要注释 vrrp_strict，也可以使用 ping 进行测试
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# vrrp_strict
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	vrrp_garp_interval 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	vrrp_gna_interval 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	script_user root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	enable_script_security
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 定义vrrp检测脚本，檢查nginx狀況
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">vrrp_script chk_nginx {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 执行脚本，当nginx服务有问题的時候就停掉keepalived服务
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">script &#34;/opt/script/chk_nginx.sh&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 间隔1秒
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">interval 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">weight 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># VRRP实例
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">vrrp_instance VI_1 {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 指定keepalived的角色，MASTER表示此主機是主服務器，BACKUP表示主機為備用服務器
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">state MASTER
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 设置的通信网卡名称 备节点设置一样
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">interface eth0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 虚拟路由标志，支持一个数字，同一个vrrp实例使用唯一的标志
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 同一個vrrp_instance底下，MASTER跟BACKUP必须一致
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">virtual_router_id 51
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 定义优先级，数字越大，优先级越高(0-255)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">priority 150
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 设定MASTER跟BACKUP之间同步检查的时间间隔，单位是秒。
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">advert_int 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 如果节点之间禁用了群发的話，则采用vrrp单发通告的方式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">unicast_src_ip 10.0.0.11
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">unicast_peer {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  10.0.0.12
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 设置验证类型与密码
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">authentication {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # 设置验证类型，主要有PASS跟HA两种
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  auth_type PASS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # 设置验证密码，在同一個vrrp_instance底下，MASTER跟BACKUP必须使用相同得密码才能正常沟通
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  auth_pass 1111
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 设置虚拟IP地址，可以设置多個虚拟IP地址，每行设定一个
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">virtual_ipaddress {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # 虚拟VIP的地址 与网卡标签
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  10.0.0.3/24 dev eth0 label eth0:1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">track_script {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # 触发检查
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  chk_nginx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>修改<!-- raw HTML omitted -->备用<!-- raw HTML omitted -->服务器<code>Keepalived</code>配置文件</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/keepalived/keepalived.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">! Configuration File for keepalived
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">global_defs {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 设置的邮件报警，这部分一般由nagios、zabbix监控软件来负责，这里的内容很鸡肋。
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">notification_email {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  31333741@qq.com
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">} 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">notification_email_from  31333741@qq.com
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">smtp_server 192.168.200.1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">smtp_connect_timeout 30
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 备节点id 不能和备节点重名
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">router_id LVS_lb02
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># VRRP实例
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">vrrp_instance VI_1 {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 设置主服务器
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">state MASTER
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 设置通信网卡  备节点设置一样
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">interface eth0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 同组路由器属性
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">virtual_router_id 51
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 优先级 这里必须比备节点高
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">priority 100
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 每隔一秒发一次心跳
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">advert_int 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 授权密码  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">authentication {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  auth_type PASS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  auth_pass 1111
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">virtual_ipaddress {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # 虚拟VIP的地址 与网卡标签
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  10.0.0.3/24 dev eth0 label eth0:1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->启动主节点<!-- raw HTML omitted --><code>keepalived</code><!-- raw HTML omitted -->服务并检查<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /etc/init.d/keepalived start
</span></span><span style="display:flex;"><span>正在启动 keepalived：            <span style="color:#f92672">[</span>确定<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@kepalived-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># ps -ef|grep keep|grep -v grep</span>
</span></span><span style="display:flex;"><span>root       <span style="color:#ae81ff">7428</span>      <span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">0</span> 10:54 ?        00:00:00 /usr/sbin/keepalived -D
</span></span><span style="display:flex;"><span>root       <span style="color:#ae81ff">7430</span>   <span style="color:#ae81ff">7428</span>  <span style="color:#ae81ff">0</span> 10:54 ?        00:00:00 /usr/sbin/keepalived -D
</span></span><span style="display:flex;"><span>root       <span style="color:#ae81ff">7431</span>   <span style="color:#ae81ff">7428</span>  <span style="color:#ae81ff">0</span> 10:54 ?        00:00:00 /usr/sbin/keepalived -D</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->检查配置后的虚拟<!-- raw HTML omitted --><code>IP</code></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->出现带有<!-- raw HTML omitted --><code>vip：10.0.0.3</code><!-- raw HTML omitted -->行的结果表示<!-- raw HTML omitted --><code>kepalived-01</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>keepalived</code><!-- raw HTML omitted -->服务单实例配置成功<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ip add|grep 10.0.0.3
</span></span><span style="display:flex;"><span>    inet 10.0.0.3/24 scope global secondary eth0:1</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->启动备节点<!-- raw HTML omitted --><code>keepalived</code><!-- raw HTML omitted -->服务<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->查看备用服务器是否有<!-- raw HTML omitted --><code>IP</code><!-- raw HTML omitted -->没有返回任何结果就对<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-02 ~<span style="color:#f92672">]</span><span style="color:#75715e"># /etc/init.d/keepalived start</span>
</span></span><span style="display:flex;"><span>正在启动 keepalived：  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-02 ~<span style="color:#f92672">]</span><span style="color:#75715e"># ip add|grep 10.0.0.3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-02 ~<span style="color:#f92672">]</span><span style="color:#75715e"># </span></span></span></code></pre></div></blockquote>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->单实例主备模式<!-- raw HTML omitted --><code>keepalived</code><!-- raw HTML omitted -->配置文件对比<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>主备单实例<code>keepalived.conf</code>配置差别项</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left"><code>Keepalived</code>配置参数</th>
<th style="text-align:left"><code>Master</code>节点特殊参数</th>
<th style="text-align:left"><code>Backup</code>节点特殊参数</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>Router_id</code> (唯一标识)</td>
<td style="text-align:left"><code>router_id lb01</code></td>
<td style="text-align:left"><code>router_id lb02</code></td>
</tr>
<tr>
<td style="text-align:left"><code>State</code>（角色状态）</td>
<td style="text-align:left"><code>Stat master</code></td>
<td style="text-align:left"><code>Stat backup</code></td>
</tr>
<tr>
<td style="text-align:left"><code>Priority</code> （竞选优先级）</td>
<td style="text-align:left"><code>Priority 150</code></td>
<td style="text-align:left"><code>Priority 100</code></td>
</tr>
</tbody>
</table>
</blockquote>
</blockquote>
<hr>
<h3 id="keepalived主备切换"><code>Keepalived</code>主备切换</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->停掉主服务上的<!-- raw HTML omitted --><code>keepalived</code><!-- raw HTML omitted -->服务或关闭主服务器，操作及检查步骤<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># ip add|grep 10.0.0.3</span>
</span></span><span style="display:flex;"><span>inet 10.0.0.3/24 scope global secondary eth0:1
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># /etc/init.d/keepalived stop</span>
</span></span><span style="display:flex;"><span>停止 keepalived：                                          <span style="color:#f92672">[</span>确定<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># ip add|grep 10.0.0.3  	# 查看vip消失</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-01 ~<span style="color:#f92672">]</span><span style="color:#75715e">#</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->可以看到主服务器<!-- raw HTML omitted --><code>vip10.00.3</code><!-- raw HTML omitted -->消失了，此时查看<!-- raw HTML omitted --><code>backup</code><!-- raw HTML omitted -->备份服务器，看是否会有<!-- raw HTML omitted --><code>vip10.0.0.3</code><!-- raw HTML omitted -->出现<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>可以看到备节点<code>keepalived-02</code>已经接管绑定了<code>10.0.0.3</code>这个<code>vip</code>，这期间备节点还会发送<code>ARP</code>广播，让所有的客户端更新本地的<code>ARP</code>表，以便客户端访问新接管<code>vip</code>服务节点。</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-02 ~<span style="color:#f92672">]</span><span style="color:#75715e"># ip add|grep 10.0.0.3        </span>
</span></span><span style="display:flex;"><span>    inet 10.0.0.3/24 scope global secondary eth0:1</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->此时如果在启动主服务器的<!-- raw HTML omitted --><code>keepalived</code>服务，主服务器就会接管回<code>vip 10.0.0.3</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># ip add|grep 10.0.0.3       </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># /etc/init.d/keepalived start</span>
</span></span><span style="display:flex;"><span>正在启动 keepalived：                                      <span style="color:#f92672">[</span>确定<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># ip add|grep 10.0.0.3        </span>
</span></span><span style="display:flex;"><span>inet 10.0.0.3/24 scope global secondary eth0:1</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->此时备节点上的<!-- raw HTML omitted --><code>vip 10.0.0.3</code><!-- raw HTML omitted -->则被释放了，如下<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-02 ~<span style="color:#f92672">]</span><span style="color:#75715e"># ip add|grep 10.0.0.3    </span></span></span></code></pre></div></blockquote>
<ul>
<li>这样就实现了单实例<code>keepalived</code><!-- raw HTML omitted -->服务<!-- raw HTML omitted --><code>IP</code><!-- raw HTML omitted -->自动漂移接管了，<!-- raw HTML omitted --><code>vip</code>漂移到了新机器新服务上，用户的访问请求自然就会找到新机器新服务了</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->注意：这里仅实现了<!-- raw HTML omitted --><code>VIP</code>自动漂移切换，因此仅适合两台服务器提供的服务均保持开启的应用场景，这也是工作中常用的高可用解决方案</li>
</ul>
</blockquote>
</blockquote>
<hr>
<h3 id="keepalived双主模式"><code>keepalived</code>双主模式</h3>
<blockquote>
<ul>
<li><code>keepalived</code><!-- raw HTML omitted -->双实例双主模式配置实战<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>Keepalived</code>还支持多实例多业务双向主备模式，即<code>A</code>业务在<code>keepalived-01</code>上主模式是主模式，在<code>keepalived-02</code>上是备模式，而<code>B</code>业务在<code>keepalived-02</code>上是备模式，在<code>keepalived-02</code>上是主模式.</li>
</ul>
</blockquote>
<ul>
<li><code>Keepalived</code><!-- raw HTML omitted -->双实例双主模式的<!-- raw HTML omitted --><code>ip</code><!-- raw HTML omitted -->及<!-- raw HTML omitted --><code>VIP</code><!-- raw HTML omitted -->规划<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th style="text-align:left"><code>Hostname</code></th>
<th style="text-align:left"><code>IP</code></th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>keepalived-01</code></td>
<td style="text-align:left">10.0.0.5</td>
<td style="text-align:left"><code>VIP：10.0.0.3</code>（用于绑定<code>A</code>服务www.etiantian.org）</td>
</tr>
<tr>
<td style="text-align:left"><code>keepalived-02</code></td>
<td style="text-align:left">10.0.0.4</td>
<td style="text-align:left"><code>VIP：10.0.0.4</code>（用于绑定<code>B</code>服务<code>blog.etiantian.org</code>）</td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->首先配置<!-- raw HTML omitted --><code>keepalived-01</code> <code>10.0.0.5</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>keepalived.conf</code><!-- raw HTML omitted -->，在单实例的基础上增加一个<!-- raw HTML omitted --><code>VIP_instance VI_2</code><!-- raw HTML omitted -->步骤及内容如下<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># cat &gt;/etc/keepalived/keepalived.conf&lt;&lt;-EOF</span>
</span></span><span style="display:flex;"><span>! Configuration File <span style="color:#66d9ef">for</span> keepalived
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>global_defs <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>	notification_email <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		31333741@qq.com
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	notification_email_from  31333741@qq.com
</span></span><span style="display:flex;"><span>	smtp_server 127.0.0.1
</span></span><span style="display:flex;"><span>	smtp_connect_timeout <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>	router_id lb01
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># vrrp_script chk_nginx {</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    script &#34;/root/chk_nginx.sh&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    interval 1</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    weight 1</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># }</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vrrp_instance VI_1 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>state MASTER
</span></span><span style="display:flex;"><span>interface eth0
</span></span><span style="display:flex;"><span>virtual_router_id <span style="color:#ae81ff">51</span>
</span></span><span style="display:flex;"><span>priority <span style="color:#ae81ff">150</span>
</span></span><span style="display:flex;"><span>advert_int <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>authentication <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  auth_type PASS
</span></span><span style="display:flex;"><span>  auth_pass <span style="color:#ae81ff">1111</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>virtual_ipaddress <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  10.0.0.3/24 dev eth0 label eth0:1  
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vrrp_instance VI_2 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>state BACKUP
</span></span><span style="display:flex;"><span>interface eth0
</span></span><span style="display:flex;"><span>virtual_router_id <span style="color:#ae81ff">52</span>
</span></span><span style="display:flex;"><span>priority <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>advert_int <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>authentication <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  auth_type PASS
</span></span><span style="display:flex;"><span>  auth_pass <span style="color:#ae81ff">1112</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>virtual_ipaddress <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  10.0.0.4/24 dev eth0 label eth0:2
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>EOF</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->提示：以<!-- raw HTML omitted --><code>vrrp_instance VI_1</code><!-- raw HTML omitted -->在<!-- raw HTML omitted --><code>keepalived-01 10.0.0.5</code><!-- raw HTML omitted -->服务器上的角色为主，<!-- raw HTML omitted --><code>vrrp_instance VI_2</code><!-- raw HTML omitted -->在<!-- raw HTML omitted --><code>keepalived-01 10.0.0.5</code><!-- raw HTML omitted -->服务器上的角色为备 然后布置<!-- raw HTML omitted --><code>keepalived-02 10.0.0.6</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>keepalived.conf</code><!-- raw HTML omitted -->，在单实例的基础上增加<!-- raw HTML omitted --><code>vrrp_instance VI_2</code><!-- raw HTML omitted -->实例，步骤如下<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-02 ~<span style="color:#f92672">]</span><span style="color:#75715e"># cat &gt;/etc/keepalived/keepalived.conf&lt;&lt;-EOF</span>
</span></span><span style="display:flex;"><span>! Configuration File <span style="color:#66d9ef">for</span> keepalived
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>global_defs <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span> notification_email <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>     31333741@qq.com
</span></span><span style="display:flex;"><span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span> notification_email_from  31333741@qq.com
</span></span><span style="display:flex;"><span> smtp_server 127.0.0.1
</span></span><span style="display:flex;"><span> smtp_connect_timeout <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span> router_id lb02
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vrrp_instance VI_1 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>state BACKUP
</span></span><span style="display:flex;"><span>interface eth0
</span></span><span style="display:flex;"><span>virtual_router_id <span style="color:#ae81ff">51</span>
</span></span><span style="display:flex;"><span>priority <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>advert_int <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>authentication <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  auth_type PASS
</span></span><span style="display:flex;"><span>  auth_pass <span style="color:#ae81ff">1111</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>virtual_ipaddress <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>10.0.0.3/24 dev eth0 label eth0:1  
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vrrp_instance VI_2 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>state MASTER
</span></span><span style="display:flex;"><span>interface eth0
</span></span><span style="display:flex;"><span>virtual_router_id <span style="color:#ae81ff">52</span>
</span></span><span style="display:flex;"><span>priority <span style="color:#ae81ff">150</span>
</span></span><span style="display:flex;"><span>advert_int <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>authentication <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  auth_type PASS
</span></span><span style="display:flex;"><span>  auth_pass <span style="color:#ae81ff">1112</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>virtual_ipaddress <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>10.0.0.4/24 dev eth0 label eth0:2
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>EOF</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->提示：以<!-- raw HTML omitted --><code>vrrp_instance VI_1</code>在<code>keepalived-02 10.0.0.6</code><!-- raw HTML omitted -->服务器上的角色为备，<!-- raw HTML omitted --><code>vrrp_instance VI_2</code>在<code>keepalived-02 10.0.0.6</code><!-- raw HTML omitted -->服务器上的角色为主 接着在<!-- raw HTML omitted --><code>keepalived-01</code>、<code>keepalived-02</code><!-- raw HTML omitted -->上分别重启<!-- raw HTML omitted --><code>keepalived</code><!-- raw HTML omitted -->服务，观察初始<!-- raw HTML omitted --><code>VIP</code><!-- raw HTML omitted -->设置情况<!-- raw HTML omitted --><code> Lb01</code><!-- raw HTML omitted -->操作情况如下<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># /etc/init.d/keepalived restart</span>
</span></span><span style="display:flex;"><span>停止 keepalived：                                        <span style="color:#f92672">[</span>确定<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>正在启动 keepalived：                                    <span style="color:#f92672">[</span>确定<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># ip add|grep -E &#34;10.0.0.3|0.4&#34;</span>
</span></span><span style="display:flex;"><span>inet 10.0.0.3/24 scope global secondary eth0:1
</span></span><span style="display:flex;"><span>inet 10.0.0.4/24 scope global secondary eth0:2</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->提示：启动<!-- raw HTML omitted --><code>keepalived-02</code><!-- raw HTML omitted -->后，初始状态已经启动了<!-- raw HTML omitted --><code>10.0.0.4VIP</code>，即<code>keepalived-02</code>由<code>VI_2</code><!-- raw HTML omitted -->实例配置的<!-- raw HTML omitted --><code>VIP</code><!-- raw HTML omitted -->对外提供服务，列入可以把<!-- raw HTML omitted --><code>blog.etiantian.org</code><!-- raw HTML omitted -->解析到<!-- raw HTML omitted --><code>10.0.0.4</code><!-- raw HTML omitted -->上 下面停掉任意一端服务器或者<!-- raw HTML omitted --><code>keepalived</code><!-- raw HTML omitted -->服务，然后查看<!-- raw HTML omitted --><code>vip</code><!-- raw HTML omitted -->是不是会漂移到另一端。停掉<!-- raw HTML omitted --><code>keepalived-01</code>的<code>keepalived</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># /etc/init.d/keepalived stop</span>
</span></span><span style="display:flex;"><span>停止 keepalived：                                        <span style="color:#f92672">[</span>确定<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># ip add|grep -E &#34;10.0.0.3|0.4&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># # 此处无任何信息</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->停掉<!-- raw HTML omitted --><code>keepalived-01</code><!-- raw HTML omitted -->后，<!-- raw HTML omitted --><code>vip 10.0.0.3</code><!-- raw HTML omitted -->即被释放,检查<!-- raw HTML omitted --><code>keepalived-02</code>服务器上<code>vip</code><!-- raw HTML omitted -->的接管情况<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>keepalived-02</code>已将接管了<code>keepalived-01</code>的<code>vip 10.0.0.3</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-02 ~<span style="color:#f92672">]</span><span style="color:#75715e"># ip add|grep -E &#34;10.0.0.3|0.4&#34;</span>
</span></span><span style="display:flex;"><span>    inet 10.0.0.4/24 scope global secondary eth0:2
</span></span><span style="display:flex;"><span>    inet 10.0.0.3/24 scope global secondary eth0:1</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="问题排查">问题排查</h3>
<h4 id="裂脑问题">裂脑问题</h4>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->什么是裂脑<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>由于某些原因，导致两台高可用服务器对在指定时间内无法检测到对方的心跳消息。各自取得资源及服务的所有权，而此时的两台高可用服务器对都还活着并在正常运行着，这样就会导致同一个<code>ip</code>或服务在两端同时存在而发生冲突，最严重的是两台主机占用一个VIP地址，当用户写入数据时可能会分别写入到两端，这可能会导致服务器两端数据不一致或造成数据丢失，这种情况称为脑裂</li>
</ul>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->导致脑裂发生的原因<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>一般来说脑裂的发生，有以下几种原因： 高可用服务器之间心跳线路发生故障，导致无法正常通信</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->心跳线坏了(包括断了，老化)<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->网卡及相关驱动坏了，<!-- raw HTML omitted --><code>IP</code><!-- raw HTML omitted -->配置及冲突<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->心跳线连接的设备故障（网卡及交换机）<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->仲裁的机器出问题<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li>高可用服务器上开启了<code>iptableable</code>防火墙阻挡了心跳消息传输</li>
<li>高可用服务器上心跳网卡地址等信息配置不正确，导致发送心跳失败</li>
<li>其他服务器配置不当等原因，心跳广播冲突。软件<code>BUG</code>等</li>
</ul>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->提示：<!-- raw HTML omitted --><code>keepalived</code><!-- raw HTML omitted -->配置里同一<!-- raw HTML omitted --><code>VRRP</code><!-- raw HTML omitted -->实例如果<!-- raw HTML omitted --><code>virtual_router_id</code><!-- raw HTML omitted -->两端参数配置不一致，也会导致脑裂问题发生<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<hr>
<h5 id="脑裂排查">脑裂排查</h5>
<blockquote>
<ul>
<li>出现上述无任何结果的现象，表示<code>keepalived-02</code>的<code>keepalived</code>服务单实例配置成功。如果<code>keepalived-02</code>配置过滤后出现<code>10.0.0.3</code>的<code>ip</code>。则表示<code>keepalived</code>工作不正常，同一个<code>IP</code>地址同一时刻应该只能出现一台服务器。</li>
<li>如果查看<code>backup</code>备节点<code>vip</code>有如下信息，说明<!-- raw HTML omitted -->高可用<!-- raw HTML omitted -->脑裂了，裂脑是两台服务器争抢同一资源导致的，例如:两边都配置了同一个<code>ip</code>，一般要先考虑排查两个地方</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->主备两台服务器之间是否通信正常，如果不正常是否有<!-- raw HTML omitted --><code>iptables</code><!-- raw HTML omitted -->防火墙阻挡<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->主备两台服务器对应的<!-- raw HTML omitted --><code>keepalived.conf</code><!-- raw HTML omitted -->配置文件是否有错误？例如：是否同一实例的<!-- raw HTML omitted --><code>virtual_router_id</code><!-- raw HTML omitted -->配置不一致<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-02 ~<span style="color:#f92672">]</span><span style="color:#75715e"># ip add|grep 10.0.0.3</span>
</span></span><span style="display:flex;"><span>  inet 10.0.0.3/24 scope global secondary eth0:1</span></span></code></pre></div></blockquote>
</blockquote>
</blockquote>
<hr>
<h5 id="脑裂解决常见方案">脑裂解决常见方案</h5>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->同时使用串行电缆和以太网电缆连接，同时用两条心跳线路，这样一条线路坏了，另一条线路还是好的，依然能够传送心跳信息<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->当检测到脑裂时强行关闭一个心跳节点（这个功能需要特殊设备支持，如<!-- raw HTML omitted --><code>Stonith、fence）</code><!-- raw HTML omitted -->。相当于节点信息接收不到心跳信息，通过单独的线路发送机关命令关闭主节点电源<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->做好裂脑的监控警报<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<hr>
<h5 id="编写监控keepalived脑裂脚本">编写监控<code>Keepalived</code>脑裂脚本</h5>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->检测思路：<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>在备节点上执行脚本，如果可以<code>ping</code>通主节点并且备节点有<code>VIP</code>就报警</li>
<li>让人员介入检查是否裂脑。</li>
<li>在<code>keepalived-02</code>备节点开发脚本并执行</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-02 ~<span style="color:#f92672">]</span><span style="color:#75715e"># cat &gt;check_split_brain.sh&lt;&lt;-EOF </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#!/bin/sh</span>
</span></span><span style="display:flex;"><span>keepalived-01_vip<span style="color:#f92672">=</span>10.0.0.12
</span></span><span style="display:flex;"><span>keepalived-01_ip<span style="color:#f92672">=</span>10.0.0.7
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> true
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span> ping -c <span style="color:#ae81ff">2</span> -W <span style="color:#ae81ff">3</span> <span style="color:#e6db74">${</span><span style="color:#e6db74">&#34;keepalived-01_ip&#34;</span><span style="color:#e6db74">}</span> &amp;&gt;/dev/null 
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $ -eq <span style="color:#ae81ff">0</span> -a <span style="color:#e6db74">`</span>ip add|grep <span style="color:#e6db74">${</span><span style="color:#e6db74">&#34;keepalived-01_vip&#34;</span><span style="color:#e6db74">}</span>|wc -l<span style="color:#e6db74">`</span> -eq <span style="color:#ae81ff">1</span> <span style="color:#f92672">]</span>  
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">then</span>    
</span></span><span style="display:flex;"><span>     echo <span style="color:#e6db74">&#34;ha is split brain.warning.&#34;</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">else</span>    
</span></span><span style="display:flex;"><span>     echo <span style="color:#e6db74">&#34;ha is ok&#34;</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span> sleep <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-02 ~<span style="color:#f92672">]</span><span style="color:#75715e"># sh check_split_brain.sh  </span>
</span></span><span style="display:flex;"><span>ha is okha is ok</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->正常情况下主节点活着，<!-- raw HTML omitted --><code>VIP 10.0.0.12</code><!-- raw HTML omitted -->在主节点，因此不会报警提示<!-- raw HTML omitted --><code>ha is ok</code>。 <code>keepalived-01</code> 停止<code>Keepalived</code><!-- raw HTML omitted -->服务看<!-- raw HTML omitted --><code>keepalived-02</code><!-- raw HTML omitted -->脚本执行情况<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># /etc/init.d/keepalived stop</span>
</span></span><span style="display:flex;"><span>停止 keepalived：                                          <span style="color:#f92672">[</span>确定<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># ip add|grep 10.0.0.12 </span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->在<!-- raw HTML omitted --><code>keepalived-02</code><!-- raw HTML omitted -->上观察即可，此前脚本已经执行<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-02 ~<span style="color:#f92672">]</span><span style="color:#75715e"># sh check_split_brain.sh</span>
</span></span><span style="display:flex;"><span>ha is okha is ok
</span></span><span style="display:flex;"><span>ha is split brain.warning.
</span></span><span style="display:flex;"><span>ha is split brain.warning.
</span></span><span style="display:flex;"><span>ha is split brain.warning.</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->关掉<!-- raw HTML omitted --><code>keepalived-01</code><!-- raw HTML omitted -->服务器，然后再观察<!-- raw HTML omitted --><code>keepalived-02</code><!-- raw HTML omitted -->脚本的输出<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@@keepalived-02 ~<span style="color:#f92672">]</span><span style="color:#75715e"># sh check_split_brain.sh </span>
</span></span><span style="display:flex;"><span>ha is okha is ok
</span></span><span style="display:flex;"><span>ha is split brain.warning.
</span></span><span style="display:flex;"><span>ha is split brain.warning.
</span></span><span style="display:flex;"><span>ha is split brain.warning.
</span></span><span style="display:flex;"><span>ha is ok
</span></span><span style="display:flex;"><span>ha is ok
</span></span><span style="display:flex;"><span>ha is ok</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h4 id="nginx配置负载"><code>nginx</code>配置负载</h4>
<blockquote>
<ul>
<li>结合<code>nginx</code>负载均衡的环境，两边<code>keepalived-01</code>和<code>keepalived-02</code>的配置环境一样 <strong>这里使用<code>nginx</code>负载均衡的配置如下：</strong></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@@keepalived-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># cat &gt;/usr/local/nginx/conf/nginx.conf&lt;&lt;-EOF</span>
</span></span><span style="display:flex;"><span>worker_processes  1;
</span></span><span style="display:flex;"><span>events <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>worker_connections  1024;
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>http <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>include       mime.types;
</span></span><span style="display:flex;"><span>default_type  application/octet-stream;
</span></span><span style="display:flex;"><span>sendfile        on;
</span></span><span style="display:flex;"><span>keepalive_timeout  65;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>upstream server_pools <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>   server 10.0.0.7:80  weight<span style="color:#f92672">=</span>1;
</span></span><span style="display:flex;"><span>   server 10.0.0.8:80  weight<span style="color:#f92672">=</span>1;
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>server <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  listen       10.0.0.3:80;
</span></span><span style="display:flex;"><span>  server_name  www.etiantian.org;
</span></span><span style="display:flex;"><span>  location / <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      proxy_pass http://server_pools;
</span></span><span style="display:flex;"><span>  include proxy.conf;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>server <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  listen       10.0.0.3:80;
</span></span><span style="display:flex;"><span>  server_name  bbs.etiantian.org;
</span></span><span style="display:flex;"><span>  location / <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      proxy_pass http://server_pools;
</span></span><span style="display:flex;"><span>   include proxy.conf;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>server <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  listen       10.0.0.4:80;
</span></span><span style="display:flex;"><span>  server_name  blog.etiantian.org;
</span></span><span style="display:flex;"><span>  location / <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      proxy_pass http://server_pools;
</span></span><span style="display:flex;"><span>     include proxy.conf;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>EOF</span></span></code></pre></div></blockquote>
<ul>
<li><code>keepalived-01</code><!-- raw HTML omitted -->上配置<!-- raw HTML omitted --><code>keepalived.conf</code><!-- raw HTML omitted -->配置文件<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># cat &gt;/etc/keepalived/keepalived.conf&lt;&lt;-EOF</span>
</span></span><span style="display:flex;"><span>! Configuration File <span style="color:#66d9ef">for</span> keepalived
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>global_defs <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>notification_email <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>31333741@qq.com
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>notification_email_from  31333741@qq.com
</span></span><span style="display:flex;"><span>smtp_server 127.0.0.1
</span></span><span style="display:flex;"><span>smtp_connect_timeout <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>router_id lb01
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vrrp_instance VI_1 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>state MASTER
</span></span><span style="display:flex;"><span>interface eth0
</span></span><span style="display:flex;"><span>virtual_router_id <span style="color:#ae81ff">51</span>
</span></span><span style="display:flex;"><span>priority <span style="color:#ae81ff">150</span>
</span></span><span style="display:flex;"><span>advert_int <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>authentication <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  auth_type PASS
</span></span><span style="display:flex;"><span>  auth_pass <span style="color:#ae81ff">1111</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>virtual_ipaddress <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>10.0.0.3/24 dev eth0 label eth0:1  
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vrrp_instance VI_2 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>state BACKUP
</span></span><span style="display:flex;"><span>interface eth0
</span></span><span style="display:flex;"><span>virtual_router_id <span style="color:#ae81ff">52</span>
</span></span><span style="display:flex;"><span>priority <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>advert_int <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>authentication <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  auth_type PASS
</span></span><span style="display:flex;"><span>  auth_pass <span style="color:#ae81ff">1112</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>virtual_ipaddress <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>10.0.0.4/24 dev eth0 label eth0:2
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>EOF</span></span></code></pre></div></blockquote>
<ul>
<li><code>keepalived-02</code><!-- raw HTML omitted -->上配置<!-- raw HTML omitted --><code>keepalived.conf</code><!-- raw HTML omitted -->配置文件<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-02 ~<span style="color:#f92672">]</span><span style="color:#75715e"># cat &gt;/etc/keepalived/keepalived.conf&lt;&lt;-EOF</span>
</span></span><span style="display:flex;"><span>! Configuration File <span style="color:#66d9ef">for</span> keepalived
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>global_defs <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>notification_email <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>31333741@qq.com
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>notification_email_from  31333741@qq.com
</span></span><span style="display:flex;"><span>smtp_server 127.0.0.1
</span></span><span style="display:flex;"><span>smtp_connect_timeout <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>router_id lb02
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vrrp_instance VI_1 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>state BACKUP
</span></span><span style="display:flex;"><span>interface eth0
</span></span><span style="display:flex;"><span>virtual_router_id <span style="color:#ae81ff">51</span>
</span></span><span style="display:flex;"><span>priority <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>advert_int <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>authentication <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  auth_type PASS
</span></span><span style="display:flex;"><span>  auth_pass <span style="color:#ae81ff">1111</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>virtual_ipaddress <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>10.0.0.3/24 dev eth0 label eth0:1  
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vrrp_instance VI_2 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>state MASTER
</span></span><span style="display:flex;"><span>interface eth0
</span></span><span style="display:flex;"><span>virtual_router_id <span style="color:#ae81ff">52</span>
</span></span><span style="display:flex;"><span>priority <span style="color:#ae81ff">150</span>
</span></span><span style="display:flex;"><span>advert_int <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>authentication <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  auth_type PASS
</span></span><span style="display:flex;"><span>  auth_pass <span style="color:#ae81ff">1112</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>virtual_ipaddress <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>10.0.0.4/24 dev eth0 label eth0:2
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>EOF</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h4 id="解决监听的服务网卡上不存在ip地址问题">解决监听的服务网卡上不存在<code>IP</code>地址问题</h4>
<blockquote>
<ul>
<li>如果配置使用<code>listen 10.0.0.3:80</code> 的方式指定<code>IP</code>监听服务，而本地的网卡上没有<code>10.0.0.3</code>这个<code>IP，nginx</code>就会报错，如：出现上述的原因是在物理网卡上没有配置与文件里监听的<code>IP</code>相对应的<code>IP</code>，解决办法是在<code>/etc/sysctl.conf</code>中加入如下参数：</li>
<li>此项表示启动<code>nginx</code>而忽视配置中监听的VIP是否存在，它同样适合<code>Haproxy</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-02 ~<span style="color:#f92672">]</span><span style="color:#75715e"># echo &#34;net.ipv4.ip_nonlocal_bind = 1&#34; &gt;&gt;/etc/sysctl.conf</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-02 ~<span style="color:#f92672">]</span><span style="color:#75715e"># sysctl -p</span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h4 id="解决高可用服务只针对物理服务器的问题">解决高可用服务只针对物理服务器的问题</h4>
<blockquote>
<ul>
<li>默认情况下<code>keepalived</code>软件仅仅在对方机器宕机或<code>keepalived</code>停掉的时候才会接管业务，但在实际过程中，有业务服务停止而<code>keepalived</code>服务还在工作的情况，这就会导致用户访问<code>VIP</code>无法找到对应的服务</li>
<li><!-- raw HTML omitted -->方法一：<!-- raw HTML omitted -->可以写守护进程脚本来处理。当<code>nginx</code>业务有问题时，就停掉本地的<code>keepalived</code>服务，实现<code>IP</code>漂移到对端继续提供服务。实际工作中部署及开发的示例脚本</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->此脚本的思路是如没有<!-- raw HTML omitted --><code>80</code><!-- raw HTML omitted -->端口存在，就停掉<!-- raw HTML omitted --><code>keepalived</code><!-- raw HTML omitted -->服务实现释放本地的<!-- raw HTML omitted --><code>VIP</code><!-- raw HTML omitted -->在后台执行上述脚本<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># cat &gt;/server/scripts/check_nginx.sh&lt;&lt;-EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#!/bin/sh</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> true
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">`</span>netstat -lntup|grep nginx|wc -l<span style="color:#e6db74">`</span> -eq <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>;<span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    /etc/init.d/keepalived stop
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>  sleep <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>$ sh server/scripts/check_nginx.sh &amp;
</span></span><span style="display:flex;"><span>$ ps -ef|grep check|grep -v grep
</span></span><span style="display:flex;"><span>root       <span style="color:#ae81ff">8580</span>   <span style="color:#ae81ff">8394</span>  <span style="color:#ae81ff">0</span> 16:19 pts/0    00:00:00 sh check_nginx.s</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->确定<!-- raw HTML omitted --><code>nginx</code><!-- raw HTML omitted -->以及<!-- raw HTML omitted --><code>keepalived</code><!-- raw HTML omitted -->服务是否正常<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># netstat -lntup|grep nginx</span>
</span></span><span style="display:flex;"><span>tcp        <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> 10.0.0.4:80                 0.0.0.0:*                   LISTEN      8541/nginx          
</span></span><span style="display:flex;"><span>tcp        <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> 10.0.0.3:80                 0.0.0.0:*                   LISTEN      8541/nginx          
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># /etc/init.d/keepalived status</span>
</span></span><span style="display:flex;"><span>keepalived <span style="color:#f92672">(</span>pid  8438<span style="color:#f92672">)</span> 正在运行...</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->然后模拟<!-- raw HTML omitted --><code>nginx</code><!-- raw HTML omitted -->服务挂掉，看<!-- raw HTML omitted --><code>IP</code><!-- raw HTML omitted -->是否会发生切换<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># /usr/local/nginx/sbin/nginx -s stop</span>
</span></span><span style="display:flex;"><span> 停止 keepalived：       <span style="color:#f92672">[</span>确定<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@@keepalived-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># /etc/init.d/keepalived status</span>
</span></span><span style="display:flex;"><span>keepalived       已停
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># netstat -lntup|grep nginx            </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-01 ~<span style="color:#f92672">]</span><span style="color:#75715e">#</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->此时备节点接管<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-02 ~<span style="color:#f92672">]</span><span style="color:#75715e"># ip add|grep -E &#34;10.0.0.3|0.4&#34;</span>
</span></span><span style="display:flex;"><span>    inet 10.0.0.3/24 scope global secondary eth0:1
</span></span><span style="display:flex;"><span>    inet 10.0.0.4/24 scope global secondary eth0:2</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->方法二：<!-- raw HTML omitted -->可以使用<code>keepalived</code>的配置脚本参数触发写好的监测服务脚本 首先要开发监测服务脚本，注意:这个脚本与上一个的不同</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># cat &gt;/server/scripts/chk_nginx_proxy.sh&lt;&lt;-EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#!/bin/sh</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">`</span>netstat -lntup|grep nginx|wc -l<span style="color:#e6db74">`</span> -eq <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>;<span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>/etc/init.d/keepalived stop
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># chmod +x /server/scripts/chk_nginx_proxy.sh </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># ll /server/scripts/chk_nginx_proxy.sh </span>
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">99</span> 6月  <span style="color:#ae81ff">10</span> 16:30 chk_nginx_proxy.sh
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-01 ~<span style="color:#f92672">]</span><span style="color:#75715e">#</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->此时<!-- raw HTML omitted --><code>keepalived</code><!-- raw HTML omitted -->服务的完整配置为<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># cat &gt;/etc/keepalived/keepalived.conf&lt;&lt;-EOF</span>
</span></span><span style="display:flex;"><span>! Configuration File <span style="color:#66d9ef">for</span> keepalived
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>global_defs <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>   notification_email <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>   31333741@qq.com
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>   notification_email_from  31333741@qq.com
</span></span><span style="display:flex;"><span>   smtp_server 127.0.0.1
</span></span><span style="display:flex;"><span>   smtp_connect_timeout <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>   router_id lb01
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>vrrp_script chk_nginx_proxy <span style="color:#f92672">{</span>  	<span style="color:#75715e"># 定义vrrp脚本，检测HTTP端口。</span>
</span></span><span style="display:flex;"><span>script <span style="color:#e6db74">&#34;/server/scripts/chk_nginx_proxy.sh&#34;</span>  	<span style="color:#75715e"># 执行脚本，当nginx服务有问题，就停掉keepalived服务。</span>
</span></span><span style="display:flex;"><span>interval <span style="color:#ae81ff">2</span>  	<span style="color:#75715e"># 间隔2秒</span>
</span></span><span style="display:flex;"><span>weight <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vrrp_instance VI_1 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    state MASTER
</span></span><span style="display:flex;"><span>    interface eth0
</span></span><span style="display:flex;"><span>    virtual_router_id <span style="color:#ae81ff">51</span>
</span></span><span style="display:flex;"><span>    priority <span style="color:#ae81ff">150</span>
</span></span><span style="display:flex;"><span>    advert_int <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    authentication <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        auth_type PASS
</span></span><span style="display:flex;"><span>        auth_pass <span style="color:#ae81ff">1111</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    virtual_ipaddress <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>     10.0.0.3/24 dev eth0 label eth0:1  
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>     track_script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    chk_nginx_proxy        <span style="color:#75715e">#触发检查</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vrrp_instance VI_2 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    state BACKUP
</span></span><span style="display:flex;"><span>    interface eth0
</span></span><span style="display:flex;"><span>    virtual_router_id <span style="color:#ae81ff">52</span>
</span></span><span style="display:flex;"><span>    priority <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>    advert_int <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    authentication <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        auth_type PASS
</span></span><span style="display:flex;"><span>        auth_pass <span style="color:#ae81ff">1112</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    virtual_ipaddress <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>     10.0.0.4/24 dev eth0 label eth0:2
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>EOF</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->注意：<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>vrrp_script chk_nginx_proxy <span style="color:#f92672">{</span>  <span style="color:#75715e"># &lt;==定义vrrp脚本，检测HTTP端口。</span>
</span></span><span style="display:flex;"><span>script <span style="color:#e6db74">&#34;/server/scripts/chk_nginx_proxy.sh&#34;</span>  <span style="color:#75715e"># &lt;==执行脚本，当nginx服务有问题，就停掉keepalived服务。</span>
</span></span><span style="display:flex;"><span>interval <span style="color:#ae81ff">2</span> <span style="color:#75715e"># &lt;==间隔2秒</span>
</span></span><span style="display:flex;"><span>weight <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h4 id="解决多组keepalived服务器在一个局域网的冲突问题">解决多组<code>keepalived</code>服务器在一个局域网的冲突问题</h4>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->可以在同组的<!-- raw HTML omitted --><code>keepalived</code><!-- raw HTML omitted -->服务器所有配置文件里指定独一无二的多播地址<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->不同实例的认证密码最好不同<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>global_defs <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>router_id LVS_19
</span></span><span style="display:flex;"><span>vrrp_mcast_group4 224.0.0.19 <span style="color:#75715e"># &lt;==这个就是指定多播地址的配置</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="配置指定文件接收keepalived服务日记">配置指定文件接收<code>keepalived</code>服务日记</h3>
<blockquote>
<ul>
<li>默认情况下<code>keepalived</code>服务日记会输出到系统日记<code>/var/log/messages</code>和其他日记信息会混合在一起，很不方便，可以将其调整为由独立的文件记录<code>keepalived</code>服务日记;操作步骤如下</li>
<li>编辑配置文件<code>/etc/sysconfig/keepalived</code>，将第14行的<code>KEEPALIVED_OPTIONS=&quot;-D&quot;</code>修改为<code>KEEPALIVED_OPTIONS=&quot;-D -d -S 0&quot;</code>快速修改方法：</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># sed -i &#39;14 s#KEEPALIVED_OPTIONS=&#34;-D&#34;#KEEPALIVED_OPTIONS=&#34;-D -d -S 0&#34;#g&#39; /etc/sysconfig/keepalived </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># sed -n &#39;14p&#39;  /etc/sysconfig/keepalived</span>
</span></span><span style="display:flex;"><span>KEEPALIVED_OPTIONS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-D -d -S 0&#34;</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->说明：可以查看<!-- raw HTML omitted --><code>/etc/sysconfig/keepalived</code><!-- raw HTML omitted -->里注释获得上述参数的说明<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># --dump-conf       -d     导出备份配置数据</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --log-detail      -D     详细日志</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --log-facility    -S     设置本地的syslog设备，编号0-7（default=LOG_DAEMON）</span>
</span></span><span style="display:flex;"><span>* -S <span style="color:#ae81ff">0</span> 表示指定为local0设备</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>rsyslog</code><!-- raw HTML omitted -->的配置文件<!-- raw HTML omitted --><code>vim /etc/rsyslog.conf</code><!-- raw HTML omitted -->，在结尾处加入如下2行内容：<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>配置表示来自<code>local0设</code>备的所有日志信息都记录到<code>/var/log/keepalived.log</code>文件。 然后在约第42行如下信息的第一列结尾加入<code>“；local0.none”：</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># keepalived</span>
</span></span><span style="display:flex;"><span>local0.*  /var/log/keepalived.log
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 配置表示来自local0设备的所有日志信息不再记录于/var/log/messages里。 3 配置完成后，重启rsyslog服务。</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># sed -i &#39;42 s#*.info;mail.none;authpriv.none;cron.none#*.info;mail.none;authpriv.none;cron.none;local0.none#g&#39; /etc/rsyslog.conf </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># sed -n &#39;42p&#39; /etc/rsyslog.conf </span>
</span></span><span style="display:flex;"><span>*.info;mail.none;authpriv.none;cron.none;local0.none                /var/log/messages
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@keepalived-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># /etc/init.d/rsyslog restart</span>
</span></span><span style="display:flex;"><span>关闭系统日志记录器：     <span style="color:#f92672">[</span>确定<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>启动系统日志记录器：            <span style="color:#f92672">[</span>确定<span style="color:#f92672">]</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->测试<!-- raw HTML omitted --><code>Keepalived</code><!-- raw HTML omitted -->日志记录结果。在重启<!-- raw HTML omitted --><code>Keepalived</code><!-- raw HTML omitted -->服务后，就会把日志信息输出到<!-- raw HTML omitted --><code>rsyslog</code><!-- raw HTML omitted -->定义的<!-- raw HTML omitted --><code>/var/log/ keepalived.log</code><!-- raw HTML omitted -->文件<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>如果要求更高，还可以在<code>/var/log/messages</code>上设置对<code>/var/log/keepalived.log</code>进行轮询，以防单个日志文件变得太大</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>Jun <span style="color:#ae81ff">10</span> 22:38:03 lb01 Keepalived<span style="color:#f92672">[</span>10852<span style="color:#f92672">]</span>: Stopping Keepalived v1.2.13 <span style="color:#f92672">(</span>03/19,2015<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Jun <span style="color:#ae81ff">10</span> 22:38:03 lb01 Keepalived_vrrp<span style="color:#f92672">[</span>10855<span style="color:#f92672">]</span>: VRRP_Instance<span style="color:#f92672">(</span>VI_1<span style="color:#f92672">)</span> sending <span style="color:#ae81ff">0</span> priority
</span></span><span style="display:flex;"><span>Jun <span style="color:#ae81ff">10</span> 22:38:03 lb01 Keepalived_vrrp<span style="color:#f92672">[</span>10855<span style="color:#f92672">]</span>: VRRP_Instance<span style="color:#f92672">(</span>VI_1<span style="color:#f92672">)</span> removing protocol VIPs.
</span></span><span style="display:flex;"><span>Jun <span style="color:#ae81ff">10</span> 22:38:03 lb01 Keepalived_vrrp<span style="color:#f92672">[</span>10855<span style="color:#f92672">]</span>: VRRP_Instance<span style="color:#f92672">(</span>VI_2<span style="color:#f92672">)</span> sending <span style="color:#ae81ff">0</span> priority
</span></span><span style="display:flex;"><span>Jun <span style="color:#ae81ff">10</span> 22:38:03 lb01 Keepalived_vrrp<span style="color:#f92672">[</span>10855<span style="color:#f92672">]</span>: VRRP_Instance<span style="color:#f92672">(</span>VI_2<span style="color:#f92672">)</span> removing protocol VIPs.
</span></span><span style="display:flex;"><span>Jun <span style="color:#ae81ff">10</span> 22:38:03 lb01 Keepalived_healthcheckers<span style="color:#f92672">[</span>10854<span style="color:#f92672">]</span>: Netlink reflector reports IP 10.0.0.3 removed
</span></span><span style="display:flex;"><span>Jun <span style="color:#ae81ff">10</span> 22:38:03 lb01 Keepalived_healthcheckers<span style="color:#f92672">[</span>10854<span style="color:#f92672">]</span>: Netlink reflector reports IP 10.0.0.4 removed
</span></span><span style="display:flex;"><span>Jun <span style="color:#ae81ff">10</span> 22:38:03 lb01 Keepalived<span style="color:#f92672">[</span>10884<span style="color:#f92672">]</span>: Starting Keepalived v1.2.13 <span style="color:#f92672">(</span>03/19,2015<span style="color:#f92672">)</span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          </section>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="kubernetes">Kubernetes</h1>


            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Kubernetes</h1>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="kubernetes_template">Kubernetes_Template</h1>

<h1 id="资源控制器">资源控制器</h1>
<blockquote>

<pre class="mermaid align-center zoomable">graph LR
A[思维导图] --&gt;B[1.前言]
A[思维导图] --&gt;C[2.Namespace]
A[思维导图] --&gt;D[3.Deployment]
A[思维导图] --&gt;E[4.StatefulSet]
A[思维导图] --&gt;F[5.DaemonSet]
A[思维导图] --&gt;G[6.HorizontalPodAutoscaler]
A[思维导图] --&gt;H[7.EndPoint]
A[思维导图] --&gt;I[8.Service]
A[思维导图] --&gt;J[9.Label标签/Selector选择器]
C[2.Namespace] --&gt;|a=1|C1[2.1概述]
C[2.Namespace] --&gt;|a=2|C2[2.2应用示例]
D[3.Deployment] --&gt;|a=1|D1[3.1概述]
D[3.Deployment] --&gt;|a=2|D2[3.2语法以及应用示例]
E[4.StatefulSet] --&gt;|a=1|E1[4.1概述]
E[4.StatefulSet] --&gt;|a=2|E2[4.2语法以及应用示例]
F[5.DaemonSet] --&gt;|a=1|F1[5.1概述]
F[5.DaemonSet] --&gt;|a=2|F2[5.2语法以及应用示例]
G[6.HorizontalPodAutoscaler] --&gt;|a=1|G1[6.1概述]
G[6.HorizontalPodAutoscaler] --&gt;|a=2|G2[6.2语法以及应用]
H[7.EndPoint] --&gt;|a=1|H1[7.1概述]
H[7.EndPoint] --&gt;|a=2|H2[7.2语法以及应用]
I[8.Service] --&gt;|a=1|I1[8.1概述]
I[8.Service] --&gt;|a=2|I2[8.2语法以及应用]
J[9.Label标签/Selector选择器] --&gt;|a=1|J1[9.1概述]
J[9.Label标签/Selector选择器] --&gt;|a=2|J2[9.2语法以及应用]

Z[横向流程图]</pre>
<pre class="mermaid align-center zoomable">graph TD
A[Deployment] --&gt; D[ReplicaSet]
B[CronJob] --&gt; E[Job]
C[DaemonSet] --&gt; G{{容器}}
D[ReplicaSet] --&gt; G{{容器}}
E[Job] --&gt; G{{容器}}
F[StatefulSet] --&gt; G{{容器}}

G{{容器}} --&gt; J[/Volume\]
G{{容器}} --&gt; H(Service服务)

J[/Volume\] --&gt; K[/configMap\]
J[/Volume\] --&gt; L[/PVC\]
J[/Volume\] --&gt; M[/Secret\]

Z[Kubernetes控制流程]</pre><ul>
<li><!-- raw HTML omitted -->标签选择器<!-- raw HTML omitted --></li>
</ul>

<pre class="mermaid align-center zoomable">graph LR
A[Deployment&lt;br&gt;seletor:env=dev] -.- C[Label&lt;br&gt;]  
B{Service&lt;br&gt;seletor:env=dev} --- C[Label&lt;br&gt;]
C[Label&lt;br&gt;] --- C1((Pod&lt;br&gt;labe:env=dev))
C[Label&lt;br&gt;] --- C2((Pod&lt;br&gt;labe:env=dev))
C[Label&lt;br&gt;] --- C3((Pod&lt;br&gt;labe:env=dev))
    Z[Service]</pre>
<pre class="mermaid align-center zoomable">graph TD

A[user containerN&lt;br&gt;user ImageN&lt;br&gt;user container1&lt;br&gt;user Image1&lt;br&gt;Pause&lt;br&gt;gcr.io/google_containers/pause-amd64&lt;br&gt;] 
    Z[Pod]</pre></blockquote>
<hr>
<h2 id="资源名称">资源名称</h2>
<blockquote>
<ul>
<li>
<ol>
<li><code>kubectl api-resources -o wide</code><!-- raw HTML omitted -->：获取参数定义命令<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<table>
<thead>
<tr>
<th><code>Name</code>(名称)</th>
<th><code>ShortNames</code>(简写)</th>
<th><code>apiVersion</code>(<code>API</code>版本)</th>
<th><code>NameSpaced</code>(命名空间)</th>
<th>kind(类型)</th>
<th>Verbs(可执行操作命令)</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>configmaps</code></td>
<td>cm</td>
<td>v1</td>
<td>true</td>
<td>ConfigMap</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>events</td>
<td>ev</td>
<td>v1</td>
<td>true</td>
<td>Event</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td><code>limitranges</code></td>
<td>limits</td>
<td>v1</td>
<td>true</td>
<td>LimitRange</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>pods</td>
<td>po</td>
<td>v1</td>
<td>true</td>
<td>Pod</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>serviceaccounts</td>
<td>sa</td>
<td>v1</td>
<td>true</td>
<td>ServiceAccount</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>services</td>
<td>svc</td>
<td>v1</td>
<td>true</td>
<td>Service</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>daemonsets</td>
<td>ds</td>
<td>apps/v1</td>
<td>true</td>
<td>DaemonSet</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>deployments</td>
<td>deploy</td>
<td>apps/v1</td>
<td>true</td>
<td>Deployment</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>replicasets</td>
<td>rs</td>
<td>apps/v1</td>
<td>true</td>
<td>ReplicaSet</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>statefulsets</td>
<td>sts</td>
<td>apps/v1</td>
<td>true</td>
<td>StatefulSet</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>horizontalpodautoscalers</td>
<td>hpa</td>
<td>autoscaling/v2</td>
<td>true</td>
<td>HorizontalPodAutoscaler</td>
<td>create,delete,deletecollection,get,list,patch,update,watch   all</td>
</tr>
<tr>
<td>cronjobs</td>
<td>cj</td>
<td>batch/v1</td>
<td>true</td>
<td>CronJob</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>jobs</td>
<td></td>
<td>batch/v1</td>
<td>true</td>
<td>Job</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>events</td>
<td>ev</td>
<td>events.k8s.io/v1</td>
<td>true</td>
<td>Event</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>ingresses</td>
<td>ing</td>
<td>networking.k8s.io/v1</td>
<td>true</td>
<td>Ingress</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>networkpolicies</td>
<td>netpol</td>
<td>networking.k8s.io/v1</td>
<td>true</td>
<td>NetworkPolicy</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
<tr>
<td>poddisruptionbudgets</td>
<td>pdb</td>
<td>policy/v1</td>
<td>true</td>
<td>PodDisruptionBudget</td>
<td>create、delete、deletecollection、get、list、patch、update、watch</td>
</tr>
</tbody>
</table>
<ul>
<li><!-- raw HTML omitted -->资源控制器作用<!-- raw HTML omitted --></li>
</ul>
<table>
<thead>
<tr>
<th>资源分类</th>
<th>资源名称</th>
<th>缩写</th>
<th>资源作用</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Pod</code>资源控制器</td>
<td><code>replicasets</code></td>
<td><code>rs</code></td>
<td>保证指定数量的<code>Pod</code>运行，并支持<code>Pod</code>数量变更，镜像版本变更</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>deployments</code></td>
<td><code>deploy</code></td>
<td>通过控制<code>ReplicaSet</code>来控制<code>Pod</code>，并支持滚动升级、版本回退</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>daemonsets</code></td>
<td><code>ds</code></td>
<td>在集群中的指定<code>Node</code>上都运行一个副本，一般用于日志采集、监控、守护进程类的任务。</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>jobs</code></td>
<td>&mdash;</td>
<td>它创建出来的<code>Pod</code>只要完成任务就立即退出，用于执行一次性任务</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>cronjobs</code></td>
<td><code>cj</code></td>
<td>它创建的Pod会周期性的执行，用于执行周期性的任务</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>horizontalpodautoscalers</code></td>
<td><code>hpa</code></td>
<td>可以根据集群负载自动调整<code>Pod</code>的数量，实现削峰填谷</td>
</tr>
<tr>
<td><code>Pod</code>资源控制器</td>
<td><code>statefulsets</code></td>
<td><code>sts</code></td>
<td>管理有状态的应用。</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h2 id="资源控制器字段类型作用">资源控制器字段类型作用</h2>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>explain</code><!-- raw HTML omitted -->选项获取字段使用方式<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl explain deployment.metadata  	<span style="color:#75715e"># 获取 deployment的metadata使用方式， 还可以获取：spec、kind</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl explain deployment.spec.selector  <span style="color:#75715e"># 获取yaml基础格式命令 </span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->资源控制器<!-- raw HTML omitted --><!-- raw HTML omitted -->必选字段<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>参数名</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>version</code></td>
<td><code>String</code></td>
<td><code>Kubernetes API </code>的版本，可以用<code>kubectl api-versions</code>命令查询</td>
</tr>
<tr>
<td><code>kind</code></td>
<td><code>String</code></td>
<td>标明<code>YAML</code>定义的资源类型和角色，如<code>Pod</code>、<code>Deployment</code>等</td>
</tr>
<tr>
<td><code>metadata</code></td>
<td><code>String</code></td>
<td>元数据对象</td>
</tr>
<tr>
<td><code>metadata.name</code></td>
<td><code>String</code></td>
<td>元数据对象的名字，可自定义，比如命名<code>Pod</code>的名字</td>
</tr>
<tr>
<td><code>spec</code></td>
<td><code>Object</code></td>
<td>详细定义对象</td>
</tr>
<tr>
<td><code>spec.containers[]</code></td>
<td><code>List</code></td>
<td>容器列表定义</td>
</tr>
<tr>
<td><code>spec.containers[].name</code></td>
<td><code>String</code></td>
<td>定义容器的名字</td>
</tr>
<tr>
<td><code>spec.containers[].image</code></td>
<td><code>String</code></td>
<td>定义容器使用的镜像</td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>
<ol start="2">
<li><code>metadata</code><!-- raw HTML omitted -->字段选择<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>metadata.name</code></td>
<td></td>
<td><code>Pod</code>名称</td>
</tr>
<tr>
<td><code>metadata.uid</code></td>
<td></td>
<td><code>Pod</code>的<code>UID</code></td>
</tr>
<tr>
<td><code>metadata.namespace</code></td>
<td></td>
<td><code>Pod</code>名字空间</td>
</tr>
<tr>
<td><code>metadata.labels['&lt;KEY&gt;']</code></td>
<td></td>
<td><code>Pod</code>标签 <code>&lt;KEY&gt;</code> 的值 (例如<code>metadata.labels['mylabel']</code>）</td>
</tr>
<tr>
<td><code>metadata.annotations['&lt;KEY&gt;']</code></td>
<td></td>
<td><code>Pod</code>的注解 <code>&lt;KEY&gt;</code> 的值（例如, <code>metadata.annotations['myannotation']</code>）</td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>
<ol start="3">
<li><code>spec.containers</code><!-- raw HTML omitted -->字段定义<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>spec.containers[].name</td>
<td>String</td>
<td>定义容器的名字。</td>
</tr>
<tr>
<td>spec.containers[].image</td>
<td>String</td>
<td>定义容器使用的镜像。</td>
</tr>
<tr>
<td>spec.containers[].imagePullSecrets</td>
<td></td>
<td>要从私有仓库拉取镜像，<code>Kubernetes</code>需要凭证。 配置文件中的 <code>imagePullSecrets</code>字段表明<code>Kubernetes</code>应该通过名为 <code>regcred</code> 的 Secret 获取凭证</td>
</tr>
<tr>
<td>spec.containers[].imagePullPolicy</td>
<td>S</td>
<td>定镜像拉取有3个值可选:<!-- raw HTML omitted --> <!-- raw HTML omitted --><code>Always</code><!-- raw HTML omitted -->：总是从远程仓库拉取镜像、<!-- raw HTML omitted --><!-- raw HTML omitted --><code>IfNotPresent</code><!-- raw HTML omitted -->：本地有则使用本地镜像，本地没有则从远程仓库拉取镜像。如上面 3个值都没设置，默认是<code>Always</code><!-- raw HTML omitted --><!-- raw HTML omitted --><code>Never</code><!-- raw HTML omitted -->：仅使用本地镜像，本地没有就报错</td>
</tr>
<tr>
<td>spec.containers[].command[]</td>
<td>List</td>
<td>指定容器启动命令，因为是数组形式，所以可以指定多个启动命令，不指定则使用镜像打包时的启动命令。</td>
</tr>
<tr>
<td>spec.containers[].args[]</td>
<td>List</td>
<td>指定容器启动命令参数，因为是数组形式，所以可以指定多个参数。</td>
</tr>
</tbody>
</table>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spec</span>:   	<span style="color:#75715e"># 必选，Pod中容器的详细定义</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">imagePullSecrets</span>:  	<span style="color:#75715e"># 配置登录 docker registry 的 secret 仓库</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">docker-harbor  	# 指定使用的secret库房名称</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:   	<span style="color:#75715e"># 必选，Pod中容器列表，一个Pod中可以定义多个容器</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">tomcat-demo   	# 指定容器名称，不可更新</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">192.168.80.210</span>:<span style="color:#ae81ff">8080</span><span style="color:#ae81ff">/test/tomcat-demo:v1 </span> <span style="color:#75715e"># 镜像仓库地址</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">Always   	# 容器下载策略：Always|Never|IfNotPresent，不管本地存不存在，都从仓库拉取镜像</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: [<span style="color:#ae81ff">string]   	# 容器的启动命令列表，替代docker的ENTRYPOINT指令、如不指定，使用打包时使用的启动命令</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">args</span>:   	<span style="color:#75715e"># 容器的启动命令参数列表、替代docker的CMD指令</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">/bin/sh</span>
</span></span><span style="display:flex;"><span>    - -<span style="color:#ae81ff">c</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">touch /tmp/healthy; sleep 30; rm -fr /tmp/healthy; sleep 600</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><code>spec.containers.volumeMounts</code><!-- raw HTML omitted -->容器工作目录定义<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>spec.containers[].workingDir</td>
<td>String</td>
<td>指定容器的工作目录</td>
</tr>
<tr>
<td>spec.containers[].volumeMounts[]</td>
<td>List</td>
<td>指定容器内部的存储卷配置</td>
</tr>
<tr>
<td>spec.containers[].volumeMounts[].name</td>
<td>String</td>
<td>指定可以被容器挂载的存储卷的名称</td>
</tr>
<tr>
<td>spec.containers[].volumeMounts[].mountPath</td>
<td>String</td>
<td>指定可以被容器挂载的存储卷的路径。</td>
</tr>
<tr>
<td>spec.containers[].volumeMountsf].readOnly</td>
<td>String</td>
<td>设置存储卷路径的读写模式，true 或者 false，默认为读写模式。</td>
</tr>
</tbody>
</table>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spec</span>:   	<span style="color:#75715e"># 必选，Pod中容器的详细定义</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">containers</span>:   	<span style="color:#75715e"># 必选，Pod中容器列表</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">workingDir</span>: <span style="color:#ae81ff">string   	# 容器的工作目录、不指定则使用镜像默认值</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumeMounts</span>:   	<span style="color:#75715e"># 挂载到容器内部的存储卷配置</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">data   	# 引用pod定义的共享存储卷的名称，需用volumes[]部分定义的的卷名</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/opt/data   	# 存储卷在容器内mount的绝对路径，应少于512字符</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">readOnly</span>: <span style="color:#ae81ff">boolean   	# 是否为只读模式</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><code>spec.containers.ports</code><!-- raw HTML omitted -->容器端口定义<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl explain deployment.spec.containers.ports  	<span style="color:#75715e"># 获取端口使用方式</span></span></span></code></pre></div><table>
<thead>
<tr>
<th>参数名称</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>spec.containers[].ports[]</td>
<td>List</td>
<td>指定容器需要用到的端口列表。</td>
</tr>
<tr>
<td>spec.containers[].ports[].name</td>
<td>String</td>
<td>指定端口名称。</td>
</tr>
<tr>
<td>spec.containers[].ports[].containerPort</td>
<td>String</td>
<td>指定容器需要监听的端口号。</td>
</tr>
<tr>
<td>spec.containers[].ports[].hostPort</td>
<td>String</td>
<td>指定容器所在主机需要监听的端口号，默认和 spec.containers[].ports[].containerPort 相同。注意，设置了则同一台主机无法启动该容器的相同副本（主机的端口号不能相同，若相同，会引发冲突）。</td>
</tr>
<tr>
<td>spec.containers[].ports[].protocol</td>
<td>String</td>
<td>指定端口协议，支持 TCP 和 UDP，默认值为 TCP 。</td>
</tr>
</tbody>
</table>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spec</span>:  	<span style="color:#75715e"># 必选，Pod中容器的详细定义</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">containers</span>:  	<span style="color:#75715e"># 必选，Pod中容器列表</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:  	<span style="color:#75715e"># 容器暴露的端口</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http  	# 服务名称、该名称可以在service种被引用</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>  	<span style="color:#75715e"># 容器需要监听的端口号</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">hostPort</span>: <span style="color:#ae81ff">int  	# 容器所在主机需要监听的端口号，默认与Container相同</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP  	# 端口协议，支持TCP和UDP，默认TCP</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>  	<span style="color:#75715e"># 集群端口</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">80</span>  	<span style="color:#75715e"># Pod端口</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nodePort</span>: <span style="color:#ae81ff">30080</span>  	<span style="color:#75715e"># 节点对外端口</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="6">
<li><code>spec.containers.env</code><!-- raw HTML omitted -->容器变量定义<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>spec.containers[].env[]</td>
<td>List</td>
<td>指定容器运行前需要设置的环境变量列表。</td>
</tr>
<tr>
<td>spec.containers[].env[].name</td>
<td>String</td>
<td>指定环境变量名称。</td>
</tr>
<tr>
<td>spec.containers[].env[].value</td>
<td>String</td>
<td>指定环境变量值。</td>
</tr>
</tbody>
</table>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spec</span>:   	<span style="color:#75715e"># 必选，Pod中容器的详细定义</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">containers</span>:   	<span style="color:#75715e"># 必选，Pod中容器列表</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">env</span>:   	<span style="color:#75715e"># 容器运行前需设置的环境变量列表</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">JAVA_OPTS   	# 环境变量名称</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;-Xmx1g&#34;</span>   	<span style="color:#75715e"># 定义使用内存、环境变量的值</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="7">
<li><code>spec.containers.resources</code><!-- raw HTML omitted -->容器资源限制<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>spec.containers[].resources</td>
<td>Object</td>
<td>指定资源限制和资源请求的值（这里开始就是设置容器的资源上限）。</td>
</tr>
<tr>
<td>spec.containers[].resources.limits</td>
<td>Object</td>
<td>指定设置容器运行时资源的运行上限。</td>
</tr>
<tr>
<td>spec.containers[].resources.limits.cpu</td>
<td>String</td>
<td>指定<code>CPU</code>的限制，单位为<code>core</code>，是用于运行 <code>docker run --cpu-shares</code>命令的参数。</td>
</tr>
<tr>
<td>spec.containers[].resources.limits.memory</td>
<td>String</td>
<td>指定内存的限制，单位为 MiB 或 GiB。</td>
</tr>
<tr>
<td>spec.containers[].resources.requests</td>
<td>Object</td>
<td>指定容器启动和调度时的限制。</td>
</tr>
<tr>
<td>spec.containers[].resources.requests.cpu</td>
<td>String</td>
<td>CPU 请求，单位为 core，容器启动时初始化可用数量。</td>
</tr>
<tr>
<td>spec.containers[].resources.requests.memory</td>
<td>String</td>
<td>内存请求，单位为 MiB 或 GiB，容器启动的初始化可用数量。</td>
</tr>
</tbody>
</table>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># 设定默认request和limit</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Namespace</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">name</span>: <span style="color:#ae81ff">apps</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">LimitRange</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">name</span>: <span style="color:#ae81ff">limit-resource  	# 在一个名称空间不能重复</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default  	# 指定名称空间，默认defalut</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">labels</span>:      <span style="color:#ae81ff">&lt;map[string]string&gt;  	# 标签</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">annotations</span>: <span style="color:#ae81ff">&lt;map[string]string&gt;  	# 注释</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设定默认request和limit</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">default</span>:  	<span style="color:#75715e"># 默认的资源上限, limit</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">1024Mi</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">500m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">defaultRequest</span>:  	<span style="color:#75715e"># 默认的资源申请值, required</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">128Mi</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">100m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">max</span>:  	<span style="color:#75715e"># 声明的limit上限</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">2048Mi</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">1000m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">min</span>:  	<span style="color:#75715e"># 声明的required下线</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">64Mi</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">50m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">Container  	# 被限制的对象，Container</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">###############################################</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:   	<span style="color:#75715e"># Pod中容器的详细定义</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:   	<span style="color:#75715e"># Pod中容器列表</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>:   	<span style="color:#75715e"># 资源限制和请求的设置</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">limits</span>:   	<span style="color:#75715e"># 限定Pod最大使用硬件资源、通常设置cpu和memory</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cpu</span>: <span style="color:#e6db74">&#34;1&#34;</span>   	<span style="color:#75715e"># Cpu的限制，单位为core数</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">memory</span>: <span style="color:#e6db74">&#34;1Gi&#34;</span>   	<span style="color:#75715e"># 内存限制，单位可以为Mib/Gib</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">requests</span>:   	<span style="color:#75715e"># 最低资源要求，在scheduler中被用到，通常设置cpu和memory</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cpu</span>: <span style="color:#e6db74">&#34;0.5&#34;</span>   	<span style="color:#75715e"># 限定使用几个核心CPU、容器启动的初始可用数量</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">memory</span>: <span style="color:#e6db74">&#34;256Mi&#34;</span>   	<span style="color:#75715e"># 设定使用内存、容器启动的初始可用数量</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="8">
<li><!-- raw HTML omitted -->容器健康检查设置<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>
<p><code>startupProbe</code><!-- raw HTML omitted -->： 启动探测：<!-- raw HTML omitted -->容器启动完毕的配置，该配置与<code>readinessProbe</code>一致，在<code>lifecycle</code>和<code>Probe</code>之前运行，失败则重启</p>
<p><code>k8s1.16</code>版本后新加<code>startupProbe</code>探测方式，用于判断容器内应用程序是否已经启动，如果配置了<code>startuprobe</code>，就会先禁用其他的探测，直到它成功为止</p>
</li>
<li>
<p><code>liveness probe</code><!-- raw HTML omitted -->(存活探针)<!-- raw HTML omitted --><code>Kubelet</code> 使用<code>liveness probe</code>（存活探针）来确定何时重启容器。例如，当应用程序处于运行状态但无法做进一步操作，<code>liveness</code>探针将捕获到<code>deadlock</code>重启处于该状态下的容器，使应用程序在存在<code>bug</code>的情况下依然能够继续运行下去（谁的程序还没几个<code>bug</code>呢）</p>
</li>
<li>
<p><code>readiness probe</code><!-- raw HTML omitted -->(就绪探针)<!-- raw HTML omitted --><code>Kubelet</code>使用<code>readiness probe(就绪探针)</code>来确定容器是否已经就绪可以接受流量。只有当<code>Pod</code>中的容器都处于就绪状态时<code>kubelet</code>才会认定该<code>Pod</code>处于就绪状态。该信号的作用是控制哪些<code>Pod</code>应该作为<code>service</code>的后端。如果<code>Pod</code>处于非就绪状态，那么它们将会被从<code>service</code>的<code>load balancer</code>中移除</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>spec.containers[].livenessProbe(存活探针)</td>
<td>Object</td>
<td>指定<code>Pod</code>内容器健康检查的设置，当探测几次无响应后，系统将自动重启该容器。参数可以设置为<code>exec</code>、<code>httpGet</code>、<code>tcpSocket</code>。</td>
</tr>
<tr>
<td>spec.containers[].livenessProbe.exec</td>
<td>Object</td>
<td>指定<code>Pod</code>内容器健康检查的设置，确定是<code>exec</code>方式。</td>
</tr>
<tr>
<td>spec.containers[].livenessProbe.exec.command[]</td>
<td>String</td>
<td>指定<code>exec</code>方式后用这个参数设置需要指定的命令或者脚本。</td>
</tr>
<tr>
<td>spec.containers[].livenessProbe.httpGet</td>
<td>Object</td>
<td>指定 Pod 内容器健康检查的设置，确定是<code>httpGet</code>方式。</td>
</tr>
<tr>
<td>spec.containers[].livenessProbe.tcpSocket</td>
<td>Object</td>
<td>指定 Pod 内容器健康检查的设置，确定是 <code>tcpSocket</code>方式。</td>
</tr>
<tr>
<td>spec.containers[].livenessProbe.initialDelaySeconds</td>
<td>Number</td>
<td>指定容器启动完成后延迟多久开始首次探测的时间间隔，单位为秒。</td>
</tr>
<tr>
<td>spec.containers[].livenessProbe.timeoutSeconds</td>
<td>Number</td>
<td>容器健康检查的探测等待时间，单位为秒，默认为 1 秒。若超过该时间，则认为该次探测失败。</td>
</tr>
<tr>
<td>spec.containers[].livenessProbe.periodSeconds</td>
<td>Number</td>
<td>对容器健康检查的定期探测时间设置，单位为秒，默认每 10 秒探测一次。<code>Kubernetes</code>如果连续执行3次Liveness探测均失败，则会杀掉并重启容器</td>
</tr>
<tr>
<td>spec.containers[].livenessProbe.failureThreshold</td>
<td>Number</td>
<td>连续探测失败多少次才被认定为失败。默认是3。最小值是1</td>
</tr>
<tr>
<td>spec.containers[].livenessProbe.successThreshold</td>
<td>Number</td>
<td>连续探测成功多少次才被认定为成功。默认是1</td>
</tr>
</tbody>
</table>
<ul>
<li><code>infrastructure Container:</code><!-- raw HTML omitted -->基础容器，维护整个<code>Pod</code>网络空间<!-- raw HTML omitted --></li>
<li><code>initContainers:</code><!-- raw HTML omitted -->初始化容器，先于业务容器开始运行<!-- raw HTML omitted --></li>
<li><code>Containers:</code><!-- raw HTML omitted -->业务容器，并行启动<!-- raw HTML omitted --></li>
<li><code>Pod</code><!-- raw HTML omitted -->内所有容器公用一个<!-- raw HTML omitted --><code>ip</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">initc-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">initc-template</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">initContainers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">initc-template</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#39;sh&#39;</span>, <span style="color:#e6db74">&#39;-c&#39;</span>, <span style="color:#e6db74">&#39;sleep 10; echo &#34;Hello&#34; &gt;&gt;/tmp/hello.txt&#39;</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-container</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#39;sh&#39;</span>, <span style="color:#e6db74">&#39;-c&#39;</span>, <span style="color:#e6db74">&#39;echo The app is running! &amp;&amp; sleep 3600&#39;</span>]</span></span></code></pre></div><ul>
<li><code>exec</code><!-- raw HTML omitted -->命令：在容器内执行一次命令，如果命令执行的退出码为<code>0</code>，则认为程序正常，否则不正常<!-- raw HTML omitted --></li>
<li><code>Pod</code><!-- raw HTML omitted -->五种状态<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>Pending(挂起)</code>：<code>API Server</code><!-- raw HTML omitted -->已经创建了<code>Pod</code>资源对象，但它尚未被调度完成或者仍处于下载镜像的过程中<!-- raw HTML omitted --></li>
<li><code>Running(运行中)</code>：<code>Pod</code><!-- raw HTML omitted -->已经被调度到某节点，并且所有容器都已经被<code>kubelet</code>创建完成<!-- raw HTML omitted --></li>
<li><code>Succeeded(成功终止)</code>：<code>Pod</code><!-- raw HTML omitted -->中的所有容器都已经成功终止并且不会被重启<!-- raw HTML omitted --></li>
<li><code>Failed(失败)</code><!-- raw HTML omitted -->：所有容器都已经终止，但至少有一个容器终止失败，即容器返回了非<code>0</code>值的退出状态<!-- raw HTML omitted --></li>
<li><code>Unknown(未知)</code>：<code>API Server</code><!-- raw HTML omitted -->无法正常获取到<code>Pod</code>对象的状态信息，通常由于网络通信失败所导致<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spec</span>:   	<span style="color:#75715e"># 必选，Pod中容器的详细定义</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:   	<span style="color:#75715e"># 必选，Pod中容器列表</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">lifecycle</span>:   	<span style="color:#75715e"># 生命周期钩子</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">postStart</span>:  	<span style="color:#75715e"># 容器启动后立即执行此钩子,如果执行失败,会根据重启策略进行重启</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">exec</span>:  	<span style="color:#75715e"># 通过执行特定命令来探测容器健康状态</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;echo Hello from the postStart handler&gt; /usr/share/message&#34;</span>]
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">preStop</span>:  	<span style="color:#75715e"># 容器终止前执行此钩子,无论结果如何,容器都会终止</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">exec</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;nginx -s quit; while killall -0 nginx; do sleep 1; done&#34;</span>]
</span></span><span style="display:flex;"><span><span style="color:#75715e">#################  		启动探针	  #####################</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">startupProbe</span>:  	<span style="color:#75715e"># 容器启动完毕的配置，该配置与readinessProbe一致，在lifecycle和Probe之前运行，失败则重启</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">tcpSocket</span>:   		<span style="color:#75715e"># 使用TcpSocket、httpGet健康检查</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8010</span>   	<span style="color:#75715e"># 探测8010端口</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">5</span>  	<span style="color:#75715e"># 检测失败5次表示未就绪</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">60</span>   	<span style="color:#75715e"># 指定容器启动60s之后开始执行Liveness探测，</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>  	<span style="color:#75715e"># 两次探测的间隔多少秒，默认值为10</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>  	<span style="color:#75715e"># 连续多少次检测成功认为容器正常，默认值为1。不支持修改</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">3</span>  	<span style="color:#75715e"># 连续多少次检测失败认为容器异常，默认值为3</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span>  	<span style="color:#75715e"># 探测请求超时时间</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##################  	存活探针编写方式  	################</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">livenessprobe</span>:  	<span style="color:#75715e"># 存活探针检查,不通过不转发流量</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tcpSocket</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8010</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#####################  		就绪探针编写方式  		################</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">readinessProbe</span>:   	<span style="color:#75715e"># 就绪探针检查、不通过重建pod</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">tcpSocket</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8010</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">####################  		httpGet编写  		###########################</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">httpGet</span>:
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/  	# URI地址</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>  	<span style="color:#75715e"># 端口号,或者协议：http/https</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">host</span>: <span style="color:#ae81ff">192.168.109.100</span>  	<span style="color:#75715e"># 主机地址  </span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTP  	# 支持的协议，http或者https</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="9">
<li><code>spec.volumes</code><!-- raw HTML omitted -->挂载目录字段<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>参数名</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>spec.volumes[].name</td>
<td>String</td>
<td>定义<code>Pod</code>共享存储卷的名称，容器定义部分 <code>spec.containers[].volumeMounts[].name</code>的值和这里是一样的。</td>
</tr>
<tr>
<td>spec.volumes[].emptyDir</td>
<td>Object</td>
<td>指定<code>Pod</code>的临时目录，值为一个空对象：<code>emptyDir:{}</code></td>
</tr>
<tr>
<td>spec.volumes[].hostPath</td>
<td>Object</td>
<td>指定挂载<code>Pod</code>所在宿主机的目录。</td>
</tr>
<tr>
<td>spec.volumes[].hostPath.path</td>
<td>String</td>
<td>指定<code>Pod</code>所在主机的目录，将被用于容器中<code>mount</code>的目录。</td>
</tr>
<tr>
<td>spec.volumes.nfs</td>
<td></td>
<td></td>
</tr>
<tr>
<td>spec.volumes[]</td>
<td>Object</td>
<td>指定类型为<code>Secret</code>的存储卷，<code>Secret</code>意为私密、秘密，这很容易理解，它存储一些密码、密钥等敏感安全文件。挂载集群预定义的<code>Secret</code>对象到容器内部。</td>
</tr>
<tr>
<td>spec.volumes[].configMap</td>
<td>Object</td>
<td>指定类型为<code>ConfigMap</code>的存储卷，表示挂载集群预定义的<code>ConfigMap</code>对象到容器内部。</td>
</tr>
</tbody>
</table>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl explain deployment.spec.volumes  	<span style="color:#75715e"># 获取 deployment存储使用</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl explain deployment.spec.volumes.hostPath.type  	<span style="color:#75715e"># 类型声明  </span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->简单存储模式→<!-- raw HTML omitted --><code>volume-emptydir</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod  </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">name</span>: <span style="color:#ae81ff">volume-emptydir </span> <span style="color:#75715e"># 定义名称</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:   	<span style="color:#75715e"># 必选，Pod中容器的详细定义</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">containers</span>:  	<span style="color:#75715e"># 必选，Pod中容器列表</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumeMounts</span>: <span style="color:#75715e"># 将logs-volume挂载到nginx容器中对应的目录，该目录为/var/log/nginx</span>
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/log/nginx </span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30  	# 可以选择 1.28.4版本</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;tail -f /logs/access.log&#34;</span>] <span style="color:#75715e"># 初始命令，动态读取指定文件</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumeMounts</span>: <span style="color:#75715e"># 将logs-volume挂载到busybox容器中的对应目录，该目录为/logs</span>
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/logs</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:   	<span style="color:#75715e"># 声明volume，name为logs-volume，类型为emptyDir</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume  	# 共享存储卷名称 （volumes类型有很多种）</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">emptyDir</span>: {}   		<span style="color:#75715e"># 类型为emtyDir的存储卷，与Pod同生命周期的一个临时目录。为空值</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->简单存储模式→<!-- raw HTML omitted --><code>volume-HostPath</code></li>
</ul>
<blockquote>
<ul>
<li><code>DirectoryOrCreate</code><!-- raw HTML omitted -->：目录存在就使用，不存在就先创建后使用<!-- raw HTML omitted --></li>
<li><code>Directory</code><!-- raw HTML omitted -->：目录必须存在<!-- raw HTML omitted --></li>
<li><code>FileOrCreate</code><!-- raw HTML omitted -->：文件存在就使用，不存在就先创建后使用<!-- raw HTML omitted --></li>
<li><code>File</code><!-- raw HTML omitted -->：文件必须存在<!-- raw HTML omitted --></li>
<li><code>Socket</code><!-- raw HTML omitted -->：<code>unix</code>套接字必须存在<!-- raw HTML omitted --></li>
<li><code>CharDevice</code><!-- raw HTML omitted -->：字符设备必须存在<!-- raw HTML omitted --></li>
<li><code>BlockDevice</code><!-- raw HTML omitted -->：块设备必须存在<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">volume-hostpath</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumeMounts</span>: <span style="color:#75715e"># 将logs-volume挂载到nginx容器中对应的目录，该目录为/var/log/nginx</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/log/nginx</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;tail -f /logs/access.log&#34;</span>] <span style="color:#75715e"># 初始命令，动态读取指定文件</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumeMounts</span>: <span style="color:#75715e"># 将logs-volume挂载到busybox容器中的对应目录，该目录为/logs</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/logs</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>: <span style="color:#75715e"># 声明volume，name为logs-volume，类型为hostPath</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">hostPath</span>:  <span style="color:#75715e"># 类型为hostPath的存储卷，表示挂载Pod所在宿主机的目录</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/root/logs </span> <span style="color:#75715e"># Pod所在宿主机的目录，将被用于同期中mount的目录</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">type</span>: <span style="color:#ae81ff">DirectoryOrCreate</span> <span style="color:#75715e"># 目录存在就使用，不存在就先创建再使用 </span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->简单存储模式→<!-- raw HTML omitted --><code>volume-nfs</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">name</span>: <span style="color:#ae81ff">volume-nfs</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumeMounts</span>:  	<span style="color:#75715e"># 将logs-volume挂载到nginx容器中对应的目录，该目录为/var/log/nginx</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/log/nginx</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;tail -f /logs/access.log&#34;</span>]  	<span style="color:#75715e"># 初始命令，动态读取指定文件</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumeMounts</span>:  	<span style="color:#75715e"># 将logs-volume挂载到busybox容器中的对应目录，该目录为/logs</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/logs</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:  	<span style="color:#75715e"># 声明volume</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nfs</span>:  	<span style="color:#75715e"># 存储类型，和底层正则的存储对应</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server</span>: <span style="color:#ae81ff">192.168.18.100</span>  	<span style="color:#75715e"># NFS服务器地址</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/root/data/nfs  	# 共享文件路径</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->高级存储模式→<!-- raw HTML omitted --><code>volume-pv</code></li>
</ul>
<blockquote>
<ul>
<li><code>PV：kubernetes</code><!-- raw HTML omitted -->管理员维护<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolume</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pv2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">nfs</span>:  	<span style="color:#75715e"># 存储类型，和底层正则的存储对应</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/root/data/pv1</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">server</span>: <span style="color:#ae81ff">192.168.18.100</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">capacity</span>:  	<span style="color:#75715e"># 存储能力，目前只支持存储空间的设置</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">2Gi</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">accessModes</span>:  	<span style="color:#75715e"># 访问模式</span>
</span></span><span style="display:flex;"><span>   - <span style="color:#ae81ff">ReadWriteMany</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">storageClassName</span>:  	<span style="color:#75715e"># 存储类别</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">persistentVolumeReclaimPolicy</span>: <span style="color:#ae81ff">Retain  	# 回收策略</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->高级存储→<!-- raw HTML omitted --><code>volume-pvc</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolumeClaim</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pvc1</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">accessModes</span>:  	<span style="color:#75715e"># 访客模式</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">ReadWriteMany</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:  	<span style="color:#75715e"># 采用标签对PV选择</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">storageClassName</span>:  	<span style="color:#75715e"># 存储类别</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:  	<span style="color:#75715e"># 请求空间</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">1Gi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#################################################### 创建 Pod 访问 PVC 类型存储</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;while true;do echo pod1 &gt;&gt; /root/out.txt; sleep 10; done;&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">volume</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/root/</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">volume</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">persistentVolumeClaim</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">claimName</span>: <span style="color:#ae81ff">pvc1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">readOnly</span>: <span style="color:#66d9ef">false</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->配置存储→<!-- raw HTML omitted --><code>volumes-secret</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Secret</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">name</span>: <span style="color:#ae81ff">secret</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">type</span>: <span style="color:#ae81ff">Opaque</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">data</span>:  	<span style="color:#75715e"># 提前编码实名：data、使用Kubernetes进行编码使用：stringData</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">username</span>: <span style="color:#ae81ff">YWRtaW4=  	# 使用kubernetes进行编码写原数据：admin</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">password</span>: <span style="color:#ae81ff">MTIzNDU2  	# 使用kubernetes进行编码写原数据：123456</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">############################################## 配置 pod-secret</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-secret</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/secret/config</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">secret</span>:  	<span style="color:#75715e"># 类型为secret的存储卷，挂载集群与定义的secret对象到容器内部</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">secretName</span>: <span style="color:#ae81ff">secret</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">items</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">string</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">string</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="10">
<li><!-- raw HTML omitted -->额外的参数对象<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>参数名</th>
<th>参数类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>spec.restartPolicy</td>
<td>String</td>
<td>定义<code>Pod</code>的重启策略，可选值为<code>Always</code>、<code>OnFailure</code>，默认值为<code>Always</code>。<!-- raw HTML omitted -->(1) <!-- raw HTML omitted --><code>Always</code><!-- raw HTML omitted -->：<code>Pod</code>一旦终止运行，无论容器是如何终止的，<code>kubelet</code>服务都将重启它<!-- raw HTML omitted -->(2) <!-- raw HTML omitted --><code>OnFailure</code><!-- raw HTML omitted -->：只有<code>Pod</code>以非零退出码终止时，<code>kubelet</code>才会重启该容器，如果容器正常结束（退出码为 0），则<code>kubelet</code>将不会重启它<!-- raw HTML omitted --> (3)<!-- raw HTML omitted --><code>Never</code><!-- raw HTML omitted -->：<code>Pod</code>终止后，<code>kubelet</code>将退出码报告给<code>master</code>，不会重启该 <code>Pod</code></td>
</tr>
<tr>
<td>spec.nodeName</td>
<td></td>
<td>定向调度</td>
</tr>
<tr>
<td>spec.nodeSelector</td>
<td>Object</td>
<td>定向调度，定义节点的过滤标签（以<code>key:value</code>格式指定）。</td>
</tr>
<tr>
<td>pod.spec.affinity</td>
<td>亲和调度</td>
<td></td>
</tr>
<tr>
<td>pod.spec.affinity.nodeAffinity</td>
<td></td>
<td>（node亲和性）：以Node为目标，解决Pod可以调度到那些Node的问题。</td>
</tr>
<tr>
<td>pod.spec.affinity.podAffinity</td>
<td></td>
<td>（pod亲和性）：以Pod为目标，解决Pod可以和那些已存在的Pod部署在同一个拓扑域中的问题。</td>
</tr>
<tr>
<td>pod.spec.affinity.podAntiAffinity</td>
<td></td>
<td>（pod反亲和性）：以Pod为目标，解决Pod不能和那些已经存在的Pod部署在同一拓扑域中的问题。</td>
</tr>
<tr>
<td>pod.spec.tolerations</td>
<td>容忍调度</td>
<td>污点就是拒绝，容忍就是忽略，Node通过污点拒绝Pod调度上去，Pod通过容忍忽略拒绝</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>spec.imagePullSecrets</td>
<td>List</td>
<td>定义拉取镜像时使用<code>Secret</code>名称（以<code>name:secretkey</code>格式指定）。</td>
</tr>
<tr>
<td>spec.hostNetwork</td>
<td>Boolean</td>
<td>定义是否使用主机网络模式，默认值为 false。 设置 true 表示使用宿主机网络，不使用 Docker 网桥，同时设置了 true 将无法在同一台宿主机上启动第二个副本。</td>
</tr>
<tr>
<td>service.spec.type</td>
<td></td>
<td><code>type</code>确定服务的公开方式。 默认为<code>ClusterIP</code>。有效的选项是<code>ExternalName</code>、<code>ClusterIP</code>、<code>NodePort</code>和<code>LoadBalancer</code></td>
</tr>
<tr>
<td>service.spec.type.ClusterIP</td>
<td></td>
<td><code>ClusterIP</code>为负载均衡分配集群内部<code>IP</code>地址端点。 端点由选择器确定，或者如果不是通过手动构造<code>Endpoints</code>对象或<code>EndpointSlice</code>指定对象。 如果<code>clusterIP</code>为<code>None</code>，则不分配虚拟<code>IP</code>，并且端点作为一组端点而不是虚拟<code>IP</code>发布。</td>
</tr>
<tr>
<td>service.spec.type.NodePort</td>
<td></td>
<td><code>NodePort</code>建立在<code>ClusterIP</code>之上，并在每个节点上分配一个端口路由到与<code>clusterIP</code>相同的端点。</td>
</tr>
<tr>
<td>service.spec.type.LoadBalancer</td>
<td></td>
<td><code>LoadBalancer</code>建立在<code>NodePort</code>并创建一个外部负载均衡器（如果当前支持<code>cloud</code>) 路由到与<code>clusterIP</code>相同的端点。</td>
</tr>
<tr>
<td>service.spec.type.ExternalName</td>
<td></td>
<td><code>ExternalName</code>将此服务别名为指定的<code>externalName</code>。 其他几个领域不适用于<code>ExternalName</code>服务</td>
</tr>
</tbody>
</table>
<ul>
<li><code>tolerations</code><!-- raw HTML omitted -->(容忍)配置<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl explain deployment.spec.template.spec.tolerations</span></span></code></pre></div><ul>
<li><code>affinity</code><!-- raw HTML omitted -->(亲和性)配置<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl explain deployment.spec.template.spec.affinity  	<span style="color:#75715e"># 查看 Deployment 亲和性使用</span></span></span></code></pre></div><blockquote>
<ul>
<li><code>nodeAffinity</code><!-- raw HTML omitted -->节点亲和性<!-- raw HTML omitted --></li>
<li><code>requiredDuringSchedulingIgnoredDuringExecution:</code><!-- raw HTML omitted -->硬性要求，必须满足条件<!-- raw HTML omitted --></li>
<li><code>preferredDuringSchedulingIgnoredDuringExecution:</code><!-- raw HTML omitted -->软性要求，不强制满足<!-- raw HTML omitted --></li>
<li><code>In</code><!-- raw HTML omitted -->：满足条件之一<!-- raw HTML omitted --></li>
<li><code>NotIn</code><!-- raw HTML omitted -->：所有条件都不满足，反亲和性<!-- raw HTML omitted --></li>
<li><code>Exists</code><!-- raw HTML omitted -->：存在就满足<!-- raw HTML omitted --></li>
<li><code>DoesNotExist</code><!-- raw HTML omitted -->不存在就满足<!-- raw HTML omitted --></li>
<li><code>Gt</code><!-- raw HTML omitted -->大于节点上的数值就满足<!-- raw HTML omitted --></li>
<li><code>Lt</code><!-- raw HTML omitted -->小于节点上的数值就满足<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl explain deployment.spec.template.spec.affinity.nodeAffinity  	<span style="color:#75715e"># 查看Deployment nodes亲和性使用</span></span></span></code></pre></div><div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">with-affinity-anti-affinity</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">affinity</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nodeAffinity</span>:  	<span style="color:#75715e"># 节点亲和性  </span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">requiredDuringSchedulingIgnoredDuringExecution</span>:  	<span style="color:#75715e"># 必须满足条件</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">nodeSelectorTerms</span>:  	<span style="color:#75715e"># 选择器，nodeSelectorTerms：节点选择器，labelSelector：标签选择器</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">matchExpressions</span>:  	<span style="color:#75715e"># 表达式匹配</span>
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">kubernetes.io/os  	# 必须存在的Key</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">In  	# 在Key中满足一个条件，匹配类型：In、NotIn、Exists、DoesNotExist、Gt、Lt</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">values</span>:  	<span style="color:#75715e"># 下方 value 在 Key 中必须存在其中之一(value)</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">linux  	# 必须是Linux才部署  </span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">preferredDuringSchedulingIgnoredDuringExecution</span>:  	<span style="color:#75715e"># 软性要求，不强制满足，优先选择亲和性目标</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">weight</span>: <span style="color:#ae81ff">1</span>  	<span style="color:#75715e"># 权重，数值越大，优先部署</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">preference</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">matchExpressions</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">label-1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">In</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">values</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">key-1</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">weight</span>: <span style="color:#ae81ff">50</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">preference</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">matchExpressions</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">label-2</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">In</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">values</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">key-2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">with-node-affinity</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">registry.k8s.io/pause:2.0</span></span></span></code></pre></div><ul>
<li><code>podAffinity</code><!-- raw HTML omitted -->亲和性<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl explain pod.spec.affinity.podAffinity</span></span></code></pre></div><div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">with-pod-affinity</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">affinity</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">podAffinity</span>:  	<span style="color:#75715e"># Pod 亲和性</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">requiredDuringSchedulingIgnoredDuringExecution</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">labelSelector</span>:  	<span style="color:#75715e"># 选择器：</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">matchExpressions</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">security</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">In</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">values</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">S1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">topologyKey</span>: <span style="color:#ae81ff">topology.kubernetes.io/zone  	# 匹配节点标签亲和性</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">podAntiAffinity</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">preferredDuringSchedulingIgnoredDuringExecution</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">weight</span>: <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">podAffinityTerm</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">labelSelector</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">matchExpressions</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">security</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">In</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">values</span>:
</span></span><span style="display:flex;"><span>              - <span style="color:#ae81ff">S2</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">topologyKey</span>: <span style="color:#ae81ff">topology.kubernetes.io/zone</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">with-pod-affinity</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">registry.k8s.io/pause:2.0  </span></span></span></code></pre></div><ul>
<li><code>podAntiAffinity</code><!-- raw HTML omitted -->反亲和性<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl explain pod.spec.affinity.podAntiAffinity  </span></span></code></pre></div></blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spec</span>:  	<span style="color:#75715e"># 必选，Pod中容器的详细定义</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">2</span>  	<span style="color:#75715e"># 创建Pod个数</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">selector</span>:  	<span style="color:#75715e"># 标签选择器</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">matchLabels</span>:  	<span style="color:#75715e"># 标签选择方式:直接给定标签键值,这里是取交集的,也就是Pod必须满足下面两个标签才能被调度</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">project</span>: <span style="color:#ae81ff">ms</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">product  	# 此行以上定义控制器本身</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:  	<span style="color:#75715e"># 定义Deployment更新回滚</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>         - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">string</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">annotations</span>:  	<span style="color:#75715e"># 注释，不能作为被筛选</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hostAliases</span>:  	<span style="color:#75715e"># /etc/hosts/手动添加解析</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">ip</span>: <span style="color:#e6db74">&#34;192.168.4.110&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hostnames</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;k8s.com&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:   	<span style="color:#75715e"># 必选，Pod中容器列表</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">restartPolicy</span>: [<span style="color:#ae81ff">Always、Never、OnFailure] </span> <span style="color:#75715e">#默认K8S-Pod的重启策略,此容器退出后立即创建一个相同容器</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nodeName</span>: <span style="color:#ae81ff">k8s-node1</span> <span style="color:#75715e"># NodeName表示将该Pod调度到指定到名称的node节点上</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nodeSelector</span>: <span style="color:#ae81ff">obeject</span> <span style="color:#75715e"># nodeSelector用于将Pod调度到添加了指定标签的Node节点上</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">imagePullSecrets</span>:  	<span style="color:#75715e"># 配置登录 docker registry 的 secret 仓库</span>
</span></span><span style="display:flex;"><span>     - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">docker-harbor  	# 指定使用的secret库房名称</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">hostNetwork</span>: <span style="color:#66d9ef">false</span>   <span style="color:#75715e">#是否使用主机网络模式，默认为false，如果设置为true，表示使用宿主机网络</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="replicasetrs类型控制器"><code>ReplicaSet(RS)</code>类型控制器</h3>
<blockquote>
<ul>
<li><code>ReplicaSet</code><!-- raw HTML omitted -->：主要作用是保证一定数量的<code>Pod</code>能够正常运行，它会持续监听这些<code>Pod</code>的运行状态，一旦<code>Pod</code>发生故障，就会重启或重建。同时它还支持对<code>Pod</code>数量的扩缩容和版本镜像的升级<!-- raw HTML omitted --></li>
<li><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/ReplicaSet/kubernetes-replicaset-template.yaml" rel="external" target="_self"><code>Kubernetes replicaset Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1    </span> <span style="color:#75715e"># 版本号 </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ReplicaSet       </span> <span style="color:#75715e"># 类型 </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:       <span style="color:#75715e"># 元数据 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">replicaset-template    </span> <span style="color:#75715e"># 名称、在一个名称空间内不能重复</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default   </span> <span style="color:#75715e"># 指定名称空间、默认defalut</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:       <span style="color:#75715e"># 标签 </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">replicaset-template</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:   <span style="color:#75715e"># 详情描述 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>   <span style="color:#75715e"># 指定副本数量，是rs创建出来的Pod的数量，默认为1.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:     <span style="color:#75715e"># 选择器，它的作用是建立Pod控制器和Pod之间的关联关系，采用了Label Selector机制（在Pod模块上定义Label，在控制器上定义选择器，就可以表明当前控制器能管理哪些Pod了）</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:        <span style="color:#75715e"># Labels匹配规则，matchExpressions：Expressions匹配规则</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">replicaset-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:     <span style="color:#75715e"># 模块 当副本数据不足的时候，会根据下面的模板创建Pod副本</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">replicaset-template</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx    </span> <span style="color:#75715e"># 容器名称</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1    </span> <span style="color:#75715e"># 容器需要的镜像地址</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>     <span style="color:#75715e"># 容器所监听的端口</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">100m</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">128Mi</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">50m</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">128Mi</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="horizontalpodautoscaler类型"><code>HorizontalPodAutoscaler</code>类型</h3>
<blockquote>
<ul>
<li><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/HPA/kubernetes-hpa-template.yaml" rel="external" target="_self"><code>Kubernetes HorizontalPodAutoscaler Template</code>模板</a></li>
</ul>
<blockquote>
<ul>
<li><code>deployment</code><!-- raw HTML omitted -->：类型控制器<!-- raw HTML omitted --></li>
<li><code>deployment-name</code><!-- raw HTML omitted -->：<code>Pod</code>的名称<!-- raw HTML omitted --></li>
<li><code>--cpu-percent</code><!-- raw HTML omitted -->：使用<code>CPU</code>百分比<!-- raw HTML omitted --></li>
<li><code>--min</code><!-- raw HTML omitted -->：<code>Pod</code>最少数量<!-- raw HTML omitted --></li>
<li><code>--max</code><!-- raw HTML omitted -->：<code>Pod</code>最多数量<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl autoscale deployment deployment-name --cpu-percent<span style="color:#f92672">=</span><span style="color:#ae81ff">50</span> --min<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> --max<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span></span></span></code></pre></div></blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">autoscaling/v2   </span> <span style="color:#75715e"># 版本号</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">HorizontalPodAutoscaler  </span> <span style="color:#75715e"># 类型</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:   <span style="color:#75715e"># 元数据 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default   </span> <span style="color:#75715e"># 指定名称空间、默认default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">hpa-template</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">minReplicas</span>: <span style="color:#ae81ff">2</span>   <span style="color:#75715e"># 最小Pod数量</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">maxReplicas</span>: <span style="color:#ae81ff">10</span>    <span style="color:#75715e"># 最大Pod数量</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">metrics</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">resource</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cpu  	# 扩缩容名称</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">averageUtilization</span>: <span style="color:#ae81ff">30</span>  	<span style="color:#75715e"># 设置CPU使用百分比，超过就扩容</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">type</span>: <span style="color:#ae81ff">Utilization  	# 利用率：Utilization，平均值：AverageValue：1k、1M、1G</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">Resource</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scaleTargetRef</span>:    <span style="color:#75715e"># 指定要控制Pod、Deployment信息</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">deployment-template</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">name</span>: <span style="color:#ae81ff">service-template</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">deployment-nginx-template</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  clusterIP: None       # 将clusterIP设置为None，即可创建headliness Service</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">NodePort       </span> <span style="color:#75715e"># Pod使用的IP类型：ClusterIP、NodePort</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>    <span style="color:#75715e"># Service的端口</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">80</span>      <span style="color:#75715e"># StatefulSet 的Pod端口</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1    </span> <span style="color:#75715e"># 版本号 </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment       </span> <span style="color:#75715e"># 类型 </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:       <span style="color:#75715e"># 元数据 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">deployment-template    </span> <span style="color:#75715e"># deployment的名称</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default   </span> <span style="color:#75715e"># 指定名称空间、默认default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:       <span style="color:#75715e"># 标签 </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">deployment-nginx-template</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:   <span style="color:#75715e"># 详情描述 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>   <span style="color:#75715e"># 副本数量 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">revisionHistoryLimit</span>: <span style="color:#ae81ff">3</span>       <span style="color:#75715e"># 保留历史版本，默认为10 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">paused</span>: <span style="color:#66d9ef">false</span>         <span style="color:#75715e"># 暂停部署，默认是false </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">progressDeadlineSeconds</span>: <span style="color:#ae81ff">600</span>          <span style="color:#75715e"># 部署超时时间（s），默认是600</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">strategy</span>:     <span style="color:#75715e"># pod更新策略，即如何替换已有的pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate        </span> <span style="color:#75715e"># 更新策略、支持 Recreate, RollingUpdate。默认RollingUpdate</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>:      <span style="color:#75715e"># 当type为RollingUpdate的时候生效，用于为rollingUpdate设置参数</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">30</span><span style="color:#ae81ff">%      </span> <span style="color:#75715e"># 用来指定在升级过程中不可用的Pod的最大数量，默认为25%。</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxSurge</span>: <span style="color:#ae81ff">30</span><span style="color:#ae81ff">%    </span> <span style="color:#75715e"># 用来指定在升级过程中可以超过期望的Pod的最大数量，默认为25%</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:     <span style="color:#75715e"># 选择器，通过它指定该控制器管理哪些pod </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:        <span style="color:#75715e"># Labels匹配规则，matchExpressions：Expressions匹配规则 </span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">deployment-nginx-template </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:     <span style="color:#75715e"># 模板，当副本数量不足时，会根据下面的模板创建pod副本 </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:   <span style="color:#75715e"># Pod 的标签</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">deployment-nginx-template</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:   <span style="color:#75715e"># Pod 的期望信息</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:   <span style="color:#75715e"># Pod 容器描述</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx  </span> <span style="color:#75715e"># 镜像名称</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent  </span> <span style="color:#75715e"># IfNotPresent：如果镜像不存在就拉取</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">100m</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">128Mi</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">50m</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">128Mi</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">restartPolicy</span>: <span style="color:#ae81ff">Always  </span> <span style="color:#75715e"># 重启策略，Always：代表一直重启</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">terminationGracePeriodSeconds</span>: <span style="color:#ae81ff">30</span>   <span style="color:#75715e"># 删除操作宽限时间</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="deploymentdeploy无状态类型"><code>Deployment(deploy)</code>无状态类型</h3>

<pre class="mermaid align-center zoomable">graph TD
A[&lt;p&gt;Deployment&lt;br&gt;seletor:env=dev] --&gt; A1((&lt;p&gt;Pod&lt;br&gt;label:env=dev))
A[&lt;p&gt;Deployment&lt;br&gt;seletor:env=dev] --&gt; A2((&lt;p&gt;Pod&lt;br&gt;label:env=dev))
A[&lt;p&gt;Deployment&lt;br&gt;seletor:env=dev] --&gt; A3((&lt;p&gt;Pod&lt;br&gt;label:env=dev))
    Z[Deployment控制Pod]  </pre><blockquote>
<ul>
<li><code>Deployment</code><!-- raw HTML omitted -->：为了更好的解决服务编排的问题，<!-- raw HTML omitted --><code>kubernetes</code>在<code>v1.2</code>版本开始，引入了<code>Deployment</code>控制器。值得一提的是，<code>Deployment</code>控制器并不直接管理<code>Pod</code>，而是通过管理<code>ReplicaSet</code>来间接管理<code>Pod</code>，即：<code>Deployment</code>管理<code>ReplicaSet</code>，<code>ReplicaSet</code>管理<code>Pod</code>。所以<code>Deployment</code>的功能比<code>ReplicaSet</code>强大</li>
<li>支持<code>ReplicaSet</code>的所有功能</li>
<li><!-- raw HTML omitted -->支持发布的停止、继续<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->支持版本滚动更新和版本回退<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>
<p><code>Recreate</code><!-- raw HTML omitted -->重建更新：在创建出新的<code>Pod</code>之前会先杀掉所有已经存在的<!-- raw HTML omitted --><code>Pod</code></p>
</li>
<li>
<p><code>RollingUpdate</code><!-- raw HTML omitted -->滚动更新：杀死一部分，就启动一部分，在更新过程中存在两个版本的<!-- raw HTML omitted --><code>Pod</code>，当<code>type</code>为<code>RollingUpdate</code>的时候生效，用于为<code>rollingUpdate</code>设置参数，  支持两个属性：</p>
</li>
<li>
<p><code>maxSurge</code><!-- raw HTML omitted -->：用来指定在升级过程中可以超过期望的<code>Pod</code>的最大数量，默认为25%<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>maxUnavailable</code><!-- raw HTML omitted -->：用来指定在升级过程中不可用的<code>Pod</code>的最大数量，默认为25%<!-- raw HTML omitted --></p>
</li>
</ul>
</blockquote>
<ul>
<li><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/Deployment/kubernetes-deployment-template.yaml" rel="external" target="_self"><code>Kubernetes Deployment Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1  	# 版本号 </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment  	# 类型 </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:  	<span style="color:#75715e"># 元数据 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">deployment-template  	# deployment的名称</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default  	# 指定名称空间、默认defalut</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:  	<span style="color:#75715e"># 标签 </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">deployment-nginx-template</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:  	<span style="color:#75715e"># 详情描述 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>  	<span style="color:#75715e"># 副本数量 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">revisionHistoryLimit</span>: <span style="color:#ae81ff">3</span>  	<span style="color:#75715e"># 保留历史版本，默认为10 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">paused</span>: <span style="color:#66d9ef">false</span>  	<span style="color:#75715e"># 暂停部署，默认是false </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">progressDeadlineSeconds</span>: <span style="color:#ae81ff">600</span>  	<span style="color:#75715e"># 部署超时时间（s），默认是600</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">strategy</span>:  	<span style="color:#75715e"># pod更新策略，即如何替换已有的pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>:  	<span style="color:#75715e"># 当type为RollingUpdate的时候生效，用于为rollingUpdate设置参数</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">30</span><span style="color:#ae81ff">%  	# 用来指定在升级过程中不可用的Pod的最大数量，默认为25%。</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxSurge</span>: <span style="color:#ae81ff">30</span><span style="color:#ae81ff">%  	# 用来指定在升级过程中可以超过期望的Pod的最大数量，默认为25%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate  	# 更新策略、支持 Recreate, RollingUpdate。默认RollingUpdate</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:  	<span style="color:#75715e"># 选择器，通过它指定该控制器管理哪些pod </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:  	<span style="color:#75715e"># Labels匹配规则，matchExpressions：Expressions匹配规则 </span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">deployment-nginx-template </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:  	<span style="color:#75715e"># 模板，当副本数量不足时，会根据下面的模板创建pod副本 </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:   <span style="color:#75715e"># Pod 的标签</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">deployment-nginx-template</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:   <span style="color:#75715e"># Pod 的期望信息</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:   <span style="color:#75715e"># Pod 容器描述</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx  </span> <span style="color:#75715e"># 镜像名称</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1    </span> <span style="color:#75715e"># fxgxxxxx/nginx:v1 在所有节点登录自己的 hub.docker.com 账户</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent  </span> <span style="color:#75715e"># IfNotPresent：如果镜像不存在就拉取</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">volumeMounts</span>:   <span style="color:#75715e"># 挂载到容器内部的存储卷配置</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx_vhosts   </span> <span style="color:#75715e"># 引用pod定义的共享存储卷的名称，需用volumes[]部分定义的的卷名</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/usr/local/nginx/conf/vhosts  </span> <span style="color:#75715e"># 存储卷在容器内mount的绝对路径，应少于512字符</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx_logs</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/usr/local/nginx/logs</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx_html</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">resources</span>:      <span style="color:#75715e"># 资源限制和请求的设置</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">limits</span>:   <span style="color:#75715e"># 限定Pod最大使用硬件资源、通常设置cpu和memory</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#e6db74">&#34;6&#34;</span>    <span style="color:#75715e"># Cpu的限制，单位为core数，将用于docker run --cpu-shares参数，1000m等于一个核心</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#e6db74">&#34;128Mi&#34;</span>     <span style="color:#75715e"># 内存限制，单位可以为Mib/Gib，将用于docker run --memory参数</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">requests</span>:     <span style="color:#75715e"># 最低资源要求，在scheduler中被用到，通常设置cpu和memory</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#e6db74">&#34;3&#34;</span>    <span style="color:#75715e"># 限定使用几个核心CPU、容器启动的初始可用数量</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#e6db74">&#34;64Mi&#34;</span>      <span style="color:#75715e"># 设定使用内存、容器启动的初始可用数量</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">restartPolicy</span>: <span style="color:#ae81ff">Always  </span> <span style="color:#75715e"># 重启策略，Always：代表一直重启</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">terminationGracePeriodSeconds</span>: <span style="color:#ae81ff">30</span>   <span style="color:#75715e"># 删除操作宽限时间</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumes</span>:      <span style="color:#75715e"># 在该pod上定义共享存储卷列表</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx_vhosts    </span> <span style="color:#75715e"># 共享存储卷名称 （volumes类型有很多种） </span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">hostPath</span>:   <span style="color:#75715e"># 类型为hostPath的存储卷，表示挂载Pod所在宿主机的目录</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/opt/data/nginx/vhosts</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">type</span>: <span style="color:#ae81ff">DirectoryOrCreate  </span> <span style="color:#75715e"># 目录存在就使用，不存在就先创建再使用</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx_logs</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">hostPath</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/opt/data/nginx/logs</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">type</span>: <span style="color:#ae81ff">DirectoryOrCreate</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx_html</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">hostPath</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/opt/data/nginx/html</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">type</span>: <span style="color:#ae81ff">DirectoryOrCreate</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">status</span>: {}</span></span></code></pre></div><ul>
<li>使用变量进行传参</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sed -e <span style="color:#e6db74">&#39;s#{REPLICAS}#1#g&#39;</span> -e <span style="color:#e6db74">&#39;s#{IMAGE}#myharbor.com:9527/test/IMAGE[:TAG_ID]#g&#39;</span> -e <span style="color:#e6db74">&#39;s#{JOB_NAME}#k8s-jd-core#g&#39;</span> -e <span style="color:#e6db74">&#39;s#{ENV}#dev#g&#39;</span> /opt/jenkins/deployment_yaml/k8s-deployment.tpl &gt; /opt/jenkins/deployment_yaml/k8s-wim-core-dev.yaml</span></span></code></pre></div><div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: {<span style="color:#ae81ff">JOB_NAME}-{ENV}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">simple-chat-{ENV}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: {<span style="color:#ae81ff">REPLICAS}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">k8s-app</span>: {<span style="color:#ae81ff">JOB_NAME}-{ENV}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">strategy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxSurge</span>: <span style="color:#ae81ff">10</span><span style="color:#ae81ff">%</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">90</span><span style="color:#ae81ff">%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">k8s-app</span>: {<span style="color:#ae81ff">JOB_NAME}-{ENV}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nodeSelector</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">deploy/env</span>: {<span style="color:#ae81ff">ENV}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: {<span style="color:#ae81ff">JOB_NAME}-{ENV}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: {<span style="color:#ae81ff">IMAGE}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/etc/localtime</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">volume-time</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">readOnly</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/app/.env.local</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">volume-env-{JOB_NAME}-{ENV}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">readOnly</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">subPath</span>: <span style="color:#ae81ff">.env.local</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">hostPath</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/usr/share/zoneinfo/Asia/Shanghai</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">type</span>: <span style="color:#ae81ff">File</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">volume-time</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">configMap</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">defaultMode</span>: <span style="color:#ae81ff">420</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">items</span>:
</span></span><span style="display:flex;"><span>              - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">app_env_local</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">path</span>: <span style="color:#ae81ff">.env.local</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">configmap-env-{JOB_NAME}-{ENV}</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">volume-env-{JOB_NAME}-{ENV}</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: {<span style="color:#ae81ff">JOB_NAME}-{ENV}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">simple-chat-{ENV}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">k8s-app</span>: {<span style="color:#ae81ff">JOB_NAME}-{ENV}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http-{JOB_NAME}-{ENV}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">generation</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: {<span style="color:#ae81ff">JOB_NAME}-ingress-{ENV}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">simple-chat-{ENV}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nginx.ingress.kubernetes.io/rewrite-target</span>: <span style="color:#ae81ff">/$2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ingressClassName</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: {<span style="color:#ae81ff">JOB_NAME}-ingress-{ENV}.com</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">name</span>: {<span style="color:#ae81ff">JOB_NAME}-{ENV}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">number</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/{JOB_NAME}(/|$)(.*)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">pathType</span>: <span style="color:#ae81ff">Prefix</span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="statefulset有状态类型"><code>StatefulSet</code>有状态类型</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->无状态应用定义<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>认为<code>Pod</code>都是一样的</li>
<li>没有顺序要求</li>
<li>不用考虑在哪个<code>Node</code>节点上运行</li>
<li>随意进行伸缩和扩展</li>
</ul>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->有状态应用定义<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>有顺序要求</li>
<li>认为每个<code>Pod</code>都是不一样的</li>
<li>需要考虑在哪个<code>Node</code>节点上运行</li>
<li>需要按照顺序进行伸缩和扩展</li>
<li>让每个<code>Pod</code>都是独立的，保持<code>Pod</code>启动顺序和唯一性</li>
</ul>
</blockquote>
<ul>
<li><code>StatefulSet</code> 是<code>Kubernetes</code><!-- raw HTML omitted -->提供的管理有状态应用的负载管理控制器<!-- raw HTML omitted --></li>
<li><code>StatefulSet</code><!-- raw HTML omitted -->常用来部署<!-- raw HTML omitted --><code>RabbitMQ</code>集群、<code>Zookeeper</code>集群、<code>MySQL</code>集群、<code>Eureka</code>集群等</li>
<li><code>StatefulSet</code><!-- raw HTML omitted -->部署需要<!-- raw HTML omitted --><code>HeadLinessService</code>（无头服务）</li>
</ul>
<blockquote>
<ul>
<li>在用<code>Deployment</code>时，每一个<code>Pod</code>名称是没有顺序的，是随机字符串，因此是<code>Pod</code>名称是无序的，但是在<code>StatefulSet</code>中要求必须是有序 ，每一个<code>Pod</code>不能被随意取代，<code>Pod</code>重建后<code>pod</code>名称还是一样的</li>
<li>而<code>Pod IP</code>是变化的，所以是以<code>Pod</code>名称来识别。<code>Pod</code>名称是<code>Pod</code>唯一性的标识符，必须持久稳定有效。这时候要用到<!-- raw HTML omitted -->无头服务<!-- raw HTML omitted -->，它可以给每个<code>Pod</code>一个唯一的名称</li>
</ul>
</blockquote>
<ul>
<li><code>Deployment</code>和<code>StatefulSet</code>区别：<code>Deployment</code><!-- raw HTML omitted -->没有唯一标识而<!-- raw HTML omitted --><code>StatefulSet</code>有唯一标识</li>
<li><code>StatefulSet</code><!-- raw HTML omitted -->唯一标识生成规则<!-- raw HTML omitted -->：  根据主机名+一定规则生成的：<!-- raw HTML omitted -->主机名.无头<!-- raw HTML omitted --><code>Service</code>名称.命名空间<code>.svc.cluster.local</code></li>
<li><code>StatefulSet</code><!-- raw HTML omitted -->控制器支持两种更新策略<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>OnDelete</code>： <code>OnDelete</code><!-- raw HTML omitted -->表示删除之后才更新<!-- raw HTML omitted --></li>
<li>(默认)<code>RollingUpdate</code>：<code>RollingUpdate</code><!-- raw HTML omitted -->表示滚动更新<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/StatefulSet/kubernetes-statefulset-template.yaml" rel="external" target="_self"><code>Kubernetes StatefulSet Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">name</span>: <span style="color:#ae81ff">service-template</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">statefulset-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">clusterIP</span>: <span style="color:#ae81ff">None      </span> <span style="color:#75715e"># 将clusterIP设置为None，即可创建headliness Service</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP  	# 类型：NodePort</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>    <span style="color:#75715e"># Service的端口</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">80</span>      <span style="color:#75715e"># StatefulSet 的Pod端口</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">StatefulSet</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">statefulset-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">service-template  </span> <span style="color:#75715e"># 使用那个Service管理DNS</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">updateStrategy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate        </span> <span style="color:#75715e"># 滚动更新，OnDelete：删除更新</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>:      <span style="color:#75715e"># 如果更新的策略是OnDelete，那么rollingUpdate就失效</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">partition</span>: <span style="color:#ae81ff">2</span>      <span style="color:#75715e"># 表示从第2个分区开始更新，默认是0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">statefulset-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">statefulset-template</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="daemonsetds守护进程类型"><code>DaemonSet(ds)</code>守护进程类型</h3>
<blockquote>
<ul>
<li>
<p><code>DaemonSet</code><!-- raw HTML omitted -->：控制器可以保证集群中的每一台（或指定）节点上都运行一个副本，一般适用于日志(<code>elk</code>)收集、节点监控(<code>zabbix</code>)等场景。也就是说，<!-- raw HTML omitted -->如果一个<code>Pod</code>提供的功能是节点级别的（每个节点都需要且只需要一个），那么这类<code>Pod</code>就适合使用<code>DaemonSet</code>类型的控制器创建</p>
</li>
<li>
<p><code>DaemonSet</code><!-- raw HTML omitted -->控制器的特点<!-- raw HTML omitted --></p>
<p><!-- raw HTML omitted -->  每向集群中添加一个节点的时候，<!-- raw HTML omitted -->指定的<code>Pod</code>副本也将添加到该节点上</p>
<p><!-- raw HTML omitted -->当节点从集群中移除的时候，<!-- raw HTML omitted --><code>Pod</code>也会被垃圾回收</p>
</li>
<li>
<p><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/DaemonSet/kubernetes-daemonset-template.yaml" rel="external" target="_self"><code>Kubernetes DaemonSet Template</code>模板</a></p>
</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1  </span> <span style="color:#75715e"># 版本号</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">DaemonSet        </span> <span style="color:#75715e"># 类型</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:       <span style="color:#75715e"># 元数据</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fluentd-daemonset      </span> <span style="color:#75715e"># Pod 名称</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default   </span> <span style="color:#75715e"># 指定名称空间、默认default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:       <span style="color:#75715e"># 标签</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#39;fluentd-es&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:   <span style="color:#75715e"># Pod 详情描述</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">revisionHistoryLimit</span>: <span style="color:#ae81ff">3</span>       <span style="color:#75715e"># 保留历史版本、默认为最大值(2^32)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">updateStrategy</span>:       <span style="color:#75715e"># 更新策略</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate        </span> <span style="color:#75715e"># 滚动更新策略</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>:      <span style="color:#75715e"># 滚动更新</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">1</span>         <span style="color:#75715e"># 最大不可用状态的Pod的最大值，可用为百分比，也可以为整数</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:     <span style="color:#75715e"># 选择器，通过它指定该控制器管理那些Pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels:        # Labels匹配规则，matchExpressions</span>: <span style="color:#ae81ff">匹配规则</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#39;fluentd-es&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:     <span style="color:#75715e"># 模板，当副本数量不足时，会根据下面的模板创建Pod模板</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#39;fluentd-es&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fluentd-es</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">agilestacks/fluentd-elasticsearch:v1.3.0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">env</span>:    <span style="color:#75715e"># 环境变量配置</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">FLUENTD_ARGS   </span> <span style="color:#75715e"># 环境变量的 key</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">value</span>: -<span style="color:#ae81ff">qq   </span> <span style="color:#75715e"># 环境变量的 value</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">volumeMounts</span>:   <span style="color:#75715e"># 加载数据卷 避免数据丢失</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">containers     </span> <span style="color:#75715e"># 数据卷名称</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/lib/docker/containers        </span> <span style="color:#75715e"># 将数据卷挂载到容器内那个目录</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">varlog</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/log</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumes</span>:          <span style="color:#75715e"># 定义数据卷</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">containers       </span> <span style="color:#75715e"># 定义数据卷的名称</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">hostPath</span>:       <span style="color:#75715e"># 数据卷类型，主机路径模式</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/var/lib/docker/containers     </span> <span style="color:#75715e"># node 中共享目录</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">varlog</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">hostPath</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/var/log</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="service类型控制器"><code>Service</code>类型控制器</h3>
<blockquote>
<ul>
<li>在<code>kubernetes</code>中，<code>Pod</code>是应用程序的载体，我们可以通过<code>Pod</code>的<code>IP</code>来访问应用程序，但是<code>Pod</code>的<code>IP</code>地址不是固定的，这就意味着不方便直接采用<code>Pod</code>的<code>IP</code>对服务进行访问</li>
<li>为了解决这个问题，<code>kubernetes</code>提供了<code>Service</code>资源，<code>Service</code>会对提供同一个服务的多个<code>Pod</code>进行聚合，并且提供一个统一的入口地址，通过访问<code>Service</code>的入口地址就能访问到后面的<code>Pod</code>服务</li>
<li><code>Service</code>在很多情况下只是一个概念：真正起作用的其实是<code>kube-proxy</code>服务进程，每个<code>Node</code>节点上都运行了一个<code>kube-proxy</code>的服务进程。当创建<code>Service</code>的时候会通过<code>API Server</code>向<code>etcd</code>写入创建的Service的信息，而<code>kube-proxy</code>会基于监听的机制发现这种<code>Service</code>的变化，然后它会将最新的<code>Service</code>信息转换为对应的访问规则</li>
<li>假如：<code>10.97.97.97:80</code>是<code>service</code>提供的访问入口：当访问这个入口的时候，可以发现后面有三个<code>pod</code>的服务在等待调用，<code>kube-proxy</code>会基于<code>rr</code>（轮询）的策略，将请求分发到其中一个<code>pod</code>上去，这个规则会同时在集群内的所有节点上都生成，所以在任何一个节点上访问都可以</li>
<li><code>ClusterIP</code><!-- raw HTML omitted -->默认值：它是<code>kubernetes</code>系统自动分配的虚拟<code>IP</code>(<code>VIP</code>)，只能在集群内部（所有<code>Node</code>节点）访问<!-- raw HTML omitted --></li>
<li><code>NodePort</code><!-- raw HTML omitted -->：将<code>Service</code>通过指定的<code>Node</code>上的端口暴露给外部，通过此方法，就可以在集群外部访问（使用浏览器域名或<code>IP</code>端口访问）服务<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>创建的<code>Service</code>的<code>IP</code>地址只能在集群内部才可以访问，如果希望<code>Service</code>暴露给集群外部使用，那么就需要使用到另外一种类型的<code>Service</code>，称为<code>NodePort</code>类型的<code>Service</code>。<code>NodePort</code>的工作原理就是将<code>Service</code>的端口映射到<code>Node</code>的一个端口上，然后就可以通过<code>NodeIP:NodePort</code>来访问<code>Service</code>了</li>
</ul>
</blockquote>
<ul>
<li><code>LoadBalancer</code><!-- raw HTML omitted -->：使用外接负载均衡器完成到服务的负载分发，注意此模式需要外部云环境的支持<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code> LoadBalancer</code>和<code>NodePort</code>很相似，目的都是向外部暴露一个端口，区别在于<code>LoadBalancer</code>会在集群的外部再来做一个负载均衡设备，而这个设备需要外部环境的支持，外部服务发送到这个设备上的请求，会被设备负载之后转发到集群中</li>
</ul>
</blockquote>
<ul>
<li><code>ExternalName</code><!-- raw HTML omitted -->：把集群外部的服务引入集群内部，直接使用<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>ExternalName</code>类型的<code>Service</code>用于引入集群外部的服务，它通过<code>externalName</code>属性指定一个服务的地址，然后在集群内部访问此<code>Service</code>就可以访问到外部的服务了</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl explain service.spec.type  	<span style="color:#75715e"># </span></span></span></code></pre></div></blockquote>
<ul>
<li><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/Service/kubernetes-service-template.yaml" rel="external" target="_self"><code>Kubernetes Service Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1         </span> <span style="color:#75715e"># 版本</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service  </span> <span style="color:#75715e"># 类型</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:       <span style="color:#75715e"># 元数据</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">service-template       </span> <span style="color:#75715e"># Service 名字</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default   </span> <span style="color:#75715e"># 命名空间</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx        </span> <span style="color:#75715e"># Service 自己本身的标签</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:     <span style="color:#75715e"># 标签选择器，用于确定当前Service代理那些Pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-deploymen      </span> <span style="color:#75715e"># 所有匹配到这些标签的Pod 都可以进行访问</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">NodePort       </span> <span style="color:#75715e"># 指定Service的类型访问方式、ClusterIP、NodePort、ExternalName，NodePort支持集群外部访问，启用ingress设置：ClusterIP</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">externalName</span>: <span style="color:#ae81ff">www.baidu.com  </span> <span style="color:#75715e"># 改成IP地址也可以,只有type类型为：ExternalName，域名配置才生效</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">clusterIP</span>: <span style="color:#ae81ff">10.64.0.47</span>        <span style="color:#75715e"># 定service IP，不指定就随机生成，启用ingress设置为：None</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">sessionAffinity</span>: <span style="color:#ae81ff">None     </span> <span style="color:#75715e"># 分发策略、session亲和性，支持ClientIP、None两个选项，默认值为None</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:        <span style="color:#75715e"># 端口映射信息</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>          <span style="color:#75715e"># Service 端口，在使用内网IP访问时使用</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP      </span> <span style="color:#75715e"># 协议</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort </span>: <span style="color:#ae81ff">80</span>     <span style="color:#75715e"># 目标Pod端口，例如：deployment、statefulset等，Nginx：80，Tomcat：8080</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nodePort</span>: <span style="color:#ae81ff">30002</span>     <span style="color:#75715e"># 绑定到node主机上的端口(端口使用范围：30000~32767)，如果不指定，会默认分配，启用ingress删除此行</span></span></span></code></pre></div><ul>
<li><code>kube-proxy</code>目前支持的三种工作模式</li>
<li><code>userspace</code><!-- raw HTML omitted -->模式<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>userspace</code>模式下，<code>kube-proxy</code>会为每一个<code>Service</code>创建一个监听端口，发向<code>Cluster IP</code>的请求被<code>iptables</code>规则重定向到<code>kube-proxy</code>监听的端口上，<code>kube-proxy</code>根据<code>LB</code>算法（负载均衡算法）选择一个提供服务的<code>Pod</code>并和其建立连接，以便将请求转发到<code>Pod</code>上</li>
<li><code>userspace</code>模式下，<code>kube-proxy</code>充当了一个四层负载均衡器的角色。由于<code>kube-proxy</code>运行在<code>userspace</code>中，在进行转发处理的时候会增加内核和用户空间之间的数据拷贝，虽然比较稳定，但是效率非常低下</li>
</ul>
</blockquote>
<ul>
<li><code>iptables</code><!-- raw HTML omitted -->模式<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>iptables</code>模式下，<code>kube-proxy</code>为<code>Service</code>后端的每个<code>Pod</code>创建对应的<code>iptables</code>规则，直接将发向<code>Cluster IP</code>的请求重定向到一个<code>Pod</code>的<code>IP</code>上</li>
<li><code>iptables</code>模式下<code>kube-proxy</code>不承担四层负载均衡器的角色，只负责创建<code>iptables</code>规则。该模式的优点在于较<code>userspace</code>模式效率更高，但是不能提供灵活的<code>LB</code>策略，当后端<code>Pod</code>不可用的时候无法进行重试</li>
</ul>
</blockquote>
<ul>
<li><code>ipvs</code><!-- raw HTML omitted -->模式<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>
<p><code>ipvs</code>模式和<code>iptables</code>类似，<code>kube-proxy</code>监控<code>Pod</code>的变化并创建相应的<code>ipvs</code>规则。<code>ipvs</code>相对<code>iptables</code>转发效率更高，除此之外，<code>ipvs</code>支持更多的<code>LB</code>算法</p>
</li>
<li>
<p><code>ipvs</code><!-- raw HTML omitted -->的映射规则，<code>rr</code>表示轮询<!-- raw HTML omitted --></p>
</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ipvsadm -Ln  	<span style="color:#75715e"># 查看kube-proxy工作模式</span></span></span></code></pre></div></blockquote>
<ul>
<li>对<code>Service</code>的访问被分发到了后端的<code>Pod</code>上去，目前<code>kubernetes</code>提供了<!-- raw HTML omitted -->两种负载分发<!-- raw HTML omitted -->策略</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->默认使用<code>kube-proxy</code>的策略，比如随机、轮询等<!-- raw HTML omitted --></li>
<li><code>sessionAffinity</code>：基于客户端地址的会话保持模式，即来自同一个客户端发起的所有请求都会转发到固定的一个<code>Pod</code>上，这对于传统基于<code>Session</code>的认证项目来说很友好，此模式可以在<code>spec</code>中添加<code>sessionAffinity: ClusterIP</code>选项</li>
</ul>
</blockquote>
<ul>
<li><code>HeadLiness</code>类型负载均的<code>Service</code></li>
</ul>
<blockquote>
<ul>
<li>在某些场景中，开发人员可能不想使用<code>Service</code>提供的负载均衡功能，而希望自己来控制负载均衡策略，针对这种情况，<code>kubernetes</code>提供了<code>HeadLinesss Service</code>，这类<code>Service不</code>会分配<code>Cluster IP</code>，如果想要访问<code>Service</code>，只能通过<code>Service</code>的域名进行查询</li>
<li><code>clusterIP: None</code>：将<code>clusterIP</code>设置为<code>None</code>，即可创建<code>headliness Service</code></li>
</ul>
</blockquote>
</blockquote>
<hr>
<h3 id="endpoint类型控制器"><code>Endpoint</code>类型控制器</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->实际中使用的不多<!-- raw HTML omitted --></li>
<li><code>Endpoint</code>：是<code>kubernete</code>中的一个资源对象，存储在<code>etcd</code>中，用来记录一个<code>service</code>对应的所有<code>Pod</code>的访问地址，它是根据<code>service</code>配置文件中的<code>selector</code>描述产生的</li>
<li>一个<code>service</code>由一组<code>Pod</code>组成，这些<code>Pod</code>通过<code>Endpoints</code>暴露出来，<code>Endpoints</code>是实现实际服务的端点集合。换言之<code>servic</code>和<code>Pod</code>之间的联系是通过<code>Endpoints</code>实现的</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl describe svc nginx-service -n app  
</span></span><span style="display:flex;"><span>$ kubectl get endpoints -n dev -o wide  </span></span></code></pre></div><ul>
<li><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/EndPoint/kubernetes-endpoint-template.yaml" rel="external" target="_self"><code>Kubernetes Endpoint Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Endpoints</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">endpoints-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx        </span> <span style="color:#75715e"># 标签和Service 里的labels一致</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subsets</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">addresses</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">ip</span>: <span style="color:#ae81ff">23.41.187.94</span>    <span style="color:#75715e"># 目标IP地址</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:        <span style="color:#75715e"># 与 Service一致</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1         </span> <span style="color:#75715e"># 版本</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service  </span> <span style="color:#75715e"># 类型</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:       <span style="color:#75715e"># 元数据</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">service-template       </span> <span style="color:#75715e"># Service 名字</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default   </span> <span style="color:#75715e"># 命名空间</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx        </span> <span style="color:#75715e"># Service 自己本身的标签</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP       </span> <span style="color:#75715e"># 指定Service的类型访问方式、ClusterIP、NodePort、ExternalName</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">sessionAffinity</span>: <span style="color:#ae81ff">None        </span> <span style="color:#75715e"># 分发策略、session亲和性，支持ClientIP、None两个选项，默认值为None</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:        <span style="color:#75715e"># 端口映射信息</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>          <span style="color:#75715e"># Service 端口，在使用内网IP访问时使用</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP      </span> <span style="color:#75715e"># 协议</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort </span>: <span style="color:#ae81ff">80</span>     <span style="color:#75715e"># 目标Pod端口，例如：deployment、statefulset等</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="job类型控制器"><code>Job</code>类型控制器</h3>
<blockquote>
<ul>
<li><code>Job</code><!-- raw HTML omitted -->主要用于负责批量处理短暂的一次性任务<!-- raw HTML omitted --></li>
<li><code>Job</code><!-- raw HTML omitted -->特点<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>当<code>Job</code>创建的<code>Pod</code>执行成功结束时，<code>Job</code>将记录成功结束的<code>Pod</code>数量</li>
<li>当成功结束的<code>Pod</code>达到指定的数量时，<code>Job</code>将完成执行</li>
</ul>
</blockquote>
<ul>
<li><code>Job</code><!-- raw HTML omitted -->模板使用重启策略定义<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->设置为：<!-- raw HTML omitted --><code>OnFailure</code>，<code> Job</code>会在<code>Pod</code>出现故障的时候重启容器，而不是创建<code>Pod</code>，<code>failed</code>次数不变</li>
<li><!-- raw HTML omitted -->设置为：<!-- raw HTML omitted --><code>Never</code>，<code>Job</code>会在<code>Pod</code>出现故障的时候创建新的<code>Pod</code>，并且故障<code>Pod</code>不会消失也不会重启，<code>failed</code>次数+1</li>
<li><!-- raw HTML omitted -->设置为：<!-- raw HTML omitted --><code>Always</code>，意味<code>Job</code>一直重启，意味<code>Pod</code>任务会重复执行，这和<code>Job</code>的定义冲突，所以不能设置为<code>Always</code></li>
</ul>
</blockquote>
<ul>
<li><code>Job</code><!-- raw HTML omitted -->资源清单<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">batch/v1  	# 版本号</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Job  	# 类型</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:  	<span style="color:#75715e"># 元数据</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">name</span>: <span style="color:#ae81ff">job-template  	# 名称</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">namespace</span>:  <span style="color:#ae81ff">default  	# 命名空间</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">labels</span>:  	<span style="color:#75715e"># 标签</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">controller</span>: <span style="color:#ae81ff">job</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:  	<span style="color:#75715e"># 详情描述</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">completions</span>: <span style="color:#ae81ff">1</span>  	<span style="color:#75715e"># 指定Job需要成功运行Pod的总次数，默认为1</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">parallelism</span>: <span style="color:#ae81ff">1</span>  	<span style="color:#75715e"># 指定Job在任一时刻应该并发运行Pod的数量，默认为1</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">activeDeadlineSeconds</span>: <span style="color:#ae81ff">30</span>  	<span style="color:#75715e"># 指定Job可以运行的时间期限，超过时间还没结束，系统将会尝试进行终止</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">backoffLimit</span>: <span style="color:#ae81ff">6</span>  	<span style="color:#75715e"># 指定Job失败后进行重试的次数，默认为6</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">manualSelector</span>: <span style="color:#66d9ef">true</span>  	<span style="color:#75715e"># 是否可以使用selector选择器选择Pod，默认为false</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">selector</span>:  	<span style="color:#75715e"># 选择器，通过它指定该控制器管理那些Pod</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">matchLabels</span>:  	<span style="color:#75715e"># Labels匹配规则</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">app</span>: <span style="color:#ae81ff">counter-pod</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">matchExpressions</span>:  	<span style="color:#75715e"># Expressions匹配规则</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">app</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">In</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">values</span>:
</span></span><span style="display:flex;"><span>              - <span style="color:#ae81ff">counter-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">template</span>:  	<span style="color:#75715e"># 模板，当副本数量不足时，会根据下面的模板创建Pod模板</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">app</span>: <span style="color:#ae81ff">counter-pod</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">restartPolicy</span>: <span style="color:#ae81ff">Never  	# 重启策略只能设置为Never或OnFailure</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>                - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">counter</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;for i in 9 8 7 6 5 4 3 2 1;do echo $i;sleep 20;done&#34;</span>]</span></span></code></pre></div></blockquote>
<hr>
<h3 id="cronjob类型控制器"><code>CronJob</code>类型控制器</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted --><code>CronJob</code>控制器<!-- raw HTML omitted -->：以<code>Job</code>控制器为其管控对象，并借助它管理<code>Pod</code>资源对象，<code>Job</code>控制器定义的作业任务在其控制器资源创建之后便会立即执行，但<code>CronJob</code>可以以类似<code>Linux</code>操作系统的周期性任务作业计划的方式控制器运行时间点及重复运行的方式，换言之，<code>CronJob</code>可以在特定的时间点反复去执行<code>Job</code>任务</li>
<li><code>schedule：cron</code><!-- raw HTML omitted -->表达式，用于指定任务的执行时间<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>/1  *</code><!-- raw HTML omitted -->：表示分钟  小时  日  月份  星期<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->分钟值从<code>0</code>到<!-- raw HTML omitted --><code>59</code></li>
<li><!-- raw HTML omitted -->小时值从<code>0</code>到<!-- raw HTML omitted --><code>23</code></li>
<li><!-- raw HTML omitted -->日(天)的值从<code>1</code>到<!-- raw HTML omitted --><code>31</code></li>
<li><!-- raw HTML omitted -->月的值从<code>1</code>到<!-- raw HTML omitted --><code>12</code></li>
<li><!-- raw HTML omitted -->星期的值从<code>0</code>到<code>6</code>，<!-- raw HTML omitted --><code>0</code><!-- raw HTML omitted -->表示星期日<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->多个时间可以用逗号隔开，范围可以用连字符给出：* 可以作为通配符，/表示每&hellip;<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li><code>concurrencyPolicy</code><!-- raw HTML omitted -->并发执行策略<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>Allow</code><!-- raw HTML omitted -->：运行<code>Job</code>并发调度（默认）<!-- raw HTML omitted --></li>
<li><code>Forbid</code><!-- raw HTML omitted -->：禁止并发运行，如果之前的任务没完成，则跳过，直接执行新的<!-- raw HTML omitted --></li>
<li><code>Replace</code><!-- raw HTML omitted -->：替换，取消当前正在运行的作业并使用新作业替换它<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/kubernetes-cronjob-template.yaml" rel="external" target="_self"><code>Kubernetes CronJob Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">batch/v1   </span> <span style="color:#75715e"># 版本号</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">CronJob  </span> <span style="color:#75715e"># 类型</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:       <span style="color:#75715e"># 元数据</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cronjob-template       </span> <span style="color:#75715e"># 名称</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default   </span> <span style="color:#75715e"># 命名空间</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">controller</span>: <span style="color:#ae81ff">cronjob</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:   <span style="color:#75715e"># 详情描述</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">concurrencyPolicy</span>: <span style="color:#ae81ff">Allow   </span> <span style="color:#75715e"># 并发执行策略，Allow：并发调度，</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">failedJobsHistoryLimit</span>: <span style="color:#ae81ff">1</span>   <span style="color:#75715e"># 保留多少个失败的任务，默认为1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">successfulJobsHistoryLimit</span>: <span style="color:#ae81ff">3</span>   <span style="color:#75715e"># 保留多少个成功的任务，默认为3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># startingDeadlineSeconds: 30   # 间隔多长时间检测失败的任务并重新执行，时间不能小于：10</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">suspend</span>: <span style="color:#66d9ef">false</span>    <span style="color:#75715e"># 是否挂起任务，若为：true 则该任务不执行</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">schedule</span>: <span style="color:#e6db74">&#34;*/1 * * * * &#34;</span>    <span style="color:#75715e"># cron格式的作业调度运行时间点，用于控制任务任务时间执行</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">jobTemplate</span>:          <span style="color:#75715e"># job控制器模板，用于为cronjob控制器生成job对象，下面其实就是job的定义</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">completions</span>: <span style="color:#ae81ff">1</span>    <span style="color:#75715e"># 指定Job需要成功运行Pod的总次数，默认为1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">parallelism</span>: <span style="color:#ae81ff">1</span>    <span style="color:#75715e"># 指定Job在任一时刻应该并发运行Pod的数量，默认为1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">activeDeadlineSeconds</span>: <span style="color:#ae81ff">30</span>         <span style="color:#75715e"># 指定Job可以运行的时间期限，超过时间还没结束，系统将会尝试进行终止</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">backoffLimit</span>: <span style="color:#ae81ff">6</span>   <span style="color:#75715e"># 指定Job失败后进行重试的次数，默认为6</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">template</span>:         <span style="color:#75715e"># 模板，当副本数量不足时，会根据下面的模板创建Pod模板</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">restartPolicy</span>: <span style="color:#ae81ff">Never         </span> <span style="color:#75715e"># 重启策略只能设置为Never或OnFailure</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">container-name</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">command</span>: [ <span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;for i in 9 8 7 6 5 4 3 2 1;do echo $i;sleep 20;done&#34;</span> ]</span></span></code></pre></div></blockquote>
<hr>
<h3 id="模板详细描述">模板详细描述</h3>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/bitnami/" rel="external" target="_self"><code>Bitnami</code>模板库</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/bitnami/charts/tree/main/bitnami" rel="external" target="_self"><code>Kubernetes</code>的<code>Bitnami</code>库</a></td>
<td><code>Helm</code>安装<code>Kubernetes</code>服务<code>Zabbix</code>、<code>Redis</code>、<code>Mysql</code>模板</td>
</tr>
<tr>
<td><a href="https://github.com/bitnami/charts-docs/tree/main/charts" rel="external" target="_self"><code>Kubernetes</code>的<code>Charts-docs</code>库</a></td>
<td><code>Helm</code>安装<code>Kubernetes</code>服务<code>Zabbix</code>、<code>Redis</code>、<code>Mysql</code>模板</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/kubernetes-template.yaml" rel="external" target="_self"><code>Kubernetes Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1   </span> <span style="color:#75715e"># 版本号，例如v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment   </span> <span style="color:#75715e"># 资源类型，例如 Pod、Deployment、Service、ReplicaSet、StatefulSet</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:   <span style="color:#75715e"># POd相关的元数据，用于描述Pod数据</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">java-demo  </span> <span style="color:#75715e"># Pod名称、在同一个名称空间内不能重复</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">string  </span> <span style="color:#75715e"># Pod所属的命名空间,默认为&#34;default&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:   <span style="color:#75715e"># 定义Pod的标签，只能使用字符串类型：string</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">java-demo  </span> <span style="color:#75715e"># 自定义label标签，key(键)为：name，value(值)为：java-demo</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v1.1.0  </span> <span style="color:#75715e"># 自定义版本</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">annotations</span>:    <span style="color:#75715e"># 注释，不能作为被筛选</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">java-demo</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:   <span style="color:#75715e"># Pod中容器的详细定义</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>   <span style="color:#75715e"># 创建的副本数量</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">revisionHistoryLimit</span>: <span style="color:#ae81ff">10</span>    <span style="color:#75715e"># 滚动更新后保留的历史版本数</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:   <span style="color:#75715e"># 选择器，用于找到匹配的 ReplicaSet(副本)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:    <span style="color:#75715e"># 按照Labels标签匹配副本</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">java-demo  </span> <span style="color:#75715e"># 匹配的key，value</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v1.1.0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">strategy</span>:   <span style="color:#75715e"># 更新策略，StatefulSet更新使用：updateStrategy</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>:    <span style="color:#75715e"># 滚动更新配置</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">partition</span>: <span style="color:#ae81ff">3</span>    <span style="color:#75715e"># 实现灰度/金丝雀发布，按序号更新，更新大于等于3的序号，不和百分比共用</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxSurge</span>: <span style="color:#ae81ff">25</span><span style="color:#ae81ff">%  </span> <span style="color:#75715e"># 多少个/百分之多少Pods处于更新，数值越大更新越快，不稳定</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">25</span><span style="color:#ae81ff">%  </span> <span style="color:#75715e"># 多少个/百分之多少Pods处于关闭，数值越小更新慢，稳定</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate  </span> <span style="color:#75715e"># 更新类型选择器，采用滚动更新，OnDelete：方式更新，删除pods时更新</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:   <span style="color:#75715e"># Pod 模板</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:   <span style="color:#75715e"># Pod 的元信息</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:   <span style="color:#75715e"># Pod 的标签 </span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">java-demo</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v1.1.0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:   <span style="color:#75715e"># Pod的期望信息</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nodeName</span>: <span style="color:#ae81ff">k8s-node1  </span> <span style="color:#75715e"># 设置NodeName表示将该Pod调度到指定到名称的node节点上</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nodeSelector</span>: <span style="color:#ae81ff">obeject  </span> <span style="color:#75715e"># 设置NodeSelector表示将该Pod调度到包含这个label的node上</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">hostNetwork</span>: <span style="color:#66d9ef">false</span>    <span style="color:#75715e"># 是否使用主机网络模式，默认为false，如果设置为true，表示使用宿主机网络</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">tolerations</span>:  	<span style="color:#75715e"># 容忍配置</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">effect</span>: <span style="color:#e6db74">&#34;污点的类型&#34;</span>  <span style="color:#75715e"># Noschedule</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">key</span>: <span style="color:#e6db74">&#34;污点的Key&#34;</span>  	<span style="color:#75715e"># 污点的Key</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">operate</span>: <span style="color:#e6db74">&#34;Equal&#34;</span>  	<span style="color:#75715e"># Exists：匹配Key，Equal添加：value配置，</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;污点的value&#34;</span>  	<span style="color:#75715e"># 污点的value</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullSecrets</span>:   <span style="color:#75715e"># 配置登录 docker registry 的 secret 仓库</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">docker-harbor  </span> <span style="color:#75715e"># 指定使用的secret库房名称</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:   <span style="color:#75715e"># 对于 Pod中容器描述</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">tomcat-demo  </span> <span style="color:#75715e"># 指定容器名称，不可更新</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">192.168.80.210</span>:<span style="color:#ae81ff">8080</span><span style="color:#ae81ff">/test/tomcat-demo:v1   </span> <span style="color:#75715e"># 镜像仓库地址</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">imagePullPolicy</span>: [ <span style="color:#ae81ff">Always | Never | IfNotPresent ]   </span> <span style="color:#75715e"># 镜像拉取方式</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">securityContext</span>: 
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">privileged</span>: <span style="color:#66d9ef">true</span>  <span style="color:#75715e"># 启用特权模式，允许容器访问主机资源</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">runAsUser</span>: <span style="color:#ae81ff">0</span>       <span style="color:#75715e"># 以 root 用户运行容器（0 是 root 用户的 UID）</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">allowPrivilegeEscalation</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">readOnlyRootFilesystem</span>: <span style="color:#66d9ef">false</span> 	<span style="color:#75715e"># 允许容器具有读写文件系统权限</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">capabilities</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">add</span>: 
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">SYS_ADMIN </span> <span style="color:#75715e"># 添加特定的 Linux 能力</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">securityContext</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">runAsNonRoot</span>: <span style="color:#66d9ef">false</span>  <span style="color:#75715e"># 允许容器以 root 用户运行</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">command</span>: [<span style="color:#ae81ff">string]  </span> <span style="color:#75715e"># 以数组方式指定容器启动命令列表，如不指定，使用打包时使用的启动命令</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">args</span>:   <span style="color:#75715e"># 以数组方式指定容器启动命令参数列表，替代docker的CMD指令</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">/bin/sh</span>
</span></span><span style="display:flex;"><span>        - -<span style="color:#ae81ff">c</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">touch /tmp/healthy; sleep 30; rm -fr /tmp/healthy; sleep 600   </span> <span style="color:#75715e"># 不能超过探针执行时间</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">workingDir</span>: <span style="color:#ae81ff">string   </span> <span style="color:#75715e"># 容器启动后进入的工作目录，不指定则使用镜像默认值</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">volumeMounts</span>:   <span style="color:#75715e"># 挂载到容器内部的存储卷配置</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">data   </span> <span style="color:#75715e"># 引用pod定义的共享存储卷的名称，需用volumes[]部分定义的的卷名</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/opt/data   </span> <span style="color:#75715e"># 存储卷在容器内mount的绝对路径，应少于512字符</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">readOnly</span>: <span style="color:#ae81ff">boolean  </span> <span style="color:#75715e"># 是否为只读模式</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:    <span style="color:#75715e"># 需要暴露的端口库号列表</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http   </span> <span style="color:#75715e"># 为端口取名，该名称可以在service种被引用</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">int   </span> <span style="color:#75715e"># 容器需要监听的端口号</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">hostPort</span>: <span style="color:#ae81ff">int  </span> <span style="color:#75715e"># 容器所在主机需要监听的端口号，默认与Container相同</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP  </span> <span style="color:#75715e"># 端口协议，支持TCP和UDP，默认TCP</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">80</span>    <span style="color:#75715e"># Pod 本身服务端口，比如Nginx：80，Tomcat：8080</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">nodePort</span>: <span style="color:#ae81ff">30001</span>   <span style="color:#75715e"># 节点对外端口</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">env</span>:    <span style="color:#75715e"># 容器运行前需设置的环境变量列表</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">JAVA_OPTS  </span> <span style="color:#75715e"># 环境变量名称</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;-Xmx1g&#34;</span>   <span style="color:#75715e"># 环境变量的值</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">resources</span>:    <span style="color:#75715e"># 资源限制和请求的设置</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">limits</span>:   <span style="color:#75715e"># 限定Pod最大使用硬件资源、通常设置cpu和memory</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#e6db74">&#34;1&#34;</span>    <span style="color:#75715e"># Cpu的限制，单位为core数，将用于docker run --cpu-shares参数，1000m等于一个核心</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#e6db74">&#34;1Gi&#34;</span>   <span style="color:#75715e"># 内存限制，单位可以为Mib/Gib，将用于docker run --memory参数</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">requests</span>:   <span style="color:#75715e"># 最低资源要求，在scheduler中被用到，通常设置cpu和memory</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#e6db74">&#34;0.5&#34;</span>    <span style="color:#75715e"># 限定使用几个核心CPU、容器启动的初始可用数量</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#e6db74">&#34;256Mi&#34;</span>   <span style="color:#75715e"># 设定使用内存、容器启动的初始可用数量</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">lifecycle</span>:    <span style="color:#75715e"># 生命周期钩子</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">postStart</span>:    <span style="color:#75715e"># 容器启动后立即执行此钩子,如果执行失败,会根据重启策略进行重启</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">exec</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;echo Hello from the postStart handler &gt;/usr/share/message&#34;</span>]
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">preStop</span>:    <span style="color:#75715e"># 容器终止前执行此钩子,无论结果如何,容器都会终止</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">exec</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;nginx -s quit; while killall -0 nginx; do sleep 1; done&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">startupProbe</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">tcpSocket</span>:    <span style="color:#75715e"># 使用TcpSocket、httpGet健康检查</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8010</span>    <span style="color:#75715e"># 探测8010端口</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">5</span>   <span style="color:#75715e"># 检测失败5次表示未就绪</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">60</span>   <span style="color:#75715e"># 指定容器启动60s之后开始执行Liveness探测，</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>   <span style="color:#75715e"># 指定每10秒执行一次Liveness探测。</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>   <span style="color:#75715e"># 检查成功为2次表示就绪</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span>   <span style="color:#75715e"># 检测失败1次表示未就绪</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">livenessProbe</span>:    <span style="color:#75715e"># 对Pod内各容器健康检查的设置，当探测无响应几次后将自动重启该容器</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">exec</span>:   <span style="color:#75715e"># 对Pod容器内检查方式设置为exec方式</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">command</span>:    <span style="color:#75715e"># exec方式需要制定的命令或脚本</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">sh</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">c</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#e6db74">&#34;sleep 5; echo &#39;success&#39;;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">httpGet</span>:    <span style="color:#75715e"># 对Pod内个容器健康检查方法设置为HttpGet，需要制定Path、port</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/  </span> <span style="color:#75715e"># URI地址：http://:80/index.html</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8010</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">host</span>: <span style="color:#ae81ff">192.168.109.100</span>   <span style="color:#75715e"># 主机地址</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTP   </span> <span style="color:#75715e"># 支持的协议，http或者https</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">HttpHeaders</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">string</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">value</span>: <span style="color:#ae81ff">string(字符串)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">tcpSocket</span>:    <span style="color:#75715e"># 对Pod内个容器健康检查方式设置为tcpSocket方式</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8010</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">60</span>   <span style="color:#75715e"># 容器启动完成后首次探测的时间，单位为秒</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span>   <span style="color:#75715e"># 对容器健康检查探测等待响应的超时时间，单位秒，默认1秒</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>   <span style="color:#75715e"># 对容器监控检查的定期探测时间设置，单位秒，默认10秒一次</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>   <span style="color:#75715e"># 配置为：1，表示检查一次成功就成功，配置为：3，表示检查3次</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">5</span>   <span style="color:#75715e"># 失败次数，检查5次失败表示失败</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">securityContext</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">privileged</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">restartPolicy</span>: [<span style="color:#ae81ff">Always | Never | OnFailure]  </span> <span style="color:#75715e"># Pod的重启策略</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">terminationGracePeriodSeconds</span>: <span style="color:#ae81ff">30</span>   <span style="color:#75715e"># 删除pods、deployment后等待时间</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumes</span>:    <span style="color:#75715e"># 在该pod上定义共享存储卷列表</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume  </span> <span style="color:#75715e"># 共享存储卷名称 （volumes类型有很多种）</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">emptyDir</span>: {}    <span style="color:#75715e"># 类型为emtyDir的存储卷，与Pod同生命周期的一个临时目录。为空值</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">hostPath</span>:   <span style="color:#75715e"># 类型为hostPath的存储卷，表示挂载Pod所在宿主机的目录</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/root/logs   </span> <span style="color:#75715e"># Pod所在宿主机的目录，将被用于同期中mount的目录</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">type</span>: <span style="color:#ae81ff">DirectoryOrCreate  </span> <span style="color:#75715e"># 目录存在就使用，不存在就先创建再使用</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">secret</span>:   <span style="color:#75715e"># 类型为secret的存储卷，挂载集群与定义的secret对象到容器内部</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">scretname</span>: <span style="color:#ae81ff">secret</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">items</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">string</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">configMap</span>:    <span style="color:#75715e"># 类型为configMap的存储卷，挂载预定义的configMap对象到容器内部</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">configmap</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">items</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">string</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">string</span></span></span></code></pre></div></blockquote>
<hr>
<h4 id="编写适用java的yaml">编写适用<code>Java</code>的<code>yaml</code></h4>
<ul>
<li>
<ol>
<li>下载<code>java demo</code>代码</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git clone https://github.com/frankinbj/tomcat-java-demo.git     </span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->修改连接数据库配置文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;tomcat-java-demo/src/main/resources/application.yml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">datasource:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    url: jdbc:mysql://192.168.80.215:3306/test?characterEncoding=utf-8
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    username: admin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    password: admin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li>打包<code>java war</code>包</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /opt/tomcat-java-demo/
</span></span><span style="display:flex;"><span>$ mvn clean package -Dmaven.test.skip<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成war包</span>
</span></span><span style="display:flex;"><span>$ ll /opt/tomcat-java-demo/target/ly-simple-tomcat-0.0.1-SNAPSHOT.war</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->把数据导入数据库，创建授权连接用户<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mysql -uroot -p &lt; tomcat-java-demo/doc/db/tables_ly_tomcat.sql
</span></span><span style="display:flex;"><span>$ grant all privileges on *.* to admin@<span style="color:#e6db74">&#39;%&#39;</span> identified by <span style="color:#e6db74">&#39;admin&#39;</span>;</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><code>JDK</code>、<code>Maven</code><!-- raw HTML omitted -->配置环境变量<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;#####  	JDK 環境變數  	#####
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export JAVA_HOME=/usr/local/jdk
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export JRE_HOME=</span><span style="color:#e6db74">${</span>JAVA_HOME<span style="color:#e6db74">}</span><span style="color:#e6db74">/jre
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export CLASSPATH=</span><span style="color:#e6db74">${</span>JAVA_HOME<span style="color:#e6db74">}</span><span style="color:#e6db74">/lib:</span><span style="color:#e6db74">${</span>JAVA_HOME<span style="color:#e6db74">}</span><span style="color:#e6db74">/lib/tools.jar
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export PATH=</span><span style="color:#e6db74">${</span>PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">:</span><span style="color:#e6db74">${</span>JAVA_HOME<span style="color:#e6db74">}</span><span style="color:#e6db74">/bin:</span><span style="color:#e6db74">${</span>JAVA_HOME<span style="color:#e6db74">}</span><span style="color:#e6db74">/jre/bin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export PATH=</span><span style="color:#e6db74">${</span>PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">:/usr/local/maven/bin &#34;</span>&gt;&gt;/etc/profile</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="6">
<li>修改<code>Dockerfile</code>配置文件，<code>docker build</code>成镜像</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>6.1 使用<code>Tomcat</code>服务打包启动容器</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/tomcat-java-demo/Dockerfile<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">FROM lizhenliang/tomcat
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">RUN rm -rf /usr/local/tomcat/webapps/*
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ADD target/*.war /usr/local/tomcat/webapps/ROOT.war
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 声明时区
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">RUN ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp; echo &#39;Asia/Shanghai&#39; &gt;/etc/timezone
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li>6.2 使用<code>java -jar</code><!-- raw HTML omitted -->打包镜像，可以使用<!-- raw HTML omitted --><code>xxl-job</code>的<code>jar</code>包</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> openjdk</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">VOLUME</span><span style="color:#e6db74"> /tmp</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> ./target/live-server-1.0.0-SNAPSHOT.jar live-server-1.0.0-SNAPSHOT.jar<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> bash -c <span style="color:#e6db74">&#34;touch /live-server-1.0.0-SNAPSHOT.jar&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># 声明时区</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime <span style="color:#f92672">&amp;&amp;</span> echo <span style="color:#e6db74">&#39;Asia/Shanghai&#39;</span> &gt;/etc/timezone<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># 声明运行时容器提供服务端口，运行时不会开启这个端口的服务，需要把端口映射</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 8080</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [<span style="color:#e6db74">&#34;java&#34;</span>,<span style="color:#e6db74">&#34;-jar&#34;</span>,<span style="color:#e6db74">&#34;/live-server-1.0.0-SNAPSHOT.jar&#34;</span>]</span></span></code></pre></div><ul>
<li>6.3 生成<code>docker images：</code>镜像并推送到私人仓库</li>
</ul>
<blockquote>
<ul>
<li>
<p><code>-t,--tag list</code>：镜像名称</p>
</li>
<li>
<p><code>-f，--file string</code>：如果文件名不是<code>Dockerfile</code>，<code>-f</code>可以指定其他文件</p>
</li>
<li>
<p><code>192.168.80.210:8080</code>：私人仓库地址</p>
</li>
<li>
<p><code>test</code>：私人仓库名</p>
</li>
<li>
<p><code>tomcat-demo:v1</code>：定义镜像名称以及版本</p>
</li>
<li>
<p>如果打包报错：<code>epository does not exist,</code>更换<code>Dockerfile</code>的<code>FROM</code>源地址</p>
</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /opt/tomcat-java-demo/
</span></span><span style="display:flex;"><span>$ docker build -t 192.168.80.210:8080/test/tomcat-demo:v1 .  	<span style="color:#75715e"># 打包镜像</span>
</span></span><span style="display:flex;"><span>$ docker push 192.168.80.210:8080/test/tomcat-demo:v1  	<span style="color:#75715e"># 推送到私人仓库 </span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h4 id="部署elk日志服务">部署<code>ELK</code>日志服务</h4>
<blockquote>
<ul>
<li><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/devops/Logs/kubernetes-elasticsearch.yaml" rel="external" target="_self"><code>Kubernetes Elasticsearch Template</code>模板</a></li>
<li><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/devops/Logs/kubernetes-logstash.yaml" rel="external" target="_self"><code>Kubernetes Logstash Template</code>模板</a></li>
<li><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/devops/Logs/kubernetes-filebeat.yaml" rel="external" target="_self"><code>Kubernetes Filebeat Template</code>模板</a></li>
<li><a href="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Template/devops/Logs/kubernetes-kibana.yaml" rel="external" target="_self"><code>Kubernetes Kibana Template</code>模板</a></li>
</ul>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="kubernetes_command">Kubernetes_Command</h1>

<h1 id="kubernetes命令使用"><code>Kubernetes</code>命令使用</h1>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands" rel="external" target="_self"><code>Kubernetes</code>官方命令文档</a></td>
<td><code>Kubernetes</code>官方文档详解</td>
</tr>
<tr>
<td><a href="https://github.com/cloudnativelabs/kube-shell" rel="external" target="_self"><code>Kube-shell</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://kubernetes.io/zh-cn/docs/tasks/debug/debug-cluster/crictl/" rel="external" target="_self"><code>crictl</code></a></td>
<td><a href="https://github.com/kubernetes-sigs/cri-tools/blob/master/docs/crictl.md" rel="external" target="_self"><code>Crictl</code></a>主要用于直接与容器运行时接口<code>CRI</code>进行交互。它用于调试和管理容器运行时，如 <code>containerd</code>或<code>CRI-O</code>中的容器</td>
</tr>
</tbody>
</table>
<p><a href="#R-image-9d66b5fd11f5fe9b74de5f67af718d9a" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/14d359426542433e871819e0de267de1.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-9d66b5fd11f5fe9b74de5f67af718d9a"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/14d359426542433e871819e0de267de1.png"></a></p>
</blockquote>
<h2 id="kubectl获取资源名称使用命令"><code>kubectl</code>获取资源名称、使用命令</h2>
<blockquote>
<ul>
<li><code>kubectl</code><!-- raw HTML omitted -->是<!-- raw HTML omitted --><code>kubernetes</code><!-- raw HTML omitted -->集群的命令行工具，通过它能够对集群本身进行管理，并能够在集群上进行容器化应用的安装和部署<!-- raw HTML omitted --></li>
<li><code>kubectl api-resources</code><!-- raw HTML omitted -->是查看<!-- raw HTML omitted --><code>kubernetes</code><!-- raw HTML omitted -->资源命令<!-- raw HTML omitted --></li>
<li><code>Kubernetes</code><!-- raw HTML omitted -->中所有的内容都抽象为资源，所有命令都是围绕资源操作、执行<!-- raw HTML omitted --></li>
</ul>
<table>
<thead>
<tr>
<th>资源分类</th>
<th>资源名称</th>
<th>缩写</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>集群级别资源</td>
<td><code>nodes</code></td>
<td><code>no</code></td>
<td>集群组成部分</td>
</tr>
<tr>
<td>集群级别资源</td>
<td><code>namespaces</code></td>
<td><code>ns</code></td>
<td>隔离<code>Pod</code></td>
</tr>
<tr>
<td><code>Pods</code></td>
<td><code>Pods</code></td>
<td><code>po</code></td>
<td>装载容器</td>
</tr>
<tr>
<td><code>Pod</code>资源控制器</td>
<td><code>replicationcontrollers</code></td>
<td><code>rc</code></td>
<td>比较原始的<code>Pod</code>控制器，已经被废弃，由<code>ReplicaSet</code>替代</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>replicasets</code></td>
<td><code>rs</code></td>
<td>保证指定数量的<code>Pod</code>运行，并支持<code>Pod</code>数量变更，镜像版本变更</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>deployments</code></td>
<td><code>deploy</code></td>
<td>通过控制<code>ReplicaSet</code>来控制<code>Pod</code>，并支持滚动升级、版本回退</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>daemonsets</code></td>
<td><code>ds</code></td>
<td>在集群中的指定<code>Node</code>上都运行一个副本，一般用于守护进程类的任务</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>jobs</code></td>
<td>&mdash;</td>
<td>它创建出来的<code>Pod</code>只要完成任务就立即退出，用于执行一次性任务</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>cronjobs</code></td>
<td><code>cj</code></td>
<td>它创建的<code>Pod</code>会周期性的执行，用于执行周期性的任务</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>horizontalpodautoscalers</code></td>
<td><code>hpa</code></td>
<td>可以根据集群负载自动调整<code>Pod</code>的数量，实现削峰填谷</td>
</tr>
<tr>
<td><code>Pod</code>资源控制器</td>
<td><code>statefulsets</code></td>
<td><code>sts</code></td>
<td>管理有状态的应用</td>
</tr>
<tr>
<td>服务发现资源</td>
<td><code>services</code></td>
<td><code>svc</code></td>
<td>统一<code>Pod</code>对外接口</td>
</tr>
<tr>
<td>服务发现资源</td>
<td><code>ingress</code></td>
<td><code>ing</code></td>
<td>统一<code>Pod</code>对外接口</td>
</tr>
<tr>
<td>存储资源</td>
<td><code>volumeattachments</code></td>
<td>&mdash;</td>
<td>存储</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>persistentvolumes</code></td>
<td><code>pv</code></td>
<td>存储</td>
</tr>
<tr>
<td>存储资源</td>
<td><code>persistentvolumeclaims</code></td>
<td><code>pvc</code></td>
<td>存储</td>
</tr>
<tr>
<td>配置资源</td>
<td><code>configmaps</code></td>
<td><code>cm</code></td>
<td>配置</td>
</tr>
<tr>
<td>配置资源</td>
<td><code>secrets</code></td>
<td>&mdash;</td>
<td>配置</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th><strong>常用命令</strong></th>
<th>命令</th>
<th>翻译</th>
<th>命令作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>&mdash;</td>
<td><code>run</code></td>
<td>运行</td>
<td>在集群中运行一个指定的镜像</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>get</code></td>
<td>获取</td>
<td>获取显示一个或多个资源</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>set</code></td>
<td>设置</td>
<td>设置一个对象的特定特征</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>create</code></td>
<td>创建</td>
<td>从文件或标准输入创建资源</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>edit</code></td>
<td>编辑</td>
<td>编辑服务器上的资源</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>patch</code></td>
<td>更新</td>
<td>更新一个资源，更新资源的字段</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>apply</code></td>
<td>应用</td>
<td>通过文件名或标准输入将配置应用于资源</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>replace</code></td>
<td>替换</td>
<td>用文件名或标准输入替换资源</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>delete</code></td>
<td>删除</td>
<td><code>delete</code>按文件名、标准输入、资源和名称，或按资源和标签选择器删除资源</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>api-resources</code></td>
<td>&mdash;</td>
<td>打印服务器上支持的<code>API</code>资源</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>api-versions</code></td>
<td>&mdash;</td>
<td>打印服务器上支持的<code>API</code>版本，格式为<code>group/version</code></td>
</tr>
<tr>
<td><strong>常用命令</strong></td>
<td><code>version</code></td>
<td>版本</td>
<td>打印客户端和服务器版本信息</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th><strong>中级命令</strong></th>
<th>命令</th>
<th>翻译</th>
<th>命令作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>&mdash;</td>
<td><code>cp</code></td>
<td>复制</td>
<td>在<code>Pod</code>内外复制文件</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>exec</code></td>
<td>执行</td>
<td>在容器中执行命令</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>label</code></td>
<td>标签</td>
<td>更新资源上的标签</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>logs</code></td>
<td>日志</td>
<td>打印<code>pod</code>中容器的日志</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>attach</code></td>
<td>缠绕</td>
<td>进入运行中的容器、附加到正在运行的容器</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>describe</code></td>
<td>描述</td>
<td><code>describe</code>显示特定资源或资源组的详细信息</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>expose</code></td>
<td>暴露</td>
<td>将复制控制器、服务、部署或<code>pod</code>暴露为新的<code>Kubernetes</code>服务<code>Service</code></td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>explain</code></td>
<td>解释</td>
<td>展示资源类型、属性文档，获取资源控制器字段使用</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>annotate</code></td>
<td>注释</td>
<td>更新资源上的注释</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>rollout</code></td>
<td>首次展示</td>
<td>管理资源的发布，查看、更新<code>Pods</code>版本发布</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>scale</code></td>
<td>手动扩容、缩容</td>
<td>扩(缩)容<code>Pod</code>的数量,为<code>Deployment</code>、<!-- raw HTML omitted --><code>ReplicaSet</code>或<!-- raw HTML omitted --><code>Replication</code> <code>Controller</code>设置新的大小</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>autoscale</code></td>
<td>监控<code>CPU</code>、内存自动扩容、缩容</td>
<td>自动调整<code>Pod</code>的数量，自动缩放<code>Deployment</code>、<!-- raw HTML omitted --><code>ReplicaSet</code>、<code>StatefulSet</code>或<code>ReplicationController</code></td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>plugin</code></td>
<td>&mdash;</td>
<td>提供与插件交互的实用程序</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>taint</code></td>
<td>污点</td>
<td><code>taint</code>节点上设置污点</td>
</tr>
<tr>
<td><strong>中级命令</strong></td>
<td><code>config</code></td>
<td>&mdash;</td>
<td>修改<code>kubeconfig</code>文件</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th><strong>高级命令</strong></th>
<th>命令</th>
<th>翻译</th>
<th>命令作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>&mdash;</td>
<td><code>top</code></td>
<td></td>
<td>顶部显示资源（<code>CPU</code>/内存）使用情况</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>auth</code></td>
<td></td>
<td>检查授权</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>diff</code></td>
<td>对比</td>
<td>对比实时版本与将要应用的版本之间的差异</td>
</tr>
<tr>
<td>&mdash;</td>
<td><code>wait</code></td>
<td>等待</td>
<td>等待实验：等待一个或多个资源的特定条件</td>
</tr>
<tr>
<td></td>
<td><code>proxy</code></td>
<td>代理</td>
<td>运行到<code>Kubernetes API</code>服务器的代理</td>
</tr>
<tr>
<td></td>
<td><code>cordon</code></td>
<td>警戒线</td>
<td>警戒线 将节点标记为不可调度</td>
</tr>
<tr>
<td></td>
<td><code>uncordon</code></td>
<td></td>
<td><code>uncordon</code>将节点标记为可调度</td>
</tr>
<tr>
<td></td>
<td><code>drain</code></td>
<td>排水</td>
<td>排水节点准备维护</td>
</tr>
<tr>
<td></td>
<td><code>completion</code></td>
<td></td>
<td>完成输出指定<code>shell</code>的<code>shell</code>完成代码（<code>bash</code>或<code>zsh</code>）</td>
</tr>
<tr>
<td></td>
<td><code>certificate</code></td>
<td>证书</td>
<td>修改证书资源</td>
</tr>
<tr>
<td></td>
<td><code>cluster-info</code></td>
<td>集群信息</td>
<td>显示集群信息</td>
</tr>
<tr>
<td></td>
<td><code>port-forward</code></td>
<td>转发</td>
<td>将一个或多个本地端口转发到一个<code>pod</code></td>
</tr>
<tr>
<td></td>
<td><code>debug</code></td>
<td>调试</td>
<td>创建调试会话以对工作负载和节点进行故障排除</td>
</tr>
<tr>
<td><strong>高级命令</strong></td>
<td><code>kustomize</code></td>
<td></td>
<td>从目录或<code>URL</code>构建一个<code>kustomization</code>目标</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>品控级别(Track)</th>
<th>日期、时间</th>
<th>&mdash;</th>
</tr>
</thead>
<tbody>
<tr>
<td>每天</td>
<td><code>daily</code></td>
<td>&mdash;</td>
</tr>
<tr>
<td>每周</td>
<td><code>weekly</code></td>
<td>&mdash;</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h3 id="span-id常用命令常用命令创建删除span"><!-- raw HTML omitted -->常用命令：创建、删除<!-- raw HTML omitted --></h3>
<blockquote>
<ul>
<li><code>kubectl --help</code><!-- raw HTML omitted -->：可以通过<code>--help</code>查看详细的操作命令<!-- raw HTML omitted --></li>
<li><code>kubectl</code><!-- raw HTML omitted -->命令的语法如下<!-- raw HTML omitted --><code>$ kubectl [command] [type] [name] [flags]</code></li>
</ul>
<blockquote>
<ul>
<li><code>command</code>:	<!-- raw HTML omitted -->指定要对资源执行的操作，比如：<!-- raw HTML omitted --><code>create</code>、<code>get</code>、<code>delete</code></li>
<li><code>type</code>：<!-- raw HTML omitted -->指定资源的类型，比如：<!-- raw HTML omitted --><code>deployment</code>、<code>pod</code>、<code>service</code></li>
<li><code>name</code>： <!-- raw HTML omitted -->指定资源的名称，名称大小写敏感 <!-- raw HTML omitted --></li>
<li><code>flags</code>： <!-- raw HTML omitted -->指定额外的可选参数<!-- raw HTML omitted --></li>
</ul>
</blockquote>
</blockquote>
<ul>
<li>
<ol>
<li><code>kubectl run --help</code><!-- raw HTML omitted -->：命令使用镜像创建容器 <!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl run nginx --image<span style="color:#f92672">=</span>nginx:1.17.1 -n web</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><code>kubectl get --help</code><!-- raw HTML omitted -->：获取资源，选择输出的格式<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><strong><code>-o wide</code></strong></li>
<li><strong><code>-o json</code></strong></li>
<li><strong><code>-o yaml</code></strong></li>
<li><code>Service</code><!-- raw HTML omitted -->可以看做是一组同类的<code>Pod</code>对外的访问接口，借助<code>Service</code>，应用可以方便的实现服务发现和负载均衡<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl get csr  	<span style="color:#75715e"># 查看申请加入kubernetes集群的token信息</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl get endpoints  	<span style="color:#75715e"># 获取service对应的所有pod的访问地址</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl get all --namespace<span style="color:#f92672">=</span>kube-system  	<span style="color:#75715e"># 查看所有namespace下所有资源</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl get pods -n web -o wide -w  	<span style="color:#75715e"># 查看namespace web下的pod，-o wide:查看更多信息，-w：动态查看</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用kubectl get命令导出yaml文件</span>
</span></span><span style="display:flex;"><span>$ kubectl get pod coredns-558bd4d5db-9h55s -n kube-system -o yaml &gt;/tmp/coredns-558bd4d5db-9h55s.yaml</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><code>kubectl set --help</code><!-- raw HTML omitted -->更新镜像、设置一个对象的特定特征<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl set image deployment/web nginx<span style="color:#f92672">=</span>nginx1.15</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><code>kubectl create --help</code><!-- raw HTML omitted -->：创建命令用于创建资源<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>yaml</code><!-- raw HTML omitted -->文件详解、使用<!-- raw HTML omitted --><code>kubectl create</code><!-- raw HTML omitted -->命令生成<!-- raw HTML omitted --><code>yaml</code><!-- raw HTML omitted -->文件<!-- raw HTML omitted --></li>
<li><code>deployment</code><!-- raw HTML omitted -->：无状态应用部署<!-- raw HTML omitted --></li>
<li><code>java-demo</code><!-- raw HTML omitted -->：自定义名称<!-- raw HTML omitted --></li>
<li><code> --image</code><!-- raw HTML omitted -->：使用镜像<!-- raw HTML omitted --></li>
<li><code> --dry-run</code><!-- raw HTML omitted -->：测试<!-- raw HTML omitted --></li>
<li><code>-o</code><!-- raw HTML omitted -->：输出<!-- raw HTML omitted --></li>
<li><code>&gt;/tmp/deploy.yaml</code><!-- raw HTML omitted -->：定向输出到文件，不加<!-- raw HTML omitted --><code>&gt;/tmp/deploy.yaml</code><!-- raw HTML omitted --> 输出到屏幕查看<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 创建一个namespace命名空间</span>
</span></span><span style="display:flex;"><span>$ kubectl create namespace dev
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl create deployment java-demo --image<span style="color:#f92672">=</span>192.168.80.210:8080/test/tomcat-demo:v1 --dry-run<span style="color:#f92672">=</span>client -o yaml &gt;/tmp/deploy.yaml  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl create service clusterip ngx-dep --tcp<span style="color:#f92672">=</span>80:80  <span style="color:#75715e"># 命令行创建service</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl create -f ns-dev.yaml    <span style="color:#75715e"># 根据yaml文件创建资源</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><code>kubectl edit --help</code><!-- raw HTML omitted -->：<code>cm</code>：编辑<!-- raw HTML omitted --><code>configMap</code><!-- raw HTML omitted -->中的配置<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 修改service中的服务</span>
</span></span><span style="display:flex;"><span>$ kubectl edit service/ingress-nginx-controller-admission -n ingress-nginx 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl edit cm kube-proxy -n kube-system <span style="color:#75715e"># 修改ipvs(必须安装ipvs内核模块，否则会降级为iptables) 修改：mode: &#34;ipvs&#34;</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="6">
<li><code>kubectl patch --help</code><!-- raw HTML omitted -->：补丁修改、更新资源的字段<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl patch pod rc-nginx-2-kpiqt -p <span style="color:#e6db74">&#39;{&#34;metadata&#34;:{&#34;labels&#34;:{&#34;app&#34;:&#34;nginx-3&#34;}}}&#39;</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="7">
<li><code>kubectl apply --help</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->如果资源不存在，就创建，相当于<!-- raw HTML omitted --><code>kubectl create</code></li>
<li><!-- raw HTML omitted -->如果资源存在，就更新，相当于<!-- raw HTML omitted --><code>kubectl patch</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 运行构建命令</span>
</span></span><span style="display:flex;"><span>$ kubectl apply -f ./  	<span style="color:#75715e"># 应用当前目录下所有yaml文件</span>
</span></span><span style="display:flex;"><span>$ kubectl apply -f deploy.yaml  	<span style="color:#75715e"># K8S默认拉去GitHub上镜像</span>
</span></span><span style="display:flex;"><span>$ kubectl apply -f nginx-pod.yaml -n web --record</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="8">
<li><code>kubectl replace --help</code><!-- raw HTML omitted -->：根据<code>yaml</code>文件更新修改后配置资源，会停掉原来的资源，重新创建<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl replace -f rc-nginx.yaml  </span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="9">
<li><code>kubectl delete --help</code><!-- raw HTML omitted -->：删除<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><a href="https://aws.amazon.com/cn/premiumsupport/knowledge-center/eks-terminated-namespaces/" rel="external" target="_self">删除<code>Terminating</code>(正在终止)状态命名空间</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl delete svc/web
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl delete -f deployment-nginx.yaml  	<span style="color:#75715e"># 删除该yaml中创建的资源</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl delete pod nginx-deployment-798444d598-87hlk -n web  	<span style="color:#75715e"># 删除pod资源  </span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="10">
<li><code>kubectl api-resources --help</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl api-resources  	<span style="color:#75715e"># 查看k8s所有的资源以及对应的apiversion</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl api-versions  	<span style="color:#75715e"># 查看k8s所有 版本号 </span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="span-id中级命令中级命令运行调试span"><!-- raw HTML omitted -->中级命令：运行、调试<!-- raw HTML omitted --></h3>
<ul>
<li>
<ol>
<li><code>kubectl exec --help</code><!-- raw HTML omitted -->进入容器<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl exec -it nginx-deployment-798444d598-87hlk  -n web -- /bin/sh
</span></span><span style="display:flex;"><span>$ kubectl exec my-pod -it -- ls /opt/  	<span style="color:#75715e"># 在已存在的容器中执行命令（只有一个容器的情况下）</span>
</span></span><span style="display:flex;"><span>$ kubectl exec my-pod -c my-container -- ls /  	<span style="color:#75715e"># 在已存在的容器中执行命令（pod中有多个容器的情况下） </span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><code>kubectl label --help</code><!-- raw HTML omitted -->：更新资源上的标签<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>标签<code>Key</code></th>
<th><code>Values</code></th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>release</code>(发布)</td>
<td>版本：<code>stable</code>(稳定版)、<code>canary</code>(金丝雀版)、<code>alpha</code>(内测)、<code>bate</code>(公测)</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>environment</code>(环境)</td>
<td>环境：<code>dev</code>(开发)、<code>qa/test</code>(测试)、<code>gray</code>(灰度)、<code>production</code>(生产)、<code>op</code>(运维)、<code>ui,as,pc,sc</code>(应用类(<code>app</code>))</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>tier</code>(层级)</td>
<td>层级：<code>frontend</code>(前端)、<code>backend</code>(后端)、<code>cache</code>(缓存)</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>partition</code>(分区/模块)</td>
<td>分区/模块：<code>customerA</code>(业务A/客户A)、<code>customerB</code>(业务B/客户B)</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>version</code>(版本号)</td>
<td>版本号：<code>v1.1、v1.2</code></td>
<td>&mdash;</td>
</tr>
</tbody>
</table>
<ul>
<li><!-- raw HTML omitted -->给节点<!-- raw HTML omitted --><code>Nodes</code><!-- raw HTML omitted -->打标签、删除标签<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 显示 Nodes 标签</span>
</span></span><span style="display:flex;"><span>$ kubectl get node --show-labels
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 给 Nodes 节点打上，名字为：data 的标签</span>
</span></span><span style="display:flex;"><span>$ kubectl label nodes nodes_name data<span style="color:#f92672">=</span>labels_name
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除 Nodes 上，名字为：data 的标签</span>
</span></span><span style="display:flex;"><span>$ kubectl label nodes nodes_name data-</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->给节点<!-- raw HTML omitted --><code>Pods</code><!-- raw HTML omitted -->打标签、删除标签<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 显示命名空间为：web 下 Pods 的标签</span>
</span></span><span style="display:flex;"><span>$ kubectl get pods --show-labels -n web -o wide
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 为 Pods 打上，名字为：version 的标签</span>
</span></span><span style="display:flex;"><span>$ kucectl label pods pods_name version<span style="color:#f92672">=</span>1.0 -n web
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 覆盖原来的标签：--overwrite</span>
</span></span><span style="display:flex;"><span>$ kucectl label pods pods_name version<span style="color:#f92672">=</span>2.0 --overwrite -n web
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除 Pods 上，名字为：version 的标签</span>
</span></span><span style="display:flex;"><span>$ kucectl label pods pods_name version- -n web</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><code>kubectl describe --help</code><!-- raw HTML omitted -->显示资源内部信息<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl describe namespace kube-system
</span></span><span style="display:flex;"><span>Name:         kube-system
</span></span><span style="display:flex;"><span>Labels:       kubernetes.io/metadata.name<span style="color:#f92672">=</span>kube-system
</span></span><span style="display:flex;"><span>Annotations:  &lt;none&gt;
</span></span><span style="display:flex;"><span>Status:       Active  	<span style="color:#75715e"># 表示正在使用中，Terminating:表示正在删除命名空间</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>No resource quota.  	<span style="color:#75715e"># 表示：针对命名空间做的资源限制</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>No LimitRange resource.  	<span style="color:#75715e"># 表示：针对命名空间中的每个组件做的资源限制</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl describe pods -n web nginx-pod  	<span style="color:#75715e"># 查看pod 的详细信息</span>
</span></span><span style="display:flex;"><span>$ kubectl describe service -n web nginx-svc  	<span style="color:#75715e"># 查看service的 详细信息 </span>
</span></span><span style="display:flex;"><span>$ kubectl describe node 192.168.3.125  	<span style="color:#75715e"># 查看node的详细信息</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><code>kubectl logs --help</code><!-- raw HTML omitted -->日志查看<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl logs -n web nginx-deployment-798444d598-87hlk  	<span style="color:#75715e"># 查看pod日志</span>
</span></span><span style="display:flex;"><span>$ kubectl logs -f nginx-deployment-798444d598-87hlk -n web  <span style="color:#75715e"># 实时查看日志</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl logs nginx-deployment-798444d598-87hlk -c &lt;container_name&gt; -n web  <span style="color:#75715e"># 查看pod中单个容器的日志</span>
</span></span><span style="display:flex;"><span>$ kubectl logs -l app<span style="color:#f92672">=</span>frontend -n web    <span style="color:#75715e"># 返回全部标记为 app=frontend 的 pod 的合并日志</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><code>kubectl expose --help</code><!-- raw HTML omitted -->端口暴露<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>expose</code><!-- raw HTML omitted -->端口设置固定选项<!-- raw HTML omitted --></li>
<li><code> java-demo</code><!-- raw HTML omitted -->： 自定义名称<!-- raw HTML omitted --></li>
<li><code>--port</code><!-- raw HTML omitted -->：<code>Pod</code>的<code>Service</code>服务端口，集群内部互通端口<!-- raw HTML omitted --></li>
<li><code>--target-port</code><!-- raw HTML omitted -->：<code>Pod</code>容器内服务端口端口<!-- raw HTML omitted --></li>
<li><code>--type</code><!-- raw HTML omitted -->：随机生成外部访问端口<!-- raw HTML omitted --></li>
<li><code>&gt;java-demo-svc.yaml</code><!-- raw HTML omitted -->：定向输出到文件，不加<!-- raw HTML omitted --><code>&gt;java-demo-svc.yaml</code><!-- raw HTML omitted -->输出到屏幕查看<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl expose --help
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl expose deployment java-demo --port<span style="color:#f92672">=</span><span style="color:#ae81ff">80</span> --target-port<span style="color:#f92672">=</span><span style="color:#ae81ff">8080</span> --type<span style="color:#f92672">=</span>NodePort --dry-run<span style="color:#f92672">=</span>client -o yaml &gt;java-demo-svc.yaml  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl apply -f java-demo-svc.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 对外发布允许外网访问</span>
</span></span><span style="display:flex;"><span>$ kubectl expose deployment web --port<span style="color:#f92672">=</span><span style="color:#ae81ff">80</span> --type<span style="color:#f92672">=</span>NodePort --target-port<span style="color:#f92672">=</span><span style="color:#ae81ff">80</span> --name<span style="color:#f92672">=</span>web
</span></span><span style="display:flex;"><span>$ kubectl get service
</span></span><span style="display:flex;"><span>$ kubectl get deploy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># PORT(S):80(集群内部互通端口)、30040/TCP(外部访问端口)</span>
</span></span><span style="display:flex;"><span>$ kubectl get pods,svc
</span></span><span style="display:flex;"><span>NAME                             READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pod/java-demo-56d54df448-2m8kr   1/1     Running   <span style="color:#ae81ff">0</span>          68m
</span></span><span style="display:flex;"><span>pod/java-demo-56d54df448-9k5dn   1/1     Running   <span style="color:#ae81ff">0</span>          68m
</span></span><span style="display:flex;"><span>pod/java-demo-56d54df448-wvqkf   1/1     Running   <span style="color:#ae81ff">0</span>          68m
</span></span><span style="display:flex;"><span>pod/nginx-6799fc88d8-5sxfn       1/1     Running   <span style="color:#ae81ff">0</span>          3h4m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                 TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>        AGE
</span></span><span style="display:flex;"><span>service/java-demo    NodePort    10.103.37.12   &lt;none&gt;        80:30040/TCP   105s
</span></span><span style="display:flex;"><span>service/kubernetes   ClusterIP   10.96.0.1      &lt;none&gt;        443/TCP        4h35m
</span></span><span style="display:flex;"><span>service/nginx        NodePort    10.106.61.55   &lt;none&gt;        80:31750/TCP   3h4m</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="6">
<li><code>kubectl explain --help</code><!-- raw HTML omitted -->：展示资源使用文档<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl explain pod.kind.replicasets <span style="color:#75715e"># 查看某种资源可以配置的一级配置如：pod、deployment</span>
</span></span><span style="display:flex;"><span>$ kubectl explain pod.metadata       <span style="color:#75715e"># 查看资源的子属性，资源类型：pod、属性：metadata</span>
</span></span><span style="display:flex;"><span>$ kubectl explain pod.spec 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># nodes</span>
</span></span><span style="display:flex;"><span>$ kubectl explain pod.spec.nodeName.containers
</span></span><span style="display:flex;"><span>$ kubectl explain pod.spec.nodeSelector.containers</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="7">
<li><code>kubectl rollout --help</code><!-- raw HTML omitted -->：管理资源<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>status</code><!-- raw HTML omitted -->：显示当前升级状态<!-- raw HTML omitted --></li>
<li><code>history</code><!-- raw HTML omitted -->：显示升级历史记录<!-- raw HTML omitted --></li>
<li><code>pause</code><!-- raw HTML omitted -->：暂停版本升级过程<!-- raw HTML omitted --></li>
<li><code>resume</code><!-- raw HTML omitted -->：继续已经暂停的版本升级过程<!-- raw HTML omitted --></li>
<li><code>restart</code><!-- raw HTML omitted -->：重启版本升级过程<!-- raw HTML omitted --></li>
<li><code>undo</code><!-- raw HTML omitted -->：回滚到上一级版本(可以使用<!-- raw HTML omitted --><code>--to-revision</code><!-- raw HTML omitted -->，指定版本)<!-- raw HTML omitted --></li>
<li><code>--record</code><!-- raw HTML omitted -->：记录<!-- raw HTML omitted --><code>CHANGE-CAUSE</code><!-- raw HTML omitted -->(改变原因)操作记录,便于回滚<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 更新发布</span>
</span></span><span style="display:flex;"><span>$ kubectl apply -f nginx-deployment.yml --record  	<span style="color:#75715e"># --record，记录操作记录,便于回滚</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># pause 暂定更新发布</span>
</span></span><span style="display:flex;"><span>$ kubectl rollout pause deployment nginx-deployment -n app
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># resume 继续更新发布</span>
</span></span><span style="display:flex;"><span>$ kubectl rollout resume deployment nginx-deployment -n app
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看升级状态</span>
</span></span><span style="display:flex;"><span>$ kubectl rollout status deployment/nginx-deployment
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看升级历史版本</span>
</span></span><span style="display:flex;"><span>$ kubectl rollout history deployment/web
</span></span><span style="display:flex;"><span>$ kubectl rollout history deployment -n app
</span></span><span style="display:flex;"><span>$ kubectl rollout history deployment/web --revision<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>  	<span style="color:#75715e"># 查看某个更新具体内容</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 回滚</span>
</span></span><span style="display:flex;"><span>$ kubectl rollout undo deployment/web --revision<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>$ kubectl rollout undo deployment/nginx-deployment --to-revision<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> -n app  	<span style="color:#75715e"># 版本回滚到v1</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="8">
<li><code>kubectl scale --help</code><!-- raw HTML omitted -->：手动扩缩容<code>Pod</code>数量<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>--replicas</code><!-- raw HTML omitted -->：参数定义<code>Pod</code>数量<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl scale rc redis --replicas<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> -n web  	<span style="color:#75715e"># 操作pod 的扩容和缩容</span>
</span></span><span style="display:flex;"><span>$ kubectl scale --replicas<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> -f redis-slave-deployment.yaml</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="9">
<li><code>kubectl autoscale --help</code><!-- raw HTML omitted -->：监控<code>CPU</code>使用百分比自动扩缩<code>Pod</code>数量<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>deployment</code><!-- raw HTML omitted -->：类型控制器<!-- raw HTML omitted --></li>
<li><code>deployment-name</code><!-- raw HTML omitted -->：<code>Pod</code>的名称<!-- raw HTML omitted --></li>
<li><code>--cpu-percent</code><!-- raw HTML omitted -->：使用<code>CPU</code>百分比<!-- raw HTML omitted --></li>
<li><code>--min</code><!-- raw HTML omitted -->：<code>Pod</code>最少数量<!-- raw HTML omitted --></li>
<li><code>--max</code><!-- raw HTML omitted -->：<code>Pod</code>最多数量<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl autoscale deployment deployment-name --cpu-percent<span style="color:#f92672">=</span><span style="color:#ae81ff">60</span> --min<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> --max<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="10">
<li><code>kubectl taint --help</code><!-- raw HTML omitted -->：污点配置<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->查看节点上的污点<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl describe nodes k8s-node1 | grep Taints</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->设置污点<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>tag=webapps</code>、<code>tag</code><!-- raw HTML omitted -->：污点名称，可以自定义，依<!-- raw HTML omitted --><code>Key=value</code></li>
<li><code>NoSchedule</code><!-- raw HTML omitted -->：影响，不会调度到此节点<!-- raw HTML omitted --></li>
<li><code>NoExecute</code><!-- raw HTML omitted -->：驱除，把此节点上的<code>Pods</code>驱除到其他节点<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl taint node k8s-node1 tag<span style="color:#f92672">=</span>webapps:NoSchedule</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->去除污点<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>-</code><!-- raw HTML omitted -->：污点名称后面跟<!-- raw HTML omitted --><!-- raw HTML omitted -->减号<!-- raw HTML omitted --><!-- raw HTML omitted -->就是去除污点意思<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl taint node k8s-master-01 node-role.kubernetes.io/control-plane:NoSchedule-
</span></span><span style="display:flex;"><span>node/k8s-master-01 untainted  	<span style="color:#75715e"># 返回结果 污点已去除</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 去除以 tag 为名设置的所有污点</span>
</span></span><span style="display:flex;"><span>$ kubectl taint node k8s-node1 tag-</span></span></code></pre></div></blockquote>
<hr>
<h3 id="span-id高级命令高级命令管理排查span"><!-- raw HTML omitted -->高级命令：管理、排查<!-- raw HTML omitted --></h3>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/kubernetes-sigs/metrics-server" rel="external" target="_self"><code>Kubernetes</code>指标服务器</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/cai11745/hybrid-cloud/blob/master/prometheus/2019-10-22-prometheus-1-install-and-metricsIngress.md" rel="external" target="_self">安装<code>Prometheus</code>监控服务器资源</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/prometheus-operator/kube-prometheus" rel="external" target="_self"><code>kube-prometheus</code>服务资源监控</a></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>
<ol>
<li><code>kubectl top --help</code><!-- raw HTML omitted -->：监控集群内存<code>CPU</code>指标<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>metrics-server</code><!-- raw HTML omitted -->可以用来收集集群中的资源使用情况、需要单独安装<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->新增参数：<!-- raw HTML omitted --><code>hostNetwork: true</code><!-- raw HTML omitted -->，用于使用宿主机网络<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->国内修改为阿里云地址：<!-- raw HTML omitted --><code>image: registry.cn-hangzhou.aliyuncs.com/google_containers/metrics-server-amd64:v0.3.6</code></li>
<li><!-- raw HTML omitted -->新增参数：<!-- raw HTML omitted --><code>- --kubelet-insecure-tls</code>，不验证客户端证书，仅用于测试目的，<code>kubelet</code>的<code>10250</code>端口使用的是<code>https</code>协议，连接需要验证<code>tls</code>证书</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml -O metrics-server.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 替换为阿里云镜像地址</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s/k8s.io\/metrics-server/cn-hangzhou.aliyuncs.com\/google_containers/g&#39;</span> metrics-server.yaml</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>metrics-server.yaml</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">metrics-server</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">metrics-server</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">metrics-server</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">strategy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">metrics-server</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">hostNetwork</span>: <span style="color:#66d9ef">true</span>   <span style="color:#75715e"># 新增参数，使用宿主机网络</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">args</span>:
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">cert-dir=/tmp</span>
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">secure-port=4443</span>
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname</span>
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">kubelet-use-node-status-port</span>
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">metric-resolution=15s</span>
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">kubelet-insecure-tls   </span> <span style="color:#75715e"># 新增参数，不校验https协议</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">registry.cn-hangzhou.aliyuncs.com/google_containers/metrics-server:v0.6.4</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span></span></span></code></pre></div><div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl apply -f metrics-server.yaml
</span></span><span style="display:flex;"><span>$ kubectl top node  --use-protocol-buffers
</span></span><span style="display:flex;"><span>$ kubectl top  pod/node  -n dev </span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><code>kubectl port-forward --help</code><!-- raw HTML omitted -->转发<code>Pod</code>中端口<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl port-forward my-pod 5000:6000  	<span style="color:#75715e"># 转发pod中的6000端口到本地的 5000 端口</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="故障排查解决">故障排查、解决</h3>
<h5 id="nodesfont-colorred节点显示fontnotreadyfont-colorred是节点之间网络不通导致font"><code>nodes</code><!-- raw HTML omitted -->节点显示<!-- raw HTML omitted --><code>NotReady</code><!-- raw HTML omitted -->是节点之间网络不通导致<!-- raw HTML omitted --></h5>
<blockquote>
<p><a href="#R-image-ad78a26c38fa93cebb75ca11c7521e18" class="lightbox-link"><img alt="get-nodes" class="border lazy lightbox noshadow figure-image" loading="lazy" src="http://oss.linuxtxc.com/images/image-20220407170459496.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-ad78a26c38fa93cebb75ca11c7521e18"><img alt="get-nodes" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="http://oss.linuxtxc.com/images/image-20220407170459496.png"></a></p>
</blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->查看集群健康状况<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl get cs
</span></span><span style="display:flex;"><span>$ kubectl cluster-info
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用镜像测试容器命令</span>
</span></span><span style="display:flex;"><span>$ kubectl run -it --image busybox:1.28.4 container-name --restart<span style="color:#f92672">=</span>Never --rm /bin/sh
</span></span><span style="display:flex;"><span>$ ping pod-name.server-name</span></span></code></pre></div><p><a href="#R-image-4ca5ef8be50e0d5fd54bad5fe7372ca0" class="lightbox-link"><img alt="get-sc" class="border lazy lightbox noshadow figure-image" loading="lazy" src="http://oss.linuxtxc.com/images/image-20220407170643950.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-4ca5ef8be50e0d5fd54bad5fe7372ca0"><img alt="get-sc" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="http://oss.linuxtxc.com/images/image-20220407170643950.png"></a></p>
</blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->先处理网络、后处理配置文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ vim  /etc/kubernetes/manifests/kube-controller-manager.yaml （注释掉 - --port<span style="color:#f92672">=</span>0）
</span></span><span style="display:flex;"><span>$ vim  /etc/kubernetes/manifests/kube-scheduler.yaml          （注释掉 - --port<span style="color:#f92672">=</span>0）
</span></span><span style="display:flex;"><span>$ systemctl start kubelet </span></span></code></pre></div><ul>
<li>2.1 <!-- raw HTML omitted -->再次查看，节点正常显示： <!-- raw HTML omitted --><code>Ready</code></li>
</ul>
<p><a href="#R-image-68713f21323c067e4299f933ad944024" class="lightbox-link"><img alt="get-cs-2" class="border lazy lightbox noshadow figure-image" loading="lazy" src="http://oss.linuxtxc.com/images/image-20220407170817379.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-68713f21323c067e4299f933ad944024"><img alt="get-cs-2" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="http://oss.linuxtxc.com/images/image-20220407170817379.png"></a></p>
<p><a href="#R-image-1ff1e5d5543d1e97df2ef88f433448c6" class="lightbox-link"><img alt="get-nodes-2" class="border lazy lightbox noshadow figure-image" loading="lazy" src="http://oss.linuxtxc.com/images/image-20220407171343144.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-1ff1e5d5543d1e97df2ef88f433448c6"><img alt="get-nodes-2" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="http://oss.linuxtxc.com/images/image-20220407171343144.png"></a></p>
</blockquote>
<hr>
<h5 id="重置kubernetes集群">重置<code>Kubernetes</code>集群</h5>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 在master、node节点都执行以下命令</span>
</span></span><span style="display:flex;"><span>$ kubeadm reset 
</span></span><span style="display:flex;"><span>$ rm -rf /etc/cni/net.d
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在master上执行</span>
</span></span><span style="display:flex;"><span>$ kubeadm init --kubernetes-version<span style="color:#f92672">=</span>1.19.0 --apiserver-advertise-address<span style="color:#f92672">=</span>192.168.3.124 --service-cidr<span style="color:#f92672">=</span>10.64.0.0/24 --pod-network-cidr<span style="color:#f92672">=</span>10.244.0.0/16
</span></span><span style="display:flex;"><span>$ mkdir -p $HOME/.kube
</span></span><span style="display:flex;"><span>$ cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style="display:flex;"><span>$ chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config
</span></span><span style="display:flex;"><span>$ vim /etc/kubernetes/manifests/kube-controller-manager.yaml （注释掉 - --port<span style="color:#f92672">=</span>0）
</span></span><span style="display:flex;"><span>$ vim /etc/kubernetes/manifests/kube-scheduler.yaml          （注释掉 - --port<span style="color:#f92672">=</span>0）
</span></span><span style="display:flex;"><span>$ systemctl start kubelet 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在node节点执行</span>
</span></span><span style="display:flex;"><span>$ kubeadm reset
</span></span><span style="display:flex;"><span>$ kubeadm join 192.168.3.124:6443 --token f62e1g.exfdrr8bg2fxpdmu <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--discovery-token-ca-cert-hash sha256:7e4762cccce2e8306b6635cbc2091eae34bbf33577276413521a343c49fc026a</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_kubernetes">Install_Kubernetes</h1>

<h1 id="部署kubernetes">部署<code>Kubernetes</code></h1>
<blockquote>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<ul>
<li>
<p><code>Etcd</code><!-- raw HTML omitted -->：负责存储集群中各种资源对象的信息<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>Kubelet</code><!-- raw HTML omitted -->：负责维护容器的生命周期，即通过控制<!-- raw HTML omitted --><code>Docker</code><!-- raw HTML omitted -->，来创建、更新、销毁容器<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>KubeProxy</code><!-- raw HTML omitted -->：负责提供集群内部的服务发现和负载均衡<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>Docker</code><!-- raw HTML omitted -->：负责节点上容器的各种操作<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>Scheduler</code><!-- raw HTML omitted -->：负责集群资源调度，按照预定的调度策略将<code>Pod</code>调度到相应的<code>node</code>节点上<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>API Server</code><!-- raw HTML omitted -->：集群操作的唯一入口，接收用户输入的命令，提供认证、授权、<code>API</code>注册和发现等机制<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>ControllerManager</code><!-- raw HTML omitted -->：负责维护集群的状态，比如程序部署安排、故障检测、自动扩展和滚动更新等<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>Core DNS</code><!-- raw HTML omitted -->：可以为集群中的<code>SVC</code>创建一个域名<code>IP</code>的对应关系解析<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>Dashboard</code><!-- raw HTML omitted -->：给<code>K8S</code>集群提供一个<code>B/S</code>结构的体系访问<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>Ingress Controller</code><!-- raw HTML omitted -->：官方只能实现四层代理，<code>Ingress</code>可以实现七层代理<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>Fedetation</code><!-- raw HTML omitted -->：提供一个可以跨集群中心的多<code>K8S</code>统一管理功能<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>Prometheus</code><!-- raw HTML omitted -->：提供一个<code>K8S</code>集群监控能力<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>ELK</code><!-- raw HTML omitted -->：提供<code>K8S</code>集群日志统一分析介入平台<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>K8S</code>部署方式分为<!-- raw HTML omitted -->二进制<!-- raw HTML omitted -->以及<!-- raw HTML omitted -->快速部署<!-- raw HTML omitted -->方式，官方给予<!-- raw HTML omitted -->三种快速部署<!-- raw HTML omitted -->方式：<a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/" rel="external" target="_self">使用<code>kubeadm</code>引导集群</a>、<a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kops/" rel="external" target="_self">使用<code>Kops</code>安装<code>Kubernetes</code></a>、<a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubespray/" rel="external" target="_self">使用<code>Kubespray</code>安装<code>Kubernetes</code></a></p>
</li>
</ul>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/kubewharf" rel="external" target="_self"><code>KubeWharf</code>轻量级多租户</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/kubernetes/perf-tests" rel="external" target="_self"><code>Kubernetes</code>性能测试</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://learnk8s.io/a/a-visual-guide-on-troubleshooting-kubernetes-deployments/troubleshooting-kubernetes.en_en.v3.pdf" rel="external" target="_self"><code>kubernetes</code>排错思维</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://kubespray.io/#/docs/getting-started" rel="external" target="_self"><code>Ansible-playbook</code>使用<code>kubespray</code>安装<code>K8S</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/easzlab/kubeasz" rel="external" target="_self"><code>kubeasz</code></a><!-- raw HTML omitted --><a href="https://www.cnblogs.com/evescn/p/16915701.html" rel="external" target="_self"><code>kubeasz</code>安装<code>Kubernetes</code>集群</a></td>
<td>**<code>kubeasz</code>**致力于提供快速部署高可用<code>k8s</code>集群的工具, 同时也努力成为<code>k8s</code>实践、使用的参考书；基于二进制方式部署和利用<code>ansible-playbook</code>实现自动化；既提供一键安装脚本, 也可以根据<code>安装指南</code>分步执行安装各个组件</td>
</tr>
<tr>
<td><a href="https://kubespray.io/#/" rel="external" target="_self"><code>kubespray</code></a></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<h2 id="服务器端口准备">服务器、端口准备</h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->部署一主三从<!-- raw HTML omitted --><code>kubernetes</code>架构</li>
</ol>
</li>
</ul>
<blockquote>

<pre class="mermaid align-center zoomable">graph TD
F[一主多从] 
A{{K8S-Master}} ==&gt; B{{K8S-Nodes}}
A{{K8S-Master}} ==&gt; C{{K8S-Nodes}}
A{{K8S-Master}} ==&gt; D{{K8S-Nodes}}
Z[多主多从]
G{{K8S-Master}} ==&gt; J{{K8S-Nodes}}
G{{K8S-Master}} ==&gt; K{{K8S-Nodes}}
G{{K8S-Master}} ==&gt; L{{K8S-Nodes}}
H{{K8S-Master}} ==&gt; J{{K8S-Nodes}}
H{{K8S-Master}} ==&gt; K{{K8S-Nodes}}
H{{K8S-Master}} ==&gt; L{{K8S-Nodes}} </pre><table>
<thead>
<tr>
<th>角色</th>
<th><code>IP</code>地址</th>
<th>配置</th>
<th>操作系统</th>
</tr>
</thead>
<tbody>
<tr>
<td>Master</td>
<td>192.168.35.128</td>
<td><code>2core、4G、80Gdisk</code></td>
<td><code>CentOS Linux release 7.9.2</code></td>
</tr>
<tr>
<td>node-1</td>
<td>192.168.35.129</td>
<td><code>2core、1G、60Gdisk</code></td>
<td><code>CentOS Linux release 7.9.2</code></td>
</tr>
<tr>
<td>node-2</td>
<td>192.168.35.130</td>
<td><code>2core、1G、60Gdisk</code></td>
<td><code>CentOS Linux release 7.9.2</code></td>
</tr>
</tbody>
</table>
<ul>
<li><!-- raw HTML omitted -->集群架构<!-- raw HTML omitted --></li>
</ul>
<table>
<thead>
<tr>
<th>角色</th>
<th><code>IP</code>地址</th>
<th>配置</th>
<th>操作系统</th>
</tr>
</thead>
<tbody>
<tr>
<td>Master-1</td>
<td>192.168.80.210</td>
<td><code>2core、4G、80Gdisk</code></td>
<td><code>CentOS Linux release 7.9.2</code></td>
</tr>
<tr>
<td>Master-2</td>
<td>192.168.80.211</td>
<td><code>2core、4G、80Gdisk</code></td>
<td><code>CentOS Linux release 7.9.2</code></td>
</tr>
<tr>
<td>node-1</td>
<td>192.168.80.212</td>
<td><code>2core、2G、60Gdisk</code></td>
<td><code>CentOS Linux release 7.9.2</code></td>
</tr>
<tr>
<td>node-2</td>
<td>192.168.80.213</td>
<td><code>2core、2G、60Gdisk</code></td>
<td><code>CentOS Linux release 7.9.2</code></td>
</tr>
<tr>
<td>node-3</td>
<td>192.168.80.215</td>
<td><code>2core、2G、60Gdisk</code></td>
<td><code>CentOS Linux release 7.9.2</code></td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->控制节点<!-- raw HTML omitted --><code>master</code>：集群的控制平面，负责集群的决策，以及需要开放的端口</li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>协议</th>
<th>方向</th>
<th>端口范围</th>
<th>作用</th>
<th>使用者</th>
</tr>
</thead>
<tbody>
<tr>
<td>TCP</td>
<td>入站</td>
<td>6443</td>
<td><code>Kubernetes API</code> 服务器</td>
<td>所有组件,管理员操作<code>Kubernetes</code>的接口。因此，<code>API</code>服务器通常暴露在控制平面之外。<code>API</code>服务器被设计成可扩展的，可能存在于多个控制平面节点上</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>2379-2380</td>
<td><code>etcd</code>服务器客户端 <code>API</code></td>
<td><code>kube-apiserver, etcd</code>，持久化的备份存储，关于集群状态的所有信息都保存在这里。<code>Etcd</code>不应该被直接操作，而应该通过 <code>API</code> 服务器来管理。</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>10250</td>
<td><code>Kubelet API</code></td>
<td><code>kubelet</code>自身、在每个工作节点上运行，以协调和验证<code>Pod</code>的执行</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>10259</td>
<td><code>kube-scheduler</code></td>
<td><code>kube-scheduler</code>自身，跟踪工作节点的状态并决定在哪里运行 Pod。<code>Kube-scheduler</code> 只可以由控制平面内的节点访问。</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>10257</td>
<td><code>kube-controller-manager</code></td>
<td><code>kube-controller-manager</code>自身，监视<code>Kubernetes</code>集群，以检测和维护<code>Kubernetes</code>环境的几个方面，包括将<code>Pod</code>加入到服务中，保持一组<code>Pod</code>的正确数量，并对节点的丢失做出反应</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>10258</td>
<td><code>Cloud controller manager</code></td>
<td>一个用于基于云的部署的可选组件。云控制器与云服务提供商接口，以管理集群的负载均衡器和虚拟网络</td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->工作节点<!-- raw HTML omitted --><code>node</code>：集群的数据平面，负责为容器提供运行环境 ，需要开放的端口</li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>协议</th>
<th>方向</th>
<th>端口范围</th>
<th>作用</th>
<th>使用者</th>
</tr>
</thead>
<tbody>
<tr>
<td>TCP</td>
<td>入站</td>
<td>10250</td>
<td><code>Kubelet API</code></td>
<td><code>kubelet</code>自身、控制平面组件</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>30000-32767</td>
<td><code>NodePort</code>服务†</td>
<td>所有组件</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h3 id="初始化环境">初始化环境</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->设置三台主机名<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ hostnamectl set-hostname k8s-master-128
</span></span><span style="display:flex;"><span>$ hostnamectl set-hostname k8s-node-01-129
</span></span><span style="display:flex;"><span>$ hostnamectl set-hostname k8s-node-02-130</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->设置集群的主机名<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ hostnamectl set-hostname k8s-master-1-80-210
</span></span><span style="display:flex;"><span>$ hostnamectl set-hostname k8s-master-2-80-211
</span></span><span style="display:flex;"><span>$ hostnamectl set-hostname k8s-node-1-80-212
</span></span><span style="display:flex;"><span>$ hostnamectl set-hostname k8s-node-2-80-213
</span></span><span style="display:flex;"><span>$ hostnamectl set-hostname k8s-node-3-80-215</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->分别在三台服务器做本地<!-- raw HTML omitted --><code>hosts</code><!-- raw HTML omitted -->解析<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;&gt;/etc/hosts<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.35.128 k8s-master-01
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.35.129 k8s-node-01
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.35.130 k8s-node-02
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->五台服务器的集群<!-- raw HTML omitted --><code>hosts</code><!-- raw HTML omitted -->配置<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;&gt;/etc/hosts<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.80.210 k8s-master-01
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.80.211 k8s-master-02
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.80.212 k8s-node-01
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.80.213 k8s-node-02
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.80.215 k8s-node-03
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.80.220 k8s-master-lb # VIP(虚拟IP)用于LoadBalance，如果不是高可用集群，该IP可以是k8s-master01的IP 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->设置时间同步，修改时区两种方式<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>tzdata</code><!-- raw HTML omitted -->时区软件包<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install tzdata 
</span></span><span style="display:flex;"><span>$ timedatectl set-timezone Asia/Shanghai</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->第一种<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->第二种<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl enable chronyd.service <span style="color:#f92672">&amp;&amp;</span> systemctl start chronyd.service</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->关闭防火墙并禁止开机自启<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl disable firewalld <span style="color:#f92672">&amp;&amp;</span> systemctl stop firewalld</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->关闭<!-- raw HTML omitted --><code>SElinux</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ setenforce <span style="color:#ae81ff">0</span>  	<span style="color:#75715e"># 临时关闭Selinux</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s/^SELINUX=.*/SELINUX=disabled/&#39;</span> /etc/selinux/config  	<span style="color:#75715e"># 永久关闭Selinux</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="6">
<li><!-- raw HTML omitted -->关闭<!-- raw HTML omitted --><code>swap</code><!-- raw HTML omitted -->交换分区<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sed -ri <span style="color:#e6db74">&#39;s/.*swap.*/#&amp;/&#39;</span> /etc/fstab <span style="color:#f92672">&amp;&amp;</span> swapoff -a</span></span></code></pre></div><ul>
<li><code>Ubunt</code><!-- raw HTML omitted -->关闭交换分区<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;etc/fstab<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/dev/disk/by-uuid/95e38332-76fc-4d2f-81a4-04bc581f2ed3 none swap sw,noauto 0 0  	# 添加：noauto
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># /swap.img     none    swap    sw      0       0  	# 添加注释
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查询验证，输出为空则生效</span>
</span></span><span style="display:flex;"><span>$ sudo swapon --show</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="7">
<li>允许<code>iptables</code><!-- raw HTML omitted -->检查桥接流量<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->确保<!-- raw HTML omitted --><code>br_netfilter</code><!-- raw HTML omitted -->模块被加载。这一操作可以通过运行<!-- raw HTML omitted --><code>lsmod | grep br_netfilter</code><!-- raw HTML omitted -->来完成。若要显式加载该模块，可执行<!-- raw HTML omitted --><code>modprobe br_netfilter</code></li>
<li><!-- raw HTML omitted -->为了让你的<!-- raw HTML omitted --><code>Linux</code><!-- raw HTML omitted -->节点上的<!-- raw HTML omitted --><code>iptables</code><!-- raw HTML omitted -->能够正确地查看桥接流量，你需要确保在你的<!-- raw HTML omitted --><code>sysctl</code><!-- raw HTML omitted -->配置中将<!-- raw HTML omitted --><code>net.bridge.bridge-nf-call-iptables</code><!-- raw HTML omitted -->设置为 1<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat <span style="color:#e6db74">&lt;&lt;EOF | sudo tee /etc/modules-load.d/k8s.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">br_netfilter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat <span style="color:#e6db74">&lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.bridge.bridge-nf-call-iptables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.ip_forward = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sysctl --system
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##########################################################  使用脚本函数</span>
</span></span><span style="display:flex;"><span>__k8s_kernel_iptables<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 加载br_netfilter模块</span>
</span></span><span style="display:flex;"><span>    modprobe br_netfilter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 查看是否加载</span>
</span></span><span style="display:flex;"><span>    lsmod | grep br_netfilter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 写内核配置文件</span>
</span></span><span style="display:flex;"><span>    cat &gt;/etc/sysctl.d/k8s.conf <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.bridge.bridge-nf-call-iptables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.ip_forward = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">vm.swappiness = 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 内核参数生效</span>
</span></span><span style="display:flex;"><span>    sysctl --system
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>__k8s_kernel_iptables</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="8">
<li><!-- raw HTML omitted -->开启<!-- raw HTML omitted --><code>ipvs</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>在<code>kubernetes</code>中<code>service</code>有两种代理模型，一种是基于<code>iptables</code>，另一种是基于<code>ipvs</code>的。<code>ipvs</code>的性能要高于<code>iptables</code>的，但是如果要使用它，需要手动载入<code>ipvs</code>模块。</li>
<li><code>Centos</code><!-- raw HTML omitted -->系统在每个节点安装配置<!-- raw HTML omitted --><code>ipset</code>和<code>ipvsadm</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install ipset ipvsadm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在所有节点执行如下脚本</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/etc/sysconfig/modules/ipvs.modules<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_rr
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_wrr
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- nf_conntrack_ipv4  	# 高版本替换为nf_conntrack
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 授权、运行、检查是否加载</span>
</span></span><span style="display:flex;"><span>$ chmod <span style="color:#ae81ff">755</span> /etc/sysconfig/modules/ipvs.modules <span style="color:#f92672">&amp;&amp;</span> bash /etc/sysconfig/modules/ipvs.modules
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 检查是否加载</span>
</span></span><span style="display:flex;"><span>$ lsmod | grep -e ipvs -e nf_conntrack_ipv4</span></span></code></pre></div><ul>
<li><code>Debian</code><!-- raw HTML omitted -->系统在每个节点安装配置<!-- raw HTML omitted --><code>ipset</code>和<code>ipvsadm</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -vp /etc/modules.d/
</span></span><span style="display:flex;"><span>$ tee /etc/modules.d/k8s.modules <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># netfilter 模块 允许 iptables 检查桥接流量
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- br_netfilter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># containerd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- overlay
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># nf_conntrack
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- nf_conntrack
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ipvs
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_lc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_lblc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_lblcr
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_rr
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_wrr
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_dh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_fo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_nq
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_sed
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_ftp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_tables
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_set
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ipt_set
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ipt_rpfilter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ipt_REJECT
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ipip
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- xt_set
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ chmod <span style="color:#ae81ff">755</span> /etc/modules.d/k8s.modules <span style="color:#f92672">&amp;&amp;</span> bash /etc/modules.d/k8s.modules <span style="color:#f92672">&amp;&amp;</span> lsmod | grep -e ip_vs -e nf_conntrack  
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ip_vs_sh               16384  0  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ip_vs_wrr              16384  0  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ip_vs_rr               16384  0  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ip_vs                 155648  6 ip_vs_rr,ip_vs_sh,ip_vs_wrr  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># nf_conntrack          139264  1 ip_vs  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># nf_defrag_ipv6         24576  2 nf_conntrack,ip_vs  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># nf_defrag_ipv4         16384  1 nf_conntrack  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># libcrc32c              16384  5 nf_conntrack,btrfs,xfs,raid456,ip_vs</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sysctl --system</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="9">
<li><!-- raw HTML omitted -->所有节点配置<!-- raw HTML omitted --><code>Limit</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ulimit -SHn <span style="color:#ae81ff">65536</span>  	<span style="color:#75715e"># 临时生效</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* soft nproc 65535  	# soft 软限制
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* hard nproc 65535  	# hard 硬限制
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* soft nofile 25535
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* hard nofile 25535
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* soft memlock unlimited
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* soft memlock unlimited &#34;</span> &gt;&gt;/etc/security/limits.conf  	<span style="color:#75715e"># 永久生效</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="10">
<li><code>k8s-master01</code><!-- raw HTML omitted -->节点设置免密登录其他节点<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>ssh-keygen</code><!-- raw HTML omitted -->：用于创建密钥的程序<!-- raw HTML omitted --></li>
<li><code>-m PEM</code><!-- raw HTML omitted -->：将密钥的格式设为<!-- raw HTML omitted --><code>PEM</code></li>
<li><code>-t rsa</code><!-- raw HTML omitted -->：创建密钥类型为：<code>RSA</code>格式，系统默认提供名为 <code>id_rsa</code> 的密钥对，有些工具可能要求私钥文件名为<!-- raw HTML omitted --><code>id_rsa</code></li>
<li><code>-b 4096</code><!-- raw HTML omitted -->：密钥的位数，本例中为<!-- raw HTML omitted --><code>4096</code></li>
<li><code>-C &quot;xxx@myserver&quot;</code><!-- raw HTML omitted -->：追加到公钥文件末尾以便于识别的注释。 通常以电子邮件地址用作注释，但也可以使用任何最适合你基础结构的事物<!-- raw HTML omitted --></li>
<li><code>-f ~/.ssh/</code><!-- raw HTML omitted -->：私钥文件的文件名（如果选择不使用默认名称）。 追加了<code>.pub</code>的相应公钥文件在相同目录中生成。 该目录必须存在<!-- raw HTML omitted --></li>
<li><code>-N mypassphrase</code><!-- raw HTML omitted -->：用于访问私钥文件的其他密码<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ssh-keygen <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-m PEM <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-t rsa <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-b <span style="color:#ae81ff">4096</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-C <span style="color:#e6db74">&#34;xxx@163.com&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-f ~/.ssh/name_rsa <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-N mypassphrase
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ <span style="color:#66d9ef">for</span> i in master-01 master-02 noder-01 noder-02 noder-03;<span style="color:#66d9ef">do</span> ssh-copy-id -i .ssh/id_rsa.pub $i;<span style="color:#66d9ef">done</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="11">
<li><!-- raw HTML omitted -->所有节点更新系统并且重启<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y --exclude<span style="color:#f92672">=</span>kernel* update <span style="color:#f92672">&amp;&amp;</span> reboot</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="12">
<li><!-- raw HTML omitted -->升级系统<!-- raw HTML omitted --><code>Kernel</code>内核到<code>4.18+</code>以上</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org
</span></span><span style="display:flex;"><span>$ rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 令列出可用的内核相关包</span>
</span></span><span style="display:flex;"><span>$ yum --disablerepo<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;*&#34;</span> --enablerepo<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;elrepo-kernel&#34;</span> list available
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装最新主线稳定内核</span>
</span></span><span style="display:flex;"><span>$ yum -y --enablerepo<span style="color:#f92672">=</span>elrepo-kernel install kernel-ml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设置 GRUB 默认的内核版本：</span>
</span></span><span style="display:flex;"><span>$ vim /etc/default/grub
</span></span><span style="display:flex;"><span>GRUB_DEFAULT<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>  	<span style="color:#75715e"># 修改部分， GRUB 初始化页面的第一个内核将作为默认内核</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 重新创建内核配置</span>
</span></span><span style="display:flex;"><span>$ grub2-mkconfig -o /boot/grub2/grub.cfg
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ reboot</span></span></code></pre></div></blockquote>
<hr>
<h3 id="所有节点都安装docker">所有节点都安装<code>docker</code></h3>
<ul>
<li>
<ol>
<li><code>yum</code><!-- raw HTML omitted -->源的使用<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->使用官方源 <!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum install -y yum-utils
</span></span><span style="display:flex;"><span>$ yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->使用阿里云官方<code>repo</code>源<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 备份服务器上原有的CentOS-Base和epel</span>
</span></span><span style="display:flex;"><span>$ mv /etc/yum.repos.d/CentOS-Base.repo<span style="color:#f92672">{</span>,.bak<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>$ mv /etc/yum.repos.d/epel.repo<span style="color:#f92672">{</span>,.bak<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装CentOS0-Base和epel源 </span>
</span></span><span style="display:flex;"><span>$ curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo
</span></span><span style="display:flex;"><span>$ curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 第一种方式安装docker 源  </span>
</span></span><span style="display:flex;"><span>$ wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 第二种方式docker源</span>
</span></span><span style="display:flex;"><span>$ yum install -y yum-utils device-mapper-persistent-data lvm2
</span></span><span style="display:flex;"><span>$ yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 做替换</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s+download.docker.com+mirrors.aliyun.com/docker-ce+&#39;</span> /etc/yum.repos.d/docker-ce.repo</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->卸载服务器自带<!-- raw HTML omitted --><code>docker</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->安装对应<code>docker</code>版本服务<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum makecache fast
</span></span><span style="display:flex;"><span>$ yum list docker-ce  --showduplicates|sort -r
</span></span><span style="display:flex;"><span>$ yum install -y docker-ce-20.10.4 docker-ce-cli-20.10.4 containerd.io docker-compose-plugin
</span></span><span style="display:flex;"><span>$ systemctl enable docker <span style="color:#f92672">&amp;&amp;</span> systemctl start docker</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>docker-compose</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo curl -L <span style="color:#e6db74">&#34;https://github.com/docker/compose/releases/download/v2.2.2/docker-compose-</span><span style="color:#66d9ef">$(</span>uname -s<span style="color:#66d9ef">)</span><span style="color:#e6db74">-</span><span style="color:#66d9ef">$(</span>uname -m<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> -o /usr/local/bin/docker-compose
</span></span><span style="display:flex;"><span>$ chmod +x /usr/local/bin/docker-compose
</span></span><span style="display:flex;"><span>$ ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose
</span></span><span style="display:flex;"><span>$ docker compose COMMAND --help  	<span style="color:#75715e"># 查看镜像编写方式</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="6">
<li><code>Kubernetes</code><!-- raw HTML omitted -->文件驱动默认由<!-- raw HTML omitted --><code>systemd</code><!-- raw HTML omitted -->改成<!-- raw HTML omitted --><code>cgroupfs</code><!-- raw HTML omitted -->, 而我们安装的<!-- raw HTML omitted --><code>docker</code><!-- raw HTML omitted -->使用的文件驱动是<!-- raw HTML omitted --><code>systemd</code><!-- raw HTML omitted -->, 造成不一致, 导致镜像无法启动<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>&quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo cat &gt;/etc/docker/daemon.json<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;registry-mirrors&#34;: [&#34;https://bn4ll166.mirror.aliyuncs.com&#34;],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;data-root&#34;: &#34;/data/docker-root&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;dns&#34;: [&#34;223.5.5.5&#34;,&#34;119.29.29.29&#34;],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;bip&#34;: &#34;172.31.255.254/16&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;storage-driver&#34;: &#34;overlay2&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;storage-opts&#34;: [&#34;overlay2.override_kernel_check=true&#34;],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;userland-proxy&#34;: false,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;log-driver&#34;: &#34;json-file&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;log-opts&#34;: {&#34;max-size&#34;: &#34;500m&#34;,&#34;max-file&#34;: &#34;1&#34;},
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;exec-opts&#34;: [&#34;native.cgroupdriver=systemd&#34;],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;live-restore&#34;: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="7">
<li><a href="https://www.qikqiak.com/k8s-book/docs/1.%E8%AF%BE%E7%A8%8B%E4%BB%8B%E7%BB%8D.html" rel="external" target="_self"><code>Docker</code>+<code>Kubernetes</code></a></li>
</ol>
</li>
</ul>
<hr>
<h3 id="所有节点配置kubernetes-yum源">所有节点配置<code>kubernetes yum</code>源</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->国内修改为阿里云<code>yum</code>源 <!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/yum.repos.d/kubernetes.repo<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[kubernetes]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name=Kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">enabled=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgcheck=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">repo_gpgcheck=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->直接使用<code>kubernetes</code>官方<code>yum</code>源<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat <span style="color:#e6db74">&lt;&lt;-EOF | sudo tee /etc/yum.repos.d/kubernetes.repo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[kubernetes]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name=Kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\$basearch
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">enabled=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgcheck=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">exclude=kubelet kubeadm kubectl
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->重启所有节点服务器<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ reboot</span></span></code></pre></div></blockquote>
<hr>
<h3 id="所有节点都安装kubeadmkubeletkubectl">所有节点都安装<code>kubeadm、kubelet、kubectl</code></h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum list kubelet kubeadm kubectl  --showduplicates | sort -r
</span></span><span style="display:flex;"><span>$ yum -y install kubelet-1.24.5 kubeadm-1.24.5 kubectl-1.24.5</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol>
<li><code>--cgroup-driver=systemd</code><!-- raw HTML omitted -->：为了实现<!-- raw HTML omitted --><code>Docker</code><!-- raw HTML omitted -->使用的<!-- raw HTML omitted --><code>cgroup drvier</code><!-- raw HTML omitted -->和<!-- raw HTML omitted --><code>kubelet</code><!-- raw HTML omitted -->使用的<!-- raw HTML omitted --><code>cgroup</code><!-- raw HTML omitted -->默认值为一致，<!-- raw HTML omitted --><code>/etc/sysconfig/kubelet</code><!-- raw HTML omitted -->文件中添加<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>--fail-swap-on=false</code><!-- raw HTML omitted -->忽略<code>swap</code>报错<!-- raw HTML omitted --></li>
<li><code>--feature-gates EphemeralContainers=true</code><!-- raw HTML omitted -->开启临时容器参数<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubelet -h | grep EphemeralContainers</span></span></code></pre></div><div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/sysconfig/kubelet<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">KUBELET_EXTRA_ARGS=&#34;--cgroup-driver=systemd --fail-swap-on=false&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">KUBE_PROXY_MODE=&#34;ipvs&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->置为开机自启动即可，由于没有生成配置文件，集群初始化后自动启动<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl enable kubelet <span style="color:#f92672">&amp;&amp;</span> systemctl start kubelet</span></span></code></pre></div></blockquote>
<hr>
<h2 id="使用kubeadm部署kubernetes">使用<code>Kubeadm</code>部署<code>Kubernetes</code></h2>
<h3 id="查看下载所需镜像">查看下载所需镜像</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->查看<!-- raw HTML omitted --><code>k8s</code><!-- raw HTML omitted -->所需镜像<!-- raw HTML omitted --><code>kubeadm config images list</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm config images list   <span style="color:#75715e"># list替换：pull、拉取镜像</span>
</span></span><span style="display:flex;"><span>k8s.gcr.io/kube-apiserver:v1.24.6
</span></span><span style="display:flex;"><span>k8s.gcr.io/kube-controller-manager:v1.24.6
</span></span><span style="display:flex;"><span>k8s.gcr.io/kube-scheduler:v1.24.6
</span></span><span style="display:flex;"><span>k8s.gcr.io/kube-proxy:v1.24.6
</span></span><span style="display:flex;"><span>k8s.gcr.io/pause:3.7
</span></span><span style="display:flex;"><span>k8s.gcr.io/etcd:3.5.3-0
</span></span><span style="display:flex;"><span>k8s.gcr.io/coredns/coredns:v1.8.6
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ docker images --digests  	<span style="color:#75715e"># 验证镜像完整性</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->下载<code>K8S</code>所需镜像 (如果过程中有提示失败迹象, 那么可能是网络原因, 多执行几次)<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm config images list | xargs -n1 docker pull  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 指定拉取阿里云源的镜像  </span>
</span></span><span style="display:flex;"><span>$ kubeadm config images pull --kubernetes-version<span style="color:#f92672">=</span>v1.20.2 --image-repository<span style="color:#f92672">=</span>registry.aliyuncs.com/google_containers  </span></span></code></pre></div></blockquote>
<hr>
<h3 id="部署master节点">部署<code>master</code>节点</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->两种方式部署<!-- raw HTML omitted --><code>Master</code>节点：<strong>命令行</strong>和**<code>yaml</code>**</li>
<li><!-- raw HTML omitted -->**注意：**主机名中不能带有_（下划线），不然初始化会报错<!-- raw HTML omitted --><a href="https://kubernetes.io/zh/docs/reference/setup-tools/kubeadm/kubeadm-init/" rel="external" target="_self"><code>kubeadm init</code></a></li>
</ul>
</blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->使用命令行方式初始化<!-- raw HTML omitted --><code>Kubernetes</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>--kubernetes-version</code>：指定版本</li>
<li><code>--apiserver-advertise-address</code>：<code>master</code>本机<code>IP</code></li>
<li><code>--service-cidr</code>：<!-- raw HTML omitted -->用于指定为<code>Service</code>分配使用网络地址，它由<code>kubernetes</code>管理，默认网段：<code>10.96.0.0/12</code><!-- raw HTML omitted --></li>
<li><code>--pod-network-cidr</code>：<!-- raw HTML omitted -->启动容器给容器所分配<code>IP</code>，<code>ip a</code>可以查看服务器本机生成<code>IP</code>段，当有从集群外节点通过静态路由方式访问集群内<code>Service</code>的需求时，需要在创建集群时指定<code>pod-network-cidr</code>， 以对来自非<code>Pod</code>网络的流量(外部流量)执行<code>MASQ</code>，外部访问pod服务做<code>nat</code>转发,它通常应该与部署使用的网络插件(例如：<code>flannel</code>、<code>calico</code>)默认设定保持一致，<code>10.244.0.0/16</code>是<code>flannel</code>默认使用网络<!-- raw HTML omitted --></li>
<li><code>--ignore-preflight-errors=Swap</code>：<!-- raw HTML omitted -->通过此参数忽略swap报错<!-- raw HTML omitted --></li>
<li><code>--image-repository registry.aliyuncs.com/google_containers</code>：<!-- raw HTML omitted -->指定从阿里云下载<!-- raw HTML omitted --></li>
<li><code>--cri-socket</code>：<!-- raw HTML omitted -->配置<code>CRI</code>端点<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm init --kubernetes-version<span style="color:#f92672">=</span>v1.24.6 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--apiserver-advertise-address<span style="color:#f92672">=</span>192.168.35.128 --node-name<span style="color:#f92672">=</span>k8s-master <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--service-cidr<span style="color:#f92672">=</span>10.64.0.0/12 --pod-network-cidr<span style="color:#f92672">=</span>10.244.0.0/16 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cri-socket unix:///var/run/containerd/containerd.sock  	<span style="color:#75715e"># 配置 CRI 端点</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->通过配置文件初始化<!-- raw HTML omitted --><code>Kubernetes</code>的<code>master</code>节点</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 输出初始化配置到文件</span>
</span></span><span style="display:flex;"><span>$ kubeadm config print init-defaults &gt;/opt/k8s/yaml/kubeadm-config.yaml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改配置文件</span>
</span></span><span style="display:flex;"><span>apiVersion: kubeadm.k8s.io/v1beta3
</span></span><span style="display:flex;"><span>bootstrapTokens:
</span></span><span style="display:flex;"><span>- groups:
</span></span><span style="display:flex;"><span>    - system:bootstrappers:kubeadm:default-node-token
</span></span><span style="display:flex;"><span>    token: abcdef.0123456789abcdef
</span></span><span style="display:flex;"><span>    ttl: 24h0m0s
</span></span><span style="display:flex;"><span>    usages:
</span></span><span style="display:flex;"><span>    - signing
</span></span><span style="display:flex;"><span>    - authentication
</span></span><span style="display:flex;"><span>kind: InitConfiguration
</span></span><span style="display:flex;"><span>localAPIEndpoint:
</span></span><span style="display:flex;"><span>    advertiseAddress: 1.2.3.4  	<span style="color:#75715e"># 修改为master本机IP</span>
</span></span><span style="display:flex;"><span>    bindPort: <span style="color:#ae81ff">6443</span>  	<span style="color:#75715e"># 使用端口</span>
</span></span><span style="display:flex;"><span>nodeRegistration:
</span></span><span style="display:flex;"><span>    criSocket: unix:///var/run/containerd/containerd.sock  	<span style="color:#75715e"># 配置 CRI 端点</span>
</span></span><span style="display:flex;"><span>    imagePullPolicy: IfNotPresent
</span></span><span style="display:flex;"><span>    name: node  	<span style="color:#75715e"># 配置主机名， 主机名不允许使用下划线</span>
</span></span><span style="display:flex;"><span>    taints: null
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiServer:
</span></span><span style="display:flex;"><span>    timeoutForControlPlane: 4m0s
</span></span><span style="display:flex;"><span>apiVersion: kubeadm.k8s.io/v1beta3
</span></span><span style="display:flex;"><span>certificatesDir: /etc/kubernetes/pki
</span></span><span style="display:flex;"><span>clusterName: kubernetes
</span></span><span style="display:flex;"><span>controllerManager: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>dns: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>etcd:
</span></span><span style="display:flex;"><span>    local:
</span></span><span style="display:flex;"><span>        dataDir: /var/lib/etcd
</span></span><span style="display:flex;"><span>imageRepository: k8s.gcr.io  	<span style="color:#75715e"># 定义使用镜像源</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## imageRepository: registry.aliyuncs.com/google_containers  	# 阿里云镜像源</span>
</span></span><span style="display:flex;"><span>kind: ClusterConfiguration
</span></span><span style="display:flex;"><span>kubernetesVersion: 1.24.6  	<span style="color:#75715e"># 定义kubernetes版本</span>
</span></span><span style="display:flex;"><span>networking:
</span></span><span style="display:flex;"><span>    dnsDomain: cluster.local
</span></span><span style="display:flex;"><span>    serviceSubnet: 10.96.0.0/12  	<span style="color:#75715e"># 10.244.0.0/16 是`flannel`默认使用网络</span>
</span></span><span style="display:flex;"><span>scheduler: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiVersion: kubeproxy.config.k8s.io/v1alpha1
</span></span><span style="display:flex;"><span>kind: KubeProxyConfiguration
</span></span><span style="display:flex;"><span>featureGates:
</span></span><span style="display:flex;"><span>    SupportIPVSProxyMode: true
</span></span><span style="display:flex;"><span>mode: ipvs  	<span style="color:#75715e"># 启用ipvs  </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubeadm init --config<span style="color:#f92672">=</span>/opt/k8s/yaml/kubeadm-config.yaml  	<span style="color:#75715e"># 初始化配置文件</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->如果初始化报错执行下面命令、然后重新初始化<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">############################################################# 	 配置containerd服务</span>
</span></span><span style="display:flex;"><span>$ rm -rf /etc/containerd/config.toml
</span></span><span style="display:flex;"><span>$ containerd config default &gt;/etc/containerd/config.toml  	<span style="color:#75715e"># 生成新配置来覆盖默认配置</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo cat &gt;&gt;/etc/containerd/config.toml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[plugins.&#34;io.containerd.grpc.v1.cri&#34;.containerd.runtimes.runc.options]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> SystemdCgroup = false  	# 修改为：true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>$ systemctl restart containerd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#############################################################  	kubelet 配置文件修改</span>
</span></span><span style="display:flex;"><span>$ sudo cat &gt;&gt;/var/lib/kubelet/kubeadm-flags.env<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">KUBELET_KUBEADM_ARGS=&#34;--container-runtime-endpoint=unix:///var/run/containerd/containerd.sock --pod-infra-container-image=registry.k8s.io/pause:3.9&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动配置增加--container-runtime=remote --container-runtime-endpoint=unix:///var/run/containerd/containerd.sock</span>
</span></span><span style="display:flex;"><span>$ sudo cat &gt;&gt;/usr/lib/systemd/system/kubelet.service<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/usr/bin/kubelet --container-runtime=remote --container-runtime-endpoint=unix:///var/run/containerd/containerd.sock
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">############################################################## 	 删除配置重载</span>
</span></span><span style="display:flex;"><span>$ swapoff -a <span style="color:#f92672">&amp;&amp;</span> kubeadm reset <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	<span style="color:#f92672">&amp;&amp;</span> systemctl daemon-reload <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	<span style="color:#f92672">&amp;&amp;</span> systemctl restart kubelet <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	<span style="color:#f92672">&amp;&amp;</span> iptables -F <span style="color:#f92672">&amp;&amp;</span> iptables -t nat -F <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	<span style="color:#f92672">&amp;&amp;</span> iptables -t mangle -F <span style="color:#f92672">&amp;&amp;</span> iptables -X</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->查看<code>node</code>信息<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl get nodes
</span></span><span style="display:flex;"><span>NAME         STATUS   ROLES                  AGE   VERSION
</span></span><span style="display:flex;"><span>k8s-master   Ready    control-plane,master   23h   v1.21.12
</span></span><span style="display:flex;"><span>k8s-node1    Ready    &lt;none&gt;                 23h   v1.21.12
</span></span><span style="display:flex;"><span>k8s-node2    Ready    &lt;none&gt;                 23h   v1.21.12</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->根据提示消息，在<code>Master</code>节点上使用<code>kubectl</code>工具，可以把下列<code>.kube</code>目录同步到<code>node</code>节点，以便<code>node</code>节点使用<code>kubectl</code>工具<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted --><strong>注意：</strong><!-- raw HTML omitted -->如果不执行<!-- raw HTML omitted -->以下命令<!-- raw HTML omitted -->，执行<code>kubectl get nodes</code>命令报错：<code>couldn't get current server API group list: Get &quot;http://localhost:8080/api?timeout=32s&quot;: dial tcp [::1]:8080: connect: connection refused</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -p $HOME/.kube
</span></span><span style="display:flex;"><span>$ cp -i /etc/kubernetes/admin.conf <span style="color:#e6db74">${</span>HOME<span style="color:#e6db74">}</span>/.kube/config
</span></span><span style="display:flex;"><span>$ chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> <span style="color:#e6db74">${</span>HOME<span style="color:#e6db74">}</span>/.kube/config
</span></span><span style="display:flex;"><span>$ scp -r /root/.kube root@k8s-node-01:/root/</span></span></code></pre></div></blockquote>
<hr>
<h3 id="node节点加入集群"><code>node</code>节点加入集群</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->当主节点启动完<code>k8s</code>之后会生成加入节点的命令，视自己服务器而定<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm join 192.168.35.128:6443 --token l37r7y.75gjs1ltufdp8kp2 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	--discovery-token-ca-cert-hash sha256:9ebc670ec3f97b5f42d77908f378786ed806ef22e9ae2cf21fe5fb239483833c</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->默认<code>token</code>有效期为24小时，当过期之后，该<code>token</code>就不可用了。这时就需要重新创建<code>token</code>，操作如下：<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm token list  	<span style="color:#75715e"># 查看Token</span>
</span></span><span style="display:flex;"><span>$ kubeadm token create --print-join-command
</span></span><span style="display:flex;"><span>$ kubeadm token create --ttl <span style="color:#ae81ff">0</span> --print-join-command  <span style="color:#75715e"># 生成一个永不过期的token</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 重新获取sha56key</span>
</span></span><span style="display:flex;"><span>$ openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outfrom der 2&gt;dev/null | openssl dgst -sha256 -hex | sed <span style="color:#e6db74">&#39;s/^.* //&#39;</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><code>master</code><!-- raw HTML omitted -->执行命令查看节点是否已加入<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl get componentstatuses  	<span style="color:#75715e"># 查看集群健康状况，缩写为：cs</span>
</span></span><span style="display:flex;"><span>NAME                 STATUS    MESSAGE             ERROR
</span></span><span style="display:flex;"><span>scheduler            Healthy   ok                  
</span></span><span style="display:flex;"><span>controller-manager   Healthy   ok                  
</span></span><span style="display:flex;"><span>etcd-0               Healthy   <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;health&#34;</span>:<span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">}</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->查看部署好的命名空间<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>default</code><!-- raw HTML omitted -->：所有未指定的<code>Namespace</code>的对象都会被分配在default命名空间<!-- raw HTML omitted --></li>
<li><code>kube-node-lease</code><!-- raw HTML omitted -->：集群节点之间的心跳维护，<code>v1.13</code>开始引入<!-- raw HTML omitted --></li>
<li><code>kube-public</code><!-- raw HTML omitted -->：此命名空间的资源可以被所有人访问（包括未认证用户）<!-- raw HTML omitted --></li>
<li><code>kube-system</code><!-- raw HTML omitted -->：所有由<code>kubernetes</code>系统创建的资源都处于这个命名空间<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl get namespace  <span style="color:#75715e"># 缩写为： ns</span>
</span></span><span style="display:flex;"><span>NAME              STATUS   AGE 
</span></span><span style="display:flex;"><span>default           Active   19h
</span></span><span style="display:flex;"><span>kube-node-lease   Active   19h
</span></span><span style="display:flex;"><span>kube-public       Active   19h
</span></span><span style="display:flex;"><span>kube-system       Active   19h</span></span></code></pre></div></blockquote>
<hr>
<h4 id="处理集群状态statusnotreadyfont-colorred是网络不通部署fontcnifont-colorred网络插件font">处理集群状态：<code>STATUS：NotReady</code><!-- raw HTML omitted -->是网络不通部署：<!-- raw HTML omitted --><code>CNI</code><!-- raw HTML omitted -->网络插件<!-- raw HTML omitted --></h4>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://segmentfault.com/a/1190000018698263" rel="external" target="_self">网络：<code>Flannel</code>、<code>Calico</code>、<code>Canal</code>和<code>Weave</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://dockone.io/article/10501" rel="external" target="_self">简单聊聊<code>Calico</code>与<code>Flannel</code></a></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li><code>kubernetes</code><!-- raw HTML omitted -->支持多种网络插件，比如<!-- raw HTML omitted --><code>flannel</code>、<code>calico</code>、<code>canal</code><!-- raw HTML omitted -->等，任选一种即可，本次选择<!-- raw HTML omitted --><code>flannel</code><!-- raw HTML omitted -->，当然你也可以安装<!-- raw HTML omitted --><code>calico</code><!-- raw HTML omitted -->，推荐安装<!-- raw HTML omitted --><code>calico</code></li>
<li><!-- raw HTML omitted -->在<code>Master</code>节点上获取<code>flannel</code>配置文件(可能会失败，如果失败，请下载到本地，然后安装)：<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li>
<ol>
<li><code>flannel、calico</code><!-- raw HTML omitted -->：基于隧道<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>隧道方案最具普适性，在任何网络环境下都可以正常工作，这与它的原理密不可分。</li>
<li>最常见的隧道方案是<code>flannel &quot;Type&quot;: &quot;vxlan&quot;</code>模式，以及<code>calico</code>的<code>ipip</code>模式，</li>
</ul>
</blockquote>
<ul>
<li>
<ol start="2">
<li><code>flannel、calico</code><!-- raw HTML omitted -->：基于路由<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>路由方案性能最好，原因是该方案不需要封包和解包，所以没有隧道方案的劣势，网络性能很好。</li>
<li>常见的路由方案包括了<code>flannel</code>的<code>&quot;Type&quot;: &quot;host-gw&quot;</code>模式，以及<code>calico</code>的<code>bgp</code>模式。</li>
<li><code>master</code><!-- raw HTML omitted -->节点执行一下语句安装<!-- raw HTML omitted --><code>calico</code><!-- raw HTML omitted -->网络插件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ curl https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/calico.yaml -O
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 看情况修改 calico配置文件</span>
</span></span><span style="display:flex;"><span>$ cat &gt;calico.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- name: CALICO_IPV4POOL_CIDR  	# 修改 CALICO_IPV4POOL_CIDR对应的参数
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  value: &#34;192.168.1.0/24&#34;  	# 修改为 --pod-network-cidr 对应的网段
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改calico 镜像地址</span>
</span></span><span style="display:flex;"><span>$ grep image calico.yaml
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s#docker.io/##g&#39;</span> calico.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl apply -f calico.yaml</span></span></code></pre></div><ul>
<li><code>master</code><!-- raw HTML omitted -->节点执行一下语句安装<code>flannel</code>网络插件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget -P /opt/k8s/yaml/ https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</span></span><span style="display:flex;"><span>$ kubectl get pods -n kube-system</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><code>kubernetes</code><!-- raw HTML omitted -->中<code>kubectl</code>命令自动补全<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum install -y bash-completion
</span></span><span style="display:flex;"><span>$ source /etc/profile.d/bash_completion.sh</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->集群不健康<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>
<p><!-- raw HTML omitted -->需要注释掉<!-- raw HTML omitted --><code>etc/kubernetes/manifests</code>目录下的<code>kube-controller-manager.yaml</code>和<code>kube-scheduler.yaml</code>的<code>--port=0</code>：</p>
</li>
<li>
<p><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>kube-controller-manager.yaml</code>文件</p>
</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo cat &gt;&gt;/etc/kubernetes/manifests/kube-controller-manager.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - command:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - kube-controller-manager
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --allocate-node-cidrs=true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --authentication-kubeconfig=/etc/kubernetes/controller-manager.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --authorization-kubeconfig=/etc/kubernetes/controller-manager.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --bind-address=127.0.0.1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --client-ca-file=/etc/kubernetes/pki/ca.crt
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --cluster-cidr=10.244.0.0/16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --cluster-name=kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --cluster-signing-cert-file=/etc/kubernetes/pki/ca.crt
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --cluster-signing-key-file=/etc/kubernetes/pki/ca.key
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --controllers=*,bootstrapsigner,tokencleaner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --kubeconfig=/etc/kubernetes/controller-manager.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --leader-elect=true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # 修改部分
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # - --port=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --root-ca-file=/etc/kubernetes/pki/ca.crt
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --service-account-private-key-file=/etc/kubernetes/pki/sa.key
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --service-cluster-ip-range=10.96.0.0/12
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --use-service-account-credentials=true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>kube-scheduler.yaml</code>文件</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo cat &gt;&gt;/etc/kubernetes/manifests/kube-scheduler.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - command:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - kube-scheduler
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --authentication-kubeconfig=/etc/kubernetes/scheduler.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --authorization-kubeconfig=/etc/kubernetes/scheduler.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --bind-address=127.0.0.1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --kubeconfig=/etc/kubernetes/scheduler.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --leader-elect=true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # 修改部分
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # - --port=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在所有Master节点再次查看集群健康状况：</span>
</span></span><span style="display:flex;"><span>$ kubectl get cs</span></span></code></pre></div></blockquote>
<hr>
<h2 id="部署kubernetes集群">部署<code>Kubernetes</code>集群</h2>
<h3 id="安装高可用组件">安装高可用组件</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->注意：如果不是高可用集群，<!-- raw HTML omitted --><code>haproxy</code>和<code>keepalived</code>无需安装</li>
</ul>
</blockquote>
<ul>
<li>
<ol>
<li>所有<code>Master</code>节点安装<code>HAPROXY</code>和<code>Keepalived</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install keepalived haproxy</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->所有<!-- raw HTML omitted --><code>Master</code><!-- raw HTML omitted -->节点配置<!-- raw HTML omitted --><code>HAProxy</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/haproxy/haproxy.cfg<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">global
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	maxconn  2000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	ulimit-n  16384
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	log  127.0.0.1 local0 err
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	stats timeout 30s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">defaults
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	log global
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	mode  http
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	option  httplog
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	timeout connect 5000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	timeout client  50000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	timeout server  50000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	timeout http-request 15s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	timeout http-keep-alive 15s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">frontend monitor-in
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	bind *:33305
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	mode http
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	option httplog
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	monitor-uri /monitor
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">listen stats
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	bind    *:8006
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	mode    http
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	stats   enable
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	stats   hide-version
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	stats   uri       /stats
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	stats   refresh   30s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	stats   realm     Haproxy\ Statistics
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	stats   auth      admin:admin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">frontend k8s-master
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	bind 0.0.0.0:16443
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	bind 127.0.0.1:16443
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	mode tcp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	option tcplog
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	tcp-request inspect-delay 5s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	default_backend k8s-master
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">backend k8s-master
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	mode tcp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	option tcplog
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	option tcp-check
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	balance roundrobin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# 下面的配置根据实际情况修改
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	server k8s-master-01 192.168.80.210:6443  check
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	server k8s-master-02 192.168.80.211:6443  check
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><code>Msster-01</code>的<code>Keepalived</code><!-- raw HTML omitted -->配置文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/keepalived/keepalived.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">! Configuration File for keepalived
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	global_defs {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		# 标识本节点的字条串，通常为 hostname
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		router_id k8s-master-01
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		script_user root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		enable_script_security    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# 检测脚本
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# keepalived会定时执行脚本并对脚本执行的结果进行分析，动态调整vrrp_instance的优先级。如果脚本执行结果为0，并且weight配置的值大于0，则优先级相应的增加。如果脚本执行结果非0，并且weight配置的值小于0，则优先级相应的减少。其他情况，维持原本配置的优先级，即配置文件中priority对应的值。
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	vrrp_script chk_apiserver {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		script &#34;/etc/keepalived/check_apiserver.sh&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        # 每2秒检查一次
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        interval 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        # 一旦脚本执行成功，权重减少5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        weight -5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        fall 3  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        rise 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# 定义虚拟路由，VI_1 为虚拟路由的标示符，自己定义名称
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	vrrp_instance VI_1 {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		# 主节点为 MASTER，对应的备份节点为 BACKUP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		state MASTER
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		# 绑定虚拟 IP 的网络接口，与本机 IP 地址所在的网卡名称相同
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		interface ens32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		# 主机的IP地址
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		mcast_src_ip 192.168.80.210
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		# 虚拟路由id
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		virtual_router_id 100
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		# 节点优先级，值范围 0-254，MASTER 要比 BACKUP 高
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		priority 100
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		# 优先级高的设置 nopreempt 解决异常恢复后再次抢占的问题
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		nopreempt 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		# 组播信息发送间隔，所有节点设置必须一样，默认 1s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		advert_int 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        # 设置验证信息，所有节点必须一致
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		authentication {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			auth_type PASS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			auth_pass K8SHA_KA_AUTH
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		# 虚拟 IP 池, 所有节点设置必须一样
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		virtual_ipaddress {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			# 虚拟 ip，可以定义多个	
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			192.168.80.220/24
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		track_script {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			chk_apiserver
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><code>Master-02</code>的<code>Keepalived</code><!-- raw HTML omitted -->配置文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/keepalived/keepalived.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">! Configuration File for keepalived
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	global_defs {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		router_id k8s-master-02
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		script_user root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		enable_script_security    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	vrrp_script chk_apiserver {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		script &#34;/etc/keepalived/check_apiserver.sh&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		interval 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		weight -5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		fall 3  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		rise 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	vrrp_instance VI_1 {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		state BACKUP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		interface ens32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		mcast_src_ip 192.168.80.211
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		virtual_router_id 101
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		priority 99
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		advert_int 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		authentication {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			auth_type PASS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			auth_pass K8SHA_KA_AUTH
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		virtual_ipaddress {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			192.168.80.220/24
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		track_script {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			chk_apiserver
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li>所有<code>Master</code><!-- raw HTML omitted -->节点设置监控脚本，并且给予执行权限<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/keepalived/check_apiserver.sh<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">err=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">for k in $(seq 1 5)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">do
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	check_code=$(pgrep kube-apiserver)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	if [[ $check_code == &#34;&#34; ]]; then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		err=$(expr $err + 1)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		sleep 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		continue
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	else
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		err=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		break
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">done
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if [[ $err != &#34;0&#34; ]]; then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	echo &#34;systemctl stop keepalived&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	/usr/bin/systemctl stop keepalived
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	exit 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">else
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	exit 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>$ chmod +x /etc/keepalived/check_apiserver.sh</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li>所有<code>Master</code><!-- raw HTML omitted -->节点启动<!-- raw HTML omitted --><code>HAProxy</code>和<code>Keepalived</code>并且测试<code>VIP(虚拟IP)</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl daemon-reload
</span></span><span style="display:flex;"><span>$ systemctl enable --now haproxy
</span></span><span style="display:flex;"><span>$ systemctl enable --now keepalived
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ping 192.168.80.220 -c <span style="color:#ae81ff">4</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="初始化kubernetes">初始化<code>Kubernetes</code></h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->命令行<!-- raw HTML omitted --><!-- raw HTML omitted -->方式初始化所有<!-- raw HTML omitted --><code>Master</code>节点</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>在<code>k8s-master01</code><!-- raw HTML omitted -->节点执行下面的命令：<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm init <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --apiserver-advertise-address<span style="color:#f92672">=</span>192.168.80.210 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --image-repository registry.aliyuncs.com/google_containers <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --control-plane-endpoint<span style="color:#f92672">=</span>192.168.80.225:16443 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --kubernetes-version v1.20.2 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --service-cidr<span style="color:#f92672">=</span>10.96.0.0/12 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --pod-network-cidr<span style="color:#f92672">=</span>10.244.0.0/16 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --cri-socket unix:///var/run/containerd/containerd.sock  	<span style="color:#75715e"># 配置 CRI 端点</span>
</span></span><span style="display:flex;"><span>  --upload-certs</span></span></code></pre></div><ul>
<li>将<code>k8s-master02</code><!-- raw HTML omitted -->节点加入到集群中，其他<code>master</code>节点加入同样命令<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm join 192.168.80.225:16443 --token povqsg.arg07e5ia1pywr71 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --discovery-token-ca-cert-hash sha256:9efd30b7f35747289b9de0c8d0768b9c2d5eb7d675cb86fa05b9a6d9526c3441 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --control-plane --certificate-key 363cc6296537b41607851c10f1f41ef23cf5cdc6965cb9c26e4b252315086855</span></span></code></pre></div><ul>
<li>防止在<code>Master-02</code><!-- raw HTML omitted -->节点中不能使用<!-- raw HTML omitted --><code>kubectl</code>命令</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -p $HOME/.kube
</span></span><span style="display:flex;"><span>$ sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style="display:flex;"><span>$ sudo chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config</span></span></code></pre></div><ul>
<li>如果<code>Token</code>过期，需要在<code>Master-01</code><!-- raw HTML omitted -->生成新的<!-- raw HTML omitted --><code>Token</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm token create --print-join-command</span></span></code></pre></div><ul>
<li>如果<code>Master</code><!-- raw HTML omitted -->要加入到集群中，需要在<!-- raw HTML omitted --><code>Master-01</code>生成<code>--certificate-key</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm init phase upload-certs --upload-certs</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><code> yaml</code><!-- raw HTML omitted -->方式初始化所有<!-- raw HTML omitted --><code>Master</code>节点</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>在<code>k8s-master01</code><!-- raw HTML omitted -->创建目录生成配置文件<!-- raw HTML omitted --><code>kubeadm-config.yaml</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -p /opt/k8s/yaml
</span></span><span style="display:flex;"><span>$ kubeadm config print init-defaults &gt;/opt/k8s/yaml/kubeadm-config.yaml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改配置文件</span>
</span></span><span style="display:flex;"><span>apiVersion: kubeadm.k8s.io/v1beta3
</span></span><span style="display:flex;"><span>bootstrapTokens:
</span></span><span style="display:flex;"><span>- groups:
</span></span><span style="display:flex;"><span>    - system:bootstrappers:kubeadm:default-node-token
</span></span><span style="display:flex;"><span>    token: abcdef.0123456789abcdef
</span></span><span style="display:flex;"><span>    ttl: 24h0m0s
</span></span><span style="display:flex;"><span>    usages:
</span></span><span style="display:flex;"><span>    - signing
</span></span><span style="display:flex;"><span>    - authentication
</span></span><span style="display:flex;"><span>kind: InitConfiguration
</span></span><span style="display:flex;"><span>localAPIEndpoint:
</span></span><span style="display:flex;"><span>    advertiseAddress: 1.2.3.4  	<span style="color:#75715e"># 修改为master本机IP</span>
</span></span><span style="display:flex;"><span>    bindPort: <span style="color:#ae81ff">6443</span>  	<span style="color:#75715e"># 使用端口</span>
</span></span><span style="display:flex;"><span>nodeRegistration:
</span></span><span style="display:flex;"><span>    criSocket: unix:///var/run/containerd/containerd.sock  	<span style="color:#75715e"># 配置 CRI 端点</span>
</span></span><span style="display:flex;"><span>    imagePullPolicy: IfNotPresent
</span></span><span style="display:flex;"><span>    name: node  	<span style="color:#75715e"># 配置主机名， 主机名不允许使用下划线</span>
</span></span><span style="display:flex;"><span>    taints: null
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiServer:
</span></span><span style="display:flex;"><span>    timeoutForControlPlane: 4m0s
</span></span><span style="display:flex;"><span>apiVersion: kubeadm.k8s.io/v1beta3
</span></span><span style="display:flex;"><span>certificatesDir: /etc/kubernetes/pki
</span></span><span style="display:flex;"><span>clusterName: kubernetes
</span></span><span style="display:flex;"><span>controllerManager: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>dns: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>etcd:
</span></span><span style="display:flex;"><span>    local:
</span></span><span style="display:flex;"><span>        dataDir: /var/lib/etcd
</span></span><span style="display:flex;"><span>imageRepository: k8s.gcr.io  	<span style="color:#75715e"># 定义使用镜像源</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># imageRepository: registry.aliyuncs.com/google_containers  	# 阿里云镜像源</span>
</span></span><span style="display:flex;"><span>kind: ClusterConfiguration
</span></span><span style="display:flex;"><span>kubernetesVersion: 1.24.0  	<span style="color:#75715e"># 定义kubernetes版本</span>
</span></span><span style="display:flex;"><span>networking:
</span></span><span style="display:flex;"><span>    dnsDomain: cluster.local
</span></span><span style="display:flex;"><span>    serviceSubnet: 10.96.0.0/12
</span></span><span style="display:flex;"><span>scheduler: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiVersion: kubeproxy.config.k8s.io/v1alpha1
</span></span><span style="display:flex;"><span>kind: KubeProxyConfiguration
</span></span><span style="display:flex;"><span>featureGates:
</span></span><span style="display:flex;"><span>    SupportIPVSProxyMode: true
</span></span><span style="display:flex;"><span>mode: ipvs  	<span style="color:#75715e"># 启用ipvs</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->可以使用如下的命令更新<!-- raw HTML omitted --><code>kubeadm-config.yaml</code>文件，需要将<code>k8s</code>设置到对应的版本</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm config migrate --old-config /opt/k8s/yaml/kubeadm-config.yaml --new-config <span style="color:#e6db74">&#34;new.yaml&#34;</span></span></span></code></pre></div><ul>
<li>将<code>new.yaml</code><!-- raw HTML omitted -->文件复制到所有的<!-- raw HTML omitted --><code>master</code>节点</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ scp new.yaml k8s-master-02:/opt/k8s/yaml/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看以及下载所有master节点提前下载镜像</span>
</span></span><span style="display:flex;"><span>$ kubeadm config images pull --config /opt/k8s/yaml/new.yaml  	<span style="color:#75715e"># pull替换list可查看所需镜像</span></span></span></code></pre></div><ul>
<li><code>k8s-master01</code>节点初始化后，会在<code>/etc/kubernetes</code><!-- raw HTML omitted -->目录下生成对应的证书和配置文件，之后其他的<!-- raw HTML omitted --><code>Master</code>节点加入到<code>k8s-master01</code>节点即可</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm init --config /opt/k8s/yaml/new.yaml --upload-certs</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->如果初始化失败，重置后再次初始化，命令如下：<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm reset -f;ipvsadm --clear;rm -rf ~/.kube</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->初始化成功后，会产生<!-- raw HTML omitted --><code>token</code>值，用于其他节点加入时使用，</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>Your Kubernetes control-plane has initialized successfully!
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>To start using your cluster, you need to run the following as a regular user:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  mkdir -p $HOME/.kube
</span></span><span style="display:flex;"><span>  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style="display:flex;"><span>  sudo chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Alternatively, <span style="color:#66d9ef">if</span> you are the root user, you can run:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  export KUBECONFIG<span style="color:#f92672">=</span>/etc/kubernetes/admin.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>You should now deploy a pod network to the cluster.
</span></span><span style="display:flex;"><span>Run <span style="color:#e6db74">&#34;kubectl apply -f [podnetwork].yaml&#34;</span> with one of the options listed at:
</span></span><span style="display:flex;"><span>  https://kubernetes.io/docs/concepts/cluster-administration/addons/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>You can now join any number of the control-plane node running the following command on each as root:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 其他 Master 节点执行</span>
</span></span><span style="display:flex;"><span>  kubeadm join 192.168.80.210:16443 --token abcdef.0123456789abcdef <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --discovery-token-ca-cert-hash sha256:505e373bae6123fc3e27e778c5fedbccbf0f91a51efdcc11b32c4573605b8e71 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --control-plane --certificate-key 70aef5f76111a5824085c644b3f34cf830efad00c1b16b878701166bf069664e
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Please note that the certificate-key gives access to cluster sensitive data, keep it secret!
</span></span><span style="display:flex;"><span>As a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;kubeadm init phase upload-certs --upload-certs&#34;</span> to reload certs afterward.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Then you can join any number of worker nodes by running the following on each as root:
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 所有 Node 节点执行</span>
</span></span><span style="display:flex;"><span>kubeadm join 192.168.80.210:16443 --token abcdef.0123456789abcdef <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --discovery-token-ca-cert-hash sha256:505e373bae6123fc3e27e778c5fedbccbf0f91a51efdcc11b32c4573605b8e71</span></span></code></pre></div><ul>
<li><code>k8s-master01</code><!-- raw HTML omitted -->节点配置环境变量，用于访问<!-- raw HTML omitted --><code>kubernetes</code>集群</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># root用户</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/root/.bashrc<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export KUBECONFIG=/etc/kubernetes/admin.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ source ~/.bash_profile
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 普通用户</span>
</span></span><span style="display:flex;"><span>$ mkdir -p $HOME/.kube
</span></span><span style="display:flex;"><span>$ sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style="display:flex;"><span>$ sudo chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># k8s-master-01中查看节点的状态：</span>
</span></span><span style="display:flex;"><span>$ kubectl get nodes</span></span></code></pre></div></blockquote>
<hr>
<h3 id="node节点加入集群-1"><code>Node</code>节点加入集群</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->所有<!-- raw HTML omitted --><code>Node</code><!-- raw HTML omitted -->节点执行<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm join 192.168.80.225:16443 --token povqsg.arg07e5ia1pywr71 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> --discovery-token-ca-cert-hash sha256:9efd30b7f35747289b9de0c8d0768b9c2d5eb7d675cb86fa05b9a6d9526c3441</span></span></code></pre></div></blockquote>
<hr>
<h2 id="font-colorred二进制安装fontkubernetes"><!-- raw HTML omitted -->二进制安装<!-- raw HTML omitted --><code>kubernetes</code></h2>
<h3 id="部署etcd存储集群三台主机作为节点">部署<code>Etcd</code>存储集群、三台主机作为节点</h3>
<ul>
<li>
<ol>
<li>键值对数据库，存储<code>K8S</code>集群所有重要信息(持久化)  <a href="https://blog.csdn.net/qq_27276045/article/details/115650151" rel="external" target="_self"><code>Kubernetes</code>存储大脑之<code>etcd</code></a>、<a href="https://www.infoq.cn/article/rhzug069xvr5z5bhhtiv" rel="external" target="_self">突破<code>etcd</code>限制！字节开源自研<code>K8s</code>存储<code>KubeBrain</code></a></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>Etcd 是一个分布式键值存储系统，Kubernetes使用Etcd进行数据存储，所以先准备一个Etcd数据库，为解决Etcd单点故障，应采用集群方式部署，这里使用3台组建集群，可容忍1台机器故障，当然，你也可以使用5台组建集群，可容忍2台机器故障</span></span></code></pre></div><ul>
<li>1.1 注意这里<code>profiles</code>字段下名称，其中<code>CjServer</code>下注明<code>server auth</code>用于服务器端认证，后续在生成服务器证书时候，需要使用这个名称作为<code>cfssl</code>命令的配置文件名称作为参数传入。</li>
<li>1.2 注意这里<code>profiles</code>字段下名称，其中<code>CjServer</code>下注明<code>server auth</code>用于服务器端认证，后续在生成服务器证书时候，需要使用这个名称作为<code>cfssl</code>命令的配置文件名称作为参数传入。</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">{</span><span style="color:#e6db74">&#34;code&#34;</span>:5100,<span style="color:#e6db74">&#34;message&#34;</span>:<span style="color:#e6db74">&#34;Invalid policy: no key usage available&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>Failed to parse input: unexpected end of JSON input</span></span></code></pre></div><ul>
<li>1.3 往往是提供的<code>-profile</code>参数中的配置文件名在<code>ca-config.json</code>中无法匹配</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 1.准备cfssl证书生成工具、cfssl是一个开源的证书管理工具，使用json文件生成证书，找任意一台服务器操作，
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cd /usr/local/src/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64  	# 是v1.2.0 最好升级到v1.3.4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ chmod +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 添加环境变量第一种方式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ vim /etc/profile
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export PATH=$PATH:/opt/kubernetes/bin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ source /etc/profile
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 把可执行文件挪移并改名
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ mv cfssl_linux-amd64 /usr/local/bin/cfssl
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ mv cfssljson_linux-amd64 /usr/local/bin/cfssljson
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ mv cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 2.生成Etcd证书、自签证书颁发机构（CA）创建工作目录：
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cat &gt;/opt/kubernetes/ssl/ca-config.json&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;signing&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;default&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;expiry&#34;: &#34;87600h&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;profiles&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;kubernetes&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         &#34;expiry&#34;: &#34;87600h&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         &#34;usages&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;signing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;key encipherment&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;server auth&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;client auth&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">###################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cat &gt;/opt/kubernetes/ssl/ca-csr.json&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;CN&#34;: &#34;etcd CA&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;key&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;size&#34;: 2048
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;names&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;L&#34;: &#34;Beijing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;ST&#34;: &#34;Beijing&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 3.生成证书
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cd /opt/kubernetes/ssl/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cfssl gencert -initca ca-csr.json | cfssljson -bare ca -
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 4. 使用自签CA签发Etcd HTTPS证书:创建证书申请文件  #####
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cat &gt;/opt/kubernetes/ssl/etcd-csr.json&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;CN&#34;: &#34;etcd&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;hosts&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;192.168.4.110&#34;, # 修改IP、为了扩容方便可以多写几个IP、去掉注释
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;192.168.4.111&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;192.168.4.112&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;xxx.xxx.xxx.xxx&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;xxx.xxx.xxx.xxx&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;xxx.xxx.xxx.xxx&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;key&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;size&#34;: 2048
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;names&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;L&#34;: &#34;BeiJing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;ST&#34;: &#34;BeiJing&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 5. 生成证书
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cd /opt/kubernetes/ssl/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes etcd-csr.json | cfssljson -bare etcd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 6.在GitHub上下载二进制文件
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cd /usr/local/src/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ wget https://github.com/etcd-io/etcd/releases/download/v3.4.14/etcd-v3.4.14-linux-amd64.tar.gz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ tar zxvf etcd-v3.4.14-linux-amd64.tar.gz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ mv etcd-v3.4.14-linux-amd64/{etcd,etcdctl} /opt/etcd/bin/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 6.创建etcd配置文件：针对IP修改为本机IP，拷贝过去后把所有结尾的“注释取消掉”
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cat &gt;/opt/etcd/cfg/etcd.conf&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># [Member]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ETCD_NAME=&#34;etcd-node1&#34;  	# 修改此处，节点2改为etcd-2，节点3改为etcd-3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ETCD_DATA_DIR=&#34;/var/lib/etcd/default.etcd&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ETCD_LISTEN_PEER_URLS=&#34;https://192.168.4.110:2380&#34;  	# 修改此处为当前服务器IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ETCD_LISTEN_CLIENT_URLS=&#34;https://192.168.4.110:2379,https://127.0.0.1:2379&#34;  	# 修改此处为当前服务器IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># [Clustering]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ETCD_INITIAL_ADVERTISE_PEER_URLS=&#34;https://192.168.4.110:2380&#34;  	# 修改此处为当前服务器IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ETCD_ADVERTISE_CLIENT_URLS=&#34;https://192.168.4.110:2379&#34;  # 修改此处为当前服务器IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 修改为所有节点IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ETCD_INITIAL_CLUSTER=&#34;etcd-node1=https://192.168.4.110:2380,etcd-node2=https://192.168.4.111:2380,etcd-node3=https://192.168.4.112:2380&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ETCD_INITIAL_CLUSTER_TOKEN=&#34;etcd-cluster&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ETCD_INITIAL_CLUSTER_STATE=&#34;new&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># [security]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># CLIENT_CERT_AUTH=&#34;true&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_CA_FILE=&#34;/opt/etcd/ssl/ca.pem&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_CERT_FILE=&#34;/opt/etcd/ssl/server.pem&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_KEY_FILE=&#34;/opt/etcd/ssl/server-key.pem&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># PEER_CLIENT_CERT_AUTH=&#34;true&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_PEER_CA_FILE=&#34;/opt/etcd/ssl/ca.pem&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_PEER_CERT_FILE=&#34;/opt/etcd/ssl/server.pem&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_PEER_KEY_FILE=&#34;/opt/etcd/ssl/server-key.pem&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#####################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_NAME：节点名称，集群中唯一
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_DATA_DIR：数据目录
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_LISTEN_PEER_URLS：集群通信监听地址
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_LISTEN_CLIENT_URLS：客户端访问监听地址
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_INITIAL_ADVERTISE_PEER_URLS：集群通告地址
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_ADVERTISE_CLIENT_URLS：客户端通告地址
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_INITIAL_CLUSTER：集群节点地址
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_INITIAL_CLUSTER_TOKEN：集群Token
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ETCD_INITIAL_CLUSTER_STATE：加入集群的当前状态，new是新集群，existing表示加入已有集群
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 7.systemctl管理etcd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cat &gt;/usr/lib/systemd/system/etcd.service&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=Etcd Server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Wants=network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Type=notify
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EnvironmentFile=/opt/etcd/cfg/etcd.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/etcd/bin/etcd \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cert-file=/opt/etcd/ssl/etcd.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--key-file=/opt/etcd/ssl/etcd-key.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--peer-cert-file=/opt/etcd/ssl/etcd.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--peer-key-file=/opt/etcd/ssl/etcd-key.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--trusted-ca-file=/opt/etcd/ssl/ca.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--peer-trusted-ca-file=/opt/etcd/ssl/ca.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--logger=zap
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LimitNOFILE=65536
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">###################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 8.拷贝刚刚生成证书到etcd目录下
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cd /opt/kubernetes/ssl/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cp ca*.pem etcd*.pem /opt/etcd/ssl/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 9.节点1生成的所有文件拷贝到其他所有节点、然后在其他节点分别修改etcd.conf配置文件中的节点名称和当前服务器IP：
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ ansible node -i /etc/ansible/hosts -m copy -a &#34;src=../../opt/etcd dest=/opt&#34; -f 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ ansible node -i /etc/ansible/hosts -m copy -a &#34;src=../../usr/lib/systemd/system/etcd.service dest=/usr/lib/systemd/system&#34; -f 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ mkdir -p /var/lib/etcd  	# 三个节点都执行
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ chmod +x /opt/etcd/bin/*  	# 其他两个节点执行语句给予执行权限
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 10.所有节点设置开机自启
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ systemctl daemon-reload
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ systemctl enable etcd &amp;&amp; systemctl start etcd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 测试etcd数据库可用性
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ etcdctl set testdir/testkey0 0  	# 设置一个键值对 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ etcdctl get testdir/testkey0  	# 查看是否获取到数据
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ etcdctl -C http://localhost:2379 cluster-health
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 11.查看集群状态
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ ETCDCTL_API=3 /opt/etcd/bin/etcdctl --cacert=/opt/etcd/ssl/ca.pem --cert=/opt/etcd/ssl/etcd.pem --key=/opt/etcd/ssl/etcd-key.pem --endpoints=&#34;https://192.168.4.110:2379,https://192.168.4.111:2379,https://192.168.4.112:2379&#34; endpoint health &#39;</span> &gt;&gt;install_etcd.sh</span></span></code></pre></div></blockquote>
<hr>
<h3 id="署master-node生成kube-apiserver证书自签证书颁发机构ca">署<code>Master Node</code>，生成<code>kube-apiserver</code>证书：自签证书颁发机构<code>CA</code></h3>
<ul>
<li>
<ol>
<li><code>api-server：</code>所有服务访问统一入口</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 1.创建证书申请文件：
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># hosts字段中IP为所有Master/LB/VIP IP,一个都不能少！为了方便后期扩容可以多写几个预留的IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cat &gt; /opt/kubernetes/ssl/kube-apiserver-csr.json &lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;CN&#34;: &#34;kubernetes&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;hosts&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;10.0.0.1&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;127.0.0.1&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;192.168.4.110&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;192.168.4.111&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;192.168.4.112&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;xxx.xxx.xxx.xxx&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;xxx.xxx.xxx.xxx&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;kubernetes&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;kubernetes.default&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;kubernetes.default.svc&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;kubernetes.default.svc.cluster&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;kubernetes.default.svc.cluster.local&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;key&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;size&#34;: 2048
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">},
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;names&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;L&#34;: &#34;BeiJing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;ST&#34;: &#34;BeiJing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;O&#34;: &#34;k8s&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;OU&#34;: &#34;System&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">######################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 2.生成证书:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cd /opt/kubernetes/ssl
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-apiserver-csr.json | cfssljson -bare api-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 打开链接下载二进制包
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.20.md#v1202
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cd /usr/local/src
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ wget https://dl.k8s.io/v1.18.6/kubernetes-server-linux-amd64.tar.gz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ tar zxvf kubernetes-server-linux-amd64.tar.gz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cd kubernetes/server/bin/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cp kube-apiserver kube-scheduler kube-controller-manager /opt/kubernetes/bin/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cp kubectl /usr/bin/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 3.部署kube-apiserver
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 两个&#34;\\&#34;第一个是转义符，第二个是换行符，使用转义符是为了使用EOF保留换行符
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cat &gt;/opt/kubernetes/cfg/kube-apiserver.conf&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">KUBE_APISERVER_OPTS=&#34;--logtostderr=false \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--v=2 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--log-dir=/opt/kubernetes/logs \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--etcd-servers=https://192.168.4.110:2379,https://192.168.4.111:2379,https://192.168.4.112:2379 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--bind-address=192.168.4.110 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--secure-port=6443 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--advertise-address=192.168.4.110 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--allow-privileged=true \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--service-cluster-ip-range=10.0.0.0/24 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--authorization-mode=RBAC,Node \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--enable-bootstrap-token-auth=true \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--token-auth-file=/opt/kubernetes/cfg/token.csv \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--service-node-port-range=30000-32767 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--kubelet-client-certificate=/opt/kubernetes/ssl/api-server.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--kubelet-client-key=/opt/kubernetes/ssl/api-server-key.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--tls-cert-file=/opt/kubernetes/ssl/api-server.pem  \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--tls-private-key-file=/opt/kubernetes/ssl/api-server-key.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--client-ca-file=/opt/kubernetes/ssl/ca.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--service-account-key-file=/opt/kubernetes/ssl/ca-key.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--etcd-cafile=/opt/etcd/ssl/ca.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--etcd-certfile=/opt/etcd/ssl/server.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--etcd-keyfile=/opt/etcd/ssl/server-key.pem \\  	# 证书需要修改
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--audit-log-maxbackup=3 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--audit-log-maxsize=100 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--audit-log-path=/opt/kubernetes/logs/k8s-audit.log&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#######################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–logtostderr：启用日志
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">—v：日志等级
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–log-dir：日志目录
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–etcd-servers：etcd集群地址
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–bind-address：监听地址
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–secure-port：https安全端口
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–advertise-address：集群通告地址
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–allow-privileged：启用授权
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–service-cluster-ip-range：Service虚拟IP地址段
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–enable-admission-plugins：准入控制模块
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–authorization-mode：认证授权，启用RBAC授权和节点自管理
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–enable-bootstrap-token-auth：启用TLS bootstrap机制
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–token-auth-file：bootstrap token文件
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–service-node-port-range：Service nodeport类型默认分配端口范围
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–kubelet-client-xxx：apiserver访问kubelet客户端证书
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–tls-xxx-file：apiserver https证书
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–etcd-xxxfile：连接Etcd集群证书
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">–audit-log-xxx：审计日志 &#39;</span>&gt;&gt; kube-apiserver.sh</span></span></code></pre></div></blockquote>
<hr>
<h3 id="启用tls-bootstrapping机制">启用<code>TLS Bootstrapping</code>机制</h3>
<ul>
<li>
<ol>
<li><code>TLS Bootstraping：Master apiserver</code>启用<code>TLS</code>认证后，<code>Node</code>节点<code>kubelet</code>和<code>kube-proxy</code>要与<code>kube-apiserver</code>进行通信，必须使用<code>CA</code>签发的有效证书才可以，当<code>Node</code>节点很多时，这种客户端证书颁发需要大量工作，同样也会增加集群扩展复杂度。为了简化流程，<code>Kubernetes</code>引入了<code>TLS bootstraping</code>机制来自动颁发客户端证书，<code>kubelet</code>会以一个低权限用户自动向<code>apiserver</code>申请证书，<code>kubelet</code>的证书由<code>apiserver</code>动态签署。所以强烈建议在<code>Node</code>上使用这种方式，目前主要用于<code>kubelet</code>，<code>kube-proxy</code>还是由我们统一颁发一个证书</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">cat &gt;/opt/kubernetes/cfg/token.csv&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$(head -c 16 /dev/urandom | od -An -t x | tr -d &#39;</span> <span style="color:#e6db74">&#39;),kubelet-bootstrap,10001,&#34;system:node-bootstrapper&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">###########################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 自行生成token
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># token=$(head -c 16 /dev/urandom | od -An -t x | tr -d &#39;</span> <span style="color:#e6db74">&#39;)  	# C语言执行生成方式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># token=`head -c 16 /dev/urandom | od -An -t x | tr -d &#39;</span> <span style="color:#e6db74">&#39;`  	# shell执行生成方式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># sed -i &#34;s/c47ffb939f5ca36231d9e3121a252940/${token}/g&#34;  /opt/kubernetes/cfg/token.csv
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># systemct管理apiserver、并设置开机自启
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">cat &gt;/usr/lib/systemd/system/kube-apiserver.service&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=Kubernetes API Server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Documentation=https://github.com/kubernetes/kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EnvironmentFile=/opt/kubernetes/cfg/kube-apiserver.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/kubernetes/bin/kube-apiserver \$KUBE_APISERVER_OPTS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#######################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ systemctl daemon-reload
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ systemctl enable kube-apiserver &amp;&amp; systemctl start kube-apiserver
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># kube-apiserver报错排查
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ cat /var/log/messages|grep kube-apiserver|grep -i error  	# -i不区分大小写
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">journalctl -xe -u kube-apiserver | more  	# 命令排错 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 3.设置授权kubelet-bootstrap用户允许请求证书
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$ kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --user=kubelet-bootstrap &#39;</span> &gt;&gt;token-apiserver.sh</span></span></code></pre></div></blockquote>
<hr>
<h3 id="部署kube-controller-manager控制器">部署<code>kube-controller-manager</code>(控制器)</h3>
<ul>
<li>
<ol>
<li><code>Pod</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>1.1 <!-- raw HTML omitted -->最小部署单元<!-- raw HTML omitted --></li>
<li>1.2 <!-- raw HTML omitted -->一组容器的集合<!-- raw HTML omitted --></li>
<li>1.3 <!-- raw HTML omitted -->一个<code>Pod</code>中的容器共享网络命名空间<!-- raw HTML omitted --></li>
<li>1.4 <!-- raw HTML omitted --><code>Pod</code>是短暂的<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li>
<ol start="2">
<li><code>Controllers</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>2.1 <!-- raw HTML omitted --><code>Deployment：</code>无状态应用部署<!-- raw HTML omitted --></li>
<li>2.2 <!-- raw HTML omitted --><code>StatefulSet：</code>有状态应用部署<!-- raw HTML omitted --></li>
<li>2.3 <!-- raw HTML omitted --><code>DaemonSet：</code>确保所有的<code>Node</code>运行一个<code>Pod</code><!-- raw HTML omitted --></li>
<li>2.4 <!-- raw HTML omitted --><code>Job：</code>一次性任务<!-- raw HTML omitted --></li>
<li>2.5 <!-- raw HTML omitted --><code>Cronjob：</code>定时任务<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->更高级层级对象，部署和管理<code>Pod</code><!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="4">
<li><code>Service</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>4.1 <!-- raw HTML omitted -->防止<code>Pod</code>失联<!-- raw HTML omitted --></li>
<li>4.2 <!-- raw HTML omitted -->定义一组<code>Pod</code>的访问策略<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted --><code>Label：</code>标签，附加到某个资源上，用于关联对象，查询和筛选<!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="6">
<li><!-- raw HTML omitted --><code>Namespaces：</code>命名空间，将对象逻辑上隔离<!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="7">
<li><!-- raw HTML omitted --><code>Controller：</code>维持副本期望数目,<code>ReplicaSet</code>替代<code>ReplicationControlled</code><!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="8">
<li><!-- raw HTML omitted --><code>deployent：</code>管理<code>RS</code>，实现滚动更新<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>8.1 <!-- raw HTML omitted --><code>--kubeconfig：</code>连接<code>apiserver</code>配置文件<!-- raw HTML omitted --></li>
<li>8.2 <!-- raw HTML omitted --><code>--master：</code>通过本地非安全本地端口<code>8080</code>连接<code>apiserver</code><!-- raw HTML omitted --></li>
<li>8.3 <!-- raw HTML omitted --><code>--leader-elect：</code>当该组件启动多个时，自动选举<code>HA</code><!-- raw HTML omitted --></li>
<li>8.4 <!-- raw HTML omitted --><code>--cluster-signing-cert-file/--cluster-signing-key-file：</code>自动为<code>kubelet</code>颁发证书的<code>CA</code>，与<code>apiserver</code>保持一致<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 创建配置文件</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/kube-controller-manager.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">KUBE_CONTROLLER_MANAGER_OPTS=&#34;--logtostderr=false \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--v=2 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--log-dir=/opt/kubernetes/logs \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--leader-elect=true \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--kubeconfig=/opt/kubernetes/cfg/kube-controller-manager.kubeconfig \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--master=127.0.0.1:8080 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--bind-address=127.0.0.1 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--allocate-node-cidrs=true \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cluster-cidr=10.244.0.0/16 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--service-cluster-ip-range=10.0.0.0/24 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cluster-signing-cert-file=/opt/kubernetes/ssl/ca.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cluster-signing-key-file=/opt/kubernetes/ssl/ca-key.pem  \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--root-ca-file=/opt/kubernetes/ssl/ca.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--service-account-private-key-file=/opt/kubernetes/ssl/ca-key.pem \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--experimental-cluster-signing-duration=87600h0m0s&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建kube-controller-manager-csr.json 证书请求文件，可以越过</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cat &gt;/opt/kubernetes/ssl/kube-controller-manager-csr.json&lt;&lt;-EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># {</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &#34;CN&#34;: &#34;system:kube-controller-manager&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &#34;hosts&#34;: [],</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &#34;key&#34;: {</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    &#34;algo&#34;: &#34;rsa&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    &#34;size&#34;: 2048</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  },</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &#34;names&#34;: [</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    {</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;C&#34;: &#34;CN&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;L&#34;: &#34;BeiJing&#34;, </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;ST&#34;: &#34;BeiJing&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;O&#34;: &#34;system:masters&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;OU&#34;: &#34;System&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    }</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  ]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># }</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成证书</span>
</span></span><span style="display:flex;"><span>$ cd /opt/kubernetes/ssl
</span></span><span style="display:flex;"><span>$ cfssl gencert -ca<span style="color:#f92672">=</span>ca.pem -ca-key<span style="color:#f92672">=</span>ca-key.pem -config<span style="color:#f92672">=</span>ca-config.json -profile<span style="color:#f92672">=</span>kubernetes kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="9">
<li><!-- raw HTML omitted -->生成<code>kubeconfig</code>文件（以下是<code>shell</code>命令，直接在终端执行）：可以越过<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># KUBE_CONFIG=&#34;/opt/kubernetes/cfg/kube-controller-manager.kubeconfig&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># KUBE_APISERVER=&#34;https://192.168.4.110:6443&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>$ kubectl config set-cluster kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#75715e">#  --certificate-authority=/opt/kubernetes/ssl/ca.pem \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --embed-certs=true \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --server=${KUBE_APISERVER} \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --kubeconfig=${KUBE_CONFIG}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config set-credentials kube-controller-manager <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#75715e">#  --client-certificate=./kube-controller-manager.pem \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --client-key=./kube-controller-manager-key.pem \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --embed-certs=true \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --kubeconfig=${KUBE_CONFIG}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config set-context default <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#75715e">#  --cluster=kubernetes \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --user=kube-controller-manager \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --kubeconfig=${KUBE_CONFIG}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config use-context default --kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="systemd管理controller-manager"><code>systemd</code>管理<code>controller-manager</code></h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted --><code>Controller manager</code>（默认端口：<code>10252</code>）监视<code>Kubernetes</code>集群，以检测和维护<code>Kubernetes</code>环境的几个方面，包括将<code>Pod</code>加入到服务中，保持一组<code>Pod</code>的正确数量，并对节点的丢失做出反应<!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="2">
<li><!-- raw HTML omitted --><code>Cloud controller manager</code>（默认端口：10258）一个用于基于云的部署的可选组件。云控制器与云服务提供商接口，以管理集群的负载均衡器和虚拟网络<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/usr/lib/systemd/system/kube-controller-manager.service<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=Kubernetes Controller Manager
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Documentation=https://github.com/kubernetes/kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EnvironmentFile=/opt/kubernetes/cfg/kube-controller-manager.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/kubernetes/bin/kube-controller-manager \$KUBE_CONTROLLER_MANAGER_OPTS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecReload=/bin/kill -HUP $MAINPID
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="启动并设置开机启动">启动并设置开机启动</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl daemon-reload
</span></span><span style="display:flex;"><span>$ systemctl enable kube-controller-manager <span style="color:#f92672">&amp;&amp;</span> systemctl start kube-controller-manager</span></span></code></pre></div></blockquote>
<hr>
<h3 id="部署kube-scheduler创建配置文件调度器负责集群资源调度组件抽离">部署<code>kube-scheduler</code>:创建配置文件(调度器负责集群资源调度,组件抽离)</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted --><code>Scheduler：</code>负责介绍任务，选择合适的节点进行分配任务<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>1.1 <!-- raw HTML omitted --><code>--kubeconfig</code>：连接<code>apiserver</code>配置文件<!-- raw HTML omitted --></li>
<li>1.2 <!-- raw HTML omitted --><code>--master</code>：通过本地非安全本地端口8080连接<code>apiserver</code><!-- raw HTML omitted --></li>
<li>1.3 <!-- raw HTML omitted --><code>--leader-elect</code>：当该组件启动多个时，自动选举(HA) <!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/kube-scheduler.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">KUBE_SCHEDULER_OPTS=&#34;--logtostderr=false \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--v=2 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--log-dir=/opt/kubernetes/logs \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--leader-elect \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#--kubeconfig=/opt/kubernetes/cfg/kube-scheduler.kubeconfig \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--master=127.0.0.1:8080 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--bind-address=127.0.0.1&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->创建<code>kube-scheduler-csr.json</code>证书请求文件：可以越过此步骤<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># cat &gt;/opt/kubernetes/ssl/kube-scheduler-csr.json&lt;&lt;-EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># {</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &#34;CN&#34;: &#34;system:kube-scheduler&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &#34;hosts&#34;: [],</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &#34;key&#34;: {</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    &#34;algo&#34;: &#34;rsa&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    &#34;size&#34;: 2048</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  },</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &#34;names&#34;: [</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    {</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;C&#34;: &#34;CN&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;L&#34;: &#34;BeiJing&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;ST&#34;: &#34;BeiJing&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;O&#34;: &#34;system:masters&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &#34;OU&#34;: &#34;System&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    }</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  ]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># }</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成证书</span>
</span></span><span style="display:flex;"><span>$ cd /opt/kubernetes/ssl
</span></span><span style="display:flex;"><span>$ cfssl gencert -ca<span style="color:#f92672">=</span>ca.pem -ca-key<span style="color:#f92672">=</span>ca-key.pem -config<span style="color:#f92672">=</span>ca-config.json -profile<span style="color:#f92672">=</span>kubernetes kube-scheduler-csr.json | cfssljson -bare kube-scheduler</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->生成<code>kubeconfig</code>文件(以下是<code>shell</code>命令，直接在终端执行)：此步骤可以越过<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># KUBE_CONFIG=&#34;/opt/kubernetes/cfg/kube-scheduler.kubeconfig&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># KUBE_APISERVER=&#34;https://192.168.100.11:6443&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config set-cluster kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#75715e">#  --certificate-authority=/opt/kubernetes/ssl/ca.pem \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --embed-certs=true \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --server=${KUBE_APISERVER} \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --kubeconfig=${KUBE_CONFIG}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config set-credentials kube-scheduler <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#75715e">#  --client-certificate=./kube-scheduler.pem \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --client-key=./kube-scheduler-key.pem \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --embed-certs=true \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --kubeconfig=${KUBE_CONFIG}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config set-context default <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#75715e">#  --cluster=kubernetes \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --user=kube-scheduler \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --kubeconfig=${KUBE_CONFIG}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config use-context default --kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="systemd管理scheduler"><code>systemd</code>管理<code>scheduler</code></h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/usr/lib/systemd/system/kube-scheduler.service<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=Kubernetes Scheduler
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Documentation=https://github.com/kubernetes/kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EnvironmentFile=/opt/kubernetes/cfg/kube-scheduler.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/kubernetes/bin/kube-scheduler \$KUBE_SCHEDULER_OPTS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->设置开机自己并且启动服务器<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl daemon-reload
</span></span><span style="display:flex;"><span>$ systemctl enable kube-scheduler <span style="color:#f92672">&amp;&amp;</span> systemctl start kube-scheduler</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->生成<code>kubectl</code>连接集群的证书：<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/ssl/admin-csr.json<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;CN&#34;: &#34;admin&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;hosts&#34;: [],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;key&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;size&#34;: 2048
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">},
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;names&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;L&#34;: &#34;BeiJing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;ST&#34;: &#34;BeiJing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;O&#34;: &#34;system:masters&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;OU&#34;: &#34;System&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->生成证书<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /opt/kubernetes/ssl/
</span></span><span style="display:flex;"><span>$ cfssl gencert -ca<span style="color:#f92672">=</span>ca.pem -ca-key<span style="color:#f92672">=</span>ca-key.pem -config<span style="color:#f92672">=</span>ca-config.json -profile<span style="color:#f92672">=</span>kubernetes admin-csr.json | cfssljson -bare admin</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->生成<code>kubeconfig</code>文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir /root/.kube
</span></span><span style="display:flex;"><span>$ KUBE_CONFIG<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/root/.kube/config&#34;</span>
</span></span><span style="display:flex;"><span>$ KUBE_APISERVER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://192.168.4.110:6443&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config set-cluster kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--certificate-authority<span style="color:#f92672">=</span>/opt/kubernetes/ssl/ca.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--server<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_APISERVER<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>$ kubectl config set-credentials cluster-admin <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--client-certificate<span style="color:#f92672">=</span>./admin.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--client-key<span style="color:#f92672">=</span>./admin-key.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>$ kubectl config set-context default <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cluster<span style="color:#f92672">=</span>kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--user<span style="color:#f92672">=</span>cluster-admin <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>$ kubectl config use-context default --kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->通过<code>kubectl</code>工具查看当前集群组件状态<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl get cs
</span></span><span style="display:flex;"><span>NAME                 STATUS    MESSAGE             ERROR
</span></span><span style="display:flex;"><span>controller-manager   Healthy   ok                  
</span></span><span style="display:flex;"><span>scheduler            Healthy   ok                  
</span></span><span style="display:flex;"><span>etcd-0               Healthy   <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;health&#34;</span>:<span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">}</span>   
</span></span><span style="display:flex;"><span>etcd-1               Healthy   <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;health&#34;</span>:<span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">}</span>   
</span></span><span style="display:flex;"><span>etcd-2               Healthy   <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;health&#34;</span>:<span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">}</span> </span></span></code></pre></div></blockquote>
<hr>
<h3 id="在master操作部署worker-node">在<code>Master</code>操作部署<code>Worker Node</code></h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted --><code>Kubelet：</code>直接跟容器引擎交互实现容器的生命周期管理<!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="2">
<li><!-- raw HTML omitted --><code>Kube proxy：</code>负责写入规则至<code>iptables</code>、<code>ipvs</code>实现服务映射访问<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>2.1 <!-- raw HTML omitted --><code>--hostname-override</code>：显示名称，集群中唯一<!-- raw HTML omitted --></li>
<li>2.2 <!-- raw HTML omitted --><code>--network-plugin</code>：启用<code>CNI</code><!-- raw HTML omitted --></li>
<li>2.3 <!-- raw HTML omitted --><code>--kubeconfig</code>：空路径，会自动生成，后面用于连接<code>apiserver</code><!-- raw HTML omitted --></li>
<li>2.4 <!-- raw HTML omitted --><code>--bootstrap-kubeconfig</code>：首次启动向<code>apiserver</code>申请证书<!-- raw HTML omitted --></li>
<li>2.5 <!-- raw HTML omitted --><code>--config</code>：配置参数文件<!-- raw HTML omitted --></li>
<li>2.6 <!-- raw HTML omitted --><code>--cert-dir</code>：<code>kubelet</code>证书生成目录<!-- raw HTML omitted --></li>
<li>2.7 <!-- raw HTML omitted --><code>--pod-infra-container-image</code>：管理<code>Pod</code>网络容器的镜像<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /usr/local/src/kubernetes/server/bin/
</span></span><span style="display:flex;"><span>$ cp kubelet kube-proxy /opt/kubernetes/bin   <span style="color:#75715e"># 本地拷贝</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 部署bubelet</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/kubelet.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">KUBELET_OPTS=&#34;--logtostderr=false \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--v=2 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--log-dir=/opt/kubernetes/logs \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--hostname-override=k8s-master \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--network-plugin=cni \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--bootstrap-kubeconfig=/opt/kubernetes/cfg/bootstrap.kubeconfig \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--config=/opt/kubernetes/cfg/kubelet-config.yml \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cert-dir=/opt/kubernetes/ssl \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--pod-infra-container-image=lizhenliang/pause-amd64:3.0&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="配置参数文件">配置参数文件</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/kubelet-config.yml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: KubeletConfiguration
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: kubelet.config.k8s.io/v1beta1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">address: 0.0.0.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">port: 10250
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">readOnlyPort: 10255
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">cgroupDriver: cgroupfs
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">clusterDNS:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - 10.0.0.2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">clusterDomain: cluster.local 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">failSwapOn: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">authentication:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  anonymous:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    enabled: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  webhook:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    cacheTTL: 2m0s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  x509:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    clientCAFile: /opt/kubernetes/ssl/ca.pem 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">authorization:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  mode: Webhook
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  webhook:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    cacheAuthorizedTTL: 5m0s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    cacheUnauthorizedTTL: 30s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">evictionHard:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  imagefs.available: 15%
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  memory.available: 100Mi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  nodefs.available: 10%
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  nodefs.inodesFree: 5%
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">maxOpenFiles: 1000000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">maxPods: 110
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="在master节点执行以下命令生成kubelet初次加入集群引导bootstrapkubeconfig文件">在<code>master</code>节点执行以下命令，生成<code>kubelet</code>初次加入集群引导<code>bootstrap.kubeconfig</code>文件</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ KUBE_CONFIG<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/opt/kubernetes/cfg/bootstrap.kubeconfig&#34;</span>
</span></span><span style="display:flex;"><span>$ KUBE_APISERVER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://192.168.4.110:6443&#34;</span> <span style="color:#75715e"># apiserver IP:PORT</span>
</span></span><span style="display:flex;"><span>$ TOKEN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;bed185231bd89516f68ed5031946b9f9&#34;</span>  	<span style="color:#75715e"># 与token.csv里保持一致</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成 kubelet bootstrap kubeconfig 配置文件</span>
</span></span><span style="display:flex;"><span>$ kubectl config set-cluster kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--certificate-authority<span style="color:#f92672">=</span>/opt/kubernetes/ssl/ca.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--server<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_APISERVER<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>Cluster <span style="color:#e6db74">&#34;kubernetes&#34;</span> set.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config set-credentials <span style="color:#e6db74">&#34;kubelet-bootstrap&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--token<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>TOKEN<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>User <span style="color:#e6db74">&#34;kubelet-bootstrap&#34;</span> set.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config set-context default <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cluster<span style="color:#f92672">=</span>kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--user<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;kubelet-bootstrap&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>Context <span style="color:#e6db74">&#34;default&#34;</span> created.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config use-context default --kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>Switched to context <span style="color:#e6db74">&#34;default&#34;</span>.</span></span></code></pre></div></blockquote>
<hr>
<h3 id="system管理kubelet"><code>system</code>管理<code>kubelet</code></h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt; /usr/lib/systemd/system/kubelet.service <span style="color:#e6db74">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=Kubernetes Kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=docker.service
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EnvironmentFile=/opt/kubernetes/cfg/kubelet.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/kubernetes/bin/kubelet \$KUBELET_OPTS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LimitNOFILE=65536
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">####################################################################</span>
</span></span><span style="display:flex;"><span>$ systemctl daemon-reload
</span></span><span style="display:flex;"><span>$ systemctl enable kubelet systemctl start kubelet</span></span></code></pre></div></blockquote>
<hr>
<h3 id="批准kubelet证书申请并加入集群">批准<code>kubelet</code>证书申请并加入集群</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 查看kubelet证书请求</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get csr</span>
</span></span><span style="display:flex;"><span>NAME                                                   AGE     SIGNERNAME                                    REQUESTOR           CONDITION
</span></span><span style="display:flex;"><span>node-csr-Pbamt5FDLAwv0HlJpcgUP9B5c4ynIRe0Xa17zXq9I6E   4m16s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 批准申请</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl certificate approve node-csr-Pbamt5FDLAwv0HlJpcgUP9B5c4ynIRe0Xa17zXq9I6E</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>certificatesigningrequest.certificates.k8s.io/node-csr-Pbamt5FDLAwv0HlJpcgUP9B5c4ynIRe0Xa17zXq9I6E approved
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看节点,由于网络插件没有部署，节点状态 NotReady</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get node</span>
</span></span><span style="display:flex;"><span>NAME         STATUS     ROLES    AGE   VERSION
</span></span><span style="display:flex;"><span>k8s-master   NotReady   &lt;none&gt;   71s   v1.18.3</span></span></code></pre></div></blockquote>
<hr>
<h3 id="部署kube-proxy">部署<code>kube-proxy</code></h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 1. 创建配置kube-proxy文件</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/kube-proxy.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">KUBE_PROXY_OPTS=&#34;--logtostderr=false \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--v=2 \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--log-dir=/opt/kubernetes/logs \\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--config=/opt/kubernetes/cfg/kube-proxy-config.yml&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2. 配置参数文件</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/kube-proxy-config.yml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: KubeProxyConfiguration
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: kubeproxy.config.k8s.io/v1alpha1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">bindAddress: 0.0.0.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metricsBindAddress: 0.0.0.0:10249
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">clientConnection:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kubeconfig: /opt/kubernetes/cfg/kube-proxy.kubeconfig
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">hostnameOverride: k8s-master
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">clusterCIDR: 10.0.0.0/24
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3. 生成kube-proxy.kubeconfig文件：生成kube-proxy证书：</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/ssl/kube-proxy-csr.json<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;CN&#34;: &#34;system:kube-proxy&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;hosts&#34;: [],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;key&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;size&#34;: 2048
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">},
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;names&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;L&#34;: &#34;BeiJing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;ST&#34;: &#34;BeiJing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;O&#34;: &#34;k8s&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;OU&#34;: &#34;System&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 4.生成证书</span>
</span></span><span style="display:flex;"><span>$ cd /opt/kubernetes/ssl/
</span></span><span style="display:flex;"><span>$ cfssl gencert -ca<span style="color:#f92672">=</span>ca.pem -ca-key<span style="color:#f92672">=</span>ca-key.pem -config<span style="color:#f92672">=</span>ca-config.json -profile<span style="color:#f92672">=</span>kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 5. 生成kubeconfig文件</span>
</span></span><span style="display:flex;"><span>$ KUBE_CONFIG<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/opt/kubernetes/cfg/kube-proxy.kubeconfig&#34;</span>
</span></span><span style="display:flex;"><span>$ KUBE_APISERVER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://192.168.4.110:6443&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ssl<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl config set-cluster kubernetes \</span>
</span></span><span style="display:flex;"><span>--certificate-authority<span style="color:#f92672">=</span>/opt/kubernetes/ssl/ca.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--server<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_APISERVER<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>Cluster <span style="color:#e6db74">&#34;kubernetes&#34;</span> set.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ssl<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl config set-credentials kube-proxy \</span>
</span></span><span style="display:flex;"><span>--client-certificate<span style="color:#f92672">=</span>./kube-proxy.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--client-key<span style="color:#f92672">=</span>./kube-proxy-key.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>User <span style="color:#e6db74">&#34;kube-proxy&#34;</span> set.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ssl<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl config set-context default \</span>
</span></span><span style="display:flex;"><span>--cluster<span style="color:#f92672">=</span>kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--user<span style="color:#f92672">=</span>kube-proxy <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KUBE_CONFIG<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>Context <span style="color:#e6db74">&#34;default&#34;</span> created.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ssl<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl config use-context default --kubeconfig=${KUBE_CONFIG}</span>
</span></span><span style="display:flex;"><span>Switched to context <span style="color:#e6db74">&#34;default&#34;</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 6.system管理kube-proxy</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/usr/lib/systemd/system/kube-proxy.service<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=Kubernetes Proxy
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EnvironmentFile=/opt/kubernetes/cfg/kube-proxy.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/kubernetes/bin/kube-proxy \$KUBE_PROXY_OPTS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LimitNOFILE=65536
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">########################################################################</span>
</span></span><span style="display:flex;"><span>$ systemctl daemon-reload
</span></span><span style="display:flex;"><span>$ systemctl enable kube-proxy <span style="color:#f92672">&amp;&amp;</span> systemctl start kube-proxy</span></span></code></pre></div></blockquote>
<hr>
<h3 id="部署网络组件">部署网络组件</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted --><code>Calico</code>是一个纯三层的数据中心网络方案，是目前<code>Kubernetes</code>主流的网络方案。部署<code>Calico</code><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /usr/local/src/
</span></span><span style="display:flex;"><span>$ wget https://docs.projectcalico.org/v3.14/manifests/calico.yaml
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master src<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f calico.yaml  # 等Calico Pod都Running，节点也会准备就绪</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master src<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get node</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master src<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pod -n kube-system</span>
</span></span><span style="display:flex;"><span>NAME                                       READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>calico-kube-controllers-65f8bc95db-27zj8   1/1     Running   <span style="color:#ae81ff">0</span>          37m
</span></span><span style="display:flex;"><span>calico-node-skvcj                          1/1     Running   <span style="color:#ae81ff">0</span>          37m</span></span></code></pre></div></blockquote>
<hr>
<h4 id="部署cni网络">部署<code>CNI</code>网络</h4>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->先准备好<code>CNI</code>二进制文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -p /opt/cni/bin
</span></span><span style="display:flex;"><span>$ cd /usr/local/src/
</span></span><span style="display:flex;"><span>$ wget https://github.com/containernetworking/plugins/releases/download/v0.8.6/cni-plugins-linux-amd64-v0.8.6.tgz  	<span style="color:#75715e"># 下载二进制安装包</span>
</span></span><span style="display:flex;"><span>$ tar zxvf cni-plugins-linux-amd64-v0.8.6.tgz -C /opt/cni/bin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 部署CNI网络</span>
</span></span><span style="display:flex;"><span>$ cd /opt/kubernetes/cfg/
</span></span><span style="display:flex;"><span>$ wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</span></span><span style="display:flex;"><span>$ sed -i -r <span style="color:#e6db74">&#34;s#quay.io/coreos/flannel:.*-amd64#lizhenliang/flannel:v0.12.0-amd64#g&#34;</span> kube-flannel.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master cfg<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f kube-flannel.yml</span>
</span></span><span style="display:flex;"><span>podsecuritypolicy.policy/psp.flannel.unprivileged created
</span></span><span style="display:flex;"><span>clusterrole.rbac.authorization.k8s.io/flannel created
</span></span><span style="display:flex;"><span>clusterrolebinding.rbac.authorization.k8s.io/flannel created
</span></span><span style="display:flex;"><span>serviceaccount/flannel created
</span></span><span style="display:flex;"><span>configmap/kube-flannel-cfg created
</span></span><span style="display:flex;"><span>daemonset.apps/kube-flannel-ds created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master cfg<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n kube-system</span>
</span></span><span style="display:flex;"><span>NAME                    READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>kube-flannel-ds-xv7db   1/1     Running   <span style="color:#ae81ff">0</span>          58s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master cfg<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get node</span>
</span></span><span style="display:flex;"><span>NAME         STATUS   ROLES    AGE   VERSION
</span></span><span style="display:flex;"><span>k8s-master   Ready    &lt;none&gt;   23m   v1.18.3</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->授权<code>apiserver</code>访问<code>kubelet</code><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/apiserver-to-kubelet-rbac.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: ClusterRole
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">annotations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rbac.authorization.kubernetes.io/autoupdate: &#34;true&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kubernetes.io/bootstrapping: rbac-defaults
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name: system:kube-apiserver-to-kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rules:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - apiGroups:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    resources:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - nodes/proxy
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - nodes/stats
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - nodes/log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - nodes/spec
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - nodes/metrics
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - pods/log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    verbs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &#34;*&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: ClusterRoleBinding
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: system:kube-apiserver
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: &#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">roleRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  apiGroup: rbac.authorization.k8s.io
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  kind: ClusterRole
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: system:kube-apiserver-to-kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">subjects:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - apiGroup: rbac.authorization.k8s.io
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    kind: User
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##############################################################</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master cfg<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f apiserver-to-kubelet-rbac.yaml</span>
</span></span><span style="display:flex;"><span>clusterrole.rbac.authorization.k8s.io/system:kube-apiserver-to-kubelet created
</span></span><span style="display:flex;"><span>clusterrolebinding.rbac.authorization.k8s.io/system:kube-apiserver created</span></span></code></pre></div></blockquote>
<hr>
<h3 id="新增加worker-node拷贝已部署好的node相关文件到新节点">新增加<code>Worker Node:</code>拷贝已部署好的<code>Node</code>相关文件到新节点</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->在<code>master</code>节点将<code>Worker Node</code>涉及文件拷贝到其他几个新节点<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ~<span style="color:#f92672">]</span><span style="color:#75715e"># ansible node -i /etc/ansible/hosts -m copy -a &#34;src=../../opt/kubernetes dest=/opt/&#34; -f 5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ~<span style="color:#f92672">]</span><span style="color:#75715e"># ansible node -i /etc/ansible/hosts -m copy -a &#34;src=../../opt/cni  dest=/opt/&#34; -f 5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ~<span style="color:#f92672">]</span><span style="color:#75715e"># scp -r /usr/lib/systemd/system/{kubelet,kube-proxy}.service k8s-node-1:/usr/lib/systemd/system</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master ~<span style="color:#f92672">]</span><span style="color:#75715e"># scp -r /usr/lib/systemd/system/{kubelet,kube-proxy}.service k8s-node-2:/usr/lib/systemd/system</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 这几个文件是证书申请审批后自动生成的，每个Node不同，必须删除其他几个节点删除kubelet证书和kubeconfig文件，重新生成</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-node-1 ~<span style="color:#f92672">]</span><span style="color:#75715e"># rm -rf /opt/kubernetes/cfg/kubelet.kubeconfig</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-node-2 ~<span style="color:#f92672">]</span><span style="color:#75715e"># rm -rf /opt/kubernetes/cfg/kubelet.kubeconfig </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-node-1 ~<span style="color:#f92672">]</span><span style="color:#75715e"># rm -f /opt/kubernetes/ssl/kubelet*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改主机名</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-node-1 ~<span style="color:#f92672">]</span><span style="color:#75715e"># sed -i &#34;s/k8s-master/k8s-node-1/g&#34; /opt/kubernetes/cfg/kubelet.conf</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-node-1 ~<span style="color:#f92672">]</span><span style="color:#75715e"># sed -i &#34;s/k8s-master/k8s-node-1/g&#34;  /opt/kubernetes/cfg/kube-proxy-config.yml </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-node-2 ~<span style="color:#f92672">]</span><span style="color:#75715e"># sed -i &#34;s/k8s-master/k8s-node-2/g&#34; /opt/kubernetes/cfg/kubelet.conf</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-node-2 ~<span style="color:#f92672">]</span><span style="color:#75715e"># sed -i &#34;s/k8s-master/k8s-node-2/g&#34;  /opt/kubernetes/cfg/kube-proxy-config.yml</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在其他几个几点给予可执行文件执行权限，</span>
</span></span><span style="display:flex;"><span>$ chmod +x /opt/cni/bin/*
</span></span><span style="display:flex;"><span>$ chmod +x /opt/etcd/bin/*
</span></span><span style="display:flex;"><span>$ chmod +x /opt/kubernetes/bin/*
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ systemctl daemon-reload
</span></span><span style="display:flex;"><span>$ systemctl enable kubelet <span style="color:#f92672">&amp;&amp;</span> systemctl start kubelet
</span></span><span style="display:flex;"><span>$ systemctl enable kube-proxy <span style="color:#f92672">&amp;&amp;</span> systemctl start kube-proxy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在Master操作批准Node kubelet证书申请</span>
</span></span><span style="display:flex;"><span>$ kubectl get csr
</span></span><span style="display:flex;"><span>NAME                                                   AGE     SIGNERNAME                                    REQUESTOR           CONDITION
</span></span><span style="display:flex;"><span>node-csr-4vSZMnrv8OUR-zfD7dQYcDdi1L84Tv_nkNHlS8Iltfk   2m46s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending
</span></span><span style="display:flex;"><span>node-csr-KRMLTPJj4yvk5Cb6s0n5T4HtFPYJ152PpDjYHLM3Ass   10s     kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending
</span></span><span style="display:flex;"><span>node-csr-Pbamt5FDLAwv0HlJpcgUP9B5c4ynIRe0Xa17zXq9I6E   71m     kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Approved,Issued
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl certificate approve node-csr-KRMLTPJj4yvk5Cb6s0n5T4HtFPYJ152PpDjYHLM3Ass
</span></span><span style="display:flex;"><span>$ kubectl certificate approve node-csr-4vSZMnrv8OUR-zfD7dQYcDdi1L84Tv_nkNHlS8Iltfk
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># STATUS 都是Ready</span>
</span></span><span style="display:flex;"><span>$ kubectl get node
</span></span><span style="display:flex;"><span>NAME         STATUS   ROLES    AGE     VERSION
</span></span><span style="display:flex;"><span>k8s-master   Ready    &lt;none&gt;   70m     v1.18.3
</span></span><span style="display:flex;"><span>k8s-node-1   Ready    &lt;none&gt;   3m21s   v1.18.3
</span></span><span style="display:flex;"><span>k8s-node-2   Ready    &lt;none&gt;   3m2s    v1.18.3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># STATUS 都是Runing</span>
</span></span><span style="display:flex;"><span>$ kubectl get pod -n kube-system
</span></span><span style="display:flex;"><span>NAME                                       READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>calico-kube-controllers-65f8bc95db-27zj8   1/1     Running   <span style="color:#ae81ff">0</span>          65m
</span></span><span style="display:flex;"><span>calico-node-skvcj                          1/1     Running   <span style="color:#ae81ff">0</span>          65m
</span></span><span style="display:flex;"><span>calico-node-wc72m                          1/1     Running   <span style="color:#ae81ff">0</span>          2m22s
</span></span><span style="display:flex;"><span>calico-node-z5kmp                          1/1     Running   <span style="color:#ae81ff">0</span>          2m2s</span></span></code></pre></div></blockquote>
<hr>
<h4 id="创建local的storage-class">创建<code>local</code>的<code>Storage Class</code></h4>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -p /opt/data
</span></span><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/storage-class.yml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: StorageClass
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: storage.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name: local-storage
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">provisioner: kubernetes.io/no-provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">volumeBindingMode: WaitForFirstConsumer
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 执行命令创建</span>
</span></span><span style="display:flex;"><span>$ kubectl create -f storage-class.yml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看一下创建的storage class</span>
</span></span><span style="display:flex;"><span>$ kubectl get sc</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->创建<code>PV</code><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/pv-sdc.yml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: PersistentVolume
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name: local-pv-sdc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">capacity:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">storage: 30Gi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">accessModes:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - ReadWriteOnce
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  persistentVolumeReclaimPolicy: Retain
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  storageClassName: local-storage
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  local:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    path: /opt/data
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  nodeAffinity:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    required:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      nodeSelectorTerms:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - matchExpressions:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - key: kubernetes.io/hostname
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          operator: In
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          values:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          - cka
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 执行创建命令</span>
</span></span><span style="display:flex;"><span>$ kubectl create -f pv-sdc.yml
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master cfg<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pv</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->创建<code>PVC</code><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/kubernetes/cfg/pvc1.yml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: PersistentVolumeClaim
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name: pvc1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">accessModes:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - ReadWriteOnce
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  storageClassName: local-storage
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  resources:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    requests:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      storage: 10Gi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>$ kubectl create -f pvc1.yml</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted --><code>PVC</code>将会一直处于<code>Pending</code>状态直到我们创建一个<code>Pod</code>使用它<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master cfg<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pvc</span>
</span></span><span style="display:flex;"><span>NAME      STATUS    VOLUME    CAPACITY   ACCESS MODES   STORAGECLASS    AGE
</span></span><span style="display:flex;"><span>pvc1      Pending                                       local-storage   5s</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_k8s_rancher">Install_K8s_Rancher</h1>

<h2 id="安装rancher图形化管理">安装<code>Rancher</code>图形化管理</h2>
<ul>
<li>
<ol>
<li><code>Rancher</code>是供采用容器的团队使用的完整软件堆栈。它解决了管理多个</li>
</ol>
</li>
<li>
<ol start="2">
<li><code>Kubernetes</code>集群的运营和安全挑战，并为<code>DevOps</code>团队提供用于运行容器化工作负载的集成工具</li>
</ol>
</li>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->必须存在<!-- raw HTML omitted --><code>Docker</code><!-- raw HTML omitted -->环境<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>服务器</th>
<th><code>IP</code></th>
<th>内存</th>
<th>CPU</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>master</code></td>
<td>192.168.35.128</td>
<td>8G</td>
<td>8<code>core</code></td>
</tr>
<tr>
<td><code>node-1</code></td>
<td>192.168.35.129</td>
<td>4G</td>
<td>4<code>core</code></td>
</tr>
<tr>
<td><code>node-2</code></td>
<td>192.168.35.130</td>
<td>4G</td>
<td>4<code>core</code></td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h3 id="安装基础环境">安装基础环境</h3>
<ul>
<li>
<ol>
<li><code>Nano</code><!-- raw HTML omitted -->：超轻量级开源云平台<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>Naco</code>：基于<code>KVM</code>技术，使用<code>Go</code>语言开发，简单易学的虚拟机管理软件，从<code>Web</code>管理门户、主机监控、镜像克隆到故障切换，功能完备，开箱即用，数分钟之内即可将您的服务器集群升级为云主机平台</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum install -y nano</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->在所有节点都安装<!-- raw HTML omitted --><code>Docker</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># ENV configuration  </span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;/swap / s/^\(.*\)$/#\1/g&#39;</span> /etc/fstab  
</span></span><span style="display:flex;"><span>$ swapoff -a 
</span></span><span style="display:flex;"><span>$ modprobe br_netfilter  
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;br_netfilter&#34;</span> &gt; /etc/modules-load.d/br_netfilter.conf  
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;net.bridge.bridge-nf-call-iptables = 1&#34;</span> &gt;&gt; /etc/sysctl.conf  
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;net.ipv4.ip_forward = 1&#34;</span> &gt;&gt; /etc/sysctl.conf  
</span></span><span style="display:flex;"><span>$ sysctl -p  
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s/#AllowTcpForwarding/AllowTcpForwarding/g&#39;</span> /etc/ssh/sshd_config  
</span></span><span style="display:flex;"><span>$ systemctl reload sshd  
</span></span><span style="display:flex;"><span>$ systemctl stop firewalld <span style="color:#f92672">&amp;&amp;</span> systemctl disable firewalld  
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s/SELINUX=enforcing/SELINUX=disabled/g&#39;</span> /etc/selinux/config  
</span></span><span style="display:flex;"><span>$ setenforce <span style="color:#ae81ff">0</span>  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># timedate configration  </span>
</span></span><span style="display:flex;"><span>$ timedatectl set-timezone Asia/Shanghai  
</span></span><span style="display:flex;"><span>$ yum install -y chrony  
</span></span><span style="display:flex;"><span>$ systemctl start chronyd <span style="color:#f92672">&amp;&amp;</span> sudo systemctl enable chronyd 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ yum install -y yum-utils  
</span></span><span style="display:flex;"><span>$ yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo  
</span></span><span style="display:flex;"><span>$ yum install -y docker-ce-19.03.9 docker-ce-cli-19.03.9 --nogpgcheck  
</span></span><span style="display:flex;"><span>$ systemctl enable docker <span style="color:#f92672">&amp;&amp;</span> systemctl start docker  </span></span></code></pre></div></blockquote>
<hr>
<h3 id="安装rancher-v265">安装<code>Rancher v2.6.5</code></h3>
<ul>
<li>
<ol>
<li><a href="https://rancher.com/docs/rancher/v2.6/en/installation/other-installation-methods/single-node-docker/" rel="external" target="_self">使用<code>Docker</code>在单节点上安装<code>Rancher</code></a></li>
</ol>
</li>
<li>
<ol start="2">
<li><code>Rancher v2.6.5</code><!-- raw HTML omitted -->支持的<!-- raw HTML omitted --><code>Kubernetes Versions</code><!-- raw HTML omitted -->版本<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>v1.23.6 Default</code></li>
<li><code>v1.22.9</code></li>
<li><code>v1.21.12</code></li>
<li><code>v1.20.15</code></li>
<li><code>v1.19.16</code></li>
<li><code>v1.18.20</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ docker pull rancher/rancher:v2.6.5
</span></span><span style="display:flex;"><span>$ docker run -d --restart<span style="color:#f92672">=</span>unless-stopped -p 888:80 -p 4443:443 --privileged rancher/rancher:v2.6.5 </span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><a href="https://rancher.com/docs/rancher/v2.6/en/installation/install-rancher-on-k8s/" rel="external" target="_self">在<code>Kubernetes</code>集群上安装/升级<code>Rancher</code></a></li>
</ol>
</li>
</ul>
<hr>
<h3 id="font-colorred在fontkubernetesfont-colorred集群上安装升级fontrancher"><!-- raw HTML omitted -->在<!-- raw HTML omitted --><code>Kubernetes</code><!-- raw HTML omitted -->集群上安装/升级<!-- raw HTML omitted --><code>Rancher</code></h3>
<ul>
<li>
<ol>
<li><a href="https://helm.sh/docs/intro/install/" rel="external" target="_self">安装<code>Helm</code></a></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><a href="https://blog.csdn.net/qq_37481017/article/details/119002325" rel="external" target="_self">基于<code>K8S 1.21.2</code>集群安装<code>Rancher 2.5.9 HA</code></a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 使用二进制安装Helm</span>
</span></span><span style="display:flex;"><span>$ wget https://get.helm.sh/helm-v3.9.0-linux-amd64.tar.gz  
</span></span><span style="display:flex;"><span>$ tar -zxvf helm-v3.9.0-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>$ mv linux-amd64/helm /usr/local/bin/helm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 脚本安装</span>
</span></span><span style="display:flex;"><span>$ curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
</span></span><span style="display:flex;"><span>$ chmod <span style="color:#ae81ff">700</span> get_helm.sh
</span></span><span style="display:flex;"><span>$ ./get_helm.sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 源代码安装</span>
</span></span><span style="display:flex;"><span>$ git clone https://github.com/helm/helm.git
</span></span><span style="display:flex;"><span>$ cd helm
</span></span><span style="display:flex;"><span>$ make</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>cert-manager</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl create namespace cert-manager
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 添加Jetstack Helm存储库</span>
</span></span><span style="display:flex;"><span>$ helm repo add jetstack https://charts.jetstack.io
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 更新本地 Helm 图表存储库缓存</span>
</span></span><span style="display:flex;"><span>$ helm repo update
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装cert-manager自定义所需的自定义资源</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kubectl apply -f https://github.com/jetstack/cert-manager/releases/download/v1.7.1/cert-manager.crds.yaml</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ helm install cert-manager jetstack/cert-manager --namespace cert-manager --create-namespace --version v1.7.1 --set installCRDs<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 验证cert-manager证书管理器是否安装成功</span>
</span></span><span style="display:flex;"><span>$ kubectl get pods --namespace cert-manager</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>Helm</code><!-- raw HTML omitted -->安装稳定版<!-- raw HTML omitted --><code>Rancher</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 为Rancher创建命名空间</span>
</span></span><span style="display:flex;"><span>$ kubectl create namespace cattle-system
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 添加 Helm 添加 Rancher 库</span>
</span></span><span style="display:flex;"><span>$ helm repo add rancher-stable https://releases.rancher.com/server-charts/stable</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>helm</code><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>Rancher</code><!-- raw HTML omitted -->注意选好版本，版本不对会报错<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm install rancher rancher-stable/rancher --namespace cattle-system --set hostname<span style="color:#f92672">=</span>my.rancher.org --set bootstrapPassword<span style="color:#f92672">=</span>admin --set replicas<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> --version 2.6.3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --set ingress.tls.source=letsEncrypt \</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  --set letsEncrypt.email=&lt;caviardé&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME: rancher
</span></span><span style="display:flex;"><span>LAST DEPLOYED: Wed May <span style="color:#ae81ff">25</span> 18:01:51 <span style="color:#ae81ff">2022</span>
</span></span><span style="display:flex;"><span>NAMESPACE: cattle-system
</span></span><span style="display:flex;"><span>STATUS: deployed
</span></span><span style="display:flex;"><span>REVISION: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>TEST SUITE: None
</span></span><span style="display:flex;"><span>NOTES:
</span></span><span style="display:flex;"><span>Rancher Server has been installed.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NOTE: Rancher may take several minutes to fully initialize. Please standby <span style="color:#66d9ef">while</span> Certificates are being issued, Containers are started and the Ingress rule comes up.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Check out our docs at https://rancher.com/docs/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>If you provided your own bootstrap password during installation, browse to https://my.rancher.org to get started.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>If this is the first time you installed Rancher, get started by running this command and clicking the URL it generates:</span></span></code></pre></div><div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo https://my.rancher.org/dashboard/?setup<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl get secret --namespace cattle-system bootstrap-secret -o go-template<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{{.data.bootstrapPassword|base64decode}}&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># To get just the bootstrap password on its own, run:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl get secret --namespace cattle-system bootstrap-secret -o go-template<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{{.data.bootstrapPassword|base64decode}}{{ &#34;\n&#34; }}&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Happy Containering!</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->等待<!-- raw HTML omitted --><code>Rancher</code><!-- raw HTML omitted -->安装成功<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl -n cattle-system rollout status deploy/rancher
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl get pods -o wide -n cattle-system
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl get pods --show-labels -n cattle-system</span></span></code></pre></div></blockquote>
<hr>
<h2 id="浏览器登录rancher页面设置">浏览器登录<code>Rancher</code>页面设置</h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted --><strong>默认用户名：</strong><!-- raw HTML omitted --><code>admin</code></li>
</ol>
</li>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->密码新设置或者随机生成<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<p><a href="#R-image-a81ca3cb889f11d5fda895f77bb3588d" class="lightbox-link"><img alt="设置Rancher密码" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-19_18-29-03.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-a81ca3cb889f11d5fda895f77bb3588d"><img alt="设置Rancher密码" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-19_18-29-03.png"></a></p>
</blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->设置<!-- raw HTML omitted --><code>Rancher Server</code><!-- raw HTML omitted -->地址<!-- raw HTML omitted --><code>IP</code><!-- raw HTML omitted -->或者域名<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<p><a href="#R-image-4a31d2d9bc3cdfd051049645546701b7" class="lightbox-link"><img alt="设定Rancher地址" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-19_18-31-17.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-4a31d2d9bc3cdfd051049645546701b7"><img alt="设定Rancher地址" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-19_18-31-17.png"></a></p>
</blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->设置<!-- raw HTML omitted --><code>Rancher</code><!-- raw HTML omitted -->中文页面<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<p><a href="#R-image-e775e187dd0bdee27c6d7ea20739f6f3" class="lightbox-link"><img alt="set-chinses" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/set-Chinses.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-e775e187dd0bdee27c6d7ea20739f6f3"><img alt="set-chinses" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/set-Chinses.png"></a></p>
</blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->登录后可以看到目前<!-- raw HTML omitted --><code>Rancher</code><!-- raw HTML omitted -->所管理只有<!-- raw HTML omitted --><code>Rancher</code><!-- raw HTML omitted -->本身存在<!-- raw HTML omitted --><code>K3S</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>5.1 <code>Rancher Labs</code>推出<code>Kubernetes</code>开源<code>K3S</code>是一个轻量级，只有<code>40MB</code>大小，易于安装<code>Kubernetes</code>发布版本，转为资源有限和低互动系统设计，适用于边缘应用、物联网、持续整合以及<code>ARM</code>等</li>
</ul>
<p><a href="#R-image-bd7096de2f5b29a4c609d82f3c0eac6f" class="lightbox-link"><img alt="初次登录页面" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-19_18-34-35.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-bd7096de2f5b29a4c609d82f3c0eac6f"><img alt="初次登录页面" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-19_18-34-35.png"></a></p>
</blockquote>
<hr>
<h2 id="使用rancher创建rke-kubernetes集群">使用<code>Rancher</code>创建<code>RKE Kubernetes</code>集群</h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->等待被创建的集群都是基于数个实体服务器或虚拟机组成，其中这些机器硬件最低要求<!-- raw HTML omitted --><code>1Cores</code>、<code>1GB</code><!-- raw HTML omitted -->并且需要提前安装好<!-- raw HTML omitted --><code>Docker</code><!-- raw HTML omitted -->服务，操作系统必须符合<!-- raw HTML omitted --><code>RKE</code><a href="https://docs.rancher.cn/docs/rke/os/_index/" rel="external" target="_self">安装要求</a></li>
</ol>
</li>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->生产环境下不允许把<!-- raw HTML omitted --><code>worker</code><!-- raw HTML omitted -->角色添加具有<!-- raw HTML omitted --><code>etcd</code><!-- raw HTML omitted -->或<!-- raw HTML omitted --><code>control plane</code><!-- raw HTML omitted -->角色节点中<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<hr>
<h3 id="web页面配置kubernetes-cluster集群"><code>Web</code>页面配置<code>Kubernetes Cluster</code>集群</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->在<!-- raw HTML omitted --><code>Rancher</code><!-- raw HTML omitted -->浏览器页面中添加<!-- raw HTML omitted --><code>Kubernetes Cluster</code></li>
</ol>
</li>
</ul>
<blockquote>
<p><a href="#R-image-e64d68d5b8a354369fd9716c69248fd1" class="lightbox-link"><img alt="Add-K8s-Cluster" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Add-Cluster.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-e64d68d5b8a354369fd9716c69248fd1"><img alt="Add-K8s-Cluster" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Add-Cluster.png"></a></p>
</blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->选择<!-- raw HTML omitted --><code>Existing nodes(自定义集群)</code></li>
</ol>
</li>
</ul>
<blockquote>
<p><a href="#R-image-fcf27d5bcda04ec405518a28f04ee2e1" class="lightbox-link"><img alt="自定义集群" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Add-Nodes.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-fcf27d5bcda04ec405518a28f04ee2e1"><img alt="自定义集群" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Add-Nodes.png"></a></p>
</blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->定义集群名称、然后下一步<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<p><a href="#R-image-de0d2bfe698a34f499e06e60e3c9e793" class="lightbox-link"><img alt="填写集群名称" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-19_20-41-58.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-de0d2bfe698a34f499e06e60e3c9e793"><img alt="填写集群名称" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-19_20-41-58.png"></a></p>
</blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->先选择<!-- raw HTML omitted --><code>etcd</code>、<code>Control Plane</code><!-- raw HTML omitted -->角色，把生成的命令复制到节点上执行，然后下一步<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<p><a href="#R-image-6e538c1d918c81758b123dce3f9a16b6" class="lightbox-link"><img alt="部署etcd Control Plane" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-19_21-14-45.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-6e538c1d918c81758b123dce3f9a16b6"><img alt="部署etcd Control Plane" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-19_21-14-45.png"></a></p>
</blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->选择<!-- raw HTML omitted --><code>Worker</code><!-- raw HTML omitted -->工作节点,把生成的命令复制到节点执行<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<p><a href="#R-image-479af13bd51c34e9d12b77b5f5c5fda8" class="lightbox-link"><img alt="选择<code>Worker</code>工作节点" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-19_21-15-51.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-479af13bd51c34e9d12b77b5f5c5fda8"><img alt="选择<code>Worker</code>工作节点" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-19_21-15-51.png"></a></p>
</blockquote>
<ul>
<li>
<ol start="6">
<li><!-- raw HTML omitted -->命令执行完成后，等待节点加入集群，成功后下方显示添加成功<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<p><a href="#R-image-7720dadc6ed7104632cc1c61e8192325" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-19_21-20-56.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-7720dadc6ed7104632cc1c61e8192325"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-19_21-20-56.png"></a></p>
</blockquote>
<hr>
<h3 id="如果错过复制添加命令选择命名空间点击edit">如果错过复制添加命令选择命名空间点击<code>Edit</code></h3>
<blockquote>
<p><a href="#R-image-1e4118c7826515ba873258554e4c84ee" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-20_15-42-56.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-1e4118c7826515ba873258554e4c84ee"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-20_15-42-56.png"></a></p>
<p><a href="#R-image-5c37d3122d6abf6deb081c576eb84d6d" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-20_15-44-52.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-5c37d3122d6abf6deb081c576eb84d6d"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-20_15-44-52.png"></a></p>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_k8s_kubesphere">Install_K8s_KubeSphere</h1>

<h2 id="在现有kubernetes上安装kubesphere-web管理系统">在现有<code>Kubernetes</code>上安装<code>KubeSphere Web</code>管理系统</h2>
<!-- raw HTML omitted -->
<blockquote>
<ul>
<li>
<ol>
<li><a href="https://kuboard.cn/" rel="external" target="_self"><code>Kuboard</code>一款免费的<code>Kubernetes</code>管理界面</a></li>
</ol>
</li>
<li>
<ol start="2">
<li><a href="https://kubeoperator.io/" rel="external" target="_self"><code>KubeOperator</code>可视化的<code>Web UI</code></a></li>
</ol>
</li>
</ul>
</blockquote>
<ul>
<li>
<ol>
<li>如需在<code>Kubernetes</code>上安装<code>KubeSphere 3.3.0</code>，您的<code>Kubernetes</code>版本必须为：<code>v1.19.x，v1.20.x，v1.21.x，v1.22.x 或 v1.23.x</code>（实验性支持）</li>
</ol>
</li>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->确保您的机器满足最低硬件要求：<!-- raw HTML omitted --><code>CPU &gt; 1核</code>、<code>内存 &gt; 2GB</code></li>
</ol>
</li>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->在安装之前，需要配置<!-- raw HTML omitted --><code>Kubernetes</code><!-- raw HTML omitted -->集群中的<!-- raw HTML omitted --><code>默认</code><!-- raw HTML omitted -->存储类型，以便实现动态供应<!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>NFS</code><!-- raw HTML omitted -->的动态供应的默认存储类<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/k8s/yaml/data-storage.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 创建一个存储类
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: storage.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: StorageClass
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	name: nfs-storage
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	annotations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		storageclass.kubernetes.io/is-default-class: &#34;true&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">provisioner: k8s-sigs.io/nfs-subdir-external-provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">parameters:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	archiveOnDelete: &#34;true&#34;  	# 删除pv的时候，pv的内容是否要备份
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: apps/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Deployment
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	name: nfs-client-provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		app: nfs-client-provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# replace with namespace where provisioner is deployed
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	namespace: default
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	replicas: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	strategy:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		type: Recreate
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	selector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		matchLabels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			app: nfs-client-provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	template:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">				app: nfs-client-provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			serviceAccountName: nfs-client-provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">				- name: nfs-client-provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">				  image: registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images/nfs-subdir-external-provisioner:v4.0.2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">				  # resources:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">					  # limits:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">						  # cpu: 10m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">					  # requests:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">						  # cpu: 10m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">				  volumeMounts:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">					  - name: nfs-client-root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">						mountPath: /persistentvolumes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">				  env:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">					  - name: PROVISIONER_NAME
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">						value: k8s-sigs.io/nfs-subdir-external-provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">					  - name: NFS_SERVER
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">						value: 192.168.94.110  	# 指定自己nfs服务器地址
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">					  - name: NFS_PATH  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">						value: /opt/data/kubesphere  	# nfs服务器共享的目录
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			volumes:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">				- name: nfs-client-root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">				  nfs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">					  server: 192.168.94.110
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">					  path: /opt/data/kubesphere
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: ServiceAccount
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: nfs-client-provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # replace with namespace where provisioner is deployed
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    namespace: default
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: ClusterRole
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: nfs-client-provisioner-runner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rules:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - apiGroups: [&#34;&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      resources: [&#34;nodes&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      verbs: [&#34;get&#34;, &#34;list&#34;, &#34;watch&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - apiGroups: [&#34;&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      resources: [&#34;persistentvolumes&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      verbs: [&#34;get&#34;, &#34;list&#34;, &#34;watch&#34;, &#34;create&#34;, &#34;delete&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - apiGroups: [&#34;&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      resources: [&#34;persistentvolumeclaims&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      verbs: [&#34;get&#34;, &#34;list&#34;, &#34;watch&#34;, &#34;update&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - apiGroups: [&#34;storage.k8s.io&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      resources: [&#34;storageclasses&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      verbs: [&#34;get&#34;, &#34;list&#34;, &#34;watch&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - apiGroups: [&#34;&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      resources: [&#34;events&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      verbs: [&#34;create&#34;, &#34;update&#34;, &#34;patch&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: ClusterRoleBinding
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: run-nfs-client-provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">subjects:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - kind: ServiceAccount
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      name: nfs-client-provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      # replace with namespace where provisioner is deployed
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      namespace: default
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">roleRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    kind: ClusterRole
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: nfs-client-provisioner-runner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    apiGroup: rbac.authorization.k8s.io
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Role
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: leader-locking-nfs-client-provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # replace with namespace where provisioner is deployed
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    namespace: default
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rules:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - apiGroups: [&#34;&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      resources: [&#34;endpoints&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      verbs: [&#34;get&#34;, &#34;list&#34;, &#34;watch&#34;, &#34;create&#34;, &#34;update&#34;, &#34;patch&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: RoleBinding
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: leader-locking-nfs-client-provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # replace with namespace where provisioner is deployed
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    namespace: default
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">subjects:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - kind: ServiceAccount
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      name: nfs-client-provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      # replace with namespace where provisioner is deployed
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      namespace: default
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">roleRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    kind: Role
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: leader-locking-nfs-client-provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    apiGroup: rbac.authorization.k8s.io
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->配置集群指标监控组件<!-- raw HTML omitted --><a href="https://github.com/kubernetes-sigs/metrics-server" rel="external" target="_self"><code>Kubernetes</code>指标服务器</a></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>5.1 <code>- --kubelet-insecure-tls</code>：<code>kubelet</code>的<code>10250</code>端口使用的是<code>https</code>协议，连接需要验证<code>tls</code>证书，<code>--kubelet-insecure-tls</code><!-- raw HTML omitted -->不验证客户端证书，仅用于测试目的<!-- raw HTML omitted --></li>
<li>5.2 <a href="https://github.com/kubernetes/kube-state-metrics" rel="external" target="_self"><code>kube-state-metrics</code></a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/k8s/yaml/metrics_server.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: ServiceAccount
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        k8s-app: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    namespace: kube-system
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: ClusterRole
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        k8s-app: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        rbac.authorization.k8s.io/aggregate-to-admin: &#34;true&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        rbac.authorization.k8s.io/aggregate-to-edit: &#34;true&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        rbac.authorization.k8s.io/aggregate-to-view: &#34;true&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: system:aggregated-metrics-reader
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rules:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - apiGroups:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - metrics.k8s.io
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      resources:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - pods
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - nodes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      verbs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - get
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - list
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - watch
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: ClusterRole
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        k8s-app: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: system:metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rules:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - apiGroups:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      resources:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - pods
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - nodes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - nodes/stats
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - namespaces
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - configmaps
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      verbs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - get
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - list
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - watch
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: RoleBinding
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        k8s-app: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: metrics-server-auth-reader
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    namespace: kube-system
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">roleRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    apiGroup: rbac.authorization.k8s.io
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    kind: Role
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: extension-apiserver-authentication-reader
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">subjects:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - kind: ServiceAccount
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      name: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      namespace: kube-system
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: ClusterRoleBinding
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        k8s-app: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: metrics-server:system:auth-delegator
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">roleRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    apiGroup: rbac.authorization.k8s.io
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    kind: ClusterRole
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: system:auth-delegator
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">subjects:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - kind: ServiceAccount
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      name: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      namespace: kube-system
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: ClusterRoleBinding
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        k8s-app: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: system:metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">roleRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    apiGroup: rbac.authorization.k8s.io
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    kind: ClusterRole
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: system:metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">subjects:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - kind: ServiceAccount
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      name: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      namespace: kube-system
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Service
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        k8s-app: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    namespace: kube-system
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ports:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - name: https
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          port: 443
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          protocol: TCP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          targetPort: https
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    selector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        k8s-app: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: apps/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Deployment
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        k8s-app: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    namespace: kube-system
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    selector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        matchLabels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            k8s-app: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    strategy:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        rollingUpdate:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            maxUnavailable: 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    template:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                k8s-app: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    - --cert-dir=/tmp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    - --kubelet-insecure-tls
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    - --secure-port=4443
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    - --kubelet-preferred-address-types=InternalIP,Hostname,InternalDNS,ExternalDNS,ExternalIP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    - --kubelet-use-node-status-port
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    image: k8s.gcr.io/metrics-server/metrics-server:v0.6.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    # image: registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images/metrics-server:v0.4.3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    imagePullPolicy: IfNotPresent
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    livenessProbe:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        failureThreshold: 3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        httpGet:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            path: /livez
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            port: https
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            scheme: HTTPS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        periodSeconds: 10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    name: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    ports:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        - containerPort: 4443
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                          name: https
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                          protocol: TCP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    readinessProbe:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        failureThreshold: 3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        httpGet:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            path: /readyz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            port: https
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            scheme: HTTPS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        periodSeconds: 10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    securityContext:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        readOnlyRootFilesystem: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        runAsNonRoot: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        runAsUser: 1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    volumeMounts:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        - mountPath: /tmp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                          name: tmp-dir
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            nodeSelector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                kubernetes.io/os: linux
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            priorityClassName: system-cluster-critical
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            serviceAccountName: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            volumes:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - emptyDir: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  name: tmp-dir
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: apiregistration.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: APIService
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        k8s-app: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: v1beta1.metrics.k8s.io
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    group: metrics.k8s.io
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    groupPriorityMinimum: 100
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    insecureSkipTLSVerify: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    service:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        name: metrics-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        namespace: kube-system
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    version: v1beta1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    versionPriority: 100
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li>5.1 <!-- raw HTML omitted -->执行命令查看<!-- raw HTML omitted --><code>Node</code>节点结果</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl top nodes
</span></span><span style="display:flex;"><span>NAME            CPU<span style="color:#f92672">(</span>cores<span style="color:#f92672">)</span>   CPU%   MEMORY<span style="color:#f92672">(</span>bytes<span style="color:#f92672">)</span>   MEMORY%   
</span></span><span style="display:flex;"><span>k8s-master-01   148m         7%     3690Mi          46%       
</span></span><span style="display:flex;"><span>k8s-node-01     35m          1%     492Mi           8%        
</span></span><span style="display:flex;"><span>k8s-node-02     32m          1%     358Mi           6%</span></span></code></pre></div><ul>
<li>5.2 <!-- raw HTML omitted -->执行命令查看<!-- raw HTML omitted --><code>Pod</code>状态</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$  kubectl top pods -A
</span></span><span style="display:flex;"><span>NAMESPACE       NAME                                        CPU<span style="color:#f92672">(</span>cores<span style="color:#f92672">)</span>  MEMORY<span style="color:#f92672">(</span>bytes<span style="color:#f92672">)</span>   
</span></span><span style="display:flex;"><span>default         nfs-client-provisioner-6f9769d4c4-h6jw9     3m           12Mi 
</span></span><span style="display:flex;"><span>ingress-nginx   ingress-nginx-controller-5fd8bfcbdc-bzppj   2m           96Mi
</span></span><span style="display:flex;"><span>kube-flannel    kube-flannel-ds-6tl2b                       5m           33Mi
</span></span><span style="display:flex;"><span>kube-flannel    kube-flannel-ds-n4k68                       3m           33Mi 
</span></span><span style="display:flex;"><span>kube-flannel    kube-flannel-ds-zkqhz                       3m           33Mi 
</span></span><span style="display:flex;"><span>kube-system     coredns-64897985d-6r9ds                     2m           17Mi
</span></span><span style="display:flex;"><span>kube-system     coredns-64897985d-fwmz5                     2m           14Mi
</span></span><span style="display:flex;"><span>kube-system     etcd-k8s-master-01                          20m          112Mi
</span></span><span style="display:flex;"><span>kube-system     kube-apiserver-k8s-master-01                63m          237Mi
</span></span><span style="display:flex;"><span>kube-system     kube-controller-manager-k8s-master-01       20m          50Mi 
</span></span><span style="display:flex;"><span>kube-system     kube-proxy-blnt7                            1m           18Mi 
</span></span><span style="display:flex;"><span>kube-system     kube-proxy-k5gkm                            1m           17Mi
</span></span><span style="display:flex;"><span>kube-system     kube-proxy-xpvqr                            1m           17Mi
</span></span><span style="display:flex;"><span>kube-system     kube-scheduler-k8s-master-01                5m           21Mi
</span></span><span style="display:flex;"><span>kube-system     metrics-server-658c4cf555-bpfcf             5m           19Mi</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="6">
<li><!-- raw HTML omitted -->下载、安装<!-- raw HTML omitted --><code>KubeSphere</code>的<code>yaml</code>文件</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget -P /opt/k8s/yaml/kubesphere/ https://github.com/kubesphere/ks-installer/releases/download/v3.3.1/kubesphere-installer.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ wget -P /opt/k8s/yaml/kubesphere/ https://github.com/kubesphere/ks-installer/releases/download/v3.3.1/cluster-configuration.yaml</span></span></code></pre></div><ul>
<li>6.1 修改<code>cluster-configuration</code>文件<code>启用可插拔组件</code></li>
</ul>
<blockquote>
<ul>
<li>6.1.1 <a href="https://kubesphere.com.cn/docs/v3.3/pluggable-components/overview/" rel="external" target="_self">官网<!-- raw HTML omitted -->启用可插拔组件<!-- raw HTML omitted --></a></li>
</ul>
</blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterConfiguration</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ks-installer</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kubesphere-system</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v3.3.0</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">persistence</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">storageClass</span>: <span style="color:#e6db74">&#34;&#34;</span>  	<span style="color:#75715e"># If there is no default StorageClass in your cluster, you need to specify an existing StorageClass here.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">authentication</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">jwtSecret</span>: <span style="color:#e6db74">&#34;&#34;</span>  	<span style="color:#75715e"># Keep the jwtSecret consistent with the Host Cluster. Retrieve the jwtSecret by executing &#34;kubectl -n kubesphere-system get cm kubesphere-config -o yaml | grep -v &#34;apiVersion&#34; | grep jwtSecret&#34; on the Host Cluster.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">local_registry</span>: <span style="color:#e6db74">&#34;&#34;</span>  	<span style="color:#75715e"># Add your private registry address if it is needed.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># dev_tag: &#34;&#34;  	# Add your kubesphere image tag you want to install, by default it&#39;s same as ks-installer release version.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">etcd</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">monitoring</span>: <span style="color:#66d9ef">true</span>  	<span style="color:#75715e"># 启用或禁用 etcd 监控仪表板安装。 在启用之前，您必须为 etcd 创建一个 Secret， 启用修改为：true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">endpointIps</span>: <span style="color:#ae81ff">192.168.94.110</span>  	<span style="color:#75715e"># etcd 集群 EndpointIps。 这里可以是一堆IP。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">2379</span>  	<span style="color:#75715e"># etcd port.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tlsEnable</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">common</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">core</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">console</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">enableMultiLogin</span>: <span style="color:#66d9ef">true</span>  	<span style="color:#75715e"># Enable or disable simultaneous logins. It allows different users to log in with the same account at the same time.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">port</span>: <span style="color:#ae81ff">30880</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">type</span>: <span style="color:#ae81ff">NodePort</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># apiserver:  	# Enlarge the apiserver and controller manager&#39;s resource requests and limits for the large cluster</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#  resources: {}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># controllerManager:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#  resources: {}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">redis</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>  	<span style="color:#75715e"># 启用 Redis 功能，修改为：true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">enableHA</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumeSize</span>: <span style="color:#ae81ff">2Gi  	# Redis PVC size.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">openldap</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>  	<span style="color:#75715e"># 启用轻量级目录协议，修改为：true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumeSize</span>: <span style="color:#ae81ff">2Gi  	# openldap PVC size.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">minio</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumeSize</span>: <span style="color:#ae81ff">20Gi  	# Minio PVC size.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">monitoring</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># type: external  	# Whether to specify the external prometheus stack, and need to modify the endpoint at the next line.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">endpoint</span>: <span style="color:#ae81ff">http://prometheus-operated.kubesphere-monitoring-system.svc:9090</span> <span style="color:#75715e"># Prometheus endpoint to get metrics data.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">GPUMonitoring</span>:  	<span style="color:#75715e"># Enable or disable the GPU-related metrics. If you enable this switch but have no GPU resources, Kubesphere will set it to zero.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">gpu</span>:  	<span style="color:#75715e"># Install GPUKinds. The default GPU kind is nvidia.com/gpu. Other GPU kinds can be added here according to your needs.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">kinds</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">resourceName</span>: <span style="color:#e6db74">&#34;nvidia.com/gpu&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">resourceType</span>: <span style="color:#e6db74">&#34;GPU&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">default</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">es</span>:   <span style="color:#75715e"># Storage backend for logging, events and auditing.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># master:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#   volumeSize: 4Gi  # The volume size of Elasticsearch master nodes.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#   replicas: 1      # The total number of master nodes. Even numbers are not allowed.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#   resources: {}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># data:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#   volumeSize: 20Gi  # The volume size of Elasticsearch data nodes.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#   replicas: 1  	# The total number of data nodes.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#   resources: {}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">logMaxAge</span>: <span style="color:#ae81ff">7</span>  	<span style="color:#75715e"># Log retention time in built-in Elasticsearch. It is 7 days by default.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">elkPrefix</span>: <span style="color:#ae81ff">logstash  	# The string making up index names. The index name will be formatted as ks-&lt;elk_prefix&gt;-log.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">basicAuth</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">username</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">password</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">externalElasticsearchHost</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">externalElasticsearchPort</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">alerting:  	# (CPU: 0.1 Core, Memory</span>: <span style="color:#ae81ff">100</span> <span style="color:#ae81ff">MiB) It enables users to customize alerting policies to send messages to receivers in time with different time intervals and alerting levels to choose from.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>  	<span style="color:#75715e"># 启用或禁用 KubeSphere 警报系统，修改为：true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># thanosruler:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   replicas: 1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   resources: {}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">auditing</span>:  	<span style="color:#75715e"># Provide a security-relevant chronological set of records，recording the sequence of activities happening on the platform, initiated by different tenants.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>  	<span style="color:#75715e"># 启用或禁用 KubeSphere 审计日志系统，修改为：true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># operator:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   resources: {}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># webhook:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   resources: {}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">devops:  	# (CPU: 0.47 Core, Memory</span>: <span style="color:#ae81ff">8.6</span> <span style="color:#ae81ff">G) Provide an out-of-the-box CI/CD system based on Jenkins, and automated workflow tools including Source-to-Image &amp; Binary-to-Image.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>  	<span style="color:#75715e"># 启用或禁用 KubeSphere DevOps 系统，修改为：true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># resources: {}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">jenkinsMemoryLim</span>: <span style="color:#ae81ff">2Gi  	# Jenkins memory limit.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">jenkinsMemoryReq</span>: <span style="color:#ae81ff">1500Mi  	# Jenkins memory request.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">jenkinsVolumeSize</span>: <span style="color:#ae81ff">8Gi  	# Jenkins volume size.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">jenkinsJavaOpts_Xms</span>: <span style="color:#ae81ff">1200m  	# The following three fields are JVM parameters.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">jenkinsJavaOpts_Xmx</span>: <span style="color:#ae81ff">1600m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">jenkinsJavaOpts_MaxRAM</span>: <span style="color:#ae81ff">2g</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">events</span>:  	<span style="color:#75715e"># Provide a graphical web console for Kubernetes Events exporting, filtering and alerting in multi-tenant Kubernetes clusters.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>  	<span style="color:#75715e"># 启用或禁用 KubeSphere 事件系统，修改为：true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># operator:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   resources: {}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># exporter:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   resources: {}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ruler:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   enabled: true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   replicas: 2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   resources: {}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">logging:  	# (CPU: 57 m, Memory</span>: <span style="color:#ae81ff">2.76</span> <span style="color:#ae81ff">G) Flexible logging functions are provided for log query, collection and management in a unified console. Additional log collectors can be added, such as Elasticsearch, Kafka and Fluentd.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>  	<span style="color:#75715e"># 启用或禁用 KubeSphere 日志系统，修改为：true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">logsidecar</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># resources: {}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">metrics_server:  	# (CPU: 56 m, Memory</span>: <span style="color:#ae81ff">44.35</span> <span style="color:#ae81ff">MiB) It enables HPA (Horizontal Pod Autoscaler).</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>  	<span style="color:#75715e"># 启用或禁用监控指标服务器，从hub.docker官方拉取镜像，网络不好会报网络错误，如果已提前安装请忽略，修改为：true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">monitoring</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">storageClass</span>: <span style="color:#e6db74">&#34;&#34;</span>  	<span style="color:#75715e"># If there is an independent StorageClass you need for Prometheus, you can specify it here. The default StorageClass is used by default.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">node_exporter</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">port</span>: <span style="color:#ae81ff">9100</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># resources: {}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># kube_rbac_proxy:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   resources: {}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># kube_state_metrics:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   resources: {}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># prometheus:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   replicas: 1  # Prometheus replicas are responsible for monitoring different segments of data source and providing high availability.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   volumeSize: 20Gi  # Prometheus PVC size.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   resources: {}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   operator:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#     resources: {}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># alertmanager:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   replicas: 1  	# AlertManager Replicas.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   resources: {}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># notification_manager:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   resources: {}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   operator:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#     resources: {}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   proxy:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#     resources: {}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">gpu</span>:  	<span style="color:#75715e"># GPU monitoring-related plug-in installation.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nvidia_dcgm_exporter</span>:  	<span style="color:#75715e"># Ensure that gpu resources on your hosts can be used normally, otherwise this plug-in will not work properly.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>  	<span style="color:#75715e"># Check whether the labels on the GPU hosts contain &#34;nvidia.com/gpu.present=true&#34; to ensure that the DCGM pod is scheduled to these nodes.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># resources: {}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">multicluster</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">clusterRole</span>: <span style="color:#ae81ff">none  # host | member | none </span> <span style="color:#75715e"># You can install a solo cluster, or specify it as the Host or Member Cluster.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">network</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networkpolicy</span>: <span style="color:#75715e"># Network policies allow network isolation within the same cluster, which means firewalls can be set up between certain instances (Pods).</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># Make sure that the CNI network plugin used by the cluster supports NetworkPolicy. There are a number of CNI network plugins that support NetworkPolicy, including Calico, Cilium, Kube-router, Romana and Weave Net.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>  	<span style="color:#75715e"># 启用或禁用网络策略，修改为：true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ippool</span>: <span style="color:#75715e"># Use Pod IP Pools to manage the Pod network address space. Pods to be created can be assigned IP addresses from a Pod IP Pool.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">type</span>: <span style="color:#ae81ff">none</span> <span style="color:#75715e"># 如果 Calico 用作您的 CNI 插件，请为此字段指定“calico”。 “none”表示 Pod IP 池已禁用</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">topology</span>: <span style="color:#75715e"># Use Service Topology to view Service-to-Service communication based on Weave Scope.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">type</span>: <span style="color:#ae81ff">none</span> <span style="color:#75715e"># Specify &#34;weave-scope&#34; for this field to enable Service Topology. &#34;none&#34; means that Service Topology is disabled.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">openpitrix</span>: <span style="color:#75715e"># An App Store that is accessible to all platform tenants. You can use it to manage apps across their entire lifecycle.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">store</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>  	<span style="color:#75715e"># 启用或禁用 KubeSphere 应用商店，修改为：true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">servicemesh</span>:  	<span style="color:#75715e"># (0.3 Core, 300 MiB) Provide fine-grained traffic management, observability and tracing, and visualized traffic topology.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>  	<span style="color:#75715e"># 基础组件（试点）。 启用或禁用 KubeSphere 服务网格（基于 Istio）微服务治理功能，修改为：true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">istio</span>:  <span style="color:#75715e"># Customizing the istio installation configuration, refer to https://istio.io/latest/docs/setup/additional-setup/customize-installation/</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">components</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ingressGateways</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">istio-ingressgateway</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cni</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">edgeruntime</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>  	<span style="color:#75715e"># 将边缘节点添加到集群并在边缘节点上部署工作负载，启动边缘计算服务，修改为：true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubeedge</span>:  	<span style="color:#75715e"># kubeedge configurations</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cloudCore</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cloudHub</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">advertiseAddress</span>: <span style="color:#75715e"># At least a public IP address or an IP address which can be accessed by edge nodes must be provided.</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#e6db74">&#34;&#34;</span>            <span style="color:#75715e"># Note that once KubeEdge is enabled, CloudCore will malfunction if the address is not provided.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">cloudhubNodePort</span>: <span style="color:#e6db74">&#34;30000&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">cloudhubQuicNodePort</span>: <span style="color:#e6db74">&#34;30001&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">cloudhubHttpsNodePort</span>: <span style="color:#e6db74">&#34;30002&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">cloudstreamNodePort</span>: <span style="color:#e6db74">&#34;30003&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">tunnelNodePort</span>: <span style="color:#e6db74">&#34;30004&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># resources: {}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># hostNetWork: false</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">iptables-manager</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">mode</span>: <span style="color:#e6db74">&#34;external&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># resources: {}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># edgeService:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#   resources: {}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">gatekeeper</span>:        <span style="color:#75715e"># Provide admission policy and rule management, A validating (mutating TBA) webhook that enforces CRD-based policies executed by Open Policy Agent.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>   <span style="color:#75715e"># Enable or disable Gatekeeper.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># controller_manager:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   resources: {}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># audit:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   resources: {}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">terminal</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># image: &#39;alpine:3.15&#39; # There must be an nsenter program in the image</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">timeout</span>: <span style="color:#ae81ff">600</span>  	<span style="color:#75715e"># Container timeout, if set to 0, no timeout will be used. The unit is seconds</span></span></span></code></pre></div><ul>
<li>6.2 <!-- raw HTML omitted -->修改好配置后安装<!-- raw HTML omitted --><code>KubeSphere</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl apply -f kubesphere-installer.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl apply -f cluster-configuration.yaml</span></span></code></pre></div><ul>
<li>6.3 <!-- raw HTML omitted -->跟踪安装进度<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl logs -n kubesphere-system <span style="color:#66d9ef">$(</span>kubectl get pod -n kubesphere-system -l <span style="color:#e6db74">&#39;app in (ks-install, ks-installer)&#39;</span> -o jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{.items[0].metadata.name}&#39;</span><span style="color:#66d9ef">)</span> -f</span></span></code></pre></div><ul>
<li>6.4 查看所有<code>Pod</code>是否在<code>KubeSphere</code><!-- raw HTML omitted -->的相关命名空间中正常运行<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl get svc/ks-console -n kubesphere-system</span></span></code></pre></div><ul>
<li>6.5 解决<code>prometheus-k8s</code>的<code>pods</code><!-- raw HTML omitted -->因为证书不能启动<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl -n kubesphere-monitoring-system create secret generic kube-etcd-client-certs  --from-file<span style="color:#f92672">=</span>etcd-client-ca.crt<span style="color:#f92672">=</span>/etc/kubernetes/pki/etcd/ca.crt  --from-file<span style="color:#f92672">=</span>etcd-client.crt<span style="color:#f92672">=</span>/etc/kubernetes/pki/apiserver-etcd-client.crt  --from-file<span style="color:#f92672">=</span>etcd-client.key<span style="color:#f92672">=</span>/etc/kubernetes/pki/apiserver-etcd-client.key</span></span></code></pre></div><ul>
<li>6.6 <!-- raw HTML omitted -->使用浏览器访问<!-- raw HTML omitted --><code>KubeSphere</code>放行：<code>30880</code>端口</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted --><strong>默认用户名：</strong><!-- raw HTML omitted --><code>admin</code></li>
<li><!-- raw HTML omitted --><strong>默认密码：</strong><!-- raw HTML omitted --><code>P@88w0rd</code></li>
</ul>
</blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ http://IP:30880</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_k8s_harbor">Install_K8s_Harbor</h1>

<h2 id="安装harbor私有镜像库">安装<code>Harbor</code>私有镜像库</h2>
<blockquote>
<ul>
<li><!-- raw HTML omitted --><strong>默认用户名：</strong><!-- raw HTML omitted --><code>admin </code></li>
<li><!-- raw HTML omitted --><strong>默认密码：</strong><!-- raw HTML omitted --><code>Harbor12345</code></li>
<li><!-- raw HTML omitted --><strong>必须先安装</strong><!-- raw HTML omitted --><code>docker</code></li>
<li><code>Harbor</code><!-- raw HTML omitted --><strong>依赖</strong><!-- raw HTML omitted --><code>docker-compose</code></li>
</ul>
</blockquote>
<hr>
<h3 id="安装docker-compose">安装<code>docker-compose</code></h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ curl -L https://get.daocloud.io/docker/compose/releases/download/1.21.2/docker-compose-<span style="color:#e6db74">`</span>uname -s<span style="color:#e6db74">`</span>-<span style="color:#e6db74">`</span>uname -m<span style="color:#e6db74">`</span> &gt; /usr/local/bin/docker-compose
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 给予执行权限</span>
</span></span><span style="display:flex;"><span>$ chmod +x /usr/local/bin/docker-compose
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装Compose命令补全工具</span>
</span></span><span style="display:flex;"><span>$ curl -L https://raw.githubusercontent.com/docker/compose/<span style="color:#66d9ef">$(</span>docker-compose version --short<span style="color:#66d9ef">)</span>/contrib/completion/bash/docker-compose -o /etc/bash_completion.d/docker-compose
</span></span><span style="display:flex;"><span>$ systemctl daemon-reload <span style="color:#f92672">&amp;&amp;</span> systemctl restart docker</span></span></code></pre></div></blockquote>
<hr>
<h3 id="安装harbor">安装<code>Harbor</code></h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget https://github.com/goharbor/harbor/releases/download/v2.10.0/harbor-offline-installer-v2.10.0.tgz
</span></span><span style="display:flex;"><span>$ tar -zxvf harbor-offline-installer-v2.10.0.tgz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ vim harbor/harbor.yml
</span></span><span style="display:flex;"><span>hostname: reg.mydomain.com  	<span style="color:#75715e"># 修改主机名： my.harbor.com</span>
</span></span><span style="display:flex;"><span>port: <span style="color:#ae81ff">80</span>  	<span style="color:#75715e"># 修改http默认端口：8080</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># port: 443  	# 注释https协议端口</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ./install.sh</span></span></code></pre></div><ul>
<li><a href="https://goharbor.io/docs/2.0.0/install-config/configure-https/" rel="external" target="_self">配置对<code>Harbor</code>的<code>HTTPS</code>访问</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 生成 CA 证书私钥</span>
</span></span><span style="display:flex;"><span>$ openssl genrsa -out ca.key <span style="color:#ae81ff">4096</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成 CA 证书</span>
</span></span><span style="display:flex;"><span>$ openssl req -x509 -new -nodes -sha512 -days <span style="color:#ae81ff">3650</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> -subj <span style="color:#e6db74">&#34;/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=yourdomain.com&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> -key ca.key <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> -out ca.crt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成私钥</span>
</span></span><span style="display:flex;"><span>$ openssl genrsa -out yourdomain.com.key <span style="color:#ae81ff">4096</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成证书签名请求 (CSR)</span>
</span></span><span style="display:flex;"><span>$ openssl req -sha512 -new <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -subj <span style="color:#e6db74">&#34;/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=yourdomain.com&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -key yourdomain.com.key <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -out yourdomain.com.csr
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成 x509 v3 扩展文件</span>
</span></span><span style="display:flex;"><span>$ cat &gt; v3.ext <span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">authorityKeyIdentifier=keyid,issuer
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">basicConstraints=CA:FALSE
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">extendedKeyUsage = serverAuth
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">subjectAltName = @alt_names
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[alt_names]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DNS.1=yourdomain.com
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DNS.2=yourdomain
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DNS.3=hostname
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用该v3.ext文件为您的 Harbor 主机生成证书</span>
</span></span><span style="display:flex;"><span>$ openssl x509 -req -sha512 -days <span style="color:#ae81ff">3650</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -extfile v3.ext <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -CA ca.crt -CAkey ca.key -CAcreateserial <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -in yourdomain.com.csr <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -out yourdomain.com.crt</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol>
<li><code>docker</code><!-- raw HTML omitted -->登录<!-- raw HTML omitted --><code>Harbor</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ docker login http://192.168.80.225:8080</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->如果报错：<!-- raw HTML omitted --><code>Error response from daemon: Get  http: server gave HTTP response to HTTPS client</code></li>
</ol>
</li>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->修改配置文件(指定私有仓库，可忽略跳过)<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ tee /etc/docker/daemon.json <span style="color:#e6db74">&lt;&lt;-&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   &#34;storage-driver&#34;: &#34;overlay2&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   &#34;registry-mirrors&#34;:[&#34;https://r2hd8p9u.mirror.aliyuncs.com&#34;],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   &#34;insecure-registries&#34;:[&#34;*.*.*.*:5000&#34;,&#34;192.168.4.126&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ vim /etc/docker/daemon.json
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34;insecure-registries&#34;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;harbor服务器IP:端口&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>$ systemctl daemon-reload <span style="color:#f92672">&amp;&amp;</span> systemctl restart docker</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->报错：<!-- raw HTML omitted --><code>request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers) (Client.Timeout exceeded while awaiting headers)</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ vim /etc/hosts  	<span style="color:#75715e"># 修改hosts解析</span>
</span></span><span style="display:flex;"><span>本机服务IP my.harbodomain.com</span></span></code></pre></div></blockquote>
<hr>
<h3 id="推送镜像到harbor仓库">推送镜像到<code>Harbor</code>仓库</h3>
<blockquote>
<ul>
<li><code>SOURCE_IMAGE[:TAG]</code><!-- raw HTML omitted -->：原镜像名字和<!-- raw HTML omitted --><code>tag</code></li>
<li><code>test</code><!-- raw HTML omitted -->：<code>Harbor</code>项目名称<!-- raw HTML omitted --></li>
<li><code>IMAGE[:TAG]</code><!-- raw HTML omitted -->：自定义命名，以及版本标签<!-- raw HTML omitted --></li>
</ul>
<p>示例：</p>
<div class="highlight wrap-code"><pre tabindex="0"><code class="language-she" data-lang="she"># 在项目中标记镜像
$ docker tag SOURCE_IMAGE[:TAG] 192.168.35.128:9527/test/IMAGE[:TAG]

# 推送镜像到当前项目
$ docker push 192.168.35.128:9527/test/IMAGE[:TAG]</code></pre></div></blockquote>
<hr>
<h3 id="font-colorred其他服务器拉取fontharborfont-colorred仓库镜像font"><!-- raw HTML omitted -->其他服务器拉取<!-- raw HTML omitted --><code>Harbor</code><!-- raw HTML omitted -->仓库镜像<!-- raw HTML omitted --></h3>
<ul>
<li>
<ol>
<li><code>/etc/hosts</code><!-- raw HTML omitted -->做好解析<!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="2">
<li><code>daemon.json</code><!-- raw HTML omitted -->文件中添加私人仓库参数<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat /etc/docker/daemon.json
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;insecure-registries&#34;</span>:<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;192.168.80.210:8080&#34;</span><span style="color:#f92672">]</span>,</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->拉取私人仓库镜像，前提仓库是公开类型，然后获取拉取命令<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<p><a href="#R-image-e69f4d0968e530cc04afaac90cad4e58" class="lightbox-link"><img alt="拉取私人仓库命令" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Harbor/Snipaste_2022-06-07_21-19-25.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-e69f4d0968e530cc04afaac90cad4e58"><img alt="拉取私人仓库命令" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Harbor/Snipaste_2022-06-07_21-19-25.png"></a></p>
</blockquote>
<hr>
<h3 id="配置k8s使用harbor镜像仓库">配置<code>K8S</code>使用<code>Harbor</code>镜像仓库</h3>
<blockquote>
<ul>
<li><code>docker-harbor</code>：<code>secret</code><!-- raw HTML omitted -->名称自定义<!-- raw HTML omitted --></li>
<li><code>--docker-server</code>：<code>Harbor</code><!-- raw HTML omitted -->仓库地址<!-- raw HTML omitted --></li>
<li><code>--docker-username</code>：<code>Harbor</code><!-- raw HTML omitted -->登录用户名<!-- raw HTML omitted --></li>
<li><code>--docker-password</code>：<code>Harbor</code><!-- raw HTML omitted -->仓库登录密码<!-- raw HTML omitted --></li>
<li><code>--docker-email</code><!-- raw HTML omitted -->：邮箱地址<!-- raw HTML omitted --></li>
<li><code>--namespace</code><!-- raw HTML omitted -->：指定命名空间，不指定默认为：<!-- raw HTML omitted --><code>default</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl create secret docker-registry docker-harbor --docker-server<span style="color:#f92672">=</span>192.168.80.210:8080 --docker-username<span style="color:#f92672">=</span>admin --docker-password<span style="color:#f92672">=</span>Harbor12345 --docker-email<span style="color:#f92672">=</span>xxx@xxx.com --namespace<span style="color:#f92672">=</span>harbor</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->将机密数据转换为可读格式<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl get secret docker-harbor --output<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;jsonpath={.data.\.dockerconfigjson}&#34;</span> | base64 --decode
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 输入以下内容</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span><span style="color:#e6db74">&#34;auths&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;192.168.80.210:8080&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;username&#34;</span>:<span style="color:#e6db74">&#34;admin&#34;</span>,<span style="color:#e6db74">&#34;password&#34;</span>:<span style="color:#e6db74">&#34;Harbor12345&#34;</span>,<span style="color:#e6db74">&#34;email&#34;</span>:<span style="color:#e6db74">&#34;xxx@xxx.com&#34;</span>,<span style="color:#e6db74">&#34;auth&#34;</span>:<span style="color:#e6db74">&#34;YWRtaW46SGFyYm9yMTIzNDU=&#34;</span><span style="color:#f92672">}}}</span></span></span></code></pre></div><ul>
<li>将<code>base64</code><!-- raw HTML omitted -->编码的数据转换为可读格式<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;YWRtaW46SGFyYm9yMTIzNDU=&#34;</span> | base64 --decode
</span></span><span style="display:flex;"><span>admin:Harbor12345  	<span style="color:#75715e"># 输出结果</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->生成<!-- raw HTML omitted --><code>yaml</code><!-- raw HTML omitted -->文件，并在<!-- raw HTML omitted --><code>spec.containers</code><!-- raw HTML omitted -->字段中修改私人镜像参数<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>生成<code>Deployment</code>的<code>yaml</code>文件并应用</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl create deployment java-demo --image<span style="color:#f92672">=</span>192.168.80.210:8080/test/tomcat-demo:v1 --dry-run<span style="color:#f92672">=</span>client -o yaml &gt;/tmp/deploy.yaml</span></span></code></pre></div><ul>
<li><code>192.168.80.210:8080</code><!-- raw HTML omitted -->：指定使用私人仓库地址，域名或者IP地址加端口号<!-- raw HTML omitted --></li>
<li><code>test</code><!-- raw HTML omitted -->：私人仓库库房名称<!-- raw HTML omitted --></li>
<li><code>tomcat-demo</code><!-- raw HTML omitted -->：使用私人仓库的镜像<!-- raw HTML omitted --></li>
<li><code>v1</code><!-- raw HTML omitted -->：必须指定要使用私人仓库镜像的版本号<!-- raw HTML omitted --></li>
<li><code>name: tomcat-demo</code><!-- raw HTML omitted -->：指定使用的镜像名字<!-- raw HTML omitted --></li>
<li><code>imagePullSecrets:</code><!-- raw HTML omitted -->：指定使用其他镜像地址<!-- raw HTML omitted --></li>
<li><code>- name: docker-harbor</code><!-- raw HTML omitted -->：指定定义的私人仓库名字<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">java-demo</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">name</span>: <span style="color:#ae81ff">java-demo</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">app</span>: <span style="color:#ae81ff">java-demo</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">app</span>: <span style="color:#ae81ff">java-demo</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>                - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">192.168.80.210</span>:<span style="color:#ae81ff">8080</span><span style="color:#ae81ff">/test/tomcat-demo:v1 </span> <span style="color:#75715e"># 需修改处</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">tomcat-demo  	# 默认生成</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">imagePullSecrets</span>:  	<span style="color:#75715e"># 手动添加字段</span>
</span></span><span style="display:flex;"><span>                - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">docker-harbor  	# 指定使用的secret库房名称</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->创建<!-- raw HTML omitted --><code>Service</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>yaml</code><!-- raw HTML omitted -->文件，应用并访问<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl expose deployment java-demo --port<span style="color:#f92672">=</span><span style="color:#ae81ff">80</span> --target-port<span style="color:#f92672">=</span><span style="color:#ae81ff">8080</span> --type<span style="color:#f92672">=</span>NodePort --dry-run<span style="color:#f92672">=</span>client -o yaml &gt;/opt/yaml/java-demo-svc.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;&gt;/opt/yaml/java-demo-svc.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Service
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  app: java-demo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name: java-demo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ports:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - port: 8080  	# Service 集群端口
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          protocol: TCP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          targetPort: 8080  	# Pod 本身服务端口，比如Nginx：80，Tomcat：8080
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          nodePort: 30001  	# 外网访问端口
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        selector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            app: java-demo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        type: NodePort
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl create -f java-demo-svc.yaml
</span></span><span style="display:flex;"><span>$ kubectl get service
</span></span><span style="display:flex;"><span>$ http://192.168.80.210:30001/  	<span style="color:#75715e"># 浏览器访问地址</span></span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_k8s_dashboard">Install_K8s_Dashboard</h1>

<h2 id="部署dashboard端口映射可以用于web访问">部署<code>Dashboard</code>(端口映射，可以用于<code>web</code>访问)</h2>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/kubernetes/dashboard" rel="external" target="_self"><code>Kubernetes Dashboard</code></a></td>
<td>官方可视化界面</td>
</tr>
<tr>
<td><a href="https://kubesphere.io/zh/" rel="external" target="_self"><code>KubeSphere</code></a></td>
<td>青云</td>
</tr>
<tr>
<td><a href="https://www.rancher.com/" rel="external" target="_self"><code>Rancher</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://kuboard.cn/" rel="external" target="_self"><code>Kuboard</code></a></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li><code>kubernetes</code>官方开发了一个基于<code>web</code>的用户界面<code>DashBoard</code>。用户可以使用<code>DashBoard</code>部署容器化的应用，而且还可以监控应用的状态，执行故障排查以及管理<code>kubernetes</code>中的各种资源。</li>
</ul>
</blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->下载用于部署<!-- raw HTML omitted --><code>DashBoard</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>yaml</code><!-- raw HTML omitted -->文件修改并运行<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>下载部署文件</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /opt/kubernetes/cfg/
</span></span><span style="display:flex;"><span>$ wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>recommended.yaml</code><!-- raw HTML omitted -->文件的<!-- raw HTML omitted --><code>Service</code><!-- raw HTML omitted -->类型<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">kubernetes-dashboard</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubernetes-dashboard</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kubernetes-dashboard</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span> - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">443</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">8443</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">nodePort</span>: <span style="color:#ae81ff">30001</span>       <span style="color:#75715e"># 此处新增</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">type</span>: <span style="color:#ae81ff">NodePort      		# 此处新增</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">kubernetes-dashboard</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->部署<!-- raw HTML omitted --><code>DashBoard</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl create -f recommended.yaml</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->查看<!-- raw HTML omitted --><code>namespace</code><!-- raw HTML omitted -->下名为<!-- raw HTML omitted --><code>kubernetes-dashboard</code><!-- raw HTML omitted -->下的资源<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl get pods,svc -n kubernetes-dashboard
</span></span><span style="display:flex;"><span>NAME                                             READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pod/dashboard-metrics-scraper-694557449d-mvnc8   1/1     Running   <span style="color:#ae81ff">0</span>          21s
</span></span><span style="display:flex;"><span>pod/kubernetes-dashboard-9774cc786-fm748         1/1     Running   <span style="color:#ae81ff">0</span>          21s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                                TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>         AGE
</span></span><span style="display:flex;"><span>service/dashboard-metrics-scraper   ClusterIP   10.0.0.248   &lt;none&gt;        8000/TCP        21s
</span></span><span style="display:flex;"><span>service/kubernetes-dashboard        NodePort    10.0.0.15    &lt;none&gt;        443:30001/TCP   22s</span></span></code></pre></div><ul>
<li><code>dashboard-admin.yaml</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">name</span>: <span style="color:#ae81ff">dashboard-admin</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kubernetes-dashboard</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubernetes-dashboard</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRoleBinding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">name</span>: <span style="color:#ae81ff">dashboard-admin</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">name</span>: <span style="color:#ae81ff">cluster-admin</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">name</span>: <span style="color:#ae81ff">dashboard-admin</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kubernetes-dashboard</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->创建<!-- raw HTML omitted --><code>service account</code><!-- raw HTML omitted -->并绑定默认<!-- raw HTML omitted --><code>cluster-admin</code><!-- raw HTML omitted -->管理员集群角色：<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl create serviceaccount dashboard-admin -n kubernetes-dashboard</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->授权：<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl create clusterrolebinding dashboard-admin <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--clusterrole<span style="color:#f92672">=</span>cluster-admin <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--serviceaccount<span style="color:#f92672">=</span>kubernetes-dashboard:dashboard-admin</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->获取账号<!-- raw HTML omitted --><code>token</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 第一种方式</span>
</span></span><span style="display:flex;"><span>$ kubectl describe secrets -n kubernetes-dashboard <span style="color:#66d9ef">$(</span>kubectl -n kubernetes-dashboard get secret | awk <span style="color:#e6db74">&#39;/dashboard-admin/{print $1}&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 第二种方式</span>
</span></span><span style="display:flex;"><span>$ kubectl get secrets -n kubernetes-dashboard | grep dashboard-admin
</span></span><span style="display:flex;"><span>$ kubectl describe secrets dashboard-admin-token-b992l -n kubernetes-dashboard</span></span></code></pre></div></blockquote>
<hr>
<h2 id="通过浏览器访问dashboard的ui">通过浏览器访问<code>DashBoard</code>的<code>UI</code></h2>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->打开浏览器访问：<!-- raw HTML omitted --><code>https://NodeIP:30001</code></li>
<li><!-- raw HTML omitted -->打开谷歌浏览器提示：<!-- raw HTML omitted --><code>NET::ERR_CERT_INVALID</code></li>
<li><!-- raw HTML omitted -->在<!-- raw HTML omitted --><code>chrome</code><!-- raw HTML omitted -->该页面上，直接键盘敲入这12个字符：<!-- raw HTML omitted --><code>thisisunsafe</code></li>
<li><!-- raw HTML omitted --><strong>注意：</strong><!-- raw HTML omitted -->鼠标点击当前页面任意位置，让页面处于最上层即可输入</li>
<li><!-- raw HTML omitted -->复制创建<!-- raw HTML omitted --><code>cluster-admin</code><!-- raw HTML omitted -->生成的<!-- raw HTML omitted --><code>token</code><!-- raw HTML omitted -->到浏览器登录<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_k8s_coredns">Install_K8s_CoreDNS</h1>

<h2 id="安装coredns">安装<code>CoreDNS</code></h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->去官网下载<!-- raw HTML omitted --><a href="https://github.com/coredns/deployment/tree/master/kubernetes" rel="external" target="_self"><code>CoreDNS</code></a><code>deploy.sh</code><!-- raw HTML omitted -->和<!-- raw HTML omitted --><code>coredns.yam.sed</code><!-- raw HTML omitted -->两个文件<!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="2">
<li><a href="https://kaerser.github.io/2019/03/11/coredns%E9%85%8D%E7%BD%AE/" rel="external" target="_self"><code>CoreDNS</code>配置</a></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget https://github.com/coredns/deployment/blob/08c2b11241ef67b5d22d2020c00001ce0baec566/kubernetes/deploy.sh
</span></span><span style="display:flex;"><span>$ wget https://github.com/coredns/deployment/blob/08c2b11241ef67b5d22d2020c00001ce0baec566/kubernetes/coredns.yaml.sed
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看帮助</span>
</span></span><span style="display:flex;"><span>$ ./deploy.sh -h</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><code>REVERSE_CIDRS=&quot;10.254.0.0/16&quot;</code><!-- raw HTML omitted -->：配置<!-- raw HTML omitted --><code>kubernetes svc</code><!-- raw HTML omitted -->网段<!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="4">
<li><code>CLUSTER_DNS_IP=&quot;10.254.0.2&quot;</code><!-- raw HTML omitted -->：配置<!-- raw HTML omitted --><code>kubernetes DNS IP</code></li>
</ol>
</li>
<li>
<ol start="5">
<li><code>CLUSTER_DOMAIN=&quot;cluster.local&quot;</code><!-- raw HTML omitted -->：配置<!-- raw HTML omitted --><code>kubernetes</code><!-- raw HTML omitted -->的域名<!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="6">
<li><!-- raw HTML omitted -->-r<!-- raw HTML omitted -->：<code>kubernetes svc</code>网段、<!-- raw HTML omitted -->-i<!-- raw HTML omitted -->：<code>kubernetes DNS IP</code>、<!-- raw HTML omitted -->-d<!-- raw HTML omitted -->：<code>kubernetes</code>的域名</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$  ./deploy.sh -s -r 10.254.0.0/16 -i 10.254.0.10 -d cluster.local &gt; coredns.yaml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改前后对比</span>
</span></span><span style="display:flex;"><span>$ diff coredns.yaml coredns.yaml.sed
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动Coredns</span>
</span></span><span style="display:flex;"><span>$ kubectl apply -f coredns.yaml</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_k8s_argo_cd">Install_K8s_Argo_CD</h1>

<h2 id="argo-cd介绍"><code>Argo CD</code>介绍</h2>
<blockquote>
<ul>
<li><code>Argo CD</code>是一个为<code>Kubernetes</code>而生的，遵循声明式<code>GitOps</code>理念的持续部署<code>CD</code>工具。<code>Argo CD</code>可在<code>Git</code>存储库更改时自动同步和部署应用程序</li>
<li>应用定义、配置和环境信息是声明式的，并可以进行版本控制</li>
<li>应用部署和生命周期管理是全自动化的、是可审计的，清晰易懂</li>
</ul>
</blockquote>
<hr>
<h2 id="安装argo-cd">安装<code>Argo CD</code></h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->创建<!-- raw HTML omitted --><code>ArgoCD</code><!-- raw HTML omitted -->命名空间<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl create namespace argocd</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->下载并启动<!-- raw HTML omitted --><code>ArgoCD</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml  </span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>NodePort</code><!-- raw HTML omitted -->方式暴露<!-- raw HTML omitted --><code>argocd ui</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl patch service -n argocd argocd-server -p <span style="color:#e6db74">&#39;{&#34;spec&#34;: {&#34;type&#34;: &#34;NodePort&#34;}}&#39;</span>  </span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->获取<!-- raw HTML omitted --><code>ArgoCD</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>admin</code><!-- raw HTML omitted -->登陆密码<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{.data.password}&#34;</span> | base64 -d</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>cli：CLI</code><!-- raw HTML omitted -->是用于管理<!-- raw HTML omitted --><code>Argo CD</code><!-- raw HTML omitted -->的命令行工具<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ curl -sSL -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/download/v2.3.3/argocd-linux-amd64 <span style="color:#f92672">&amp;&amp;</span> chmod +x /usr/local/bin/argocd</span></span></code></pre></div></blockquote>
<ol start="6">
<li><!-- raw HTML omitted -->查看<!-- raw HTML omitted --><code>argocd-server</code><!-- raw HTML omitted -->暴露端口<!-- raw HTML omitted --></li>
</ol>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl get svc -n argocd</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="configure_k8s_storage">Configure_K8s_Storage</h1>

<h1 id="kubernetes数据存储"><code>Kubernetes</code>数据存储</h1>
<ul>
<li>
<ol>
<li>都知道容器的生命周期可能很短，会被频繁的创建和销毁。那么容器在销毁的时候，保存在容器中的数据也会被清除。这种结果对用户来说，在某些情况下是不乐意看到的。为了持久化保存容器中的数据，<code>kubernetes</code>引入了<code>Volume</code>的概念</li>
</ol>
</li>
<li>
<ol start="2">
<li><code>Volume</code>是<code>Pod</code>中能够被多个容器访问的共享目录，它被定义在<code>Pod</code>上，然后被一个<code>Pod</code>里面的多个容器挂载到具体的文件目录下，<code>kubernetes</code>通过<code>Volume</code>实现同一个<code>Pod</code>中不同容器之间的数据共享以及数据的持久化存储。<code>Volume</code>的生命周期不和<code>Pod</code>中的单个容器的生命周期有关，当容器终止或者重启的时候，<code>Volume</code>中的数据也不会丢失</li>
</ol>
</li>
<li>
<ol start="3">
<li><code>kubernetes</code>的<code>Volume</code>支持多种类型，比较常见的有下面的几个：</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->简单存储<!-- raw HTML omitted -->：<code>EmptyDir</code>、<code>HostPath</code>、<code>NFS</code></li>
<li><!-- raw HTML omitted -->高级存储<!-- raw HTML omitted -->：<code>PV</code>、<code>PVC</code></li>
<li><!-- raw HTML omitted -->配置存储<!-- raw HTML omitted -->：<code>ConfigMap</code>、<code>Secret</code></li>
</ul>
</blockquote>
<hr>
<h2 id="简单存储">简单存储</h2>
<h3 id="emptydir"><code>EmptyDir</code></h3>
<ul>
<li>
<ol>
<li><code>EmptyDir</code>是最基础的<code>Volume</code>类型，一个<code>EmptyDir</code>就是<code>Host</code>上的一个空目录</li>
</ol>
</li>
<li>
<ol start="2">
<li><code>EmptyDir</code>是在<code>Pod</code>被分配到<code>Node</code>时创建的，它的初始内容为空，并且无须指定宿主机上对应的目录文件，因为<code>kubernetes</code>会自动分配一个目录，当<code>Pod</code>销毁时，<code>EmptyDir</code>中的数据也会被永久删除。</li>
</ol>
</li>
<li>
<ol start="3">
<li><code>EmptyDir</code>的用途如下</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->临时空间<!-- raw HTML omitted -->例如用于某些应用程序运行时所需的临时目录，且无须永久保留</li>
<li><!-- raw HTML omitted -->多容器共享目录<!-- raw HTML omitted -->一个容器需要从另一个容器中获取数据的目录</li>
</ul>
</blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->接下来，通过一个容器之间的共享案例来使用描述一个<!-- raw HTML omitted --><code>EmptyDir</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->在一个<code>Pod</code>中准备两个容器<!-- raw HTML omitted --><code>nginx</code>和<code>busybox</code>然后声明一个<code>volume</code>分别挂载到两个容器的目录中，然后<code>nginx</code>容器负责向<code>volume</code>中写日志，<code>busybox</code>中通过命令将日志内容读到控制台</li>
<li><a href="https://raw.githubusercontent.com/usermice/imgs/master/Kubernetes_Server/Template/Storage/kubernetes-emptydir-template.yaml" rel="external" target="_self"><code>Kubernetes Emptydir Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod  </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">emptydir-volume-template       </span> <span style="color:#75715e"># 定义名称</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:   <span style="color:#75715e"># 必选，Pod中容器的详细定义</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:   <span style="color:#75715e"># 必选，Pod中容器列表</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;bash&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;for i in {1..100};do echo $i &gt;&gt;/tmp/hello.txt;sleep 1;done&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:       <span style="color:#75715e"># 将logs-volume挂载到nginx容器中的目录路径</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/tmp</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">readOnly</span>: <span style="color:#66d9ef">false</span>   <span style="color:#75715e"># 是否只读，默认false</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;bash&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;tail -f /tmp/hello.txt&#34;</span>]     <span style="color:#75715e"># 初始命令，动态读取指定文件</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:       <span style="color:#75715e"># 将logs-volume挂载到busybox容器中的目录路径</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/tmp</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:      <span style="color:#75715e"># 声明volume，name为logs-volume，类型为emptyDir</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume  </span> <span style="color:#75715e"># 共享存储卷名称 （volumes类型有很多种）</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">emptyDir</span>: {<span style="color:#f92672">}        # 类型为emtyDir的存储卷，与Pod同生命周期的一个临时目录。为空值，使用 emptyDir</span>: {} <span style="color:#ae81ff">表使用默认值</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e"># medium: string   # 存储介质，支持Memory和空字符串(默认)</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e"># sizeLimit: string        # 大小限制，默认不限制。一般在使用Memory时会限制</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="hostpath"><code>HostPath</code></h3>
<ul>
<li>
<ol>
<li>已经知道<code>EmptyDir</code>中的数据不会被持久化，它会随着<code>Pod</code>的结束而销毁，如果想要简单的将数据持久化到主机中，可以选择<!-- raw HTML omitted --><code>HostPath</code><!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="2">
<li><code>HostPath</code>就是将<code>Node</code>主机中的一个实际目录挂载到<code>Pod</code>中，以供容器使用，这样的设计就可以保证<code>Pod</code>销毁了，但是数据依旧可以保存在<code>Node</code>主机上</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl explain Pod.spec.volumes.hostPath.type  	<span style="color:#75715e"># 类型声明</span></span></span></code></pre></div><ul>
<li><code>Directory</code><!-- raw HTML omitted -->：目录，必须存在<!-- raw HTML omitted --></li>
<li><code>DirectoryOrCreate</code><!-- raw HTML omitted -->：目录存在就使用，不存在就先创建后使用<!-- raw HTML omitted --></li>
<li><code>File</code><!-- raw HTML omitted -->：文件，必须存在<!-- raw HTML omitted --></li>
<li><code>FileOrCreate</code><!-- raw HTML omitted -->：文件存在就使用，不存在就先创建后使用<!-- raw HTML omitted --></li>
<li><code>Socket</code><!-- raw HTML omitted -->：<code>unix</code>套接字，必须存在<!-- raw HTML omitted --></li>
<li><code>CharDevice</code><!-- raw HTML omitted -->：字符设备，必须存在<!-- raw HTML omitted --></li>
<li><code>BlockDevice</code><!-- raw HTML omitted -->：块设备，必须存在<!-- raw HTML omitted --></li>
<li><a href="https://raw.githubusercontent.com/usermice/imgs/master/Kubernetes_Server/Template/Storage/kubernetes-hostpath-template.yaml" rel="external" target="_self"><code>Kubernetes HostPath Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">hostpath-volume-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:       <span style="color:#75715e"># 将logs-volume挂载到nginx容器中的目录目录路径</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/log/nginx</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;tail -f /logs/access.log&#34;</span>]        <span style="color:#75715e"># 初始命令，动态读取指定文件</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:       <span style="color:#75715e"># 将logs-volume挂载到busybox容器中的目录目录路径</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/logs</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:      <span style="color:#75715e"># 声明volume，name为logs-volume，类型为hostPath</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hostPath</span>:   <span style="color:#75715e"># 类型为hostPath的存储卷，表示挂载Pod所在宿主机的目录</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/opt/logs  </span> <span style="color:#75715e"># Pod所在宿主机的目录，将被用于同期中mount的目录</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">type</span>: <span style="color:#ae81ff">DirectoryOrCreate  </span> <span style="color:#75715e"># 目录存在就使用，不存在就先创建再使用</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="nfs"><code>NFS</code></h3>
<blockquote>
<ul>
<li><code>HostPath</code>虽然可以解决数据持久化的问题，但是一旦<code>Node</code>节点故障了，<code>Pod</code>如果转移到别的<code>Node</code>节点上，又会出现问题，此时需要准备单独的网络存储系统，比较常用的是<code>NFS</code>和<code>CIFS</code></li>
<li><code>NFS</code>是一个网络文件存储系统，可以搭建一台<code>NFS</code>服务器，然后将<code>Pod</code>中的存储直接连接到<code>NFS</code>系统上，这样，无论<code>Pod</code>在节点上怎么转移，只要<code>Node</code>和<code>NFS</code>的对接没有问题，数据就可以成功访问</li>
</ul>
</blockquote>
<hr>
<h4 id="font-colorred编辑fontnfs-volumeyamlfont-colorred文件挂载fontnfs"><!-- raw HTML omitted -->编辑<!-- raw HTML omitted --><code>nfs-volume.yaml</code><!-- raw HTML omitted -->文件挂载<!-- raw HTML omitted --><code>NFS</code></h4>
<blockquote>
<ul>
<li><a href="https://raw.githubusercontent.com/usermice/imgs/master/Kubernetes_Server/Template/Storage/kubernetes-nfs-template.yaml" rel="external" target="_self"><code>Kubernetes NFS Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-volume-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:       <span style="color:#75715e"># 将logs-volume挂载到nginx容器中的目录路径</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/log/nginx</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;tail -f /logs/access.log&#34;</span>]        <span style="color:#75715e"># 初始命令，动态读取指定文件</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:       <span style="color:#75715e"># 将logs-volume挂载到busybox容器中的目录路径</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/logs</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:      <span style="color:#75715e"># 声明volume</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nfs</span>:        <span style="color:#75715e"># 存储类型，和底层正则的存储对应</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">server</span>: <span style="color:#ae81ff">192.168.18.100</span>    <span style="color:#75715e"># NFS服务器地址</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/opt/data/nfs     </span> <span style="color:#75715e"># 共享文件路径</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">readOnly</span>: <span style="color:#66d9ef">false</span>   <span style="color:#75715e"># 是否只读，默认false</span></span></span></code></pre></div></blockquote>
<hr>
<h2 id="高级存储">高级存储</h2>
<h3 id="pv持久卷"><code>PV</code>持久卷</h3>
<ul>
<li>
<ol>
<li><code>PV(Persistent Volume)</code><!-- raw HTML omitted -->是持久化卷的意思，是对底层的共享存储的一种抽象。一般情况下<code>PV</code>由<code>kubernetes</code>管理员进行创建和配置，它和底层具体的共享存储技术有关，并通过插件完成和共享存储的对接<!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="2">
<li><code>pv</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><!-- raw HTML omitted -->关键配置<!-- raw HTML omitted --><!-- raw HTML omitted -->参数说明<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->存储类型：<!-- raw HTML omitted -->底层实际存储的类型，<code>kubernetes</code>支持多种存储类型，每种存储类型的配置有所不同</li>
<li>
<ol start="2">
<li><code>capacity</code><!-- raw HTML omitted -->(存储能力)：<!-- raw HTML omitted -->目前只支持存储空间的设置<code>storage=1Gi</code>，不过未来可能会加入<code>IOPS</code>、吞吐量等指标的配置</li>
</ol>
</li>
<li>
<ol start="3">
<li><code>accessModes</code><!-- raw HTML omitted -->(访问模式)：<!-- raw HTML omitted -->用来描述用户应用对存储资源的访问权限，访问权限包括下面几种方式</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>
<p><!-- raw HTML omitted -->需要注意的是：底层不同的存储类型可能支持的访问模式不同<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>ReadWriteOnce(RWO)</code><!-- raw HTML omitted -->：读写权限，<!-- raw HTML omitted -->但是只能被单个节点挂载</p>
</li>
<li>
<p><code>ReadOnlyMany(ROX)</code><!-- raw HTML omitted -->：只读权限，<!-- raw HTML omitted -->可以被多个节点挂载</p>
</li>
<li>
<p><code>ReadWriteMany(RWX)</code><!-- raw HTML omitted -->：读写权限，<!-- raw HTML omitted -->可以被多个节点挂载</p>
</li>
</ul>
</blockquote>
<ul>
<li>
<ol start="4">
<li><code>persistentVolumeReclaimPolicy</code><!-- raw HTML omitted -->(回收策略)：<!-- raw HTML omitted -->当<code>PV</code>不再被使用之后，对其的处理方式，目前支持三种策略</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>
<p><!-- raw HTML omitted -->需要注意的是：底层不同的存储类型可能支持的回收策略不同<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>Retain</code><!-- raw HTML omitted -->(保留)：<!-- raw HTML omitted -->保留数据，需要管理员手动清理数据</p>
</li>
<li>
<p><code>Recycle</code><!-- raw HTML omitted -->(回收)：<!-- raw HTML omitted -->清除<code>PV</code>中的数据，效果相当于<code>rm -rf /volume/*</code></p>
</li>
<li>
<p><code>Delete</code><!-- raw HTML omitted -->(删除)：<!-- raw HTML omitted -->和<code>PV</code>相连的后端存储完成<code>volume</code>的删除操作，常见于云服务器厂商的存储服务</p>
</li>
</ul>
</blockquote>
<ul>
<li>
<ol start="5">
<li><code>storageClassName</code><!-- raw HTML omitted -->(存储类别)：<!-- raw HTML omitted --><code>PV</code>可以通过<code>storageClassName</code>参数指定一个存储类别</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>具有特定类型的<code>PV</code>只能和请求了该类别的<code>PVC</code>进行绑定</li>
<li>未设定类别的<code>PV</code>只能和不请求任何类别的<code>PVC</code>进行绑定</li>
</ul>
</blockquote>
<ul>
<li>
<ol start="6">
<li><code>status</code><!-- raw HTML omitted -->(状态)：<!-- raw HTML omitted -->一个<code>PV</code>的生命周期，可能会处于4种不同的阶段</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>Available</code><!-- raw HTML omitted -->(可用)：<!-- raw HTML omitted -->表示可用状态，还未被任何<code>PVC</code>绑定</li>
<li><code>Bound</code><!-- raw HTML omitted -->(已绑定)：<!-- raw HTML omitted -->表示<code>PV</code>已经被<code>PVC</code>绑定</li>
<li><code>Released</code><!-- raw HTML omitted -->(已释放)：<!-- raw HTML omitted -->表示<code>PVC</code>被删除，但是资源还没有被集群重新释放</li>
<li><code>Failed</code><!-- raw HTML omitted -->(失败)：<!-- raw HTML omitted -->表示该<code>PV</code>的自动回收失败</li>
</ul>
</blockquote>
<ul>
<li><code>PV</code>：<code>kubernetes</code><!-- raw HTML omitted -->管理员维护<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<h4 id="构建font-colorred静态fontpv存储卷">构建<!-- raw HTML omitted -->静态<!-- raw HTML omitted --><code>PV</code>存储卷</h4>
<blockquote>
<ul>
<li><a href="https://raw.githubusercontent.com/usermice/imgs/master/Kubernetes_Server/Template/Storage/kubernetes-pv-template.yaml" rel="external" target="_self"><code>Kubernetes PV Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e">##########   定义Redis的静态 PV持久卷   ##########</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolume</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis-pv-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis-pv-template</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">capacity</span>:     <span style="color:#75715e"># 存储能力，目前只支持存储空间的设置</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">10Gi      </span> <span style="color:#75715e"># 限制容量为 10G</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumeMode</span>: <span style="color:#ae81ff">Filesystem   </span> <span style="color:#75715e"># 存储类型为文件系统</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">accessModes</span>:          <span style="color:#75715e"># 访问模式</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ReadWriteMany      </span> <span style="color:#75715e"># Read：读、Write：写、Once：单节点、Many：代表多节点，Only：只读只写</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">persistentVolumeReclaimPolicy</span>: <span style="color:#ae81ff">Retain  </span> <span style="color:#75715e"># 回收策略：Retain：保留、Recycle：回收、Delete：删除</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">storageClassName</span>: <span style="color:#ae81ff">nfs        </span> <span style="color:#75715e"># 创建 PV 的存储类的自定义名字，PVC需要于此相同，存储类型，分别为： NFS、CephFS、iSCSI</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">mountOptions</span>:         <span style="color:#75715e"># 加载配置</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">hard</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">nfsvers=4.1        </span> <span style="color:#75715e"># NFS 版本</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nfs</span>:          <span style="color:#75715e"># 存储类型，和storageClassName的存储类别对应</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/opt/data/redis      </span> <span style="color:#75715e"># nfs 授权目录</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span>: <span style="color:#ae81ff">192.168.186.110</span>     <span style="color:#75715e"># nfs 所在服务器PV持久卷</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>--- <span style="color:#75715e"># 分隔符可以定义多个</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##########   定义Nginx的静态 PV持久卷   ##########</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolume</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-pv-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-pv-template</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">capacity</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">10Gi</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumeMode</span>: <span style="color:#ae81ff">Filesystem</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">accessModes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ReadWriteMany</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">persistentVolumeReclaimPolicy</span>: <span style="color:#ae81ff">Retain</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">storageClassName</span>: <span style="color:#ae81ff">nfs</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">mountOptions</span>:         <span style="color:#75715e"># 加载配置</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">hard</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">nfsvers=4.1        </span> <span style="color:#75715e"># NFS 版本</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nfs</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/opt/data/nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span>: <span style="color:#ae81ff">192.168.186.110</span></span></span></code></pre></div></blockquote>
<hr>
<h4 id="构建font-colorred动态fontpv存储卷">构建<!-- raw HTML omitted -->动态<!-- raw HTML omitted --><code>PV</code>存储卷</h4>
<ul>
<li>
<ol>
<li><a href="https://kubernetes.io/zh-cn/docs/concepts/storage/storage-classes/" rel="external" target="_self"><code>StorageClass</code>动态资源存储</a></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><a href="https://raw.githubusercontent.com/usermice/imgs/master/Kubernetes_Server/Template/Storage/kubernetes-storageclass-template.yaml" rel="external" target="_self"><code>Kubernetes StorageClass Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">storage.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">StorageClass   </span> <span style="color:#75715e"># 创建动态存储类</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-storage-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">storageclass.kubernetes.io/is-default-class</span>: <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">provisioner</span>: <span style="color:#ae81ff">fuseim.pri/ifs    </span> <span style="color:#75715e"># 外部制备器提供者，编写为提供者的名称，k8s-sigs.io/nfs-subdir-external-provisioner</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">allowVolumeExpansion</span>: <span style="color:#66d9ef">true</span>      <span style="color:#75715e"># 动态调整持久卷大小</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">parameters</span>:     <span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">archiveOnDelete</span>: <span style="color:#e6db74">&#34;true&#34;</span>       <span style="color:#75715e"># 是否存档，false：表示不存档，会删除oldPath下面的数据，true：表示存档，会重命名路径</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">reclaimPolicy</span>: <span style="color:#ae81ff">Retain  </span> <span style="color:#75715e"># 回收策略，默认为：Delete，</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">volumeBindingMode</span>: <span style="color:#ae81ff">Immediate   </span> <span style="color:#75715e"># 默认为：Immediate，表示创建 PVC立即进行绑定，只有：azuredisk和：AWSelasticblockstore 支持其他值</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->创建权限，<!-- raw HTML omitted --><a href="https://raw.githubusercontent.com/usermice/imgs/master/Kubernetes_Server/Template/Permissions/kubernetes-permissions-template.yaml" rel="external" target="_self"><code>Kubernetes Permissions Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount   </span> <span style="color:#75715e"># 权限管理</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole  </span> <span style="color:#75715e"># 创建集群角色</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-client-provisioner-runner</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">apiGroups</span>: [<span style="color:#e6db74">&#34;&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;nodes&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;get&#34;</span>, <span style="color:#e6db74">&#34;list&#34;</span>, <span style="color:#e6db74">&#34;watch&#34;</span>]
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">apiGroups</span>: [<span style="color:#e6db74">&#34;&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;persistentvolumes&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;get&#34;</span>, <span style="color:#e6db74">&#34;list&#34;</span>, <span style="color:#e6db74">&#34;watch&#34;</span>, <span style="color:#e6db74">&#34;create&#34;</span>, <span style="color:#e6db74">&#34;delete&#34;</span>]
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">apiGroups</span>: [<span style="color:#e6db74">&#34;&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;persistentvolumeclaims&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;get&#34;</span>, <span style="color:#e6db74">&#34;list&#34;</span>, <span style="color:#e6db74">&#34;watch&#34;</span>, <span style="color:#e6db74">&#34;update&#34;</span>]
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">apiGroups</span>: [<span style="color:#e6db74">&#34;storage.k8s.io&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;storageclasses&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;get&#34;</span>, <span style="color:#e6db74">&#34;list&#34;</span>, <span style="color:#e6db74">&#34;watch&#34;</span>]
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">apiGroups</span>: [<span style="color:#e6db74">&#34;&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;events&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;create&#34;</span>, <span style="color:#e6db74">&#34;update&#34;</span>, <span style="color:#e6db74">&#34;patch&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRoleBinding   </span> <span style="color:#75715e"># 绑定集群角色</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">run-nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-client-provisioner-runner</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Role   </span> <span style="color:#75715e"># 创建普通角色</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">leader-locking-nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">apiGroups</span>: [<span style="color:#e6db74">&#34;&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;endpoints&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;get&#34;</span>, <span style="color:#e6db74">&#34;list&#34;</span>, <span style="color:#e6db74">&#34;watch&#34;</span>, <span style="color:#e6db74">&#34;create&#34;</span>, <span style="color:#e6db74">&#34;update&#34;</span>, <span style="color:#e6db74">&#34;patch&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">RoleBinding  </span> <span style="color:#75715e"># 绑定普通角色</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">leader-locking-nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Role</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">leader-locking-nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->创建适用与<!-- raw HTML omitted --><code>provisioner</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>Deployment</code><a href="https://raw.githubusercontent.com/usermice/imgs/master/Kubernetes_Server/Template/Storage/kubernetes-deployment-provisioner-nfs-template.yaml" rel="external" target="_self"><code>Kubernetes Deployment Provisioner NFS Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>apiVersion: apps/v1
</span></span><span style="display:flex;"><span>kind: Deployment
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: nfs-client-provisioner
</span></span><span style="display:flex;"><span>  namespace: default
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    app: nfs-client-provisioner
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  replicas: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>  strategy:
</span></span><span style="display:flex;"><span>    type: Recreate      <span style="color:#75715e"># Recreate:不滚动更新，</span>
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    matchLabels:
</span></span><span style="display:flex;"><span>      app: nfs-client-provisioner
</span></span><span style="display:flex;"><span>  template:
</span></span><span style="display:flex;"><span>    metadata:
</span></span><span style="display:flex;"><span>      labels:
</span></span><span style="display:flex;"><span>        app: nfs-client-provisioner
</span></span><span style="display:flex;"><span>    spec:
</span></span><span style="display:flex;"><span>      hostNetwork: true
</span></span><span style="display:flex;"><span>      serviceAccountName: nfs-client-provisioner        <span style="color:#75715e"># 关联：nfs-client-provisioner 账号授与账户权限</span>
</span></span><span style="display:flex;"><span>      containers:
</span></span><span style="display:flex;"><span>      - name: nfs-client-provisioner
</span></span><span style="display:flex;"><span>        image: registry.cn-beijing.aliyuncs.com/pylixm/nfs-subdir-external-provisioner:v4.0.0
</span></span><span style="display:flex;"><span>        resources:
</span></span><span style="display:flex;"><span>          limits:
</span></span><span style="display:flex;"><span>            cpu: 200m
</span></span><span style="display:flex;"><span>            memory: 128Mi
</span></span><span style="display:flex;"><span>          requests:
</span></span><span style="display:flex;"><span>            cpu: 50m
</span></span><span style="display:flex;"><span>            memory: 64Mi
</span></span><span style="display:flex;"><span>        volumeMounts:
</span></span><span style="display:flex;"><span>        - name: nfs-client-root
</span></span><span style="display:flex;"><span>          mountPath: /persistentvolumes
</span></span><span style="display:flex;"><span>        env:
</span></span><span style="display:flex;"><span>        - name: PROVISIONER_NAME
</span></span><span style="display:flex;"><span>          value: fuseim.pri/ifs   <span style="color:#75715e"># 必须和StorageClass的外部制备器提供者名字相同</span>
</span></span><span style="display:flex;"><span>        - name: NFS_SERVER
</span></span><span style="display:flex;"><span>          value: 192.168.186.110        <span style="color:#75715e"># 指定自己nfs服务器地址</span>
</span></span><span style="display:flex;"><span>        - name: NFS_PATH  
</span></span><span style="display:flex;"><span>          value: /opt/data/redis        <span style="color:#75715e"># nfs服务器共享的目录</span>
</span></span><span style="display:flex;"><span>      volumes:
</span></span><span style="display:flex;"><span>      - name: nfs-client-root
</span></span><span style="display:flex;"><span>        nfs:
</span></span><span style="display:flex;"><span>          server: 192.168.186.110
</span></span><span style="display:flex;"><span>          path: /opt/data/redis</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->创建<!-- raw HTML omitted --><code>Service</code>、<code>StatefulSet</code>、<code>PVC</code><!-- raw HTML omitted -->申请动态存储卷<!-- raw HTML omitted --><a href="https://raw.githubusercontent.com/usermice/imgs/master/Kubernetes_Server/Template/Storage/kubernetes-svc-statefulset-storage-nfs-template.yaml" rel="external" target="_self"><code>Kubernetes Service StatefulSet NFS Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">name</span>: <span style="color:#ae81ff">service-template</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">statefulset-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">NodePort</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>    <span style="color:#75715e"># Service的端口</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">80</span>      <span style="color:#75715e"># StatefulSet 的Pod端口</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">StatefulSet</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">statefulset-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">service-template  </span> <span style="color:#75715e"># 使用那个Service管理DNS</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">updateStrategy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate        </span> <span style="color:#75715e"># 滚动更新，OnDelete：删除更新</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>:      <span style="color:#75715e"># 如果更新的策略是OnDelete，那么rollingUpdate就失效</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">partition</span>: <span style="color:#ae81ff">2</span>      <span style="color:#75715e"># 表示从第2个分区开始更新，默认是0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">statefulset-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">statefulset-template</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-pvc-test  	# 关联 PVC 名字，以便使用</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/usr/share/nginx/html</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumeClaimTemplates</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-pvc-test   </span> <span style="color:#75715e"># 定义：PVC 名字</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">storageClassName</span>: <span style="color:#ae81ff">nfs-storage-template   </span> <span style="color:#75715e"># 存储类名字，必须和StorageClass的pods名字相同</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">accessModes</span>:      <span style="color:#75715e"># 访问模式</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">ReadWriteMany  </span> <span style="color:#75715e"># 多节点读写</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">resources</span>:        <span style="color:#75715e"># 期望资源</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">2Gi         </span> <span style="color:#75715e"># 期望的空间容量</span></span></span></code></pre></div><ul>
<li><code>StatefulSet</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>Pods</code><!-- raw HTML omitted -->处于<!-- raw HTML omitted --><code>Pending</code><!-- raw HTML omitted -->状态，<!-- raw HTML omitted --><code>describe</code><!-- raw HTML omitted -->命令查看有以下报错<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>0/3 nodes are available: pod has unbound immediate PersistentVolumeClaims. preemption: 0/3 nodes are available: 3 No preemption victims found for incoming pod..</code></li>
<li><code>quay.io/external_storage/nfs-client-provisioner:latest</code><!-- raw HTML omitted -->官方镜像需要用到<!-- raw HTML omitted --><code>K8S</code><!-- raw HTML omitted -->里的<!-- raw HTML omitted --><code>SelfLink</code><!-- raw HTML omitted -->参数<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->解决方法<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 方法一：更换镜像，建议使用此方法</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 镜像一</span>
</span></span><span style="display:flex;"><span>gcr.io/k8s/staging-sig-storage/nfs-subdir-external-provisioner:v4.0.0
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 镜像二</span>
</span></span><span style="display:flex;"><span>registry.cn-beijing.aliyuncs.com/pylixm/nfs-subdir-external-provisioner:v4.0.0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 更换镜像后重新应用</span>
</span></span><span style="display:flex;"><span>$ kubectl replace -f kubernetes-deployment-provisioner-nfs-template.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 方法二：解决官方不支持方式</span>
</span></span><span style="display:flex;"><span>$ sudo cat &gt;&gt;/etc/kubernetes/manifests/kube-apiserver.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - command:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - kube-apiserver
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - --feafure-gates=RemoveSelfLink=false  	# 新增参数，默认是：true 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 重新应用</span>
</span></span><span style="display:flex;"><span>$ kubectl apply -f /etc/kubernetes/manifests/kube-apiserver.yaml</span></span></code></pre></div></blockquote>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>PVC</code> <!-- raw HTML omitted -->方式申请动态<!-- raw HTML omitted --><code>StorageClass</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolumeClaim</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pvc-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">accessModes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ReadWriteMany</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">200Mi</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">storageClassName</span>: <span style="color:#ae81ff">nfs-storage-template   </span> <span style="color:#75715e"># 存储类名字，必须和StorageClass的pods名字相	</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="pvc持久卷申请书"><code>PVC</code>持久卷申请书</h3>
<ul>
<li>
<ol>
<li><code>PVC(Persistent Volume Claim)</code>是持久化卷声明的意思，是用户对于存储需求的一种声明。换言之，PVC其实就是用户向<code>kubernetes</code>系统发出的一种资源需求申请</li>
</ol>
</li>
<li>
<ol start="2">
<li><code>PVC</code>：<code>kubernetes</code>用户维护</li>
</ol>
</li>
<li>
<ol start="3">
<li><code>PVC</code>是资源的申请，用来声明对存储空间、访问模式、存储类别需求信息</li>
</ol>
</li>
<li>
<ol start="4">
<li><code>PVC</code><!-- raw HTML omitted -->的关键配置参数说明<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>accessModes</code>(访客模式)：用于描述用户应用对存储资源的访问权限</li>
</ul>
<blockquote>
<ul>
<li><code>selector</code>(选择条件)：通过<code>Label Selector</code>的设置，可使<code>PVC</code>对于系统中已存在的<code>PV</code>进行筛选</li>
<li><code>storageClassName</code>(存储类别)：<code>PVC</code>在定义时可以设定需要的后端存储的类别，只有设置了该<code>class</code>的<code>pv</code>才能被系统选出</li>
<li><code>resources</code>(资源请求)：描述对存储资源的请求</li>
</ul>
</blockquote>
<ul>
<li><a href="https://raw.githubusercontent.com/usermice/imgs/master/Kubernetes_Server/Template/Storage/kubernetes-pvc-template.yaml" rel="external" target="_self"><code>Kubernetes PVC Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e">##########   定义Redis的PVC申请书，用于申请 Redis的PV   ##########</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolumeClaim</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis-pvc-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis-pvc-template</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumeMode</span>: <span style="color:#ae81ff">Filesystem       </span> <span style="color:#75715e"># 文件系统也需要与 PV相同才能使用</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">accessModes</span>:          <span style="color:#75715e"># 访问模式</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ReadWriteMany      </span> <span style="color:#75715e"># 权限需要与对应的PV 相同，才可以使用，Read：读、Write：写、Once：单节点、Many：代表多节点，Only：只读只写</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">storageClassName</span>: <span style="color:#ae81ff">nfs        </span> <span style="color:#75715e"># 需要与PV名字相同，Block:代表块存储、Filesystem:代表文件系统、nfs</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:    <span style="color:#75715e"># 请求空间</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">5Gi     </span> <span style="color:#75715e"># 对PV申请 5G 的存储空间</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e">##########   定义Nginx的PVC申请书，用于申请 Redis的PV   ##########</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolumeClaim</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-pvc-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-pvc-template</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumeMode</span>: <span style="color:#ae81ff">Filesystem</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">accessModes</span>:          <span style="color:#75715e"># 访问模式</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ReadWriteMany      </span> <span style="color:#75715e"># Read:代表可读、Write:代表写、Many:代表多节点</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">storageClassName</span>: <span style="color:#ae81ff">nfs        </span> <span style="color:#75715e"># 存储类型 ，Block:代表块存储、Filesystem:代表文件系统、nfs</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:    <span style="color:#75715e"># 请求空间</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">5Gi     </span> <span style="color:#75715e"># 对PV申请 5G 的存储空间</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e">##########      创建 Deployment 访问 PVC 类型存储   ##########</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis-pod-pvc-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis-pod-pvc-template</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">revisionHistoryLimit</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">progressDeadlineSeconds</span>: <span style="color:#ae81ff">600</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">strategy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>:      <span style="color:#75715e"># 当type为RollingUpdate的时候生效，用于为rollingUpdate设置参数</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">30</span><span style="color:#ae81ff">%      </span> <span style="color:#75715e"># 用来指定在升级过程中不可用的Pod的最大数量，默认为25%。</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxSurge</span>: <span style="color:#ae81ff">30</span><span style="color:#ae81ff">%    </span> <span style="color:#75715e"># 用来指定在升级过程中可以超过期望的Pod的最大数量，默认为25%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate        </span> <span style="color:#75715e"># 更新策略、支持 Recreate, RollingUpdate。默认RollingUpdate</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:     <span style="color:#75715e"># 选择器，通过它指定该控制器管理哪些pod </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:        <span style="color:#75715e"># Labels匹配规则，matchExpressions：Expressions匹配规则 </span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis-pvc-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:     <span style="color:#75715e"># 模板，当副本数量不足时，会根据下面的模板创建pod副本 </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:   <span style="color:#75715e"># Pod 的标签</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis-pvc-template</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#  nodeSelector:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    kubernetes.io/hostname: kube-01     # 指定节点</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">reids</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">redis:6.2.7</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;while true;do echo pod1 &gt;&gt; /root/out.txt; sleep 10; done;&#34;</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis-data       </span> <span style="color:#75715e"># 必须与volume定义的名称相同</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/opt/redis/conf       </span> <span style="color:#75715e"># 容器内路径</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis-data   </span> <span style="color:#75715e"># 自定义名称</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">persistentVolumeClaim</span>:      <span style="color:#75715e"># 关联 PVC</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">claimName</span>: <span style="color:#ae81ff">redis-pvc-template    </span> <span style="color:#75715e"># 关联 PVC，必须和定义PVC名称相同且，必须和当前pod在同一个命名空间</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">readOnly</span>: <span style="color:#66d9ef">false</span>   <span style="color:#75715e"># 是否只读，默认false</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="pvfont-colorred和fontpvc"><code>PV</code><!-- raw HTML omitted -->和<!-- raw HTML omitted --><code>PVC</code></h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->创建<!-- raw HTML omitted --><code>PVC</code><!-- raw HTML omitted -->后一直绑定不了<!-- raw HTML omitted --><code>PV</code><!-- raw HTML omitted -->的原因<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<p>① <code>PVC</code><!-- raw HTML omitted -->的空间申请大小比<!-- raw HTML omitted --><code>PV</code><!-- raw HTML omitted -->的空间要大<!-- raw HTML omitted --></p>
<p>② <code>PVC</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>storageClassName</code><!-- raw HTML omitted -->和<!-- raw HTML omitted --><code>PV</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>storageClassName</code><!-- raw HTML omitted -->不一致<!-- raw HTML omitted --></p>
<p>③ <code>PVC</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>accessModes</code><!-- raw HTML omitted -->和<!-- raw HTML omitted --><code>PV</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>accessModes</code><!-- raw HTML omitted -->不一致<!-- raw HTML omitted --></p>
</blockquote>
<ul>
<li>
<ol start="2">
<li><code>PVC</code><!-- raw HTML omitted -->和<!-- raw HTML omitted --><code>PV</code><!-- raw HTML omitted -->是一一对应，<!-- raw HTML omitted --><code>PV</code><!-- raw HTML omitted -->和<!-- raw HTML omitted --><code>PVC</code><!-- raw HTML omitted -->之间的相互作用遵循如下生命周期<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->资源供应：<!-- raw HTML omitted -->管理员手动创建底层存储和<code>PV</code></li>
<li><!-- raw HTML omitted -->资源绑定<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>用户创建<code>PVC</code>，<code>kubernetes</code>负责根据<code>PVC</code>声明去寻找<code>PV</code>，并绑定在用户定义好<code>PVC</code>之后，系统将根据<code>PVC</code>对存储资源的请求在以存在的<code>PV</code>中选择一个满足条件的</li>
</ul>
<blockquote>
<ul>
<li>一旦找到就将该<code>PV</code>和用户定义的<code>PVC</code>进行绑定，用户的应用就可以使用这个<code>PVC</code>了</li>
<li>如果找不到<code>PVC</code>就会无限期的处于<code>Pending</code>状态，直到系统管理员创建一个符合其要求的<code>PV</code></li>
</ul>
</blockquote>
<ul>
<li><code>PV</code>一旦绑定到某个<code>PVC</code>上就会被这个<code>PVC</code>独占，不能再和其他的<code>PVC</code>进行绑定了</li>
</ul>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->资源使用：<!-- raw HTML omitted -->用户可以在<code>Pod</code>中像<code>volume</code>一样使用<code>PVC</code>，<code>Pod</code>使用<code>Volume</code>的定义，将<code>PVC</code>挂载到容器内的某个路径进行使用</li>
<li><!-- raw HTML omitted -->资源释放<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>用户删除<code>PVC</code>来释放<code>PV</code></li>
<li>当存储资源使用完毕后，用户可以删除<code>PVC</code>，和该<code>PVC</code>绑定的<code>PV</code>将会标记为<!-- raw HTML omitted -->已释放<!-- raw HTML omitted -->但是还不能立刻和其他的<code>PVC</code>进行绑定。通过之前<code>PVC</code>写入的数据可能还留在存储设备上，只有在清除之后该<code>PV</code>才能再次使用</li>
</ul>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->资源回收<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>kubernetes</code>根据<code>PV</code>设置的回收策略进行资源的回收</li>
<li>对于<code>PV</code>，管理员可以设定回收策略，用于设置与之绑定的<code>PVC</code>释放资源之后如何处理遗留数据的问题。只有<code>PV</code>的存储空间完成回收，才能供新的<code>PVC</code>绑定和使用</li>
</ul>
</blockquote>
</blockquote>
<hr>
<h2 id="配置文件存储管理">配置文件存储管理</h2>
<h3 id="configmapfont-colorredfontsecretfont-colorred覆盖fontmark热更新mark"><code>ConfigMap</code><!-- raw HTML omitted -->&amp;<!-- raw HTML omitted --><code>Secret</code><!-- raw HTML omitted -->覆盖<!-- raw HTML omitted --><!-- raw HTML omitted -->热更新<!-- raw HTML omitted --></h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->注意事项<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>SubPath</code><!-- raw HTML omitted -->解决<!-- raw HTML omitted --><code>ConfigMap</code><!-- raw HTML omitted -->&amp;&amp;<!-- raw HTML omitted --><code>Secret</code><!-- raw HTML omitted -->目录覆盖问题，<!-- raw HTML omitted --><code>SubPath</code><!-- raw HTML omitted -->不支持热更新<!-- raw HTML omitted --></li>
<li>如果<code>ConfigMap</code>和<code>Secret</code>是以<code>subPath</code>的形式挂载的，那么<code>Pod</code>是不会感知到<code>ConfigMap</code>和<code>Secret</code>的更新的</li>
<li>如果<code>Pod</code>的变量来自<code>ConfigMap</code>和<code>Secret</code>中定义的内容，那么<code>ConfigMap</code>和<code>Secret</code>更新后，也不会更新<code>Pod</code>中的变量</li>
<li><code>immutable: true</code><!-- raw HTML omitted -->：禁止修改<!-- raw HTML omitted --><code>ConfigMap</code>、<code>Secret</code></li>
</ul>
</blockquote>
<hr>
<h3 id="configmap配置类型"><code>ConfigMap</code>配置类型</h3>
<h4 id="configmap简介以及注意事项"><code>ConfigMap</code>简介以及注意事项</h4>
<blockquote>
<ul>
<li><code>ConfigMap</code><!-- raw HTML omitted -->：是一个比较特殊的存储卷，它的主要作用是用来存储配置信息的<!-- raw HTML omitted --></li>
<li><code>ConfigMap</code>中的<code>key</code>映射为一个文件，<code>value</code>映射为文件中的内容。如果更新了<code>ConfigMap</code>中的内容，容器中的值也会动态更新</li>
<li><code>ConfigMap</code>是一种<code>API</code>对象，<!-- raw HTML omitted -->用来将非加密数据保存到键值对中。可以用作环境变量、命令行参数或者存储卷中的配置文件<!-- raw HTML omitted --></li>
<li><code>ConfigMap</code><!-- raw HTML omitted -->可以将环境变量配置信息和容器镜像解耦，便于应用配置的修改。如果需要存储加密信息时可以使用<!-- raw HTML omitted --><code>Secret</code>对象</li>
<li>使用<code>ConfigMap</code><!-- raw HTML omitted -->有以下几个限制条件：<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>ConfigMap</code><!-- raw HTML omitted -->必须<!-- raw HTML omitted -->在<code>pod</code>之前创建</li>
<li><code>ConfigMap</code>受<code>namespace</code>的限制，<!-- raw HTML omitted -->只能<!-- raw HTML omitted -->相同<code>namespace</code>的<code>pod</code>才可以引用</li>
</ul>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->注意事项<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>ConfigMap</code><!-- raw HTML omitted -->在设计上不是用来保存大量数据的<!-- raw HTML omitted -->在<code>ConfigMap</code>中保存的数据不可超过<code>1 MiB</code></li>
<li>如果需要保存超出此尺寸限制的数据，需要考虑挂载存储卷或者使用独立的数据库或者文件服务</li>
</ul>
</blockquote>
</blockquote>
<hr>
<h4 id="configmap使用以及配置"><code>ConfigMap</code>使用以及配置</h4>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->获取使用帮助<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl create configmap -h  	<span style="color:#75715e"># 查看使用帮助  </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl create configmap &lt;map-name&gt; &lt;data-source&gt;  	<span style="color:#75715e"># 命令使用方式  </span></span></span></code></pre></div><ul>
<li>从<!-- raw HTML omitted -->目录<!-- raw HTML omitted -->中创建<code>ConfigMap</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -pv /opt/yaml/configmap/config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;&gt;/opt/yaml/configmap/config/db.properties<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">port=3306
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">username=root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">host=127.0.0.1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">password=password
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;&gt;/opt/yaml/configmap/config/redis.properties<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">port=6379
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">host=127.0.0.1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">password=password
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --from-file：目录下的所有文件都会被用在ConfigMap里面创建一个键值对，键的名字就是文件名，值就是文件的内容，  </span>
</span></span><span style="display:flex;"><span>$ kubectl create configmap configmap-template --from-file<span style="color:#f92672">=</span>/opt/yaml/configmap/config/</span></span></code></pre></div><ul>
<li>从<!-- raw HTML omitted -->文件<!-- raw HTML omitted -->中创建<code>ConfigMap</code><!-- raw HTML omitted -->，并自定义<!-- raw HTML omitted --><code>ConfigMap</code><!-- raw HTML omitted -->中<!-- raw HTML omitted --><code>key</code><!-- raw HTML omitted -->的名称<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># --from-file，可以使用多次，同样键为文件名，值为文件中的内容</span>
</span></span><span style="display:flex;"><span>$ kubectl create configmap configmap-template-2 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> --from-file<span style="color:#f92672">=</span>rename1<span style="color:#f92672">=</span>/opt/yaml/configmap/config/db.properties <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> --from-file<span style="color:#f92672">=</span>rename2<span style="color:#f92672">=</span>/opt/yaml/configmap/config/redis.properties  </span></span></code></pre></div><ul>
<li><code>--from-literal=key=value</code><!-- raw HTML omitted -->键值对方式<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 使用：literal(key:value)，方式，--from-literal=key1=123 --from-literal=key2=234</span>
</span></span><span style="display:flex;"><span>$ kubectl create configmap configmap-template-3 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> --from-literal<span style="color:#f92672">=</span>key-1<span style="color:#f92672">=</span>value-1 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> --from-literal<span style="color:#f92672">=</span>key-2<span style="color:#f92672">=</span>value-2</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->从环境变量文件创建<!-- raw HTML omitted --><code>ConfigMap</code></li>
</ul>
<blockquote>
<ul>
<li>
<p><!-- raw HTML omitted -->注意：<!-- raw HTML omitted -->当<code>--from-env-file</code>从多个数据源创建<code>ConfigMap</code>的时候，仅仅最后一个<code>env</code>文件有效</p>
</li>
<li>
<p><!-- raw HTML omitted -->语法规则：<!-- raw HTML omitted --></p>
<p><code>env</code>文件中的每一行必须为<code>VAR = VAL</code>格式</p>
<p>以<code>＃</code>开头的行(即注释)将被忽略</p>
<p>空行将被忽略</p>
<p>引号没有特殊处理(即它们将成为<code>ConfigMap</code>值的一部分)</p>
</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl create configmap configmap-template-3 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --from-literal<span style="color:#f92672">=</span>password<span style="color:#f92672">=</span>passwd123 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --from-literal<span style="color:#f92672">=</span>APP_NAME<span style="color:#f92672">=</span>springboot-test <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --from-literal<span style="color:#f92672">=</span>JAVA_OPTS_TEST<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Xms512m -Xmx512&#39;</span>  </span></span></code></pre></div><ul>
<li><a href="https://raw.githubusercontent.com/usermice/imgs/master/Kubernetes_Server/Template/Storage/kubernetes-configmap-env-template.yaml" rel="external" target="_self"><code>Kubernetes ConfigMap ENV Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">configmap-env-test</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">revisionHistoryLimit</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">progressDeadlineSeconds</span>: <span style="color:#ae81ff">600</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>: 
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">name</span>: <span style="color:#ae81ff">configmap-env-test</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">strategy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxSurge</span>: <span style="color:#ae81ff">25</span><span style="color:#ae81ff">%</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">25</span><span style="color:#ae81ff">%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">configmap-env-test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">env-test</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">command</span>: [ <span style="color:#e6db74">&#34;/bin/sh&#34;</span>, <span style="color:#e6db74">&#34;-c&#34;</span>, <span style="color:#e6db74">&#34;env;sleep 3600&#34;</span> ]
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">env</span>:          <span style="color:#75715e"># 定义环境变量</span>
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">APP_ENV_TEST_CM      </span> <span style="color:#75715e"># 定义环境变量名</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">configMapKeyRef</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">name</span>: <span style="color:#ae81ff">configmap-template-3     </span> <span style="color:#75715e"># ConfigMap 的名字</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">key</span>: <span style="color:#ae81ff">APP_NAME  </span> <span style="color:#75715e"># 表示从 name的ConfigMap中获取名字为Key 的value，将其赋值给容器内本地的环境变量 APP_ENV_TEST_CM</span>
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">JAVA_ENV_TEST_CM</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">configMapKeyRef</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">name</span>: <span style="color:#ae81ff">configmap-template-3     </span> <span style="color:#75715e"># ConfigMap 的名字</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">key</span>: <span style="color:#ae81ff">JAVA_OPTS_TEST    </span> <span style="color:#75715e"># ConfigMap 的 key</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">volumeMounts</span>:   <span style="color:#75715e"># 加载数据卷</span>
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">passwd-config  </span> <span style="color:#75715e"># 表示加载 volumes 属性中那个数据卷</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">mountPath</span>: <span style="color:#e6db74">&#34;/opt/&#34;</span>    <span style="color:#75715e"># 想要将数据卷中的文件加载到那个目录下</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">readOnly</span>: <span style="color:#66d9ef">true</span>    <span style="color:#75715e"># 是否只读</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumes</span>: <span style="color:#75715e"># 依数据卷方式挂载 ConfigMap Secret</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">passwd-config  </span> <span style="color:#75715e"># 自定义名字</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">configMap</span>:    <span style="color:#75715e"># 数据卷类型为：ConfigMap</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">configmap-template-3   </span> <span style="color:#75715e"># ComfigMap 的名字，必须和加载的ConfigMap相同</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">items</span>:    <span style="color:#75715e"># 对 ConfigMap中的Key进行映射，如果不指定，默认会将ConfigMap中所有Key全部转换为一个个同名文件</span>
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">key</span>: <span style="color:#e6db74">&#34;password&#34;</span>   <span style="color:#75715e"># ConfigMap中的Key</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#34;password&#34;</span>    <span style="color:#75715e"># 将该Key的值转换为文件  </span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">restartPolicy</span>: <span style="color:#ae81ff">Always</span></span></span></code></pre></div><div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;&gt;/opt/yaml/configmap/config/env-file.properties<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">enemies=aliens
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">lives=3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">allowed=&#34;true&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl create cm configmap-template-3 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --from-env-file<span style="color:#f92672">=</span>/opt/yaml/configmap/config/env-file.properties
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;&gt;env.txt<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 其中，env.txt的文件格式为:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">key1=***
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">key2=***
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl create configmap configmap名 --from-env-file<span style="color:#f92672">=</span>env.txt </span></span></code></pre></div></blockquote>
<ul>
<li><code>ConfigMap</code><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>nginx.conf</code><!-- raw HTML omitted -->配置文件进行替换<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;&gt;nginx.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#user  nobody;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">worker_processes  1;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">events {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> worker_connections  1024;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#########   我是测试配置文件   ##########
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">http {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> include       mime.types;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> default_type  application/octet-stream;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> sendfile        on;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> keepalive_timeout  65;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> server {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     listen       80;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     server_name  localhost;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     location / {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         root   html;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         index  index.html index.htm;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     error_page   500 502 503 504  /50x.html;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     location = /50x.html {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         root   html;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>nginx.conf</code><!-- raw HTML omitted -->创建<!-- raw HTML omitted --><code>ConfigMap</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl create configmap nginxconf-cm-template --from-file<span style="color:#f92672">=</span>nginx.conf</span></span></code></pre></div><ul>
<li><a href="https://raw.githubusercontent.com/usermice/imgs/master/Kubernetes_Server/Template/Storage/kubernetes-configmap-template.yaml" rel="external" target="_self"><code>Kubernetes configmap Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e">##########   配置 Deployment 引用 ConfigMap 创建的文件   ##########</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-configmap-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">revisionHistoryLimit</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">progressDeadlineSeconds</span>: <span style="color:#ae81ff">600</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>: 
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-cm-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">strategy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxSurge</span>: <span style="color:#ae81ff">25</span><span style="color:#ae81ff">%</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">25</span><span style="color:#ae81ff">%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-cm-template</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">200m</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">128Mi</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">50m</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">128Mi</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-config   </span> <span style="color:#75715e"># 引用定义的 vulumes 名称</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#e6db74">&#39;/etc/nginx/nginx.conf&#39;</span>    <span style="color:#75715e"># 文件全路径</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">subPath</span>: <span style="color:#ae81ff">etc/nginx/nginx.conf  </span> <span style="color:#75715e"># subPath：要覆盖文件的相对路径，只覆盖必要文件，如果缺少此配置，将清空原有的所有文件和目录，不需要最前面的：/</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">restartPolicy</span>: <span style="color:#ae81ff">Always</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">terminationGracePeriodSeconds</span>: <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-config   </span> <span style="color:#75715e"># 定义 volumes 的名称</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">configMap</span>: <span style="color:#75715e"># 类型为configMap的存储卷，挂载预定义的configMap对象到容器内部</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginxconf-cm-template     </span> <span style="color:#75715e"># ConfigMap名称，使用名称进行关联 ConfigMap</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">items</span>:   <span style="color:#75715e"># 将configMap中的Key进行映射，如果不指定，默认会将configMap中所有Key全部转为一个个同名文档</span>
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">nginx.conf   </span> <span style="color:#75715e"># configMap中的Key</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">etc/nginx/nginx.conf  </span> <span style="color:#75715e"># 将该Key的值转为文件，最前面不需要：/</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted --> 进入<code>Pod</code>中查看<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl exec -it nginx-configmap-pod --  /bin/sh
</span></span><span style="display:flex;"><span>$ more /etc/nginx/nginx.conf</span></span></code></pre></div></blockquote>
<ul>
<li><a href="https://raw.githubusercontent.com/usermice/imgs/master/Kubernetes_Server/Template/Storage/kubernetes-configmap-simple-template.yaml" rel="external" target="_self"><code>Kubernetes ConfigMap Simple Template</code>模板</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ConfigMap</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">configmap-template   </span> <span style="color:#75715e"># ConfigMap</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">data</span>:   <span style="color:#75715e"># &lt;map[string]string&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">info</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">username:admin</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">password:123456</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##########   挂载数据方式   ##########</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">stream.conf</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    stream.conf {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      server {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        listen 1550;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        proxy_pass  192.168.3.125:16303;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }</span>    
</span></span><span style="display:flex;"><span><span style="color:#75715e">##########   挂载数据方式   ##########</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">listen-port</span>: <span style="color:#e6db74">&#34;8080&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">server-name</span>: <span style="color:#ae81ff">www.erge.com</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">default-vhost: |      # 此内容传给 Pod 中 items: 下 path</span>: <span style="color:#ae81ff">路径中</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">server {</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">listen 8080 default;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">location / {</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">return 200 &#34;default-vhost!\r\n&#34;;</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">blog-vhosts</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    server {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      listen 8080;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      server_name blog.erge.com;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      location / {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        return 200 &#34;blog-vhosts!\r\n&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }</span>    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e">##########   配置env引用方式 pod-configmap   ##########</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">configmap-pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tier</span>: <span style="color:#ae81ff">configmap</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">role</span>: <span style="color:#ae81ff">slb</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">mountPath</span>: <span style="color:#e6db74">&#39;/etc/nginx&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">LISTEN_PORT</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">configMapKeyRef</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">slb-vhosts-config</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">key</span>: <span style="color:#ae81ff">listen-port</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">SERVER_NAME</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">configMapKeyRef</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">slb-vhosts-config</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">key</span>: <span style="color:#ae81ff">server-name</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config  	# 定义 volumes 的名称</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">configMap</span>: <span style="color:#75715e"># 类型为configMap的存储卷，挂载预定义的configMap对象到容器内部</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">configmap-template </span> <span style="color:#75715e"># ConfigMap生成的Pod 名称，使用名称关联</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e"># items:   # 将configMap中的Key进行映射，如果不指定，默认会将configMap中所有Key全部转为一个个同名文档</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e"># - key: nginx.conf    # configMap中的Key</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">#   path: etc/nginx/nginx.conf   # 将该Key的值转为文件</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e">##########   配置volume引用方式 pod-configmap   ########## </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-configmap</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/configmap/config     </span> <span style="color:#75715e"># 没有则会自动创建,目录下有文件则会覆盖掉</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-config</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-config         </span> <span style="color:#75715e"># 此名称和 volumeMounts定义name名称一样</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">configMap</span>:          <span style="color:#75715e"># 类型为configMap的存储卷，挂载预定义的configMap对象到容器内部</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">configmap  </span> <span style="color:#75715e"># 配置为 configMap 容器的名称</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">defaultMode</span>: <span style="color:#ae81ff">integer      </span> <span style="color:#75715e"># 挂载到Pod中后，文件权限，如0444</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">items</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">default-vhost       </span> <span style="color:#75715e"># configMap中data下的key</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">default.conf       </span> <span style="color:#75715e"># 挂载路径，获取Configmap中data关键字下 定义配置文件名传给 volumeMounts 下的mountPath中</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mode</span>: <span style="color:#ae81ff">integer    </span> <span style="color:#75715e"># 文件权限</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">blog-vhosts</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">blog.conf</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">optional</span>: <span style="color:#66d9ef">true</span>      <span style="color:#75715e"># 当key不存在时是否报错，默认true</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="secret密码令牌类型"><code>Secret</code>密码令牌类型</h3>
<h4 id="secret简介以及注意事项"><code>Secret</code>简介以及注意事项</h4>
<blockquote>
<ul>
<li><code>Secret</code><!-- raw HTML omitted -->：在<!-- raw HTML omitted --><code>kubernetes</code><!-- raw HTML omitted -->中，还存在一种和<!-- raw HTML omitted --><code>ConfigMap</code><!-- raw HTML omitted -->非常类似的对象，称为<!-- raw HTML omitted --><code>Secret</code><!-- raw HTML omitted -->对象，它主要用来存储敏感信息，例如密码、密钥、证书等等<!-- raw HTML omitted --></li>
<li><code>imagePullSecret</code><!-- raw HTML omitted -->：<code>Pod</code>拉取私有镜像仓库的时使用的账户密码，会传递给<!-- raw HTML omitted --><code>kubelet</code><!-- raw HTML omitted -->，然后<!-- raw HTML omitted --><code>kubelet</code><!-- raw HTML omitted -->就可以拉取有密码的仓库里面的镜像<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->如果同时使用<!-- raw HTML omitted --><code>data</code><!-- raw HTML omitted -->和<!-- raw HTML omitted --><code>stringData</code><!-- raw HTML omitted -->，那么<!-- raw HTML omitted --><code>data</code><!-- raw HTML omitted -->会被忽略<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<hr>
<h4 id="secret使用以及配置"><code>Secret</code>使用以及配置</h4>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->获取使用帮助<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl create secret -h  	<span style="color:#75715e"># 查看使用帮助</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl create secret <span style="color:#f92672">[</span>flags<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>options<span style="color:#f92672">]</span>  	<span style="color:#75715e"># 命令使用方式  	</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>base64</code><!-- raw HTML omitted -->对准备的数据进行编码：对用户名、密码进行编码<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo -n <span style="color:#e6db74">&#39;user_name&#39;</span> | base64  		<span style="color:#75715e"># 特殊字符使用：&#39;&#39;(单引号)</span>
</span></span><span style="display:flex;"><span>$ echo -n <span style="color:#e6db74">&#39;password&#39;</span> | base64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 解码使用：--decode</span>
</span></span><span style="display:flex;"><span>$ echo -n <span style="color:#e6db74">&#39;dXNlcl9uYW1l&#39;</span> | base64 --decode</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->从命令行创建<!-- raw HTML omitted --><code>Secret</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl create secret generic secret-name <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> --from-literal<span style="color:#f92672">=</span>username<span style="color:#f92672">=</span>admin <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> --from-literal<span style="color:#f92672">=</span>password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;passwd@!3-&#39;</span>  	<span style="color:#75715e"># 特殊字符使用：&#39;&#39;(单引号)</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->创建<!-- raw HTML omitted --><code>Secret</code><!-- raw HTML omitted -->连接<!-- raw HTML omitted --><code>Harbor</code><!-- raw HTML omitted -->私人仓库<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>docker-harbor-registrykey</code>：<code>Secret</code>的<code>Pods</code><!-- raw HTML omitted -->名称，自定义<!-- raw HTML omitted --></li>
<li><code>--docker-server</code><!-- raw HTML omitted -->：镜像仓库地址<!-- raw HTML omitted --></li>
<li><code>--docker-username</code><!-- raw HTML omitted -->：镜像仓库用户名<!-- raw HTML omitted --></li>
<li><code>--docker-password</code><!-- raw HTML omitted -->：镜像仓库密码<!-- raw HTML omitted --></li>
<li><code>--docker-email</code><!-- raw HTML omitted -->：邮箱地址<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 获取 docker-registry 使用帮助</span>
</span></span><span style="display:flex;"><span>$ kubectl create secret docker-registry -h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建一个ImagePullSecret</span>
</span></span><span style="display:flex;"><span>$ kubectl create secret docker-registry docker-harbor-registrykey <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --docker-server<span style="color:#f92672">=</span>192.168.18.119:85:8080 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --docker-username<span style="color:#f92672">=</span>admin <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --docker-password<span style="color:#f92672">=</span>Harbor12345 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --docker-email<span style="color:#f92672">=</span>xxxxx@qq.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看是否创建成功</span>
</span></span><span style="display:flex;"><span>$ kubectl get secret docker-harbor-registrykey</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->创建<!-- raw HTML omitted --><code>redis.yaml</code><!-- raw HTML omitted -->文件，获取<!-- raw HTML omitted --><code>Harbor</code><!-- raw HTML omitted -->仓库镜像<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">imagePullSecrets</span>:  	<span style="color:#75715e"># 配置登录 docker registry 的 secret 仓库</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">docker-harbor-registrykey  	# 引用Secret的Pods，容器名称</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">192.168.18.119</span>:<span style="color:#ae81ff">85</span><span style="color:#ae81ff">/yuncloud/redis</span> <span style="color:#75715e"># 这是Harbor的镜像私有仓库地址</span></span></span></code></pre></div></blockquote>
<ul>
<li>准备<code>volumes-secret</code><!-- raw HTML omitted -->资源清单<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Secret</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">secret</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">Opaque</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">data</span>:  	<span style="color:#75715e"># 提前编码使用：data、使用Kubernetes进行编码使用：stringData</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">username</span>: <span style="color:#ae81ff">YWRtaW4=  	# 使用kubernetes进行编码写，原数据：admin</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">password</span>: <span style="color:#ae81ff">MTIzNDU2  	# 使用kubernetes进行编码写，原数据：123456</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e">##########   配置 secret-pod   ##########</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">secret-pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/secret/config</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">secret</span>:  	<span style="color:#75715e"># 类型为secret的存储卷，挂载集群与定义的secret对象到容器内部</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">secretName</span>: <span style="color:#ae81ff">secret</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">items</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">string</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">string</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted --> 查看编码后的目录以及信息<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 将nginx.conf导出到本地</span>
</span></span><span style="display:flex;"><span>$ kubectl exec -it nginx -- cat /etc/nginx/nginx.conf &gt; nginx.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl exec -it secret-pod-name -n default -- /bin/sh
</span></span><span style="display:flex;"><span>$ ls /secret/config
</span></span><span style="display:flex;"><span>$ more /secret/config/username
</span></span><span style="display:flex;"><span>$ more /secret/config/password</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="configure_k8s_rancher">Configure_K8s_Rancher</h1>

<h2 id="rancher服务宕机情况下使用kubernetes-cluster"><code>Rancher</code>服务宕机情况下使用<code>Kubernetes Cluster</code></h2>
<ul>
<li>
<ol>
<li><a href="https://docs.rancher.cn/docs/rancher2/cluster-admin/cleaning-cluster-nodes/_index/" rel="external" target="_self"><code>Rancher</code>清理节点</a></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>KUBE_SVC<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kube-scheduler
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kube-proxy
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kube-controller-manager
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kube-apiserver
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> kube_svc in <span style="color:#e6db74">${</span>KUBE_SVC<span style="color:#e6db74">}</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e"># 停止服务</span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">`</span>systemctl is-active <span style="color:#e6db74">${</span>kube_svc<span style="color:#e6db74">}</span><span style="color:#e6db74">`</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;active&#39;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        systemctl stop <span style="color:#e6db74">${</span>kube_svc<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e"># 禁止服务开机启动</span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">`</span>systemctl is-enabled <span style="color:#e6db74">${</span>kube_svc<span style="color:#e6db74">}</span><span style="color:#e6db74">`</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;enabled&#39;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        systemctl disable <span style="color:#e6db74">${</span>kube_svc<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 停止所有容器</span>
</span></span><span style="display:flex;"><span>docker stop <span style="color:#66d9ef">$(</span>docker ps -aq<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除所有容器</span>
</span></span><span style="display:flex;"><span>docker rm -f <span style="color:#66d9ef">$(</span>docker ps -qa<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除所有容器卷</span>
</span></span><span style="display:flex;"><span>docker volume rm <span style="color:#66d9ef">$(</span>docker volume ls -q<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 卸载mount目录</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> mount in <span style="color:#66d9ef">$(</span>mount | grep tmpfs | grep <span style="color:#e6db74">&#39;/var/lib/kubelet&#39;</span> | awk <span style="color:#e6db74">&#39;{ print $3 }&#39;</span><span style="color:#66d9ef">)</span> /var/lib/kubelet /var/lib/rancher;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>   umount $mount;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 备份目录</span>
</span></span><span style="display:flex;"><span>mv /etc/kubernetes /etc/kubernetes-bak-<span style="color:#66d9ef">$(</span>date +<span style="color:#e6db74">&#34;%Y%m%d%H%M&#34;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>mv /var/lib/etcd /var/lib/etcd-bak-<span style="color:#66d9ef">$(</span>date +<span style="color:#e6db74">&#34;%Y%m%d%H%M&#34;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>mv /var/lib/rancher /var/lib/rancher-bak-<span style="color:#66d9ef">$(</span>date +<span style="color:#e6db74">&#34;%Y%m%d%H%M&#34;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>mv /opt/rke /opt/rke-bak-<span style="color:#66d9ef">$(</span>date +<span style="color:#e6db74">&#34;%Y%m%d%H%M&#34;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除残留路径</span>
</span></span><span style="display:flex;"><span>rm -rf /etc/ceph <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> /etc/cni <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> /opt/cni <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> /run/secrets/kubernetes.io <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> /run/calico <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> /run/flannel <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> /var/lib/calico <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> /var/lib/cni <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> /var/lib/kubelet <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> /var/log/containers <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> /var/log/kube-audit <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> /var/log/pods <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> /var/run/calico <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> /usr/libexec/kubernetes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 清理网络接口</span>
</span></span><span style="display:flex;"><span>no_del_net_inter<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">lo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">eth
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ens
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">bond
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>network_interface<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>ls /sys/class/net<span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> net_inter in $network_interface;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">if</span> ! echo <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>no_del_net_inter<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> | grep -qE <span style="color:#e6db74">${</span>net_inter:0:3<span style="color:#e6db74">}</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        ip link delete $net_inter
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 清理残留进程</span>
</span></span><span style="display:flex;"><span>port_list<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">80
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">443
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">6443
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">2376
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">2379
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">2380
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">8472
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">9099
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">10250
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">10254
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> port in $port_list;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>   pid<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>netstat -atlnup | grep $port | awk <span style="color:#e6db74">&#39;{print $7}&#39;</span> | awk -F <span style="color:#e6db74">&#39;/&#39;</span> <span style="color:#e6db74">&#39;{print $1}&#39;</span> | grep -v - | sort -rnk2 | uniq<span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> -n $pid <span style="color:#f92672">]]</span>;<span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        kill -9 $pid
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kube_pid<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>ps -ef | grep -v grep | grep kube | awk <span style="color:#e6db74">&#39;{print $2}&#39;</span><span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> -n $kube_pid <span style="color:#f92672">]]</span>;<span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>   kill -9 $kube_pid
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 清理Iptables表</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 注意：如果节点Iptables有特殊配置，以下命令请谨慎操作</span>
</span></span><span style="display:flex;"><span>sudo iptables --flush
</span></span><span style="display:flex;"><span>sudo iptables --flush --table nat
</span></span><span style="display:flex;"><span>sudo iptables --flush --table filter
</span></span><span style="display:flex;"><span>sudo iptables --table nat --delete-chain
</span></span><span style="display:flex;"><span>sudo iptables --table filter --delete-chain
</span></span><span style="display:flex;"><span>systemctl restart docker</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted --><code>Rancher Server</code>是上游中心管理角色，控制或创建旗下<code>N</code>个<code>Kubernetes Cluster</code>集群，不管是测试中的单个节点或者是<code>Kubernetes Cluster</code>集群失效都无法读取，运维仍需要对下游所有<code>Kubernetes Cluster</code>集群管控<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>服务器</th>
<th>IP</th>
<th>CPU</th>
<th>内存</th>
</tr>
</thead>
<tbody>
<tr>
<td>master</td>
<td>192.168.35.128</td>
<td>8<code>core</code></td>
<td>8G</td>
</tr>
<tr>
<td>node-1</td>
<td>192.168.35.129</td>
<td>4<code>core</code></td>
<td>4G</td>
</tr>
<tr>
<td>node-2</td>
<td>192.168.35.130</td>
<td>4<code>core</code></td>
<td>4G</td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>
<ol start="3">
<li>前提条件</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>3.1 <!-- raw HTML omitted -->所有机器都是<code>CentOS 7</code><!-- raw HTML omitted --></li>
<li>3.2 <!-- raw HTML omitted --><code>Rancher Server</code>是以<code>Docker</code>方式单独建立<!-- raw HTML omitted --></li>
<li>3.3 <!-- raw HTML omitted --><code>test-cluster Kubernetes Cluster</code>集群是以<code>Rancher Server</code>自定义方式创建<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->模拟<code>Racnher Server</code>服务失效对<code>Kubernetes Cluster</code>集群进行管控<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>4.1 <!-- raw HTML omitted -->点击创建集群名称<!-- raw HTML omitted --></li>
</ul>
<p><a href="#R-image-d1035e9993abe4fe4c70b7dddab7c247" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-20_15-47-45.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-d1035e9993abe4fe4c70b7dddab7c247"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-20_15-47-45.png"></a></p>
<ul>
<li>4.2 <!-- raw HTML omitted -->提前下载<code>Kubernetesfig</code>文件<!-- raw HTML omitted --></li>
</ul>
<p><a href="#R-image-250f39511349cf615dcfd2e66221911b" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-20_15-49-19.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-250f39511349cf615dcfd2e66221911b"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-20_15-49-19.png"></a></p>
<p><a href="#R-image-198cae57dd002fece2ab44011a7d3212" class="lightbox-link"><img alt="下k8s file" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-20_16-16-23.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-198cae57dd002fece2ab44011a7d3212"><img alt="下k8s file" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-20_16-16-23.png"></a></p>
</blockquote>
<hr>
<h2 id="模拟rancher服务宕机">模拟<code>Rancher</code>服务宕机</h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->停止<code>Rancher Server</code>服务<code>docker stop rancher</code><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>1.1 <!-- raw HTML omitted --><code>查看Kubernetes</code>集群版本号<!-- raw HTML omitted --></li>
</ul>
<p><a href="#R-image-aa59b54579d2a9dcd7c16d77412050e3" class="lightbox-link"><img alt="查看<code>Rancher</code>安装<code>Kubernetes</code>集群版本" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-25_20-04-18.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-aa59b54579d2a9dcd7c16d77412050e3"><img alt="查看<code>Rancher</code>安装<code>Kubernetes</code>集群版本" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Rancher/Snipaste_2022-05-25_20-04-18.png"></a></p>
</blockquote>
<h3 id="安装kubectl">安装<code>Kubectl</code></h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->在能连接<code>test-kubernetes-cluster</code>集群中任意一个节点部署<code>Kubectl</code><!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="2">
<li><!-- raw HTML omitted --><code>Kubectl</code>版本需和<code>test-cluster-cluster</code>版本相同或者高于<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/yum.repos.d/kubernetes.repo<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[kubernetes] 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name=Kubernetes 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">enabled=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgcheck=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">repo_gpgcheck=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ yum -y install kubectl-1.23.6-0</span></span></code></pre></div></blockquote>
<h3 id="创建kube目录修改文件">创建<code>.kube</code>目录修改文件</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->并且将下载的<code>Kubernetesfig</code>文件改名为<code>config</code>，然后放到<code>${HOME}/.kube/</code>目录中<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir <span style="color:#e6db74">${</span>HOME<span style="color:#e6db74">}</span>/.kube
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ mv <span style="color:#e6db74">${</span>HOME<span style="color:#e6db74">}</span>/.kube/test-kubernetes-cluster.yaml <span style="color:#e6db74">${</span>HOME<span style="color:#e6db74">}</span>/.kube/config</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted --><code>${HOME}/.kube/config</code>文件没修改前<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat <span style="color:#e6db74">${</span>HOME<span style="color:#e6db74">}</span>/.kube/config
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Config
</span></span><span style="display:flex;"><span>clusters:
</span></span><span style="display:flex;"><span>- name: <span style="color:#e6db74">&#34;test-kubernetes-cluster&#34;</span>
</span></span><span style="display:flex;"><span>  cluster:
</span></span><span style="display:flex;"><span>    server: <span style="color:#e6db74">&#34;https://192.168.80.210:4443/k8s/clusters/c-gwknl&#34;</span>
</span></span><span style="display:flex;"><span>    certificate-authority-data: <span style="color:#e6db74">&#34;LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJwekNDQ\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      VUyZ0F3SUJBZ0lCQURBS0JnZ3Foa2pPUFFRREFqQTdNUnd3R2dZRFZRUUtFeE5rZVc1aGJXbGoKY\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      kdsemRHVnVaWEl0YjNKbk1Sc3dHUVlEVlFRREV4SmtlVzVoYldsamJHbHpkR1Z1WlhJdFkyRXdIa\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      GNOTWpJdwpOVEkxTVRFeE9UUXhXaGNOTXpJd05USXlNVEV4T1RReFdqQTdNUnd3R2dZRFZRUUtFe\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      E5rZVc1aGJXbGpiR2x6CmRHVnVaWEl0YjNKbk1Sc3dHUVlEVlFRREV4SmtlVzVoYldsamJHbHpkR\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      1Z1WlhJdFkyRXdXVEFUQmdjcWhrak8KUFFJQkJnZ3Foa2pPUFFNQkJ3TkNBQVJTb3NwRzE4OHJBQ\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      mZabTAwQnRqcjAyL29udnZGVnppU09wZUdVd09SUApoSHpUbk1acTRmazVpRFhPV2lIUy9iQ0hvT\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      WQra1VtYkx6QVRPNkd2azdtSm8wSXdRREFPQmdOVkhROEJBZjhFCkJBTUNBcVF3RHdZRFZSMFRBU\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      UgvQkFVd0F3RUIvekFkQmdOVkhRNEVGZ1FVZ1YzR1g0Z2tXN3hPZVZWQURWem0KVEpxSW95b3dDZ\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      1lJS29aSXpqMEVBd0lEU0FBd1JRSWdlTHh3WTVGcGkweDBGNXhBQUNZMnNPbVQ4aHBqNjVCWApUc\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      1lsQk1sOGx0RUNJUURkNmlONTJmbG9hVzZybXpvWXRLQy9nOEJRRW00b2UrcGN0YldCaGY0UENRP\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      T0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQ==&#34;</span>
</span></span><span style="display:flex;"><span>- name: <span style="color:#e6db74">&#34;test-kubernetes-cluster-node-1-80-211&#34;</span>
</span></span><span style="display:flex;"><span>  cluster:
</span></span><span style="display:flex;"><span>    server: <span style="color:#e6db74">&#34;https://192.168.80.211:6443&#34;</span>
</span></span><span style="display:flex;"><span>    certificate-authority-data: <span style="color:#e6db74">&#34;LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUM0VENDQ\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      WNtZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFTTVJBd0RnWURWUVFERXdkcmRXSmwKT\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      FdOaE1CNFhEVEl5TURVeU5URXhNek0xTUZvWERUTXlNRFV5TWpFeE16TTFNRm93RWpFUU1BNEdBM\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      VVFQXhNSAphM1ZpWlMxallUQ0NBU0l3RFFZSktvWklodmNOQVFFQkJRQURnZ0VQQURDQ0FRb0NnZ\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      0VCQUtJSzVRVy84eHB3CkRHUzMrN0M2Q0lobS8zcWFUUENvVmdFeU91YkVtR1EzbnAvYk9qTUJKY\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      3Ayck05cW5CV2M4ZmtUUWhCNHZsL24Kay8zSkUrMkdta1RBbVAwaGpLa3d6d1JiT2lrYzdYVEtnd\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      ElTQ3I2cjRkOWhZTElERElzTTJtUzZYYnhNdGd1SApoamk3MTJYQmNoZ3lEamxjREl3S1k5WXRYc\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      3lDY3hPejdFNXN4YmpLTk1nb2sxK3VZSTlHaHhYYUlGcGp0VWFUClJXUW00dE9JOFplWWlUWG9aT\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      nJldTU1SVkyZ3pQVjZ1dURTWGQybFRHMEtmVng0Y1FYSDJIekdSODJ4NWZkK3kKS01HY0M1N21DN\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      HpiM3pET1Z2NVNEdmxOZEhyQ0g3QmpVYzh0MlFpU2JyQUwrQ216NnhMVFF4dlp1YkVLejU2TApKe\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      ElKUGFhNkdSY0NBd0VBQWFOQ01FQXdEZ1lEVlIwUEFRSC9CQVFEQWdLa01BOEdBMVVkRXdFQi93U\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      UZNQU1CCkFmOHdIUVlEVlIwT0JCWUVGSkN3bmVCVXZUMUtoeWtCUjF6bmxWQ2I1T2RnTUEwR0NTc\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      UdTSWIzRFFFQkN3VUEKQTRJQkFRQnRwa0doRDJ1RFdYTmZaSUhaa0NNclNpSkZXaGxIUGNPa2VPZ\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      TJwcmp1UEZ0bzFWMVpyNlloWWVpcQp1cGxRdWlpenBwbEthZncxR1lpSnY4SCsrcHpjUFZoS3JTM\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      2F5Ykp1T2hxdnFyYUVZbzJDbjVVbkFpVWxBb2g1CnRqY1lNcVFKdkVzODd5UlFtUVhMSVNEMkdYb\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      3UwN24ySy9wTVZXQWpHYjRsUTk0VmpHcjI3dHppSlhIYkh2L04KbHNNZklJV2czbTFKSW9SMlBNa\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      3gvY1FpcGl6a3JRVHRpalhMbW0xbUFGOEtMR2JZcnNaTk1sMFdITWZWWjdXcgplemRBVjhVNDdsb\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      GowKzUzQ0FkZk0rYWpiSk5uMUtYMWF1Sm8rb1JXVTJjVno0SkYydUllMnBjcFcxUUplY1NPCmZ2U\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      ysyOU9FK09GZW5tenRINTdZTStTWk1jRE8KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>users:
</span></span><span style="display:flex;"><span>- name: <span style="color:#e6db74">&#34;test-kubernetes-cluster&#34;</span>
</span></span><span style="display:flex;"><span>  user:
</span></span><span style="display:flex;"><span>    token: <span style="color:#e6db74">&#34;kubeconfig-user-j85xz8pbjt:ls679hfqpvf9c25nswd5gdfm2hf4qtxj2kvqmj6kzzrjkj48lwwlpd&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>contexts:
</span></span><span style="display:flex;"><span>- name: <span style="color:#e6db74">&#34;test-kubernetes-cluster&#34;</span>
</span></span><span style="display:flex;"><span>  context:
</span></span><span style="display:flex;"><span>    user: <span style="color:#e6db74">&#34;test-kubernetes-cluster&#34;</span>
</span></span><span style="display:flex;"><span>    cluster: <span style="color:#e6db74">&#34;test-kubernetes-cluster&#34;</span>
</span></span><span style="display:flex;"><span>- name: <span style="color:#e6db74">&#34;test-kubernetes-cluster-node-1-80-211&#34;</span>
</span></span><span style="display:flex;"><span>  context:
</span></span><span style="display:flex;"><span>    user: <span style="color:#e6db74">&#34;test-kubernetes-cluster&#34;</span>
</span></span><span style="display:flex;"><span>    cluster: <span style="color:#e6db74">&#34;test-kubernetes-cluster-node-1-80-211&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>current-context: <span style="color:#e6db74">&#34;test-kubernetes-cluster&#34;</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted --><code>${HOME}/.kube/config</code>文件修改后<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat <span style="color:#e6db74">${</span>HOME<span style="color:#e6db74">}</span>/.kube/config
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Config
</span></span><span style="display:flex;"><span>clusters:
</span></span><span style="display:flex;"><span>- name: <span style="color:#e6db74">&#34;test-kubernetes-cluster-rke-master&#34;</span>
</span></span><span style="display:flex;"><span>  cluster:
</span></span><span style="display:flex;"><span>    server: <span style="color:#e6db74">&#34;https://192.168.80.211:6443&#34;</span>
</span></span><span style="display:flex;"><span>    certificate-authority-data: <span style="color:#e6db74">&#34;LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUM0VENDQ\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      WNtZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFTTVJBd0RnWURWUVFERXdkcmRXSmwKT\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      FdOaE1CNFhEVEl5TURVeU5URXhNek0xTUZvWERUTXlNRFV5TWpFeE16TTFNRm93RWpFUU1BNEdBM\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      VVFQXhNSAphM1ZpWlMxallUQ0NBU0l3RFFZSktvWklodmNOQVFFQkJRQURnZ0VQQURDQ0FRb0NnZ\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      0VCQUtJSzVRVy84eHB3CkRHUzMrN0M2Q0lobS8zcWFUUENvVmdFeU91YkVtR1EzbnAvYk9qTUJKY\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      3Ayck05cW5CV2M4ZmtUUWhCNHZsL24Kay8zSkUrMkdta1RBbVAwaGpLa3d6d1JiT2lrYzdYVEtnd\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      ElTQ3I2cjRkOWhZTElERElzTTJtUzZYYnhNdGd1SApoamk3MTJYQmNoZ3lEamxjREl3S1k5WXRYc\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      3lDY3hPejdFNXN4YmpLTk1nb2sxK3VZSTlHaHhYYUlGcGp0VWFUClJXUW00dE9JOFplWWlUWG9aT\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      nJldTU1SVkyZ3pQVjZ1dURTWGQybFRHMEtmVng0Y1FYSDJIekdSODJ4NWZkK3kKS01HY0M1N21DN\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      HpiM3pET1Z2NVNEdmxOZEhyQ0g3QmpVYzh0MlFpU2JyQUwrQ216NnhMVFF4dlp1YkVLejU2TApKe\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      ElKUGFhNkdSY0NBd0VBQWFOQ01FQXdEZ1lEVlIwUEFRSC9CQVFEQWdLa01BOEdBMVVkRXdFQi93U\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      UZNQU1CCkFmOHdIUVlEVlIwT0JCWUVGSkN3bmVCVXZUMUtoeWtCUjF6bmxWQ2I1T2RnTUEwR0NTc\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      UdTSWIzRFFFQkN3VUEKQTRJQkFRQnRwa0doRDJ1RFdYTmZaSUhaa0NNclNpSkZXaGxIUGNPa2VPZ\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      TJwcmp1UEZ0bzFWMVpyNlloWWVpcQp1cGxRdWlpenBwbEthZncxR1lpSnY4SCsrcHpjUFZoS3JTM\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      2F5Ykp1T2hxdnFyYUVZbzJDbjVVbkFpVWxBb2g1CnRqY1lNcVFKdkVzODd5UlFtUVhMSVNEMkdYb\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      3UwN24ySy9wTVZXQWpHYjRsUTk0VmpHcjI3dHppSlhIYkh2L04KbHNNZklJV2czbTFKSW9SMlBNa\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      3gvY1FpcGl6a3JRVHRpalhMbW0xbUFGOEtMR2JZcnNaTk1sMFdITWZWWjdXcgplemRBVjhVNDdsb\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      GowKzUzQ0FkZk0rYWpiSk5uMUtYMWF1Sm8rb1JXVTJjVno0SkYydUllMnBjcFcxUUplY1NPCmZ2U\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      ysyOU9FK09GZW5tenRINTdZTStTWk1jRE8KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>users:
</span></span><span style="display:flex;"><span>- name: <span style="color:#e6db74">&#34;test-kubernetes-cluster-rke-master&#34;</span>
</span></span><span style="display:flex;"><span>  user:
</span></span><span style="display:flex;"><span>    token: <span style="color:#e6db74">&#34;kubeconfig-user-j85xz8pbjt:ls679hfqpvf9c25nswd5gdfm2hf4qtxj2kvqmj6kzzrjkj48lwwlpd&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>contexts:
</span></span><span style="display:flex;"><span>- name: <span style="color:#e6db74">&#34;test-kubernetes-cluster-rke-master&#34;</span>
</span></span><span style="display:flex;"><span>  context:
</span></span><span style="display:flex;"><span>    user: <span style="color:#e6db74">&#34;test-kubernetes-cluster-rke-master&#34;</span>
</span></span><span style="display:flex;"><span>    cluster: <span style="color:#e6db74">&#34;test-kubernetes-cluster-rke-master&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>current-context: <span style="color:#e6db74">&#34;test-kubernetes-cluster-rke-master&#34;</span></span></span></code></pre></div></blockquote>
<h3 id="使用kubectl控制kubernetes-cluster集群">使用<code>Kubectl</code>控制<code>Kubernetes Cluster</code>集群</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl --kubeconfig <span style="color:#e6db74">${</span>HOME<span style="color:#e6db74">}</span>/.kube/config get pods -n kube-system
</span></span><span style="display:flex;"><span>$ kubectl create ns dev</span></span></code></pre></div></blockquote>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="configure_k8s_jcr">Configure_K8s_Jcr</h1>

<h2 id="安装配置jfrog-artifactory">安装配置<code>JFrog Artifactory</code></h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->下载最新<!-- raw HTML omitted --><code>JFrog Artifactory</code>社区版镜像</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ docker pull docker.bintray.io/jfrog/artifactory-jcr:latest</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->为私有镜像仓库做持久化存储<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -p /opt/docker/volume/artifactory
</span></span><span style="display:flex;"><span>$ chmod <span style="color:#ae81ff">777</span> -R /opt/docker
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 切换到上述目录后执行数据卷创建命令</span>
</span></span><span style="display:flex;"><span>$ cd /opt/docker/volume/artifactory
</span></span><span style="display:flex;"><span>$ docker volume create data</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->启动镜像<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>3.1 <!-- raw HTML omitted -->默认用户名：<!-- raw HTML omitted --><code>admin</code></li>
<li>3.2 <!-- raw HTML omitted -->默认密码：<!-- raw HTML omitted --><code>password</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ docker run --name jfrog-artifactory -d -v /opt/docker/volume/artifactory:/var/opt/jfrog/artifactory -p 8081:8081 -p 8082:8082 docker.bintray.io/jfrog/artifactory-jcr:latest</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->打开浏览器访问<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>http://ip:8082  	<span style="color:#75715e"># 或者配置Nginx域名</span></span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="configure_k8s_helm">Configure_K8s_Helm</h1>

<h1 id="使用helm配置管理k8s">使用<code>Helm</code>配置管理<code>K8s</code></h1>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/bitnami/" rel="external" target="_self"><code>Bitnami</code>模板库</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/bitnami/charts/tree/main/bitnami" rel="external" target="_self"><code>Kubernetes</code>的<code>Bitnami</code>库</a></td>
<td><code>Helm</code>安装<code>Kubernetes</code>服务<code>Zabbix</code>、<code>Redis</code>、<code>Mysql</code>模板</td>
</tr>
<tr>
<td><a href="https://github.com/bitnami/charts-docs/tree/main/charts" rel="external" target="_self"><code>Kubernetes</code>的<code>Charts-docs</code>库</a></td>
<td><code>Helm</code>安装<code>Kubernetes</code>服务<code>Zabbix</code>、<code>Redis</code>、<code>Mysql</code>模板</td>
</tr>
<tr>
<td><a href="https://artifacthub.io/" rel="external" target="_self">查找、安装和发布<code>Kubernetes</code>包</a></td>
<td><code>Helm</code>安装<code>Kubernetes</code>服务<code>Zabbix</code>、<code>Redis</code>、<code>Mysql</code>模板</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>
<ol>
<li><code>kubernetes</code>上的应用对象，都是由特定的资源描述组成，包括<code>Deployment</code>、<code>Service</code>等，都保存在各自文件中或者集中写在一个配置文件，然后通过<code>kubectl apply -f </code>部署。如果应用只由一个或几个这样的服务组成，上面的部署方式就足够了。但是对于一个复杂的应用，会有很多类似上面的资源描述文件，例如微服务架构应用，组成应用的服务可能多达几十、上百个，如果有更新或回滚应用的需求，可能要修改和维护所涉及到大量的资源文件，而这种组织和管理应用的方式就显得力不从心了。并且由于缺少对发布过的应用进行版本管理和控制，使得<code>kubernetes</code>上的应用维护和更新面临诸多的挑战，主要面临以下的问题：</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>如何将这些服务作为一个整体管理？</li>
<li>这些资源文件如何高效复用？</li>
<li>应用级别的版本如何管理？</li>
</ul>
</blockquote>
<ul>
<li>
<ol start="2">
<li><code>Helm</code><!-- raw HTML omitted -->是一个<!-- raw HTML omitted --><code>kubernetes</code><!-- raw HTML omitted -->的包管理工具，就像<!-- raw HTML omitted --><code>Linux</code><!-- raw HTML omitted -->下的包管理器，如<!-- raw HTML omitted --><code>yum</code>、<code>apt</code><!-- raw HTML omitted -->等，可以很方便的将之前打包好的<!-- raw HTML omitted --><code>yaml</code><!-- raw HTML omitted -->文件部署到<!-- raw HTML omitted --><code>kubernetes</code>上</li>
</ol>
</li>
<li>
<ol start="3">
<li><code>Helm</code><!-- raw HTML omitted -->有3个重要概念<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>helm</code><!-- raw HTML omitted -->：一个命令行客户端工具，主要用于<!-- raw HTML omitted --><code>kubernetes</code>应用<code>chart</code>的创建、打包、发布和管理</li>
<li><code>chart</code><!-- raw HTML omitted -->：应用描述，一系列用于描述<!-- raw HTML omitted --><code>kubernetes</code>资源相关文件的集合，类似<code>Ansible</code>的<code>Playbook</code>剧本</li>
<li><code>release</code><!-- raw HTML omitted -->：基于<!-- raw HTML omitted --><code>chart</code><!-- raw HTML omitted -->的部署实体，一个<!-- raw HTML omitted --><code>chart</code>被<code>Helm</code>运行后将会生成对应的一个<code>release</code>，将在<code>kubernetes</code>中创建出真实运行的资源对象</li>
</ul>
</blockquote>
<ul>
<li>
<ol start="4">
<li><code>Helm v3</code><!-- raw HTML omitted -->变化<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>最明显变化删除<code>Tiller</code>组件</li>
<li><code>release</code>名称可以在不同的命名空间重用。</li>
<li>支持将<code>chart</code>推动到<code>Docker</code>镜像仓库中</li>
<li>使用<code>JSONSchema</code>验证<code>chart values</code></li>
</ul>
</blockquote>
<hr>
<h2 id="helm常用命令"><code>Helm</code>常用命令</h2>
<blockquote>
<table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>get</code></td>
<td>下载一个<code>release</code>。可用的子命令：<code>all</code>、<code>hooks</code>、<code>manifest</code>、<code>note</code>、<code>values</code></td>
</tr>
<tr>
<td><code>repo</code></td>
<td>添加、列出、移除、更新和索引<code>chart</code>仓库。可用的子命令：<code>add</code>、<code>index</code>、<code>list</code>、<code>remove</code>、<code>update</code></td>
</tr>
<tr>
<td><code>list</code></td>
<td>列出<code>release</code></td>
</tr>
<tr>
<td><code>pull</code></td>
<td>从远程仓库中下载<code>chart</code>并解压到本地。比如：<code>helm install stable/mysql --untar</code></td>
</tr>
<tr>
<td><code>show</code></td>
<td>查看<code>chart</code>的详细信息。可用的子命令：<code>all</code>、<code>chart</code>、<code>readme</code>、<code>values</code></td>
</tr>
<tr>
<td><code>search</code></td>
<td>根据关键字搜索<code>chart</code>。可用的子命令：<code>all</code>、<code>chart</code>、<code>readme</code>、<code>values</code></td>
</tr>
<tr>
<td><code>create</code></td>
<td>创建一个<code>chart</code>并指定名字</td>
</tr>
<tr>
<td><code>install</code></td>
<td>安装一个<code>chart</code></td>
</tr>
<tr>
<td><code>status</code></td>
<td>显示已命名版本的状态</td>
</tr>
<tr>
<td><code>upgrade</code></td>
<td>更新升级一个<code>release</code></td>
</tr>
<tr>
<td><code>history</code></td>
<td>获取<code>release</code>历史</td>
</tr>
<tr>
<td><code>package</code></td>
<td>将<code>chart</code>目录打包到<code>chart</code>存档文件中</td>
</tr>
<tr>
<td><code>template</code></td>
<td>本地呈现模板</td>
</tr>
<tr>
<td><code>rollback</code></td>
<td>从之前的版本回退</td>
</tr>
<tr>
<td><code>uninstall</code></td>
<td>卸载一个<code>release</code></td>
</tr>
<tr>
<td><code>dependency</code></td>
<td>管理<code>chart</code>依赖</td>
</tr>
<tr>
<td><code>version</code></td>
<td>查看<code>Helm</code>客户端版本</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h2 id="font-colorred安装fonthelm"><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>Helm</code></h2>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->使用二进制安装<!-- raw HTML omitted --><code>Helm</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget https://get.helm.sh/helm-v3.9.0-linux-amd64.tar.gz  
</span></span><span style="display:flex;"><span>$ tar -zxvf helm-v3.9.0-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>$ mv linux-amd64/helm /usr/local/bin/helm</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->脚本安装<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
</span></span><span style="display:flex;"><span>$ chmod <span style="color:#ae81ff">700</span> get_helm.sh
</span></span><span style="display:flex;"><span>$ ./get_helm.sh</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->源代码安装<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git clone https://github.com/helm/helm.git
</span></span><span style="display:flex;"><span>$ cd helm
</span></span><span style="display:flex;"><span>$ make</span></span></code></pre></div></blockquote>
<hr>
<h2 id="配置chart仓库">配置<code>chart</code>仓库</h2>
<blockquote>
<ul>
<li><code>Helm</code><!-- raw HTML omitted -->添加仓库方式<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm repo add 仓库名 仓库地址</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->使用官方仓库<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm repo add helm https://hub.kubeapps.com/charts/incubator</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->添加其它仓库<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># Bitnami</span>
</span></span><span style="display:flex;"><span>$ helm repo add bitnami https://charts.bitnami.com/bitnami
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用微软仓库</span>
</span></span><span style="display:flex;"><span>$ helm repo add microsoft http://mirror.azure.cn/kubernetes/charts
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 国内添加阿里云、微软仓库</span>
</span></span><span style="display:flex;"><span>$ helm repo add aliyun https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->更新仓库命令<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm repo update</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->删除存储库<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm repo remove 仓库名</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->获取配置的存储库<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm repo list</span></span></code></pre></div></blockquote>
<hr>
<h2 id="helm基本使用"><code>Helm</code>基本使用</h2>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->根据关键字搜索<!-- raw HTML omitted --><code>chart</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm search repo | hub chart名称
</span></span><span style="display:flex;"><span>$ helm search repo redis    <span style="color:#75715e"># 示例</span>
</span></span><span style="display:flex;"><span>  DEPRECATED  	<span style="color:#75715e"># 表示已过期</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->查看<!-- raw HTML omitted --><code>chart</code><!-- raw HTML omitted -->信息<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm show chart 仓库名/chart名称
</span></span><span style="display:flex;"><span>$ helm show chart bitnami/redis</span></span></code></pre></div><ul>
<li><code>readme</code><!-- raw HTML omitted -->查看安装文档说明<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm show readme bitnami/redis</span></span></code></pre></div></blockquote>
<hr>
<h3 id="font-colorred安装fontchartfont-colorred形成fontrelease"><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>chart</code><!-- raw HTML omitted -->，形成<!-- raw HTML omitted --><code>release</code></h3>
<ul>
<li>
<ol>
<li>自定义选项是因为并不是所有的<code>chart</code>都能按照默认配置运行成功，可能会需要一些环境依赖，例如<code>PV</code>。</li>
</ol>
</li>
<li>
<ol start="2">
<li>所以需要自定义<code>chart</code>配置选项，安装过程中有两种方法可以传递配置数据：</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>--values</code><!-- raw HTML omitted -->：的使用(麻烦、不推荐)<!-- raw HTML omitted --></li>
<li><code>--set</code><!-- raw HTML omitted -->：在命令行上指定替代。如果两种都用，那么<!-- raw HTML omitted --><code>--set</code>的优先级高</li>
<li><code>--values 或 -f</code><!-- raw HTML omitted -->：指定带有覆盖的<!-- raw HTML omitted --><code>YAML</code>文件。这里可以多次指定，最右边的文件优先</li>
</ul>
</blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->安装可能报错，需要自己手动安装<!-- raw HTML omitted --><code>PV</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->先将修改的变量写到一个文件中，并修改此文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm show values stable/mysql &gt; config.yaml</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>config.yaml</code><!-- raw HTML omitted -->文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>-- <span style="color:#ae81ff">修改部分</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">persistence</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">accessMode</span>: <span style="color:#ae81ff">ReadWriteOnce</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">size</span>: <span style="color:#ae81ff">8Gi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">mysqlUser</span>: <span style="color:#e6db74">&#34;k8s&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">mysqlPassword</span>: <span style="color:#e6db74">&#34;123456&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">mysqlDatabase</span>: <span style="color:#e6db74">&#34;k8s&#34;</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>-f</code><!-- raw HTML omitted -->来替换默认的配置<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm install -f config.yaml self-mysql stable/mysql</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->推荐使用命令行替代变量<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm install db --set persistence.storageClass<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;managed-nfs-storage&#34;</span> stable/mysql</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>chart</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm install 安装之后的名称 仓库名/chart的名称<span style="color:#f92672">(</span>即搜索之后的应用名称<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>$ helm install k8s_ui stable/weave-scope  	<span style="color:#75715e"># 安装 stable/weave-scope，并将其命名为 k8s_ui</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看当前的 release 列表</span>
</span></span><span style="display:flex;"><span>$ helm list
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看已命名 release 的状态</span>
</span></span><span style="display:flex;"><span>$ helm status k8s_ui 安装之后的名称</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="6">
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>Helm</code><!-- raw HTML omitted -->构建一个<!-- raw HTML omitted --><code>Chart</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>helm create</code><!-- raw HTML omitted -->创建<!-- raw HTML omitted --><code>chart</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm create mychart  <span style="color:#75715e"># chart名称</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->进入自定义<!-- raw HTML omitted --><code>chart</code><!-- raw HTML omitted -->目录的<!-- raw HTML omitted --><code>templates</code><!-- raw HTML omitted -->目录中，修改其中的<!-- raw HTML omitted --><code>deployment.yaml</code>和<code>service.yaml</code><!-- raw HTML omitted -->等文件<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>charts</code><!-- raw HTML omitted -->：该目录保存其他依赖的<!-- raw HTML omitted --><code>chart(子chart)</code></li>
<li><code>Chart.yaml</code><!-- raw HTML omitted -->：定义当前<!-- raw HTML omitted --><code>Chart</code><!-- raw HTML omitted -->属性信息<!-- raw HTML omitted --></li>
<li><code>templates</code><!-- raw HTML omitted -->：<code>chart</code>配置模板，目录存放所有<!-- raw HTML omitted --><code>yaml</code><!-- raw HTML omitted -->文件<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>Deployment.yaml</code><!-- raw HTML omitted -->：<!-- raw HTML omitted --></li>
<li><code>_helpers.tpl</code><!-- raw HTML omitted -->：<!-- raw HTML omitted --></li>
<li><code>hpa.yaml</code><!-- raw HTML omitted -->：<!-- raw HTML omitted --></li>
<li><code>ingress.yaml</code><!-- raw HTML omitted -->：<!-- raw HTML omitted --></li>
<li><code>NOTES.txt</code><!-- raw HTML omitted -->：用于介绍<code>Chart</code>的帮助信息，<code>Helm install</code>部署后展示给用户<!-- raw HTML omitted --></li>
<li><code>serviceaccount.yaml</code><!-- raw HTML omitted -->：<!-- raw HTML omitted --></li>
<li><code>service.yaml</code><!-- raw HTML omitted -->：<!-- raw HTML omitted --></li>
<li><code>tests</code><!-- raw HTML omitted -->：<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>tests-connection.yaml</code><!-- raw HTML omitted -->：<!-- raw HTML omitted --></li>
</ul>
</blockquote>
</blockquote>
<ul>
<li><code>values.yaml</code><!-- raw HTML omitted -->：定义所有<!-- raw HTML omitted --><code>yaml</code><!-- raw HTML omitted -->全局变量<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd chart名称/templates</span></span></code></pre></div><p><a href="#R-image-fc0230e63a95a55ddccda65541f69303" class="lightbox-link"><img alt="Chart中的信息" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Helm/Chart%E4%B8%AD%E7%9A%84%E4%BF%A1%E6%81%AF.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-fc0230e63a95a55ddccda65541f69303"><img alt="Chart中的信息" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kubernetes_Server/Helm/Chart%E4%B8%AD%E7%9A%84%E4%BF%A1%E6%81%AF.png"></a></p>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->通过刚才创建的<!-- raw HTML omitted --><code>chart</code><!-- raw HTML omitted -->目录，将其部署<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm install web mychart  <span style="color:#75715e"># web:自定义名称，chart名称</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->打包<!-- raw HTML omitted --><code>chart</code><!-- raw HTML omitted -->，让别人共享<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm package mychart  <span style="color:#75715e"># chart名称</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="font-colorred查看fontservicefont-colorred并将其改为fontnodeport"><!-- raw HTML omitted -->查看<!-- raw HTML omitted --><code>Service</code><!-- raw HTML omitted -->，并将其改为<!-- raw HTML omitted --><code>NodePort</code></h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl edit svc xxx
</span></span><span style="display:flex;"><span>$ kubectl edit svc ui-weave-scope</span></span></code></pre></div></blockquote>
<hr>
<h3 id="font-colorred应用示例font"><!-- raw HTML omitted -->应用示例<!-- raw HTML omitted --></h3>
<ul>
<li>
<ol>
<li><code>root</code><!-- raw HTML omitted -->目录下操作的<!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="2">
<li>创建<code>chart</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm create nginx</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->进入<!-- raw HTML omitted --><code>chart</code><!-- raw HTML omitted -->目录，修改<!-- raw HTML omitted --><code>values.yaml</code><!-- raw HTML omitted -->文件，内容如下<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo cat &gt;&gt;nginx/values.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">replicas: 3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">image: nginx 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">tag: 1.17 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">serviceport: 80 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">targetport: 80 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">label: nginx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->删除<!-- raw HTML omitted --><code>templates</code><!-- raw HTML omitted -->目录中的文件和文件夹<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rm -rf emplates/*</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>deployment.yaml</code><!-- raw HTML omitted -->文件，内容如下<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo cat &gt;&gt;deployment.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: apps/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Deployment
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     app: {{ .Values.label }} 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> name: {{ .Release.Name }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> replicas: {{ .Values.replicas }} 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> selector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     matchLabels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         app: {{ .Values.label }} 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> strategy: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> template:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">             app: {{ .Values.label }} 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - image: {{ .Values.image }}:{{ .Values.tag }} 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          name: {{ .Values.image }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="6">
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>service.yaml</code><!-- raw HTML omitted -->文件，内容如下：<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo cat &gt;&gt;service.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion:   v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Service
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     app: {{ .Values.label }} 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> name:  {{ .Release.Name }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> ports:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        -  port: {{ .Values.serviceport }} 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">           protocol: TCP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">           targetPort: {{ .Values.targetport }} 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    selector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        app: {{ .Values.label }} 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    type: NodePort
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="7">
<li><!-- raw HTML omitted -->切换到<!-- raw HTML omitted --><code>chart</code><!-- raw HTML omitted -->目录的上一层目录、并且安装<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd ~
</span></span><span style="display:flex;"><span>$ helm install nginx nginx/</span></span></code></pre></div></blockquote>
<hr>
<h3 id="font-colorred调试font"><!-- raw HTML omitted -->调试<!-- raw HTML omitted --></h3>
<ul>
<li>
<ol>
<li><code>Helm</code>也提供了<code>--dry-run</code>和<code>--debug</code>调试参数，帮助你验证模板的正确性。在执行<code>helm install</code>的时候带上这两个参数就可以把对应的<code>values</code>值和渲染的资源清单打印出来，而不是真正的做部署一个<code>release</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm install nginx nginx/ --dry-run --debug</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->一些常用的内置对象：<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>内置对象</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Release.Name</code></td>
<td><code>release</code>的名称</td>
</tr>
<tr>
<td><code>Release.Namespace</code></td>
<td><code>release</code>的命名空间</td>
</tr>
<tr>
<td><code>Release.Service</code></td>
<td><code>release</code>的服务的名称</td>
</tr>
<tr>
<td><code>Release.Revision</code></td>
<td><code>release</code>的修订版本号，从1开始累加</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h3 id="font-colorredvaluesfont"><!-- raw HTML omitted --><code>Values</code><!-- raw HTML omitted --></h3>
<ul>
<li>
<ol>
<li><code>Values</code>对象是为<code>Chart</code>模板提供值，这个对象的值有<code>4</code>个来源：</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>chart</code>包中的<code>values.yaml</code>文件</li>
<li>父<code>chart</code>包的<code>values.yaml</code>文件</li>
<li>通过<code>helm install</code>或者<code>helm upgrade</code>的<code>-f</code>或者<code>--values</code>参数传入的自定义的<code>yaml</code>文件</li>
<li>通过<code>--set</code>参数传入的值</li>
</ul>
</blockquote>
<ul>
<li>
<ol start="2">
<li><code>Chart</code>的<code>values.yaml</code>提供的值可以被用户提供的<code>values</code>文件覆盖，而该文件同样可以被<code>--set</code>参数所覆盖，换言之，<code>--set</code>参数的优先级高</li>
</ol>
</li>
</ul>
<hr>
<h2 id="升级回滚和卸载发行版本">升级、回滚和卸载发行版本</h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->升级<!-- raw HTML omitted -->发布新版本的<code>chart</code>时，或者当我们需要更改发布的配置，可以使用<code>helm upgrade</code>命令</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm upgrade --set imageTag<span style="color:#f92672">=</span>1.18 nginx nginx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ helm upgrade web mychart  <span style="color:#75715e"># web:自定义名称，chart名称</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ helm upgrade -f values.yaml nginx nginx</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->回滚<!-- raw HTML omitted -->如果在发布后没有达到预期的效果，则可以使用<code>helm rollback</code>回滚到之前的版本</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm history redis -n default  	<span style="color:#75715e"># 查看历史版本</span>
</span></span><span style="display:flex;"><span>$ helm rollback nginx <span style="color:#ae81ff">1</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->卸载<!-- raw HTML omitted -->可以使用<code>helm uninstall</code>命令</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm uninstall nginx</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted --> 查看历史版本配置信息<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm get all --revision <span style="color:#ae81ff">1</span> nginx</span></span></code></pre></div></blockquote>
<hr>
<h2 id="管道函数">管道、函数</h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->管道<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>quote</code>  <code>.Values.label.app</code><!-- raw HTML omitted -->将后面的值作为参数传递过<!-- raw HTML omitted --><code>quote</code><!-- raw HTML omitted -->函数<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->模板函数调用语法为：<!-- raw HTML omitted --><code>functionName arg1 arg2...</code></li>
<li>在上面的案例中，其实是将值传递给模板引擎进行渲染，模板引擎还支持对拿到的数据进行二次处理，示例：从<code>.Values</code>中读取的值变成字符串，可以使用<code>quote</code>函数实现</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat templates/deployment.yaml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 略...</span>
</span></span><span style="display:flex;"><span>app: <span style="color:#f92672">{{</span> quote  .Values.label.app    <span style="color:#f92672">}}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 略...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ helm install --dry-run nginx ../nginx/ app:<span style="color:#e6db74">&#34;nginx&#34;</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->函数<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>default</code><!-- raw HTML omitted -->函数运行在模板中指定默认值，以防止该值会忽略掉。如果忘记定义，执行<!-- raw HTML omitted --><code>helm install</code><!-- raw HTML omitted -->的时候会因为缺少字段而无法创建资源，这时就可以定义一个默认值了，示例：<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo cat &gt;&gt;templates/deployment.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: apps/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Deployment
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        app: {{ .Values.label }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: {{ .Release.Name }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    replicas: {{ .Values.replicas }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    selector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        matchLabels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            app: {{ .Values.label }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    strategy: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    template:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                app: {{ .Values.label }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            - image: {{ .Values.image| default &#34;nginx&#34; }}:{{ .Values.tag }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              name: {{ .Values.image }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->缩进函数：<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>{{ <span style="color:#ae81ff">.Values.resources | indent 12 }}</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->大写函数<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>{{ <span style="color:#ae81ff">upper .Values.resources }}</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->首字母大写函数<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>{{ <span style="color:#ae81ff">title .Values.resources }}</span></span></span></code></pre></div></blockquote>
<hr>
<h2 id="流程控制">流程控制</h2>
<ul>
<li>
<ol>
<li>流程控制是为模板提供了一种能力，满足更复杂的数据逻辑处理</li>
</ol>
</li>
<li>
<ol start="2">
<li><code>Helm</code>模板语言提供以下流程控制语句：</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>if/else</code><!-- raw HTML omitted -->条件块<!-- raw HTML omitted --></li>
<li><code>with</code><!-- raw HTML omitted -->指定范围<!-- raw HTML omitted --></li>
<li><code>range</code><!-- raw HTML omitted -->循环块<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li>
<ol start="3">
<li><code>if/else</code><!-- raw HTML omitted -->：块是用于在模板有条件的包含文本块的方法<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->条件判断：<!-- raw HTML omitted -->就是判断条件是否为真，如果值为以下几种情况则为<code>false</code>，否则为<code>true</code>：</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->一个布尔类型的<!-- raw HTML omitted --><code>false</code></li>
<li><!-- raw HTML omitted -->一个数字<!-- raw HTML omitted --><code>0</code></li>
<li><!-- raw HTML omitted -->一个空的字符串<!-- raw HTML omitted --></li>
<li>一个空的集合(<code>map</code>、<code>slice</code>、<code>tuple</code>、<code>dict</code>、<code>array</code>)</li>
</ul>
</blockquote>
<ul>
<li>还可以使用<code>ne</code>、<code>lt</code>、<code>gt</code>、<code>and</code>、<code>or</code>等运算符</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>{{ <span style="color:#ae81ff">if 条件表达式 }}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># xxx</span>
</span></span><span style="display:flex;"><span>{{ <span style="color:#ae81ff">else if 条件表达式 }}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># xxx</span>
</span></span><span style="display:flex;"><span>{{ <span style="color:#ae81ff">else }}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># xxx</span>
</span></span><span style="display:flex;"><span>{{ <span style="color:#ae81ff">end }}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 示例</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: {{ <span style="color:#ae81ff">.Values.label }}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: {{ <span style="color:#ae81ff">.Release.Name }}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">replicas</span>: {{ <span style="color:#ae81ff">.Values.replicas }}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">app</span>: {{ <span style="color:#ae81ff">.Values.label }}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">strategy</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">app</span>: {{ <span style="color:#ae81ff">.Values.label }}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">image</span>: {{ <span style="color:#ae81ff">.Values.image| default &#34;nginx&#34; }}:{{ .Values.tag }}</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">name</span>: {{ <span style="color:#ae81ff">.Values.image }}</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>                  {{ <span style="color:#ae81ff">if eq .Values.devops &#34;k8s&#34; }}</span>
</span></span><span style="display:flex;"><span>              - <span style="color:#f92672">name </span>: <span style="color:#ae81ff">hello</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;123&#34;</span>
</span></span><span style="display:flex;"><span>                {{ <span style="color:#ae81ff">else }}</span>
</span></span><span style="display:flex;"><span>              - <span style="color:#f92672">name </span>: <span style="color:#ae81ff">hello</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;456&#34;</span>
</span></span><span style="display:flex;"><span>                {{ <span style="color:#ae81ff">end }}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 模板引擎渲染一下，会得到如下的结果：</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">$ helm install --dry-run nginx nginx</span></span></span></code></pre></div><ul>
<li>可以看到渲染出来会有多余的空行，这是因为当模板引擎运行的时候，会将控制指令删除，所以之前占的位置也就空白了，需要使用<code>{{- if ...}}</code>的方式消除此空行</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: {{ <span style="color:#ae81ff">.Values.label }}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: {{ <span style="color:#ae81ff">.Release.Name }}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">replicas</span>: {{ <span style="color:#ae81ff">.Values.replicas }}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">app</span>: {{ <span style="color:#ae81ff">.Values.label }}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">strategy</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">app</span>: {{ <span style="color:#ae81ff">.Values.label }}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>                - <span style="color:#f92672">image</span>: {{ <span style="color:#ae81ff">.Values.image| default &#34;nginx&#34; }}:{{ .Values.tag }}</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">name</span>: {{ <span style="color:#ae81ff">.Values.image }}</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>                      {{- <span style="color:#ae81ff">if eq .Values.devops &#34;k8s&#34; }}</span>
</span></span><span style="display:flex;"><span>                - <span style="color:#f92672">name </span>: <span style="color:#ae81ff">hello</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;123&#34;</span>
</span></span><span style="display:flex;"><span>                  {{- <span style="color:#ae81ff">else }}</span>
</span></span><span style="display:flex;"><span>                - <span style="color:#f92672">name </span>: <span style="color:#ae81ff">hello</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;456&#34;</span>
</span></span><span style="display:flex;"><span>                  {{- <span style="color:#ae81ff">end }}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 通过模板引擎渲染，会得到如下的结果</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">$ helm install --dry-run nginx nginx</span></span></span></code></pre></div><ul>
<li>如果使用<code>{{- if ... -}}</code>那么就需要谨慎，比如：</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: {{ <span style="color:#ae81ff">.Values.label }}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: {{ <span style="color:#ae81ff">.Release.Name }}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">replicas</span>: {{ <span style="color:#ae81ff">.Values.replicas }}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">app</span>: {{ <span style="color:#ae81ff">.Values.label }}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">strategy</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">app</span>: {{ <span style="color:#ae81ff">.Values.label }}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>                - <span style="color:#f92672">image</span>: {{ <span style="color:#ae81ff">.Values.image| default &#34;nginx&#34; }}:{{ .Values.tag }}</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">name</span>: {{ <span style="color:#ae81ff">.Values.image }}</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>                      {{- <span style="color:#ae81ff">if eq .Values.devops &#34;k8s&#34; -}}</span>
</span></span><span style="display:flex;"><span>                  - <span style="color:#f92672">name </span>: <span style="color:#ae81ff">hello</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;123&#34;</span>
</span></span><span style="display:flex;"><span>                    {{- <span style="color:#ae81ff">else }}</span>
</span></span><span style="display:flex;"><span>                  - <span style="color:#f92672">name </span>: <span style="color:#ae81ff">hello</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;456&#34;</span>
</span></span><span style="display:flex;"><span>                    {{- <span style="color:#ae81ff">end }}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 通过模板引擎渲染，会得到如下的结果：</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">$ helm install --dry-run nginx nginx</span></span></span></code></pre></div><ul>
<li>相当于下面这种格式</li>
</ul>
<blockquote>
<ul>
<li>当然不对，因为<code>{{- if ... -}}</code>删除了双方的换行符</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">NAME</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">LAST DEPLOYED</span>: <span style="color:#ae81ff">Mon Jan 11 20:46:10 2021</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">NAMESPACE</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">STATUS</span>: <span style="color:#ae81ff">pending-install</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">REVISION</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">TEST SUITE</span>: <span style="color:#ae81ff">None</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">HOOKS</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">MANIFEST</span>:
</span></span><span style="display:flex;"><span>---  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Source: nginx/templates/service.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>:   <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>:  <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>: 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        -  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span> 
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">80</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">NodePort</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Source: nginx/templates/deployment.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">strategy</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>                - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">env: - name: hello value</span>: <span style="color:#ae81ff">123</span></span></span></code></pre></div></blockquote>
</blockquote>
<ul>
<li>
<ol start="4">
<li><code>range</code><!-- raw HTML omitted -->循环块<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>在<code>Helm</code>模板语言中，使用<code>range</code>关键字来进行循环操作</li>
<li>在<code>values.yaml</code>中添加一个变量列表：</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">test</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">1</span> 
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">2</span> 
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">3</span></span></span></code></pre></div><ul>
<li>4.3 循环打印该列表：</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1 </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ConfigMap </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>:    {{   <span style="color:#ae81ff">.Release.Name    }} </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">data</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">test</span>:    
</span></span><span style="display:flex;"><span>        {{- <span style="color:#ae81ff">range . Values.test }}</span>
</span></span><span style="display:flex;"><span>            {{   <span style="color:#ae81ff">.    }}</span>
</span></span><span style="display:flex;"><span>        {{-   <span style="color:#ae81ff">end   }}</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><code>with</code><!-- raw HTML omitted -->指定范围<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>with</code><!-- raw HTML omitted -->可以用来控制变量作用域<!-- raw HTML omitted --></li>
<li>前面我们使用<code>{{ .Release.xxx }}</code>或者<code>{{ .Values.xxx }}</code>，其中.就是表示对当前范围的引用，<code>.values</code>就是告诉模板在当前范围中查找Values对象的值</li>
<li><code>with</code><!-- raw HTML omitted -->语句就可以用来控制变量的作用域范围，其语法和一个简单的if语句类似：<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>{{ <span style="color:#ae81ff">with 条件表达式 }}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># xxx</span>
</span></span><span style="display:flex;"><span>{{ <span style="color:#ae81ff">end }}</span></span></span></code></pre></div><ul>
<li><code>with</code><!-- raw HTML omitted -->语句可以允许将当前范围的.设置为特定的对象，比如我们前面一直使用的<code>.Values.label</code>，我们可以使用with来将.范围指向<!-- raw HTML omitted --><code>.Values.label</code>示例：<code>values.yaml</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">nodeSelector</span>: 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">team</span>: <span style="color:#ae81ff">a </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">gpu</span>:   <span style="color:#66d9ef">yes</span></span></span></code></pre></div><ul>
<li><code>deployment.yaml</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>:   <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>:   <span style="color:#ae81ff">Deployment </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: {{ <span style="color:#ae81ff">.Release.Name }}-deployment </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">matchLabels</span>: 
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">template</span>: 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">labels</span>: 
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>            {{- <span style="color:#ae81ff">with .Values.nodeSelector }}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">nodeSelector</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">team</span>: {{  <span style="color:#ae81ff">.team }}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">gpu</span>: {{  <span style="color:#ae81ff">.gpu  }}</span>
</span></span><span style="display:flex;"><span>            {{- <span style="color:#ae81ff">end }}</span></span></span></code></pre></div></blockquote>
<hr>
<h2 id="命名模板">命名模板</h2>
<ul>
<li>
<ol>
<li>需要复用代码的地方可以使用命名模板</li>
</ol>
</li>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->命名模板：<!-- raw HTML omitted -->使用<code>define</code>定义，<code>template</code>引入，在<code>templates</code>目录中默认下划线开头的文件为公共模板,比如：<code>_helpers.tpl</code>。</li>
</ol>
</li>
<li>
<ol start="3">
<li>示例：<code> _helpers.tpl</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>{{-   <span style="color:#ae81ff">define   &#34;demo.fullname&#34;   -}}</span>
</span></span><span style="display:flex;"><span>{{- <span style="color:#ae81ff">.Chart.Name -}}-{{ .Release.Name }}</span>
</span></span><span style="display:flex;"><span>{{-   <span style="color:#ae81ff">end   -}}</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><code>deployment.yaml</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>:   <span style="color:#ae81ff">apps/v1 </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>:   <span style="color:#ae81ff">Deployment </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">name</span>:  {{   <span style="color:#ae81ff">template&#34;demo.fullname&#34;   .    }}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 其他略</span></span></span></code></pre></div><ul>
<li><code>template</code><!-- raw HTML omitted -->指令是将一个模板包含在另一个模板中的方法。但是，<code>template</code>函数不能用于<code>Go</code>模板管道，为了解决该问题，增加了<code>include</code>功能<!-- raw HTML omitted --></li>
<li><code>_helpers.tpl：</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>{{-   <span style="color:#ae81ff">define   &#34;demo.labels&#34;    -}}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">app</span>:   {{   <span style="color:#ae81ff">template&#34;demo.fullname&#34;   .   }}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">chart</span>:   <span style="color:#e6db74">&#34;{{   .Chart.Name   }}-{{    .Chart.Version   }}&#34;</span> 
</span></span><span style="display:flex;"><span><span style="color:#f92672">release</span>:   <span style="color:#e6db74">&#34;{{   .Release.Name   }}&#34;</span>
</span></span><span style="display:flex;"><span>{{-   <span style="color:#ae81ff">end   -}}</span></span></span></code></pre></div><ul>
<li>4.3 <code>deployment.yaml</code></li>
</ul>
<blockquote>
<p>下面包含一个名为<code>demo.labels</code>的模板，然后将值  . 传递给模板，最后将该模板的 输出传递给<code>nindent</code>函数。</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>:   <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>:   <span style="color:#ae81ff">Deployment </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">name</span>:    {{   <span style="color:#ae81ff">include&#34;demo.fullname&#34;   .    }} </span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        {{-   <span style="color:#ae81ff">include   &#34;demo.labels&#34;   .    |   nindent   4    }}</span>
</span></span><span style="display:flex;"><span>...</span></span></code></pre></div></blockquote>
</blockquote>

<pre class="mermaid align-center zoomable">graph LR
A(创建模板) --&gt;B(修改Chart.yaml Values.yaml文件&lt;br&gt;添加常用变量&lt;br&gt;)
    B --&gt; C(在Templates目录下创建部署镜像所需的yaml文件&lt;br&gt;并且使用变量&lt;br&gt;引用yaml文件里面的常变动字段&lt;br&gt;)
    
    C --&gt;|a=1| D{暂未启用}
    C --&gt;|a=2| E[暂未启用]
    F[开发自己的chart]</pre><hr>
<h2 id="使用helm安装jenkins">使用<code>Helm</code>安装<code>Jenkins</code></h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->获取更新仓库信息<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm repo add jenkins https://charts.jenkins.io
</span></span><span style="display:flex;"><span>$ helm repo update</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->查看已经添加的<!-- raw HTML omitted --><code>helm</code><!-- raw HTML omitted -->仓库<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm repo list</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->搜索仓库中的<!-- raw HTML omitted --><code>Jenkins</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm search repo jenkins
</span></span><span style="display:flex;"><span>NAME           	CHART VERSION	APP VERSION	DESCRIPTION                                       
</span></span><span style="display:flex;"><span>jenkins/jenkins	4.2.5        	2.361.1    	Jenkins - Build great things at any scale! The ...</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted --> 查看、下载<!-- raw HTML omitted --><code>Jenkins</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm show values jenkins/jenkins
</span></span><span style="display:flex;"><span>$ helm pull jenkins/jenkins  	<span style="color:#75715e"># 下载 Jenkins 安装包</span>
</span></span><span style="display:flex;"><span>$ tar -zxvf jenkins-3.5.9.tgz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sed -i -e <span style="color:#e6db74">&#39;/#/d;/^$/d&#39;</span> values.yaml  	<span style="color:#75715e"># 去掉注释和空行后修改</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->安装以及查看登录名和密码<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm install jenkins ./jenkins
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看登录的用户名</span>
</span></span><span style="display:flex;"><span>$  kubectl exec jenkins-0 -- cat /run/secrets/chart-admin-username
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看登录的密码</span>
</span></span><span style="display:flex;"><span>$  kubectl exec jenkins-0 -- cat /run/secrets/chart-admin-password</span></span></code></pre></div></blockquote>
<hr>
<h2 id="使用helm安装redis">使用<code>Helm</code>安装<code>Redis</code></h2>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->添加<!-- raw HTML omitted --><code>Bitnami</code><!-- raw HTML omitted -->仓库<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm repo add bitnami https://charts.bitnami.com/bitnami
</span></span><span style="display:flex;"><span>$ helm repo list
</span></span><span style="display:flex;"><span>$ helm search repo redis</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->下载、配置安装包<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm pull bitnami/redis
</span></span><span style="display:flex;"><span>$ tar xvf redis-18.8.0.tgz</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>values.yaml</code></li>
</ul>
<blockquote>
<ul>
<li><code>StorageClass</code><!-- raw HTML omitted -->的名字，如果<!-- raw HTML omitted --><code>storageClass</code><!-- raw HTML omitted -->不正常，<!-- raw HTML omitted --><code>redis</code><!-- raw HTML omitted -->启动不了<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">imageRegistry</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">imagePullSecrets</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">storageClass</span>: <span style="color:#e6db74">&#34;nfs-storage-template&#34;</span>    <span style="color:#75715e"># StorageClass 的名字，如果storageClass不正常，redis启动不了</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">redis</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">password</span>: <span style="color:#e6db74">&#34;Password&#34;</span>    <span style="color:#75715e"># redis 连接密码</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kubeVersion</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">nameOverride</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">fullnameOverride</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">namespaceOverride</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">commonLabels</span>: {}
</span></span><span style="display:flex;"><span><span style="color:#f92672">commonAnnotations</span>: {}
</span></span><span style="display:flex;"><span><span style="color:#f92672">secretAnnotations</span>: {}
</span></span><span style="display:flex;"><span><span style="color:#f92672">clusterDomain</span>: <span style="color:#ae81ff">cluster.local</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">extraDeploy</span>: []
</span></span><span style="display:flex;"><span><span style="color:#f92672">useHostnames</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">nameResolutionThreshold</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">nameResolutionTimeout</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">diagnosticMode</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">command</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">sleep</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">args</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">infinity</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">image</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">registry</span>: <span style="color:#ae81ff">docker.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">repository</span>: <span style="color:#ae81ff">bitnami/redis</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tag</span>: <span style="color:#ae81ff">7.2.4</span>-<span style="color:#ae81ff">debian-11-r2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">digest</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">pullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">pullSecrets</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">debug</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">architecture</span>: <span style="color:#ae81ff">replication  </span> <span style="color:#75715e"># standalone:单节点部署，replication：一主三从配置</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">auth</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">sentinel</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">password</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">existingSecret</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">existingSecretPasswordKey</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">usePasswordFiles</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">commonConfiguration</span>: |-<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  appendonly yes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  save &#34;&#34;</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">existingConfigmap</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">master</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">count</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">configuration</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">disableCommands</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">FLUSHDB</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">FLUSHALL</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">command</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">args</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enableServiceLinks</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">preExecCmds</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraFlags</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraEnvVars</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraEnvVarsCM</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraEnvVarsSecret</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containerPorts</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">redis</span>: <span style="color:#ae81ff">6379</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">startupProbe</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">livenessProbe</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">readinessProbe</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">customStartupProbe</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">customLivenessProbe</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">customReadinessProbe</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">limits</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">requests</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podSecurityContext</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">fsGroupChangePolicy</span>: <span style="color:#ae81ff">Always</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sysctls</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">supplementalGroups</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">fsGroup</span>: <span style="color:#ae81ff">1001</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containerSecurityContext</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">seLinuxOptions</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">runAsUser</span>: <span style="color:#ae81ff">1001</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">runAsGroup</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">runAsNonRoot</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">allowPrivilegeEscalation</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">seccompProfile</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RuntimeDefault</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">capabilities</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">drop</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">ALL</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">StatefulSet</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">schedulerName</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">updateStrategy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">minReadySeconds</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">priorityClassName</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">automountServiceAccountToken</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hostAliases</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podLabels</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podAnnotations</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">shareProcessNamespace</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podAffinityPreset</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podAntiAffinityPreset</span>: <span style="color:#ae81ff">soft</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nodeAffinityPreset</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">key</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">values</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">affinity</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nodeSelector</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tolerations</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">topologySpreadConstraints</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">dnsPolicy</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">dnsConfig</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">lifecycleHooks</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraVolumes</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraVolumeMounts</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">sidecars</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">initContainers</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">persistence</span>:    <span style="color:#75715e"># 持久化配置</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>   <span style="color:#75715e"># 默认启用</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">medium</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sizeLimit</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/data  </span> <span style="color:#75715e"># 存储目录</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">subPath</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">subPathExpr</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">storageClass</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">accessModes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">ReadWriteOnce</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">size</span>: <span style="color:#ae81ff">2Gi  </span> <span style="color:#75715e"># Master 主节点默认使用空间</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">selector</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">dataSource</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">existingClaim</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">persistentVolumeClaimRetentionPolicy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">whenScaled</span>: <span style="color:#ae81ff">Retain</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">whenDeleted</span>: <span style="color:#ae81ff">Retain</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">service</span>:    <span style="color:#75715e"># 服务端口配置</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">redis</span>: <span style="color:#ae81ff">6379</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nodePorts</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">redis</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">externalTrafficPolicy</span>: <span style="color:#ae81ff">Cluster</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">extraPorts</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">internalTrafficPolicy</span>: <span style="color:#ae81ff">Cluster</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">clusterIP</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">loadBalancerIP</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">loadBalancerClass</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">loadBalancerSourceRanges</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">externalIPs</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sessionAffinity</span>: <span style="color:#ae81ff">None</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sessionAffinityConfig</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">terminationGracePeriodSeconds</span>: <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">serviceAccount</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">create</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">automountServiceAccountToken</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>: {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">replica</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">StatefulSet</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicaCount</span>: <span style="color:#ae81ff">2</span>  	<span style="color:#75715e"># 从节点副本数量</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">configuration</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">disableCommands</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">FLUSHDB</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">FLUSHALL</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">command</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">args</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enableServiceLinks</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">preExecCmds</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraFlags</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraEnvVars</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraEnvVarsCM</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraEnvVarsSecret</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">externalMaster</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">host</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">6379</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containerPorts</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">redis</span>: <span style="color:#ae81ff">6379</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">startupProbe</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">22</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">livenessProbe</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">readinessProbe</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">customStartupProbe</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">customLivenessProbe</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">customReadinessProbe</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">limits</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   cpu: 250m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   memory: 256Mi</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">requests</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   cpu: 250m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   memory: 256Mi</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podSecurityContext</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">fsGroupChangePolicy</span>: <span style="color:#ae81ff">Always</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sysctls</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">supplementalGroups</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">fsGroup</span>: <span style="color:#ae81ff">1001</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containerSecurityContext</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">seLinuxOptions</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">runAsUser</span>: <span style="color:#ae81ff">1001</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">runAsGroup</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">runAsNonRoot</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">allowPrivilegeEscalation</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">seccompProfile</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RuntimeDefault</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">capabilities</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">drop</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">ALL</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">schedulerName</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">updateStrategy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">minReadySeconds</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">priorityClassName</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podManagementPolicy</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">automountServiceAccountToken</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hostAliases</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podLabels</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podAnnotations</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">shareProcessNamespace</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podAffinityPreset</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podAntiAffinityPreset</span>: <span style="color:#ae81ff">soft</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nodeAffinityPreset</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">key</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">values</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">affinity</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nodeSelector</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tolerations</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">topologySpreadConstraints</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">dnsPolicy</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">dnsConfig</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">lifecycleHooks</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraVolumes</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraVolumeMounts</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">sidecars</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">initContainers</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">persistence</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">medium</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sizeLimit</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/data</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">subPath</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">subPathExpr</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">storageClass</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">accessModes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">ReadWriteOnce</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">size</span>: <span style="color:#ae81ff">2Gi  	# 从节点使用磁盘空间</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">selector</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">dataSource</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">existingClaim</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">persistentVolumeClaimRetentionPolicy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">whenScaled</span>: <span style="color:#ae81ff">Retain</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">whenDeleted</span>: <span style="color:#ae81ff">Retain</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">redis</span>: <span style="color:#ae81ff">6379</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nodePorts</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">redis</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">externalTrafficPolicy</span>: <span style="color:#ae81ff">Cluster</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">internalTrafficPolicy</span>: <span style="color:#ae81ff">Cluster</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">extraPorts</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">clusterIP</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">loadBalancerIP</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">loadBalancerClass</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">loadBalancerSourceRanges</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sessionAffinity</span>: <span style="color:#ae81ff">None</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sessionAffinityConfig</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">terminationGracePeriodSeconds</span>: <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">autoscaling</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">minReplicas</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">maxReplicas</span>: <span style="color:#ae81ff">11</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetCPU</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetMemory</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">serviceAccount</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">create</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">automountServiceAccountToken</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>: {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">sentinel</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">image</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">registry</span>: <span style="color:#ae81ff">docker.io</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">repository</span>: <span style="color:#ae81ff">bitnami/redis-sentinel</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tag</span>: <span style="color:#ae81ff">7.2.4</span>-<span style="color:#ae81ff">debian-11-r3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">digest</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">pullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">pullSecrets</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">debug</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">annotations</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">masterSet</span>: <span style="color:#ae81ff">mymaster</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">quorum</span>: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">getMasterTimeout</span>: <span style="color:#ae81ff">90</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">automateClusterRecovery</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">redisShutdownWaitFailover</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">downAfterMilliseconds</span>: <span style="color:#ae81ff">60000</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">failoverTimeout</span>: <span style="color:#ae81ff">180000</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">parallelSyncs</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">configuration</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">command</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">args</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enableServiceLinks</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">preExecCmds</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraEnvVars</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraEnvVarsCM</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraEnvVarsSecret</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">externalMaster</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">host</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">6379</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containerPorts</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sentinel</span>: <span style="color:#ae81ff">26379</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">startupProbe</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">22</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">livenessProbe</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">readinessProbe</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">customStartupProbe</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">customLivenessProbe</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">customReadinessProbe</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">persistence</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">storageClass</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">accessModes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">ReadWriteOnce</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">size</span>: <span style="color:#ae81ff">100Mi</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">selector</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">dataSource</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">medium</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sizeLimit</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">persistentVolumeClaimRetentionPolicy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">whenScaled</span>: <span style="color:#ae81ff">Retain</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">whenDeleted</span>: <span style="color:#ae81ff">Retain</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">limits</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">requests</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containerSecurityContext</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">seLinuxOptions</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">runAsUser</span>: <span style="color:#ae81ff">1001</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">runAsGroup</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">runAsNonRoot</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">allowPrivilegeEscalation</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">seccompProfile</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RuntimeDefault</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">capabilities</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">drop</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">ALL</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">lifecycleHooks</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraVolumes</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraVolumeMounts</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">redis</span>: <span style="color:#ae81ff">6379</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">sentinel</span>: <span style="color:#ae81ff">26379</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nodePorts</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">redis</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">sentinel</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">externalTrafficPolicy</span>: <span style="color:#ae81ff">Cluster</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">extraPorts</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">clusterIP</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">loadBalancerIP</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">loadBalancerClass</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">loadBalancerSourceRanges</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sessionAffinity</span>: <span style="color:#ae81ff">None</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sessionAffinityConfig</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">headless</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">annotations</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">terminationGracePeriodSeconds</span>: <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">serviceBindings</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">networkPolicy</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">allowExternal</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraIngress</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraEgress</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ingressNSMatchLabels</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ingressNSPodMatchLabels</span>: {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">metrics</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">allowExternal</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ingressNSMatchLabels</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ingressNSPodMatchLabels</span>: {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">podSecurityPolicy</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">create</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rbac</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">create</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>: []
</span></span><span style="display:flex;"><span><span style="color:#f92672">serviceAccount</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">create</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">automountServiceAccountToken</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">annotations</span>: {}
</span></span><span style="display:flex;"><span><span style="color:#f92672">pdb</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">create</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">minAvailable</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">maxUnavailable</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">tls</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">authClients</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">autoGenerated</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">existingSecret</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">certificatesSecret</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">certFilename</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">certKeyFilename</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">certCAFilename</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">dhParamsFilename</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metrics</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">image</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">registry</span>: <span style="color:#ae81ff">docker.io</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">repository</span>: <span style="color:#ae81ff">bitnami/redis-exporter</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tag</span>: <span style="color:#ae81ff">1.56.0</span>-<span style="color:#ae81ff">debian-11-r1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">digest</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">pullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">pullSecrets</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">startupProbe</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">livenessProbe</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">readinessProbe</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">customStartupProbe</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">customLivenessProbe</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">customReadinessProbe</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">command</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">redisTargetHost</span>: <span style="color:#e6db74">&#34;localhost&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraArgs</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraEnvVars</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containerSecurityContext</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">seLinuxOptions</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">runAsUser</span>: <span style="color:#ae81ff">1001</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">runAsGroup</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">runAsNonRoot</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">allowPrivilegeEscalation</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">seccompProfile</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RuntimeDefault</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">capabilities</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">drop</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">ALL</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraVolumes</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraVolumeMounts</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">limits</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">requests</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podLabels</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podAnnotations</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">prometheus.io/scrape</span>: <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">prometheus.io/port</span>: <span style="color:#e6db74">&#34;9121&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">9121</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">externalTrafficPolicy</span>: <span style="color:#ae81ff">Cluster</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">extraPorts</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">loadBalancerIP</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">loadBalancerClass</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">loadBalancerSourceRanges</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">clusterIP</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">serviceMonitor</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">namespace</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">interval</span>: <span style="color:#ae81ff">30s</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scrapeTimeout</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabellings</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metricRelabelings</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">honorLabels</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">additionalLabels</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">podTargetLabels</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sampleLimit</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetLimit</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podMonitor</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">namespace</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">interval</span>: <span style="color:#ae81ff">30s</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scrapeTimeout</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabellings</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metricRelabelings</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">honorLabels</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">additionalLabels</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">podTargetLabels</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sampleLimit</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetLimit</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">prometheusRule</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">namespace</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">additionalLabels</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rules</span>: []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">volumePermissions</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">image</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">registry</span>: <span style="color:#ae81ff">docker.io</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">repository</span>: <span style="color:#ae81ff">bitnami/os-shell</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tag</span>: <span style="color:#ae81ff">11</span>-<span style="color:#ae81ff">debian-11-r94</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">digest</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">pullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">pullSecrets</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">limits</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">requests</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containerSecurityContext</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">seLinuxOptions</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">runAsUser</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">sysctl</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">image</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">registry</span>: <span style="color:#ae81ff">docker.io</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">repository</span>: <span style="color:#ae81ff">bitnami/os-shell</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tag</span>: <span style="color:#ae81ff">11</span>-<span style="color:#ae81ff">debian-11-r94</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">digest</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">pullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">pullSecrets</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">command</span>: []
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">mountHostSys</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">limits</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">requests</span>: {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">useExternalDNS</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">suffix</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">annotationKey</span>: <span style="color:#ae81ff">external-dns.alpha.kubernetes.io/</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">additionalAnnotations</span>: {}</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>Redis</code><!-- raw HTML omitted -->形成<!-- raw HTML omitted --><code>Release</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm install release-name project-dir -n namespace
</span></span><span style="display:flex;"><span>$ helm install redis ./redis/ -n default</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->登录<!-- raw HTML omitted --><code>Redis</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl exec --tty -i redis-master-0 --namespace default -- bash
</span></span><span style="display:flex;"><span>$ kubectl exec --tty -i redis-replicas-1 --namespace default -- bash</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->升级<!-- raw HTML omitted --><code>Redis</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm upgrade redis ./redis/ -n default</span></span></code></pre></div></blockquote>
<hr>
<h2 id="使用helm安装prometheus">使用<code>Helm</code>安装<code>Prometheus</code></h2>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/prometheus-operator/kube-prometheus" rel="external" target="_self"><code>kube-prometheus</code></a></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h2 id="使用helm安装elk">使用<code>Helm</code>安装<code>ELK</code></h2>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="configure_k8s_auth">Configure_K8s_Auth</h1>

<h2 id="安全控制">安全控制</h2>
<h3 id="访问控制">访问控制</h3>
<ul>
<li>
<ol>
<li><code>kubernetes</code>作为一个分布式集群的管理工具，保证集群的安全性是其一个重要的任务。所谓的安全性其实就是保证对<code>kubernetes</code>的各种客户端进行认证和授权操作</li>
</ol>
</li>
<li>
<ol start="2">
<li>在<code>kubernetes</code>集群中，客户端通常由两类：</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>User Account</code><!-- raw HTML omitted -->：一般是独立于<!-- raw HTML omitted --><code>kubernetes</code><!-- raw HTML omitted -->之外的其他服务管理的用户账号<!-- raw HTML omitted --></li>
<li><code>Service Account</code>：<code>kubernetes</code><!-- raw HTML omitted -->管理的账号，用于为<!-- raw HTML omitted --><code>Pod</code><!-- raw HTML omitted -->的服务进程在访问<!-- raw HTML omitted --><code>kubernetes</code><!-- raw HTML omitted -->时提供身份标识<!-- raw HTML omitted --></li>
</ul>

<pre class="mermaid align-center zoomable">graph LR
C1((用户)) --&gt; B1(User&lt;br&gt;Account) --&gt; A((Kubernetes))
C2((Pod)) --&gt; B2(Service&lt;br&gt;Account) --&gt; A((Kubernetes))</pre></blockquote>
<hr>
<h3 id="认证授权和准入控制">认证、授权和准入控制</h3>
<ul>
<li>
<ol>
<li><code>API Server</code><!-- raw HTML omitted -->是访问和管理资源对象的唯一入口。任何一个请求访问<!-- raw HTML omitted --><code>API Server</code>，<!-- raw HTML omitted -->都要经过下面的三个流程：<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>Authentication</code>(认证)<!-- raw HTML omitted -->：身份鉴别，只有正确的账号才能通过认证<!-- raw HTML omitted --></li>
<li><code>Authorization</code>(授权)<!-- raw HTML omitted -->：权限鉴别，判断用户是否有权限对访问的资源执行特定的动作<!-- raw HTML omitted --></li>
<li><code>Admission Control</code>(准入控制)<!-- raw HTML omitted -->：精细访问控制，用于补充授权机制以实现更加精细的访问控制功能<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->需要注意：<!-- raw HTML omitted -->在<code>Kubernetes</code>中不能通过<code>API</code>调用将普通用户添加到集群中</li>
</ul>
<blockquote>
<ul>
<li>普通账户是针对（人）用户的，服务账户针对<code>Pods</code>进程</li>
<li>普通账户是全局性，在集群所有<code>namespaces</code>中，名称具有唯一性</li>
<li>通常，集群的普通账户可以与企业数据库同步，新的普通账户创建需要特殊权限，服务账户创建目的是更轻量化，允许集群用户为特定任务创建服务账户</li>
<li>普通账户和服务账户的审核注意事项不同</li>
<li>对于复杂系统的配置包，可以包括对该系统的各种组件的服务账户的定义</li>
</ul>
</blockquote>

<pre class="mermaid align-center zoomable">graph LR
A((请求)) --&gt; B[Authentication&lt;br&gt;认证&lt;br&gt;身份鉴别&lt;br&gt;] --&gt; C[Authorization&lt;br&gt;授权&lt;br&gt;权限鉴别&lt;br&gt;] --&gt; D[Admission Control&lt;br&gt;注入控制&lt;br&gt;精细访问控制&lt;br&gt;] --&gt; E((Kubernetes&lt;br&gt;资源))</pre></blockquote>
<hr>
<h4 id="认证管理">认证管理</h4>
<h5 id="user-accounts普通账户"><code>User Accounts</code>(普通账户)</h5>
<hr>
<h5 id="service-accounts服务账户"><code>Service Accounts</code>(服务账户)</h5>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount   </span> <span style="color:#75715e"># 权限管理</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span></span></span></code></pre></div></blockquote>
<hr>
<h5 id="kubernetesfont-colorred的客户端fonthttpfont-colorred和fonthttpsfont-colorred身份认证方式font"><code>kubernetes</code><!-- raw HTML omitted -->的客户端<!-- raw HTML omitted --><code>http</code><!-- raw HTML omitted -->和<!-- raw HTML omitted --><code>https</code><!-- raw HTML omitted -->身份认证方式<!-- raw HTML omitted --></h5>
<ul>
<li>
<ol>
<li><code>kubernetes</code><!-- raw HTML omitted -->允许同时配置多种认证方式，<!-- raw HTML omitted -->只要其中任意一种方式认证通过即可</li>
</ol>
</li>
<li>
<ol start="2">
<li><code>kubernetes</code>集群安全的关键点在于如何识别并认证客户端身份，它提供了<code>3</code>种客户端身份认证方式</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>2.1 <code>HTTP Base</code><!-- raw HTML omitted -->认证：<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->通过用户名+密码的方式进行认证，<!-- raw HTML omitted -->这种方式是把<code>用户名:密码</code>用<code>BASE64</code>算法进行编码后的字符串放在<code>HTTP</code>请求中的<code>Header</code>的<code>Authorization</code>域里面发送给服务端。服务端收到后进行解码，获取用户名和密码，然后进行用户身份认证的过程</li>
</ul>
</blockquote>
<ul>
<li>2.2 <code>HTTP Token</code><!-- raw HTML omitted -->认证：<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->通过一个<code>Token</code>来识别合法用户，<!-- raw HTML omitted -->这种认证方式是用一个很长的难以被模仿的字符串<code>--Token</code>来表明客户端身份的一种方式。每个<code>Token</code>对应一个用户名，当客户端发起<code>API</code>调用请求的时候，需要在<code>HTTP</code>的<code>Header</code>中放入<code>Token</code>，<code>API Server</code>接受到<code>Token</code>后会和服务器中保存的<code>Token</code>进行比对，然后进行用户身份认证的过程。</li>
</ul>
</blockquote>
<ul>
<li>2.3 <code>HTTPS</code><!-- raw HTML omitted -->证书认证： <!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->基于<code>CA</code>根证书签名的双向数字证书认证方式，<!-- raw HTML omitted -->这种认证方式是安全性最高的一种方式，但是同时也是操作起来最麻烦的一种方式</li>
<li><!-- raw HTML omitted -->证书申请和下发：<!-- raw HTML omitted --><code>HTTPS</code>通信双方的服务器向<code>CA</code>机构申请证书，<code>CA</code>机构发根证书、服务端证书及私钥给申请者</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->客户端和服务器的双向认证<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<blockquote>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->客户端向服务端发起请求，<!-- raw HTML omitted -->服务端下发自己的证书给客户端。客户端收到证书后，通过私钥解密证书，在证书中获取服务端的私钥。客户端利用服务器端的公钥认证证书中的信息，如果一致，则认可这个服务器。</li>
<li><!-- raw HTML omitted -->客户端发送自己的证书给服务器端，<!-- raw HTML omitted -->服务端接收到证书后，通过私钥解密证书。在证书中获取客户端的公钥，并用该公钥认证证书信息，确认客户端是否合法。</li>
</ul>
</blockquote>
</blockquote>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->服务器端和客户端进行通信<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<blockquote>
<blockquote>
<ul>
<li>服务器端和客户端协商好加密方案后，客户端会产生一个随机的私钥并加密，然后发送到服务器端</li>
<li>服务器端接收到这个私钥后，双方接下来通信的所有内容都通过该随机私钥加密</li>
</ul>
</blockquote>
</blockquote>

<pre class="mermaid align-center zoomable">graph TB
A((CA机构)) -- 申请证书 --&gt;B((服务端))
A((CA机构)) -- 申请证书 --&gt; C((客户端))
B((服务端)) -- 下发证书 --&gt; A((CA机构))
C((客户端)) -- 下发证书 --&gt; A((CA机构))

B((服务端)) &lt;-- 双向身份认证 --&gt; C((客户端))
B((服务端)) &lt;-- 双向通信 --&gt; C((客户端))</pre></blockquote>
<hr>
<h4 id="授权管理">授权管理</h4>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->授权发生在认证成功之后，<!-- raw HTML omitted -->通过认证就可以知道请求用户是谁，然后<code>kubernetes</code>会根据事先定义的授权策略来决定用户是否有权限访问，这个过程就称为授权</li>
</ol>
</li>
<li>
<ol start="2">
<li>每个发送到<code>API Server</code>的请求都带上了用户和资源的信息：比如发送请求的用户、请求的路径、请求的动作等，授权就是根据这些信息和授权策略进行比较，如果符合策略，则认为授权通过，否则会返回错误。</li>
</ol>
</li>
<li>
<ol start="3">
<li><code>API Server</code>目前支持的几种授权策略</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>AlwaysDeny</code><!-- raw HTML omitted -->：表示拒绝所有请求，一般用于测试<!-- raw HTML omitted --></li>
<li><code>AlwaysAllow</code><!-- raw HTML omitted -->：允许接收所有的请求，相当于集群不需要授权流程（<code>kubernetes</code>默认的策略）<!-- raw HTML omitted --></li>
<li><code>ABAC</code><!-- raw HTML omitted -->：基于属性的访问控制，表示使用用户配置的授权规则对用户请求进行匹配和控制<!-- raw HTML omitted --></li>
<li><code>Webhook</code><!-- raw HTML omitted -->：通过调用外部<code>REST</code>服务对用户进行授权<!-- raw HTML omitted --></li>
<li><code>Node</code><!-- raw HTML omitted -->：是一种专用模式，用于对<code>kubelet</code>发出的请求进行访问控制<!-- raw HTML omitted --></li>
<li><code>RBAC</code><!-- raw HTML omitted -->：基于角色的访问控制（<code>kubeadm</code>安装方式下的默认选项）<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<hr>
<h5 id="rbac基于角色的访问控制"><code>RBAC</code>基于角色的访问控制</h5>
<blockquote>
<ul>
<li><code>RBAC</code><!-- raw HTML omitted -->基于角色的访问控制<!-- raw HTML omitted -->(<code>Role Based Access Control</code>)<!-- raw HTML omitted -->主要是在描述一件事情：给哪些对象授权了哪些权限<!-- raw HTML omitted --></li>
<li><code>RBAC</code>涉及到了下面几个概念：</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->对象：<!-- raw HTML omitted --><code>User</code>、<code>Groups</code>、<code>ServiceAccount</code>。</li>
<li><!-- raw HTML omitted -->角色：<!-- raw HTML omitted -->代表着一组定义在资源上的可操作的动作（权限）的集合</li>
<li><!-- raw HTML omitted -->绑定：<!-- raw HTML omitted -->将定义好的角色和用户绑定在一起</li>
</ul>
</blockquote>
<ul>
<li><code>RBAC</code>引入的<code>4</code>个顶级资源对象：</li>
</ul>
<blockquote>
<ul>
<li><code>Role</code>(角色)<!-- raw HTML omitted -->，用于指定一组权限<!-- raw HTML omitted --></li>
<li><code>ClusterRole</code>(集群角色)<!-- raw HTML omitted -->，用于指定一组权限<!-- raw HTML omitted --></li>
<li><code>RoleBinding</code>(角色绑定)<!-- raw HTML omitted -->，用于将角色（权限的集合）赋予给对象<!-- raw HTML omitted --></li>
<li><code>ClusterRoleBinding</code>(集群角色绑定)<!-- raw HTML omitted -->，用于将角色（权限的集合）赋予给对象<!-- raw HTML omitted --></li>
</ul>
</blockquote>

<pre class="mermaid align-center zoomable">graph TB
A1(Group) --- A[RoleBinding]
A2(User) --- A[RoleBinding]
A3(Service&lt;br&gt;Account) --- A[RoleBinding]

A[RoleBinding] --- B[Role]

B[Role] --- Pod --- |a=1|B1[List]
B[Role] --- Pod --- |a=2|B2[Get]
B[Role] --- Pod --- |a=3|B3[Watch]

B[Role] --- Deployment --- |b=1|B4[List]
B[Role] --- Deployment --- |b=2|B5[Get]
B[Role] --- Deployment --- |b=3|B6[Watch]</pre></blockquote>
<hr>
<h5 id="role普通角色"><code>Role</code>(普通角色)</h5>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->一个角色就是一组权限的集合，这里的权限都是许可形式的（白名单）<!-- raw HTML omitted --></li>
<li><code>Role</code><!-- raw HTML omitted -->只能对命名空间的资源进行授权，需要指定<!-- raw HTML omitted --><code>namespace</code></li>
</ul>
</blockquote>
<ul>
<li>
<ol>
<li><code>rules:</code><!-- raw HTML omitted -->中的参数说明：<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl explain role.rules.resources  	<span style="color:#75715e"># 显示 resources 使用方式</span></span></span></code></pre></div><ul>
<li>1.1 <code>apiGroups:</code></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->支持的<!-- raw HTML omitted --><code>API</code><!-- raw HTML omitted -->组列表，<!-- raw HTML omitted --><code>&quot;&quot;</code>,<code>&quot;apps&quot;</code>,<code>&quot;autoscaling</code>&quot;&quot;,<code>&quot;batch&quot;</code>。</li>
</ul>
</blockquote>
<ul>
<li>1.2 <code>resources:</code></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->支持的资源对象列表，<!-- raw HTML omitted --><code>&quot;namespaces&quot;</code>,<code>&quot;services&quot;</code>,<code>&quot;endpoints&quot;</code>,<code>&quot;pods&quot;</code>,<code>&quot;secrets&quot;</code>,<code>&quot;configmaps&quot;</code>,<code>&quot;crontabs&quot;</code>,<code>&quot;deployments&quot;</code>,<code>&quot;jobs&quot;</code>,<code>&quot;nodes&quot;</code>,<code>&quot;rolebindings&quot;</code>,<code>&quot;clusterroles&quot;</code>,<code>&quot;daemonsets&quot;</code>,<code>&quot;replicasets&quot;</code>,<code>&quot;statefulsets&quot;</code>,<code>&quot;horizontalpodautoscalers&quot;</code>,<code>&quot;replicationcontrollers&quot;</code>,<code>&quot;cronjobs&quot;</code></li>
</ul>
</blockquote>
<ul>
<li>1.3 <code>verbs:</code></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->对资源对象的操作方法列表，<!-- raw HTML omitted --><code>&quot;get&quot;</code>,<code> &quot;list&quot;</code>,<code> &quot;watch&quot;</code>,<code> &quot;create&quot;</code>,<code> &quot;update&quot;</code>,<code> &quot;patch&quot;</code>, <code>&quot;delete&quot;</code>,<code>&quot;exec&quot;</code></li>
</ul>
</blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Role</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">authorization-role</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">apiGroups</span>: [<span style="color:#e6db74">&#34;&#34;</span>]  	<span style="color:#75715e"># 支持的API组列表，&#34;&#34;空字符串，表示核心API群</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;pods&#34;</span>]  	<span style="color:#75715e"># 支持的资源对象列表</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;get&#34;</span>,<span style="color:#e6db74">&#34;watch&#34;</span>,<span style="color:#e6db74">&#34;list&#34;</span>]</span></span></code></pre></div></blockquote>
<hr>
<h5 id="rolebinding普通角色绑定"><code>RoleBinding</code>(普通角色绑定)</h5>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->角色绑定用来把一个角色绑定到一个目标对象上，绑定目标可以是<!-- raw HTML omitted --><code>User</code>、<code>Group</code>或者<code>ServiceAccount</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>RoleBinding</code>可以将同一<code>namespace</code>中的<code>subject</code>对象绑定到某个<code>Role</code>下，则此<code>Subject</code>具有该<code>Role</code>定义的权限</li>
<li><code>subjects:</code><!-- raw HTML omitted --><!-- raw HTML omitted --></li>
<li><code>roleRef:</code><!-- raw HTML omitted --><!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">RoleBinding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">authorization-role-binding</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">User  	# User，Group，ServiceAccoun  </span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">user-name</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io  </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Role</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">authorization-role</span></span></span></code></pre></div></blockquote>
<hr>
<h5 id="clusterrole集群角色"><code>ClusterRole</code>(集群角色)</h5>
<ul>
<li>
<ol>
<li><code>ClusterRole</code><!-- raw HTML omitted -->可以对集群范围内的资源、跨<code>namespace</code>的范围资源、非资源类型进行授权<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">name</span>: <span style="color:#ae81ff">authorization-clusterrole</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">apiGroups</span>: [<span style="color:#e6db74">&#34;&#34;</span>]  	<span style="color:#75715e"># 支持的API组列表，&#34;&#34;空字符串，表示核心API群</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;pods&#34;</span>]  	<span style="color:#75715e"># 支持的资源对象列表</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;get&#34;</span>,<span style="color:#e6db74">&#34;watch&#34;</span>,<span style="color:#e6db74">&#34;list&#34;</span>]</span></span></code></pre></div></blockquote>
<hr>
<h5 id="clusterrolebinding集群角色绑定"><code>ClusterRoleBinding</code>(集群角色绑定)</h5>
<blockquote>
<ul>
<li><code>ClusterRoleBinding</code>在整个集群级别和所有<code>namespaces</code>将特定的<code>subject</code>与<code>ClusterRole</code>绑定，授予权限</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRoleBinding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">authorization-clusterrole-binding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:  <span style="color:#75715e"># 应用什么类型的主体  </span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">User  	# User，Group，ServiceAccoun </span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">user-name  	# 对应的名字</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:  	<span style="color:#75715e"># 角色绑定 </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io  	# 对应的Api分组  </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole  	# 角色类型</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">authorization-clusterrole</span></span></span></code></pre></div></blockquote>
<hr>
<h4 id="准入控制">准入控制</h4>
<ul>
<li>
<ol>
<li>通过了前面的认证和授权之后，还需要经过准入控制通过之后，<code>API Server</code>才会处理这个请求。</li>
</ol>
</li>
<li>
<ol start="2">
<li>准入控制是一个可配置的控制器列表，可以通过在<code>API Server</code>上通过命令行设置选择执行哪些注入控制器。</li>
</ol>
</li>
<li>
<ol start="3">
<li>只有当所有的注入控制器都检查通过之后，<code>API Server</code>才会执行该请求，否则返回拒绝。</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,PersistentVolumeLabel,DefaultStorageClass,ResourceQuota,DefaultTolerationSeconds</span></span></code></pre></div></blockquote>
<hr>
<h5 id="admission-controlfont-colorred准入控制font"><code>Admission Control</code><!-- raw HTML omitted -->(准入控制)<!-- raw HTML omitted --></h5>
<blockquote>
<ul>
<li><code>AlwaysAdmit</code><!-- raw HTML omitted -->：允许所有请求<!-- raw HTML omitted --></li>
<li><code>AlwaysDeny</code><!-- raw HTML omitted -->：禁止所有请求，一般用于测试<!-- raw HTML omitted --></li>
<li><code>AlwaysPullImages</code><!-- raw HTML omitted -->：在启动容器之前总去下载镜像<!-- raw HTML omitted --></li>
<li><code>DenyExecOnPrivileged</code>：它会拦截所有想在<code>Privileged Container</code>上执行命令的请求</li>
<li><code>ImagePolicyWebhook</code>：这个插件将允许后端的一个<code>Webhook</code>程序来完成<code>admission controller</code>的功能</li>
<li><code>Service Account</code>：实现<code>ServiceAccount</code>实现了自动化</li>
<li><code>SecurityContextDeny</code>：这个插件将使用<code>SecurityContext</code>的<code>Pod</code>中的定义全部失效</li>
<li><code>ResourceQuota</code>：用于资源配额管理目的，观察所有请求，确保在<code>namespace</code>上的配额不会超标</li>
<li><code>LimitRanger</code>：用于资源限制管理，作用于<code>namespace</code>上，确保对<code>Pod</code>进行资源限制</li>
<li><code>InitialResources</code>：为未设置资源请求与限制的<code>Pod</code>，根据其镜像的历史资源的使用情况进行设置</li>
<li><code>NamespaceLifecycle</code>：如果尝试在一个不存在的<code>namespace</code>中创建资源对象，则该创建请求将被拒 绝。当删除一个<code>namespace</code>时，系统将会删除该<code>namespace</code>中所有对象</li>
<li><code>DefaultStorageClass</code>：为了实现共享存储的动态供应，为未指定<code>StorageClass</code>或<code>PV</code>的<code>PVC</code>尝试匹配默认<code>StorageClass</code>，尽可能减少用户在申请<code>PVC</code>时所需了解的后端存储细节</li>
<li><code>DefaultTolerationSeconds</code>：这个插件为那些没有设置<code>forgiveness tolerations</code>并具有<code>notready:NoExecute</code>和<code>unreachable:NoExecute</code>两种<code>taints</code>的<code>Pod</code>设置默认的<code>“容忍”</code>时间，为<code>5min</code></li>
<li><code>PodSecurityPolicy</code>：这个插件用于在创建或修改Pod时决定是否根据<code>Pod</code>的<code>security context</code>和可用的<code>PodSecurityPolicy</code>对<code>Pod</code>的安全策略进行控制</li>
</ul>
</blockquote>
<hr>
<h3 id="rbac实战"><code>RBAC</code>实战</h3>
<ul>
<li>
<ol>
<li>创建一个只能管理<code>dev</code>命名空间下<code>Pods</code>资源的账号。</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->创建密钥<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /etc/kubernetes/pki/
</span></span><span style="display:flex;"><span>$ <span style="color:#f92672">(</span>umask 077;openssl genrsa -out user-name.key 2048<span style="color:#f92672">)</span></span></span></code></pre></div><ul>
<li>用<code>API Server</code>的密钥去签署证书</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->证书申请：<!-- raw HTML omitted -->申请的用户是<code>user-name</code>，组是<code>group-name</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ openssl req -new -key user-name.key -out user-name.csr -subj <span style="color:#e6db74">&#34;/CN=user-name/O=group-name&#34;</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->签署证书<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ openssl x509 -req -in user-name.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out user-name.crt -days <span style="color:#ae81ff">3650</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->设置集群、用户、上下文信息：<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl config set-cluster kubernetes --embed-certs<span style="color:#f92672">=</span>true --certificate-authority<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca.crt --server<span style="color:#f92672">=</span>https://192.168.18.100:6443
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config set-credentials user-name --embed-certs<span style="color:#f92672">=</span>true --client-certificate<span style="color:#f92672">=</span>/etc/kubernetes/pki/user-name.crt --client-key<span style="color:#f92672">=</span>/etc/kubernetes/pki/user-name.key
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl config set-context user-name@kubernetes --cluster<span style="color:#f92672">=</span>kubernetes --user<span style="color:#f92672">=</span>user-name</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->测试账户、切换<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->切换账号到<!-- raw HTML omitted --><code>user-name</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl config use-context user-name@kubernetes</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->查看<code>default</code>下的<code>Pod</code>，发现没有权限：<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl get pods -n default</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->切换到<code>admin</code>账户：<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl config use-context kubernetes-admin@kubernetes</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h4 id="rolebindingfont-colorred引用fontclusterrolefont-colorred进行授权font"><code>RoleBinding</code><!-- raw HTML omitted -->引用<!-- raw HTML omitted --><code>ClusterRole</code><!-- raw HTML omitted -->进行授权<!-- raw HTML omitted --></h4>
<ul>
<li>
<ol>
<li><code>RoleBinding</code>(角色绑定)可以引用<code>ClusterRole</code>(集群角色)，对属于同一命名空间内<code>ClusterRole</code>定义的资源主体进行授权。</li>
</ol>
</li>
<li>
<ol start="2">
<li>一种很常用的做法是，集群管理员为集群范围预定义好一组角色<code>ClusterRole</code>，然后在多个命名空间中重复使用这些<code>ClusterRole</code>。这样可以大幅度提高授权管理工作效率，也使得各个命名空间下的基础性授权规则和使用体验保持一致。</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>虽然<code>authorization-clusterrole</code>是一个集群角色，但是因为使用了<code>RoleBinding</code>，所以<code>xudaxian</code>只能读取<code>default</code>命名空间中的资源</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">RoleBinding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">authorization-clusterrole-binding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">xudaxian</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">User</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">authorization-clusterrole</span></span></span></code></pre></div></blockquote>
<hr>
<h4 id="font-colorred创建fontrolefont-colorred和fontrolebindingfont-colorred为fontuser-namefont-colorred授权font"><!-- raw HTML omitted -->创建<!-- raw HTML omitted --><code>Role</code><!-- raw HTML omitted -->和<!-- raw HTML omitted --><code>RoleBinding</code><!-- raw HTML omitted -->，为<!-- raw HTML omitted --><code>user-name</code><!-- raw HTML omitted -->授权<!-- raw HTML omitted --></h4>
<ul>
<li>
<ol>
<li>创建<code>dev-role.yaml</code>文件，内容如下：</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Role</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">name</span>: <span style="color:#ae81ff">dev-role</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">apiGroups</span>: [<span style="color:#e6db74">&#34;&#34;</span>]  	<span style="color:#75715e"># 支持的API组列表，&#34;&#34;空字符串，表示核心API群</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;pods&#34;</span>]  	<span style="color:#75715e"># 支持的资源对象列表</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;get&#34;</span>,<span style="color:#e6db74">&#34;watch&#34;</span>,<span style="color:#e6db74">&#34;list&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">RoleBinding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">name</span>: <span style="color:#ae81ff">authorization-role-binding </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">User</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">user-name</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Role </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">dev-role</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li>创建<code>Role</code>和<code>RoleBinding</code>：</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl create -f dev-role.yaml</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li>切换账户到<code>user-name</code>用户，再次验证：</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl config use-context user-name@kubernetes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 再次查看：</span>
</span></span><span style="display:flex;"><span>$ kubectl get pod -n default
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 切回admin账户：</span>
</span></span><span style="display:flex;"><span>$ kubectl config use-context kubernetes-admin@kubernetes</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          </section>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="ldap">LDAP</h1>


            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of LDAP</h1>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="config_openldap">Config_OpenLDAP</h1>


            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_kerberos">Install_Kerberos</h1>

<h2 id="kerberos"><code>Kerberos</code></h2>
<blockquote>
<ul>
<li><a href="https://www.thegeekdiary.com/how-to-install-and-configure-kerberos-in-centos-rhel-7/" rel="external" target="_self">如何在<code>CentOS/RHEL 7</code>中安装和配置<code>Kerberos</code></a></li>
</ul>
</blockquote>
<hr>
<h3 id="安装kerberos">安装<code>Kerberos</code></h3>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_openldap">Install_OpenLDAP</h1>

<h2 id="openldap"><code>OpenLDAP</code></h2>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://hebye.com/docs/ldap/ldap-1d97mtl9ifh1c" rel="external" target="_self"><code>OpenLDAP</code>的安装与配置</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/ibv/LDAP-Admin" rel="external" target="_self"><code>LDAP Admin for Linux</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://directory.apache.org/studio/" rel="external" target="_self"><code>Apache Directory Studio</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/uroesch/LdapAdminPortable/tags" rel="external" target="_self"><code>LDAP Admin for PortableApps.com</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.ldap-account-manager.org/lamcms/" rel="external" target="_self"><code>LDAP Account Manager</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.cnblogs.com/woshimrf/p/ldap.html" rel="external" target="_self"><code>openldap</code>介绍和使用</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://zhuanlan.zhihu.com/p/32732045" rel="external" target="_self"><code>LDAP</code>基础学习笔记</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.jianshu.com/p/243ff61b0552" rel="external" target="_self"><code>OpenLDAP</code>安装使用及与各系统的集成</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.ibm.com/docs/zh/samfess/8.2.2?topic=reports-creating-users-in-ldap" rel="external" target="_self">在<code>LDAP</code>中创建用户</a></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h3 id="openldap安装"><code>OpenLDAP</code>安装</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>Openldap</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum install openldap-servers openldap-clients -y</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->修改配置文件<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->把<!-- raw HTML omitted --><code>/etc/openldap/</code><!-- raw HTML omitted -->目录下<!-- raw HTML omitted --><code>slapd.d</code><!-- raw HTML omitted -->默认文件夹备份<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /etc/openldap/
</span></span><span style="display:flex;"><span>$ cp -r slapd.d<span style="color:#f92672">{</span>,.bak<span style="color:#f92672">}</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->生成加密密钥<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ slappasswd
</span></span><span style="display:flex;"><span>New password: 
</span></span><span style="display:flex;"><span>Re-enter new password: 
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>SSHA<span style="color:#f92672">}</span>2OhbHFHD0Lx1JUS7IsQZnHlS65tKlAvf</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->拷贝、修改配置文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cp /usr/share/openldap-servers/slapd.ldif /etc/openldap/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改配置文件，把中文注释行都删除</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/etc/openldap/slapd.ldif<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">dn: cn=config
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">objectClass: olcGlobal
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">cn: config
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">olcArgsFile: /var/run/openldap/slapd.args
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">olcPidFile: /var/run/openldap/slapd.pid
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">olcTLSCACertificatePath: /etc/openldap/certs
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">olcTLSCertificateFile: &#34;OpenLDAP Server&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">olcTLSCertificateKeyFile: /etc/openldap/certs/password
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">dn: cn=schema,cn=config
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">objectClass: olcSchemaConfig
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">cn: schema
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 添加/etc/openldap/schema/ 目录下属性类
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">include: file:///etc/openldap/schema/core.ldif
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">include: file:///etc/openldap/schema/collective.ldif
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">include: file:///etc/openldap/schema/corba.ldif
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">include: file:///etc/openldap/schema/cosine.ldif
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">include: file:///etc/openldap/schema/duaconf.ldif
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">include: file:///etc/openldap/schema/dyngroup.ldif
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">include: file:///etc/openldap/schema/inetorgperson.ldif
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">include: file:///etc/openldap/schema/java.ldif
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">include: file:///etc/openldap/schema/misc.ldif
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">include: file:///etc/openldap/schema/nis.ldif
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">include: file:///etc/openldap/schema/openldap.ldif
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">include: file:///etc/openldap/schema/pmi.ldif
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">include: file:///etc/openldap/schema/ppolicy.ldif
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">dn: olcDatabase=frontend,cn=config
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">objectClass: olcDatabaseConfig
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">objectClass: olcFrontendConfig
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">olcDatabase: frontend
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">dn: olcDatabase=config,cn=config
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">objectClass: olcDatabaseConfig
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">olcDatabase: config
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">olcAccess: to * by dn.base=&#34;gidNumber=0+uidNumber=0,cn=peercred,cn=external,c
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> n=auth&#34; manage by * none
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">dn: olcDatabase=monitor,cn=config
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">objectClass: olcDatabaseConfig
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">olcDatabase: monitor
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># dc=my-domain 修改为定义域名
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">olcAccess: to * by dn.base=&#34;gidNumber=0+uidNumber=0,cn=peercred,cn=external,c
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> n=auth&#34; read by dn.base=&#34;cn=Manager,dc=ladp.erge,dc=com&#34; read by * none
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">dn: olcDatabase=hdb,cn=config
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">objectClass: olcDatabaseConfig
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">objectClass: olcHdbConfig
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">olcDatabase: hdb
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># my-domain 修改为定义域名
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">olcSuffix: dc=ladp.erge,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">olcRootDN: cn=Manager,dc=ladp.erge,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># olcRootPW 为新增字段
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">olcRootPW: {SSHA}2OhbHFHD0Lx1JUS7IsQZnHlS65tKlAvf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">olcDbDirectory:	/var/lib/ldap
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">olcDbIndex: objectClass eq,pres
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">olcDbIndex: ou,cn,mail,surname,givenname eq,pres,sub
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->生成主配置文件<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>
<p><code>-n 0</code><!-- raw HTML omitted -->指定<code>0</code>号数据库<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>-F slapd.d</code><!-- raw HTML omitted -->指定生成的目录<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>-l slapd.ldif</code><!-- raw HTML omitted -->指定使用那个文件生成<!-- raw HTML omitted --></p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ slapadd -n <span style="color:#ae81ff">0</span> -F slapd.d -l slapd.ldif  	<span style="color:#75715e"># 返回以下：100.00% 代表成功，如果报错是：slapd.ldif 配置文件问题</span>
</span></span><span style="display:flex;"><span>_#################### 100.00% eta   none elapsed            none fast!
</span></span><span style="display:flex;"><span>Closing DB...</span></span></code></pre></div></li>
<li>
<p><!-- raw HTML omitted -->修改权限<!-- raw HTML omitted --></p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ chown -R ldap:ldap /etc/openldap/slapd.d
</span></span><span style="display:flex;"><span>$ chown -R ldap:ldap /var/lib/ldap/ </span></span></code></pre></div></li>
<li>
<p><!-- raw HTML omitted -->拷贝数据库默认配置文件<!-- raw HTML omitted --></p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cp /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG</span></span></code></pre></div></li>
</ul>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->启动并设置为开机自启<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl start slapd <span style="color:#f92672">&amp;&amp;</span> systemctl enable slapd</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->配置基本域<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/openldap/config_init.ldif<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># dn 条目
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">dn: dc=ladp.erge,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 对象类
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">objectclass: dcObject
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">objectclass: organization
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 组织名称
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">o: aishangwei
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># dc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">dc: ladp.erge
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->添加基本域<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>系统会提示您输入<code>LDAP</code>密码。 输入您为<code>LDAP root</code>用户定义的纯文本密码</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ldapadd -x -D <span style="color:#e6db74">&#34;cn=Manager,dc=ldap.erge,dc=com&#34;</span> -W -f /etc/openldap/config_init.ldif</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->查询域<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ldapsearch -x -b <span style="color:#e6db74">&#39;dc=ldap.erge,dc=com&#39;</span>   <span style="color:#e6db74">&#39;(objectClass=*)&#39;</span>
</span></span><span style="display:flex;"><span>$ ldapsearch -H ldapi:/// -Y EXTERNAL -b <span style="color:#e6db74">&#34;cn=config&#34;</span> -LLL –Q
</span></span><span style="display:flex;"><span>$ ldapsearch -h 192.168.88.110 -b <span style="color:#e6db74">&#34;dc=ladp.erge,dc=com&#34;</span> -D <span style="color:#e6db74">&#34;cn=Manager,dc=erge,dc=com&#34;</span> -W |grep dn</span></span></code></pre></div></blockquote>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->取消匿名登录<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>
<p><code>openldap</code>在匿名情况下是可以被访问的。而且<code>openldap</code>的相关信息，除了用户的密码信息之外，其他<code>openldap</code>的信息完全被呈现出来。</p>
</li>
<li>
<p>从安全的角度考虑，这种情况是不被允许的，所以要取消<code>openldap</code>的匿名访问功能。</p>
</li>
<li>
<p>要取消<code>openldap</code>的匿名访问功能，操作方法也比较简单。我们只需要把以下<code>openldap</code>信息导入<code>openldap</code>中即可，而且是无需重启<code>openldap</code>服务即时生效的。</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/openldap/disable_anon.ldif<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">dn: cn=config
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">changetype: modify
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">add: olcDisallows
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">olcDisallows: bind_anon
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">dn: cn=config
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">changetype: modify
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">add: olcRequires
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">olcRequires: authc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">dn: olcDatabase={-1}frontend,cn=config
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">changetype: modify
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">add: olcRequires
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">olcRequires: authc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/disable_anon.ldif
</span></span><span style="display:flex;"><span>SASL/EXTERNAL authentication started
</span></span><span style="display:flex;"><span>SASL username: gidNumber<span style="color:#f92672">=</span>0+uidNumber<span style="color:#f92672">=</span>0,cn<span style="color:#f92672">=</span>peercred,cn<span style="color:#f92672">=</span>external,cn<span style="color:#f92672">=</span>auth
</span></span><span style="display:flex;"><span>SASL SSF: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>modifying entry <span style="color:#e6db74">&#34;cn=config&#34;</span>
</span></span><span style="display:flex;"><span>modifying entry <span style="color:#e6db74">&#34;cn=config&#34;</span>
</span></span><span style="display:flex;"><span>modifying entry <span style="color:#e6db74">&#34;olcDatabase={-1}frontend,cn=config&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看配置文件</span>
</span></span><span style="display:flex;"><span>$ cat /etc/openldap/slapd.d/cn<span style="color:#ae81ff">\=</span>config.ldif
</span></span><span style="display:flex;"><span><span style="color:#75715e"># AUTO-GENERATED FILE - DO NOT EDIT!! Use ldapmodify.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CRC32 af9dbdcd</span>
</span></span><span style="display:flex;"><span>dn: cn<span style="color:#f92672">=</span>config
</span></span><span style="display:flex;"><span>objectClass: olcGlobal
</span></span><span style="display:flex;"><span>cn: config
</span></span><span style="display:flex;"><span>olcArgsFile: /var/run/openldap/slapd.args
</span></span><span style="display:flex;"><span>olcPidFile: /var/run/openldap/slapd.pid
</span></span><span style="display:flex;"><span>olcTLSCACertificatePath: /etc/openldap/certs
</span></span><span style="display:flex;"><span>olcTLSCertificateFile: <span style="color:#e6db74">&#34;OpenLDAP Server&#34;</span>
</span></span><span style="display:flex;"><span>olcTLSCertificateKeyFile: /etc/openldap/certs/password
</span></span><span style="display:flex;"><span>structuralObjectClass: olcGlobal
</span></span><span style="display:flex;"><span>entryUUID: 7b515fd2-ab06-103b-8cdb-d13498ff4586
</span></span><span style="display:flex;"><span>creatorsName: cn<span style="color:#f92672">=</span>config
</span></span><span style="display:flex;"><span>createTimestamp: 20210916065302Z
</span></span><span style="display:flex;"><span>olcDisallows: bind_anon
</span></span><span style="display:flex;"><span>olcRequires: authc   //取消匿名用户登录
</span></span><span style="display:flex;"><span>entryCSN: 20210916072755.667534Z#000000#000#000000
</span></span><span style="display:flex;"><span>modifiersName: gidNumber<span style="color:#f92672">=</span>0+uidNumber<span style="color:#f92672">=</span>0,cn<span style="color:#f92672">=</span>peercred,cn<span style="color:#f92672">=</span>external,cn<span style="color:#f92672">=</span>auth
</span></span><span style="display:flex;"><span>modifyTimestamp: 20210916072755Z</span></span></code></pre></div></li>
</ul>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->开启<!-- raw HTML omitted --><code>Openldap</code><!-- raw HTML omitted -->日志<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/openldap/loglevel.ldif<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">dn: cn=config
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">changetype: modify
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">replace: olcLogLevel
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">olcLogLevel: stats
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ldapmodify -Y EXTERNAL -H ldapi:/// -f /etc/openldap/loglevel.ldif
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;&gt;/etc/rsyslog.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">local4.* /var/log/slapd.log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ systemctl restart rsyslog
</span></span><span style="display:flex;"><span>$ systemctl restart slapd</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->允许普通用户修改自己的密码<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/openldap/updatepass.ldif<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">dn: olcDatabase={2}hdb,cn=config
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">changetype: modify
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">add: olcAccess
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">olcAccess: to attrs=userPassword
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     by self =xw
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     by anonymous auth
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     by * none
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">olcAccess: to *
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     by self write
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     by users read
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     by * none
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ldapmodify -Y EXTERNAL -H ldapi:/// -f /etc/openldap/updatepass.ldif</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>Openldap</code><!-- raw HTML omitted -->管理员密码<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 1. 查看openldap管理员密码字段放在哪个配置文件中</span>
</span></span><span style="display:flex;"><span>$ ldapsearch -H ldapi:// -LLL -Q -Y EXTERNAL -b <span style="color:#e6db74">&#34;cn=config&#34;</span> <span style="color:#e6db74">&#34;(olcRootDN=*)&#34;</span> dn olcRootDN olcRootPW
</span></span><span style="display:flex;"><span>dn: olcDatabase<span style="color:#f92672">={</span>2<span style="color:#f92672">}</span>hdb,cn<span style="color:#f92672">=</span>config
</span></span><span style="display:flex;"><span>olcRootDN: cn<span style="color:#f92672">=</span>admin,dc<span style="color:#f92672">=</span>hebye,dc<span style="color:#f92672">=</span>com
</span></span><span style="display:flex;"><span>olcRootPW: <span style="color:#f92672">{</span>SSHA<span style="color:#f92672">}</span>Z9XXRjQYHbjYXuOvXPgR/g+HRBoNmj/u
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2. 设置openldap管理员最新的密码</span>
</span></span><span style="display:flex;"><span>$ slappasswd -s password
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3. 生成修改openldap管理员密码的ldif文件</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/root/newpasswd.ldif<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">dn: olcDatabase={2}hdb,cn=config
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">changetype: modify
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">replace: olcRootPW
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">olcRootPW: {SSHA}YB8N9nZg9qKisiW/Xp6NVPeqhE66mQOB
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 4. 导入文件</span>
</span></span><span style="display:flex;"><span>$ ldapmodify -H ldapi:// -Y EXTERNAL -f /root/newpasswd.ldif
</span></span><span style="display:flex;"><span>SASL/EXTERNAL authentication started
</span></span><span style="display:flex;"><span>SASL username: gidNumber<span style="color:#f92672">=</span>0+uidNumber<span style="color:#f92672">=</span>0,cn<span style="color:#f92672">=</span>peercred,cn<span style="color:#f92672">=</span>external,cn<span style="color:#f92672">=</span>auth
</span></span><span style="display:flex;"><span>SASL SSF: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>modifying entry <span style="color:#e6db74">&#34;olcDatabase={2}hdb,cn=config&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 5. 上述命令执行完毕后，openldap的管理员密码就已经被修改掉了</span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          </section>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="logs">Logs</h1>


            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Logs</h1>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="use_logrotate">Use_Logrotate</h1>

<h2 id="logrotate日志切割"><code>logrotate</code>日志切割</h2>
<blockquote>
<ul>
<li><code>man logrotate</code><!-- raw HTML omitted -->查看<!-- raw HTML omitted --><code>logrodate</code><!-- raw HTML omitted -->使用详情<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->如果日志切割在：<!-- raw HTML omitted --><code>/usr</code>, <code>boot</code>, <code>/etc</code>, <code>efi</code><!-- raw HTML omitted -->等目录下时，会提示：<!-- raw HTML omitted --><code>error: error opening /usr/local/nginx/logs/nginx.log: Read-only file system</code><!-- raw HTML omitted -->这是因为启动文件配置：<!-- raw HTML omitted --><code>ProtectSystem=full</code></li>
</ul>
<blockquote>
<ul>
<li>修改<code>/lib/systemd/system/logrotate.service</code>配置文件</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl status logrotate.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;/lib/systemd/system/logrotate.service<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ReadWritePaths=/usr/local/nginx/logs  	# 文件末尾添加此行
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ systemctl daemon-reload 
</span></span><span style="display:flex;"><span>$ systemctl restart logrotate.service</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="配置nginx日志切割">配置<code>Nginx</code>日志切割</h3>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://blog.csdn.net/weixin_45203131/article/details/113186186" rel="external" target="_self"><code>centos7 logrotate</code>日志切割</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.cnblogs.com/diantong/p/10717926.html" rel="external" target="_self"><code>CentOS</code>下使用<code>Logrotate</code>日志切割</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://bypass007.github.io/Emergency-Response-Notes/" rel="external" target="_self"><code>Logs</code>日志分析排查<code>GitBook</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/Bypass007/Emergency-Response-Notes" rel="external" target="_self"><code>Logs</code>日志分析排查<code>Github</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.cnblogs.com/kevingrace/p/6307298.html" rel="external" target="_self">日志切割方法小结<code>Logrotate、python、shell</code>脚本实现 </a></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ man logrotate
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 新增nginx log 每日切割</span>
</span></span><span style="display:flex;"><span>$ grep <span style="color:#e6db74">&#34;nginx&#34;</span> /etc/logrotate.d/nginx  &amp;&gt;/dev/null  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;/etc/logrotate.d/nginx<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;/opt/apps/nginx/logs/*.jsonl&#34; /opt/apps/nginx/logs/*.log{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">daily  	# 安日期轮转日志：hourly(小时)、daily(天)、weekly(月)、monthly(月)、yearly(年)，如果设置(size)则不用该参数
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">dateext  	# 文件后缀是日期格式,也就是切割后文件是:xxx.log-20150828，该设置可能和大小切割冲突，该设置按日期生成
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">size 100k	# 在日志大小大于 logsize（例如 100K，100M，100G）时轮换、minsize、maxsize，该选项与日期设置是互斥的
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rotate 15  	# 指定日志文件删除之前转储的次数，0指没有备份，15指保留15个备份
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">compress  	# 通过gzip压缩转储以后的日志（gzip -d xxx.gz解压）
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">missingok  	# 如果日志不存在则忽略该警告信息
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">notifempty  	# 如果是空文件的话，不转储
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">copytruncate  	# 用于还在打开中的日志文件，把当前日志备份并截断
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">delaycompress  	# 和compress一起使用时，delaycompress选项指示logrotate不要将最近的归档压缩，压缩将在下一次轮循周期进行
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sharedscripts  	# 运行postrotate脚本，在所有日志都轮转后统一执行一次脚本。如果没配该选项，每个日志轮转后都会执行一次脚本
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">postrotate  	# 运行postrotate脚本，作用是在所有日志都轮转后统一执行一次脚本，如重启（kill -HUP）服务
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    [ -f /var/run/nginx.pid ] &amp;&amp; kill -USR1 `cat /var/run/nginx.pid`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">endscript  	# 最通常的作用是让应用重启，以便切换到新的日志文件, 在所有其它指令完成后，postrotate和endscript里面指定的命令将被执行。在这种情况下，nginx 进程将立即再次读取其配置并继续运行
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">create 640 www root 	# 以指定的权限用户和组创建全新的日志文件，同时logrotate也会重命名原始日志文件
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">su root root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">} 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 手动调试验证不执行：-d</span>
</span></span><span style="display:flex;"><span>$ /usr/sbin/logrotate -d /etc/logrotate.d/nginx
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 手动强制执行：-f</span>
</span></span><span style="display:flex;"><span>$ /usr/sbin/logrotate -f /etc/logrotate.d/nginx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 新增刪除7天以前log定時腳本  </span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;###nginx超過七天log刪除
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">1 0 * * * /bin/bash /opt/scripts/DEL_NGINX.sh &gt;&gt; ~/del_tom.log 2&gt;&amp;1&#34;</span> &gt;&gt; /var/spool/cron/admin</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_quickwit">Install_Quickwit</h1>

<h2 id="quickwit"><code>Quickwit</code></h2>
<blockquote>
<ul>
<li><a href="https://quickwit.io/docs/" rel="external" target="_self"><code>Quickwit</code>日志管理、分析</a></li>
<li><a href="https://opentelemetry.io/docs/" rel="external" target="_self"><code>OpenTelemetry</code></a></li>
</ul>
</blockquote>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_logkit">Install_Logkit</h1>

<h2 id="logkit"><code>LogKit</code></h2>
<blockquote>
<ul>
<li><a href="https://github.com/qiniu/logkit" rel="external" target="_self"><code>LogKit</code></a></li>
</ul>
<blockquote>
<ul>
<li>非常强大的服务器代理，用于通过易于使用的<code>Web</code>控制台收集和发送日志和指标</li>
</ul>
</blockquote>
</blockquote>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_graylog">Install_Graylog</h1>

<h2 id="graylog日志服务"><code>GrayLog</code>日志服务</h2>
<blockquote>
<ul>
<li><a href="https://docs.graylog.org/docs/operating-system-packages" rel="external" target="_self"><code>GrayLog</code></a>日志服务</li>
<li><a href="https://testerhome.com/topics/3026" rel="external" target="_self"><code>Graylog</code>—日志聚合工具中的后起之秀</a></li>
<li><a href="https://my.oschina.net/HeAlvin/blog/378262" rel="external" target="_self">推荐！国外程序员整理的系统管理员资源大全</a></li>
</ul>
<blockquote>
<ul>
<li><code>Java ( &gt;= 8 )</code></li>
<li><code>MongoDB (4.0, 4.2 or 4.4)</code></li>
<li><code>Elasticsearch (6.x or 7.x)</code></li>
<li><code>GrayLog-Server</code></li>
<li><code>GrayLog-Web</code></li>
</ul>
</blockquote>
</blockquote>
<hr>
<h3 id="安装graylog所需服务">安装<code>GrayLog</code>所需服务</h3>
<ul>
<li>
<ol>
<li><a href="https://www.mongodb.com/docs/manual/tutorial/install-mongodb-on-red-hat/" rel="external" target="_self"><code>Mongodb</code></a>数据库</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>Mongodb</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>yum</code><!-- raw HTML omitted -->存储库<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/yum.repos.d/mongodb-org.repo<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[mongodb-org-4.2]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name=MongoDB Repository
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">baseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/4.2/x86_64/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgcheck=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">enabled=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgkey=https://www.mongodb.org/static/pgp/server-4.2.asc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->安装并启动<!-- raw HTML omitted --><code>MongoDB</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install mongodb-org
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ systemctl daemon-reload
</span></span><span style="display:flex;"><span>$ systemctl enable mongod.service <span style="color:#f92672">&amp;&amp;</span> systemctl start mongod.service
</span></span><span style="display:flex;"><span>$ systemctl --type<span style="color:#f92672">=</span>service --state<span style="color:#f92672">=</span>active | grep mongod</span></span></code></pre></div></blockquote>
</blockquote>
<ul>
<li>
<ol start="2">
<li><code>Elasticsearch</code>数据存储服务</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>GrayLog</code>所需服务<code>Elasticsearch</code>弹性搜索、数据存储服务</li>
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>Elasticsearch</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>yum</code><!-- raw HTML omitted -->存储库<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>GrayLog</code><!-- raw HTML omitted -->不支持<!-- raw HTML omitted --><code>Elasticsearch 7.11</code><!-- raw HTML omitted -->及更高版本。它会破坏你的<!-- raw HTML omitted --><code>Graylog</code><!-- raw HTML omitted -->实例！<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rpm --import https://artifacts.elastic.co/GPG-KEY-elasticsearch  	<span style="color:#75715e"># 添加密钥</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;/etc/yum.repos.d/elasticsearch.repo<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[elasticsearch-7.x]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name=Elasticsearch repository for 7.x packages
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">baseurl=https://artifacts.elastic.co/packages/oss-7.x/yum
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgcheck=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">enabled=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">autorefresh=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">type=rpm-md
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>elasticsearch-oss</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install elasticsearch-oss</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>Elasticsearch</code><!-- raw HTML omitted -->配置文件，并将集群名称设置为<!-- raw HTML omitted --><code>Graylog</code><!-- raw HTML omitted -->并取消注释<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ tee -a /etc/elasticsearch/elasticsearch.yml &gt;/dev/null <span style="color:#e6db74">&lt;&lt;-EOT
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">cluster.name: graylog
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">action.auto_create_index: false  	# 并取消注释，启用该操作
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOT</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->启动<!-- raw HTML omitted --><code>Elasticsearch</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl daemon-reload
</span></span><span style="display:flex;"><span>$ systemctl enable elasticsearch.service <span style="color:#f92672">&amp;&amp;</span> systemctl restart elasticsearch.service
</span></span><span style="display:flex;"><span>$ systemctl --type<span style="color:#f92672">=</span>service --state<span style="color:#f92672">=</span>active | grep elasticsearch</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="安装graylog服务">安装<code>GrayLog</code>服务</h3>
<blockquote>
<ul>
<li><code>GrayLog</code><!-- raw HTML omitted -->各插件功能<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>graylog-enterprise-integrations-plugins</code><!-- raw HTML omitted -->企业集成插件<!-- raw HTML omitted --></li>
<li><code>graylog-enterprise-plugins</code><!-- raw HTML omitted -->企业插件<!-- raw HTML omitted --></li>
<li><code>graylog-integrations-plugins</code><!-- raw HTML omitted -->集成插件<!-- raw HTML omitted --></li>
<li><code>graylog-server</code><!-- raw HTML omitted -->服务端<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rpm -Uvh https://packages.graylog2.org/repo/packages/graylog-4.2-repository_latest.rpm
</span></span><span style="display:flex;"><span>$ yum install graylog-server graylog-enterprise-plugins graylog-integrations-plugins graylog-enterprise-integrations-plugins</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>GrayLog</code><!-- raw HTML omitted -->配置文件<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->阅读配置文件中的说明并根据需要进行编辑，位于<!-- raw HTML omitted --><code>/etc/graylog/server/server.conf</code><!-- raw HTML omitted -->另外添加<!-- raw HTML omitted --><code>password_secret</code><!-- raw HTML omitted -->和<!-- raw HTML omitted --><code>root_password_sha2</code><!-- raw HTML omitted -->因为这些是强制性的，没有它们<!-- raw HTML omitted --><code>Graylog</code><!-- raw HTML omitted -->将无法启动<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ln -s /usr/local/src/jdk1.8.0_221/bin/java /usr/bin/java  	<span style="color:#75715e"># 给Java做个软连接</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ echo -n <span style="color:#e6db74">&#34;Enter Password: &#34;</span> <span style="color:#f92672">&amp;&amp;</span> head -1 &lt;/dev/stdin | tr -d <span style="color:#e6db74">&#39;\n&#39;</span> | sha256sum | cut -d<span style="color:#e6db74">&#34; &#34;</span> -f1  	<span style="color:#75715e"># 为：password_secret，生成64位密码字符</span>
</span></span><span style="display:flex;"><span>$ echo -n yourpassword | sha256sum  	<span style="color:#75715e"># 为：root_password_sha2，生成哈希值</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改配置文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat //etc/graylog/server/server.conf 
</span></span><span style="display:flex;"><span>password_secret <span style="color:#f92672">=</span>   	<span style="color:#75715e"># 57行左右， 添加用户集群数据库中所用</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root_password_sha2 <span style="color:#f92672">=</span>   	<span style="color:#75715e"># 68行左右，添加生成的哈希值， 用于登录web界面</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>http_bind_address <span style="color:#f92672">=</span> 127.0.0.1:9000  	<span style="color:#75715e"># 105行左右修改为：http_bind_address = 0.0.0.0:9000</span></span></span></code></pre></div></blockquote>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->启动<!-- raw HTML omitted --><code>GrayLog</code><!-- raw HTML omitted -->服务<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl daemon-reload
</span></span><span style="display:flex;"><span>$ systemctl enable graylog-server.service <span style="color:#f92672">&amp;&amp;</span> systemctl start graylog-server.service
</span></span><span style="display:flex;"><span>$ systemctl --type<span style="color:#f92672">=</span>service --state<span style="color:#f92672">=</span>active | grep graylog</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>Selinux</code><!-- raw HTML omitted -->开放端口<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->允许<!-- raw HTML omitted --><code>Web</code><!-- raw HTML omitted -->服务器访问网络<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ setsebool -P httpd_can_network_connect <span style="color:#ae81ff">1</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->针对端口配置<!-- raw HTML omitted --><code>Selinux</code><!-- raw HTML omitted -->开放<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ semanage port -a -t http_port_t -p tcp <span style="color:#ae81ff">9000</span>  	<span style="color:#75715e"># Graylog REST API 和 Web 界面</span>
</span></span><span style="display:flex;"><span>$ semanage port -a -t http_port_t -p tcp <span style="color:#ae81ff">9200</span>  	<span style="color:#75715e"># Elasticsearch（仅当使用 HTTP API 时）</span>
</span></span><span style="display:flex;"><span>$ semanage port -a -t mongod_port_t -p tcp <span style="color:#ae81ff">27017</span>  	<span style="color:#75715e"># 允许使用 MongoDB 的默认端口 (27017/tcp)</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->防火墙开放端口<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ firewall-cmd --add-port<span style="color:#f92672">=</span>9000/tcp --permanent
</span></span><span style="display:flex;"><span>$ firewall-cmd --reload</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->打开浏览器访问<!-- raw HTML omitted --><code>GrayLog</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ http://IP:9000  	<span style="color:#75715e"># 默认用户名：admin，所定义的root_password_sha2密码</span></span></span></code></pre></div><ul>
<li><code>Google</code><!-- raw HTML omitted -->浏览器访问报错更换浏览器<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>While rendering this widget, the following error occurred:
</span></span><span style="display:flex;"><span>NotFoundError: Failed to execute <span style="color:#e6db74">&#39;removeChild&#39;</span> on <span style="color:#e6db74">&#39;Node&#39;</span>: The node to be removed is not a child of this node.</span></span></code></pre></div></blockquote>
</blockquote>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_fluentd">Install_Fluentd</h1>

<h2 id="fluentd"><code>Fluentd</code></h2>
<blockquote>
<ul>
<li>
<p><a href="https://www.fluentd.org/" rel="external" target="_self"><code>Fluentd</code></a></p>
<p><code>Fluentd</code>是一个开源的数据收集器，用作统一化数据收集和使用</p>
</li>
</ul>
</blockquote>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_finder">Install_Finder</h1>

<h2 id="finder日志系统"><code>Finder</code>日志系统</h2>
<blockquote>
<ul>
<li><!-- raw HTML omitted --><code>JDK1.8</code><!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted --><code>Tomcat8</code><!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 使用root登录</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1. 创建用户: tomcat</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 如果已有可忽略</span>
</span></span><span style="display:flex;"><span>$ useradd tomcat
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2. 设置临时变量: TOMCAT_HOME</span>
</span></span><span style="display:flex;"><span>TOMCAT_HOME<span style="color:#f92672">=</span>Tomcat根目录
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3. 删除并重建ROOT目录, 如有重要资料请注意备份</span>
</span></span><span style="display:flex;"><span>$ rm -rf $TOMCAT_HOME/webapps/ROOT
</span></span><span style="display:flex;"><span>$ mkdir -p $TOMCAT_HOME/webapps/ROOT
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 4. 下载并解压到ROOT目录</span>
</span></span><span style="display:flex;"><span>$ wget -O /tmp/finder-web-2.5.8.zip http://www.finderweb.net/download/finder-web-2.5.8.war
</span></span><span style="display:flex;"><span>$ unzip -o -d $TOMCAT_HOME/webapps/ROOT /tmp/finder-web-2.5.8.zip
</span></span><span style="display:flex;"><span><span style="color:#75715e"># rm -f /tmp/finder-web-2.5.8.zip</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 5. 为应用目录赋权限</span>
</span></span><span style="display:flex;"><span>$ chown -R tomcat:tomcat $TOMCAT_HOME
</span></span><span style="display:flex;"><span>$ chmod -R <span style="color:#ae81ff">755</span> $TOMCAT_HOME
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 6. 启动Tomcat</span>
</span></span><span style="display:flex;"><span>$ sudo -u tomcat $TOMCAT_HOME/bin/startup.sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 7. 访问地址：http://ip:8080/finder</span>
</span></span><span style="display:flex;"><span>tomcat默认的端口号为8080，如需修改，请手动编辑TOMCAT_HOME/conf/server.xml，需重启Tomcat。
</span></span><span style="display:flex;"><span>默认的用户名密码：
</span></span><span style="display:flex;"><span>admin <span style="color:#ae81ff">1234</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 8. 修改挂载文件</span>
</span></span><span style="display:flex;"><span>$ cat &gt;finder/webapps/ROOT/WEB-INF/finderweb/workspaces.xml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;finderweb&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> &lt;workspace name=&#34;nginx&#34; displayName=&#34;nginx&#34; work=&#34;/opt/logs/nginx&#34; charset=&#34;utf8&#34; readonly=&#34;true&#34; orderNum=&#34;1&#34;/&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> &lt;workspace name=&#34;mysql&#34; displayName=&#34;mysql&#34; work=&#34;/opt/logs/mysql&#34; charset=&#34;utf8&#34; readonly=&#34;true&#34; orderNum=&#34;2&#34;/&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;/finderweb&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li><code>Docker</code>方式安装<code>Finder</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#39;1.0&#39;</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">services</span>:   
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tomcat</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">tomcat:8.5.15-jre8</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">tomcat_finder</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">8090</span>:<span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">TZ</span>: <span style="color:#ae81ff">Asiz/Shanghai </span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">/opt/finder/webapps:/usr/local/tomcat/webapps</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">/opt/finder/conf:/usr/local/tomcat/conf</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">/opt/finder/logs:/usr/local/tomcat/logs</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">/opt/finder/project/logs/nginx:/opt/hwc-logs/nginx</span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_es_head">Install_Es_Head</h1>

<h2 id="elasticsearch-head"><code>elasticsearch-head</code></h2>
<blockquote>
<ul>
<li><a href="https://github.com/mobz/elasticsearch-head" rel="external" target="_self"><code>elasticsearch-head Github</code>地址</a></li>
</ul>
</blockquote>
<h3 id="安装nodejsnpm">安装<code>nodejs、npm</code></h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>nodejs</code><!-- raw HTML omitted -->前先安装<!-- raw HTML omitted --><code>epel-release</code><!-- raw HTML omitted -->源<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install epel-release</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>nodejs、npm</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install nodejs npm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 更新npm</span>
</span></span><span style="display:flex;"><span>$ npm install -g npm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装 n 模块</span>
</span></span><span style="display:flex;"><span>$ npm install -g n</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="国内安装cnpm">国内安装<code>cnpm</code></h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->更换国内阿里云源<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 查看npm 使用地址</span>
</span></span><span style="display:flex;"><span>$ npm config get registry
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 更换源</span>
</span></span><span style="display:flex;"><span>$ npm config set registry https://registry.npm.taobao.org
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用cnpm</span>
</span></span><span style="display:flex;"><span>$ npm install -g cnpm --registry<span style="color:#f92672">=</span>https://registry.npm.taobao.org</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="安装elasticsearch-head">安装<code>elasticsearch-head</code></h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget https://github.com/mobz/elasticsearch-head/archive/refs/tags/v5.0.0.tar.gz
</span></span><span style="display:flex;"><span>$ tar zxvf v5.0.0.tar.gz
</span></span><span style="display:flex;"><span>$ cd elasticsearch-head
</span></span><span style="display:flex;"><span>$ npm install
</span></span><span style="display:flex;"><span>$ npm run start</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_elk">Install_ELK</h1>

<h2 id="elasticsearch部署"><code>Elasticsearch</code>部署</h2>
<blockquote>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/install-elasticsearch.html" rel="external" target="_self">官方文档</a></li>
<li><a href="https://www.elastic.co/cn/downloads/past-releases#elasticsearch" rel="external" target="_self">历史版本</a></li>
<li><a href="https://blog.csdn.net/u012332735/article/details/54946355" rel="external" target="_self"><code>Elasticsearch</code>常用插件集合</a></li>
<li><a href="https://www.cnblogs.com/hahaha111122222/p/13139809.html" rel="external" target="_self"><code>ELK</code>基于<code>ElastAlert</code>实现日志的微信报警</a></li>
<li><code>Elasticsearch</code><!-- raw HTML omitted -->简介<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>Elasticsearch</code>是一个基于<code>Lucene</code>的弹性数据存储、搜索、开源分布式搜索服务，它提供了一个分布式多用户能力的全文搜索引擎，基于<code>RESTful web</code>接口，在<code>elasticsearch</code>中，所有节点的数据是均等的。</li>
<li>特点：分布式，零配置，自动发现，索引自动分片，索引副本机制，<code>restful</code>风格接口，多数据源， 自动搜索负载等。</li>
<li><code>Elasticsearch</code>是用<code>Java</code>开发的，并作为<code>Apache</code>许可条款下的开放源码发布，是第二流行的企业搜索引擎。设计用于云计算中，能够达到实时搜索，稳定，可靠，快速，安装使用方便。</li>
</ul>
</blockquote>
<ul>
<li><a href="https://www.elastic.co/cn/downloads/elasticsearch" rel="external" target="_self">下载<code>elasticsearch-8.1</code></a></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-8.14.1-linux-x86_64.tar.gz
</span></span><span style="display:flex;"><span>$ wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-8.14.1-linux-x86_64.tar.gz.sha512
</span></span><span style="display:flex;"><span>$ sha512sum -c elasticsearch-8.1.3-linux-x86_64.tar.gz.sha512
</span></span><span style="display:flex;"><span>$ tar -xzf elasticsearch-8.1.3-linux-x86_64.tar.gz
</span></span><span style="display:flex;"><span>$ cd elasticsearch-8.1.3/ </span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>Elasticsearch</code><!-- raw HTML omitted -->配置文件<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>Elasticsearch</code><!-- raw HTML omitted -->主配置文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /opt/elasticsearch/config
</span></span><span style="display:flex;"><span>$ cp elasticsearch.yml<span style="color:#f92672">{</span>,.bak<span style="color:#f92672">}</span>  	<span style="color:#75715e"># 提前给配置文件做个备份</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;# cluster.name: my-application  	# 17行、组名(同一个组，组名必须一致)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 节点名称，建议和主机名一致，在23行位置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># node.name: node-1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 数据存放的路径，在33行位置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># path.data: /opt/elasticsearch/data
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 日志存放的路径，在37行位置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># path.logs: /opt/elasticsearch/logs
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 锁住内存，不被使用到交换分区去(通常在内部不足时，休眠的程序内存信息会交换到交换分区)，在43行位置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># bootstrap.memory_lock: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 网络设置，建议填写本机IP或者0.0.0.0，在56行位置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># network.host: 192.168.0.1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 端口设置，在61行位置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># http.port: 9200
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 设置节点启动时进行集群发现的初始主机列表。这些主机用于帮助节点发现并加入集群，在70行位置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># discovery.seed_hosts: [&#34;</span>host1ip:9300<span style="color:#e6db74">&#34;, &#34;</span>host2ip:9300<span style="color:#e6db74">&#34;,&#34;</span>host3ip:9300<span style="color:#e6db74">&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 和节点名称一致，在74行位置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># cluster.initial_master_nodes: [&#34;</span>node-1<span style="color:#e6db74">&#34;, &#34;</span>node-2<span style="color:#e6db74">&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 设置为false允许使用通配符删除索引，以防止误删数据设置为true，删除操作必须指定索引名称
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># action.destructive_requires_name: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 跨域配置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">http.cors.enabled: true  	# 支持跨域
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">http.cors.allow-origin: &#34;</span>*<span style="color:#e6db74">&#34;  	# 跨域范围  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">http.cors.allow-headers: Authorization,X-Requested-With,Content-Length,Content-Type
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 配置密钥证书
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># xpack.security.enabled: true  	# 启用安全性检查
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># xpack.security.transport.ssl.enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># xpack.security.transport.ssl.verification_mode: certificate
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># xpack.security.transport.ssl.keystore.path: /usr/share/elasticsearch/config/elastic-certificates.p12
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># xpack.security.transport.ssl.truststore.path: /usr/share/elasticsearch/config/elastic-certificates.p12
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 集群模式，从节点关闭多播
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># discovery.zen.ping.multicast.enabled: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 集群模式，从节点配置主服务器和自己的地址
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># discovery.zen.ping.unicast.hosts: [&#34;</span>10.18.41.31<span style="color:#e6db74">&#34;,&#34;</span>10.18.41.137<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 手动创建系统索引
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">action.auto_create_index: .monitoring*,.watches,.triggered_watches,.watcher-history*,.ml* &#34;</span> &gt;&gt;elasticsearch.yml</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>Elasticsearch</code><!-- raw HTML omitted -->资源限制配置文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 调整jvm.options文件的32、和33行</span>
</span></span><span style="display:flex;"><span>$ cd /opt/elasticsearch/config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;/## -Xms4g/a\\-Xms512m&#34;</span> jvm.options
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;/## -Xmx4g/a\\-Xmx512m&#34;</span> jvm.options</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->启动服务并开启<!-- raw HTML omitted -->防火墙：9200<!-- raw HTML omitted -->端口<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>Ulimit</code><!-- raw HTML omitted -->调整进程的最大文件描述符<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ulimit -n <span style="color:#ae81ff">65535</span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;* soft nofile 65536
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* hard nofile 65536
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* soft nproc 32000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* hard nproc 32000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* hard memlock unlimited
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* soft memlock unlimited &#34;</span>&gt;&gt;/etc/security/limits.conf</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>vm.max_map_count</code><!-- raw HTML omitted -->最大虚拟内存区域<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;vm.max_map_count=655360&#34;</span> &gt;&gt;/etc/sysctl.conf</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改权限启动服务开放防火墙<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>
<p><!-- raw HTML omitted --><strong>9200端口</strong>：<!-- raw HTML omitted -->用于所有通过<code>HTTP</code>协议进行的<code>API</code>调用。包括搜索、聚合、监控、以及其他任何使用<code>HTTP</code>协议的请求。所有的客户端库都会使用该端口与<code>ElasticSearch</code>进行交互。</p>
</li>
<li>
<p><!-- raw HTML omitted --><strong>9300端口</strong>：<!-- raw HTML omitted -->是一个自定义的二进制协议，用于集群中各节点之间的通信。用于诸如集群变更、主节点选举、节点加入/离开、分片分配等事项。</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ chown -R user:user /opt/elasticsearch  	<span style="color:#75715e"># 普通用户启动</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cd /opt/elasticsearch/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 证书设置</span>
</span></span><span style="display:flex;"><span>$ ./bin/elasticsearch-certutil ca
</span></span><span style="display:flex;"><span>$ ./bin/elasticsearch-certutil cert --ca elastic-stack-ca.p12
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 密码设置</span>
</span></span><span style="display:flex;"><span>$ ./bin/elasticsearch-reset-passwords -u elastic  	<span style="color:#75715e"># 为elastic用户生成随机密码</span>
</span></span><span style="display:flex;"><span>$ ./bin/elasticsearch-reset-passwords --username elastic -i  	<span style="color:#75715e"># 为elastic指定密码</span>
</span></span><span style="display:flex;"><span>$ ./bin/elasticsearch-setup-passwords interactive  	<span style="color:#75715e"># 设置用户密码，修改密码也是一样。</span>
</span></span><span style="display:flex;"><span>$ ./bin/elasticsearch
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 此命令来判断是init启动还是systemctl启动</span>
</span></span><span style="display:flex;"><span>$ ps -p <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 当systemd启用了日志记录，日志信息使用可用journalctl的命令</span>
</span></span><span style="display:flex;"><span>$ journalctl - f
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 列出elasticsearch服务的日记帐分录</span>
</span></span><span style="display:flex;"><span>$ journalctl - unit elasticsearch
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 要从给定时间开始列出elasticsearch服务的日记帐分录：</span>
</span></span><span style="display:flex;"><span>$ journalctl --unit elasticsearch --since  <span style="color:#e6db74">&#34;2016-10-30 18:17:16&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 检查Elasticsearch</span>
</span></span><span style="display:flex;"><span>$  curl -i -XGET http://127.0.0.1:9200</span></span></code></pre></div></li>
<li>
<p><code>Nginx Error</code>日志解析的<code>Ingest Pipeline</code></p>
<p>你需要在<code>Elasticsearch</code>中创建一个专门的<code>pipeline</code>来解析<code>Nginx</code>的<code>error.log</code>，比如解析日期、时间、错误信息、客户端<code>IP</code>、请求<code>URI</code>等。可以参考下面的<code>Ingest Pipeline</code>配置：</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">PUT _ingest/pipeline/nginx_error_pipeline</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;description&#34;: </span><span style="color:#e6db74">&#34;Pipeline for parsing Nginx error logs&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;processors&#34;: </span>[
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;grok&#34;: </span>{
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;field&#34;: </span><span style="color:#e6db74">&#34;message&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;patterns&#34;: </span>[
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;%{TIMESTAMP_ISO8601:timestamp} \\[%{LOGLEVEL:log_level}] %{NUMBER:pid}#%{NUMBER}: \\*%{NUMBER} %{GREEDYDATA:error_message}, client: %{IP:client_ip}, server: %{DATA:server_name}, request: \&#34;%{WORD:method} %{DATA:request_uri} HTTP/%{NUMBER:http_version}\&#34;, upstream: \&#34;%{DATA:upstream}\&#34;, host: \&#34;%{DATA:host}\&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;date&#34;: </span>{
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;field&#34;: </span><span style="color:#e6db74">&#34;timestamp&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;formats&#34;: </span>[<span style="color:#e6db74">&#34;yyyy/MM/dd HH:mm:ss&#34;</span>]
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ]
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></li>
</ul>
</blockquote>
</blockquote>
</blockquote>
<hr>
<h3 id="elasticsearch-head插件安装"><code>elasticsearch-head</code>插件安装</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->下载启动<!-- raw HTML omitted --><code>elasticsearch-head</code><!-- raw HTML omitted -->防火墙开放：9100<!-- raw HTML omitted --><!-- raw HTML omitted -->端口<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /opt/
</span></span><span style="display:flex;"><span>$ git clone git://github.com/mobz/elasticsearch-head.git
</span></span><span style="display:flex;"><span>$ cd elasticsearch-head
</span></span><span style="display:flex;"><span>$ npm install
</span></span><span style="display:flex;"><span>$ npm run start
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  grunt server  	# 或者使用  grunt 启动</span>
</span></span><span style="display:flex;"><span>$ curl http://localhost:9100/  	<span style="color:#75715e"># 登录浏览器输入地址访问</span></span></span></code></pre></div></blockquote>
<hr>
<h2 id="logstash部署"><code>Logstash</code>部署</h2>
<blockquote>
<ul>
<li><code>Logstash</code><!-- raw HTML omitted -->简介<!-- raw HTML omitted -->、<a href="https://www.elastic.co/guide/en/logstash/master/index.html" rel="external" target="_self">官方文档</a></li>
</ul>
<blockquote>
<ul>
<li><code>Logstash</code>是一个完全开源工具，可以对你的日志进行收集、过滤、分析，并将其存储供以后使用（如，搜索），<code>logstash</code>带有一个<code>web</code>界面，搜索和展示所有日志。</li>
</ul>
</blockquote>
<ul>
<li><a href="https://www.elastic.co/cn/downloads/logstash" rel="external" target="_self">下载、解压<code>Logstash</code></a></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget https://artifacts.elastic.co/downloads/logstash/logstash-8.3.3-linux-x86_64.tar.gz
</span></span><span style="display:flex;"><span>$ tar zxvf logstash-8.3.3-linux-x86_64.tar.gz</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>Logstash</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>conf</code><!-- raw HTML omitted -->文件收集<!-- raw HTML omitted --><code>Nginx</code><!-- raw HTML omitted -->日志<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://www.elastic.co/guide/en/logstash/current/configuration.html" rel="external" target="_self">参考官网标准输入输出</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.elastic.co/guide/en/logstash/current/configuration-file-structure.html" rel="external" target="_self">参考官网函数输入输出</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.elastic.co/guide/en/logstash/current/plugins-outputs-elasticsearch.html" rel="external" target="_self">参考官网收集系统日志</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.elastic.co/guide/en/logstash/current/event-dependent-configuration.html" rel="external" target="_self">参考官网收集<code>Java</code>日志</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.elastic.co/guide/en/logstash/current/plugins-codecs-multiline.html" rel="external" target="_self">参考官网使用<code>multiline</code>多行模式</a></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li><code>input{}</code>：<code>logstash</code><!-- raw HTML omitted -->从日志文件中调用函数输入<!-- raw HTML omitted --></li>
<li><code>output{}</code>：<code>logstash</code><!-- raw HTML omitted -->从日志文件中调用函数输出<!-- raw HTML omitted --></li>
<li><code>stdin{}</code>：<code>logstash</code><!-- raw HTML omitted -->从标准输入中收集日志<!-- raw HTML omitted --></li>
<li><code>stdout{} </code>：<code>logstash</code><!-- raw HTML omitted -->从标准输出日志<!-- raw HTML omitted --></li>
<li><code>syslog</code>：<code>logstash</code><!-- raw HTML omitted -->从系统日志程序中收集日志<!-- raw HTML omitted --></li>
<li><code>tcp</code>：<code>logstash</code><!-- raw HTML omitted -->从<!-- raw HTML omitted --><code>TCP</code><!-- raw HTML omitted -->程序端口中收集日志<!-- raw HTML omitted --></li>
<li><code>udp</code>：<code>logstash</code><!-- raw HTML omitted -->从<!-- raw HTML omitted --><code>UDP</code><!-- raw HTML omitted -->程序端口中收集日志<!-- raw HTML omitted --></li>
<li><code>rubuydebug</code>：<!-- raw HTML omitted -->通过<!-- raw HTML omitted --><code>rubuy</code><!-- raw HTML omitted -->库进行收集<!-- raw HTML omitted --></li>
<li><code>multiline</code>：<!-- raw HTML omitted -->多行模块<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;Settings: Default filter workers: 4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Logstash startup completed
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">input {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">file {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">type =&gt; &#34;</span>nginx-error-log<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">path =&gt; &#34;</span>/usr/local/nginx/logs/*error*.log<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">start_position =&gt; &#34;</span>beginning<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}file {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">type =&gt; &#34;</span>nginx-access-log<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">path =&gt; &#34;</span>/usr/local/nginx/logs/*access*.log<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">start_position =&gt; &#34;</span>beginning<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">codec =&gt; json
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">output {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if [type] =~ &#34;</span>nginx-error-log<span style="color:#e6db74">&#34; {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">elasticsearch {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">hosts =&gt; [&#34;</span>elasticsearch服务所在IP:9200<span style="color:#e6db74">&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">index =&gt; &#34;</span>mayi-nginx-error--%<span style="color:#f92672">{</span>+YYYY.MM.dd<span style="color:#f92672">}</span><span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}else if [type] =~ &#34;</span>nginx-access-log<span style="color:#e6db74">&#34; {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">elasticsearch {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">hosts =&gt; [&#34;</span>elasticsearch服务所在IP:9200<span style="color:#e6db74">&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">index =&gt; &#34;</span>mayi-nginx-access-%<span style="color:#f92672">{</span>+YYYY.MM.dd<span style="color:#f92672">}</span><span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">} &#34;</span> &gt;&gt;/opt/elk/logstash/data/nginx-log.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#####  	  </span>
</span></span><span style="display:flex;"><span>$ cat &gt;logstash.yml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">input {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> redis {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     host =&gt; &#34;Redis 服务所在IP&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     port =&gt; &#34;6379&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     password =&gt; &#34;password&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     data_type =&gt; &#34;list&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     key =&gt; &#34;filebeat&#34; #从redis中导入的key，与filebeat输出对应
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     type =&gt; &#34;redis-input&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     db =&gt; 0 #导入key的数据库，默认为0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">filter {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # 判断redis字符串在不在自己定义的新字段中，用于区分日志类型，做对应的处理
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> if &#39;redis&#39; in [app] {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     # 聚合redis日志
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     grok {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		   # 自定义匹配日志内容，默认一条日志从上到下只会匹配一次对的。且只会匹配一个字段，如需要匹配多个字段，需进行严格匹配
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		   patterns_dir =&gt; [&#34;/opt/elk/patterns_time&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		   # grok提供很多自带的正则，可供使用
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        match =&gt; { &#34;message&#34; =&gt; &#34;%{LOGTIME</span>:log_time<span style="color:#f92672">}</span><span style="color:#e6db74">&#34; }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		   # （?&lt;自定义的&gt;要匹配的内容）
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        match =&gt; { &#34;</span>message<span style="color:#e6db74">&#34; =&gt; &#34;</span><span style="color:#f92672">(</span>?&lt;log_time&gt;%<span style="color:#f92672">{</span>TIMESTAMP_ISO8601<span style="color:#f92672">})</span>.*session <span style="color:#f92672">(</span>?&lt;session&gt;.*<span style="color:#ae81ff">\S</span>$<span style="color:#f92672">)</span><span style="color:#e6db74">&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     date {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		    # 修改采集时间为日志里的时间
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         match =&gt; [&#34;</span>log_time<span style="color:#e6db74">&#34;, &#34;</span>yyyy-MM-dd HH:mm<span style="color:#e6db74">&#34;,&#34;</span>dd MMM yyyy HH:mm:ss.SSS<span style="color:#e6db74">&#34; ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         locale =&gt; &#34;</span>en<span style="color:#e6db74">&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     ruby {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         code =&gt; &#34;</span>event.set<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;timestamp&#39;</span>, event.get<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;@timestamp&#39;</span><span style="color:#f92672">)</span>.time.localtime - 8*60*60<span style="color:#f92672">)</span><span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     ruby {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         code =&gt; &#34;</span>event.set<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;@timestamp&#39;</span>,event.get<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;timestamp&#39;</span><span style="color:#f92672">))</span><span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     mutate {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		      # 转换字段类型，用于聚合操作
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">           convert =&gt; { &#34;</span>session<span style="color:#e6db74">&#34; =&gt; &#34;</span>string<span style="color:#e6db74">&#34; }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			  # 删除无用字段
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">           remove_field =&gt; [&#34;</span>log_time<span style="color:#e6db74">&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	 # 将logstash时间转化中国时间,logstash默认为utc时间，比中国时间慢8个小时（修改的是采集时间，对日志时间没有影响）
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ruby {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     code =&gt; &#34;</span>event.set<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;timestamp&#39;</span>, event.get<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;@timestamp&#39;</span><span style="color:#f92672">)</span>.time.localtime + 8*60*60<span style="color:#f92672">)</span><span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ruby {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     code =&gt; &#34;</span>event.set<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;@timestamp&#39;</span>,event.get<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;timestamp&#39;</span><span style="color:#f92672">))</span><span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  mutate {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     remove_field =&gt; [&#34;</span>timestamp<span style="color:#e6db74">&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">output {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # 用于调试
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # stdout{ codec =&gt; rubydebug }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> #####  创建线上环境索引  ######
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if &#39;online_82&#39; in [app] {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     elasticsearch {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       action =&gt; &#34;</span>index<span style="color:#e6db74">&#34; #The operation on ES
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       hosts =&gt; &#34;</span>127.0.0.1:9200<span style="color:#e6db74">&#34; # ElasticSearch host, can be array.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		  # 输出到es中的索引
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       index =&gt; &#34;</span>online_82_%<span style="color:#f92672">{</span>+YYYY.MM.dd<span style="color:#f92672">}</span><span style="color:#e6db74">&#34; #The index to write data to.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       user =&gt; &#34;</span>elastic<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       password =&gt; &#34;</span>dtyn!@<span style="color:#e6db74">$&#34; }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		 # 对应filebeat中[tags],用对应索引进行判断
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   if [tags][0] == &#39;count&#39; {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     elasticsearch {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       action =&gt; &#34;</span>index<span style="color:#e6db74">&#34; #The operation on ES
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       hosts =&gt; &#34;</span>127.0.0.1:9200<span style="color:#e6db74">&#34; #ElasticSearch host, can be array.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       index =&gt; &#34;</span>online_82_redis_count<span style="color:#e6db74">&#34; #The index to write data to.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       user =&gt; &#34;</span>elastic<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       password =&gt; &#34;</span>dtyn!@$<span style="color:#e6db74">&#34; }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->检查配置、启动服务<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 添加&#34;--configtest&#34;或者&#34;-t&#34;参数检查配置语法是否有误</span>
</span></span><span style="display:flex;"><span>$ /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/nginx.conf --config.test_and_exit
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动程序后台运行&#34;&amp;&#34;</span>
</span></span><span style="display:flex;"><span>$ nohup /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/nginx.conf &amp;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># &#34;screen&#34; 启动另一个终端 </span>
</span></span><span style="display:flex;"><span>$ /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/nginx.conf
</span></span><span style="display:flex;"><span>$ screen -ls
</span></span><span style="display:flex;"><span>$ screen -r <span style="color:#ae81ff">16582</span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h2 id="beats部署"><code>Beats</code>部署</h2>
<blockquote>
<ul>
<li><code>Beats</code>是由<code>Elastic</code>公司开发和维护的一组开源数据采集器。它们设计用于从各种数据源收集数据，然后将数据发送到<code>Elasticsearch</code>或者<code>Logstash</code>等后端存储和分析系统中</li>
</ul>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://www.elastic.co/guide/en/beats/libbeat/current/index.html" rel="external" target="_self">官方文档</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.elastic.co/cn/downloads/beats/" rel="external" target="_self">选择一个<code>Beat</code>任何<code>Beat</code>皆可</a></td>
<td>-</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h3 id="filebeat部署"><code>Filebeat</code>部署</h3>
<blockquote>
<ul>
<li><code>Filebeat</code>用于轻量级日志和文件数据收集。<code>Filebeat</code>可以监控指定的日志文件或位置，收集日志数据，并将其发送到<code>Elasticsearch</code>或<code>Logstash</code>进行存储和分析</li>
<li><a href="https://www.elastic.co/cn/downloads/beats/filebeat" rel="external" target="_self">下载安装<code>Filebeat</code></a></li>
</ul>
<blockquote>
<ul>
<li><a href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-installation-configuration.html" rel="external" target="_self"><code>Filebeat</code>安装配置编辑</a></li>
<li><a href="https://www.cnblogs.com/cjsblog/p/9495024.html" rel="external" target="_self"><code>Filebeat</code>模块与配置</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ curl -L -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-8.3.3-linux-x86_64.tar.gz
</span></span><span style="display:flex;"><span>$ tar xzvf filebeat-8.3.3-linux-x86_64.tar.gz</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>Filebeat</code></li>
</ul>
<blockquote>
<ul>
<li><code>filebeat.yml</code>文件</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># 动态配置，允许从外部文件加载输入</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">filebeat.config.inputs</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/etc/filebeat/input.d/*.yml</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">reload.enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">reload.period</span>: <span style="color:#ae81ff">10s</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 动态模块配置 </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">filebeat.config.modules</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">path</span>: <span style="color:#ae81ff">${path.config}/modules.d/*.yml</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">reload.enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">setup.template.settings</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">index.number_of_shards</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">index.codec</span>: <span style="color:#ae81ff">best_compression</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">index.mapping</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">dynamic</span>: <span style="color:#66d9ef">false</span>  <span style="color:#75715e"># 关闭自动字段识别</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">processors</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">add_host_metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">when.not.contains.tags</span>: <span style="color:#ae81ff">forwarded</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">add_docker_metadata</span>: {}  	<span style="color:#75715e"># 也可以使用：~</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">drop_fields</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">fields</span>: [<span style="color:#e6db74">&#34;agent.ephemeral_id&#34;</span>, <span style="color:#e6db74">&#34;agent.hostname&#34;</span>, <span style="color:#e6db74">&#34;agent.id&#34;</span>, <span style="color:#e6db74">&#34;agent.name&#34;</span>, <span style="color:#e6db74">&#34;agent.type&#34;</span>, <span style="color:#e6db74">&#34;agent.version&#34;</span>, <span style="color:#e6db74">&#34;headers&#34;</span>]
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">rename</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">fields</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">from</span>: <span style="color:#e6db74">&#34;url&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">to</span>: <span style="color:#e6db74">&#34;url_host&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ignore_missing</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">fail_on_error</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#####  	Outputs  	#####</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  reids output</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">output.redis</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>: [<span style="color:#e6db74">&#34;Redis服务所在IP:6379&#34;</span>] <span style="color:#75715e"># 输出到redis的ip端口号</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">password</span>: <span style="color:#e6db74">&#34;password&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">key</span>: <span style="color:#e6db74">&#34;filebeat&#34;</span> <span style="color:#75715e"># 输出到redis中的key，这个key是一个列表，llen key查看长度  lrange key 0 -1 查看列表所有的值</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">timeout</span>: <span style="color:#ae81ff">30</span> <span style="color:#75715e"># 连接redis超时时间，默认为5s</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">output.elasticsearch</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>: [<span style="color:#e6db74">&#34;&lt;节点01的IP&gt;:9200&#34;</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 指定每次向 Elasticsearch 批量发送的最大事件，以字节为单位</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">bulk_max_size</span>: <span style="color:#ae81ff">2048</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 间隔 5秒，强制将积累的事件发送到 Elasticsearch，确保数据能够及时被处理</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">flush_interval</span>: <span style="color:#ae81ff">5s</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template.name</span>: <span style="color:#e6db74">&#34;filebeat&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template.path</span>: <span style="color:#e6db74">&#34;filebeat.template.json&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template.overwrite</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">username</span>: <span style="color:#e6db74">&#34;elastic&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">password</span>: <span style="color:#e6db74">&#34;changeme&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 启用压缩，减少网络带宽使用</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">compression_level</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">index</span>: <span style="color:#e6db74">&#34;nginx-%{[fields.application]}-%{+yyyy.MM.dd}&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">indices</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">when.equals</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">fields.application</span>: [<span style="color:#e6db74">&#39;app-docker-nginx_access&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">output.elasticsearch</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>: [<span style="color:#e6db74">&#34;&lt;节点01的IP&gt;:9200&#34;</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">api_key</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">index</span>: <span style="color:#e6db74">&#34;nginx-%{[fields.application]}-%{+yyyy.MM.dd}&#34;</span>  <span style="color:#75715e"># fields.application参数修改</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">indices</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">when.equals</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">fields.application</span>: [<span style="color:#e6db74">&#39;app-docker-nginx_access&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">output.elasticsearch</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>: [<span style="color:#e6db74">&#34;https://myEShost:9200&#34;</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">username</span>: <span style="color:#e6db74">&#34;filebeat_internal&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">password</span>: <span style="color:#e6db74">&#34;YOUR_PASSWORD&#34;</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ssl</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ca_trusted_fingerprint</span>: <span style="color:#e6db74">&#34;b9a10bbe64ee9826abeda6546fc988c8bf798b41957c33d05db736716513dc9c&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Kibana Setup</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">setup.kibana</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">host</span>: <span style="color:#e6db74">&#34;mykibanahost:5601&#34;</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">username</span>: <span style="color:#e6db74">&#34;my_kibana_user&#34;</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">password</span>: <span style="color:#e6db74">&#34;{pwd}&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 自定义模板格式</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">setup.ilm.enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">setup.template.name</span>: <span style="color:#e6db74">&#34;nginx&#34;</span>  	<span style="color:#75715e"># 模板名称</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">setup.template.pattern</span>: <span style="color:#e6db74">&#34;nginx-*&#34;</span>  	<span style="color:#75715e"># 匹配模板类型</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">setup.template.enabled</span>: <span style="color:#66d9ef">false</span>  	<span style="color:#75715e"># false：不使用默认模板，true：使用默认模板</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">setup.template.overwrite</span>: <span style="color:#66d9ef">true</span>  	<span style="color:#75715e"># 是否覆盖原来模板</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">setup.template</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;filebeat-logs&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">pattern</span>: <span style="color:#e6db74">&#34;filebeat-logs-*&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">mappings</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">properties</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">level</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">type</span>: <span style="color:#ae81ff">keyword</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ts</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">type</span>: <span style="color:#ae81ff">date</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">format</span>: <span style="color:#e6db74">&#34;yyyy-MM-dd HH:mm:ss&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">file_name</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">type</span>: <span style="color:#ae81ff">keyword</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">msg</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">type</span>: <span style="color:#ae81ff">keyword</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ti</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">type</span>: <span style="color:#ae81ff">keyword</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">route</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">type</span>: <span style="color:#ae81ff">keyword</span></span></span></code></pre></div><ul>
<li><code>/opt/filebeat/input.d/*.yaml</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">filebeat.inputs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">type</span>: <span style="color:#ae81ff">log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span> <span style="color:#75715e"># True表示收集</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># pasths配置收集日志的路径，支持配置多条路径，及多目录</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">/opt/app/nacos-1.3.2/nacos/bin/logs/*.log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># tags 标记;可以用来区分日志,这是一个列表可以写多个标记</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tags</span>: [<span style="color:#e6db74">&#34;nacos&#34;</span>] 
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># fileds创建新的字段，默认是二级字段，可以自定义多个key: value</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">fields</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">test_71_nacos-1.3.2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 让新建的字段变成顶级字段，减少不必要的资源开销</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">fields_under_root</span>: <span style="color:#66d9ef">true</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 让filebeat采集最新的日志变化，忽略掉之前旧日志</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tail_files</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 下边这几项可以不用</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># filebeat依靠文件描述符识别文件，当发生重命名或移动，filebeat依然采集的原文件。</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">close_renamed</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Filebeat 在多长时间后关闭文件的处理，5分钟</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">close_inactive</span>: <span style="color:#ae81ff">5m</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 等待再次检查文件的时间，默认是10s</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">max_backoff</span>: <span style="color:#ae81ff">1s</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 此选项指定等待时间的增加速度,1表示禁用回算算法</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">backoff_factor</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 控制日志文件的检查频率，每10秒检查一次</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scan_frequency</span>: <span style="color:#ae81ff">10s</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 开启 json日志格式</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">json.keys_under_root</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">json.overwrite_keys</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">json.message_key</span>: <span style="color:#ae81ff">message</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">json.add_error_key</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##### 	 filbeat也可以采集jar堆栈日志：多行日志内容为一条日志</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">type</span>: <span style="color:#ae81ff">log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">/opt/app/nacos-1.3.2/nacos/bin/logs/*.log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">multiline</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 自定义每条日志的开头</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">pattern: &#39;\# Time</span>: <span style="color:#ae81ff">\d{4}-\d{2}-\d{2}&#39;</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#75715e"># 定义模式是否被否定,默认值为false</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#f92672">negate</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#75715e"># 与模式不匹配的连续行将追加到匹配的上一行</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#f92672">match</span>: <span style="color:#ae81ff">after</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#####  	</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">type</span>: <span style="color:#ae81ff">log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">/usr/local/nginx/logs/gitlab.log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">fields</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">application</span>: <span style="color:#ae81ff">app-docker-nginx_access</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->列出以及使用模块<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ./filebeat modules list
</span></span><span style="display:flex;"><span>$ ./filebeat modules enable nginx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- module: nginx
</span></span><span style="display:flex;"><span>  access:
</span></span><span style="display:flex;"><span>    enabled: true
</span></span><span style="display:flex;"><span>    var.paths: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;/var/log/nginx/access.log*&#34;</span><span style="color:#f92672">]</span> </span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->检测启动<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ./filebeat setup -e
</span></span><span style="display:flex;"><span>$ chown root filebeat.yml 
</span></span><span style="display:flex;"><span>$ chown root modules.d/nginx.yml 
</span></span><span style="display:flex;"><span>$ ./filebeat -e</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="metricbeat部署"><code>Metricbeat</code>部署</h3>
<blockquote>
<ul>
<li><a href="https://www.elastic.co/guide/en/beats/metricbeat/current/metricbeat-installation-configuration.html" rel="external" target="_self"><code>Metricbeat</code></a></li>
<li><code>Metricbeat</code>用于定时收集系统和服务的指标数据。<code>Metricbeat</code>支持收集各种服务（如<code>Redis</code>、<code>Apache</code>、<code>MySQL</code>等）的性能指标，并将这些数据发送到<code>Elasticsearch</code>或者其他数据存储和可视化工具中</li>
</ul>
</blockquote>
<hr>
<h3 id="packetbeat部署"><code>Packetbeat</code>部署</h3>
<blockquote>
<ul>
<li><a href="https://www.elastic.co/guide/en/beats/packetbeat/current/packetbeat-installation-configuration.html" rel="external" target="_self"><code>Packetbeat</code></a></li>
<li><code>Packetbeat</code>用于实时网络数据分析。<code>Packetbeat</code>可以监控网络流量，捕获和分析应用层协议（如<code>HTTP</code>、<code>MySQL</code>、<code>DNS</code>等）的数据，帮助识别问题和优化网络性能</li>
</ul>
</blockquote>
<hr>
<h3 id="heartbeat部署"><code>Heartbeat</code>部署</h3>
<blockquote>
<ul>
<li><code>Heartbeat</code>用于监控服务的可用性。<code>Heartbeat</code>可以定期检查服务、网站或者主机的可访问性，并记录响应时间和状态，以帮助运维人员快速发现和解决故障。</li>
</ul>
</blockquote>
<hr>
<h3 id="auditbeat部署"><code>Auditbeat</code>部署</h3>
<blockquote>
<ul>
<li><code>Auditbeat</code>用于收集系统审计日志。<code>Auditbeat</code>监控操作系统和文件系统的活动，包括文件访问、用户登录等安全相关事件，并将这些事件发送到中心化的日志管理系统</li>
</ul>
</blockquote>
<hr>
<h2 id="kibana部署"><code>Kibana</code>部署</h2>
<blockquote>
<ul>
<li>
<p><a href="https://www.elastic.co/guide/en/kibana/current/index.html" rel="external" target="_self">部署<code>Kibana</code>图形化展示官方文档</a></p>
</li>
<li>
<p><code>Kibana</code>是由<code>Elastic</code>公司开发的开源数据可视化工具，用于对<code>Elasticsearch</code>索引中的数据进行搜索、分析和可视化。它是<code>Elastic Stack</code>（也称为<code>ELK Stack</code>）中的一个重要组件，与<code>Elasticsearch</code>、<code>Logstash</code>和<code>Beats</code>一起构成了一个强大的数据分析平台</p>
</li>
<li>
<p>是一个基于浏览器页面的<code>Elasticsearch</code>前端展示工具，也是一个开源和免费的工具，<code>Kibana</code>可以为<code>Logstash</code>和<code>ElasticSearch</code>提供的日志分析友好的<code>Web</code>界面，可以帮你汇总、分析和搜索重要数据日志</p>
</li>
<li>
<p><strong>主要功能和特点：</strong></p>
</li>
</ul>
<blockquote>
<ul>
<li>
<p><strong>数据查询和搜索</strong>：</p>
<p><code>Kibana</code>提供了一个直观的搜索和查询界面，允许用户在<code>Elasticsearch</code>索引中执行复杂的搜索操作。用户可以使用<code>Lucene</code>&gt; 查询语法或者结构化的查询构建器来筛选和查找数据。</p>
</li>
<li>
<p><strong>数据可视化</strong>：</p>
<p><code>Kibana</code>允许用户将<code>Elasticsearch</code>&gt; 中的数据通过各种图表（如折线图、柱状图、饼图等）和图形化展示方式进行可视化。这些图表可以帮助用户直观地理解数据的趋势、关系和模式</p>
</li>
<li>
<p><strong>仪表盘和视图</strong>：</p>
<p>用户可以通过创建仪表盘<code>Dashboard</code>&gt; 来集成多个数据可视化组件，形成一个全面的数据展示和监控面板。仪表盘可以包含多个图表、指标和数据表格，为用户提供全面的数据洞察力</p>
</li>
<li>
<p><strong>实时数据分析</strong>：</p>
<p><code>Kibana</code>支持实时数据分析和实时查询，用户可以即时查看和分析数据的变化和趋势。这对于监控和操作实时系统特别有用</p>
</li>
<li>
<p><strong>用户权限和安全性</strong>：</p>
<p><code>Kibana</code>提供了灵活的用户权限管理和安全功能，允许管理员定义和控制用户对不同数据和功能的访问权限。这对于多用户和多团队协作使用的环境非常重要。</p>
</li>
<li>
<p><strong>插件和扩展性</strong>：</p>
<p><code>Kibana</code>提供了丰富的插件和可扩展的<code>API</code>，使得用户可以根据自己的需求和场景定制和扩展<code>Kibana</code>的功能。社区和第三方开发者可以通过插件扩展<code>Kibana</code>的功能，增加新的数据处理和可视化能力。</p>
</li>
</ul>
</blockquote>
<ul>
<li><strong>使用场景：</strong></li>
</ul>
<blockquote>
<ul>
<li>
<p><strong>日志分析和监控</strong>：</p>
<p>通过结合<code>Elasticsearch</code>和<code>Beats</code>，<code>Kibana</code>可以实时分析和监控日志数据，帮助用户快速发现和解决系统问题。</p>
</li>
<li>
<p><strong>应用性能监控</strong>：</p>
<p>通过集成<code>Metricbeat</code>和<code>Elasticsearch</code>，<code>Kibana</code>可以实时展示和分析应用程序的性能指标，帮助开发团队优化应用性能。</p>
</li>
<li>
<p><strong>安全事件分析</strong>：</p>
<p>结合<code>Auditbeat</code>和<code>Elasticsearch</code>，<code>Kibana</code>可以监控和分析系统和应用的安全事件，帮助安全团队及时响应和调查安全事件。</p>
</li>
</ul>
</blockquote>
<ul>
<li><a href="https://elastic.co/cn/downloads/kibana" rel="external" target="_self">下载、解压<code>Kibana</code>图形化展示工具</a></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ curl -O https://artifacts.elastic.co/downloads/kibana/kibana-8.3.3-linux-x86_64.tar.gz
</span></span><span style="display:flex;"><span>$ curl https://artifacts.elastic.co/downloads/kibana/kibana-8.3.3-linux-x86_64.tar.gz.sha512 | sha512sum -c - 
</span></span><span style="display:flex;"><span>$ tar -zxvf kibana-8.3.3-linux-x86_64.tar.gz
</span></span><span style="display:flex;"><span>$ cd kibana-8.3.3/ </span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->修改配置文件<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /usr/local/src/kibana-8.3.3/config
</span></span><span style="display:flex;"><span>$ cp kibana.yml<span style="color:#f92672">{</span>,.bak<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;# 配置端口，在6行位置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># server.port: 5601
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 去掉注释，修改为本机IP，在11行位置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># server.host: &#34;</span>Kibana服务所在IP<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 定义用户名称，用于标识 Kibana 实例
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># server.name: &#34;</span>your-hostname<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 启用或禁用 SSL
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># server.ssl.enabled: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># server.ssl.certificate: /path/to/your/server.crt
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># server.ssl.key: /path/to/your/server.key
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 去掉注释，修改为elssticsearch的IP地址和端口，在43行位置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># elasticsearch.hosts: [&#34;</span>http://elssticsearch服务IP:9200<span style="color:#e6db74">&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#####  	设置Elasticsearch参数配置   #####
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># elasticsearch.username: &#34;</span>kibana_system<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># elasticsearch.password: &#34;</span>password<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># elasticsearch.serviceAccountToken: &#34;</span>my_token<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># elasticsearch.pingTimeout: 1500
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># elasticsearch.requestTimeout: 30000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># elasticsearch.maxSockets: 1024
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># elasticsearch.compression: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># elasticsearch.requestHeadersWhitelist: [ authorization ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># elasticsearch.customHeaders: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># elasticsearch.shardTimeout: 30000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># elasticsearch.ssl.certificate: /path/to/your/client.crt
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># elasticsearch.ssl.key: /path/to/your/client.key
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># elasticsearch.ssl.certificateAuthorities: [ &#34;</span>/path/to/your/CA.pem<span style="color:#e6db74">&#34; ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># elasticsearch.ssl.verificationMode: full
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##### 语言配置English:&#34;</span>en<span style="color:#e6db74">&#34;, Chinese:&#34;</span>zh-CN<span style="color:#e6db74">&#34;, Japanese:&#34;</span>ja-JP<span style="color:#e6db74">&#34;, French:&#34;</span>fr-FR<span style="color:#e6db74">&#34; #####
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># i18n.locale: &#34;</span>en<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span>&gt;config/kibana.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># sed -i &#39;/kibana.index:/a\\kibana.index: &#34;.kibana&#34;&#39; kibana.yml  	# 新版不存在此参数</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->启动服务、处理不能删除索引问题<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->防火墙开放：5601<!-- raw HTML omitted --><!-- raw HTML omitted -->端口<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 检测启动方式  </span>
</span></span><span style="display:flex;"><span>$ ps -p <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ./bin/kibana
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 命令行执行</span>
</span></span><span style="display:flex;"><span>$ curl -XPUT -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> http://localhost:9200/_all/_settings -d <span style="color:#e6db74">&#39;{&#34;index.blocks.read_only_allow_delete&#34;:null}&#39;</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 浏览器</span>
</span></span><span style="display:flex;"><span>PUT _settings
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;index&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;blocks&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;read_only_allow_delete&#34;</span>: <span style="color:#e6db74">&#34;false&#34;</span>
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;delete-es-index.sh<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">date=`date -d &#34;7 days ago&#34; +%Y.%m.%d`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">curl -XDELETE -u &#39;elastic:dtyn!@$&#39; http://localhost:9200/*{$date}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="configure_elk">Configure_ELK</h1>

<h2 id="配置elasticsearchredis">配置<code>elasticsearch+redis</code></h2>
<ul>
<li>
<ol>
<li><code>elasticsearch</code><!-- raw HTML omitted -->出现问题怎么处理<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>接下来描述会遇见到的一个问题：一旦我们的<code>elasticsearch</code>出现问题，就不能进行日志采集处理了！这种情况下该怎么办呢？</li>
<li><!-- raw HTML omitted -->解决方案：<!-- raw HTML omitted -->可以在<code>client</code>和<code>elasticsearch</code>之间添加一个中间件作为缓存，先将采集到的日志内容写到中间件上，然后再从中间件输入到<code>elasticsearch</code>中。
这就完美的解决了上述的问题了。<code>ELK</code>中使用<code>redis</code>作为中间件，缓存日志采集内容</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ curl <span style="color:#e6db74">&#39;localhost:9200/_cat/health?v&#39;</span>  	<span style="color:#75715e"># 检测集群是否健康</span>
</span></span><span style="display:flex;"><span>$ curl <span style="color:#e6db74">&#39;localhost:9200/_cat/nodes?v&#39;</span>  	<span style="color:#75715e"># 获取集群节点列表</span>
</span></span><span style="display:flex;"><span>$ curl <span style="color:#e6db74">&#39;localhost:9200/_cat/indices?v&#39;</span>  	<span style="color:#75715e"># 列出所有索引</span>
</span></span><span style="display:flex;"><span>$ curl -u user_name:password -X GET <span style="color:#e6db74">&#34;http://localhost:9200/_cluster/health?pretty&#34;</span>
</span></span><span style="display:flex;"><span>$ curl -XPUT <span style="color:#e6db74">&#39;localhost:9200/customer?pretty&#39;</span>  	<span style="color:#75715e"># 创建一个名为&#34;customer&#34;的索引</span>
</span></span><span style="display:flex;"><span>$ curl -XDELETE <span style="color:#e6db74">&#39;localhost:9200/customer?pretty&#39;</span>  	<span style="color:#75715e"># 删除一个名为&#34;customer&#34;的索引</span>
</span></span><span style="display:flex;"><span>$ curl localhost:9200/_cat/segments/<span style="color:#f92672">{</span>indexName<span style="color:#f92672">}</span>|wc -l  	<span style="color:#75715e"># 查看某个索引的段数量：GET /nginx-2022-*/_segments</span>
</span></span><span style="display:flex;"><span>$ curl -XPOST 192.168.60.7:9200/indexName/_forcemerge?max_num_segments<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>  	<span style="color:#75715e"># 合并某个索引的段</span>
</span></span><span style="display:flex;"><span>POST /nginx-2022-*/_forcemerge?max_num_segments<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>  	<span style="color:#75715e"># 支持通配符</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;delete_es_index.sh<span style="color:#e6db74">&lt;&lt;-EOF 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 定期删除两个月之前elasticsearch索引
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">date=`date -d &#34;-2 months&#34; &#34;+%Y.%m&#34;`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/usr/bin/curl -v --user elastic:elastic用户密码 -XDELETE &#34;http://es机器IP:9200/*-$date&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>Redis</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat /etc/redis.conf  	<span style="color:#75715e"># 修改下面两行内容</span>
</span></span><span style="display:flex;"><span>daemonize yes
</span></span><span style="display:flex;"><span>bind 192.168.1.160
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ systemctl start redis
</span></span><span style="display:flex;"><span>$ lsof -i:6379
</span></span><span style="display:flex;"><span>COMMAND     PID  USER   FD   TYPE  DEVICE SIZE/OFF NODE NAME
</span></span><span style="display:flex;"><span>redis-ser <span style="color:#ae81ff">19474</span> redis    4u  IPv4 <span style="color:#ae81ff">1344465</span>      0t0  TCP elk-node1:6379 <span style="color:#f92672">(</span>LISTEN<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ redis-cli -h 192.168.1.160
</span></span><span style="display:flex;"><span>192.168.1.160:6379&gt; info
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Server</span>
</span></span><span style="display:flex;"><span>redis_version:2.8.19
</span></span><span style="display:flex;"><span>.......</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->编写从<!-- raw HTML omitted --><code>Client</code><!-- raw HTML omitted -->端收集数据的文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat /opt/logstash/data/redis-out.conf
</span></span><span style="display:flex;"><span>input <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>stdin <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>output <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>redis <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>host <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;192.168.1.160&#34;</span>
</span></span><span style="display:flex;"><span>port <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6379&#34;</span>
</span></span><span style="display:flex;"><span>db <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6&#34;</span>
</span></span><span style="display:flex;"><span>data_type <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;list&#34;</span>
</span></span><span style="display:flex;"><span>key <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;demo&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->执行收集数据的文件，并输入数据<!-- raw HTML omitted --><code>hello redis</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /opt/logstash/bin/logstash -f redis-out.conf 
</span></span><span style="display:flex;"><span>Settings: Default filter workers: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>Logstash startup completed  	<span style="color:#75715e"># 下面输入数据hello redis</span>
</span></span><span style="display:flex;"><span>hello redis</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->在<!-- raw HTML omitted --><code>redis</code><!-- raw HTML omitted -->中查看数据<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ redis-cli -h 192.168.1.160
</span></span><span style="display:flex;"><span>192.168.1.160:6379&gt; info
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Server</span>
</span></span><span style="display:flex;"><span>.......
</span></span><span style="display:flex;"><span>.......
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Keyspace</span>
</span></span><span style="display:flex;"><span>db6:keys<span style="color:#f92672">=</span>1,expires<span style="color:#f92672">=</span>0,avg_ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>  	<span style="color:#75715e"># 在最下面一行，显示是db6</span>
</span></span><span style="display:flex;"><span>192.168.1.160:6379&gt; <span style="color:#66d9ef">select</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>192.168.1.160:6379<span style="color:#f92672">[</span>6<span style="color:#f92672">]</span>&gt; keys *
</span></span><span style="display:flex;"><span>1<span style="color:#f92672">)</span> <span style="color:#e6db74">&#34;demo&#34;</span>
</span></span><span style="display:flex;"><span>192.168.1.160:6379<span style="color:#f92672">[</span>6<span style="color:#f92672">]</span>&gt; LINDEX demo -1
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;{\&#34;message\&#34;:\&#34;hello redis\&#34;,\&#34;@version\&#34;:\&#34;1\&#34;,\&#34;@timestamp\&#34;:\&#34;2016-11-14T08:04:25.981Z\&#34;,\&#34;host\&#34;:\&#34;elk-node1\&#34;}&#34;</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="6">
<li><!-- raw HTML omitted -->继续随便写点数据测试<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /opt/logstash/bin/logstash -f redis-out.conf
</span></span><span style="display:flex;"><span>Settings: Default filter workers: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>Logstash startup completed
</span></span><span style="display:flex;"><span>hello redis
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">123456</span>
</span></span><span style="display:flex;"><span>asdf
</span></span><span style="display:flex;"><span>ert
</span></span><span style="display:flex;"><span>wang
</span></span><span style="display:flex;"><span>shi
</span></span><span style="display:flex;"><span>bo
</span></span><span style="display:flex;"><span>guohuihui
</span></span><span style="display:flex;"><span>as
</span></span><span style="display:flex;"><span>we
</span></span><span style="display:flex;"><span>r
</span></span><span style="display:flex;"><span>g
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asdfjkdfsak
</span></span><span style="display:flex;"><span>5423wer
</span></span><span style="display:flex;"><span>34rt3
</span></span><span style="display:flex;"><span>6y
</span></span><span style="display:flex;"><span>7uj
</span></span><span style="display:flex;"><span>u
</span></span><span style="display:flex;"><span>io9
</span></span><span style="display:flex;"><span>sdjfhsdk890
</span></span><span style="display:flex;"><span>huanqiu
</span></span><span style="display:flex;"><span>huanqiuchain
</span></span><span style="display:flex;"><span>hqsb
</span></span><span style="display:flex;"><span>asda    </span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="7">
<li><!-- raw HTML omitted -->在<!-- raw HTML omitted --><code>redis</code><!-- raw HTML omitted -->中查看长度<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ redis-cli -h 192.168.1.160
</span></span><span style="display:flex;"><span>192.168.1.160:6379&gt; info
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Server</span>
</span></span><span style="display:flex;"><span>redis_version:2.8.19
</span></span><span style="display:flex;"><span>.......
</span></span><span style="display:flex;"><span>.......
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Keyspace</span>
</span></span><span style="display:flex;"><span>db6:keys<span style="color:#f92672">=</span>1,expires<span style="color:#f92672">=</span>0,avg_ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>  	<span style="color:#75715e"># 显示是db6</span>
</span></span><span style="display:flex;"><span>192.168.1.160:6379&gt; <span style="color:#66d9ef">select</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>192.168.1.160:6379<span style="color:#f92672">[</span>6<span style="color:#f92672">]</span>&gt; keys *
</span></span><span style="display:flex;"><span>1<span style="color:#f92672">)</span> <span style="color:#e6db74">&#34;demo&#34;</span>
</span></span><span style="display:flex;"><span>192.168.1.160:6379<span style="color:#f92672">[</span>6<span style="color:#f92672">]</span>&gt; LLEN demo
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>integer<span style="color:#f92672">)</span> <span style="color:#ae81ff">24</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="8">
<li><!-- raw HTML omitted -->将<!-- raw HTML omitted --><code>redis</code><!-- raw HTML omitted -->中的内容写到<!-- raw HTML omitted --><code>elasticsearch</code><!-- raw HTML omitted -->中<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ vim redis-in.conf
</span></span><span style="display:flex;"><span>input <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>redis <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span> host <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;192.168.1.160&#34;</span>
</span></span><span style="display:flex;"><span> port <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6379&#34;</span>
</span></span><span style="display:flex;"><span> db <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6&#34;</span>
</span></span><span style="display:flex;"><span> data_type <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;list&#34;</span>
</span></span><span style="display:flex;"><span> key <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;demo&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>output <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>elasticsearch <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span> hosts <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;192.168.1.160:9200&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span> index <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;redis-in-%{+YYYY.MM.dd}&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="9">
<li><!-- raw HTML omitted -->执行<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /opt/logstash/bin/logstash -f  redis-in.conf --configtest
</span></span><span style="display:flex;"><span>Configuration OK
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ /opt/logstash/bin/logstash -f  redis-in.conf &amp;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在redis中查看，发现数据已被读出：</span>
</span></span><span style="display:flex;"><span>192.168.1.160:6379<span style="color:#f92672">[</span>6<span style="color:#f92672">]</span>&gt; LLEN demo
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>integer<span style="color:#f92672">)</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 登陆elasticsearch界面查看</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="10">
<li><!-- raw HTML omitted -->将收集到的所有日志写入到<!-- raw HTML omitted --><code>redis</code><!-- raw HTML omitted -->中。这了重新定义一个添加<!-- raw HTML omitted --><code>redis</code><!-- raw HTML omitted -->缓存后的总文件<!-- raw HTML omitted --><code>shipper.conf</code><!-- raw HTML omitted -->。（可以将之前执行的总文件<!-- raw HTML omitted --><code>file.conf</code><!-- raw HTML omitted -->停掉）<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ vim shipper.conf
</span></span><span style="display:flex;"><span>input <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>file <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span> path <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;/var/log/messages&#34;</span>
</span></span><span style="display:flex;"><span> type <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;system&#34;</span>
</span></span><span style="display:flex;"><span> start_position <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;beginning&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>file <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  path <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;/var/log/elasticsearch/huanqiu.log&#34;</span>
</span></span><span style="display:flex;"><span>  type <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;es-error&#34;</span>
</span></span><span style="display:flex;"><span>  start_position <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;beginning&#34;</span>
</span></span><span style="display:flex;"><span>  codec <span style="color:#f92672">=</span>&gt; multiline <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      pattern <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;^\[&#34;</span>
</span></span><span style="display:flex;"><span>      negate <span style="color:#f92672">=</span>&gt; true
</span></span><span style="display:flex;"><span>      what <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;previous&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>file <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>   path <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;/var/log/nginx/access_json.log&#34;</span>
</span></span><span style="display:flex;"><span>   codec <span style="color:#f92672">=</span>&gt; json
</span></span><span style="display:flex;"><span>   start_position <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;beginning&#34;</span>
</span></span><span style="display:flex;"><span>   type <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;nginx-log&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>syslog <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    type <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;system-syslog&#34;</span>
</span></span><span style="display:flex;"><span>    host <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;192.168.1.160&#34;</span>
</span></span><span style="display:flex;"><span>    port <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;514&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>output <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span>type<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;system&#34;</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span> redis <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    host <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;192.168.1.160&#34;</span>
</span></span><span style="display:flex;"><span>    port <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6379&#34;</span>
</span></span><span style="display:flex;"><span>    db <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6&#34;</span>
</span></span><span style="display:flex;"><span>    data_type <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;list&#34;</span>
</span></span><span style="display:flex;"><span>    key <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;system&#34;</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span>type<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;es-error&#34;</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  redis <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>   host <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;192.168.1.160&#34;</span>
</span></span><span style="display:flex;"><span>   port <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6379&#34;</span>
</span></span><span style="display:flex;"><span>   db <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6&#34;</span>
</span></span><span style="display:flex;"><span>   data_type <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;list&#34;</span>
</span></span><span style="display:flex;"><span>   key <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;demo&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span>type<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;nginx-log&#34;</span><span style="color:#f92672">{</span>   
</span></span><span style="display:flex;"><span>   redis <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      host <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;192.168.1.160&#34;</span>
</span></span><span style="display:flex;"><span>      port <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6379&#34;</span>
</span></span><span style="display:flex;"><span>      db <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6&#34;</span>
</span></span><span style="display:flex;"><span>      data_type <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;list&#34;</span>
</span></span><span style="display:flex;"><span>      key <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;nginx-log&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span>type<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;system-syslog&#34;</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>   redis <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      host <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;192.168.1.160&#34;</span>
</span></span><span style="display:flex;"><span>      port <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6379&#34;</span>
</span></span><span style="display:flex;"><span>      db <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6&#34;</span>
</span></span><span style="display:flex;"><span>      data_type <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;list&#34;</span>
</span></span><span style="display:flex;"><span>      key <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;system-syslog&#34;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">}</span>   
</span></span><span style="display:flex;"><span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="11">
<li><!-- raw HTML omitted -->执行上面的文件（提前将上面之前启动的<!-- raw HTML omitted --><code>file.conf</code><!-- raw HTML omitted -->文件的执行给结束掉！）<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$  /opt/logstash/bin/logstash -f shipper.conf --configtest
</span></span><span style="display:flex;"><span>Configuration OK
</span></span><span style="display:flex;"><span>$ /opt/logstash/bin/logstash -f shipper.conf
</span></span><span style="display:flex;"><span>Settings: Default filter workers: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>Logstash startup completed
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在redis中查看：</span>
</span></span><span style="display:flex;"><span>$ redis-cli -h 192.168.1.160
</span></span><span style="display:flex;"><span>192.168.1.160:6379&gt; info
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Server</span>
</span></span><span style="display:flex;"><span>redis_version:2.8.19
</span></span><span style="display:flex;"><span>.......
</span></span><span style="display:flex;"><span>.......
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Keyspace</span>
</span></span><span style="display:flex;"><span>db6:keys<span style="color:#f92672">=</span>1,expires<span style="color:#f92672">=</span>0,avg_ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>  	<span style="color:#75715e"># 显示是db6</span>
</span></span><span style="display:flex;"><span>192.168.1.160:6379&gt; <span style="color:#66d9ef">select</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>192.168.1.160:6379<span style="color:#f92672">[</span>6<span style="color:#f92672">]</span>&gt; keys *
</span></span><span style="display:flex;"><span>1<span style="color:#f92672">)</span> <span style="color:#e6db74">&#34;demo&#34;</span>
</span></span><span style="display:flex;"><span>2<span style="color:#f92672">)</span> <span style="color:#e6db74">&#34;system&#34;</span>
</span></span><span style="display:flex;"><span>192.168.1.160:6379<span style="color:#f92672">[</span>6<span style="color:#f92672">]</span>&gt; keys *
</span></span><span style="display:flex;"><span>1<span style="color:#f92672">)</span> <span style="color:#e6db74">&#34;nginx-log&#34;</span>
</span></span><span style="display:flex;"><span>2<span style="color:#f92672">)</span> <span style="color:#e6db74">&#34;demo&#34;</span>
</span></span><span style="display:flex;"><span>3<span style="color:#f92672">)</span> <span style="color:#e6db74">&#34;system&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 另开一个窗口，添加点日志:</span>
</span></span><span style="display:flex;"><span>$ logger <span style="color:#e6db74">&#34;12325423&#34;</span>
</span></span><span style="display:flex;"><span>$ logger <span style="color:#e6db74">&#34;12325423&#34;</span>
</span></span><span style="display:flex;"><span>$ logger <span style="color:#e6db74">&#34;12325423&#34;</span>
</span></span><span style="display:flex;"><span>$ logger <span style="color:#e6db74">&#34;12325423&#34;</span>
</span></span><span style="display:flex;"><span>$ logger <span style="color:#e6db74">&#34;12325423&#34;</span>
</span></span><span style="display:flex;"><span>$ logger <span style="color:#e6db74">&#34;12325423&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 又会增加日志：</span>
</span></span><span style="display:flex;"><span>192.168.1.160:6379<span style="color:#f92672">[</span>6<span style="color:#f92672">]</span>&gt; keys *
</span></span><span style="display:flex;"><span>1<span style="color:#f92672">)</span> <span style="color:#e6db74">&#34;system-syslog&#34;</span>
</span></span><span style="display:flex;"><span>2<span style="color:#f92672">)</span> <span style="color:#e6db74">&#34;nginx-log&#34;</span>
</span></span><span style="display:flex;"><span>3<span style="color:#f92672">)</span> <span style="color:#e6db74">&#34;demo&#34;</span>
</span></span><span style="display:flex;"><span>4<span style="color:#f92672">)</span> <span style="color:#e6db74">&#34;system&#34;</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="12">
<li><!-- raw HTML omitted -->可以在任意的一台<!-- raw HTML omitted --><code>ES</code><!-- raw HTML omitted -->中将数据从<!-- raw HTML omitted --><code>redis</code><!-- raw HTML omitted -->读取到<!-- raw HTML omitted --><code>ES</code><!-- raw HTML omitted -->中。
下面咱们在<!-- raw HTML omitted --><code>elk-node2</code><!-- raw HTML omitted -->节点，将数据从<!-- raw HTML omitted --><code>redis</code><!-- raw HTML omitted -->读取到<!-- raw HTML omitted --><code>ES</code><!-- raw HTML omitted -->中：
编写文件：<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat file.conf
</span></span><span style="display:flex;"><span>input <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>redis <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>   type <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;system&#34;</span>
</span></span><span style="display:flex;"><span>   host <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;192.168.1.160&#34;</span>
</span></span><span style="display:flex;"><span>   port <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6379&#34;</span>
</span></span><span style="display:flex;"><span>   db <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6&#34;</span>
</span></span><span style="display:flex;"><span>   data_type <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;list&#34;</span>
</span></span><span style="display:flex;"><span>   key <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;system&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> redis <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>   type <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;es-error&#34;</span>
</span></span><span style="display:flex;"><span>   host <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;192.168.1.160&#34;</span>
</span></span><span style="display:flex;"><span>   port <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6379&#34;</span>
</span></span><span style="display:flex;"><span>   db <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6&#34;</span>
</span></span><span style="display:flex;"><span>   data_type <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;list&#34;</span>
</span></span><span style="display:flex;"><span>   key <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;es-error&#34;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>   redis <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      type <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;nginx-log&#34;</span>
</span></span><span style="display:flex;"><span>      host <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;192.168.1.160&#34;</span>
</span></span><span style="display:flex;"><span>      port <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6379&#34;</span>
</span></span><span style="display:flex;"><span>      db <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6&#34;</span>
</span></span><span style="display:flex;"><span>      data_type <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;list&#34;</span>
</span></span><span style="display:flex;"><span>      key <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;nginx-log&#34;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  redis <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      type <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;system-syslog&#34;</span>
</span></span><span style="display:flex;"><span>      host <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;192.168.1.160&#34;</span>
</span></span><span style="display:flex;"><span>      port <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6379&#34;</span>
</span></span><span style="display:flex;"><span>      db <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;6&#34;</span>
</span></span><span style="display:flex;"><span>      data_type <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;list&#34;</span>
</span></span><span style="display:flex;"><span>      key <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;system-syslog&#34;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">}</span>   
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>output <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span>type<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;system&#34;</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    elasticsearch <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>       hosts <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;192.168.1.160:9200&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>       index <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;system-%{+YYYY.MM.dd}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span>type<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;es-error&#34;</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    elasticsearch <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>       hosts <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;192.168.1.160:9200&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>       index <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;es-error-%{+YYYY.MM.dd}&#34;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span>type<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;nginx-log&#34;</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>   elasticsearch <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      hosts <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;192.168.1.160:9200&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>      index <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;nignx-log-%{+YYYY.MM.dd}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span>type<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;system-syslog&#34;</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    elasticsearch <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>       hosts <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;192.168.1.160:9200&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>       index <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;system-syslog-%{+YYYY.MM.dd}&#34;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 执行</span>
</span></span><span style="display:flex;"><span>$ /opt/logstash/bin/logstash -f file.conf --configtest
</span></span><span style="display:flex;"><span>Configuration OK
</span></span><span style="display:flex;"><span>$ /opt/logstash/bin/logstash -f file.conf &amp;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 去redis中检查，发现数据已经被读出到elasticsearch中了、同时登陆logstash和kibana看，发现可以正常收集到日志了。</span>
</span></span><span style="display:flex;"><span>192.168.1.160:6379<span style="color:#f92672">[</span>6<span style="color:#f92672">]</span>&gt; keys *
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>empty list or set<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 可以执行这个 去查看nginx日志、也可以启动多个redis写到ES中，具体根据自己的实际情况而定。</span>
</span></span><span style="display:flex;"><span>$ ab -n10000 -c1 http://192.168.1.160/ </span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          </section>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="message_queue">Message_Queue</h1>


            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Message_Queue</h1>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_activemq">Install_ActiveMQ</h1>

<h2 id="activemq部署"><code>ActiveMQ</code>部署</h2>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->通过<!-- raw HTML omitted --><code>http://localhost:8161/admin/</code><!-- raw HTML omitted -->来访问<!-- raw HTML omitted --><code>ActiveMQ</code><!-- raw HTML omitted -->的控制台界面<!-- raw HTML omitted -->.</li>
<li>账号：<code>admin</code></li>
<li>密码：<code>admin</code></li>
<li>端口：<code>8161</code>：后台管理系统，<code>61616</code>：给<code>JAVA</code>程序连接的<code>TCP</code>端口</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo wget https://archive.apache.org/dist/activemq/5.15.16/apache-activemq-5.15.16-bin.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ tar zxvf apache-activemq-5.15.16-bin.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ bin<span style="color:#ae81ff">\a</span>ctivemq start
</span></span><span style="display:flex;"><span>$ bin<span style="color:#ae81ff">\a</span>ctivemq stop
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 发送消息的示例</span>
</span></span><span style="display:flex;"><span>$ bin<span style="color:#ae81ff">\a</span>ctivemq producer --message <span style="color:#e6db74">&#34;My message&#34;</span> --messageCount <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 收消息的示例</span>
</span></span><span style="display:flex;"><span>$ bin<span style="color:#ae81ff">\a</span>ctivemq consumer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 控制台输出</span>
</span></span><span style="display:flex;"><span>$ bin<span style="color:#ae81ff">\a</span>ctivemq consumer</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_rocketmq">Install_RocketMQ</h1>

<h2 id="rocketmq部署"><code>Rocketmq</code>部署</h2>
<h3 id="单机单实例">单机单实例</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>Rocketmq</code><!-- raw HTML omitted -->必要条件<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>64</code><!-- raw HTML omitted -->位<!-- raw HTML omitted --><code>JDK 1.8+</code></li>
<li><!-- raw HTML omitted --><code>Maven 3.2.x</code><!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted --><code>Git</code><!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->使用于<!-- raw HTML omitted --><code>Broker</code><!-- raw HTML omitted -->服务器<!-- raw HTML omitted --><code>4G+</code><!-- raw HTML omitted -->可用磁盘空间<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>JDK</code><!-- raw HTML omitted -->配置环境变量<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><a href="https://www.oracle.com/java/technologies/oracle-java-archive-downloads.html" rel="external" target="_self">打开链接找早期版本</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ tar -zxvf /usr/local/src/jdk-8u181-linux-x64.tar.gz -C /usr/local/src/  	<span style="color:#75715e"># 加压到指定位置</span>
</span></span><span style="display:flex;"><span>$ ln -s /usr/local/src/jdk1.8.0_181 /usr/local/jdk  	<span style="color:#75715e"># 做个软链接，取消软链接rm -rf /usr/local/jdk  文件后不要加&#34;/&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 添加环境变量</span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">HISTSIZE=10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export TMOUT=600
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export HISTTIMEFORMAT=&#34;%F %T &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#######JDK環境變數########################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export JAVA_HOME=/usr/local/jdk
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export JRE_HOME=$JAVA_HOME/jre
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export CLASSPATH=$JAVA_HOME/lib:$JAVA_HOME/lib/tools.jar
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export PATH=$PATH:$JAVA_HOME/bin:$JAVA_HOME/jre/bin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;</span>&gt;&gt; /etc/profile
</span></span><span style="display:flex;"><span>$ source /etc/profile</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted --><a href="https://maven.apache.org/download.cgi" rel="external" target="_self">部署<code>maven3.2.2</code>版本</a><!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget -P /usr/local/src/ https://downloads.apache.org/maven/maven-3/3.8.1/binaries/apache-maven-3.8.1-bin.tar.gz
</span></span><span style="display:flex;"><span>$ tar -zxvf /usr/local/src/apache-maven-3.8.1-bin.tar.gz -C /usr/local/src/
</span></span><span style="display:flex;"><span>$ ln -s /usr/local/src/apache-maven-3.8.1/ /usr/local/maven
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#39;#####  添加maven环境变量  ########
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export MAVEN_HOME=/usr/local/maven
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export PATH=${PATH}:${MAVEN_HOME}/bin&#39;</span> &gt;&gt;/etc/profile
</span></span><span style="display:flex;"><span>source /etc/profile
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cp /usr/local/src/apache-maven-3.8.1/conf/settings.xml ~/.m2/  	# 拷贝文件到此目录下</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># vim  ~/.m2/settings.xml</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &lt;profiles&gt;  	# 拷贝下面几行到&lt;profiles&gt;下</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &lt;repositories&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#        &lt;repository&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#          &lt;id&gt;org.codehaus&lt;/id&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#          &lt;url&gt;https://repo1.maven.org/maven2/org/codehaus/&lt;/url&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#        &lt;/repository&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      &lt;/repositories&gt;</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted --><a href="https://rocketmq.apache.org/docs/quick-start/" rel="external" target="_self">下载并解压<code>rocketmq</code>安装包、使用<code>mvn</code>打包</a><!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install unzip
</span></span><span style="display:flex;"><span>$ wget -P /usr/local/src/ https://downloads.apache.org/rocketmq/4.8.0/rocketmq-all-4.8.0-source-release.zip
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 二进制文件包</span>
</span></span><span style="display:flex;"><span>$ wget -P /usr/local/src/ https://downloads.apache.org/rocketmq/4.8.0/rocketmq-all-4.8.0-bin-release.zip
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ unzip /usr/local/src/rocketmq-all-4.8.0-source-release.zip -d /usr/local/src/  	<span style="color:#75715e"># 解压到指定位置</span>
</span></span><span style="display:flex;"><span>$ cd /usr/local/src/rocketmq-all-4.8.0-source-release
</span></span><span style="display:flex;"><span>$ mvn -Prelease-all -DskipTests clean install -U
</span></span><span style="display:flex;"><span>$ cd distribution/target/rocketmq-4.8.0/rocketmq-4.8.0</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->启动名称服务器<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ nohup sh bin/mqnamesrv &amp;
</span></span><span style="display:flex;"><span>$ tail -f ~/logs/rocketmqlogs/namesrv.log</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->先修改经纪人服务器配置文件<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ vim /usr/local/src/rocketmq-all-4.8.0-source-release/distribution/target/rocketmq-4.8.0/rocketmq-4.8.0/bin/runbroker.sh
</span></span><span style="display:flex;"><span>JAVA_OPT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>JAVA_OPT<span style="color:#e6db74">}</span><span style="color:#e6db74"> -server -Xms128m -Xmx256m -Xmn256m&#34;</span>  	<span style="color:#75715e"># 此处几个参数需要修改</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ vim /usr/local/src/rocketmq-all-4.8.0-source-release/distribution/target/rocketmq-4.8.0/rocketmq-4.8.0/bin/runserver.sh
</span></span><span style="display:flex;"><span>JAVA_OPT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>JAVA_OPT<span style="color:#e6db74">}</span><span style="color:#e6db74"> -server -Xms128m -Xmx256m -Xmn256m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=320m&#34;</span>  	<span style="color:#75715e"># 修改Xms128m -Xmx256m &gt; -Xmn256m</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->启动经纪人服务<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ tail -f ~/logs/rocketmqlogs/broker.log  	<span style="color:#75715e"># 报错异常关闭selinux</span>
</span></span><span style="display:flex;"><span>The broker<span style="color:#f92672">[</span>%s, 172.30.30.233:10911<span style="color:#f92672">]</span> boot success...</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->发送接收消息<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ export NAMESRV_ADDR<span style="color:#f92672">=</span>localhost:9876
</span></span><span style="display:flex;"><span>$ sh bin/tools.sh org.apache.rocketmq.example.quickstart.Producer
</span></span><span style="display:flex;"><span>$ sh bin/tools.sh org.apache.rocketmq.example.quickstart.Consumer</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->关闭服务器<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sh bin/mqshutdown broker
</span></span><span style="display:flex;"><span>The mqbroker<span style="color:#f92672">(</span>36695<span style="color:#f92672">)</span> is running...
</span></span><span style="display:flex;"><span>Send shutdown request to mqbroker<span style="color:#f92672">(</span>36695<span style="color:#f92672">)</span> OK
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sh bin/mqshutdown namesrv
</span></span><span style="display:flex;"><span>The mqnamesrv<span style="color:#f92672">(</span>36664<span style="color:#f92672">)</span> is running...
</span></span><span style="display:flex;"><span>Send shutdown request to mqnamesrv<span style="color:#f92672">(</span>36664<span style="color:#f92672">)</span> OK</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="集群模式部署">集群模式部署</h3>
<blockquote>
<ul>
<li><a href="https://github.com/apache/rocketmq/blob/master/docs/cn/operation.md" rel="external" target="_self">运维管理部署<code>Rocketmq</code></a></li>
<li><!-- raw HTML omitted -->启动<!-- raw HTML omitted --><code>NameServer</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ nohup sh  /usr/local/src/rocketmq-all-4.8.0-source-release/distribution/target/rocketmq-4.8.0/rocketmq-4.8.0/bin/mqnamesrv &amp;</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->验证<!-- raw HTML omitted --><code>Name Server</code><!-- raw HTML omitted -->是否启动成功<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ tail -f ~/logs/rocketmqlogs/namesrv.log
</span></span><span style="display:flex;"><span>2021-04-24 16:51:14 INFO main - The Name Server boot success. serializeType<span style="color:#f92672">=</span>JSON</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->查看并修改<!-- raw HTML omitted --><code>Rocketmq</code><!-- raw HTML omitted -->集群配置文件<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /usr/local/src/rocketmq-all-4.8.0-source-release/distribution/target/rocketmq-4.8.0/rocketmq-4.8.0/conf/2m-2s-sync
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@localhost 2m-2s-sync<span style="color:#f92672">]</span><span style="color:#75715e"># ll</span>
</span></span><span style="display:flex;"><span>-rw-r--r--. <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">928</span> Dec  <span style="color:#ae81ff">8</span> 18:16 broker-a.properties
</span></span><span style="display:flex;"><span>-rw-r--r--. <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">922</span> Dec  <span style="color:#ae81ff">8</span> 18:16 broker-a-s.properties
</span></span><span style="display:flex;"><span>-rw-r--r--. <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">928</span> Dec  <span style="color:#ae81ff">8</span> 18:16 broker-b.properties
</span></span><span style="display:flex;"><span>-rw-r--r--. <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">922</span> Dec  <span style="color:#ae81ff">8</span> 18:16 broker-b-s.properties
</span></span><span style="display:flex;"><span>-rw-------. <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">290</span> Apr <span style="color:#ae81ff">23</span> 22:47 nohup.out
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ vim broker-a-s.properties  	<span style="color:#75715e"># 主机做主从必添加两处</span>
</span></span><span style="display:flex;"><span>storePathRootDir<span style="color:#f92672">=</span>/opt/slave/broker-a-s
</span></span><span style="display:flex;"><span>listenPort <span style="color:#f92672">=</span> <span style="color:#ae81ff">10915</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>broker-a.properties</code><!-- raw HTML omitted -->配置文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;broker-a.properties<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 所属集群名字
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">brokerClusterName=rocketmq-cluster
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># broker名字，注意此处不同的配置文件填写的不一样，
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">brokerName=broker-a
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 0:表示 Master，&gt;0:表示 Slave
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">brokerId=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># nameServer地址，分号分割
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">namesrvAddr=mq-nameserver1:9876;mq-nameserver2:9876
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 在发送消息时，自动创建服务器不存在的topic，默认创建的队列数
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">defaultTopicQueueNums=4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 是否允许 Broker 自动创建Topic，建议线下开启，线上关闭
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">autoCreateTopicEnable=false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">autoCreateSubscriptionGroup=false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># Broker 对外服务的监听端口
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">listenPort=10911
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">haListenPort=10912
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 删除文件时间点，默认凌晨 4点
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">deleteWhen=04
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 文件保留时间，默认 48 小时
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fileReservedTime=120
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># commitLog每个文件的大小默认1G
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">mapedFileSizeCommitLog=1073741824
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ConsumeQueue每个文件默认存30W条，根据业务情况调整
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">mapedFileSizeConsumeQueue=300000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># destroyMapedFileIntervalForcibly=120000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># redeleteHangedFileInterval=120000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 检测物理文件磁盘空间
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">diskMaxUsedSpaceRatio=88
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 存储路径
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">storePathRootDir=/rocketmq/store
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># commitLog 存储路径
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">storePathCommitLog=/rocketmq/store/commitlog
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 消费队列存储路径存储路径
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">storePathConsumeQueue=/rocketmq/store/consumequeue
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 消息索引存储路径
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">storePathIndex=/rocketmq/store/index
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># checkpoint 文件存储路径
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">storeCheckpoint=/rocketmq/store/checkpoint
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># abort 文件存储路径
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">abortFile=/rocketmq/store/abort
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 限制的消息大小
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">maxMessageSize=65536
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># flushCommitLogLeastPages=4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># flushConsumeQueueLeastPages=2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># flushCommitLogThoroughInterval=10000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># flushConsumeQueueThoroughInterval=60000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># Broker 的角色
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># - ASYNC_MASTER 异步复制Master
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># - SYNC_MASTER 同步双写Master
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># - SLAVE
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">brokerRole=SYNC_MASTER
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 刷盘方式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># - ASYNC_FLUSH 异步刷盘
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># - SYNC_FLUSH 同步刷盘
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">flushDiskType=ASYNC_FLUSH
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># checkTransactionMessageEnable=false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 发消息线程池数量
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># sendMessageThreadPoolNums=128
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 拉消息线程池数量 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># pullMessageThreadPoolNums=128
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 强制指定本机IP，需要根据每台机器进行修改。官方介绍可为空，系统默认自动识别，但多网卡时IP地址可能读取错误
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">brokerIP1=10.125.15.124
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>broker-a-s.properties</code><!-- raw HTML omitted -->配置文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;broker-a-s.properties<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 所属集群名字
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">brokerClusterName=rocketmq-cluster
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># broker名字，注意此处不同的配置文件填写的不一样，
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">brokerName=broker-a-s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 0 表示 Master，&gt;0 表示 Slave
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">brokerId=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># nameServer地址，分号分割
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">namesrvAddr=mq-nameserver1:9876;mq-nameserver2:9876
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 在发送消息时，自动创建服务器不存在的topic，默认创建的队列数
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">defaultTopicQueueNums=4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 是否允许 Broker 自动创建Topic，建议线下开启，线上关闭
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">autoCreateTopicEnable=false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">autoCreateSubscriptionGroup=false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># Broker 对外服务的监听端口
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">listenPort=10923
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">haListenPort=10924
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 删除文件时间点，默认凌晨 4点
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">deleteWhen=04
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 文件保留时间，默认 48 小时
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fileReservedTime=120
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># commitLog每个文件的大小默认1G
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">mapedFileSizeCommitLog=1073741824
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ConsumeQueue每个文件默认存30W条，根据业务情况调整
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">mapedFileSizeConsumeQueue=300000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># destroyMapedFileIntervalForcibly=120000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># redeleteHangedFileInterval=120000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 检测物理文件磁盘空间
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">diskMaxUsedSpaceRatio=88
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 存储路径
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">storePathRootDir=/rocketmq/store-s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># commitLog 存储路径
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">storePathCommitLog=/rocketmq/store-s/commitlog
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 消费队列存储路径存储路径
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">storePathConsumeQueue=/rocketmq/store-s/consumequeue
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 消息索引存储路径
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">storePathIndex=/rocketmq/store-s/index
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># checkpoint 文件存储路径
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">storeCheckpoint=/rocketmq/store-s/checkpoint
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># abort 文件存储路径
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">abortFile=/rocketmq/store-s/abort
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 限制的消息大小
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">maxMessageSize=65536
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># flushCommitLogLeastPages=4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># flushConsumeQueueLeastPages=2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># flushCommitLogThoroughInterval=10000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># flushConsumeQueueThoroughInterval=60000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># Broker 的角色
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># - ASYNC_MASTER 异步复制Master
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># - SYNC_MASTER 同步双写Master
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># - SLAVE
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">brokerRole=SLAVE
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 刷盘方式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># - ASYNC_FLUSH 异步刷盘
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># - SYNC_FLUSH 同步刷盘
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">flushDiskType=ASYNC_FLUSH
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># checkTransactionMessageEnable=false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 发消息线程池数量
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># sendMessageThreadPoolNums=128
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 拉消息线程池数量 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># pullMessageThreadPoolNums=128
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 强制指定本机IP，需要根据每台机器进行修改。官方介绍可为空，系统默认自动识别，但多网卡时IP地址可能读取错误
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">brokerIP1=10.125.15.125
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>broker-b.properties</code><!-- raw HTML omitted -->配置文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;broker-b.properties<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 所属集群名字
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">brokerClusterName=rocketmq-cluster
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># broker名字，注意此处不同的配置文件填写的不一样，
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">brokerName=broker-b
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 0 表示 Master，&gt;0 表示 Slave
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">brokerId=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># nameServer地址，分号分割
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">namesrvAddr=mq-nameserver1:9876;mq-nameserver2:9876
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 在发送消息时，自动创建服务器不存在的topic，默认创建的队列数
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">defaultTopicQueueNums=4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 是否允许 Broker 自动创建Topic，建议线下开启，线上关闭
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">autoCreateTopicEnable=false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">autoCreateSubscriptionGroup=false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># Broker 对外服务的监听端口
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">listenPort=10911
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">haListenPort=10912
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 删除文件时间点，默认凌晨 4点
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">deleteWhen=04
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 文件保留时间，默认 48 小时
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fileReservedTime=120
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># commitLog每个文件的大小默认1G
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">mapedFileSizeCommitLog=1073741824
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ConsumeQueue每个文件默认存30W条，根据业务情况调整
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">mapedFileSizeConsumeQueue=300000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># destroyMapedFileIntervalForcibly=120000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># redeleteHangedFileInterval=120000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 检测物理文件磁盘空间
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">diskMaxUsedSpaceRatio=88
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 存储路径
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">storePathRootDir=/rocketmq/store
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># commitLog 存储路径
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">storePathCommitLog=/rocketmq/store/commitlog
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 消费队列存储路径存储路径
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">storePathConsumeQueue=/rocketmq/store/consumequeue
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 消息索引存储路径
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">storePathIndex=/rocketmq/store/index
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># checkpoint 文件存储路径
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">storeCheckpoint=/rocketmq/store/checkpoint
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># abort 文件存储路径
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">abortFile=/rocketmq/store/abort
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 限制的消息大小
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">maxMessageSize=65536
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># flushCommitLogLeastPages=4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># flushConsumeQueueLeastPages=2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># flushCommitLogThoroughInterval=10000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># flushConsumeQueueThoroughInterval=60000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># Broker 的角色
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># - ASYNC_MASTER 异步复制Master
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># - SYNC_MASTER 同步双写Master
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># - SLAVE
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">brokerRole=SYNC_MASTER
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 刷盘方式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># - ASYNC_FLUSH 异步刷盘
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># - SYNC_FLUSH 同步刷盘
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">flushDiskType=ASYNC_FLUSH
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># checkTransactionMessageEnable=false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 发消息线程池数量
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># sendMessageThreadPoolNums=128
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 拉消息线程池数量 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># pullMessageThreadPoolNums=128
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 强制指定本机IP，需要根据每台机器进行修改。官方介绍可为空，系统默认自动识别，但多网卡时IP地址可能读取错误
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">brokerIP1=10.125.15.125
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>broker-b-s.properties</code><!-- raw HTML omitted -->配置文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;broker-b-s.properties<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 所属集群名字
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">brokerClusterName=rocketmq-cluster
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># broker名字，注意此处不同的配置文件填写的不一样，
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">brokerName=broker-b-s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 0：表示Master，&gt;0：表示 Slave
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">brokerId=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># nameServer地址，分号分割
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">namesrvAddr=mq-nameserver1:9876;mq-nameserver2:9876
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 在发送消息时，自动创建服务器不存在的topic，默认创建的队列数
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">defaultTopicQueueNums=4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 是否允许 Broker 自动创建Topic，建议线下开启，线上关闭
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">autoCreateTopicEnable=false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">autoCreateSubscriptionGroup=false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># Broker 对外服务的监听端口
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">listenPort=10923
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">haListenPort=10924
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 删除文件时间点，默认凌晨 4点
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">deleteWhen=04
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 文件保留时间，默认 48 小时
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fileReservedTime=120
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># commitLog每个文件的大小默认1G
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">mapedFileSizeCommitLog=1073741824
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ConsumeQueue每个文件默认存30W条，根据业务情况调整
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">mapedFileSizeConsumeQueue=300000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># destroyMapedFileIntervalForcibly=120000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># redeleteHangedFileInterval=120000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 检测物理文件磁盘空间
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">diskMaxUsedSpaceRatio=88
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 存储路径
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">storePathRootDir=/rocketmq/store-s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># commitLog 存储路径
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">storePathCommitLog=/rocketmq/store-s/commitlog
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 消费队列存储路径存储路径
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">storePathConsumeQueue=/rocketmq/store-s/consumequeue
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 消息索引存储路径
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">storePathIndex=/rocketmq/store-s/index
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># checkpoint 文件存储路径
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">storeCheckpoint=/rocketmq/store-s/checkpoint
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># abort 文件存储路径
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">abortFile=/rocketmq/store-s/abort
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 限制的消息大小
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">maxMessageSize=65536
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># flushCommitLogLeastPages=4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># flushConsumeQueueLeastPages=2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># flushCommitLogThoroughInterval=10000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># flushConsumeQueueThoroughInterval=60000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># Broker 的角色
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># - ASYNC_MASTER 异步复制Master
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># - SYNC_MASTER 同步双写Master
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># - SLAVE
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">brokerRole=SLAVE
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 刷盘方式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># - ASYNC_FLUSH 异步刷盘
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># - SYNC_FLUSH 同步刷盘
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">flushDiskType=ASYNC_FLUSH
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># checkTransactionMessageEnable=false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 发消息线程池数量
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># sendMessageThreadPoolNums=128
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 拉消息线程池数量 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># pullMessageThreadPoolNums=128
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 强制指定本机IP，需要根据每台机器进行修改。官方介绍可为空，系统默认自动识别，但多网卡时IP地址可能读取错误
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">brokerIP1=10.125.15.124
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->在其他几个节点服务器启动<!-- raw HTML omitted --><code>Master</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ nohup sh mqbroker -n 192.168.1.1:9876 -c $ROCKETMQ_HOME/conf/2m-2s-async/broker-a.properties &amp;  	<span style="color:#75715e"># 在机器A机器启动Master</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ nohup sh mqbroker -n 192.168.1.1:9876 -c $ROCKETMQ_HOME/conf/2m-2s-async/broker-b.properties &amp;  	<span style="color:#75715e"># 在机器B机器启动Master</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ nohup sh mqbroker -n 192.168.1.1:9876 -c $ROCKETMQ_HOME/conf/2m-2s-async/broker-a-s.properties &amp;  	<span style="color:#75715e"># 在机器C机器启动Slave</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ nohup sh mqbroker -n 192.168.1.1:9876 -c $ROCKETMQ_HOME/conf/2m-2s-async/broker-b-s.properties &amp;  	<span style="color:#75715e"># 在机器C机器启动Slave</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>rocketmq-console</code><!-- raw HTML omitted -->图形化管理控制台<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->下载图形化管理控制台<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git clone https://github.com/apache/rocketmq-externals.git</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改配置文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/usr/local/src/rocketmq-externals/rocketmq-console/src/main/resources/application.properties<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 管理后台访问上下文路径，默认为空，如果填写，一定要前面加“/”，后面不要加，否则启动报错
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">server.contextPath=/rocketmq
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 访问端口
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">server.port=8080
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">### SSL setting  默认就行
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># server.ssl.key-store=classpath:rmqcngkeystore.jks
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># server.ssl.key-store-password=rocketmq
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># server.ssl.keyStoreType=PKCS12
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># server.ssl.keyAlias=rmqcngkey
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># spring.application.index=true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spring.application.name=rocketmq-console
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spring.http.encoding.charset=UTF-8
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spring.http.encoding.enabled=true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spring.http.encoding.force=true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># logback配置文件路径，先默认即可
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">logging.config=classpath:logback.xml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># if this value is empty,use env value rocketmq.config.namesrvAddr  NAMESRV_ADDR | now, you can set it in ops page.default &gt; localhost:9876
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># Name Server地址，修改成你自己的服务地址。多个地址用英文分号“;”隔开
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rocketmq.config.namesrvAddr=localhost:9876
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># if you use rocketmq version &lt; 3.5.8, rocketmq.config.isVIPChannel should be false.default true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rocketmq.config.isVIPChannel=
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># rocketmq-console&#39;s data path:dashboard/monitor
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rocketmq.config.dataPath=/tmp/rocketmq-console/data
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># set it false if you don&#39;t want use dashboard.default true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rocketmq.config.enableDashBoardCollect=true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># set the message track trace topic if you don&#39;t want use the default one
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rocketmq.config.msgTrackTopicName=
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rocketmq.config.ticketKey=ticket
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># Must create userInfo file: ${rocketmq.config.dataPath}/users.properties if the login is required
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rocketmq.config.loginRequired=false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->打包运行<!-- raw HTML omitted --><code>rocketmq-console</code><!-- raw HTML omitted -->服务<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mvn clean package -Dmaven.test.skip<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span>$ cd /usr/local/src/rocketmq-externals/rocketmq-console/target/
</span></span><span style="display:flex;"><span>$ java -jar rocketmq-console-ng-2.0.0.jar</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->打开浏览器访问<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ http://IP:8080/#/
</span></span><span style="display:flex;"><span>控制台→更换语言→Simplified Chinese<span style="color:#f92672">(</span>切换中文<span style="color:#f92672">)</span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_redpanda">Install_Redpanda</h1>

<h2 id="redpanda部署"><code>Redpanda</code>部署</h2>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://redpanda.com/" rel="external" target="_self"><code>Redpanda</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://docs.redpanda.com/current/deploy/deployment-option/self-hosted/" rel="external" target="_self"><code>Redpanda</code>部署文档</a></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_rabbitmq">Install_RabbitMQ</h1>

<h2 id="rabbitmq部署"><code>Rabbitmq</code>部署</h2>
<blockquote>
<ul>
<li><a href="https://blog.csdn.net/u011186019/article/details/51911234" rel="external" target="_self">安装<code>RabbitMQ</code></a></li>
<li><a href="https://docs.celeryq.dev/en/stable/" rel="external" target="_self"><code>Celery</code>分布式任务队列</a></li>
</ul>
</blockquote>
<hr>
<h3 id="rabbitmq集群安装"><code>RabbitMQ</code>集群安装</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->集群服务器配置<!-- raw HTML omitted --></li>
</ul>
<table>
<thead>
<tr>
<th><code>IP</code></th>
<th>主机名</th>
<th>节点属性</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.150.21</td>
<td><code>rabbit-mq-01</code></td>
<td>内存节点+<code>Haproxy</code>节点</td>
</tr>
<tr>
<td>192.168.150.22</td>
<td><code>rabbit-mq-02</code></td>
<td>内存节点+<code>Haproxy</code>节点</td>
</tr>
<tr>
<td>192.168.150.23</td>
<td><code>rabbit-mq-03</code></td>
<td>磁盘节点</td>
</tr>
<tr>
<td>192.168.150.24</td>
<td><code>keepalived vip</code></td>
<td>提供对外<code>VIP</code></td>
</tr>
</tbody>
</table>
<ul>
<li><code>Erlang</code><!-- raw HTML omitted -->安装<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code> RabbitMQ</code>是用<code>Erlang</code>语言编写的，我们将安装最新版本的<code>Erlang</code>到服务器中。 <code>Erlang</code>在默认的<code>YUM</code>存储库中不可用，因此您将需要安装<code>EPEL</code>存储库。 运行以下命令相同。 做好<code>hosts</code>解析，<!-- raw HTML omitted -->防火墙开放端口<!-- raw HTML omitted --><code>port 25672</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y update
</span></span><span style="display:flex;"><span>$ yum -y install epel-release
</span></span><span style="display:flex;"><span>$ yum -y install erlang socat</span></span></code></pre></div></blockquote>
<ul>
<li><code>RabbitMQ</code><!-- raw HTML omitted -->安装<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>RabbitMQ</code>为预编译并可以直接安装的企业<code>Linux系</code>统提供<code>RPM</code>软件包。 唯一需要的依赖是将<code>Erlang</code>安装到系统中。 我们已经安装<code>了Erlang</code>，我们可以进一步下载<code>RabbitMQ</code>。
通过运行下载<code>Erlang RPM</code>软件包</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rpm --import https://www.rabbitmq.com/rabbitmq-release-signing-key.asc
</span></span><span style="display:flex;"><span>$ wget https://www.rabbitmq.com/releases/rabbitmq-server/v3.6.10/rabbitmq-server-3.6.10-1.el7.noarch.rpm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ rpm -Uvh rabbitmq-server-3.6.10-1.el7.noarch.rpm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># https://github.com/rabbitmq/rabbitmq-server/releases/download/v3.7.19/rabbitmq-server-3.7.19-1.el7.noarch.rpm</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># https://github.com/rabbitmq/rabbitmq-server/releases/download/v3.7.19/rabbitmq-server-3.7.19-1.el7.noarch.rpm.asc</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->开启第一台<!-- raw HTML omitted --><code>MQ</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl start rabbitmq-server</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->复制<!-- raw HTML omitted --><code>.erlang.cookie</code><!-- raw HTML omitted -->文件到其他两台<!-- raw HTML omitted --><code>MQ</code><!-- raw HTML omitted -->服务器集群节点<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ scp /var/lib/rabbitmq/.erlang.cookie rabbit-mq-02:/var/lib/rabbitmq/
</span></span><span style="display:flex;"><span>$ scp /var/lib/rabbitmq/.erlang.cookie rabbit-mq-03:/var/lib/rabbitmq/</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->启动其他两台集群节点服务器上的<!-- raw HTML omitted --><code>MQ</code><!-- raw HTML omitted -->服务<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ chown -R rabbitmq. /var/lib/rabbitmq
</span></span><span style="display:flex;"><span>$ systemctl start rabbitmq-server</span></span></code></pre></div></blockquote>
<ul>
<li><code>Rabbitmq</code><!-- raw HTML omitted -->集群连接、集群节点之间防火墙开启：<!-- raw HTML omitted --><code>4369</code><!-- raw HTML omitted -->端口<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rabbitmqctl stop_app
</span></span><span style="display:flex;"><span>$ rabbitmqctl join_cluster rabbit@rabbit-mq-01
</span></span><span style="display:flex;"><span>$ rabbitmqctl start_app</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->设置镜像模式<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rabbitmqctl cluster_status
</span></span><span style="display:flex;"><span>$ rabbitmqctl set_policy ha-all <span style="color:#e6db74">&#34;^&#34;</span> <span style="color:#e6db74">&#39;{&#34;ha-mode&#34;:&#34;all&#34;}&#39;</span>
</span></span><span style="display:flex;"><span>$ rabbitmqctl cluster_status</span></span></code></pre></div></blockquote>
<ul>
<li>设置节点信息<!-- raw HTML omitted -->内存节点、磁盘节点<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rabbitmqctl stop_app
</span></span><span style="display:flex;"><span>$ rabbitmqctl change_cluster_node_type ram  	<span style="color:#75715e"># 类型(ram 内存)、(disc 硬盘)延迟插件必须硬盘</span>
</span></span><span style="display:flex;"><span>$ rabbitmqctl start_app</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->在所有节点机器上开启<!-- raw HTML omitted --><code>rabbit</code><!-- raw HTML omitted -->监控<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rabbitmq-plugins enable rabbitmq_management</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="rabbitmq用户授权"><code>Rabbitmq</code>用户授权</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->添加用户、用户密码都是：<!-- raw HTML omitted --><code>admin</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rabbitmqctl add_user admin admin</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->设置<!-- raw HTML omitted --><code>permissions</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rabbitmqctl set_permissions -p <span style="color:#e6db74">&#34;/&#34;</span> admin <span style="color:#e6db74">&#34;.*&#34;</span> <span style="color:#e6db74">&#34;.*&#34;</span> <span style="color:#e6db74">&#34;.*&#34;</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->设置用户角色权限<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rabbitmqctl set_user_tags admin administrator</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->防火墙开启：<!-- raw HTML omitted --><code>15672</code><!-- raw HTML omitted -->端口，使用浏览器访问<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ http://IP:15672/</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="rabbitmq安装延时插件"><code>RabbitMQ</code>安装延时插件</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->切换安装<!-- raw HTML omitted --><code>Rabbitmq</code><!-- raw HTML omitted -->服务主目录<!-- raw HTML omitted --><code>plugins</code><!-- raw HTML omitted -->下<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /usr/lib/rabbitmq/lib/rabbitmq_server-3.6.10/plugins</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->下载延时插件安装包<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget https://dl.bintray.com/rabbitmq/community-plugins/3.6.x/rabbitmq_delayed_message_exchange/&gt; rabbitmq_delayed_message_exchange-20171215-3.6.x.zip</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->解压延时插件安装包<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install unzip
</span></span><span style="display:flex;"><span>$ unzip  rabbitmq_delayed_message_exchange-20171215-3.6.x.zip
</span></span><span style="display:flex;"><span>$ cd ../sbin
</span></span><span style="display:flex;"><span>$ ./rabbitmq-plugins enable rabbitmq_delayed_message_exchange</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->重启<!-- raw HTML omitted --><code>Rabitymq</code><!-- raw HTML omitted -->服务<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl restart rabbitmq-server</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="haproxy部署"><code>HAProxy</code>部署</h3>
<blockquote>
<ul>
<li>使用<code>HAProxy</code>使<code>Rabbitmq</code>服务实现高可用</li>
<li><!-- raw HTML omitted -->两台服务器都安装<!-- raw HTML omitted --><code>HAProxy</code><!-- raw HTML omitted -->服务<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th><code>IP</code></th>
<th>主机名</th>
<th>节点属性</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.150.21</td>
<td><code>rabbit-mq-01</code></td>
<td>内存节点+<code>Haproxy</code>节点，<!-- raw HTML omitted -->端口：8888(<code>haproxy</code>监控端口)、8889(<code>rabbitmq</code>&gt; 服务端口)<!-- raw HTML omitted --></td>
</tr>
<tr>
<td>192.168.150.22</td>
<td><code>rabbit-mq-02</code></td>
<td>内存节点+<code>Haproxy</code>节点，<!-- raw HTML omitted -->端口：8888(<code>haproxy</code>监控端口)、8889(<code>rabbitmq</code>&gt; 服务端口)<!-- raw HTML omitted --></td>
</tr>
</tbody>
</table>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum install -y haproxy </span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->修改配置文件<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/haproxy/haproxy.cfg<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">global
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # log /yougo/haproxy/home/log    local0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # log /yougo/haproxy/home/log    local1 notice
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # chroot /yougo/haproxy         # 改变当前工作目录
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # stats socket /yougo/haproxy/home/admin.sock mode 660 level admin   # 创建监控所用的套接字目录
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> pidfile  /var/run/haproxy.pid   # haproxy的pid存放路径,启动进程的用户必须有权限访问此文件 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> maxconn  4000                   # 最大连接数，默认4000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> #  user   haproxy               # 默认用户
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> #  group   haproxy              # 默认用户组
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> daemon                          # 创建1个进程进入deamon模式运行。此参数要求将运行模式设置为&#34;daemon
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # Default SSL material locations
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # ca-base /etc/ssl/certs
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # crt-base /etc/ssl/private
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # Default ciphers to use on SSL-enabled listening sockets.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # For more information, see ciphers(1SSL). This list is from:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> #  https://hynek.me/articles/hardening-your-web-servers-ssl-ciphers/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # ssl-default-bind-ciphers &gt; ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AESGCM:RSA+AES:RSA+3DES:!aNULL:!MD5:!DSS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # ssl-default-bind-options no-sslv3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">###########默认配置#########
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">defaults
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> log global
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> mode    http                # 默认的模式mode { tcp|http|health }，tcp是4层，http是7层，health只会返回OK
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> option  httplog             # 采用http日志格式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> option  dontlognull         # 启用该项，日志中将不会记录空连接。所谓空连接就是在上游的负载均衡器或者监控系统为了探测该服务是否存活可用时,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                             # 需要定期的连接或者获取某一固定的组件或页面,或者探测扫描端口是否在监听或开放等动作被称为空连接;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                             # 官方文档中标注，如果该服务上游没有其他的负载均衡器的话，建议不要使用
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                             # 该参数，因为互联网上的恶意扫描或其他动作就不会被记录下来
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> timeout connect 5000        # 连接超时时间
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> timeout client  50000       # 客户端连接超时时间
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> timeout server  50000       # 服务器端连接超时时间
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> option  httpclose        # 每次请求完毕后主动关闭http通道 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> option  httplog          # 日志类别http日志格式 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> #option  forwardfor      # 如果后端服务器需要获得客户端真实ip需要配置的参数，可以从Http Header中获得客户端ip  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> option  redispatch       # serverId对应的服务器挂掉后,强制定向到其他健康的服务器
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> timeout connect 10000    # default 10 second timeout if a backend is not found
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> maxconn     60000        # 最大连接数
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> retries     3            # 3次连接失败就认为服务不可用，也可以通过后面设置 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # errorfile 400 /yougo/haproxy/home/errors/400.http
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # errorfile 403 /yougo/haproxy/home/errors/403.http
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # errorfile 408 /yougo/haproxy/home/errors/408.http
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # errorfile 500 /yougo/haproxy/home/errors/500.http
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # errorfile 502 /yougo/haproxy/home/errors/502.http
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # errorfile 503 /yougo/haproxy/home/errors/503.http
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # errorfile 504 /yougo/haproxy/home/errors/504.http
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">####################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">listen http_front
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     bind 0.0.0.0:8888           # 监听端口  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     stats refresh 30s           # 统计页面自动刷新时间  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     stats uri /haproxy?stats    # 统计页面url  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     stats realm Haproxy Manager # 统计页面密码框上提示文本  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     stats auth admin:admin      # 统计页面用户名和密码设置  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     #stats hide-version         # 隐藏统计页面上HAProxy的版本信息
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#####################RabbitMQ的管理界面也放在HAProxy后面了###############################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#listen rabbitmq_admin 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#    bind 0.0.0.0:8004
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#   server node1 192.168.0.31:15672
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#    server node2 192.168.0.32:15672
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#    server node3 192.168.0.33:15672
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">####################################################################
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">listen rabbitmq_cluster
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> bind 0.0.0.0:8889  	# rabbitmq集群调用的端口
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> option tcplog
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> mode tcp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> timeout client  3h
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> timeout server  3h
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> option          clitcpka
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> balance roundrobin  	# 负载均衡算法（#banlance roundrobin 轮询，balance source 保存session值，支持static-rr，leastconn，first，uri等参数）
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # balance url_param userid
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # balance url_param session_id check_post 64
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # balance hdr(User-Agent)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # balance hdr(host)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # balance hdr(Host) use_domain_only
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # balance rdp-cookie
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # balance leastconn
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # balance source //ip
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> server   rabbitmq1  172.16.0.30:5672 check inter 5s rise 2 fall 3  	# check inter 2000 是检测心跳频率，rise &gt; 2是2次正确认为服务器可用，fall 3是3次失败认为服务器不可用
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> server   rabbitmq2  172.16.0.31:5672 check inter 5s rise 2 fall 3  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> server   rabbitmq3  172.16.0.32:5672 check inter 5s rise 2 fall 3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->两台<!-- raw HTML omitted --><code>HAProxy</code><!-- raw HTML omitted -->服务器启动服务<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl start haproxy</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="keepalived部署"><code>Keepalived</code>部署</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>Keepalived</code><!-- raw HTML omitted -->服务<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum install -y keepalived</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>Keepalived</code><!-- raw HTML omitted -->主节点<!-- raw HTML omitted --><code>Master</code><!-- raw HTML omitted -->配置文件<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/keepalived/keepalived.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">global_defs {  	# 全局配置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">notification_email {  	# 指定keepalived在发生切换时需要需要发送Email的对象，一行一个
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   user@example.com  	# 指定的收件人
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">notification_email_from mail@example.org  	# 指定的发件人
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">smtp_server 192.168.200.1  	# 指定的SMTP服务器地址
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">smtp_connect_timeout 30  	# 指定SMTP连接超时时间
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">router_id Rabbitmq_Dev  	# 此处注意router_id为负载均衡标识，在局域网内应该是唯一
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">vrrp_instance VI_1 {  	# 监控多个网段的实例
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> state MASTER  	# 指定Keepalived的角色，MASTER表示此主机是主服务器,BACKUP表示此主机是备用服务器，所以设置priority时要注意MASTER比BACKUP高。如&gt; 果设置了nopreempt,那么state的这个值不起作用，主备靠priority决定，必须大写
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> nopreempt  	# 设置为不抢占
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> interface eth0  	# 指定监测网络的接口，当LVS接管时，将会把IP地址添加到该网卡上。
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> virtual_router_id 58  	# 虚拟路由标识，同一个vrrp实例使用唯一的标识，同一个vrrp_instance下，MASTER和BACKUP必须一致。
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> priority 101  	# MASTER权重要高于   BACKUP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> advert_int 1  	# 心跳报文发送间隔
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> unicast_src_ip 192.168.150.21  	# 配置单播的源地址
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> unicast_peer { 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     192.168.150.22  	# 配置单播的目标地址、对端IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> }  	# keepalived在组播模式下所有的信息都会向224.0.0.18的组播地址发送，产生众多的无用信息，并且会产生干扰和冲突，可以将组播的模式改为单拨。这是一种安&gt; 全的方法，避免局域网内有大量的keepalived造成虚拟路由id的冲突。
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> authentication {  	# 认证配置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     auth_type PASS  	# 主从服务器验证方式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     auth_pass 1111  	# 认证密码
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> virtual_ipaddress {  	# 设置虚拟IP地址，可以设置多个虚拟IP地址，每行一个
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     192.168.150.24/24 dev eth1 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> track_interface {  	# 设置额外的监控，里面那个网卡出现问题都会切换
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     eth0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>Keepalived</code><!-- raw HTML omitted -->备用节点<!-- raw HTML omitted --><code>Backup</code><!-- raw HTML omitted -->配置文件<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/keepalived/keepalived.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">global_defs {  	# 全局配置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">notification_email {  	# 指定在keepalived在发生切换时需要发送Email的对象，一行一个
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    user@example.com  	# 指定收件人
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">notification_email_from mail@example.org  	# 指定发件人
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">smtp_server 192.168.200.1  	# 指定SMTP服务器地址
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">smtp_connect_timeout 30  	# 指定SMTP连接超时时间
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">router_id Rabbitmq_Dev  	# 此处注意router_id为负载均衡表示，在局域网应该是唯一
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">vrrp_instance VI_1 {  	# 监控多个网段实例
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> state BACKUP  	# 指定Keepalived的角色，MASTER表示此主机是主服务器,BACKUP表示此主机是备用服务器，所以设置priority时要注意MASTER比BACKUP高。如&gt; 果设置了nopreempt,那么state的这个值不起作用，主备靠priority决定。
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> nopreempt  	# 设置为不抢占 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> interface eth0  	# 设置实例绑定的网卡
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> virtual_router_id 58  	# 虚拟路由标识，同一个vrrp实例使用唯一的标识，同一个vrrp_instance下，MASTER和BACKUP必须一致。
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> priority 100  	# 权重要低于MASTER
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> advert_int 1  	# 心跳报文发送间隔、检查间隔默认1秒
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> unicast_src_ip 192.168.150.22  	# 配置单播的源地址
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> unicast_peer { 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     192.168.150.21  	# 配置单播的目标地址、对端IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> }  	# keepalived在组播模式下所有的信息都会向224.0.0.18的组播地址发送，产生众多的无用信息，并且会产生干扰和冲突，可以将组播的模式改为单拨。这是一种安&gt; 全的方法，避免局域网内有大量的keepalived造成虚拟路由id的冲突。
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> authentication {  	# 设置认证
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     auth_type PASS  	# 认证方式有两种PASS、AH两种
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     auth_pass 1111  	# 认证密码
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # VIP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> virtual_ipaddress {  	# 设置虚拟IP地址，可以设置多个虚拟IP地址，每行一个
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     192.168.150.24/24 dev eth1 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->启动<!-- raw HTML omitted --><code>Keepalived</code><!-- raw HTML omitted -->服务<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl start keepalived</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h4 id="允许组播网段和vrrp协议通信">允许组播网段和<code>vrrp</code>协议通信</h4>
<blockquote>
<ul>
<li><code>centos7 firewalld</code>开启情况下，会阻断组播和<code>vrrp</code>的协议通信，导致<code>Keepalived</code>脑裂情况，需要在<code>keepalived</code>的两台服务器执行以下命令，就可以正常通信</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ firewall-cmd --direct --permanent --add-rule ipv4 filter INPUT <span style="color:#ae81ff">0</span> --in-interface 网卡名称<span style="color:#f92672">(</span>eth0<span style="color:#f92672">)</span> --destination 224.0.0.18 --protocol &gt; vrrp -j ACCEPT
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ firewall-cmd --reload</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->监控网络协议，查看是否有脑裂情况<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ tcpdump -i 网卡名称<span style="color:#f92672">(</span>eth0<span style="color:#f92672">)</span> vrrp -n</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>python</code><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>pika</code><!-- raw HTML omitted -->包进行测试<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum install -y python-pip
</span></span><span style="display:flex;"><span>$ pip install pika</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->生产端程序脚本<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;Production.py<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># !/usr/bin/env python
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">import pika
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">credentials = pika.PlainCredentials(&#39;admin&#39;,&#39;admin&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">connection = pika.BlockingConnection(pika.ConnectionParameters(
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> &#39;192.168.150.21&#39;,8889,&#39;/&#39;,credentials))
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">channel = connection.channel()
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">channel.queue_declare(queue=&#39;balance&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">channel.basic_publish(exchange=&#39;&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                   routing_key=&#39;balance&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                   body=&#39;Hello World!&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">print(&#34; [x] Sent &#39;Hello World!&#39;&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">connection.close()
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->消费端程序脚本<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;Consumption.py<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># !/usr/bin/env python
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">import pika
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">credentials = pika.PlainCredentials(&#39;admin&#39;,&#39;admin&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">connection = pika.BlockingConnection(pika.ConnectionParameters(
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> &#39;192.168.150.21&#39;,8889,&#39;/&#39;,credentials))
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">channel = connection.channel()
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">channel.queue_declare(queue=&#39;balance&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">channel.basic_publish(exchange=&#39;&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                   routing_key=&#39;balance&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                   body=&#39;Hello World!&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">print(&#34; [x] Sent &#39;Hello World!&#39;&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">connection.close()
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_nsq">Install_Nsq</h1>

<h2 id="nsq部署"><code>nsq</code>部署</h2>
<blockquote>
<ul>
<li><a href="https://nsq.io/deployment/installing.html" rel="external" target="_self"><code>Nsq</code>官网</a></li>
<li><!-- raw HTML omitted -->下载<!-- raw HTML omitted --><code>nsq</code><!-- raw HTML omitted -->预编译二进制安装包<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget -P /usr/local/src/ https://s3.amazonaws.com/bitly-downloads/nsq/nsq-1.2.1.linux-amd64.go1.16.6.tar.gz</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->解压启动安装包<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ tar -zxvf nsq-1.2.1.linux-amd64.go1.16.6.tar.gz -C /usr/local/src/
</span></span><span style="display:flex;"><span>$ cd nsq-1.2.1.linux-amd64.go1.16.6/bin/
</span></span><span style="display:flex;"><span>$ nohup ./nsqlookupd &amp;  	<span style="color:#75715e"># 启动nsqlookup</span>
</span></span><span style="display:flex;"><span>$ nohup ./nsqd --lookupd-tcp-address<span style="color:#f92672">=</span>127.0.0.1:4160 &amp;  	<span style="color:#75715e"># nsqd</span>
</span></span><span style="display:flex;"><span>$ nohup ./nsqadmin --lookupd-http-address<span style="color:#f92672">=</span>0.0.0.0:4161 --http-address<span style="color:#f92672">=</span>IP:8761 &amp; <span style="color:#75715e"># nsqadmin管理，ip需要更换为服务所在的服务器IP</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->测试、访问<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ curl -d <span style="color:#e6db74">&#39;hello world 1&#39;</span> <span style="color:#e6db74">&#39;http://127.0.0.1:4151/pub?topic=test&#39;</span>  	<span style="color:#75715e"># 写入消息</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ./nsq_to_file --topic<span style="color:#f92672">=</span>test --output-dir<span style="color:#f92672">=</span>/tmp/log --lookupd-http-address<span style="color:#f92672">=</span>127.0.0.1:4161  	<span style="color:#75715e"># 把队列消息写入到文件</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->通过浏览器访问<!-- raw HTML omitted -->nsqadmin</li>
</ul>
<blockquote>
<ul>
<li><code>http://IP:8761/</code></li>
</ul>
</blockquote>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_kafka">Install_Kafka</h1>

<h2 id="kafka部署"><code>Kafka</code>部署</h2>
<h3 id="kafka简介"><code>Kafka</code>简介</h3>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://kafka.apache.org/" rel="external" target="_self"><code>Kafka</code>官网</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://segmentfault.com/a/1190000012730949" rel="external" target="_self">安装及快速入门</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.cnblogs.com/gwyy/p/12206176.html" rel="external" target="_self"><code>php</code>安装<code>kafka</code>扩展</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://qii404.me/2018/02/02/kafka-cluster.html" rel="external" target="_self"><code>Kafka</code>集群搭建过程和简单使用</a></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>zookeeper</code><!-- raw HTML omitted -->保存所有集群主机消息内容<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->开发语言：<!-- raw HTML omitted --><code>Java/Scala</code><!-- raw HTML omitted -->，支持协议：仿<!-- raw HTML omitted --><code>AMQP</code></li>
<li><code>Kafka</code>是分布式发布-订阅消息系统,它最初由<code>LinkedIn</code>公司开发，之后成为<code>Apache</code>项目的一部分</li>
<li><code>Kafka</code>是一个分布式的，可划分的，冗余备份的持久性的日志服务，它主要用于处理活跃的流式数据</li>
<li>事务处理不支持、支持集群、支持负载均衡、支持<code>zookeeper</code>动态扩容</li>
<li>所有消息自动保存两天时间</li>
<li><code>Kafka</code>为了避免随机写入带来的时间消耗，采取顺序写的方式存储数据</li>
<li><code>Kafka</code>采用零拷贝技术，让数据传输更加迅速</li>
<li>批量读书数据，减少磁盘<code>IO</code>操作，可以提升性能</li>
<li>为了保证历史消息继续可以被消费，提供一个<code>offset</code>指向，通过指向来负责消息读取顺序</li>
<li>网络传输采用数据压缩格式，所以传输更快，占用带宽越少</li>
<li><code>Kafka</code>中数据可以设置副本，可以在出现问题之后依然保证该数据的有效性</li>
<li><code>Kafka</code><!-- raw HTML omitted -->整体采用显示分布式架构，<!-- raw HTML omitted --><code>producers</code>、<code>broker(Kafka)</code><!-- raw HTML omitted -->和<!-- raw HTML omitted --><code>consumers</code><!-- raw HTML omitted -->都可以有多个<!-- raw HTML omitted --></li>
<li><code>producer</code>、<code>consumer</code><!-- raw HTML omitted -->实现<!-- raw HTML omitted --><code>Kafka</code><!-- raw HTML omitted -->注册的接口，数据从<!-- raw HTML omitted --><code>producer</code><!-- raw HTML omitted -->发送到<!-- raw HTML omitted --><code>broker</code>，<code>broker</code><!-- raw HTML omitted -->承担一个中间缓存和分发的作用，<!-- raw HTML omitted --><code>broker</code><!-- raw HTML omitted -->分发注册到系统中的<!-- raw HTML omitted --><code>consumer</code></li>
<li><code>broker</code>的作用类似于缓存，即活跃的数据和离线处理系统之间的缓存，客户端和服务端的通信，是基于简单，高性能，且与编程语言无关的<code>TCP</code>协议</li>
<li><code>Topic</code><!-- raw HTML omitted -->：特指<!-- raw HTML omitted --><code>Kafka</code><!-- raw HTML omitted -->处理的消息源<!-- raw HTML omitted --><code>feeds of messages</code><!-- raw HTML omitted -->的不同分类<!-- raw HTML omitted --></li>
<li><code>Partition</code><!-- raw HTML omitted -->：代表分区，单核<!-- raw HTML omitted --><code>CPU</code><!-- raw HTML omitted -->一个分区，多个<!-- raw HTML omitted --><code>CPU</code><!-- raw HTML omitted -->可以有多个分区。<!-- raw HTML omitted --><code>Topic</code><!-- raw HTML omitted -->物理上的分组，一个<!-- raw HTML omitted --><code>topic</code><!-- raw HTML omitted -->可以分为多个<!-- raw HTML omitted --><code>partition</code><!-- raw HTML omitted -->，每个<!-- raw HTML omitted --><code>partition</code><!-- raw HTML omitted -->是一个有序的队列，<!-- raw HTML omitted --><code>partition</code><!-- raw HTML omitted -->中的每条消息都会被分配一个有序的<!-- raw HTML omitted --><code>id(offset)</code></li>
<li><code>Message</code><!-- raw HTML omitted -->：消息，是通信的基本单位，每个<!-- raw HTML omitted --><code>producer</code><!-- raw HTML omitted -->可以向一个<!-- raw HTML omitted --><code>topic</code><!-- raw HTML omitted -->(主题)发布一些消息<!-- raw HTML omitted --></li>
<li><code>Producers</code><!-- raw HTML omitted -->：消息和数据产生着，向<!-- raw HTML omitted --><code>Kafka</code>的一个<code>topic</code><!-- raw HTML omitted -->发布消息的过程叫做<!-- raw HTML omitted --><code>producers</code></li>
<li><code>Consumers</code><!-- raw HTML omitted -->：消息和数据消费者，订阅<!-- raw HTML omitted --><code>topics</code><!-- raw HTML omitted -->并处理其发布消息的过程叫做<!-- raw HTML omitted --><code>consumers</code></li>
<li><code>Broker</code><!-- raw HTML omitted -->：缓存代理，<!-- raw HTML omitted --><code>Kafka</code><!-- raw HTML omitted -->集群中的一台或者多台服务器统称为<!-- raw HTML omitted --><code>broker</code></li>
<li><code>offset</code><!-- raw HTML omitted -->与消息访问<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>消费者通过<code>offset</code>的方式来取得消息数据，利用<code>offset</code>偏移改变消息读取位置，可以实现历史消息读取</li>
<li>为了避免频繁的大量小数据磁盘<code>IO</code>操作，<code>Kafka</code>采用批量读取模式处理消息</li>
<li>在高负载状态下，为防止无效率的字节复制，<code>Kafka</code><!-- raw HTML omitted -->采用由<!-- raw HTML omitted --><code>Producer</code>，<code>broker</code><!-- raw HTML omitted -->和<!-- raw HTML omitted --><code>consumer</code>共享的标准化二进制消息格式，这样数据库就可以在它们之间自由传输，无需转换，降低了字节复制成本开销</li>
</ul>
</blockquote>
</blockquote>
</blockquote>
<hr>
<h3 id="kafka图形化页面"><code>Kafka</code>图形化页面</h3>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://juejin.cn/post/6971224791793532941#heading-4" rel="external" target="_self"><code>Kafka</code>图形化工具<code>Eagle</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/provectus/kafka-ui" rel="external" target="_self"><code>Apache Kafka</code>的用户界面</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/obsidiandynamics/kafdrop" rel="external" target="_self"><code>Kafdrop – Kafka Web UI</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/smartloli/EFAK" rel="external" target="_self"><code>Eagle For Apache Kafka</code>以前称为<code>Kafka Eagle</code></a></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h3 id="kafka单节点部署"><code>Kafka</code>单节点部署</h3>
<blockquote>
<ul>
<li><a href="https://kafka.apache.org/quickstart" rel="external" target="_self"><code>Kafka</code>安装</a></li>
<li><!-- raw HTML omitted -->单机部署单实例<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->下载、解压<!-- raw HTML omitted --><code>Kafka</code><!-- raw HTML omitted -->安装包<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget -P /usr/local/src/ https://archive.apache.org/dist/kafka/2.8.1/kafka_2.13-2.8.1.tgz
</span></span><span style="display:flex;"><span>$ tar -zxvf /usr/local/srckafka_2.13-2.8.1.tgz -C /opt/
</span></span><span style="display:flex;"><span>$ cd /opt/
</span></span><span style="display:flex;"><span>$ mv kafka_2.13-2.8.1/ kafka</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->单机单实例修改<!-- raw HTML omitted --><code>Kafka</code><!-- raw HTML omitted -->配置文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;/^dataDir=/cdataDir=\/opt\/kafka\/zookeeper&#39;</span> /opt/kafka/config/zookeeper.properties
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;/^broker.id=/cbroker.id=1&#39;</span> /opt/kafka/config/server.properties  	<span style="color:#75715e"># 集群设置不同id</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;/^log.dirs=/clog.dirs=/opt/kafka/logs/logs-1&#39;</span> /opt/kafka/config/server.properties
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Kafka默认端口号：9092，如果要修改默认端口执行下面两条命令</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;/#advertised.listeners/a port=9095&#39;</span> /opt/kafka/config/server.properties
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;/#advertised.listeners/a advertised.listeners=PLAINTEXT://$IP:9095&#39;</span> /opt/kafka/config/server.properties
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ mkdir -p /opt/kafka/<span style="color:#f92672">{</span>zookeeper,logs<span style="color:#f92672">}</span>  	<span style="color:#75715e"># 创建持久化目录</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->单机启动单实例<!-- raw HTML omitted --><code>zookeeper</code><!-- raw HTML omitted -->和<!-- raw HTML omitted --><code>Kafka</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /opt/kafka/bin/zookeeper-server-start.sh -daemon /opt/kafka/config/zookeeper.properties  	<span style="color:#75715e"># 后台启动zookeeper进程</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ /opt/kafka/bin/kafka-server-start.sh -daemon /opt/kafka/config/server.properties</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->执行检查命令<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ jps
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">14050</span> Kafka
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">10042</span> QuorumPeerMain
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">15724</span> Jps</span></span></code></pre></div><p><a href="#R-image-feb5188e82ce56c213c75d2e4c43bc1d" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kafka_Server/jps.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-feb5188e82ce56c213c75d2e4c43bc1d"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kafka_Server/jps.png"></a></p>
</blockquote>
</blockquote>
<hr>
<h3 id="kafka单节点多实例"><code>Kafka</code>单节点多实例</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->单机部署多实例集群模式<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>Kafka</code><!-- raw HTML omitted -->配置文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;/^dataDir=/cdataDir=\/opt\/kafka\/zookeeper&#39;</span> /opt/kafka/config/zookeeper.properties
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 拷贝修改kafka配置文件</span>
</span></span><span style="display:flex;"><span>$ cp /opt/kafka/config/server.properties /opt/kafka/config/server-2.properties
</span></span><span style="display:flex;"><span>$ cp /opt/kafka/config/server.properties /opt/kafka/config/server-3.properties
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改第一个实例配置</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;/^broker.id=/cbroker.id=1&#39;</span> /opt/kafka/config/server.properties  <span style="color:#75715e"># 集群设置不同id</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;/^log.dirs=/clog.dirs=/opt/kafka/logs/logs-1&#39;</span> /opt/kafka/config/server.properties
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;/#advertised.listeners/a advertised.listeners=PLAINTEXT://$IP:9092&#39;</span> /opt/kafka/config/server.properties
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改第二个实例</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;/^broker.id=/cbroker.id=2&#39;</span> /opt/kafka/config/server.properties  <span style="color:#75715e"># 集群设置不同id</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;/^log.dirs=/clog.dirs=/opt/kafka/logs/logs-2&#39;</span> /opt/kafka/config/server.properties
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;/#advertised.listeners/a advertised.listeners=PLAINTEXT://$IP:9093&#39;</span> /opt/kafka/config/server.properties
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改第三个实例</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;/^broker.id=/cbroker.id=3&#39;</span> /opt/kafka/config/server.properties  <span style="color:#75715e"># 集群设置不同id</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;/^log.dirs=/clog.dirs=/opt/kafka/logs/logs-3&#39;</span> /opt/kafka/config/server.properties
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;/#advertised.listeners/a advertised.listeners=PLAINTEXT://$IP:9094&#39;</span> /opt/kafka/config/server.properties</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->单机启动多实例<!-- raw HTML omitted --><code>zookeeper</code><!-- raw HTML omitted -->和<!-- raw HTML omitted --><code>Kafka</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /opt/kafka/bin/zookeeper-server-start.sh -daemon /opt/kafka/config/zookeeper.properties  	<span style="color:#75715e"># 后台启动zookeeper进程</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动Kafka多个实例</span>
</span></span><span style="display:flex;"><span>$ /opt/kafka/bin/kafka-server-start.sh -daemon /opt/kafka/config/server.properties
</span></span><span style="display:flex;"><span>$ /opt/kafka/bin/kafka-server-start.sh -daemon /opt/kafka/config/server-2.properties
</span></span><span style="display:flex;"><span>$ /opt/kafka/bin/kafka-server-start.sh -daemon /opt/kafka/config/server-3.properties</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="kafka集群模式"><code>Kafka</code>集群模式</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->多<!-- raw HTML omitted --><code>zookeeper</code><!-- raw HTML omitted -->多<!-- raw HTML omitted --><code>Kafka</code><!-- raw HTML omitted -->实例<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->下载、解压<!-- raw HTML omitted --><code>Kafka</code><!-- raw HTML omitted -->安装包<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget -P /usr/local/src/ https://archive.apache.org/dist/kafka/2.8.1/kafka_2.13-2.8.1.tgz
</span></span><span style="display:flex;"><span>$ tar -zxvf /usr/local/srckafka_2.13-2.8.1.tgz -C /opt/
</span></span><span style="display:flex;"><span>$ cd /opt/
</span></span><span style="display:flex;"><span>$ mv kafka_2.13-2.8.1/ kafka</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>zookeeper</code><!-- raw HTML omitted -->和<!-- raw HTML omitted --><code>Kafka</code><!-- raw HTML omitted -->配置文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -p /opt/kafka/<span style="color:#f92672">{</span>zookeeper,logs<span style="color:#f92672">}</span>  	<span style="color:#75715e"># 创建持久化目录</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;/^dataDir=/cdataDir=\/opt\/kafka\/zookeeper&#39;</span> /opt/kafka/config/zookeeper.properties
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;/^broker.id=/cbroker.id=1&#39;</span> /opt/kafka/config/server.properties  	<span style="color:#75715e"># 集群设置不同id</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;/^log.dirs=/clog.dirs=/opt/kafka/logs/logs-1&#39;</span> /opt/kafka/config/server.properties
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;/^zookeeper.connect=/czookeeper.connect=${IP-1}:2128,${IP-2}:2128,${IP-3}:2128&#39;</span> /opt/kafka/config/server.properties</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->多<!-- raw HTML omitted --><code>zookeeper</code><!-- raw HTML omitted -->和多<!-- raw HTML omitted --><code>Kafka</code><!-- raw HTML omitted -->实例启动<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /opt/kafka/bin/zookeeper-server-start.sh -daemon /opt/kafka/config/zookeeper.properties  	<span style="color:#75715e"># 后台启动zookeeper进程</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ /opt/kafka/bin/kafka-server-start.sh -daemon /opt/kafka/config/server.properties</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="创建topic测试">创建<code>Topic</code>测试</h3>
<blockquote>
<ul>
<li><code>--create</code><!-- raw HTML omitted -->：创建<!-- raw HTML omitted --></li>
<li><code>--zookeeper</code><!-- raw HTML omitted -->： 使用<!-- raw HTML omitted --><code>zookeeper</code></li>
<li><code>--replication-factor 1</code><!-- raw HTML omitted -->： 使用<code>1</code>个副本<!-- raw HTML omitted --></li>
<li><code>--partitions 1</code><!-- raw HTML omitted -->：启用分区数量<!-- raw HTML omitted --></li>
<li><code>--topic test</code><!-- raw HTML omitted -->： 主题名字：<!-- raw HTML omitted --><code>test</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /opt/kafka/bin/kafka-console-producer.sh --broker-list localhost:9092 --topic test  	<span style="color:#75715e"># 使用kafka-console-producer.sh 产生消息，发送消息</span>
</span></span><span style="display:flex;"><span>$ /opt/kafka/bin/kafka-console-consumer.sh --topic test --from-beginning --bootstrap-server localhost:9092  	<span style="color:#75715e"># 使用kafka-console-consumer.sh消费消息</span></span></span></code></pre></div><ul>
<li><code>--from-beginning</code><!-- raw HTML omitted -->： 接受历史消息参数<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /opt/kafka/bin/kafka-topics.sh --describe --topic test --bootstrap-server localhost:9092  	<span style="color:#75715e"># 查看topics描述信息</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->第一行给出了所有分区的摘要，每个附加行给出了关于一个分区的信息。 由于我们只有一个分区，所以只有一行<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>Leader</code><!-- raw HTML omitted -->：是负责给定分区的所有读取和写入的节点。 每个节点将成为分区随机选择部分的领导者<!-- raw HTML omitted --></li>
<li><code>Replicas</code><!-- raw HTML omitted -->：是复制此分区日志的节点列表，无论它们是否是领导者，或者即使他们当前处于活动状态<!-- raw HTML omitted --></li>
<li><code>Isr</code><!-- raw HTML omitted -->：是一组“同步”副本。这是复制品列表的子集，当前活着并被引导到领导者<!-- raw HTML omitted --></li>
</ul>
<p><a href="#R-image-71b2999a823898c925206e4299b68ca6" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kafka_Server/topics.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-71b2999a823898c925206e4299b68ca6"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Kafka_Server/topics.png"></a></p>
</blockquote>
</blockquote>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="configure_rabbitmq">Configure_Rabbitmq</h1>

<h2 id="使用rabbitmq">使用<code>Rabbitmq</code></h2>
<h3 id="rabbitmq添加登录账户"><code>Rabbitmq</code>添加登录账户</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->在<!-- raw HTML omitted --><code>/etc/rabbitmq/rabbitmq.config</code><!-- raw HTML omitted -->配置文件下添加，<!-- raw HTML omitted -->如果不存在就自行创建<!-- raw HTML omitted -->添加<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>admin</code><!-- raw HTML omitted -->就是用户名称<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat /etc/rabbitmq/rabbitmq.config
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">{</span>rabbit,<span style="color:#f92672">[{</span>tcp_listeners,<span style="color:#f92672">[</span>5672<span style="color:#f92672">]}</span>,<span style="color:#f92672">{</span>loopback_users,<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;admin&#34;</span><span style="color:#f92672">]}]}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">]</span></span></span></code></pre></div></blockquote>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->使用命令添加用户并授权 添加用户<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rabbitmqctl add_user admin admin</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->设置<!-- raw HTML omitted --><code>permissions</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rabbitmqctl set_permissions -p <span style="color:#e6db74">&#34;/&#34;</span> admin <span style="color:#e6db74">&#34;.*&#34;</span> <span style="color:#e6db74">&#34;.*&#34;</span> <span style="color:#e6db74">&#34;.*&#34;</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->设置用户角色<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rabbitmqctl set_user_tags admin administrator</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->查看新添加的<!-- raw HTML omitted --><code>admin</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rabbitmqctl list_users</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->查看用于的权限<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ./rabbitmqctl list_permissions -p /</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="rabbitmq问题"><code>RabbitMQ</code>问题</h3>
<h4 id="rabbitmq无法新建连接问题处理过程记录"><code>RabbitMQ</code>无法新建连接问题处理过程记录</h4>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->症状描述<!-- raw HTML omitted -->客户反馈无法云平台<code>VNC</code>控制台窗口一直处于<code>loading</code>状态，无法打开.</li>
<li>定位过程</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->首先查看<!-- raw HTML omitted --><code>nova-api</code><!-- raw HTML omitted -->服务是否正常<!-- raw HTML omitted --><code>nova list</code><!-- raw HTML omitted -->正常<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->查看<!-- raw HTML omitted --><code>nova service-list</code><!-- raw HTML omitted -->输出，所有服务在线<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>nova get-vnc-console</code><!-- raw HTML omitted -->获取云主机<!-- raw HTML omitted --><code>vnc</code><!-- raw HTML omitted -->链接，超时无法获取<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li>初步找到控制台窗口无法打开的原因，继续分析问题</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->查看云主机所在节点的<!-- raw HTML omitted --><code>nova-compute</code><!-- raw HTML omitted -->服务，一切正常<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->查看<!-- raw HTML omitted --><code>nova-compute</code><!-- raw HTML omitted -->日志，没有收到创建<!-- raw HTML omitted --><code>vnc</code><!-- raw HTML omitted -->链接请求<!-- raw HTML omitted --><code>vnc</code><!-- raw HTML omitted -->控制台链接是在云主机所在计算节点生成的，因为要查询云主机<!-- raw HTML omitted --><code>qemu</code><!-- raw HTML omitted -->进程创建的<!-- raw HTML omitted --><code>vnc server</code><!-- raw HTML omitted -->端口号，创建完成后要把<!-- raw HTML omitted --><code>token</code><!-- raw HTML omitted -->和端口号对应关系保存到<!-- raw HTML omitted --><code>nova-consoleauth</code><!-- raw HTML omitted -->进程，<!-- raw HTML omitted --><code>nova-consoleauth</code><!-- raw HTML omitted -->进程会根据配置项决定把对应关系保存到进程内存还是<!-- raw HTML omitted --><code>memcache</code><!-- raw HTML omitted -->服务，之前处理过一次控制节点内存不足导致<!-- raw HTML omitted --><code>token</code><!-- raw HTML omitted -->保存失败的问题，这次也先查了下<!-- raw HTML omitted --><code>nova-consoleauth</code><!-- raw HTML omitted -->日志，没有发现类似情况<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->查看<!-- raw HTML omitted --><code>nova-api</code><!-- raw HTML omitted -->节点日志，发现收到了请求但没有返回<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->打开<!-- raw HTML omitted --><code>nova-api</code><!-- raw HTML omitted -->和<!-- raw HTML omitted --><code>nova-compute</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>debug</code><!-- raw HTML omitted -->日志继续分析<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->发现<!-- raw HTML omitted --><code>nova-api</code><!-- raw HTML omitted -->一直在尝试连接到<!-- raw HTML omitted --><code>RabbitMQ</code><!-- raw HTML omitted -->，一直卡在<!-- raw HTML omitted --><code>connecting</code><!-- raw HTML omitted -->，没有<!-- raw HTML omitted --><code>connected</code><!-- raw HTML omitted -->日志<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li>找到更进一步的问题原因，继续分析问题</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->首先重启<!-- raw HTML omitted --><code>nova-api</code><!-- raw HTML omitted -->服务，试验下能否恢复，发现启动进程时可以连接到<!-- raw HTML omitted --><code>MQ</code>，<!-- raw HTML omitted -->但获取<!-- raw HTML omitted --><code>vnc</code><!-- raw HTML omitted -->链接时问题仍然存在<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->通过<!-- raw HTML omitted --><code>rabbitmqctl</code><!-- raw HTML omitted -->命令行查看<!-- raw HTML omitted --><code>queue</code><!-- raw HTML omitted -->和<!-- raw HTML omitted --><code>exchange</code><!-- raw HTML omitted -->情况，也没发现异常，云主机节点的<!-- raw HTML omitted --><code>compute</code><!-- raw HTML omitted -->队列也有<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->重启<!-- raw HTML omitted --><code>MQ</code><!-- raw HTML omitted -->服务，试验能否恢复，重启后发现<!-- raw HTML omitted --><code>vnc</code><!-- raw HTML omitted -->链接获取命令恢复正常，页面打开控制台窗口正常<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li>问题解决但没找到原因，于是继续观察，等了大概2分钟，再次尝试打开<code>vnc</code>控制台窗口，发现老问题还在，一直<code>loading</code>，继续分析问题，</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->查看<!-- raw HTML omitted --><code>MQ</code><!-- raw HTML omitted -->服务器日志，发现异常<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->发现问题根本原因，文件句柄数量超出限制，<!-- raw HTML omitted --><code>google</code><!-- raw HTML omitted -->搜索这个错误，发现了解决方法<!-- raw HTML omitted --><a href="https://my.oschina.net/moooofly/blog/678513" rel="external" target="_self">原创<code>RabbitMQ</code>之<code>file descriptor limit alarm</code>分析</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0"><code>=WARNING REPORT==== 25-Oct-2017::10:35:48 ===
file descriptor limit alarm set.

********************************************************************
*** New connections will not be accepted until this alarm clears ***
********************************************************************</code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->首先修改<!-- raw HTML omitted --><code>MQ</code><!-- raw HTML omitted -->节点物理机文件句柄数量配置（增加如下两行）<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat /etc/security/limits.conf  | grep nofile
</span></span><span style="display:flex;"><span>* soft nofile <span style="color:#ae81ff">262144</span>
</span></span><span style="display:flex;"><span>* hard nofile <span style="color:#ae81ff">262144</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ulimit -n <span style="color:#ae81ff">65536</span>  	<span style="color:#75715e"># 也修改</span></span></span></code></pre></div></blockquote>
<ul>
<li>重启<code>RabbitMQ</code>，<code>rabbitmqctl status</code>命令查看限制，发现不生效：</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->按照搜索结果中的提示执行：<!-- raw HTML omitted --><code>rabbitmqctl stop、rabbitmq-server -detached</code><!-- raw HTML omitted -->再次查看，发现句柄数限制已修改<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->尝试<!-- raw HTML omitted --><code>web</code><!-- raw HTML omitted -->打开<!-- raw HTML omitted --><code>vnc</code><!-- raw HTML omitted -->窗口，发现恢复正常，<!-- raw HTML omitted --><code>nova-api</code><!-- raw HTML omitted -->和<!-- raw HTML omitted --><code>nova-compute</code><!-- raw HTML omitted -->日志正常<!-- raw HTML omitted --><code>connected</code><!-- raw HTML omitted -->到<!-- raw HTML omitted --><code>MQ</code><!-- raw HTML omitted -->等待几分钟仍然正常，问题解决<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0"><code> {file_descriptors,
     [{total_limit,924},
      {total_used,525},</code></pre></div></blockquote>
<ul>
<li>尝试修改安装部署脚本，发现先修改系统句柄数配置再安装<code>MQ</code>，仍然无法修改<code>MQ</code>句柄限制
继续<code>google</code>，<a href="https://www.rabbitmq.com/install-rpm.html" rel="external" target="_self">查看到<code>RabbitMQ</code>官方文档</a> 有如下描述：</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0"><code>控制 Linux 上的系统限制

运行生产工作负载的 RabbitMQ 安装可能需要系统限制和内核参数调整，以便处理相当数量的并发连接和队列。需要调整的主要设置是最大打开文件数，也称为ulimit -n。许多操作系统上的默认值对于消息传递代理来说太低了（例如，在几个 Linux 发行版上为 1024）。我们建议在生产环境中为用户 rabbitmq 允许至少 65536 个文件描述符。对于大多数开发工作负载，4096 应该足够了。

有两个限制：操作系统内核允许打开文件的最大数量（fs.file-max）和每个用户的限制（ulimit -n）。前者必须高于后者。

使用 systemd（最近的 Linux 发行版）

在使用 systemd 的发行版上，操作系统限制是通过 /etc/systemd/system/rabbitmq-server.service.d/limits.conf 中的配置文件控制的，例如：

[Service]
LimitNOFILE=300000</code></pre></div></blockquote>
<ul>
<li>据此修改正常</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir /etc/systemd/system/rabbitmq-server.service.d -p
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat  &gt;/etc/systemd/system/rabbitmq-server.service.d/limits.conf<span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LimitNOFILE=300000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ setenforce <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;s#enforcing#disabled#g&#34;</span>  /etc/selinux/config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;/etc/security/limits.conf<span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* soft nofile 204800
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* hard nofile 204800
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ulimit -n <span style="color:#ae81ff">204800</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ systemctl daemon-reload
</span></span><span style="display:flex;"><span>$ systemctl restart rabbitmq-server.service</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="zabbix监控-rabbitmq"><code>Zabbix</code>监控<code> Rabbitmq</code></h3>
<blockquote>
<ul>
<li><a href="http://www.lstop.pub/2016/10/10/%E8%87%AA%E5%B7%B1%E5%86%99%E4%B8%80%E4%B8%AA%E7%9B%91%E6%8E%A7RabbitMQ%E7%9A%84%E8%84%9A%E6%9C%AC/" rel="external" target="_self"><code>Rabbitmq-python</code>监控脚本</a></li>
<li><code>RabbitMQ</code>自己已经有一个挺好的管理监控界面，可以看到非常详细的消息队列信息，但是对于运维人员来说，还缺少了很重要的告警功能。 自己写一个脚本也是很有必要的，在网上也有很多参考，主要思路是利用<code>RabbitMQ</code>自带管理模块的<code>RESTful API</code>取值，发送到<code>zabbix</code>，由<code>zabbix</code>负责告警阀值判断和发送告警</li>
<li><!-- raw HTML omitted --><code>RabbitMQ RESTful API</code><!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>首先认识<code>RabbitMQ</code>的<code>API</code>，看看能取到什么，推荐看官方<code>help</code></li>
<li><!-- raw HTML omitted -->查看<!-- raw HTML omitted --><code>MQ</code><!-- raw HTML omitted -->总体情况<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>官方解析：<code>/api/overview Various random bits of information that describe the whole system</code></li>
<li>例子：<code>curl -u guest:guest http://192.168.55.241:15672/api/overview</code> 然后返回d的<code>json</code>格式响应是：</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;management_version&#34;</span>: <span style="color:#e6db74">&#34;3.0.0&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;statistics_level&#34;</span>: <span style="color:#e6db74">&#34;fine&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;exchange_types&#34;</span>: [
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;topic&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;description&#34;</span>: <span style="color:#e6db74">&#34;AMQP topic exchange, as per the AMQP specification&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;enabled&#34;</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;fanout&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;description&#34;</span>: <span style="color:#e6db74">&#34;AMQP fanout exchange, as per the AMQP specification&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;enabled&#34;</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;direct&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;description&#34;</span>: <span style="color:#e6db74">&#34;AMQP direct exchange, as per the AMQP specification&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;enabled&#34;</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;headers&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;description&#34;</span>: <span style="color:#e6db74">&#34;AMQP headers exchange, as per the AMQP specification&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;enabled&#34;</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;rabbitmq_version&#34;</span>: <span style="color:#e6db74">&#34;3.0.0&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;erlang_version&#34;</span>: <span style="color:#e6db74">&#34;R15B01&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;message_stats&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;publish&#34;</span>: <span style="color:#ae81ff">1104833</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;publish_details&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;rate&#34;</span>: <span style="color:#ae81ff">12.262779782167032</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;interval&#34;</span>: <span style="color:#ae81ff">298146914019</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;last_event&#34;</span>: <span style="color:#ae81ff">1476068131606</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;ack&#34;</span>: <span style="color:#ae81ff">1177571</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;ack_details&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;rate&#34;</span>: <span style="color:#ae81ff">11.230039450092189</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;interval&#34;</span>: <span style="color:#ae81ff">57927468985</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;last_event&#34;</span>: <span style="color:#ae81ff">1476068130882</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;deliver&#34;</span>: <span style="color:#ae81ff">1177572</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;deliver_details&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;rate&#34;</span>: <span style="color:#ae81ff">11.027518607238914</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;interval&#34;</span>: <span style="color:#ae81ff">57927468985</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;last_event&#34;</span>: <span style="color:#ae81ff">1476068130882</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;deliver_get&#34;</span>: <span style="color:#ae81ff">1207878</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;deliver_get_details&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;rate&#34;</span>: <span style="color:#ae81ff">11.027518607238914</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;interval&#34;</span>: <span style="color:#ae81ff">57927468985</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;last_event&#34;</span>: <span style="color:#ae81ff">1476068130882</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;deliver_no_ack&#34;</span>: <span style="color:#ae81ff">30306</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;deliver_no_ack_details&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;rate&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;interval&#34;</span>: <span style="color:#ae81ff">1067361970</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;last_event&#34;</span>: <span style="color:#ae81ff">1476068115093</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;redeliver&#34;</span>: <span style="color:#ae81ff">8</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;redeliver_details&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;rate&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;interval&#34;</span>: <span style="color:#ae81ff">115179973</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;last_event&#34;</span>: <span style="color:#ae81ff">1476068099504</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;queue_totals&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;messages&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;messages_ready&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;messages_unacknowledged&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;messages_details&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;rate&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;interval&#34;</span>: <span style="color:#ae81ff">255911999</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;last_event&#34;</span>: <span style="color:#ae81ff">1476068131232</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;messages_ready_details&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;rate&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;interval&#34;</span>: <span style="color:#ae81ff">255911999</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;last_event&#34;</span>: <span style="color:#ae81ff">1476068131232</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;messages_unacknowledged_details&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;rate&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;interval&#34;</span>: <span style="color:#ae81ff">255911999</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;last_event&#34;</span>: <span style="color:#ae81ff">1476068131232</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;object_totals&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;consumers&#34;</span>: <span style="color:#ae81ff">70</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;queues&#34;</span>: <span style="color:#ae81ff">27</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;exchanges&#34;</span>: <span style="color:#ae81ff">13</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;connections&#34;</span>: <span style="color:#ae81ff">176</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;channels&#34;</span>: <span style="color:#ae81ff">236</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;node&#34;</span>: <span style="color:#e6db74">&#34;rabbit@rabbit01&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;statistics_db_node&#34;</span>: <span style="color:#e6db74">&#34;rabbit@rabbit01&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;listeners&#34;</span>: [
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;node&#34;</span>: <span style="color:#e6db74">&#34;rabbit@rabbit01&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;protocol&#34;</span>: <span style="color:#e6db74">&#34;amqp&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;ip_address&#34;</span>: <span style="color:#e6db74">&#34;::&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;port&#34;</span>: <span style="color:#ae81ff">5672</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;contexts&#34;</span>: [
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;node&#34;</span>: <span style="color:#e6db74">&#34;rabbit@rabbit01&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;description&#34;</span>: <span style="color:#e6db74">&#34;RabbitMQ Management&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;path&#34;</span>: <span style="color:#e6db74">&#34;/&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;port&#34;</span>: <span style="color:#ae81ff">15672</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;node&#34;</span>: <span style="color:#e6db74">&#34;rabbit@rabbit01&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;description&#34;</span>: <span style="color:#e6db74">&#34;Redirect to port 15672&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;path&#34;</span>: <span style="color:#e6db74">&#34;/&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;port&#34;</span>: <span style="color:#ae81ff">55672</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;ignore_in_use&#34;</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></blockquote>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->查看单个队列<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>官方解析：<code>/api/queues/vhost/name An individual queue. To PUT a queue, you will need a body looking something like this: {“auto_delete”:false,”durable”:true,”arguments”:[],”node”:”rabbit@smacmullen”} All keys are optional</code></li>
<li>例子：<code>%2F代表vhost为/ curl -u guest:guest http://192.168.55.241:15672/api/queues/%2F/wxq.msgweb.push.wgw.0</code> 然后返回d的<code>json</code>格式响应是：</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;policy&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;exclusive_consumer_tag&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;messages_ready&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;messages_unacknowledged&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;messages&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;consumers&#34;</span>: <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;active_consumers&#34;</span>: <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;memory&#34;</span>: <span style="color:#ae81ff">55680</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;backing_queue_status&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;q1&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;q2&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;delta&#34;</span>: [
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;delta&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;undefined&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;undefined&#34;</span>
</span></span><span style="display:flex;"><span>        ],
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;q3&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;q4&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;len&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;pending_acks&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;target_ram_count&#34;</span>: <span style="color:#e6db74">&#34;infinity&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;ram_msg_count&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;ram_ack_count&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;next_seq_id&#34;</span>: <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;persistent_count&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;avg_ingress_rate&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;avg_egress_rate&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;avg_ack_ingress_rate&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;avg_ack_egress_rate&#34;</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;messages_details&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;rate&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;interval&#34;</span>: <span style="color:#ae81ff">10001981</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;last_event&#34;</span>: <span style="color:#ae81ff">1476068574166</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;messages_ready_details&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;rate&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;interval&#34;</span>: <span style="color:#ae81ff">10001981</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;last_event&#34;</span>: <span style="color:#ae81ff">1476068574166</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;messages_unacknowledged_details&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;rate&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;interval&#34;</span>: <span style="color:#ae81ff">10001981</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;last_event&#34;</span>: <span style="color:#ae81ff">1476068574166</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;incoming&#34;</span>: [
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;stats&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;publish&#34;</span>: <span style="color:#ae81ff">763</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;publish_details&#34;</span>: {
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&#34;rate&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&#34;interval&#34;</span>: <span style="color:#ae81ff">75305976</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&#34;last_event&#34;</span>: <span style="color:#ae81ff">1476068545922</span>
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;exchange&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;wxq_appmsg_exchange&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;vhost&#34;</span>: <span style="color:#e6db74">&#34;/&#34;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;deliveries&#34;</span>: [
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;stats&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;deliver_get&#34;</span>: <span style="color:#ae81ff">774</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;deliver_get_details&#34;</span>: {
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&#34;rate&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&#34;interval&#34;</span>: <span style="color:#ae81ff">44411017</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&#34;last_event&#34;</span>: <span style="color:#ae81ff">1476068470753</span>
</span></span><span style="display:flex;"><span>                },
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;deliver_no_ack&#34;</span>: <span style="color:#ae81ff">774</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;deliver_no_ack_details&#34;</span>: {
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&#34;rate&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&#34;interval&#34;</span>: <span style="color:#ae81ff">44411017</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&#34;last_event&#34;</span>: <span style="color:#ae81ff">1476068470753</span>
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;channel_details&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;192.168.65.158:64326 -&gt; 192.168.55.241:5672 (1)&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;number&#34;</span>: <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;connection_name&#34;</span>: <span style="color:#e6db74">&#34;192.168.65.158:64326 -&gt; 192.168.55.241:5672&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;peer_port&#34;</span>: <span style="color:#ae81ff">64326</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;peer_host&#34;</span>: <span style="color:#e6db74">&#34;192.168.65.158&#34;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;message_stats&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;deliver_get&#34;</span>: <span style="color:#ae81ff">774</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;deliver_get_details&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;rate&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;interval&#34;</span>: <span style="color:#ae81ff">44411017</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;last_event&#34;</span>: <span style="color:#ae81ff">1476068470753</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;deliver_no_ack&#34;</span>: <span style="color:#ae81ff">774</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;deliver_no_ack_details&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;rate&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;interval&#34;</span>: <span style="color:#ae81ff">44411017</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;last_event&#34;</span>: <span style="color:#ae81ff">1476068470753</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;publish&#34;</span>: <span style="color:#ae81ff">763</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;publish_details&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;rate&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;interval&#34;</span>: <span style="color:#ae81ff">75305976</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;last_event&#34;</span>: <span style="color:#ae81ff">1476068545922</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;consumer_details&#34;</span>: [
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;channel_details&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;192.168.65.158:64326 -&gt; 192.168.55.241:5672 (1)&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;number&#34;</span>: <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;connection_name&#34;</span>: <span style="color:#e6db74">&#34;192.168.65.158:64326 -&gt; 192.168.55.241:5672&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;peer_port&#34;</span>: <span style="color:#ae81ff">64326</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;peer_host&#34;</span>: <span style="color:#e6db74">&#34;192.168.65.158&#34;</span>
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;queue_details&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;wxq.msgweb.push.wgw.0&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;vhost&#34;</span>: <span style="color:#e6db74">&#34;/&#34;</span>
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;consumer_tag&#34;</span>: <span style="color:#e6db74">&#34;amq.ctag-jKVWrQSs7dbX9VaFfOZiYA&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;exclusive&#34;</span>: <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;ack_required&#34;</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;wxq.msgweb.push.wgw.0&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;vhost&#34;</span>: <span style="color:#e6db74">&#34;/&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;durable&#34;</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;auto_delete&#34;</span>: <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;arguments&#34;</span>: {},
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;node&#34;</span>: <span style="color:#e6db74">&#34;rabbit@rabbit01&#34;</span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h4 id="zabbix-sender"><code>zabbix sender</code></h4>
<blockquote>
<ul>
<li><code>zabbix sender</code>区别于在<code>zabbix agent</code>添加<code>item</code>，<code>sender</code>可以主动发送<code>item</code>值到<code>zabbix server</code>
可以先规划好在<code>zabbix server</code>中使用的<code>host</code>和<code>item</code>名字</li>
<li><!-- raw HTML omitted -->例如：<!-- raw HTML omitted -->这样就可以通过python取值，保存在临时文件中，再<code>send</code>到<code>zabbix server</code></li>
</ul>
<blockquote>
<ul>
<li><code>rabbitmq.[rabbit@wx-pro-server01,messages_ready]</code>待处理消息总数</li>
<li><code>rabbitmq.[rabbit@wx-pro-server01,messages_unacknowledged]</code>未收到<code>ack</code>响应消息总数</li>
<li><code>rabbitmq.queues[/,queue_messages_ready,wxq_msg_send] wxq_msg_send</code>队列的待处理消息数</li>
<li><code>rabbitmq.queues[/,queue_active_consumers,wxq_msg_send] wxq_msg_send</code>队列的活动连接数</li>
</ul>
</blockquote>
<ul>
<li><code>zabbix_sender</code><!-- raw HTML omitted -->使用方法<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>-c</code>：<code>agent</code><!-- raw HTML omitted -->配置文件<!-- raw HTML omitted --></li>
<li><code>-i</code> ：<!-- raw HTML omitted -->临时文件，用于保存多个<!-- raw HTML omitted --><code>item</code><!-- raw HTML omitted -->和对应值，每行一个<!-- raw HTML omitted --><code>item</code></li>
<li><code>-s</code>：<!-- raw HTML omitted -->在<!-- raw HTML omitted --><code>zabbix server</code><!-- raw HTML omitted -->上配置的<!-- raw HTML omitted --><code>host</code><!-- raw HTML omitted -->名字<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>/usr/bin/zabbix_sender -c /etc/zabbix/zabbix_agentd.conf -i /tmp/tmp5ai4uI -s ser01-rabbitmq</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h4 id="python代码"><code>python</code>代码</h4>
<blockquote>
<ul>
<li><a href="https://blog.51cto.com/john88wang/1745824" rel="external" target="_self">使用<code>Zabbix</code>监控<code>RabbitMQ</code></a></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># coding=utf-8</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">RabbitMq监控脚本 v1.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">v1.1 监控channel的unacknowledged
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">v1.0 监控overview、queue
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> urllib2
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> socket
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> tempfile
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> logging
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> subprocess
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> optparse
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span>logging<span style="color:#f92672">.</span>basicConfig(filename<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/var/log/zabbix/rabbitmq_zabbix.log&#39;</span>, level<span style="color:#f92672">=</span>logging<span style="color:#f92672">.</span>WARNNING, format<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%(asctime)s</span><span style="color:#e6db74"> </span><span style="color:#e6db74">%(levelname)s</span><span style="color:#e6db74">: </span><span style="color:#e6db74">%(message)s</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RabbitMqApi</span>(object):
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39; 调用RabbitMQ的API类 &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">######## json.loads()  transfer json data to python data</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">######## json.dump()   transfer python data to json data</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> __init__(self, user_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;guest&#39;</span>, password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;guest&#39;</span>, host_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;192.168.55.241&#39;</span>, 
</span></span><span style="display:flex;"><span>           protocol<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;http&#39;</span>, port<span style="color:#f92672">=</span><span style="color:#ae81ff">15672</span>, senderhostname<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;ser01-rabbitmq&#39;</span>,
</span></span><span style="display:flex;"><span>                       zbconf<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/etc/zabbix/zabbix_agentd.conf&#39;</span>):
</span></span><span style="display:flex;"><span>self<span style="color:#f92672">.</span>user_name <span style="color:#f92672">=</span> user_name
</span></span><span style="display:flex;"><span>self<span style="color:#f92672">.</span>password <span style="color:#f92672">=</span> password
</span></span><span style="display:flex;"><span>self<span style="color:#f92672">.</span>host_name <span style="color:#f92672">=</span> host_name <span style="color:#f92672">or</span> socket<span style="color:#f92672">.</span>gethostname()
</span></span><span style="display:flex;"><span>self<span style="color:#f92672">.</span>protocol <span style="color:#f92672">=</span> protocol
</span></span><span style="display:flex;"><span>self<span style="color:#f92672">.</span>port <span style="color:#f92672">=</span> port
</span></span><span style="display:flex;"><span>self<span style="color:#f92672">.</span>senderhostname <span style="color:#f92672">=</span> senderhostname <span style="color:#66d9ef">if</span> senderhostname <span style="color:#66d9ef">else</span> host_name
</span></span><span style="display:flex;"><span>self<span style="color:#f92672">.</span>conf <span style="color:#f92672">=</span> zbconf
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 调用RabbitMQ的API类取原始数据，json格式</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">call_api</span>(self, path):
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  All URIs will server only resource of type application/json,and will require HTTP basic authentication. The default username and password is guest/guest.  /</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">f is encoded for the default virtual host &#39;/&#39; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{0}</span><span style="color:#e6db74">://</span><span style="color:#e6db74">{1}</span><span style="color:#e6db74">:</span><span style="color:#e6db74">{2}</span><span style="color:#e6db74">/api/</span><span style="color:#e6db74">{3}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(self<span style="color:#f92672">.</span>protocol, self<span style="color:#f92672">.</span>host_name, self<span style="color:#f92672">.</span>port, path)
</span></span><span style="display:flex;"><span>password_mgr <span style="color:#f92672">=</span> urllib2<span style="color:#f92672">.</span>HTTPPasswordMgrWithDefaultRealm()
</span></span><span style="display:flex;"><span>password_mgr<span style="color:#f92672">.</span>add_password(<span style="color:#66d9ef">None</span>, url, self<span style="color:#f92672">.</span>user_name, self<span style="color:#f92672">.</span>password)
</span></span><span style="display:flex;"><span>handler <span style="color:#f92672">=</span> urllib2<span style="color:#f92672">.</span>HTTPBasicAuthHandler(password_mgr)
</span></span><span style="display:flex;"><span>logging<span style="color:#f92672">.</span>debug(<span style="color:#e6db74">&#39;Issue a rabbit API call to get data on &#39;</span> <span style="color:#f92672">+</span> url)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> json<span style="color:#f92672">.</span>loads(urllib2<span style="color:#f92672">.</span>build_opener(handler)<span style="color:#f92672">.</span>open(url)<span style="color:#f92672">.</span>read())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 调用RabbitMQ的API类取原始数据，json格式</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">call_api_queue</span>(self, queue_name):
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  get queue detail
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{0}</span><span style="color:#e6db74">://</span><span style="color:#e6db74">{1}</span><span style="color:#e6db74">:</span><span style="color:#e6db74">{2}</span><span style="color:#e6db74">/api/queues/</span><span style="color:#e6db74">%2F</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{3}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(self<span style="color:#f92672">.</span>protocol, self<span style="color:#f92672">.</span>host_name, self<span style="color:#f92672">.</span>port, queue_name)
</span></span><span style="display:flex;"><span>password_mgr <span style="color:#f92672">=</span> urllib2<span style="color:#f92672">.</span>HTTPPasswordMgrWithDefaultRealm()
</span></span><span style="display:flex;"><span>password_mgr<span style="color:#f92672">.</span>add_password(<span style="color:#66d9ef">None</span>, url, self<span style="color:#f92672">.</span>user_name, self<span style="color:#f92672">.</span>password)
</span></span><span style="display:flex;"><span>handler <span style="color:#f92672">=</span> urllib2<span style="color:#f92672">.</span>HTTPBasicAuthHandler(password_mgr)
</span></span><span style="display:flex;"><span>logging<span style="color:#f92672">.</span>debug(<span style="color:#e6db74">&#39;Issue a rabbit API call to get data on &#39;</span> <span style="color:#f92672">+</span> url)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> json<span style="color:#f92672">.</span>loads(urllib2<span style="color:#f92672">.</span>build_opener(handler)<span style="color:#f92672">.</span>open(url)<span style="color:#f92672">.</span>read())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">call_api_channel</span>(self, channel_name):
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  get channel detail
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{0}</span><span style="color:#e6db74">://</span><span style="color:#e6db74">{1}</span><span style="color:#e6db74">:</span><span style="color:#e6db74">{2}</span><span style="color:#e6db74">/api/channels/</span><span style="color:#e6db74">{3}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(self<span style="color:#f92672">.</span>protocol, self<span style="color:#f92672">.</span>host_name, self<span style="color:#f92672">.</span>port, urllib2<span style="color:#f92672">.</span>quote(channel_name))
</span></span><span style="display:flex;"><span>password_mgr <span style="color:#f92672">=</span> urllib2<span style="color:#f92672">.</span>HTTPPasswordMgrWithDefaultRealm()
</span></span><span style="display:flex;"><span>password_mgr<span style="color:#f92672">.</span>add_password(<span style="color:#66d9ef">None</span>, url, self<span style="color:#f92672">.</span>user_name, self<span style="color:#f92672">.</span>password)
</span></span><span style="display:flex;"><span>handler <span style="color:#f92672">=</span> urllib2<span style="color:#f92672">.</span>HTTPBasicAuthHandler(password_mgr)
</span></span><span style="display:flex;"><span>logging<span style="color:#f92672">.</span>debug(<span style="color:#e6db74">&#39;Issue a rabbit API call to get data on &#39;</span> <span style="color:#f92672">+</span> url)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> json<span style="color:#f92672">.</span>loads(urllib2<span style="color:#f92672">.</span>build_opener(handler)<span style="color:#f92672">.</span>open(url)<span style="color:#f92672">.</span>read())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 把数据与item对应写进临时文件</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_get_queue_data</span>(self, queue, tmpfile):
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> [ <span style="color:#e6db74">&#39;memory&#39;</span>,<span style="color:#e6db74">&#39;messages&#39;</span>,<span style="color:#e6db74">&#39;messages_ready&#39;</span>,<span style="color:#e6db74">&#39;messages_unacknowledged&#39;</span>,<span style="color:#e6db74">&#39;consumers&#39;</span>,<span style="color:#e6db74">&#39;active_consumers&#39;</span> ]:
</span></span><span style="display:flex;"><span><span style="color:#75715e">#key = rabbitmq.queues[/,queue_memory,queue.helloWorld]</span>
</span></span><span style="display:flex;"><span>key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#34;rabbitmq.queues[</span><span style="color:#e6db74">{0}</span><span style="color:#e6db74">,queue_</span><span style="color:#e6db74">{1}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">{2}</span><span style="color:#e6db74">]&#34;&#39;</span><span style="color:#f92672">.</span>format(queue[<span style="color:#e6db74">&#39;vhost&#39;</span>], item, queue[<span style="color:#e6db74">&#39;name&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#75715e">### if item is in queue,value=queue[item],else value=0</span>
</span></span><span style="display:flex;"><span>value <span style="color:#f92672">=</span> queue<span style="color:#f92672">.</span>get(item, <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>logging<span style="color:#f92672">.</span>debug(<span style="color:#e6db74">&#34;SENDER_DATA: - </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (key,value))
</span></span><span style="display:flex;"><span>tmpfile<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#34;- </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> </span><span style="color:#e6db74">%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (key, value))
</span></span><span style="display:flex;"><span><span style="color:#75715e">##  This is a non standard bit of information added after the standard items</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#39;deliver_get&#39;</span>, <span style="color:#e6db74">&#39;publish&#39;</span>]:
</span></span><span style="display:flex;"><span>key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#34;rabbitmq.queues[</span><span style="color:#e6db74">{0}</span><span style="color:#e6db74">,queue_message_stats_</span><span style="color:#e6db74">{1}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">{2}</span><span style="color:#e6db74">]&#34;&#39;</span><span style="color:#f92672">.</span>format(queue[<span style="color:#e6db74">&#39;vhost&#39;</span>], item, queue[<span style="color:#e6db74">&#39;name&#39;</span>])
</span></span><span style="display:flex;"><span>value <span style="color:#f92672">=</span> queue<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;message_stats&#39;</span>, {})<span style="color:#f92672">.</span>get(item, <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>logging<span style="color:#f92672">.</span>debug(<span style="color:#e6db74">&#34;SENDER_DATA: - </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (key,value))
</span></span><span style="display:flex;"><span>tmpfile<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#34;- </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> </span><span style="color:#e6db74">%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (key, value))
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用zabbix_sender把item发送到zabbix server</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_send_queue_data</span>(self, tmpfile):
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;Send the queue data to Zabbix.&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;Get key value from temp file. &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>args <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/usr/bin/zabbix_sender -c </span><span style="color:#e6db74">{0}</span><span style="color:#e6db74"> -i </span><span style="color:#e6db74">{1}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>senderhostname:
</span></span><span style="display:flex;"><span>args <span style="color:#f92672">=</span> args <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; -s &#34;</span> <span style="color:#f92672">+</span> self<span style="color:#f92672">.</span>senderhostname
</span></span><span style="display:flex;"><span>return_code <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>process <span style="color:#f92672">=</span> subprocess<span style="color:#f92672">.</span>Popen(args<span style="color:#f92672">.</span>format(self<span style="color:#f92672">.</span>conf, tmpfile<span style="color:#f92672">.</span>name),
</span></span><span style="display:flex;"><span>                                  shell<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, stdout<span style="color:#f92672">=</span>subprocess<span style="color:#f92672">.</span>PIPE,
</span></span><span style="display:flex;"><span>                                  stderr<span style="color:#f92672">=</span>subprocess<span style="color:#f92672">.</span>PIPE)
</span></span><span style="display:flex;"><span>out, err <span style="color:#f92672">=</span> process<span style="color:#f92672">.</span>communicate()
</span></span><span style="display:flex;"><span>logging<span style="color:#f92672">.</span>debug(<span style="color:#e6db74">&#34;Finished sending data&#34;</span>)
</span></span><span style="display:flex;"><span>return_code <span style="color:#f92672">=</span> process<span style="color:#f92672">.</span>wait()
</span></span><span style="display:flex;"><span>logging<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;Found return code of &#34;</span> <span style="color:#f92672">+</span> str(return_code))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> return_code <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>logging<span style="color:#f92672">.</span>warning(out)
</span></span><span style="display:flex;"><span>logging<span style="color:#f92672">.</span>warning(err)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>logging<span style="color:#f92672">.</span>debug(err)
</span></span><span style="display:flex;"><span>logging<span style="color:#f92672">.</span>debug(out)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> return_code
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_queue</span>(self, queueName):
</span></span><span style="display:flex;"><span>rdatafile <span style="color:#f92672">=</span> tempfile<span style="color:#f92672">.</span>NamedTemporaryFile(delete<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>return_code <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>queue <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>call_api_queue(queueName)
</span></span><span style="display:flex;"><span>self<span style="color:#f92672">.</span>_get_queue_data(queue, rdatafile)
</span></span><span style="display:flex;"><span>self<span style="color:#f92672">.</span>_get_channel_data(queue, rdatafile)
</span></span><span style="display:flex;"><span>rdatafile<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>return_code <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_send_queue_data(rdatafile)
</span></span><span style="display:flex;"><span>os<span style="color:#f92672">.</span>unlink(rdatafile<span style="color:#f92672">.</span>name)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> return_code
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_overview</span>(self):
</span></span><span style="display:flex;"><span>return_code <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>rdatafile <span style="color:#f92672">=</span> tempfile<span style="color:#f92672">.</span>NamedTemporaryFile(delete<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>queue <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>call_api(<span style="color:#e6db74">&#39;overview&#39;</span>)
</span></span><span style="display:flex;"><span>self<span style="color:#f92672">.</span>_get_overview_data(queue, rdatafile)
</span></span><span style="display:flex;"><span>rdatafile<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>return_code <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_send_queue_data(rdatafile)
</span></span><span style="display:flex;"><span>os<span style="color:#f92672">.</span>unlink(rdatafile<span style="color:#f92672">.</span>name)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> return_code
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_get_overview_data</span>(self, queue, tmpfile):
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#39;publish_details&#39;</span>, <span style="color:#e6db74">&#39;ack_details&#39;</span>, <span style="color:#e6db74">&#39;deliver_get_details&#39;</span>]:
</span></span><span style="display:flex;"><span>key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;rabbitmq.[</span><span style="color:#e6db74">{0}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">{1}</span><span style="color:#e6db74">_rate]&#34;</span><span style="color:#f92672">.</span>format(queue[<span style="color:#e6db74">&#39;node&#39;</span>], item)
</span></span><span style="display:flex;"><span>value <span style="color:#f92672">=</span> queue<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;message_stats&#39;</span>)<span style="color:#f92672">.</span>get(item)<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;rate&#39;</span>, <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>logging<span style="color:#f92672">.</span>debug(<span style="color:#e6db74">&#34;SENDER_DATA: - </span><span style="color:#e6db74">{0}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">{1:.2f}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(key, value))
</span></span><span style="display:flex;"><span>tmpfile<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#34;- </span><span style="color:#e6db74">{0}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">{1:.2f}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(key, value))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#39;messages&#39;</span>,<span style="color:#e6db74">&#39;messages_ready&#39;</span>,<span style="color:#e6db74">&#39;messages_unacknowledged&#39;</span>]:
</span></span><span style="display:flex;"><span>key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;rabbitmq.[</span><span style="color:#e6db74">{0}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">{1}</span><span style="color:#e6db74">]&#34;</span><span style="color:#f92672">.</span>format(queue[<span style="color:#e6db74">&#39;node&#39;</span>], item)
</span></span><span style="display:flex;"><span>value <span style="color:#f92672">=</span> queue<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;queue_totals&#39;</span>)<span style="color:#f92672">.</span>get(item,<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>logging<span style="color:#f92672">.</span>debug(<span style="color:#e6db74">&#34;SENDER_DATA: - </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (key,value))
</span></span><span style="display:flex;"><span>tmpfile<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#34;- </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> </span><span style="color:#e6db74">%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (key, value))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_get_channel_data</span>(self, queue, tmpfile): 
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">从queue获取queue name和channel name，组装zabbix的k-v并写进临时文件
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> ch_detail <span style="color:#f92672">in</span> queue[<span style="color:#e6db74">&#39;consumer_details&#39;</span>]:
</span></span><span style="display:flex;"><span>key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;rabbitmq.[</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">,</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">]&#34;</span><span style="color:#f92672">.</span>format(queue[<span style="color:#e6db74">&#39;name&#39;</span>], ch_detail<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;channel_details&#39;</span>)<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;name&#39;</span>,<span style="color:#e6db74">&#39;no_name&#39;</span>))
</span></span><span style="display:flex;"><span>value <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_get_channel_ack(ch_detail<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;channel_details&#39;</span>)<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;name&#39;</span>,<span style="color:#e6db74">&#39;no_name&#39;</span>))
</span></span><span style="display:flex;"><span>logging<span style="color:#f92672">.</span>debug(<span style="color:#e6db74">&#34;SENDER_DATA: - </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (key,value))
</span></span><span style="display:flex;"><span>tmpfile<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#34;- </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> </span><span style="color:#e6db74">%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (key, value))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_get_channel_ack</span>(self, channel_name):
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">使用api获取messages_unacknowledged值
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>d <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>call_api_channel(channel_name)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> d[<span style="color:#e6db74">&#39;messages_unacknowledged&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;Command-line parameters and decoding for Zabbix use/consumption.&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#testapi = RabbitMqApi()</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#testapi.check_queue(&#39;wxq_msg_send&#39;)</span>
</span></span><span style="display:flex;"><span>parser <span style="color:#f92672">=</span> optparse<span style="color:#f92672">.</span>OptionParser()
</span></span><span style="display:flex;"><span>parser<span style="color:#f92672">.</span>add_option(<span style="color:#e6db74">&#39;-u&#39;</span>, <span style="color:#e6db74">&#39;--username&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;RabbitMQ API username,default=guest&#39;</span>,default<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;guest&#39;</span>)
</span></span><span style="display:flex;"><span>parser<span style="color:#f92672">.</span>add_option(<span style="color:#e6db74">&#39;-p&#39;</span>, <span style="color:#e6db74">&#39;--password&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;RabbitMQ API password,default=guest&#39;</span>,default<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;guest&#39;</span>)
</span></span><span style="display:flex;"><span>parser<span style="color:#f92672">.</span>add_option(<span style="color:#e6db74">&#39;--mqhost&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;RabbitMQ API hostname,default=hostname&#39;</span>,default<span style="color:#f92672">=</span>socket<span style="color:#f92672">.</span>gethostname())
</span></span><span style="display:flex;"><span>parser<span style="color:#f92672">.</span>add_option(<span style="color:#e6db74">&#39;--protocol&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;RabbitMQ API protocol,default=http&#39;</span>,default<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;http&#39;</span>)
</span></span><span style="display:flex;"><span>parser<span style="color:#f92672">.</span>add_option(<span style="color:#e6db74">&#39;--port&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;RabbitMQ API port,default=15672&#39;</span>,default<span style="color:#f92672">=</span><span style="color:#ae81ff">15672</span>)
</span></span><span style="display:flex;"><span>parser<span style="color:#f92672">.</span>add_option(<span style="color:#e6db74">&#39;--host&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Zabbix Host name which the item belongs to,no default&#39;</span>)
</span></span><span style="display:flex;"><span>parser<span style="color:#f92672">.</span>add_option(<span style="color:#e6db74">&#39;--conf&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Zabbix agent configure file,default=/etc/zabbix/zabbix_agentd.conf&#39;</span>,default<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/etc/zabbix/zabbix_agentd.conf&#39;</span>)
</span></span><span style="display:flex;"><span>parser<span style="color:#f92672">.</span>add_option(<span style="color:#e6db74">&#39;--queue&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;RabbitMQ queue which you want to check,no default&#39;</span>)
</span></span><span style="display:flex;"><span>parser<span style="color:#f92672">.</span>add_option(<span style="color:#e6db74">&#39;-o&#39;</span>,<span style="color:#e6db74">&#39;--overview&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;check RabbitMQ overview&#39;</span>,action<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;store_true&#34;</span>)
</span></span><span style="display:flex;"><span>parser<span style="color:#f92672">.</span>add_option(<span style="color:#e6db74">&#39;-c&#39;</span>,<span style="color:#e6db74">&#39;--count&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;How many times to execute command&#39;</span>, type<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;int&#39;</span>, default<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>parser<span style="color:#f92672">.</span>add_option(<span style="color:#e6db74">&#39;-i&#39;</span>,<span style="color:#e6db74">&#39;--interval&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Command execute interval&#39;</span>, type<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;int&#39;</span>, default<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>(options, args) <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>parse_args()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> options<span style="color:#f92672">.</span>host:
</span></span><span style="display:flex;"><span>parser<span style="color:#f92672">.</span>error(<span style="color:#e6db74">&#34;请输入zabbix里定义的hostname&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">elif</span> (<span style="color:#f92672">not</span> options<span style="color:#f92672">.</span>queue <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> options<span style="color:#f92672">.</span>overview):
</span></span><span style="display:flex;"><span>parser<span style="color:#f92672">.</span>error(<span style="color:#e6db74">&#34;请指定-o或者--queue，选择检查mq总体指标或者某个队列指标&#34;</span>)
</span></span><span style="display:flex;"><span>logging<span style="color:#f92672">.</span>debug(<span style="color:#e6db74">&#34;Started trying to process data&#34;</span>)
</span></span><span style="display:flex;"><span>api <span style="color:#f92672">=</span> RabbitMqApi(user_name<span style="color:#f92672">=</span>options<span style="color:#f92672">.</span>username, password<span style="color:#f92672">=</span>options<span style="color:#f92672">.</span>password, host_name<span style="color:#f92672">=</span>options<span style="color:#f92672">.</span>mqhost, 
</span></span><span style="display:flex;"><span>               protocol<span style="color:#f92672">=</span>options<span style="color:#f92672">.</span>protocol, port<span style="color:#f92672">=</span>options<span style="color:#f92672">.</span>port, senderhostname<span style="color:#f92672">=</span>options<span style="color:#f92672">.</span>host,
</span></span><span style="display:flex;"><span>               zbconf<span style="color:#f92672">=</span>options<span style="color:#f92672">.</span>conf)
</span></span><span style="display:flex;"><span>cnt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> cnt <span style="color:#f92672">&lt;</span> options<span style="color:#f92672">.</span>count:                                               
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> options<span style="color:#f92672">.</span>overview:
</span></span><span style="display:flex;"><span>api<span style="color:#f92672">.</span>check_overview()
</span></span><span style="display:flex;"><span>time<span style="color:#f92672">.</span>sleep(options<span style="color:#f92672">.</span>interval)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">elif</span> options<span style="color:#f92672">.</span>queue:
</span></span><span style="display:flex;"><span>api<span style="color:#f92672">.</span>check_queue(options<span style="color:#f92672">.</span>queue)
</span></span><span style="display:flex;"><span>time<span style="color:#f92672">.</span>sleep(options<span style="color:#f92672">.</span>interval)
</span></span><span style="display:flex;"><span>cnt <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span> main()</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->脚本使用方式<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>--mqhost</code>：<code>RabbitMQ</code><!-- raw HTML omitted -->服务器<!-- raw HTML omitted --><code>ip</code></li>
<li><code>--host</code>：<code>zabbix server</code><!-- raw HTML omitted -->上配置的<!-- raw HTML omitted --><code>host</code><!-- raw HTML omitted -->名字<!-- raw HTML omitted --></li>
<li><code>--queue</code>：<!-- raw HTML omitted -->队列名字<!-- raw HTML omitted --></li>
<li><code>-o</code>：<!-- raw HTML omitted -->获取<!-- raw HTML omitted --><code>overview</code><!-- raw HTML omitted -->数据<!-- raw HTML omitted --></li>
<li><code>-c</code>：<!-- raw HTML omitted -->执行<code>5</code>次<!-- raw HTML omitted --></li>
<li><code>-i</code>：<!-- raw HTML omitted -->间隔<code>12</code>秒<!-- raw HTML omitted --></li>
<li><code>--help</code>：<!-- raw HTML omitted -->查看帮助，有其他参数可选<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mqMon.py -o –mqhost 192.168.55.241 –host ser01-rabbitmq -c <span style="color:#ae81ff">5</span> -i <span style="color:#ae81ff">12</span>  	<span style="color:#75715e"># 监控`mq`总体情况</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ mqMon.py –queue wxq_msg_send –mqhost 192.168.55.241 –host ser01-rabbitmq -c <span style="color:#ae81ff">5</span> -i <span style="color:#ae81ff">12</span>  	<span style="color:#75715e"># 监控队列情况</span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          </section>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="monitor">Monitor</h1>


            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Monitor</h1>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_zabbix">Install_Zabbix</h1>

<h2 id="部署zabbix监控系统">部署<code>Zabbix</code>监控系统</h2>
<h3 id="基础配置环境要求">基础配置环境要求</h3>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://www.zabbix.com/manuals" rel="external" target="_self"><code>Zabbix</code>部署文档</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.zabbix.com/cn/download" rel="external" target="_self">下载安装<code>Zabbix</code></a></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->部署<!-- raw HTML omitted --><code>Zabbix</code><!-- raw HTML omitted -->硬件要求<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>名称</th>
<th>平台</th>
<th>CPU/内存</th>
<th>数据库</th>
<th>受监控的主机</th>
</tr>
</thead>
<tbody>
<tr>
<td>小型</td>
<td><code>CentOS</code></td>
<td>虚拟设备</td>
<td><code>MySQL InnoDB</code></td>
<td>100</td>
</tr>
<tr>
<td>中型</td>
<td><code>CentOS</code></td>
<td><code>2个CPU内核/2GB</code></td>
<td><code>MySQL InnoDB</code></td>
<td>500</td>
</tr>
<tr>
<td>大型</td>
<td><code>RedHat Enterprise Linux</code></td>
<td><code>4个CPU内核/8GB RAID10</code></td>
<td><code>MySQL InnoDB</code>或 <code>PostgreSQL</code></td>
<td>&gt;1000</td>
</tr>
<tr>
<td>超大型</td>
<td><code>RedHat Enterprise Linux</code></td>
<td><code>8个CPU内核/16GB RAID10</code></td>
<td><code>MySQL InnoDB</code>或 <code>PostgreSQL</code></td>
<td>&gt;10000</td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->部署<!-- raw HTML omitted --><code>Zabbix</code><!-- raw HTML omitted -->数据库版本要求<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>数据库</th>
<th>支持版本</th>
<th>推荐版本</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>MySQL/Percona</code></td>
<td><code>5.7.28-8.0.X</code></td>
<td><code>8.0.X</code></td>
<td>如果<code>MySQL</code>或<code>Percona</code>用作<code>Zabbix</code>后端数据库，则需要。需要<code>InnoDB</code>引擎。我们建议使用<code>MariaDB Connector/C</code>库来构建服务器/代理</td>
</tr>
<tr>
<td><code>MariaDB</code></td>
<td><code>10.0.37-10.6.X</code></td>
<td><code>10.5.X</code></td>
<td><code>InnoDB</code>引擎是必需的。我们建议使用<code>MariaDB Connector/C</code> 库来构建服务器/代理</td>
</tr>
<tr>
<td><code>PostgreSQL</code></td>
<td><code>10.9-13.X</code></td>
<td><code>12.X.X</code>或更新</td>
<td>使用<code>PostgreSQL</code>作为<code>Zabbix</code>后端数据库。<!-- raw HTML omitted -->建议使用<code>PostgreSQL 8.3</code>以上的版本, 以 <a href="http://www.postgresql.org/docs/8.3/static/release-8-3.html" rel="external" target="_self">提供更好的VACUUM性能</a>。</td>
</tr>
<tr>
<td><code>SQLite</code></td>
<td><code>3.3.5-3.34.X</code></td>
<td><code>3.3X.X</code></td>
<td>仅支持<code>Zabbix</code>代理。如果<code>SQLite</code>用作<code>Zabbix</code>代理数据库</td>
</tr>
</tbody>
</table>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl start mariadb
</span></span><span style="display:flex;"><span>$ mysql -uroot -e <span style="color:#e6db74">&#34;create database zabbix character set utf8mb4 collate utf8mb4_bin;&#34;</span> 
</span></span><span style="display:flex;"><span>$ mysql -uroot -e <span style="color:#e6db74">&#34;create user &#39;zabbix&#39;@&#39;localhost&#39; identified by &#39;zabbix&#39;;&#34;</span>   
</span></span><span style="display:flex;"><span>$ mysql -uroot -e <span style="color:#e6db74">&#34;grant all privileges on zabbix.* to &#39;zabbix&#39;@&#39;localhost&#39;;&#34;</span>
</span></span><span style="display:flex;"><span>$ mysql -uroot -e <span style="color:#e6db74">&#34;flush privileges;&#34;</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>Zabbix</code><!-- raw HTML omitted -->前准备<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->卸载原有数据库，安装高版本<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum remove -y mariadb*</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->创建用户<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ groupadd --system zabbix
</span></span><span style="display:flex;"><span>$ useradd --system -g zabbix -d /usr/lib/zabbix -s /sbin/nologin -c <span style="color:#e6db74">&#34;Zabbix Monitoring System&#34;</span> zabbix</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->创建所需目录<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir /opt/<span style="color:#f92672">{</span>src,zabbix<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>$ chown zabbix:zabbix /opt/*</span></span></code></pre></div><ul>
<li>3.4 <!-- raw HTML omitted -->安装依赖<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install epel-release wget unixODBC-devel net-snmp-devel libevent-devel <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>libxml2-devel libcurl-devel java-1.6.0-openjdk-devel gcc gcc-c++ <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>mariadb mariadb-server mariadb-devel
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ yum -y install go
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Debian 系统</span>
</span></span><span style="display:flex;"><span>$ sudo apt-get install libxml2 libxml2-dev libsnmp-dev libevent-dev openjdk-11-jdk <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>libcurl4-openssl-dev </span></span></code></pre></div></blockquote>
<hr>
<h3 id="安装zabbix-server">安装<code>Zabbix Server</code></h3>
<ul>
<li>
<ol>
<li><a href="https://cdn.zabbix.com/zabbix/sources/stable/" rel="external" target="_self">下载<code>Zabbix Server</code>编译安装包</a></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget -P /opt/src/ https://cdn.zabbix.com/zabbix/sources/stable/6.0/zabbix-6.0.14.tar.gz</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->解压配置<!-- raw HTML omitted --><code>Zabbix Server</code><!-- raw HTML omitted -->安装包<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ tar -zxvf /opt/src/zabbix-6.0.14.tar.gz -C /opt/src/
</span></span><span style="display:flex;"><span>$ cd /opt/src/zabbix-6.0.14/
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 编译安装路径</span>
</span></span><span style="display:flex;"><span>$ ./configure --prefix<span style="color:#f92672">=</span>/opt/zabbix --enable-server --enable-agent --enable-ipv6 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-net-snmp --with-libcurl --with-libxml2 --enable-java --with-openssl <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-mysql<span style="color:#f92672">=</span>/usr/local/mysql/bin/mysql_config
</span></span><span style="display:flex;"><span>$ make -j2 <span style="color:#f92672">&amp;&amp;</span> make install</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->拷贝<!-- raw HTML omitted --><code>Zabbix Server</code><!-- raw HTML omitted -->启动文件给予执行权限<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cp /opt/src/zabbix-6.0.14/misc/init.d/fedora/core/zabbix_* /etc/init.d/  
</span></span><span style="display:flex;"><span>$ chmod +x /etc/init.d/zabbix_*</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->启动数据库导入<!-- raw HTML omitted --><code>Zabbix SQL</code><!-- raw HTML omitted -->文件后再启动<!-- raw HTML omitted --><code>Zabbix Server</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ll /opt/src/zabbix-6.0.14/database/mysql/ | grep *.sql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ mysql -uzabbix -p<span style="color:#e6db74">&#39;zabbix&#39;</span> zabbix &lt; /opt/src/zabbix-6.0.14/database/mysql/schema.sql
</span></span><span style="display:flex;"><span>$ mysql -uzabbix -p<span style="color:#e6db74">&#39;zabbix&#39;</span> zabbix &lt; /opt/src/zabbix-6.0.14/database/mysql/images.sql
</span></span><span style="display:flex;"><span>$ mysql -uzabbix -p<span style="color:#e6db74">&#39;zabbix&#39;</span> zabbix &lt; /opt/src/zabbix-6.0.14/database/mysql/data.sql
</span></span><span style="display:flex;"><span>$ mysql -uzabbix -p<span style="color:#e6db74">&#39;zabbix&#39;</span> zabbix &lt; /opt/src/zabbix-6.0.14/database/mysql/double.sql
</span></span><span style="display:flex;"><span>$ mysql -uzabbix -p<span style="color:#e6db74">&#39;zabbix&#39;</span> zabbix &lt; /opt/src/zabbix-6.0.14/database/mysql/history_pk_prepare.sql</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>zabbix_server</code><!-- raw HTML omitted -->配置文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/zabbix/etc/zabbix_server.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DBHost=localhost  	# 数据库地址
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DBName=zabbix  	# 数据库名
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DBUser=root  	# 连接数据库的用户
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DBPassword=123456  	# 密码
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DBSocket=/home/ops/opt/mysql/mysql.sock  	# 数据库sock文件路径
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DBPort=3306  	# 端口
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LogFile=/opt/zabbix_server/logs/zabbix_server.log  	# 日志文件
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">PidFile=/opt/zabbix_server/logs/zabbix_server.pid  	# 保存pid的文件
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SocketDir=/opt/zabbix/logs
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="6">
<li><!-- raw HTML omitted -->拷贝<!-- raw HTML omitted --><code>Zabbix</code><!-- raw HTML omitted -->前端文件，到<!-- raw HTML omitted --><code>Nginx</code>的<code>web</code><!-- raw HTML omitted -->目录<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo cp -rf /opt/src/zabbix-6.0.14/ui/* /usr/local/nginx/html/zabbix/</span></span></code></pre></div></blockquote>
<hr>
<h3 id="docker安装zabbix-server"><code>Docker</code>安装<code>Zabbix Server</code></h3>
<blockquote>
<ul>
<li><a href="https://www.zabbix.com/documentation/6.0/en/manual/installation/containers" rel="external" target="_self">从<code>Docker</code>容器安装</a>、<a href="https://www.leeks.info/zh_CN/latest/index.html" rel="external" target="_self">欢迎使用<code>Leeks</code>的笔记</a></li>
</ul>
</blockquote>
<ul>
<li>
<ol>
<li>创建专用于<code>Zabbix</code>组件容器的网络</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ docker network create --subnet 172.20.0.0/16 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--ip-range 172.20.100.0/20 zabbix-net</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li>启动空<code>MySQL</code>服务器实例数据库<code>8.0</code>以上</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ docker run -v /etc/localtime:/etc/localtime <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   --name mysql-server -t <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -e MYSQL_DATABASE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;zabbix&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -e MYSQL_USER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;zabbix&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -e MYSQL_PASSWORD<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>zabbix_pwd<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -e MYSQL_ROOT_PASSWORD<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>root_pwd<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   --network<span style="color:#f92672">=</span>zabbix-net <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   --restart unless-stopped <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -d mysql:8.0 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   --character-set-server<span style="color:#f92672">=</span>utf8 --collation-server<span style="color:#f92672">=</span>utf8_bin <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   --default-authentication-plugin<span style="color:#f92672">=</span>mysql_native_password</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li>启动<code>Zabbix Java</code>网关实例</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ docker run -v /etc/localtime:/etc/localtime <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   --name zabbix-java-gateway -t <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   --network<span style="color:#f92672">=</span>zabbix-net <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   --restart unless-stopped <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -d zabbix/zabbix-java-gateway:alpine-6.0-latest</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li>启动<code>Zabbix</code>服务器实例并将该实例与创建的<code>MySQL</code>服务器实例链接</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>启动<code>Zabbix</code>服务器实例并将该实例与创建的<code>MySQL</code>服务器实例链接</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ docker volume create zabbix-server-volume
</span></span><span style="display:flex;"><span>$ docker run -v /etc/localtime:/etc/localtime <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --name zabbix-server-mysql -t <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --link zabbix-web-service:zabbix-web-service <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      -e DB_SERVER_HOST<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;mysql-server&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      -e MYSQL_DATABASE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;zabbix&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      -e MYSQL_USER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;zabbix&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      -e MYSQL_PASSWORD<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>zabbix_pwd<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      -e MYSQL_ROOT_PASSWORD<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>root_pwd<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      -e ZBX_JAVAGATEWAY<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;zabbix-java-gateway&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      -e ZBX_STARTREPORTWRITERS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;2&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      -e ZBX_WEBSERVICEURL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://zabbix-web-service:10053/report&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      -v zabbix-server-volume:/etc/zabbix <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      -v <span style="color:#e6db74">${</span>server_dir<span style="color:#e6db74">}</span>/server/alertscripts:/usr/lib/zabbix/alertscripts <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      -v <span style="color:#e6db74">${</span>server_dir<span style="color:#e6db74">}</span>/server/externalscripts:/usr/lib/zabbix/externalscripts <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      -v <span style="color:#e6db74">${</span>server_dir<span style="color:#e6db74">}</span>/server/modules:/usr/lib/zabbix/modules <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --network<span style="color:#f92672">=</span>zabbix-net <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      -p 10051:10051 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --restart unless-stopped <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      -d zabbix/zabbix-server-mysql:alpine-6.0-latest</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li>启动<code>Zabbix Web</code>界面并将实例与创建的<code>MySQL</code>服务器和<code>Zabbix</code>服务器实例链接</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>Zabbix Web</code>界面实例向主机公开<code>80/TCP</code>端口 <code>HTTP</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ docker run -v /etc/localtime:/etc/localtime <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --name zabbix-web-nginx-mysql -t <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      -e ZBX_SERVER_HOST<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;zabbix-server-mysql&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      -e DB_SERVER_HOST<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;mysql-server&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      -e MYSQL_DATABASE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;zabbix&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      -e MYSQL_USER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;zabbix&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      -e MYSQL_PASSWORD<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>zabbix_pwd<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      -e MYSQL_ROOT_PASSWORD<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>root_pwd<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      -e ZBX_SERVER_NAME<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>zabbix_server_name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --network<span style="color:#f92672">=</span>zabbix-net <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      -p 8080:8080 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --restart unless-stopped <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      -d zabbix/zabbix-web-nginx-mysql:alpine-6.0-latest</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="6">
<li>安装<code>Zabbix Proxy</code>服务</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ docker run --name zabbix-proxy-mysql <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -e DB_SERVER_HOST<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;mysql-server&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -e MYSQL_USER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;user&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -e MYSQL_PASSWORD<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;some-password&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -e ZBX_HOSTNAME<span style="color:#f92672">=</span>some-hostname <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -e ZBX_SERVER_HOST<span style="color:#f92672">=</span>some-zabbix-server <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -d zabbix/zabbix-proxy-mysql:alpine-6.0-latest</span></span></code></pre></div></blockquote>
<hr>
<h3 id="配置nginx使浏览器访问zabbix">配置<code>Nginx</code>使浏览器访问<code>Zabbix</code></h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo cat &gt;/usr/local/nginx/conf/vhosts/zabbix.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">server{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> listen 80;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> server_name zabbix.com;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> location / {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     root   /usr/local/nginx/html/zabbix;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     index  index.php index.html index.htm;  	# 添加&#34;index.php&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # tcp socket 通信模式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> location ~ \.php$ {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     root	/usr/local/nginx/html/zabbix;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     fastcgi_pass  127.0.0.1:9000;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     fastcgi_index index.php;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;  	# fastcgi_param行改成这个。
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     include  fastcgi_params;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # Unix socke 通信模式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> location ~ \.php(.*)$ {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     root	/usr/local/nginx/html/zabbix;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     fastcgi_pass unix:/tmp/php7.sock;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     fastcgi_index index.php;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     fastcgi_split_path_info ^((?U).+\.php)(/?.+)$;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     fastcgi_param PATH_INFO $fastcgi_path_info;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     fastcgi_param PATH_TRANSLATED $document_root$fastcgi_path_info;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     include  fastcgi_params;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> } 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> error_page 404 http://zabbix.com;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> access_log  /usr/local/nginx/logs/zabbix-access.log  main;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> error_log   /usr/local/nginx/logs/zabbix-error.log  info;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="启动zabbix服务端和客户端">启动<code>Zabbix</code>服务端和客户端</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># Debian 系统需执行</span>
</span></span><span style="display:flex;"><span>$ sudo ln -s /usr/local/mysql/lib/libmysqlclient.so.20 /usr/lib/libmysqlclient.so.20
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ /opt/zabbix/sbin/zabbix_server  	<span style="color:#75715e"># 启动 Zabbix Server</span>
</span></span><span style="display:flex;"><span>$ /opt/zabbix/sbin/zabbix_agentd  	<span style="color:#75715e"># 启动 Zabbix Agentd</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="处理访问页面后没有中文选项">处理访问页面后没有中文选项</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 列出说有支持的语言</span>
</span></span><span style="display:flex;"><span>$ locale -a
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 如果没有想要的语言环境，打开下方文件找到需要的语言取消注释</span>
</span></span><span style="display:flex;"><span>$ sudo cat &gt;/etc/locale.gen<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># zh_CN.UTF-8 UTF-8
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 重载语言环境</span>
</span></span><span style="display:flex;"><span>$ sudo locale-gen
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 重启PHP使配置生效，然后刷新浏览器</span>
</span></span><span style="display:flex;"><span>$ sudo /etc/init.d/php-fpm restart</span></span></code></pre></div></blockquote>
<hr>
<h3 id="web页面配置zabbix"><code>web</code>页面配置<code>zabbix</code></h3>
<blockquote>
<p><a href="#R-image-7645e66d00c42505a5f266012b2dfa13" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server/Snipaste_2022-09-14_23-08-45.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-7645e66d00c42505a5f266012b2dfa13"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server/Snipaste_2022-09-14_23-08-45.png"></a></p>
<ul>
<li><!-- raw HTML omitted -->下方图片显示要修改的<!-- raw HTML omitted --><code>PHP</code><!-- raw HTML omitted -->配置文件,修改后重启<!-- raw HTML omitted --><code>php-fpm</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;s/post_max_size = 8M/post_max_size = 16M/g&#34;</span> /usr/local/php/etc/php.ini  
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;s/max_execution_time = 30/max_execution_time = 300/g&#34;</span> /usr/local/php/etc/php.ini  
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;s/max_input_time = 60/max_input_time = 300/g&#34;</span> /usr/local/php/etc/php.ini </span></span></code></pre></div><p><a href="#R-image-bebd85742f9d43cd9c3ce59afcb0b15b" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server/Snipaste_2022-09-14_23-11-47.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-bebd85742f9d43cd9c3ce59afcb0b15b"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server/Snipaste_2022-09-14_23-11-47.png"></a></p>
<ul>
<li><!-- raw HTML omitted -->连接数据库报错<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ln -s /var/lib/mysql/mysql.sock /tmp/</span></span></code></pre></div><p><a href="#R-image-b77346fbde264fac46bed5185f17d98e" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server/Snipaste_2022-09-14_23-13-46.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-b77346fbde264fac46bed5185f17d98e"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server/Snipaste_2022-09-14_23-13-46.png"></a></p>
<p><a href="#R-image-bf42bb60ea5e7968b79622826e13819b" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server/Snipaste_2022-09-14_23-15-02.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-bf42bb60ea5e7968b79622826e13819b"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server/Snipaste_2022-09-14_23-15-02.png"></a></p>
<p><a href="#R-image-053051777b24686d730fc53b8bc97535" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server/Snipaste_2022-09-14_23-15-52.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-053051777b24686d730fc53b8bc97535"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server/Snipaste_2022-09-14_23-15-52.png"></a></p>
<p><a href="#R-image-dcd3ede899acef32f3df0ea234d4e665" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server/Snipaste_2022-09-14_23-16-37.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-dcd3ede899acef32f3df0ea234d4e665"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server/Snipaste_2022-09-14_23-16-37.png"></a></p>
<p><a href="#R-image-0a29a087918764f9bc3f9770ad0f3a20" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server/Snipaste_2022-09-14_23-17-40.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-0a29a087918764f9bc3f9770ad0f3a20"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server/Snipaste_2022-09-14_23-17-40.png"></a></p>
<p><a href="#R-image-0ca843b509146bd5b078761716f32341" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server/Snipaste_2022-09-14_23-18-45.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-0ca843b509146bd5b078761716f32341"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server/Snipaste_2022-09-14_23-18-45.png"></a></p>
<ul>
<li><!-- raw HTML omitted --><strong>默认帐户：</strong><!-- raw HTML omitted --><code>Admin</code><!-- raw HTML omitted -->，<strong>默认密码：</strong><!-- raw HTML omitted --><code>zabbix</code></li>
</ul>
<p><a href="#R-image-ae95777879f433b9d7a42fc1bc0c9f7d" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server/Snipaste_2022-09-14_23-20-31.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-ae95777879f433b9d7a42fc1bc0c9f7d"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server/Snipaste_2022-09-14_23-20-31.png"></a></p>
<ul>
<li><!-- raw HTML omitted -->处理图形汉字乱码<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rz /usr/local/nginx/html/assets/fonts
</span></span><span style="display:flex;"><span>$ mv simhei.ttf DejaVuSans.ttf</span></span></code></pre></div></blockquote>
<hr>
<h2 id="编译安装zabbix-agent">编译安装<code>Zabbix Agent</code></h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->部署前准备<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir /opt/<span style="color:#f92672">{</span>src,zabbix-agent<span style="color:#f92672">}</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted --><a href="https://cdn.zabbix.com/zabbix/binaries/stable/" rel="external" target="_self">下载安装包</a><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install wget
</span></span><span style="display:flex;"><span>$ wget -P /opt/src/ 
</span></span><span style="display:flex;"><span>https://cdn.zabbix.com/zabbix/binaries/stable/6.0/6.0.14/zabbix_agent-6.0.14-linux-3.0-amd64-static.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ tar -zxvf /opt/src/zabbix_agent-6.0.14-linux-3.0-amd64-static.tar.gz -C /opt/zabbix-agent </span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>Zabbix Agent</code><!-- raw HTML omitted -->配置文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/zabbix-agent/conf/zabbix_agentd.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Server=127.0.0.1  	# 添加Zabbix Server服务器IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ServerActive=127.0.0.1  	# 替换为Zabbix Server服务器IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Hostname=本机主机名  	# 被监控端自己的主机名
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">AllowKey=system.run[*]  	# 监控异常后，是否允许服务器远程过来执行命令，如重启某个服务
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">UnsafeUserParameters=1  	# 是否允许自定义key监控
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->启动<!-- raw HTML omitted --><code>Zabbix Agent</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /opt/zabbix-agent/sbin/zabbix_agentd -c /opt/zabbix-agent/conf/zabbix_agentd.conf</span></span></code></pre></div></blockquote>
<hr>
<h2 id="配置zabbix通信加密">配置<code>Zabbix</code>通信加密</h2>
<ul>
<li>
<ol>
<li>申请证书</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 生成ca私钥</span>
</span></span><span style="display:flex;"><span>$ openssl genrsa <span style="color:#ae81ff">2048</span> &gt; ca.key
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用ca私钥建立ca证书</span>
</span></span><span style="display:flex;"><span>$ openssl req -new -x509 -nodes -days <span style="color:#ae81ff">1000</span> -key ca.key -subj /CN<span style="color:#f92672">=</span>Signing<span style="color:#ae81ff">\ </span>CA/OU<span style="color:#f92672">=</span>Development<span style="color:#ae81ff">\ </span>group/O<span style="color:#f92672">=</span>Zabbix<span style="color:#ae81ff">\ </span>SIA/DC<span style="color:#f92672">=</span>zabbix/DC<span style="color:#f92672">=</span>com &gt; ca.crt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成服务器csr证书请求文件</span>
</span></span><span style="display:flex;"><span>$ openssl req -newkey rsa:2048 -days <span style="color:#ae81ff">1000</span> -nodes -keyout server.key -subj /CN<span style="color:#f92672">=</span>server/OU<span style="color:#f92672">=</span>Development<span style="color:#ae81ff">\ </span>group/O<span style="color:#f92672">=</span>Zabbix<span style="color:#ae81ff">\ </span>SIA/DC<span style="color:#f92672">=</span>zabbix/DC<span style="color:#f92672">=</span>com &gt; server.csr
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用ca证书与私钥签发服务器证书</span>
</span></span><span style="display:flex;"><span>$ openssl x509 -req -in server.csr -days <span style="color:#ae81ff">1000</span> -CA ca.crt -CAkey ca.key -set_serial <span style="color:#ae81ff">01</span> &gt; server.crt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成客户端csr证书请求文件</span>
</span></span><span style="display:flex;"><span>$ openssl req -newkey rsa:2048 -days <span style="color:#ae81ff">1000</span> -nodes -keyout client.key -subj /CN<span style="color:#f92672">=</span>client/OU<span style="color:#f92672">=</span>Development<span style="color:#ae81ff">\ </span>group/O<span style="color:#f92672">=</span>Zabbix<span style="color:#ae81ff">\ </span>SIA/DC<span style="color:#f92672">=</span>zabbix/DC<span style="color:#f92672">=</span>com &gt; client.csr
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用ca证书与私钥签发客户端证书</span>
</span></span><span style="display:flex;"><span>$ openssl x509 -req -in client.csr -days <span style="color:#ae81ff">1000</span> -CA ca.crt -CAkey ca.key -set_serial <span style="color:#ae81ff">01</span> &gt; client.crt</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li>配置<code>Zabbix Server</code>服务端</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/zabbix/etc/zabbix_server.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 修改TLSCAFile配置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">TLSCAFile=/opt/zabbix_server/zabbix_crt/ca.crt
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 修改TLSCertFile配置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">TLSCertFile=/opt/zabbix_server/zabbix_crt/server.crt
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 修改TLSKeyFile配置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">TLSKeyFile=/opt/zabbix_server/zabbix_crt/server.key
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li>配置<code>Zabbix Agent</code>端</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>配置<code>PSK</code>加密</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/zabbix-agent/conf/zabbix_agentd.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">TLSPSKIdentity= PSK Name  	# 一致性共享密钥名称
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">TLSPSKFile= PSK File  	# PSK 共享密钥文件存放路径
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li>配置证书加密</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/zabbix-agent/conf/zabbix_agentd.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 修改agent连接模式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">TLSConnect=cert
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 修改传入数据连接模式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">TLSAccept=cert
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 修改TLSCAFile配置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">TLSCAFile=/opt/zabbix_agent/zabbix_crt/ca.crt
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 修改TLSCertFile配置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">TLSCertFile=/opt/zabbix_agent/zabbix_crt/client.crt
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 修改TLSKeyFile配置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">TLSKeyFile=/opt/zabbix_agent/zabbix_crt/client.key
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_prometheus">Install_Prometheus</h1>

<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<h2 id="prometheus"><code>Prometheus</code></h2>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://prometheus.io/docs/introduction/first_steps/" rel="external" target="_self"><code>Prometheus</code>官网</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://yunlzheng.gitbook.io/prometheus-book" rel="external" target="_self"><code>prometheus-book</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/prometheus" rel="external" target="_self"><code>Github-Prometheus</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://blog.gmem.cc/prometheus-study-note" rel="external" target="_self"><code>Prometheus</code>学习笔记</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://blog.51cto.com/qiangsh/3093700" rel="external" target="_self"><code>Prometheus</code>介绍和使用</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://juejin.im/post/5d79d804e51d453b7779d5ce" rel="external" target="_self"><code>Prometheus</code>+<code>Grafana</code>详解</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.cnblogs.com/qianjingchen/articles/9578341.html" rel="external" target="_self"><code>Prometheus</code>自定义监控部署</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://prometheus.io/docs/instrumenting/clientlibs/" rel="external" target="_self"><code>Prometheus  CLIENT LIBRARIES</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://juejin.im/post/5d397c2fe51d45775e33f64a" rel="external" target="_self">使用<code>Prometheus</code>+<code>Grafana</code>快速打造高逼格监控平台</a></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->概述<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<p><code>Prometheus</code>是一个开源监控系统，它前身是<a href="https://soundcloud.com" rel="external" target="_self"><code>SoundCloud</code></a>的告警工具包。从<code>2012</code>年开始，许多公司和组织开始使用<code>Prometheus</code>。该项目的开发人员和用户社区非常活跃，越来越多的开发人员和用户参与到该项目中。目前它是一个独立的开源项目，且不依赖于任何公司。为了强调这点和明确该项目治理结构，<code>Prometheus</code>在<code>2016</code>年继<a href="https://kubernetes.io" rel="external" target="_self"><code>Kurberntes</code></a>之后，加入了<a href="https://www.cncf.io" rel="external" target="_self"><code>Cloud Native Computing Foundation</code></a></p>
<ul>
<li>1.1 <code>prometheus</code><!-- raw HTML omitted -->特点<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->多维度数据模型，一个时间序列由一个度量指标和多个标签键值对确定<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->灵活的查询语言，对收集的时许数据进行重组<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->强大的数据可视化功能，除了内置的浏览器，也支持<!-- raw HTML omitted --><code>grafana</code><!-- raw HTML omitted -->集成<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->高效存储，内存加本地磁盘，可通过功能分片和联盟来拓展性能<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->运维简单，只依赖于本地磁盘，<!-- raw HTML omitted --><code>go</code><!-- raw HTML omitted -->二进制安装包没有任何其他依赖 <!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->精简告警<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->非常多的客户端库<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->提供了许多导出器来收集常用系统指标<!-- raw HTML omitted --></li>
</ul>
</blockquote>
</blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->数据模型 <!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<p><code>Prometheus</code>从根本上存储的所有数据都是时间序列数据（<code>Time Serie Data</code>，简称时序数据）。时序数据是具有时间戳的数据流，该数据流属于某个度量指标（<code>Metric</code>）和该度量指标下的多个标签（<code>Label</code>）。除了提供存储功能，<code>Prometheus</code>还可以利用查询表达式来执行非常灵活和复杂的查询。</p>
<ul>
<li>
<p><!-- raw HTML omitted -->度量指标和标签<!-- raw HTML omitted --></p>
<p>每个时间序列（<code>Time Serie</code>，简称时序）由度量指标和一组标签键值对唯一确定。</p>
</li>
<li>
<p>度量指标名称描述了被监控系统的某个测量特征（比如<code>http_requests_total</code>表示<code>http</code>请求总数）。度量指标名称由<code>ASCII</code>字母、数字、下划线和冒号组成，须匹配正则表达式<code>[a-zA-Z_:][a-zA-Z0-9_:]*</code>。</p>
</li>
<li>
<p>标签开启了<code>Prometheus</code>的多维数据模型。对于同一个度量指标，不同标签值组合会形成特定维度的时序。<code>Prometheus</code>的查询语言可以通过度量指标和标签对时序数据进行过滤和聚合。改变任何度量指标上的任何标签值，都会形成新的时序。标签名称可以包含<code>ASCII</code>字母、数字和下划线，须匹配正则表达式<code>[a-zA-Z_][a-zA-Z0-9_]*</code>，带有 _ 下划线的标签名称保留为内部使用。标签值可以包含任意<code>Unicode</code>字符，包括中文。</p>
</li>
<li>
<p><!-- raw HTML omitted -->采样值(<code>Sample</code>)<!-- raw HTML omitted --></p>
</li>
</ul>
<blockquote>
<p>时序数据其实就是一系列采样值。每个采样值包括：</p>
<ul>
<li><!-- raw HTML omitted -->一个<code>64</code>位的浮点数值  <!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->一个精确到毫秒的时间戳  <!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->注解(<code>Notation</code>)<!-- raw HTML omitted --></li>
</ul>
<p>一个注解由一个度量指标和一组标签键值对构成。形式如下：</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>metric name<span style="color:#f92672">]{[</span>label name<span style="color:#f92672">]=[</span>label value<span style="color:#f92672">]</span>, ...<span style="color:#f92672">}</span>  </span></span></code></pre></div><p>例如，度量指标为<code>api_http_requests_total</code>，标签为<code>method=&quot;POST&quot;</code>、<code>handler=&quot;/messages&quot;</code>的注解表示如下：</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>api_http_requests_total<span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;POST&#34;</span>, handler<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/messages&#34;</span><span style="color:#f92672">}</span></span></span></code></pre></div></blockquote>
</blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->度量指标类型 <!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->计数器(<code>Counter</code>)<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0"><code>计数器是一种累计型的度量指标，它是一个只能递增的数值。计数器主要用于统计类似于服务请求数、任务完成数和错误出现次数这样的数据</code></pre></div><ul>
<li><!-- raw HTML omitted -->计量器(<code>Gauge</code>)<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0"><code>计量器表示一个既可以增加, 又可以减少的度量指标值。计量器主要用于测量类似于温度、内存使用量这样的瞬时数据</code></pre></div><ul>
<li><!-- raw HTML omitted -->直方图(<code>Histogram</code>)<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0"><code>直方图对观察结果（通常是请求持续时间或者响应大小这样的数据）进行采样，并在可配置的桶中对其进行统计。有以下几种方式来产生直方图（假设度量指标为 ）：  </code></pre></div><ul>
<li><!-- raw HTML omitted -->按桶计数<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0"><code>相当于&lt;basename&gt;_bucket{le=&#34;&lt;upper inclusive bound&gt;&#34;}</code></pre></div><ul>
<li><!-- raw HTML omitted -->采样值总和<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0"><code>相当于 &lt;basename&gt;_sum  </code></pre></div><ul>
<li><!-- raw HTML omitted -->采样值总数<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0"><code>相当于 &lt;basename&gt;_count ，也等同于把所有采样值放到一个桶里来计数 &lt;basename&gt;_bucket{le=&#34;+Inf&#34;}</code></pre></div><ul>
<li><!-- raw HTML omitted -->汇总(<code>Summary</code>)<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0"><code>类似于直方图，汇总也对观察结果进行采样。除了可以统计采样值总和和总数，它还能够按分位数统计。有以下几种方式来产生汇总（假设度量指标为 ）：</code></pre></div><ul>
<li><!-- raw HTML omitted -->采样值总和<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0"><code>相当于 &lt;basename&gt;_sum</code></pre></div><ul>
<li><!-- raw HTML omitted -->采样值总数<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0"><code>相当于 &lt;basename&gt;_count  </code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->任务(<code>Job</code>)和实例(<code>Instance</code>)<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<p>在<code>Prometheus</code>里，可以从中抓取采样值的端点称为实例，为了性能扩展而复制出来的多个这样的实例形成了一个任务</p>
<ul>
<li><!-- raw HTML omitted -->例如下面的<!-- raw HTML omitted --><code>api-server</code><!-- raw HTML omitted -->任务有四个相同的实例<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0"><code>job: api-server
instance 1: 1.2.3.4:5670
instance 2: 1.2.3.4:5671
instance 3: 5.6.7.8:5670
instance 4: 5.6.7.8:5671</code></pre></div><p>​	<code>Prometheus</code>抓取完采样值后，会自动给采样值添加下面的标签和值：</p>
<ul>
<li>
<p><code>job:</code><!-- raw HTML omitted --> 抓取所属任务<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>instance</code><!-- raw HTML omitted -->： 抓取来源实例<!-- raw HTML omitted --></p>
<p>另外每次抓取时，<code>Prometheus</code>还会自动在以下时序里插入采样值：</p>
</li>
<li>
<p><code>up{job=&quot;[job-name]&quot;, instance=&quot;instance-id&quot;}</code><!-- raw HTML omitted -->：采样值为 1 表示实例健康，否则为不健康<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>scrape_duration_seconds{job=&quot;[job-name]&quot;, instance=&quot;[instance-id]&quot;}</code><!-- raw HTML omitted -->：采样值为本次抓取消耗时间<!-- raw HTML omitted --></p>
</li>
<li>
<p><code>scrape_samples_post_metric_relabeling{job=&quot;&lt;job-name&gt;&quot;, instance=&quot;&lt;instance-id&gt;&quot;}</code><!-- raw HTML omitted -->：采样值为重新打标签后的采样值个数  <!-- raw HTML omitted --></p>
</li>
<li>
<p><code>scrape_samples_scraped{job=&quot;&lt;job-name&gt;&quot;, instance=&quot;&lt;instance-id&gt;&quot;}</code><!-- raw HTML omitted -->：采样值为本次抓取到的采样值个数  <!-- raw HTML omitted --></p>
</li>
</ul>
</blockquote>
<hr>
<h3 id="prometheus与其他监控系统对比"><code>Prometheus</code>与其他监控系统对比</h3>
<ul>
<li>
<ol>
<li><code>Prometheus vs Zabbix</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><a href="https://www.zabbix.com" rel="external" target="_self"><code>Zabbix</code></a><!-- raw HTML omitted -->使用的是<!-- raw HTML omitted --><code>C</code><!-- raw HTML omitted -->和<!-- raw HTML omitted --><code>PHP</code>, <code>Prometheus</code><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>Golang</code><!-- raw HTML omitted -->整体而言<!-- raw HTML omitted --><code>Prometheus</code><!-- raw HTML omitted -->运行速度更快一点<!-- raw HTML omitted --></li>
<li><code>Zabbix</code><!-- raw HTML omitted -->属于传统主机监控，主要用于物理主机、交换机、网络等监控，<!-- raw HTML omitted --><code>Prometheus</code><!-- raw HTML omitted -->不仅适用主机监控，还适用于<!-- raw HTML omitted --><code>Cloud</code>、<code>SaaS</code>、<code>Openstack</code>、<code>Container</code><!-- raw HTML omitted -->监控<!-- raw HTML omitted --></li>
<li><code>Zabbix</code><!-- raw HTML omitted -->在传统主机监控方面，有更丰富的插件<!-- raw HTML omitted --></li>
<li><code>Zabbix</code><!-- raw HTML omitted -->可以在<!-- raw HTML omitted --><code>WebGui</code><!-- raw HTML omitted -->中配置很多事情，<!-- raw HTML omitted --><code>Prometheus</code><!-- raw HTML omitted -->需要手动修改文件配置<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li>
<ol start="2">
<li><code>Prometheus vs Nagios</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><a href="https://www.nagios.org" rel="external" target="_self"><code>Nagios</code></a><!-- raw HTML omitted -->数据不支持自定义<!-- raw HTML omitted --><code>Labels</code><!-- raw HTML omitted -->, 不支持查询，告警也不支持去噪、分组, 没有数据存储，如果想查询历史状态，需要安装插件<!-- raw HTML omitted --></li>
<li><code>Nagios</code><!-- raw HTML omitted -->是上世纪 90 年代的监控系统，比较适合小集群或静态系统的监控<!-- raw HTML omitted --><code>Nagios</code><!-- raw HTML omitted -->太古老，很多特性都没有<!-- raw HTML omitted --><code>Prometheus</code><!-- raw HTML omitted -->要优秀很多<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li>
<ol start="3">
<li><code>Prometheus vs Sensu</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><a href="https://sensu.io" rel="external" target="_self"><code>Sensu</code></a><!-- raw HTML omitted -->广义上讲是<!-- raw HTML omitted --><code>Nagios</code><!-- raw HTML omitted -->的升级版本，它解决了很多<!-- raw HTML omitted --><code>Nagios</code><!-- raw HTML omitted -->的问题，如果你对<!-- raw HTML omitted --><code>Nagios</code><!-- raw HTML omitted -->很熟悉，使用<!-- raw HTML omitted --><code>Sensu</code><!-- raw HTML omitted -->是个不错的选择<!-- raw HTML omitted --></li>
<li><code>Sensu</code><!-- raw HTML omitted -->依赖<!-- raw HTML omitted --><code>RabbitMQ</code><!-- raw HTML omitted -->和<!-- raw HTML omitted --><code>Redis</code><!-- raw HTML omitted -->，数据存储上扩展性更好<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li>
<ol start="4">
<li><code>Prometheus vs InfluxDB</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><a href="https://www.influxdata.com" rel="external" target="_self"><code>InflusDB</code></a><!-- raw HTML omitted -->是一个开源的时序数据库，主要用于存储数据，如果想搭建监控告警系统，需要依赖其他系统<!-- raw HTML omitted --></li>
<li><code>InfluxDB</code><!-- raw HTML omitted -->在存储水平扩展以及高可用方面做的更好, 毕竟核心是数据库<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<hr>
<h3 id="altermanager核心概念"><code>altermanager</code>核心概念</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->分组<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>分组将类似性质的警报分类为单个通知。在许多系统一次性失败并且数百到数千个警报可能同时发生的较大中断期间，这尤其有用</li>
<li>示例：发生网络分区时，群集中正在运行数十或数百个服务实例。一半的服务实例无法再访问数据库。<code>Prometheus</code>中的警报规则配置为在每个服务实例无法与数据库通信时发送警报。结果，数百个警报被发送到<code>Alertmanager</code></li>
<li>作为用户，人们只想获得单个页面，同时仍能够确切地看到哪些服务实例受到影响。因此，可以将<code>Alertmanager</code>配置为按群集和<code>alertname</code>对警报进行分组，以便发送单个紧凑通知</li>
<li>通过配置文件中的路由树配置警报的分组，分组通知的定时以及这些通知的接收器</li>
</ul>
</blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->抑制<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>如果某些其他警报已经触发，则抑制是抑制某些警报的通知的概念。示例：正在触发警报，通知无法访问整个集群。<code>Alertmanager</code>可以配置为在该特定警报触发时将与该集群有关的所有其他警报静音。这可以防止数百或数千个与实际问题无关的触发警报的通知。通过<code>Alertmanager</code>的配置文件配置禁止</li>
</ul>
</blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->沉默<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>3沉默是在给定时间内简单地静音警报的简单方法。基于匹配器配置静默，就像路由树一样。检查传入警报它们是否匹配活动静默的所有相等或正则表达式匹配器。如果他们这样做，则不会发送该警报的通知。在<code>Alertmanager</code>的<code>Web</code>界面中配置了静音</li>
</ul>
</blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->客户端行为<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>Alertmanager</code>对其客户的行为有特殊要求。这些仅适用于不使用<code>Prometheus</code>发送警报的高级用例</li>
</ul>
</blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->高可用<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>Alertmanager</code>支持配置以创建用于高可用性的集群。这可以使用<code>--cluster- *</code>标志进行配置。重要的是不要在<code>Prometheus</code>和它的<code>Alertmanagers</code>之间加载平衡流量，而是将<code>Prometheus</code>指向所有<code>Alertmanagers</code>的列表</li>
</ul>
</blockquote>
<ul>
<li>
<ol start="6">
<li><!-- raw HTML omitted -->监控要点<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>监控方式</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>硬件监控</td>
<td>温度、硬件故障等</td>
</tr>
<tr>
<td>系统监控</td>
<td><code>CPU</code>、内存、硬盘、网卡流量、<code>TCP</code>状态、进程数</td>
</tr>
<tr>
<td>应用监控</td>
<td><code>Nginx</code>、<code>Tomcat</code>、<code>PHP</code>、<code>MySQL</code>、<code>Redis</code>等</td>
</tr>
<tr>
<td>日志监控</td>
<td>系统日志、服务日志、访问日志、错误日志</td>
</tr>
<tr>
<td>安全监控</td>
<td><code>WAF</code>、敏感文件监控</td>
</tr>
<tr>
<td><code>API</code>监控</td>
<td>可用性、接口请求、相应时间</td>
</tr>
<tr>
<td>业务监控</td>
<td>例如电商网站、每分钟生成多少订单、注册用户多少、推广活动效果</td>
</tr>
<tr>
<td>流量分析</td>
<td>根据流量获取用户相关信息，例如用户地理位置、某页面访问状态、页面停留时间等</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>名称</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Counter</code></td>
<td>递增计数器 <code>eg</code>： <code>API</code></td>
</tr>
<tr>
<td><code>Gauge</code></td>
<td>可以任意变化的数值 <code>eg. cpu</code>占用率</td>
</tr>
<tr>
<td><code>Histogram</code></td>
<td>对一段时间范围内数据进行采样，并对所有数值求和与统计数量<code>eg</code>柱状图</td>
</tr>
<tr>
<td><code>Summary</code></td>
<td>与<code>Histogram</code>类似</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h3 id="安装部署">安装部署</h3>
<h4 id="prometheus安装"><code>prometheus</code>安装</h4>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted --><a href="https://prometheus.io/docs/prometheus/latest/installation/" rel="external" target="_self"><code>docker</code>安装</a><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -p /opt/prometheus/<span style="color:#f92672">{</span>conf,logs,data<span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ docker run --detach --name prometheus <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--restart always --publish 19090:9090 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--volume /opt/prometheus/data:/data <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--volume /opt/prometheus/conf:/etc/prometheus <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--config.file<span style="color:#f92672">=</span>/opt/prometheus/conf/prometheus.yml <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>prom/prometheus:v2.40.0  	<span style="color:#75715e"># --config.file 使用额外卷</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;/opt/docker-compost/prometheus/docker-compose.yml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">version: &#34;3&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">services:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">prometheus:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">container_name: prometheus  # 启动后名称
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">image: &#39;prom/prometheus:v2.40.0&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># image: &#39;prom/prometheus:v2.40.4&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># image: &#39;prom/prometheus:v2.40.3&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">restart: always
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">hostname: &#39;prometheus&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">environment:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  TZ: Asia/Shanghai
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ports:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - &#39;19090:9090&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      volumes:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - &#39;/opt/prometheus/data:/data&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - &#39;/opt/prometheus/conf:/etc/prometheus&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ docker-compose up -d</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted --><a href="https://prometheus.io/docs/prometheus/latest/getting_started/" rel="external" target="_self">二进制安装</a><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /opt/src <span style="color:#f92672">&amp;&amp;</span> wget https://github.com/prometheus/prometheus/releases/download/v2.40.0/prometheus-2.40.0.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>$ tar -zxf prometheus-2.40.0.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>$ mv prometheus-2.40.0.linux-amd64 prometheus  
</span></span><span style="display:flex;"><span>$ chown root.root prometheus -R </span></span></code></pre></div><ul>
<li>2.1 <!-- raw HTML omitted -->编写启动文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/usr/lib/systemd/system/prometheus.service <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=Prometheus
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Documentation=https://prometheus.io/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Type=simple
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/prometheus/prometheus --config.file=/opt/prometheus/prometheus.yml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecReload=/bin/kill -HUP $MAINPID
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=on-failure  	# 或者使用 always
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">StandardOutput=syslog
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">StandardError=syslog
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SyslogIdentifier=prometheus
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=user_name
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Group=user_name
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LimitNOFILE=65535
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li>启动服务、以及设置开机自启<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ nohup ./prometheus --config.file<span style="color:#f92672">=</span>prometheus.yml 2&gt;&amp;<span style="color:#ae81ff">1</span> 1&gt;prometheus.log &amp;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ systemctl enable prometheus
</span></span><span style="display:flex;"><span>$ systemctl start prometheus</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->查看服务<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ netstat -lntup |grep prometheus
</span></span><span style="display:flex;"><span>tcp6       <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> :::9090                 :::*                    LISTEN      16655/prometheus</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->源码安装<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ go get github.com/prometheus/prometheus/cmd/...  
</span></span><span style="display:flex;"><span>$ prometheus --config.file<span style="color:#f92672">=</span>your_config.yml  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 或者make build  </span>
</span></span><span style="display:flex;"><span>$ mkdir -p $GOPATH/src/github.com/prometheus
</span></span><span style="display:flex;"><span>$ cd $GOPATH/src/github.com/prometheus
</span></span><span style="display:flex;"><span>$ git clone https://github.com/prometheus/prometheus.git
</span></span><span style="display:flex;"><span>$ cd prometheus
</span></span><span style="display:flex;"><span>$ make build
</span></span><span style="display:flex;"><span>$ ./prometheus --config.file<span style="color:#f92672">=</span>your_config.yml</span></span></code></pre></div></blockquote>
<hr>
<h4 id="alertmanager安装"><code>alertmanager</code>安装</h4>
<ul>
<li>
<ol>
<li><code>docker</code><!-- raw HTML omitted -->安装<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><a href="https://quay.io/repository/prometheus/alertmanager?tab=tags&tag=latest" rel="external" target="_self"><code>Alertmanager</code></a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -p /opt/alertmanager/<span style="color:#f92672">{</span>conf,logs,data<span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ docker run --detach --name alertmanager <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --restart always --publish 19093:9093 --publish 19094:9094 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --volume /opt/alertmanager/data:/data <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --volume /opt/alertmanager/conf:/etc/alertmanager <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  quay.io/prometheus/alertmanager:latest
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;/opt/docker-compost/alertmanager/docker-compose.yml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">version: &#34;3&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  services:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    alertmanager:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      container_name: alertmanager  # 启动后名称
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      image: &#39;quay.io/prometheus/alertmanager:latest&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      # image: &#39;quay.io/prometheus/alertmanager:v0.24.0&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      # image: &#39;quay.io/prometheus/alertmanager:v0.23.0&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      restart: always
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      hostname: &#39;alertmanager&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      environment:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        TZ: Asia/Shanghai
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      ports:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - &#39;19093:9093&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - &#39;19094:9094&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      volumes:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - &#39;/opt/alertmanager/data:/data&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - &#39;/opt/alertmanager/conf:/etc/alertmanager&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ docker-compose up -d</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->二进制安装<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /opt <span style="color:#f92672">&amp;&amp;</span> wget -c https://github.com/prometheus/alertmanager/releases/download/v0.24.0/alertmanager-0.24.0.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>$ tar zxf alertmanager-0.24.0.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>$ mv alertmanager-0.24.0.linux-amd64 alertmanager
</span></span><span style="display:flex;"><span>$ chown root.root alertmanager -R</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->编写启动文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/usr/lib/systemd/system/alertmanager.service <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=Alertmanager
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Documentation=https://prometheus.io/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Type=simple
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/alertmanager/alertmanager --config.file=/opt/alertmanager/alertmanager.yml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->启动服务、以及设置开机自启<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ nohup ./alertmanager --config.file<span style="color:#f92672">=</span>alertmanager.yml 2&gt;&amp;<span style="color:#ae81ff">1</span> 1&gt;alertmanager.log &amp;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ systemctl enable alertmanager
</span></span><span style="display:flex;"><span>$ systemctl start alertmanager</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->查看启动服务的端口<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ netstat -lntup |grep alertmanager
</span></span><span style="display:flex;"><span>tcp6       <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> :::9094                 :::*                    LISTEN      17237/alertmanager
</span></span><span style="display:flex;"><span>tcp6       <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> :::9093                 :::*                    LISTEN      17237/alertmanager
</span></span><span style="display:flex;"><span>udp6       <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> :::9094                 :::*                                17237/alertmanager</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->编译安装<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ GO15VENDOREXPERIMENT<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> go get github.com/prometheus/alertmanager/cmd/...
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cd $GOPATH/src/github.com/prometheus/alertmanager</span>
</span></span><span style="display:flex;"><span>$ alertmanager --config.file<span style="color:#f92672">=</span>&lt;your_file&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 手动源码构建</span>
</span></span><span style="display:flex;"><span>$ mkdir -p $GOPATH/src/github.com/prometheus
</span></span><span style="display:flex;"><span>$ cd $GOPATH/src/github.com/prometheus
</span></span><span style="display:flex;"><span>$ git clone https://github.com/prometheus/alertmanager.git
</span></span><span style="display:flex;"><span>$ cd alertmanager
</span></span><span style="display:flex;"><span>$ make build
</span></span><span style="display:flex;"><span>$ ./alertmanager --config.file<span style="color:#f92672">=</span>&lt;your_file&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># amtool构建</span>
</span></span><span style="display:flex;"><span>$ make build BINARIES<span style="color:#f92672">=</span>amtool</span></span></code></pre></div></blockquote>
<hr>
<h4 id="节点安装node_export">节点安装<code>node_export</code></h4>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->利用<!-- raw HTML omitted --><code>node_export</code><!-- raw HTML omitted -->来监控主机，官方也提供了很多其他的<!-- raw HTML omitted --><code>export</code><!-- raw HTML omitted -->可以用来直接使用<!-- raw HTML omitted --></li>
<li><a href="https://prometheus.io/docs/instrumenting/exporters/" rel="external" target="_self"><code>EXPORTERS AND INTEGRATIONS</code></a></li>
<li><a href="https://prometheus.io/docs/guides/node-exporter/" rel="external" target="_self">使用<code>NODE EXPORTER</code>监控<code>LINUX</code>主机指标</a></li>
<li><a href="https://grafana.com/grafana/dashboards/8919-1-node-exporter-for-prometheus-dashboard-cn-0413-consulmanager/" rel="external" target="_self"><code>1 Node Exporter Dashboard 22/04/13 ConsulManager</code>自动同步版</a></li>
</ul>
</blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->二进制安装  <!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /opt <span style="color:#f92672">&amp;&amp;</span> wget -c https://github.com/prometheus/node_exporter/releases/download/v1.4.0/node_exporter-1.4.0.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>$ tar zxvf node_exporter-1.4.0.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>$ mv node_exporter-1.4.0.linux-amd64 node_exporter
</span></span><span style="display:flex;"><span>$ chown root.root node_exporter -R</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->编写启动文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/usr/lib/systemd/system/node_exporter.service <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=node_exporter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Documentation=https://prometheus.io/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Type=simple
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/node_exporter/node_exporter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->启动服务、以及设置开机自启<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ nohup ./node_exporter --config.file<span style="color:#f92672">=</span>node_exporter.yml 2&gt;&amp;<span style="color:#ae81ff">1</span> 1&gt;node_exporter.log &amp;  
</span></span><span style="display:flex;"><span>$ systemctl enable node_exporter
</span></span><span style="display:flex;"><span>$ systemctl start node_exporter</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->查看启动的服务端口<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ netstat -lntup |grep node_export
</span></span><span style="display:flex;"><span>tcp6       <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> :::9100                 :::*                    LISTEN      4551/node_exporter</span></span></code></pre></div></blockquote>
<hr>
<h4 id="部署cadvisor采集源">部署<code>cAdvisor</code>采集源</h4>
<ul>
<li>
<ol>
<li><code>Docker</code><!-- raw HTML omitted -->部署<!-- raw HTML omitted --><code>cAdvisor</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><a href="https://grafana.com/grafana/dashboards/893-main/" rel="external" target="_self"><code>Docker and system monitoring Grafana dashboard</code></a></li>
<li><a href="https://grafana.com/grafana/dashboards/10585-docker-dashboard/" rel="external" target="_self"><code>Grafana Docker Dashboard</code></a></li>
<li><a href="https://grafana.com/grafana/dashboards/16314-docker-container-os-node-node-exporter-cadvisor/?tab=revisions" rel="external" target="_self"><code>docker container &amp; OS node(node_exporter, cadvisor)</code></a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ docker run -d --name<span style="color:#f92672">=</span>cadvisor <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -p 8080:8080 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -v /:/rootfs:ro <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -v /var/run:/var/run:rw <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -v /sys:/sys:ro <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -v /var/lib/docker/:/var/lib/docker:ro <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  google/cadvisor:v0.33.0</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->查看指标<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ http://&lt;目标节点IP&gt;:8080/metrics</span></span></code></pre></div></blockquote>
<hr>
<h4 id="数据库服务器部署mysqld_exporter">数据库服务器部署<code>mysqld_exporter</code></h4>
<blockquote>
<ul>
<li><a href="https://grafana.com/grafana/dashboards/17320-1-mysqld-exporter-dashboard-22-11-06/" rel="external" target="_self"><code>1 Mysqld Exporter Dashboard 22/11/06中文版</code></a></li>
</ul>
</blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->二进制安装  <!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /opt <span style="color:#f92672">&amp;&amp;</span> wget https://github.com/prometheus/mysqld_exporter/releases/download/v0.14.0/mysqld_exporter-0.14.0.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>$ tar zxvf mysqld_exporter-0.14.0.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>$ mv mysqld_exporter-0.14.0.linux-amd64 mysqld_exporter  
</span></span><span style="display:flex;"><span>$ chown -R root. mysqld_exporter  </span></span></code></pre></div><ul>
<li><code>mysqld_exporter</code><!-- raw HTML omitted -->需要连接<!-- raw HTML omitted --><code>Mysql</code><!-- raw HTML omitted -->，首先为它创建用户并赋予所需的权限<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#66d9ef">GRANT</span> REPLICATION CLIENT, PROCESS <span style="color:#66d9ef">ON</span> <span style="color:#f92672">*</span>.<span style="color:#f92672">*</span> <span style="color:#66d9ef">TO</span> <span style="color:#e6db74">&#39;exporter&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;localhost&#39;</span> <span style="color:#66d9ef">identified</span> <span style="color:#66d9ef">by</span> <span style="color:#e6db74">&#39;123456&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GRANT</span> <span style="color:#66d9ef">SELECT</span> <span style="color:#66d9ef">ON</span> performance_schema.<span style="color:#f92672">*</span> <span style="color:#66d9ef">TO</span> <span style="color:#e6db74">&#39;exporter&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;localhost&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">flush</span> <span style="color:#66d9ef">privileges</span>;</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->在数据库服务器<!-- raw HTML omitted --><code>mysqld_exporter</code><!-- raw HTML omitted -->目录下创建<!-- raw HTML omitted --><code>.my.cnf</code><!-- raw HTML omitted -->文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/mysqld_exporter/.my.cnf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[client]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">user=mysql_monitor
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">password=mysql_monitor
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->编写启动文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/usr/lib/systemd/system/mysqld_exporter.service <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=mysql_exporter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Documentation=https://prometheus.io/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Type=simple
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/mysqld_exporter/mysqld_exporter --config.my-cnf=/opt/mysqld_exporter/.my.cnf 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->启动服务、以及设置开机自启<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ./mysqld_exporter  --config.my-cnf<span style="color:#f92672">=</span>/opt/mysqld_exporter/.my.cnf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ systemctl enable mysqld_exporter
</span></span><span style="display:flex;"><span>$ systemctl start mysqld_exporter</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->查看启动的服务端口<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ss -unplt|grep mysqld_exporter
</span></span><span style="display:flex;"><span>tcp    LISTEN     <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">128</span>    <span style="color:#f92672">[</span>::<span style="color:#f92672">]</span>:9104               <span style="color:#f92672">[</span>::<span style="color:#f92672">]</span>:*                   users:<span style="color:#f92672">((</span><span style="color:#e6db74">&#34;mysqld_exporter&#34;</span>,pid<span style="color:#f92672">=</span>7339,fd<span style="color:#f92672">=</span>3<span style="color:#f92672">))</span></span></span></code></pre></div></blockquote>
<hr>
<h4 id="部署pushgateway推送网关">部署<code>pushgateway</code>(推送网关)</h4>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->二进制安装  <!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /opt <span style="color:#f92672">&amp;&amp;</span> wget -c https://github.com/prometheus/pushgateway/releases/download/v1.4.3/pushgateway-1.4.3.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>$ tar zxf pushgateway-1.4.3.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>$ mv pushgateway-1.4.3.linux-amd64 pushgateway
</span></span><span style="display:flex;"><span>$ chown root.root pushgateway -R</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->编写启动文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/usr/lib/systemd/system/pushgateway.service <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=pushgateway
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Documentation=https://prometheus.io/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Type=simple
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/pushgateway/pushgateway
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->启动服务、以及设置开机自启<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ nohup ./pushgateway --config.file<span style="color:#f92672">=</span>node_exporter.yml 2&gt;&amp;<span style="color:#ae81ff">1</span> 1&gt;node_exporter.log &amp;  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ systemctl enable pushgateway
</span></span><span style="display:flex;"><span>$ systemctl start pushgateway</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->查看启动的服务端口<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ netstat -lntup |grep push
</span></span><span style="display:flex;"><span>tcp6       <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> :::9091                 :::*                    LISTEN      5982/pushgateway</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_open_falcon">Install_Open_Falcon</h1>

<h2 id="部署open-falcon服务">部署<code>Open Falcon</code>服务</h2>
<h3 id="open-falcon架构"><code>Open-falcon</code>架构</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->介绍<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<p><code>OpenFalcon</code>是一款企业级、高可用、可扩展的开源监控解决方案。此项目最初由小米公司发起，小米运维团队从互联网公司的需求出发，根据多年的运维经验，结合<code>SRE</code>、<code>SA</code>、<code>DEVS</code>的使用经验和反馈，开发的一套面向互联网的企业级开源监控产品，最新版本为<code>v2.0</code>。目前有几十家公司不同程度使用<code>OpenFalcon</code>作为分布式系统的监控解决方案。</p>
</blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->优点<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>采集器自动发现，支持<code>falcon-agent</code>、<code>snmp</code>、支持用户主动push数据、用户自定义插件</li>
<li>支持每个周期上亿次的数据采集、告警判定、历史数据存储和查询</li>
<li>高效的分区、支持监控策略模板、模板继承和覆盖、多种告警方式、支持告警回调</li>
<li>单节点能支持200万<code>metric</code>的上报、归档、存储</li>
<li>其存储采用<code>rrdtool</code>归档，秒级返回上百个<code>metric</code>一年的历史数据</li>
<li>多维度的数据展示，可由用户自定义<code>Screen</code></li>
<li>通过各种插件目前支持<code>Linux</code>、<code>Windows</code>、<code>Mysql</code>、<code>Redis</code>、<code>Memache</code>、<code>RabbitMQ</code>和交换机监控</li>
</ul>
</blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->监控范围<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>OpenFalcon</code>支持系统基础监控，第三方服务监控，<code>JVM</code>监控，业务应用监控</li>
<li>基础监控指<code>Linux</code>平台的系统指标监控，包括<code>CPU</code>、<code>Load</code>、内存、磁盘、<code>IO</code>、网络等，这些指标由<code>OpenFalcon</code>的<code>agent</code>节点直接支持，无需插件</li>
<li><code>JVM</code>监控主要通过插件完成，插件通过<code>JVM</code>开放的<code>JMX</code>通信端口，获取到<code>JVM</code>参数指标，并推送到<code>agent</code>节点，再由<code>agent</code>发送到<code>OpenFalcon</code></li>
<li>第三方服务监控指一些常见服务监控，包括<code>MySQL</code>、<code>Redis</code>、<code>Nginx</code>等，<code>OpenFalcon</code>官网提供了很多第三方服务的监控插件，也可以自己实现插件，定义采集指标。而采集到的指标，也是通过插件先发送给<code>agent</code>，再由agent发送到<code>OpenFalcon</code></li>
<li>业务应用监控主要是监控企业自主开发的应用服务。由企业根据业务需要定义采集指标，自实现插件。将获取到的采集指标发送到<code>agen</code>t，再由<code>agent</code>发送到<code>OpenFalcon</code></li>
</ul>
</blockquote>
<ul>
<li>
<ol start="4">
<li><code>openfalcon</code><!-- raw HTML omitted -->数据流向<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>常见的<code>OpenFalcon</code>包含<code>transfer</code>、<code>hbs</code>、<code>agent</code>、<code>judge</code>、<code>graph</code>、<code>API</code>几个进程。但没有提供用户界面。用户界面的解决方案是<code>OpenFalcon</code>官方提供的<code>Dashboard</code>，由<code>python</code>编写的一个Web服务。<code>Dashboard</code>调用<code>OpenFalcon</code>的<code>API</code>节点<code>REST</code>，完成用户认证，查询历史等操作。</li>
<li>以下是各个节点的数据流向图，主数据流向是<code>agent</code>-&gt;<code>transfer</code>-&gt;<code>judge/graph</code>：</li>
</ul>
<p><a href="#R-image-82bdc1d54e16d76f2fd62ddbb28213ea" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/transfer.jpg" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-82bdc1d54e16d76f2fd62ddbb28213ea"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/transfer.jpg"></a></p>
<p><a href="#R-image-7d7d8c1b2e44c3a512faf34cee833436" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/transfer-1.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-7d7d8c1b2e44c3a512faf34cee833436"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/transfer-1.png"></a></p>
</blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->模块<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<p><a href="#R-image-2e1844c7f7f08e8795401040ba17c540" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/transfer-2.jpg" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-2e1844c7f7f08e8795401040ba17c540"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/transfer-2.jpg"></a></p>
<p><a href="#R-image-d01129951ea2b4b0a086b3f5758f37e0" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/transfer-3.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-d01129951ea2b4b0a086b3f5758f37e0"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/transfer-3.png"></a></p>
<p><a href="#R-image-012807d9a6d17760f47c2d59cfe1974f" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/transfer-4.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-012807d9a6d17760f47c2d59cfe1974f"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/transfer-4.png"></a></p>
</blockquote>
<ul>
<li>
<ol start="6">
<li><!-- raw HTML omitted -->组件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>
<p><code>Agent</code>: 是用于采集被部署机器上的监控数据，每隔<code>60</code>秒<code>push</code>给<code>Transfer</code>模块。<code>agent</code>与<code>Transfer</code>建立的是长连接（毕竟每分钟发送一次，短连接开销太大）。每台要被监控的机器都要部署该模块，它消耗的资源很小，不用太担心这一点。同时<code>agent</code>提供了一个<code>http</code>接口<code>/v1/push</code>用于接收用户手工<code>push</code>的一些数据，然后通过长连接迅速转发给<code>Transfer</code>，在实际使用中，我们对于某些自己项目接口的监控就是通过此方式来进行上传的</p>
</li>
<li>
<p><code>transfer</code>： 是数据转发服务。它接收<code>agent</code>上报的数据，然后按照哈希规则进行数据分片、并将分片后的数据分别<code>push</code>给<code>graph</code>和<code>judge</code>等组件</p>
</li>
<li>
<p><code>graph</code>是存储绘图数据的组件。<code>graph</code>组件接收<code>transfer</code>组件推送上来的监控数据，同时处理<code>query</code>组件的查询请求、返回绘图数据</p>
</li>
<li>
<p><code>query</code>组件，提供统一的绘图数据查询入口。<code>query</code>组件接收查询请求，根据一致性哈希算法去相应的<code>graph</code>实例查询不同监控项的数据，然后汇总拿到的数据，最后统一返回给用户</p>
</li>
<li>
<p><code>dashboard</code>是面向用户的查询界面。在这里，用户可以看到<code>push</code>到<code>graph</code>中的所有数据，并查看其趋势图</p>
</li>
<li>
<p>邮件短信发送模块，这个组件没有代码，需要各个公司自行提供。监控系统产生报警事件之后需要发送报警邮件或者报警短信，各个公司可能有自己的邮件服务器，有自己的邮件发送方法；有自己的短信通道，有自己的短信发送方法。<code>falcon</code>为了适配各个公司，在接入方案上做了一个规范，需要各公司提供<code>http</code>的短信和邮件发送接口</p>
</li>
<li>
<p><code>Sender</code>： 6 中提到各个公司会提供邮件、短信发送接口，但是产生了报警之后就立马调用这些接口发送报警，是不合适的。因为这些接口可能无法处理巨大的并发量，而且接口本身的处理速度可能也比较慢，这会拖慢我们的处理逻辑。所以一个比较好的方式是把邮件、短信发送这个事情做成异步的。<code>Sender</code>提供一个短信<code>redis</code>队列，提供一个邮件<code>redis</code>队列。当有短信要发送的时候，直接将短信内容写入短信<code>redis</code>队列即可，当有邮件要发送的时候，直接将邮件内容写入邮件<code>redis</code>队列。针对每个队列，后面有一个预设大小的<code>worker</code>线程池来处理。有了队列的缓冲，即便某个时刻产生了大量报警，造成邮件、短信发送的突发流量，也不会对邮件、短信发送接口造成冲击</p>
</li>
<li>
<p><code>Fe</code>这是<code>Go</code>版本的<code>UIC</code>，也是一个统一的<code>web</code>入口，因为监控组件众多，记忆<code>ip</code>、<code>port</code>去访问还是比较麻烦。<code>fe</code>像是一个监控的<code>hao123.</code>就是为了用户使用方便配置的一个web浏览器操作界面</p>
</li>
<li>
<p><code>Portal</code>是用来配置报警策略的,和<code>HBS</code>一起描述</p>
</li>
<li>
<p><code>HBS(Heartbeat Server)</code>：</p>
</li>
</ul>
<blockquote>
<ul>
<li><code>Portal</code>的数据库中有一个<code>host</code>表，维护了公司所有机器的信息，比如<code>hostname</code>、<code>ip</code>等等。<code>HBS</code>第一个功能：<code>agent</code>发送心跳信息给<code>HBS</code>的时候，会把<code>hostname</code>、<code>ip</code>、<code>agent</code> <code>version</code>、<code>plugin version</code>等信息告诉<code>HBS</code>，<code>HBS</code>负责更新<code>host</code>表</li>
<li><code>Agent</code>只采集用户配置的监控项。比如用户配置了对某个机器<code>80</code>端口的监控，我们才会去采集这个机器<code>80</code>端口的存活性。那<code>agent</code>如何知道自己应该采集哪些端口和进程呢？向<code>HBS</code>要，<code>HBS</code>去读取<code>Portal</code>的数据库，返回给<code>agent</code></li>
<li><code>Judge</code>需要获取所有的报警策略，让<code>Judge</code>去读取<code>Portal</code>的<code>DB</code>么？不太好。因为<code>Judge</code>的实例数目比较多，如果公司有几十万机器，<code>Judge</code>实例数目可能会是几百个，几百个<code>Judge</code>实例去访问<code>Portal</code>数据库，也是一个比较大的压力。既然<code>HBS</code>无论如何都要访问<code>Portal</code>的数据库了，那就让<code>HBS</code>去获取所有的报警策略缓存在内存里，然后<code>Judge</code>去向<code>HBS</code>请求。这样一来，对<code>Portal DB</code>的压力就会大大减小</li>
</ul>
</blockquote>
<ul>
<li><code>Judge Judge</code>用于告警判断，<code>agent</code>将数据<code>push</code>给<code>Transfer</code>，<code>Transfer</code>不但会转发给<code>Graph</code>组件来绘图，还会转发给<code>Judge</code>用于判断是否触发告警。因为监控系统数据量比较大，一台机器显然是搞不定的，所以必须要有个数据分片方案。<code>Transfer</code>通过一致性哈希来分片，每个<code>Judge</code>就只需要处理一小部分数据就可以了。所以判断告警的功能不能放在直接的数据接收端<code>Transfer</code>，而应该放到<code>Transfer</code>后面的组件里，就有了<code>Judge.</code></li>
<li><code>Links</code>是为报警合并功能写的组件。如果你不想使用报警合并功能，这个组件是无需安装的。一般不会用到</li>
<li><code>alarm</code>模块是处理报警<code>event</code>的，<code>judge</code>产生的报警<code>event</code>写入<code>redis</code>，<code>alarm</code>从<code>redis</code>读取处理，报警<code>event</code>的处理逻辑并非仅仅是发邮件、发短信这么简单。为了能够自动化对<code>event</code>做处理，<code>alarm</code>需要支持在产生<code>event</code>的时候回调用户提供的接口；有的时候报警短信、邮件太多，对于优先级比较低的报警，希望做报警合并，这些逻辑都是在<code>alarm</code>中做的</li>
</ul>
</blockquote>
<ul>
<li>
<ol start="7">
<li><!-- raw HTML omitted -->流程<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>目标服务器运行<code>agent</code></li>
<li><code>agent</code>采集各类监控项数值，传给<code>transfer</code></li>
<li><code>transfer</code>校验和整理监控项数值，做一致性<code>hash</code>分片，传给对应的<code>judge</code>模块以验证是否触发告警</li>
<li><code>transfer</code>整理监控项数值，做一致性<code>hash</code>分片，传输给<code>graph</code>以进行数据的存储</li>
<li><code>judge</code>根据具体报警策略或阈值进行告警判断，如触发告警则组装告警<code>event</code>事件，写入缓存队列</li>
<li><code>alarm</code>和<code>sender</code>根据<code>event</code>事件中的判定结果，执行<code>event</code>，像用户组发送短信或邮件</li>
<li><code>graph</code>收到监控项数据后，将数据存储成<code>RRD</code>文件格式，进行归档，并提供查询接口</li>
<li><code>query</code>将调用<code>graph</code>的查询接口，将监控数据传送到<code>dashboard</code>以进行页面展示</li>
<li><code>dashboard</code>则渲染页面，展示曲线报表图等</li>
<li><code>portal</code>提供页面供用户配置机器分组、报警策略、表达式、<code>nodata</code>等配置</li>
</ul>
</blockquote>
<hr>
<h3 id="open-falcon部署"><code>Open-falcon</code>部署</h3>
<blockquote>
<ul>
<li><code>Open-Falcon</code><!-- raw HTML omitted -->为前后端分离的架构，包含<!-- raw HTML omitted --><code>backend</code><!-- raw HTML omitted -->和<!-- raw HTML omitted --><code>frontend</code><!-- raw HTML omitted -->两部分<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->前端(客户端)和后端(服务端)<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->环境准备<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>redis</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum install -y redis
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动</span>
</span></span><span style="display:flex;"><span>$ redis-server &amp;</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->装<!-- raw HTML omitted --><code>mysql</code></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->解压到<!-- raw HTML omitted --><code>/usr/local</code><!-- raw HTML omitted -->目录<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget http://ftp.iij.ad.jp/pub/db/mysql/Downloads/MySQL-5.7/mysql-5.7.22-linux-glibc2.12-x86_64.tar.gz</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->移动至该目录<!-- raw HTML omitted --><code>cd /usr/local/mysql</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mv mysql-5.7.22-linux-glibc2.12-x86_64 /usr/local/mysql</span></span></code></pre></div><ul>
<li><code>rpm -qa | grep mariadb</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rpm -e mariadb-libs –nodeps</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->创建数据库目录<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir data</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->创建<!-- raw HTML omitted --><code>mysql</code><!-- raw HTML omitted -->系统组和系统用户并不建立家目录<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ groupadd -r mysql <span style="color:#f92672">&amp;&amp;</span> useradd -r -g mysql -s /bin/false -M mysql</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->授权给<!-- raw HTML omitted --><code>mysql</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ chown -R mysql:mysql .</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->做个软链接<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ln -s /usr/local/mysql/bin/* /usr/local/bin</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->编写主配置文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/my.cnf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[mysqld]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">basedir=/usr/local/mysql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">datadir=/usr/local/mysql/data
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">pid-file=/usr/local/mysql/data/mysqld.pid
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">socket=/usr/local/mysql/mysql.sock
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">log-error=/usr/local/mysql/data/mysql.err
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[client]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">socket=/usr/local/mysql/mysql.sock
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->初始化数据库<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mysqld --initialize --user<span style="color:#f92672">=</span>mysql --basedir<span style="color:#f92672">=</span>/usr/local/mysql --datadir<span style="color:#f92672">=</span>/usr/local/mysql/data</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->移动至<!-- raw HTML omitted --><code>support-files</code><!-- raw HTML omitted -->目录下<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd support-files</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->复制启动服务至<!-- raw HTML omitted --><code>/etc/init.d/mysqld</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cp mysql.server /etc/init.d/mysqld</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->启动<!-- raw HTML omitted --><code>mysql</code><!-- raw HTML omitted -->服务<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /etc/init.d/mysqld start</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->找密码<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat /usr/local/mysql/data/mysql.err</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->登录<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mysql -uroot -p<span style="color:#e6db74">&#39;密码&#39;</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改密码<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ alter user root@localhost identified by <span style="color:#e6db74">&#39;123&#39;</span>;</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->初始化<!-- raw HTML omitted --><code>mysql</code><!-- raw HTML omitted -->表结构<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /tmp/ <span style="color:#f92672">&amp;&amp;</span> git clone https://github.com/open-falcon/falcon-plus.git 
</span></span><span style="display:flex;"><span>$ cd /tmp/falcon-plus/scripts/mysql/db_schema/
</span></span><span style="display:flex;"><span>$ mysql -h 127.0.0.1 -u root -p &lt; 1_uic-db-schema.sql
</span></span><span style="display:flex;"><span>$ mysql -h 127.0.0.1 -u root -p &lt; 2_portal-db-schema.sql
</span></span><span style="display:flex;"><span>$ mysql -h 127.0.0.1 -u root -p &lt; 3_dashboard-db-schema.sql
</span></span><span style="display:flex;"><span>$ mysql -h 127.0.0.1 -u root -p &lt; 4_graph-db-schema.sql
</span></span><span style="display:flex;"><span>$ mysql -h 127.0.0.1 -u root -p &lt; 5_alarms-db-schema.sql
</span></span><span style="display:flex;"><span>$ rm -rf /tmp/falcon-plus/</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>Go</code><!-- raw HTML omitted -->语言开发环境(需要<code>epel</code>源)<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum install golang -y</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->查看<!-- raw HTML omitted --><code>go</code><!-- raw HTML omitted -->的安装路径<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ find / -name go</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->设置环境变量<!-- raw HTML omitted --><code>GOROOT</code>和<code>GOPATH</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ export GOROOT<span style="color:#f92672">=</span>/usr/lib/golang
</span></span><span style="display:flex;"><span>$ export GOPATH<span style="color:#f92672">=</span>/home</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->下载编译好的二进制版本<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget https://github.com/open-falcon/falcon-plus/releases/download/v0.2.1/open-falcon-v0.2.1.tar.gz</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->启动后端<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->创建工作目录<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ export FALCON_HOME<span style="color:#f92672">=</span>/home/work
</span></span><span style="display:flex;"><span>$ export WORKSPACE<span style="color:#f92672">=</span>$FALCON_HOME/open-falcon
</span></span><span style="display:flex;"><span>$ mkdir -p $WORKSPACE</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->解压二进制包<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ tar -xzvf open-falcon-v0.2.1.tar.gz -C $WORKSPACE</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->在一台机器上启动所有的后端组件<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>
<p><!-- raw HTML omitted -->修改配置文件<!-- raw HTML omitted --><code>cfg.json</code></p>
<p>部分模块依赖连接数据库，因为如果不修改配置文件，<code>aggregator</code>模块会出现无法启动，<code>graph</code>、<code>hbs</code>、<code>nodata</code>、<code>api</code>、<code>alarm</code>模块会出现开启不报错但是状态为开启失败的情况。</p>
<p>如果需要每个模块都能正常启动，需要将上面模块的<code>cfg.json</code>的数据库信息进行修改，需要修改配置文件所在的目录</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>模块</th>
<th>配置文件所在路径</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>aggregator</code></td>
<td><code>/home/work/aggregator/config/cfg.json</code></td>
</tr>
<tr>
<td><code>graph</code></td>
<td><code>/home/work/graph/config/cfg.json</code></td>
</tr>
<tr>
<td><code>hbs</code></td>
<td><code>/home/work/hbs/config/cfg.json</code></td>
</tr>
<tr>
<td><code>nodata</code></td>
<td><code>/home/work/nodata/config/cfg.json</code></td>
</tr>
<tr>
<td><code>api</code></td>
<td><code>/home/work/api/config/cfg.json</code></td>
</tr>
<tr>
<td><code>alarm</code></td>
<td><code>/home/work/alarm/config/cfg.json</code></td>
</tr>
</tbody>
</table>
<ul>
<li><!-- raw HTML omitted -->启动<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd $WORKSPACE
</span></span><span style="display:flex;"><span>$ ./open-falcon start
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 检查所有模块的启动状况</span>
</span></span><span style="display:flex;"><span>$ ./open-falcon check</span></span></code></pre></div></blockquote>
</blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->安装前端<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->创建工作目录<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ export HOME<span style="color:#f92672">=</span>/home/work
</span></span><span style="display:flex;"><span>$ export WORKSPACE<span style="color:#f92672">=</span>$HOME/open-falcon
</span></span><span style="display:flex;"><span>$ mkdir -p $WORKSPACE
</span></span><span style="display:flex;"><span>$ cd $WORKSPACE</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->克隆前端组件<!-- raw HTML omitted --><code>diamante</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd $WORKSPACE
</span></span><span style="display:flex;"><span>$ git clone https://github.com/open-falcon/dashboard.git</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->安装依赖包<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum install -y python-virtualenv
</span></span><span style="display:flex;"><span>$ yum install -y python-devel
</span></span><span style="display:flex;"><span>$ yum install -y openldap-devel
</span></span><span style="display:flex;"><span>$ yum install -y mysql-devel
</span></span><span style="display:flex;"><span>$ yum groupinstall <span style="color:#e6db74">&#34;Development tools&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cd $WORKSPACE/dashboard/
</span></span><span style="display:flex;"><span>$ virtualenv ./env
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ./env/bin/pip install -r pip_requirements.txt -i https://pypi.douban.com/simple</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改配置<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>dashboard的配置文件为： <span style="color:#e6db74">&#39;rrd/config.py&#39;</span>，请根据实际情况修改
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># API_ADDR 表示后端api组件的地址</span>
</span></span><span style="display:flex;"><span>API_ADDR <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://127.0.0.1:8080/api/v1&#34;</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 根据实际情况，修改PORTAL_DB_*, 默认用户名为root，默认密码为&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 根据实际情况，修改ALARM_DB_*, 默认用户名为root，默认密码为&#34;&#34;</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->在生产环境启动<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ bash control start
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 停止</span>
</span></span><span style="display:flex;"><span>$ bash control stop
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看日志</span>
</span></span><span style="display:flex;"><span>$ Bash control tail</span></span></code></pre></div><ul>
<li><code>dashboard</code><!-- raw HTML omitted -->用户管理<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0"><code>dashbord没有默认创建任何账号包括管理账号，需要你通过页面进行注册账号。
想拥有管理全局的超级管理员账号，需要手动注册用户名为root的账号（第一个帐号名称为root的用户会被自动设置为超级管理员）。
超级管理员可以给普通用户分配权限管理。

小提示：注册账号能够被任何打开dashboard页面的人注册，所以当给相关的人注册完账号后，需要去关闭注册账号功能。只需要去修改api组件的配置文件cfg.json，将signup_disable配置项修改为true，重启api即可。当需要给人开账号的时候，再将配置选项改回去，用完再关掉即可。</code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->被监控端配置<!-- raw HTML omitted --><code>agent</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>agent</code><!-- raw HTML omitted -->需要部署到所有要被监控的机器上，比如公司有10万台机器，那就要部署10万个<!-- raw HTML omitted --><code>agent</code>。<code>agent</code><!-- raw HTML omitted -->本身资源消耗很少，不用担心<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->配置说明：配置文件必须叫<!-- raw HTML omitted --><code>cfg.json</code><!-- raw HTML omitted -->，可以基于<!-- raw HTML omitted --><code>cfg.example.json</code><!-- raw HTML omitted -->修改<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;debug&#34;</span>: true,  	<span style="color:#75715e"># 控制一些debug信息的输出，生产环境通常设置为false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;hostname&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,  	<span style="color:#75715e"># agent采集了数据发给transfer，endpoint就设置为了hostname，默认通过`hostname`获取，如果配置中配置了hostname，就用配置中的</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;ip&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#75715e"># agent与hbs心跳的时候会把自己的ip地址发给hbs，agent会自动探测本机ip，如果不想让agent自动探测，可以手工修改该配置</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;plugin&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;enabled&#34;</span>: false,  	<span style="color:#75715e"># 默认不开启插件机制</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;dir&#34;</span>: <span style="color:#e6db74">&#34;./plugin&#34;</span>,  	<span style="color:#75715e"># 把放置插件脚本的git repo clone到这个目录</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;git&#34;</span>: <span style="color:#e6db74">&#34;https://github.com/open-falcon/plugin.git&#34;</span>, <span style="color:#75715e"># 放置插件脚本的git repo地址</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;logs&#34;</span>: <span style="color:#e6db74">&#34;./logs&#34;</span>  	<span style="color:#75715e"># 插件执行的log，如果插件执行有问题，可以去这个目录看log</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;heartbeat&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;enabled&#34;</span>: true,  	<span style="color:#75715e"># 此处enabled要设置为true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;addr&#34;</span>: <span style="color:#e6db74">&#34;127.0.0.1:6030&#34;</span>, <span style="color:#75715e"># hbs的地址，端口是hbs的rpc端口</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;interval&#34;</span>: 60,  	<span style="color:#75715e"># 心跳周期，单位是秒</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;timeout&#34;</span>: <span style="color:#ae81ff">1000</span>  	<span style="color:#75715e"># 连接hbs的超时时间，单位是毫秒</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;transfer&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;enabled&#34;</span>: true, 
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;addrs&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;127.0.0.1:18433&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">]</span>,  	<span style="color:#75715e"># transfer的地址，端口是transfer的rpc端口, 可以支持写多个transfer的地址，agent会保证HA</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;interval&#34;</span>: 60,  	<span style="color:#75715e"># 采集周期，单位是秒，即agent一分钟采集一次数据发给transfer</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;timeout&#34;</span>: <span style="color:#ae81ff">1000</span>  	<span style="color:#75715e"># 连接transfer的超时时间，单位是毫秒</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;http&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;enabled&#34;</span>: true,  	<span style="color:#75715e"># 是否要监听http端口</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;listen&#34;</span>: <span style="color:#e6db74">&#34;:1988&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;backdoor&#34;</span>: false
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;collector&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;ifacePrefix&#34;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;eth&#34;</span>, <span style="color:#e6db74">&#34;em&#34;</span><span style="color:#f92672">]</span>,  	<span style="color:#75715e"># 默认配置只会采集网卡名称前缀是eth、em的网卡流量，配置为空就会采集所有的，lo的也会采集。可以从/proc/net/dev看到各个网卡的流量信息</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;mountPoint&#34;</span>: <span style="color:#f92672">[]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;default_tags&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;ignore&#34;</span>: <span style="color:#f92672">{</span>  	<span style="color:#75715e"># 默认采集了200多个metric，可以通过ignore设置为不采集</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;cpu.busy&#34;</span>: true,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;df.bytes.free&#34;</span>: true,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;df.bytes.total&#34;</span>: true,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;df.bytes.used&#34;</span>: true,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;df.bytes.used.percent&#34;</span>: true,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;df.inodes.total&#34;</span>: true,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;df.inodes.free&#34;</span>: true,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;df.inodes.used&#34;</span>: true,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;df.inodes.used.percent&#34;</span>: true,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;mem.memtotal&#34;</span>: true,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;mem.memused&#34;</span>: true,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;mem.memused.percent&#34;</span>: true,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;mem.memfree&#34;</span>: true,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;mem.swaptotal&#34;</span>: true,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;mem.swapused&#34;</span>: true,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;mem.swapfree&#34;</span>: true
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->进程管理<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ./open-falcon start agent  	<span style="color:#75715e"># 启动进程</span>
</span></span><span style="display:flex;"><span>$ ./open-falcon stop agent  	<span style="color:#75715e"># 停止进程</span>
</span></span><span style="display:flex;"><span>$ ./open-falcon monitor agent  	<span style="color:#75715e"># 查看日志</span></span></span></code></pre></div><ul>
<li>
<p><!-- raw HTML omitted -->验证<!-- raw HTML omitted --></p>
<p>看<code>var</code>目录下的<code>log</code>是否正常，或者浏览器访问其<code>1988</code>端口。另外<code>agent</code>提供了一个<code>--check</code>参数，可以检查<code>agent</code>是否可以正常跑在当前机器上</p>
</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ./falcon-agent --check</span></span></code></pre></div><ul>
<li>
<p><code>/v1/push</code><!-- raw HTML omitted -->接口<!-- raw HTML omitted --></p>
<p>设计初衷是不希望用户直接连到<code>Transfer</code>发送数据，而是通过<code>agent</code>的<code>/v1/push</code>接口转发，接口使用范例：</p>
</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ts<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>date +%s<span style="color:#e6db74">`</span>; curl -X POST -d <span style="color:#e6db74">&#34;[{\&#34;metric\&#34;: \&#34;metric.demo\&#34;, \&#34;endpoint\&#34;: \&#34;qd-open-falcon-judge01.hd\&#34;, \&#34;timestamp\&#34;: </span>$ts<span style="color:#e6db74">,\&#34;step\&#34;: 60,\&#34;value\&#34;: 9,\&#34;counterType\&#34;: \&#34;GAUGE\&#34;,\&#34;tags\&#34;: \&#34;project=falcon,module=judge\&#34;}]&#34;</span> http://127.0.0.1:1988/v1/push</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_nightingale">Install_Nightingale</h1>

<h2 id="nightingale部署"><code>Nightingale</code>部署</h2>
<blockquote>
<ul>
<li><a href="https://github.com/ccfos/nightingale" rel="external" target="_self"><code>Nightingale</code></a></li>
</ul>
</blockquote>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_grafana">Install_Grafana</h1>

<h2 id="部署grafana">部署<code>Grafana</code></h2>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://grafana.com/grafana/download?platform=linux" rel="external" target="_self"><code>Download Grafana</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://grafana.com/grafana/download?pg=graf-deployment-options&plcmt=deploy-box-1" rel="external" target="_self"><code>Download Grafana</code></a></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>
<ol>
<li><code>Docker</code><!-- raw HTML omitted -->安装<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ docker run -d --name<span style="color:#f92672">=</span>grafana -p 3000:3000 grafana/grafana-enterprise</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><code>tar.gz</code><!-- raw HTML omitted -->二进制包安装<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget https://dl.grafana.com/enterprise/release/grafana-enterprise-9.4.7.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>$ tar -zxvf grafana-enterprise-9.4.7.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>$ mv grafana-enterprise-9.4.7 /opt/apps/grafana
</span></span><span style="display:flex;"><span>$ /opt/apps/grafana/bin/grafana-server</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><code>rpm</code><!-- raw HTML omitted -->安装<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget https://dl.grafana.com/enterprise/release/grafana-enterprise-9.3.0-1.x86_64.rpm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ yum localinstall grafana-6.3.3-1.x86_64.rpm -y</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->设置开机自启：<!-- raw HTML omitted --><code>web</code><!-- raw HTML omitted -->页面<!-- raw HTML omitted --><code>3000</code><!-- raw HTML omitted -->登录信息：<!-- raw HTML omitted --><strong><code>admin/admin</code></strong></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl enable grafana-server.service
</span></span><span style="display:flex;"><span>$ systemctl start grafana-server.service</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->安装插件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ grafana-cli plugins install grafana-piechart-panel
</span></span><span style="display:flex;"><span>$ systemctl restart grafana-server</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="configure_zabbix">Configure_Zabbix</h1>

<h2 id="配置zabbix-job">配置<code>Zabbix Job</code></h2>
<ul>
<li>
<ol>
<li><code>Zabbix-Agen</code><!-- raw HTML omitted -->测试服务端<!-- raw HTML omitted -->、<a href="https://www.cnblogs.com/zhuochong/p/10361947.html" rel="external" target="_self"><code>Zabbix</code>监控配置</a></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted --><code>abbix_get</code>：<code>-s</code>：客户端地址，<code>-p</code>：客户端端口，<code>-k</code>：键值<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ bin/zabbix_get -s <span style="color:#e6db74">&#34;zabbix_agent IP&#34;</span> -k agent.ping -p <span style="color:#ae81ff">10050</span> <span style="color:#75715e"># get value</span>
</span></span><span style="display:flex;"><span>$ cp /usr/share/fonts/wqy-microhei/wqy-microhei.ttc nginx/html/zabbix/fonts/DejaVuSans.ttf</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->压力测试<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ab -c <span style="color:#ae81ff">10</span> -n <span style="color:#ae81ff">1000000</span> http://192.168.56.11:8080/</span></span></code></pre></div></blockquote>
<hr>
<h3 id="配置zabbix用户">配置<code>Zabbix</code>用户</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->创建配置用户<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<p><a href="#R-image-9f849c0817100efd3cf720a97595e6c3" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server_Job/Snipaste_2023-04-03_18-28-48.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-9f849c0817100efd3cf720a97595e6c3"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server_Job/Snipaste_2023-04-03_18-28-48.png"></a></p>
<p><a href="#R-image-101a97f38b4a02e035ebe95234d170d9" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server_Job/Snipaste_2023-04-03_18-34-55.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-101a97f38b4a02e035ebe95234d170d9"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server_Job/Snipaste_2023-04-03_18-34-55.png"></a></p>
</blockquote>
<hr>
<h3 id="创建主机或者主机组">创建主机或者主机组</h3>
<blockquote>
<p><a href="#R-image-af4e79e683acd6c37c1a1d8d835d963d" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server_Job/host_groups_redis.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-af4e79e683acd6c37c1a1d8d835d963d"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server_Job/host_groups_redis.png"></a></p>
<p><a href="#R-image-fb2091b40c270db12d29fb7330be3d3d" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server_Job/host_groups_web.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-fb2091b40c270db12d29fb7330be3d3d"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server_Job/host_groups_web.png"></a></p>
<p><a href="#R-image-8099c2fe988def0cb529033125d968e1" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server_Job/Snipaste_2023-04-03_18-38-06.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-8099c2fe988def0cb529033125d968e1"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server_Job/Snipaste_2023-04-03_18-38-06.png"></a></p>
<p><a href="#R-image-5a73736b2b338efe0c47d8d8fb75d37a" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server_Job/Snipaste_2023-04-03_18-43-33.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-5a73736b2b338efe0c47d8d8fb75d37a"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server_Job/Snipaste_2023-04-03_18-43-33.png"></a></p>
</blockquote>
<hr>
<h3 id="配置zabbix监控端口告警">配置<code>Zabbix</code>监控端口告警</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->监控端口<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->创建、配置监控项<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<p><a href="#R-image-55d43fd960eddfa4987ecb6079f6f9b1" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server_Job/Snipaste_2023-04-04_13-26-45.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-55d43fd960eddfa4987ecb6079f6f9b1"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server_Job/Snipaste_2023-04-04_13-26-45.png"></a></p>
<p><a href="#R-image-acfc78a1bd89834331edfb07e45fad61" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server_Job/Snipaste_2023-04-04_13-28-55.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-acfc78a1bd89834331edfb07e45fad61"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server_Job/Snipaste_2023-04-04_13-28-55.png"></a></p>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->创建、配置触发器<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<p><a href="#R-image-b729cd1278f74a957d0dd08621ba37c4" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server_Job/Snipaste_2023-04-04_13-30-18.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-b729cd1278f74a957d0dd08621ba37c4"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server_Job/Snipaste_2023-04-04_13-30-18.png"></a></p>
<p><a href="#R-image-aee38248d81cb3e133e028593a85089a" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server_Job/Snipaste_2023-04-04_13-31-54.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-aee38248d81cb3e133e028593a85089a"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server_Job/Snipaste_2023-04-04_13-31-54.png"></a></p>
</blockquote>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="configure_zabbix_grafana">Configure_Zabbix_Grafana</h1>

<h2 id="配置zabbixgrafana监控展示">配置<code>Zabbix+Grafana</code>监控展示</h2>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://www.zabbix.com/cn/integrations/grafana" rel="external" target="_self"><code>Zabbix+Grafana</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://grafana.com/grafana/dashboards/?plcmt=footer&dataSource=alexanderzobnin-zabbix-datasource" rel="external" target="_self"><code>Grafana Dashboards</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://blog.csdn.net/sinat_33622098/article/details/116007072" rel="external" target="_self"><code>Grafana</code>之<code>telegram</code>报警配置</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/starsliao/ConsulManager" rel="external" target="_self"><code>ConsulManager</code>实现<code>Prometheus</code>监控目标</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://grafana.com/grafana/dashboards/9965-1-blackbox-exporter-dashboard-20220412/" rel="external" target="_self"><code>Blackbox Exporter Dashboard 2022/04/12</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://grafana.com/grafana/dashboards/8919-1-node-exporter-for-prometheus-dashboard-cn-0413-consulmanager/" rel="external" target="_self"><code>1 Node Exporter Dashboard 22/04/13 ConsulManager</code>自动同步版</a></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>Grafana</code><!-- raw HTML omitted -->中文界面<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/apps/grafana/conf/defaults.ini<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">default_language = en-US  	# 修改为：default_language = zh-CN
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ grafana-cli plugins install grafana-zh-cn-panel</span></span></code></pre></div></blockquote>
<ul>
<li><code>Grafana</code><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><a href="https://grafana.com/grafana/plugins/alexanderzobnin-zabbix-app/?tab=installation" rel="external" target="_self"><code>Zabbix</code>插件</a><!-- raw HTML omitted -->到指定目录<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>--pluginsDir=</code><!-- raw HTML omitted -->指定插件安装目录<!-- raw HTML omitted --></li>
<li><code>alexanderzobnin-zabbix-app</code><!-- raw HTML omitted -->要安装的插件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /opt/apps/grafana/bin/grafana-cli --pluginsDir<span style="color:#f92672">=</span>/opt/apps/grafana/data/plugins plugins install alexanderzobnin-zabbix-app</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->安装<a href="https://grafana.com/grafana/plugins/grafana-image-renderer/?tab=installation" rel="external" target="_self"><code>Grafana Image Renderer</code></a>图像插件<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /opt/apps/grafana/bin/grafana-cli --pluginsDir<span style="color:#f92672">=</span>/opt/apps/grafana/data/plugins plugins install grafana-image-renderer</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->启用图片发送参数<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/apps/grafana/conf/defaults.ini<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">capture = false  	# 修改为：true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">upload_external_image_storage = false  	# 修改为：true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li><code>Grafana</code><!-- raw HTML omitted -->页面配置<!-- raw HTML omitted --><code>Zabbix</code><!-- raw HTML omitted -->数据源<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<p><a href="#R-image-8033a6ccebea8b07abd6aacf605b117e" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Grafana_Server/Snipaste_2023-04-04_20-04-35.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-8033a6ccebea8b07abd6aacf605b117e"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Grafana_Server/Snipaste_2023-04-04_20-04-35.png"></a></p>
<p><a href="#R-image-13d3133184585802f97280b4eca6d603" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Grafana_Server/Snipaste_2023-04-04_20-02-57.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-13d3133184585802f97280b4eca6d603"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Grafana_Server/Snipaste_2023-04-04_20-02-57.png"></a></p>
<p><a href="#R-image-31def027bf9ec7b4b22282cbb57b2d86" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Grafana_Server/Snipaste_2023-04-04_20-05-53.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-31def027bf9ec7b4b22282cbb57b2d86"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Grafana_Server/Snipaste_2023-04-04_20-05-53.png"></a></p>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>Zabbix</code><!-- raw HTML omitted -->数据源创建<!-- raw HTML omitted --><code>Grafana</code><!-- raw HTML omitted -->仪表盘<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<p><a href="#R-image-789d9d04ff43c9dd70f9116406f7630d" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Grafana_Server/Snipaste_2023-04-04_20-18-40.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-789d9d04ff43c9dd70f9116406f7630d"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Grafana_Server/Snipaste_2023-04-04_20-18-40.png"></a></p>
</blockquote>
<ul>
<li><code>Grafana</code><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>Telegram</code><!-- raw HTML omitted -->告警<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<p><a href="#R-image-8f715af80942b09023eeb5753fd98e33" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server_Telegram/Snipaste_2023-04-04_20-40-56.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-8f715af80942b09023eeb5753fd98e33"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server_Telegram/Snipaste_2023-04-04_20-40-56.png"></a></p>
<p><a href="#R-image-782d7724d0a2c2b8295f25c4268e7465" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server_Telegram/Snipaste_2023-04-04_21-09-21.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-782d7724d0a2c2b8295f25c4268e7465"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Zabbix_Server_Telegram/Snipaste_2023-04-04_21-09-21.png"></a></p>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="configure_prometheus">Configure_Prometheus</h1>

<h2 id="配置prometheus">配置<code>Prometheus</code></h2>
<h3 id="prometheus的yaml文件编写"><code>Prometheus</code>的<code>yaml</code>文件编写</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/prometheus/prometheus.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># my global config
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">global:  	# 全局配置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">scrape_interval:     15s # 默认情况下，每15s拉取一次目标采样点数据
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># scrape_timeout is set to the global default (10s).
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># Alertmanager configuration
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">alerting:  	# 报警配置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">alertmanagers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - static_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - targets:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      # - alertmanager:9093
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#remote_write:  	# 用于远程存储写配置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#remote_read:  	# 用于远程读配置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># Load rules once and periodically evaluate them according to the global &#39;evaluation_interval&#39;.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rule_files:  	# 规则配置，主要是配置：报警规则
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # - &#34;rules/*.yml&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # - &#34;first_rules.yml&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # - &#34;second_rules.yml&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># A scrape configuration containing exactly one endpoint to scrape:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># Here it&#39;s Prometheus itself.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">scrape_configs:  	# 抓取配置，主要配置抓取客户端相关
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - job_name: &#39;prometheus&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # metrics_path defaults to &#39;/metrics&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # scheme defaults to &#39;http&#39;.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    static_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - targets: [&#39;localhost:9090&#39;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - job_name: &#39;node&#39;  	# 任务名，使用node_export插件获取服务器监控数据
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    static_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - targets:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &#39;localhost:9100&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &#39;swoft_1:9100&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &#39;swoft_2:9100&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &#39;175_web:9100&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &#39;176_web:9100&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &#39;177_admin:9100&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &#39;mysql_redis_0:9100&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &#39;mysql_redis_1:9100&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &#39;mysql_redis_2:9100&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &#39;mysql_redis_3:9100&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - job_name: &#39;mysql&#39;  	# 使用mysqld_exporter插件获取Mysql监控数据
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    static_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - targets:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &#39;mysql_redis_0:9104&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &#39;mysql_redis_1:9104&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &#39;mysql_redis_2:9104&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &#39;mysql_redis_3:9104&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - job_name: &#39;container&#39;  	# 使用cAdvisor 获取到的容器监控数据
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    static_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - targets: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &#39;&lt;节点01的IP&gt;:8080&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &#39;&lt;节点02的IP&gt;:8080&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="配置prometheus-web页面">配置<code>Prometheus web</code>页面</h3>
<blockquote>
<ul>
<li>
<p><!-- raw HTML omitted -->浏览器访问：<!-- raw HTML omitted --><code>IP:9090</code></p>
</li>
<li>
<p><code>shell</code><!-- raw HTML omitted -->命令创建<!-- raw HTML omitted --></p>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;some_metric 3.14&#34;</span> | curl --data-binary @- http://localhost:9091/metrics/job/some_job</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->发送复杂数据<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat <span style="color:#e6db74">&lt;&lt;EOF | curl --data-binary @- http://localhost:9091/metrics/job/some_job/instance/some_instance
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># TYPE some_metric counter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">some_metric{label=&#34;val1&#34;} 42
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># TYPE another_metric gauge
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># HELP another_metric Just an example.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">another_metric 2398.283
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->添加数据源<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>
<p><!-- raw HTML omitted -->添加<!-- raw HTML omitted --><code>prometheus</code><!-- raw HTML omitted -->，填写<!-- raw HTML omitted --><code>prometheus</code><!-- raw HTML omitted -->的管理地址<!-- raw HTML omitted --></p>
</li>
<li>
<p><!-- raw HTML omitted -->导入<!-- raw HTML omitted --><code>dashboard</code></p>
</li>
<li>
<p><!-- raw HTML omitted -->通过<!-- raw HTML omitted --><a href="https://grafana.com/grafana/dashboards" rel="external" target="_self"><code>grafana</code>官网</a><!-- raw HTML omitted -->仪表盘添加对应仪表盘<!-- raw HTML omitted --></p>
</li>
<li>
<p><!-- raw HTML omitted -->常用仪表盘<!-- raw HTML omitted --></p>
</li>
</ul>
</blockquote>
</blockquote>
<hr>
<h3 id="配置grafana">配置<code>grafana</code></h3>
<blockquote>
<ul>
<li><code>grafana</code><!-- raw HTML omitted -->告警邮件配置<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>grafana</code><!-- raw HTML omitted -->配置文件，添加<!-- raw HTML omitted --><code>Email</code><!-- raw HTML omitted -->配置<!-- raw HTML omitted --></li>
<li><a href="https://grafana.com/grafana/dashboards/" rel="external" target="_self"><code>Grafana Dashboards</code></a></li>
<li><a href="https://github.com/starsliao/ConsulManager" rel="external" target="_self"><code>ConsulManager</code></a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/grafana/grafana.ini<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[smtp]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">enabled = true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">host = smtp.163.com:465
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">user = 18329903316
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># If the password contains # or ; you have to wrap it with trippel quotes. Ex &#34;&#34;&#34;#password;&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">password = xxxxxxxxxxxx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">;cert_file =
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">;key_file =
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">;skip_verify = false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">from_address = 18329903316@163.com
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">;from_name = Grafana
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">;ehlo_identity = dashboard.exmple.com
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li><code>grafana web</code><!-- raw HTML omitted -->界面配置<!-- raw HTML omitted --><code>Notification channels</code></li>
</ul>
<blockquote>
</blockquote>
<ul>
<li><code>alter</code><!-- raw HTML omitted -->配置<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->⚠️：<!-- raw HTML omitted --><code>Template variables are not supported in alert queries</code><!-- raw HTML omitted -->在查询中不能使用模版语法，不然无法创建告警<!-- raw HTML omitted --></li>
</ul>
</blockquote>
</blockquote>
<hr>
<h3 id="配置prometheus监控nginx">配置<code>Prometheus</code>监控<code>Nginx</code></h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->下载<!-- raw HTML omitted --><code>Nginx</code><!-- raw HTML omitted -->监控插件<!-- raw HTML omitted --><code>nginx-module-vts</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git clone git://github.com/vozlt/nginx-module-vts.git </span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->重新编译<!-- raw HTML omitted --><code>Nginx</code><!-- raw HTML omitted -->支持插件<!-- raw HTML omitted --><code>nginx-module-vts</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ./configure --prefix<span style="color:#f92672">=</span>/usr/local/nginx-1.12.2 --user<span style="color:#f92672">=</span>nginx --group<span style="color:#f92672">=</span>nginx --with-http_stub_status_module  --with-http_ssl_module &gt; --add-module<span style="color:#f92672">=</span>/usr/local/nginx-module-vts
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ make</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->拷贝重新编译后的<!-- raw HTML omitted --><code>Nginx</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ nginx -s stop
</span></span><span style="display:flex;"><span>$ <span style="color:#ae81ff">\c</span>p ./objs/nginx /usr/local/nginx/sbin/</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>Nginx</code><!-- raw HTML omitted -->主配置文件<!-- raw HTML omitted --><code>nginx.conf</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;nginx.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">http {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.....
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">### Prometheus 配置   
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">vhost_traffic_status_zone;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">vhost_traffic_status_filter_by_host on;  	# 打开vhost过滤
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">### Prometheus 配置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.....
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">server {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">location /status {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         # vhost_traffic_status off;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         vhost_traffic_status_display;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         vhost_traffic_status_display_format html;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->下载<!-- raw HTML omitted --><code>nginx-vts-exporter</code><!-- raw HTML omitted -->监控插件<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /opt <span style="color:#f92672">&amp;&amp;</span> wget -c https://github.com/hnlq715/nginx-vts-exporter/releases/download/&gt; v0.10.3/nginx-vts-exporter-0.10.3.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>$ tar xf nginx-vts-exporter-0.10.3.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>./nginx-vts-exporter -nginx.scrape_timeout <span style="color:#ae81ff">10</span> -nginx.scrape_uri 
</span></span><span style="display:flex;"><span>http://10.10.16.107/status/format/json &amp;  	<span style="color:#75715e"># 启动nginx Vhost Traffic</span>
</span></span><span style="display:flex;"><span>http://10.10.16.107/status  	<span style="color:#75715e"># 访问nginx主机各节点状态</span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="配置alertmanager告警">配置<code>Alertmanager</code>告警</h3>
<ul>
<li><!-- raw HTML omitted -->告警规则<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><a href="https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/" rel="external" target="_self"><code>ALERTING RULES</code></a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;rules/general.yml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">groups:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- name: general.rules  	# 报警规则组名称
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  rules:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # 任何实例5分钟内无法访问发出告警
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - alert: InstanceDown
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    expr: up == 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    for: 5m  	# 持续时间 ， 表示持续一分钟获取不到信息，则触发报警
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      severity: page  # 自定义标签 error
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    annotations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      summary: &#34;Instance {{ $labels.instance }} 停止工作 down&#34;  	# 自定义摘要
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      description: &#34;{{ $labels.instance }} of job {{ $labels.job }} 已经停止5分钟以上 has been down for more than 5 minutes.&#34;  	# 自定义具体描述
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;rules/node.yml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">groups:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- name: node.rules
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  rules:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - alert: NodeFilesystemUsage
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    expr: 100 - (node_filesystem_free_bytes{fstype=~&#34;ext4|xfs&#34;} / node_filesystem_size_bytes{fstype=~&#34;ext4|xfs&#34;} * 100) &gt; 80
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    for: 2m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      severity: warning
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    annotations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      summary: &#34;{{$labels.instance}}: {{$labels.mountpoint }} 分区使用过高&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      description: &#34;{{$labels.instance}}: {{$labels.mountpoint }} 分区使用大于 80% (当前值: {{ $value }})&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - alert: NodeMemoryUsage
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    expr: 100 - (node_memory_MemFree_bytes+node_memory_Cached_bytes+node_memory_Buffers_bytes) / node_memory_MemTotal_bytes * 100 &gt; 80
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    for: 2m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      severity: warning
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    annotations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      summary: &#34;{{$labels.instance}}: 内存使用过高&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      description: &#34;{{$labels.instance}}: 内存使用大于 80% (当前值: {{ $value }})&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - alert: NodeCPUUsage
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    expr: 100 - (avg(irate(node_cpu_seconds_total{mode=&#34;idle&#34;}[5m])) by (instance) * 100) &gt; 80
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    for: 2m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      severity: warning
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    annotations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      summary: &#34;{{$labels.instance}}: CPU使用过高&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      description: &#34;{{$labels.instance}}: CPU使用大于 80% (当前值: {{ $value }})&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># cat rules/reload.yml 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">groups:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- name: prometheus.rules
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  rules:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - alert: AlertmanagerReloadFailed
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    expr: alertmanager_config_last_reload_successful == 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    for: 10m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      severity: warning
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    annotations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      summary: &#34;{{$labels.instance}}: Alertmanager配置重新加载失败&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      description: &#34;{{$labels.instance}}: Alertmanager配置重新加载失败&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - alert: PrometheusReloadFailed
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    expr: prometheus_config_last_reload_successful == 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    for: 10m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      severity: warning
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    annotations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      summary: &#34;{{$labels.instance}}: Prometheus配置重新加载失败&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      description: &#34;{{$labels.instance}}: Prometheus配置重新加载失败&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">route</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">receiver</span>: <span style="color:#e6db74">&#39;default-receiver&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">group_wait</span>: <span style="color:#ae81ff">30s</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">group_interval</span>: <span style="color:#ae81ff">5m</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">repeat_interval</span>: <span style="color:#ae81ff">4h</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">group_by</span>: [<span style="color:#ae81ff">cluster, alertname]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">routes</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">receiver</span>: <span style="color:#e6db74">&#39;database-pager&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">group_wait</span>: <span style="color:#ae81ff">10s</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">match_re</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">service</span>: <span style="color:#ae81ff">mysql|cassandra</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">receiver</span>: <span style="color:#e6db74">&#39;frontend-pager&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">group_by</span>: [<span style="color:#ae81ff">product, environment]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">match</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">team</span>: <span style="color:#ae81ff">frontend</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">receivers</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">‘database-pager</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">email_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- to: &#39;</span><span style="color:#ae81ff">zhenliang369@163.com&#39;</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">‘frontend-pager</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">email_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- to: &#39;</span><span style="color:#ae81ff">zhenliang369@163.com&#39; </span></span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="configure_open_falcon">Configure_Open_Falcon</h1>

<h2 id="open-falcon配置"><code>Open-falcon</code>配置</h2>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->查看监控数据<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>
<p><a href="https://www.cnblogs.com/kevingrace/p/5570488.html" rel="external" target="_self"><code>Linux</code>下<code>smokeping</code>网络监控环境部署记录</a></p>
</li>
<li>
<p><code>agent</code>只要部署到机器上，并且配置好了<code>heartbeat</code>和<code>transfer</code>就自动采集数据了，我们就可以去<code>dashboard</code>上面搜索监控数据查看了。<code>dashboard</code>是个<code>web&gt; </code>项目，浏览器访问之。左侧输入<code>endpoint</code>搜索，<code>endpoint</code>是什么？应该用什么搜索？对于<code>agent</code>采集的数据<code>endpoint</code>都是机器名，去目标机器上执行<code>hostname</code>&gt; ，看到的输出就是<code>endpoint</code>，拿着<code>hostname</code>去搜索。</p>
</li>
<li>
<p>选中前面的复选框，点击“查看<code>counter</code>列表”，可以列出隶属于这个<code>endpoint</code>的<code>counter</code>假如我们要查看<code>cpu.busy</code>，在<code>counter</code>搜索框中输入<code>cpu</code>&gt; 并回车。看到<code>cpu.busy</code>了吧，点击，会看到一个新页面，图表中就是这个机器的<code>cpu.busy</code>&gt; 的近一小时数据了，想看更长时间的？右上角有个小三角，展开菜单，可以选择更长的时间跨度</p>
</li>
</ul>
<p><a href="#R-image-eb5e6a2569ad6536135a727ffc867833" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/dashboard.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-eb5e6a2569ad6536135a727ffc867833"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/dashboard.png"></a></p>
<p><a href="#R-image-8529978f604361f5ed2761225dedd877" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/dashboard-cpu.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-8529978f604361f5ed2761225dedd877"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/dashboard-cpu.png"></a></p>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->配置报警策略<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>
<p><!-- raw HTML omitted -->配置报警接收人<!-- raw HTML omitted --></p>
<p><code>falcon</code>的报警接收人不是一个具体的手机号，也不是一个具体的邮箱，因为手机号、邮箱都是容易发生变化的，如果变化了去修改所有相关配置那就太麻烦了。我们把用&gt; 户的联系信息维护在一个叫 <code>帐户/Profile</code> 里，以后如果要修改手机号、邮箱，只要修改自己的帐户信息即可。报警接收人也不是单个的人，而是一个组（<code>Teams</code>），比如<code>&gt; falcon</code>这个系统的任何组件出问题了，都应该发报警给<code>falcon</code>的运维和开发人员，发给<code>falcon</code>这个团队，这样一来，新员工入职只要加入<code>falcon</code>这个<code>Team</code>&gt; 即可；员工离职，只要从<code>falcon</code>这个<code>Team</code>删掉即可。</p>
</li>
</ul>
<p><a href="#R-image-e41a286958559f94d84a25773dd95058" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/dashboard-profile.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-e41a286958559f94d84a25773dd95058"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/dashboard-profile.png"></a></p>
<ul>
<li><!-- raw HTML omitted -->添加报警组，添加成员<!-- raw HTML omitted --></li>
</ul>
<p><a href="#R-image-376e8ec88604791a94e8581038a89807" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/dashboard-group.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-376e8ec88604791a94e8581038a89807"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/dashboard-group.png"></a></p>
<p><a href="#R-image-8f6aa5dd9959504c3c0003d0df5816cb" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/dashboard-group-1.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-8f6aa5dd9959504c3c0003d0df5816cb"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/dashboard-group-1.png"></a></p>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->创建<!-- raw HTML omitted --><code>HostGroup</code></li>
</ul>
<blockquote>
<ul>
<li>比如我们要对<code>falcon-judge</code>这个组件做端口监控，那首先创建一个<code>HostGroup</code>，把所有部署了<code>falcon-judge</code>&gt; 这个模块的机器都塞进去，以后要扩容或下线机器的时候直接从这个<code>HostGroup</code>增删机器即可，报警策略会自动生效、失效。咱们为这个<code>HostGroup</code>取名为：<code>&gt; sa.dev.falcon.judge</code>，这个名称有讲究，<code>sa</code>是我们部门，<code>dev</code>是我们组，<code>falcon</code>是项目名，<code>judge</code>&gt; 是组件名，传达出了很多信息，这样命名比较容易管理，推荐大家这么做</li>
</ul>
<p><a href="#R-image-87f0d1485e35389ce3d44a8dbf4309db" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/hostgroups.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-87f0d1485e35389ce3d44a8dbf4309db"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/hostgroups.png"></a></p>
<ul>
<li>在往组里加机器的时候如果报错，需要检查<code>portal</code>的数据库中<code>host</code>表，看里边是否有相关机器。那<code>host</code>表中的机器从哪里来呢？<code>agent</code>有个<code>heartbeat(hbs)</code>&gt; 的配置，<code>agent</code>每分钟会发心跳给<code>hbs</code>，把自己的<code>ip</code>、<code>hostname</code>、<code>agent version</code>等信息告诉<code>hbs</code>，<code>hbs</code>负责写入<code>host</code>表。如果<code>host</code>&gt; 表中没数据，需要检查这条链路是否通畅</li>
</ul>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->创建策略模板<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>portal</code>最上面有个<code>Templates</code>链接，这就是策略模板管理的入口。我们进去之后创建一个模板，名称姑且也叫：<code>sa.dev.falcon.judge.tpl</code>，与<code>HostGroup</code>&gt; 名称相同，在里边配置一个端口监控，通常进程监控有两种手段，一个是进程本身是否存活，一个是端口是否在监听，此处我们使用端口监控</li>
</ul>
<p><a href="#R-image-5ed6a6f52b14dd4012cf751877cd06a8" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/template.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-5ed6a6f52b14dd4012cf751877cd06a8"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/template.png"></a></p>
<p><a href="#R-image-2eb327cf7afa1c160059d08476788af1" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/template-1.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-2eb327cf7afa1c160059d08476788af1"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/template-1.png"></a></p>
<ul>
<li>右上角那个加号按钮是用于增加策略的，一个模板中可以有多个策略，此处我们只添加了一个。下面可以配置报警接收人，此处填写的是<code>falcon</code>，这是之前在<code>UIC</code>&gt; 中创建的<code>Team</code>。</li>
</ul>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->将<!-- raw HTML omitted --><code>HostGroup</code><!-- raw HTML omitted -->与模板绑定<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>一个模板是可以绑定到多个<code>HostGroup</code>的，现在我们重新回到<code>HostGroups</code>页面，找到<code>sa.dev.falcon.judge</code>这个<code>HostGroup</code>&gt; ，右侧有几个超链接，点击【templates】进入一个新页面，输入模板名称，绑定一下就行了</li>
</ul>
<p><a href="#R-image-04046e4d03ddb567b485a279ab1fdea1" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/hostgroups-tempates.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-04046e4d03ddb567b485a279ab1fdea1"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/hostgroups-tempates.png"></a></p>
<p><a href="#R-image-d61775525ec7de728789351eb4460d3e" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/hostgroups-tempates-1.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-d61775525ec7de728789351eb4460d3e"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/hostgroups-tempates-1.png"></a></p>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->补充<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>上面步骤做完了，也就配置完了。如果<code>judge</code>组件宕机，端口不再监听了，就会报警。不过大家不要为了测试报警效果，直接把<code>judge</code>组件给干掉了，因为<code>judge</code>&gt; 本身就是负责判断报警的，把它干掉了，那就没法判断了……所以说<code>falcon</code>&gt; 现在并不完善，没法用来监控本身的组件。为了测试，大家可以修改一下端口监控的策略配置，改成一个没有在监听的端口，这样就触发报警了</li>
<li>上面的策略只是对<code>falcon-judge</code>做了端口监控，那如果我们要对<code>falcon</code>这个项目的所有机器加一些负载监控，应该如何做呢？</li>
<li>创建一个<code>HostGroup：sa.dev.falcon</code>，把所有<code>falcon</code>的机器都塞进去</li>
<li>创建一个模板：<code>sa.dev.falcon.common</code>，添加一些像<code>ping</code>, <code>df.bytes.free.percent</code>, <code>load.5min</code>等策略</li>
<li>将<code>sa.dev.falcon.common</code>绑定到<code>sa.dev.falcon</code>这个<code>HostGroup</code></li>
</ul>
<p><a href="#R-image-5b82481a012ceb5de7fc9f1ab565754c" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/template-2.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-5b82481a012ceb5de7fc9f1ab565754c"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/template-2.png"></a></p>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->配置策略表达式<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->策略表达式，即<!-- raw HTML omitted --><code>expression</code></li>
</ul>
<p><a href="#R-image-6c0fcbe09495aacc8ad4da92de0c32e1" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/expressions.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-6c0fcbe09495aacc8ad4da92de0c32e1"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/expressions.png"></a></p>
<ul>
<li>
<p>上例中的配置传达出的意思是：<code>endpoint=aggregator</code>并且<code>metric=cpu.busy</code>的所有的监控指标，只要连续<code>3</code>次<code>&gt;= 0.5</code>则报警给<code>falcon-test1</code>&gt; 这个报警组。</p>
</li>
<li>
<p><code>expression</code>无需绑定到<code>HostGroup</code>，<code>enjoy it</code></p>
</li>
</ul>
</blockquote>
</blockquote>
<hr>
<h3 id="nodata配置"><code>Nodata</code>配置</h3>
<blockquote>
<blockquote>
<ul>
<li>使用<code>Nodata</code>，需要进行两个配置: <code>Nodata</code>配置和策略配置。下面，我们以一个例子，讲述如何使用<code>Nodata</code>提供的服务</li>
</ul>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->用户需求<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>当机器分组<code>cop.xiaomi_owt.inf_pdl.falcon</code>下的所有机器，其采集指标<code>agent.alive</code> 上报中断时，通知用户</li>
</ul>
</blockquote>
<ul>
<li><code>nodata</code><!-- raw HTML omitted -->配置<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->进入<!-- raw HTML omitted --><code>Nodata</code><!-- raw HTML omitted -->配置主页，可以看到<!-- raw HTML omitted --><code>Nodata</code><!-- raw HTML omitted -->配置列表<!-- raw HTML omitted --></li>
</ul>
<p><a href="#R-image-8817273edb38393c43c2161e8519b6f7" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/nodata.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-8817273edb38393c43c2161e8519b6f7"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/nodata.png"></a></p>
<ul>
<li><!-- raw HTML omitted -->点击右上角的添加按钮，添加<!-- raw HTML omitted --><code>nodata</code><!-- raw HTML omitted -->配置<!-- raw HTML omitted --></li>
</ul>
<p><a href="#R-image-b92c1cd28fe0048695cd71d24c015d97" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/nodata-1.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-b92c1cd28fe0048695cd71d24c015d97"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/nodata-1.png"></a></p>
<ul>
<li><!-- raw HTML omitted -->进行完上述配置后，分组<!-- raw HTML omitted --><code>cop.xiaomi_owt.inf_pdl.falcon</code><!-- raw HTML omitted -->下的所有机器，其采集项<!-- raw HTML omitted --> <code>agent.alive</code>&lt;&gt; font color=red&gt;上报中断后，<!-- raw HTML omitted --><code>nodata</code><!-- raw HTML omitted -->服务就会补发一个取值为<!-- raw HTML omitted --><code>-1.0</code>、<code>agent.alive</code><!-- raw HTML omitted -->&gt; 的监控数据给监控系统<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->策略配置<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>配置了<code>Nodata</code>后，如果有数据上报中断的情况，<code>Nodata</code>配置中的默认值就会被上报。我们可以针对这个默认值，设置报警；只要收到了默认值，就认为发生了数据上报&gt; 的中断（如果你设置的默认值，可能与正常上报的数据相等，那么请修改你的<code>Nodata</code>配置、使默认值有别于正常值）。将此策略，绑定到分组<code>&gt; cop.xiaomi_owt.inf_pdl.falcon</code>即可。</li>
</ul>
<p><a href="#R-image-769a54787e65f3de8eeee5cb1dbf26b8" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/template-3.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-769a54787e65f3de8eeee5cb1dbf26b8"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/template-3.png"></a></p>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->注意事项<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>配置名称<code>name</code>，要全局唯一。这是为了方便<code>Nodata</code>配置的管理。</li>
<li>监控实例<code>endpoint</code>, 可以是机器分组、机器名或者其他 这三种类型，只能选择其中的一种。同一类型，支持多个记录，但建议不超过5个，多条记录换行分割、每行一条&gt; 记录。选择机器分组时，系统会帮忙展开成具体机器名，支持动态生效。监控实体不是机器名时，只能选择“其他”类型。</li>
<li>监控指标<code>metric</code>。</li>
<li>数据标签<code>tags</code>，多个<code>tag</code>要用逗号隔开。必须填写完整的<code>tags</code>串，因为<code>nodata</code>会按照此<code>tags</code>串，去完全匹配、筛选监控数指标项。</li>
<li>数据类型<code>type</code>，只支持原始值类型<code>GAUGE</code>。因为，<code>nodata</code>只应该监控 &ldquo;特征指标&rdquo;(如<code>agent.alive</code>)，&ldquo;特征指标&quot;都是<code>GAUGE</code>类型的</li>
<li>采集周期<code>step</code>，单位是秒。必须填写 完整<code>&amp;</code>真实<code>step</code>。该字段不完整 或者 不真实，将会导致<code>nodata</code>监控的误报、漏报。</li>
<li>补发值<code>default</code>，必须有别于上报的真实数据。比如，<code>cpu.idle</code>的取值范围是[0,100]，那么它的<code>nodata</code>默认取值 只能取小于<code>0</code>或者大于<code>100</code>&gt; 的值。否则，会发生误报、漏报</li>
</ul>
</blockquote>
</blockquote>
<hr>
<h3 id="报警函数说明">报警函数说明</h3>
<blockquote>
<ul>
<li>说明：<code>#</code>后面的数字的最大值，即在<code>judge</code>内存中保留最近几个点，是支持自定义的</li>
</ul>
<blockquote>
<ul>
<li><code>all(#3)</code>: 最新的<code>3</code>个点都满足阈值条件则报警</li>
<li><code>max(#3)</code>: 对于最新的<code>3</code>个点，其最大值满足阈值条件则报警</li>
<li><code>min(#3)</code>: 对于最新的<code>3</code>个点，其最小值满足阈值条件则报警</li>
<li><code>sum(#3)</code>: 对于最新的<code>3</code>个点，其和满足阈值条件则报警</li>
<li><code>avg(#3)</code>: 对于最新的<code>3</code>个点，其平均值满足阈值条件则报警</li>
<li><code>diff(#3)</code>: 拿最新<code>push</code>上来的点（被减数），与历史最新的<code>3</code>个点（<code>3</code>个减数）相减，得到<code>3</code>个差，只要有一个差满足阈值条件则报警</li>
<li><code>pdiff(#3)</code>: 拿最新<code>push</code>上来的点，与历史最新的<code>3</code>个点相减，得到<code>3</code>个差，再将<code>3</code>个差值分别除以减数，得到<code>3</code>个商值，只要有一个商值满足阈值则报警</li>
<li><code>lookup(#2,3)</code>: 最新的<code>3</code>个点中有<code>2</code>个满足条件则报警；</li>
<li><code>stddev(#7) = 3</code>：离群点检测函数，取最新<strong>7</strong>个点的数据分别计算得到他们的标准差和均值，分别计为<code>σ</code>和<code>μ</code>，其中当前值计为<code>X</code>，那么当<code>X</code>落在区间 [μ-3σ, μ+3σ] 之外时，则认为当前值波动过大，触发报警；更多请参考<code>3-sigma</code>算法：https://en.wikipedia.org/wiki/68%E2%80%9395%E2%80%9399.7_rule。</li>
</ul>
</blockquote>
<ul>
<li>最常用的就是<code>all</code>函数了，比如<code>cpu.idle</code> <code>all(#3) &lt; 5</code>，表示<code>cpu.idle</code>的值连续<code>3</code>次小于<code>5%</code>则报警。</li>
<li><code>lookup</code>为非连续性报警函数，适用于在一定范围内容忍监控指标抖动的场景，比如某个主机的<code>cpu.busy</code>忽高忽低，使用<code>all(#1)&gt;80</code>明显过于严格，会产生大量报警干扰视线，使用<code>all(#3)&gt;80</code>则连续三次偏高的概率很小，可能永远不会触发报警，不能帮助我们发现系统的不稳定，那么如果使用<code>lookup(#3,5)</code>，我们就可以知道<code>cpu.busy</code>最近抖动频繁，超过了我们容忍的界线。</li>
<li>新增 <code>stddev</code> 函数，基于高斯分布的离群点检测方式，比如<code>cpu.idle</code> <code>stddev(#5) = 3</code> ，表示获取<code>cpu.idle</code>的历史<code>5</code>个点数据，计算得到他们的标准差和均值，分别计为<code>σ</code>和<code>μ</code>，看其是否分布在<code>(μ-3σ,μ+3σ)</code>范围之内，如果不在范围之内则报警。</li>
</ul>
</blockquote>
<hr>
<h3 id="screen的使用"><code>screen</code>的使用</h3>
<blockquote>
<ul>
<li>我们可以使用<code>screen</code>提前将图像定制好，而不用每次都去搜索出图，这样就实现了类似的cacti图像展示功能。</li>
</ul>
<p><a href="#R-image-d03022a8fc922294c22c60dae5019c56" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/screen.jpg" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-d03022a8fc922294c22c60dae5019c56"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/screen.jpg"></a></p>
<p><a href="#R-image-781d15c1996fcae1ade1ca009ce49a96" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/screen-falcon.jpg" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-781d15c1996fcae1ade1ca009ce49a96"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/screen-falcon.jpg"></a></p>
<p><a href="#R-image-98907549dd0aff62e2bb1532fd942638" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/screen-1.jpg" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-98907549dd0aff62e2bb1532fd942638"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/screen-1.jpg"></a></p>
<p><a href="#R-image-d174c6258eb168926aaa848793c33dcc" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/screen-2.jpg" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-d174c6258eb168926aaa848793c33dcc"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/screen-2.jpg"></a></p>
<p><a href="#R-image-ed64cfbbf2bf127f6d2b0dc6cf058afa" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/screen-3.jpg" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-ed64cfbbf2bf127f6d2b0dc6cf058afa"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/screen-3.jpg"></a></p>
<p><a href="#R-image-043d667308d0870514555658e9ef14b8" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/screen-4.jpg" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-043d667308d0870514555658e9ef14b8"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/screen-4.jpg"></a></p>
<p><a href="#R-image-50261cce1007bf70905a928d92b2a09b" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/screen-5.jpg" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-50261cce1007bf70905a928d92b2a09b"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/screen-5.jpg"></a></p>
<p><a href="#R-image-cdcaad447c25a7a2ecbd5274a64b7387" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/screen-6.jpg" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-cdcaad447c25a7a2ecbd5274a64b7387"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Monitor_Server/Open-Falcon_Server/screen-6.jpg"></a></p>
<p><!-- raw HTML omitted -->注：<!-- raw HTML omitted --><code>graph</code><!-- raw HTML omitted -->可以加多个<!-- raw HTML omitted --></p>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          </section>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="nosql">Nosql</h1>


            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Nosql</h1>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_scylladb">Install_Scylladb</h1>

<h2 id="scylladb部署"><code>Scylladb</code>部署</h2>
<h3 id="单节点部署scylladb">单节点部署<code>Scylladb</code></h3>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://docs.scylladb.com/stable/getting-started/os-support.html" rel="external" target="_self">系统要求</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.scylladb.com/" rel="external" target="_self"><code>ScyllaDB</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.scylladb.com/download/?platform=ubuntu-22.04&version=scylla-5.1#open-source" rel="external" target="_self"><code>ScyllaDB</code>文档</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/scylladb/scylladb/" rel="external" target="_self"><code>Github-Scylla</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://docs.scylladb.com/stable/operating-scylla/admin.html#cqlsh-networking" rel="external" target="_self"><code>Scylla</code>使用端口</a></td>
<td></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>端口</th>
<th>协议</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>9042</td>
<td><code>TCP</code></td>
<td><code>CQL</code>、本地传输端口： <code>native_transport_port</code></td>
</tr>
<tr>
<td>9142</td>
<td><code>TCP</code></td>
<td><code>SSL</code> <code>CQL</code>使用加密方式由客户端到节点</td>
</tr>
<tr>
<td>7000</td>
<td><code>TCP</code></td>
<td><code>Inter-node communication</code> (<code>RPC</code>) 节点间通信</td>
</tr>
<tr>
<td>7001</td>
<td><code>TCP</code></td>
<td><code>SSL inter-node communication</code> (<code>RPC</code>) 使用<code>SSL</code>节点间通信</td>
</tr>
<tr>
<td>7199</td>
<td><code>TCP</code></td>
<td><code>JMX management</code>、<code>JMX</code>管理</td>
</tr>
<tr>
<td>10000</td>
<td><code>TCP</code></td>
<td><code>Scylla REST API</code></td>
</tr>
<tr>
<td>9180</td>
<td><code>TCP</code></td>
<td><code>Prometheus API</code>普罗米修斯<code>API</code></td>
</tr>
<tr>
<td>9100</td>
<td><code>TCP</code></td>
<td><code>node_exporter</code> (<code>Optionally</code>：可选)</td>
</tr>
<tr>
<td>9160</td>
<td><code>TCP</code></td>
<td><code>Scylla client port</code> (<code>Thrift</code>) <code>Scylla</code>客户端端口</td>
</tr>
<tr>
<td>19042</td>
<td><code>TCP</code></td>
<td><code>Native shard-aware transport port</code>本机分片感知传输端口</td>
</tr>
<tr>
<td>19142</td>
<td><code>TCP</code></td>
<td><code>Native shard-aware transport port</code> (<code>ssl</code>) 本机分片感知传输端口 (<code>ssl</code>)</td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted --><code>Install Openjdk 8 or 11</code><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -p /etc/apt/keyrings
</span></span><span style="display:flex;"><span>$ gpg --homedir /tmp --no-default-keyring --keyring /etc/apt/keyrings/scylladb.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys d0a112e067426ab2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ wget -O /etc/apt/sources.list.d/scylla.list http://downloads.scylladb.com/deb/debian/scylla-5.1.list</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>scylla</code><!-- raw HTML omitted -->安装包<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ apt-get update
</span></span><span style="display:flex;"><span>$ apt-get install -y scylla </span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->列出可用安装包<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ apt-cache madison scylla</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->开始安装<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ apt-get install scylla<span style="color:#f92672">{</span>,-server,-jmx,-tools,-tools-core,-kernel-conf,-node-exporter,-conf,-python3<span style="color:#f92672">}=</span>4.6.1-0.20220328.2309d6b51-1  	<span style="color:#75715e"># 4.6.1-0.20220328.2309d6b51-1 为安装包</span></span></span></code></pre></div><ul>
<li>1.4 <!-- raw HTML omitted -->将<!-- raw HTML omitted --><code>Java</code><!-- raw HTML omitted -->设置为<!-- raw HTML omitted --><code>1.8</code><!-- raw HTML omitted -->版本<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ apt-get update
</span></span><span style="display:flex;"><span>$ apt-get install -y openjdk-8-jre-headless
</span></span><span style="display:flex;"><span>$ update-java-alternatives --jre-headless -s java-1.8.0-openjdk-amd64</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->运行<!-- raw HTML omitted --><code>scylla_setup</code><!-- raw HTML omitted -->脚本来调整系统设置<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ scylla_setup
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Do you want to run check your kernel version?
</span></span><span style="display:flex;"><span>Yes - runs a  script to verify that the kernel <span style="color:#66d9ef">for</span> this instance qualifies to run Scylla. No - skips the kernel check.
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>YES/no<span style="color:#f92672">]</span>YES  	<span style="color:#75715e"># 是否检查内核版本</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Do you want to verify the ScyllaDB packages are installed?
</span></span><span style="display:flex;"><span>Yes - runs a script to confirm that ScyllaDB is installed. No - skips the installation check.
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>YES/no<span style="color:#f92672">]</span>YES  	<span style="color:#75715e"># 是否验证 ScyllaDB 软件包已安装</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Do you want the Scylla server service to automatically start when the Scylla node boots?
</span></span><span style="display:flex;"><span>Yes - Scylla server service automatically starts on Scylla node boot. No - skips this step. Note you will have to start the Scylla Server service manually.
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>YES/no<span style="color:#f92672">]</span>YES  	<span style="color:#75715e"># 是否允许Scylla开机自启</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Created symlink /etc/systemd/system/multi-user.target.wants/scylla-server.service → /lib/systemd/system/scylla-server.service.
</span></span><span style="display:flex;"><span>Do you want to enable Scylla to check <span style="color:#66d9ef">if</span> there is a newer version of Scylla available?
</span></span><span style="display:flex;"><span>Yes - start the Scylla-housekeeping service to check <span style="color:#66d9ef">for</span> a newer version. This check runs periodically. No - skips this step.
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>YES/no<span style="color:#f92672">]</span>NO  	<span style="color:#75715e"># 是否检查Scylla 是不是最新版本</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Do you want to setup Network Time Protocol<span style="color:#f92672">(</span>NTP<span style="color:#f92672">)</span> to auto-synchronize the current time on the node?
</span></span><span style="display:flex;"><span>Yes - enables time-synchronization. This keeps the correct time on the node. No - skips this step.
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>YES/no<span style="color:#f92672">]</span>YES  	<span style="color:#75715e"># 是否启用NTP时间同步</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Do you want to setup RAID and XFS?
</span></span><span style="display:flex;"><span>It is recommended to use RAID and XFS <span style="color:#66d9ef">for</span> Scylla data. If you <span style="color:#66d9ef">select</span> yes, you will be prompted to choose the unmounted disks to use <span style="color:#66d9ef">for</span> Scylla data. Selected disks are formatted as part of the process.
</span></span><span style="display:flex;"><span>Yes - choose a disk/disks to format and setup <span style="color:#66d9ef">for</span> RAID and XFS. No - skip this step.
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>YES/no<span style="color:#f92672">]</span>YES  	<span style="color:#75715e"># 是否设置RAID和XFS 是：将会格式化磁盘</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Do you want to enable coredumps?
</span></span><span style="display:flex;"><span>Yes - sets up coredump to allow a post-mortem analysis of the Scylla state just prior to a crash. No - skips this step.
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>YES/no<span style="color:#f92672">]</span>  	<span style="color:#75715e"># 是否允许coredump在崩溃之前对Scylla状态进行事后分析</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Do you want to setup a system-wide customized configuration <span style="color:#66d9ef">for</span> Scylla?
</span></span><span style="display:flex;"><span>Yes - setup the sysconfig file. No - skips this step.
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>YES/no<span style="color:#f92672">]</span>YES  <span style="color:#75715e"># 是否为Scylla设置系统范围自定义配置</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Do you want IOTune to study your disks IO profile and adapt Scylla to it? <span style="color:#f92672">(</span>*WARNING* Saying NO here means the node will not boot in production mode unless you configure the I/O Subsystem manually!<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Yes - let iotune study my disk<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>. Note that this action will take a few minutes. No - skip this step.
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>YES/no<span style="color:#f92672">]</span>YES  	<span style="color:#75715e"># 是否让IOTune研究您的磁盘IO配置文件并使Scylla适应它，否”意味着手动配置 I/O 子系统，否则节点将不会以生产模式启动</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Do you want to set the CPU scaling governor to Performance level on boot?
</span></span><span style="display:flex;"><span>Yes - sets the CPU scaling governor to performance level. No - skip this step.
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>YES/no<span style="color:#f92672">]</span>YES  	<span style="color:#75715e"># 是否允许在引导时将CPU缩放调控器设置为性能级别</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Do you want to enable fstrim service?
</span></span><span style="display:flex;"><span>Yes - runs fstrim on your SSD. No - skip this step.
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>yes/NO<span style="color:#f92672">]</span>YES  	<span style="color:#75715e"># 是否启用fstrim 服务</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Will Scylla be the only service on this host?
</span></span><span style="display:flex;"><span>Answer yes to lock all memory to Scylla, to prevent swapout. Answer no to <span style="color:#66d9ef">do</span> nothing.
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>YES/no<span style="color:#f92672">]</span>YES  	<span style="color:#75715e"># Scylla是不是该主机上的唯一服务，是：将内存锁定到Scylla，以防止换出</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Do you want to configure rsyslog to send log to a remote repository?
</span></span><span style="display:flex;"><span>Answer yes to setup rsyslog to a remote server, Answer no to <span style="color:#66d9ef">do</span> nothing.
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>YES/no<span style="color:#f92672">]</span>no  	<span style="color:#75715e"># 是否配置rsyslog将日志发送到远程存储库</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->启动<!-- raw HTML omitted --><code>Scylla</code><!-- raw HTML omitted -->数据库服务<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl start scylla-server
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看是否启动</span>
</span></span><span style="display:flex;"><span>$ systemctl status scylla-server</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->检查节点状态<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ nodetool status
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 运行cqlsh 连接到数据库</span>
</span></span><span style="display:flex;"><span>$ cqlsh
</span></span><span style="display:flex;"><span>$ cqlsh&gt; help  	<span style="color:#75715e"># 使用help帮助命令</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 运行 cassandra-stress</span>
</span></span><span style="display:flex;"><span>$ cqlsh&gt; cassandra-stress write -mode cql3 native</span></span></code></pre></div></blockquote>
<hr>
<h3 id="部署scylladb集群">部署<code>Scylladb</code>集群</h3>
<h4 id="单数据中心scylla集群模式">单数据中心<code>Scylla</code>集群模式</h4>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://docs.scylladb.com/stable/operating-scylla/procedures/cluster-management/create-cluster.html" rel="external" target="_self">创建<code>Scylla</code>集群 - 单数据中心 <code>DC</code></a></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h4 id="多数据中心scylla集群模式">多数据中心<code>Scylla</code>集群模式</h4>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://docs.scylladb.com/stable/operating-scylla/procedures/cluster-management/create-cluster-multidc.html" rel="external" target="_self">创建<code>Scylla</code>集群 - 多数据中心 <code>DC</code></a></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_redis">Install_Redis</h1>

<h2 id="redis安装"><code>Redis</code>安装</h2>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="http://download.redis.io/releases/" rel="external" target="_self"><code>Redis</code>安装包</a></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>
<ol>
<li><code>Redis</code><!-- raw HTML omitted -->依赖<!-- raw HTML omitted --><code>gcc</code><!-- raw HTML omitted -->与<!-- raw HTML omitted --><code>gcc-c++</code><!-- raw HTML omitted -->，而<!-- raw HTML omitted --><code>Redis5.0</code><!-- raw HTML omitted -->以上需要更高版本<!-- raw HTML omitted --><code>gcc</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>Gcc</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># Debian系统</span>
</span></span><span style="display:flex;"><span>$ sudo apt-get install wget gcc make pkg-config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ yum -y install gcc gcc-c++ centos-release-scl wget git</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->安装高版本<!-- raw HTML omitted --><code>gcc</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install devtoolset-9-gcc devtoolset-9-gcc-c++ devtoolset-9-binutils
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 临时生效</span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;scl enable devtoolset-9 bash&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 添加到环境变量永久生效</span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;source /opt/rh/devtoolset-9/enable&#34;</span> &gt;&gt;/etc/profile
</span></span><span style="display:flex;"><span>$ source /etc/profile
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;scl enable devtoolset-9 bash&#39;</span> &gt;&gt; ~/.bashrc
</span></span><span style="display:flex;"><span>$ source ~/.bashrc   <span style="color:#75715e"># 使更改生效</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 如果出现不能跳转root执行</span>
</span></span><span style="display:flex;"><span>$ sudo scl enable devtoolset-9 bash</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>Redis</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->下载<!-- raw HTML omitted --><code>tar</code><!-- raw HTML omitted -->包到指定目并解压<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget -P /usr/local/src/ https://download.redis.io/releases/redis-6.2.6.tar.gz  	<span style="color:#75715e"># 下载到指定目录</span>
</span></span><span style="display:flex;"><span>$ sudo wget -P /usr/local/src/ https://download.redis.io/redis-stable.tar.gz</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->解压到指定目录并重命名<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -p /usr/local/redis <span style="color:#f92672">&amp;&amp;</span> tar zxvf /usr/local/src/redis-6.2.6.tar.gz -C /usr/local/redis --strip-components <span style="color:#ae81ff">1</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>redis</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /usr/local/redis
</span></span><span style="display:flex;"><span>$ make MALLOC<span style="color:#f92672">=</span>libc BUILD_TLS<span style="color:#f92672">=</span>yes  	<span style="color:#75715e"># 有些版本或者云需要 BUILD_TLS=yes 参数</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->执行安装<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ make PREFIX<span style="color:#f92672">=</span>/usr/local/redis install </span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改配置文件<!-- raw HTML omitted --><code>daemonize</code><!-- raw HTML omitted -->参数能后台启动以及使用密码连接<!-- raw HTML omitted --><!-- raw HTML omitted -->注释不可以在行尾<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;# redis后台运行
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">daemonize yes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># Redis的pid文件存放位置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">pidfile /usr/local/redis/logs/redis_6379.pid
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># Redis的日志文件存放位置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">logfile /usr/local/redis/logs/redis_6379.log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 端口号
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">port 6379
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 最好是本机IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">bind 192.168.176.131
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 超时时间300秒 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">timeout 300
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 缓存库的个数
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">databases 8
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 将数据库转储到的文件名
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">dbfilename dump-16379.db
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 数据存放目录
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">dir /opt/data/redis/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 主库密码
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">masterauth password
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 连接密码
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">requirepass password &#39;</span>&gt; /usr/local/redis/redis.conf</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->启动<!-- raw HTML omitted --><code>Redis</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /usr/local/redis/bin/redis-server /usr/local/redis/redis.conf</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->编写常规启动文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;#!/bin/sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># Simple Redis init.d script conceived to work on Linux systems
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># as it does use of the /proc filesystem.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># chkconfig:   2345 90 10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># description:  Redis is a persistent key-value database
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">REDISPORT=6379
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EXEC=/usr/local/redis/bin/redis-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">CLIEXEC=/usr/local/redis/bin/redis-cli
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">$CLIEXEC -a &#34;Redis&#34; -p $REDISPORT shutdown
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">PIDFILE=/var/run/redis_${REDISPORT}.pid
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">CONF=&#34;/usr/local/redis/redis.conf&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">case &#34;$1&#34; in
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">start)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  if [ -f $PIDFILE ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          echo &#34;$PIDFILE exists, process is already running or crashed&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  else
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          echo &#34;Starting Redis server...&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          $EXEC $CONF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">stop)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  if [ ! -f $PIDFILE ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          echo &#34;$PIDFILE does not exist, process is not running&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  else
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          PID=$(cat $PIDFILE)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          echo &#34;Stopping ...&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          $CLIEXEC -p $REDISPORT shutdown
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          while [ -x /proc/${PID} ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          do
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              echo &#34;Waiting for Redis to shutdown ...&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              sleep 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          done
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          echo &#34;Redis stopped&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">*)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  echo &#34;Please use start or stop as first argument&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">esac&#39;</span> &gt; /etc/init.d/redis
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ chmod +x /etc/init.d/redis
</span></span><span style="display:flex;"><span>$ chkconfig redis on
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动并查看端口号</span>
</span></span><span style="display:flex;"><span>$ service redis start
</span></span><span style="display:flex;"><span>$ netstat -nuplt | grep <span style="color:#ae81ff">6379</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->编写指定目录启动文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;## 目录
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">REDIS_PATH=&#34;/opt/apps/redis&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sql_conf_dir=&#39;</span>/opt/apps/redis<span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sql_conf_file=$(ls $sql_conf_dir/* |egrep conf$)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sql_user=&#39;</span>admin<span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">start_redis(){
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  sql_pid=$(ps -ef |egrep redis-server |egrep -v root |awk &#39;</span><span style="color:#f92672">{</span>print $2<span style="color:#f92672">}</span><span style="color:#e6db74">&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  [ ! -z ${sql_pid} ] &amp;&amp; echo -e &#34;\n\033[31mredis running...\033[0m\n&#34; &amp;&amp; exit
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  su ${sql_user} -s /bin/bash -c &#34;${REDIS_PATH}/bin/redis-server ${sql_conf_file}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">stop_redis(){
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  sql_pid=$(ps -ef |egrep redis-server |egrep -v root |awk &#39;</span><span style="color:#f92672">{</span>print $2<span style="color:#f92672">}</span><span style="color:#e6db74">&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  [ -z ${sql_pid} ] &amp;&amp; echo -e &#34;\n\033[31mredis not run...\033[0m\n&#34; &amp;&amp; exit
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  su swadmin -s /bin/bash -c &#34;kill ${sql_pid}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">### Finally the input handling.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">case &#34;$1&#34; in
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">start)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  start_redis
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">stop)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  stop_redis
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">*)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  echo &#34;Usage: service redis {start|stop}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  exit 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">esac
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">exit &#39;</span>&gt; /etc/init.d/redis
</span></span><span style="display:flex;"><span>$ chmod +x /etc/init.d/redis
</span></span><span style="display:flex;"><span>$ chkconfig redis on</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->部署脚本<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;redis-install.sh<span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#!/bin/bash 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sed -i &#34;N;56isource /opt/rh/devtoolset-9/enable&#34;  /etc/profile  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">id swadmin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if [ $? -ne 0 ];then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 创建普通用户部署运行Redis
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">groupadd swadmin &amp;&amp; useradd -g swadmin swadmi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sleep 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo &#34;20210623@123&#34;|passwd --stdin2 swadmin &amp;&gt;/dev/null   # 给swadmin用户设置密码
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fi  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">mkdir -p /opt/{src,conf,data,apps} /opt/data/{data_17693,data_17694,data_17695,data_16303}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">chown -R swadmin. /opt/* 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo &#34;#####   Start/Stop Service   #####
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Cmnd_Alias SWADMIN_START_SERVICES = /etc/init.d/redis, /opt/*  # 授予普通用户启动停止权限
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">swadmin ALL=(ALL)NOPASSWD:SWADMIN_START_SERVICES&#34; &gt;/etc/sudoers.d/swadmin 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">chmod 660 /etc/sudoers.d/swadmin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># Redis依赖gcc 与gcc-c++,#Redis5.0以上需要高版本gcc  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">yum -y install gcc gcc-c++ centos-release-scl wget git
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">yum -y install devtoolset-9-gcc devtoolset-9-gcc-c++ devtoolset-9-binutils
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo &#39;scl enable devtoolset-9 bash&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo &#34;source /opt/rh/devtoolset-9/enable&#34; &gt;&gt;/etc/profile
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">source /etc/profile
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 如遇因缺少gcc报错先执行
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## make distclean 再meke
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">su swadmin -c &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">git clone https://admin:&#34;frTd3KbJct_pgoBstA5f&#34;@gitlab.com/usererge/redis-conf.git /opt/conf/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">wget -P /opt/src/ http://download.redis.io/releases/redis-5.0.7.tar.gz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">mkdir -p /opt/apps/redis &amp;&amp; tar zxvf /opt/src/redis-5.0.7.tar.gz -C /opt/apps/redis --strip-components 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">cd /opt/apps/redis/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">make MALLOC=libc 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">make PREFIX=/opt/apps/redis install
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/opt/apps/redis/src/redis-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/opt/conf/redis-conf/re_17693.conf &amp;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">source /etc/profile  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_redis_cluster">Install_Redis_Cluster</h1>

<h2 id="redis集群部署"><code>Redis</code>集群部署</h2>
<h3 id="redis主从模式"><code>Redis</code>主从模式</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->单节点<!-- raw HTML omitted -->主从模式需要修改<!-- raw HTML omitted -->端口<!-- raw HTML omitted -->以及配置文件</li>
<li><!-- raw HTML omitted -->主节点<!-- raw HTML omitted --><code>redis.conf</code><!-- raw HTML omitted -->配置文件<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>daemonize yes  	<span style="color:#75715e"># redis后台运行</span>
</span></span><span style="display:flex;"><span>pidfile /usr/local/redis/logs/redis_6379.pid  	<span style="color:#75715e"># Redis的pid文件存放位置</span>
</span></span><span style="display:flex;"><span>logfile /usr/local/redis/logs/redis_6379.log  	<span style="color:#75715e"># Redis的日志文件存放位置</span>
</span></span><span style="display:flex;"><span>port <span style="color:#ae81ff">6379</span>  	<span style="color:#75715e"># 端口号</span>
</span></span><span style="display:flex;"><span>bind 192.168.176.131  	<span style="color:#75715e"># 最好是本机IP</span>
</span></span><span style="display:flex;"><span>timeout <span style="color:#ae81ff">300</span>  	<span style="color:#75715e"># 超时时间300秒                                        </span>
</span></span><span style="display:flex;"><span>databases <span style="color:#ae81ff">8</span>  	<span style="color:#75715e"># 缓存库的个数 </span>
</span></span><span style="display:flex;"><span>dbfilename dump-16379.db  	<span style="color:#75715e"># 将数据库转储到的文件名</span>
</span></span><span style="display:flex;"><span>dir ./  	<span style="color:#75715e"># 数据存放目录</span>
</span></span><span style="display:flex;"><span>masterauth password  	<span style="color:#75715e"># 主库密码</span>
</span></span><span style="display:flex;"><span>requirepass password  	<span style="color:#75715e"># 登录连接密码</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->从节点<!-- raw HTML omitted --><code>redis.conf</code><!-- raw HTML omitted -->配置文件，第二台从节点修改：<!-- raw HTML omitted --><code>bind</code><!-- raw HTML omitted -->为自己服务器本身<!-- raw HTML omitted --><code>ip</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>daemonize yes  	<span style="color:#75715e"># redis后台运行</span>
</span></span><span style="display:flex;"><span>pidfile /usr/local/redis/logs/redis_6379.pid  	<span style="color:#75715e"># 不同实例修改为对应pid文件</span>
</span></span><span style="display:flex;"><span>logfile /usr/local/redis/logs/redis_6379.log
</span></span><span style="display:flex;"><span>port <span style="color:#ae81ff">6379</span>
</span></span><span style="display:flex;"><span>bind 192.168.176.132
</span></span><span style="display:flex;"><span>timeout <span style="color:#ae81ff">300</span>
</span></span><span style="display:flex;"><span>databases <span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>dbfilename dump-16379.db
</span></span><span style="display:flex;"><span>dir ./  	<span style="color:#75715e"># 数据存放目录</span>
</span></span><span style="display:flex;"><span>masterauth <span style="color:#ae81ff">123456</span>  	<span style="color:#75715e"># 填写主库密码</span>
</span></span><span style="display:flex;"><span>requirepass <span style="color:#ae81ff">123456</span>  	<span style="color:#75715e"># 登录连接密码</span>
</span></span><span style="display:flex;"><span>slaveof 192.168.176.131 <span style="color:#ae81ff">6379</span>  	<span style="color:#75715e"># 连接的主库IP和端口号</span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="redis-cluster模式"><code>Redis Cluster</code>模式</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->集群模式最少6个节点<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->修改配置文件<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>dir /usr/local/redis-cluster/data/redis-6379  	<span style="color:#75715e"># 修改为对应实例数据存放目录</span>
</span></span><span style="display:flex;"><span>pidfile /usr/local/redis-cluster/logs/redis_6379.pid  	<span style="color:#75715e"># 修改为对应实例：Pid</span>
</span></span><span style="display:flex;"><span>logfile /usr/local/redis-cluster/logs/redis_6379.log  	<span style="color:#75715e"># 修改为对应实例 </span>
</span></span><span style="display:flex;"><span>port <span style="color:#ae81ff">6379</span>  	<span style="color:#75715e"># 端口号</span>
</span></span><span style="display:flex;"><span>cluster-enabled yes  	<span style="color:#75715e"># 开启集群模式，把注释#去掉</span>
</span></span><span style="display:flex;"><span>cluster-config-file /usr/local/redis-cluster/conf/redis_16379.conf  	<span style="color:#75715e"># 不同实例修改为对应</span>
</span></span><span style="display:flex;"><span>cluster-node-timeout <span style="color:#ae81ff">10000</span>  	<span style="color:#75715e"># 请求超时，设置10秒</span>
</span></span><span style="display:flex;"><span>appendonly yes  	<span style="color:#75715e"># aof日志开启，有需要就开启，它会每次写操作都记录一条日志</span></span></span></code></pre></div></blockquote>
<ul>
<li><code>Redis5.0</code><!-- raw HTML omitted -->以上版本使用<!-- raw HTML omitted --><code>Redis-cli</code><!-- raw HTML omitted -->客户端部署<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->部署集群需要<!-- raw HTML omitted --><!-- raw HTML omitted -->防火墙开放集群端口<!-- raw HTML omitted --><!-- raw HTML omitted -->互通如端口是：<!-- raw HTML omitted --><code>6379</code> <!-- raw HTML omitted -->集群端口就是：<!-- raw HTML omitted --><code>16379</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /opt/apps/redis/bin/redis-cli -a password --cluster create --cluster-replicas <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> 192.168.213.128:6379 192.168.213.128:6380 192.168.213.128:6381 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> 192.168.213.129:6379 192.168.213.129:6380 192.168.213.129:6381</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->脚本部署<!-- raw HTML omitted --><code>Redis-Cluster</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;#!bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">pkill redis-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">cd /opt/conf/redis-conf/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sed -i &#39;</span>s/^#cluster-enabled/cluster-enabled/<span style="color:#e6db74">&#39; re_17693.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">cat re_17693.conf |tee re_1769{4..5}.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">chown -R swadmin. *
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sed -i &#34;s/17693/17694/g&#34; re_17694.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sed -i &#34;s/17693/17695/g&#34; re_17695.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/opt/apps/redis/bin/redis-server /opt/conf/redis-conf/re_17693.conf &amp;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/opt/apps/redis/bin/redis-server /opt/conf/redis-conf/re_17694.conf &amp;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/opt/apps/redis/bin/redis-server /opt/conf/redis-conf/re_17695.conf &amp;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">firewall-cmd --permanent --new-ipset=redis_whitelist --type=hash:ip
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">firewall-cmd --permanent --add-rich-rule &#39;</span>rule family<span style="color:#f92672">=</span>ipv4 source ipset<span style="color:#f92672">=</span>redis_whitelist port protocol<span style="color:#f92672">=</span>tcp port<span style="color:#f92672">=</span>27693-27695 accept<span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">firewall-cmd --permanent --add-rich-rule &#39;</span>rule family<span style="color:#f92672">=</span>ipv4 source ipset<span style="color:#f92672">=</span>redis_whitelist port protocol<span style="color:#f92672">=</span>tcp port<span style="color:#f92672">=</span>17693-17695 accept<span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">read -p &#34;请输入对方服务器IP:&#34; IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">firewall-cmd --permanent --ipset=redis_whitelist --add-entry=$IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">firewall-cmd --reload
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#echo &#39;</span>yes<span style="color:#e6db74">&#39; |/opt/apps/redis/bin/redis-cli -a \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">9tN6GFGK60Jk8BNkBJM611GwA66uDFeG \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--cluster create --cluster-replicas 1 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.213.128:17693  192.168.213.128:17694 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.213.128:17695  192.168.213.129:17693 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.213.129:17694  192.168.213.129:17695  #创建集群命令根据IP和端口修改
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;</span>&gt;redis-cluster.sh</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="docker部署redis集群"><code>docker</code>部署<code>Redis</code>集群</h3>
<ul>
<li>
<ol>
<li><a href="https://www.jianshu.com/p/b7dea62bcd8b" rel="external" target="_self"><code>Docker</code>方式部署<code>redis-cluster</code></a></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;docker-install-redis-cluster.sh<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#------------ bootstrap the cluster nodes --------------------
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">start_cmd=&#39;redis-server --port 6379 --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000 --appendonly yes --masterauth Redis --requirepass Redis&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">redis_image=&#39;redis:5.0-rc&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">network_name=&#39;redis_cluster_net&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker network create $network_name
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo $network_name &#34; created&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#---------- create the cluster ------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">for port in `seq 6379 6384`; do \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker run -d --name &#34;redis-&#34;$port -p $port:6379 --net $network_name $redis_image $start_cmd;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo &#34;created redis cluster node redis-&#34;$port
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">done
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">cluster_hosts=&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">for port in `seq 6379 6384`; do \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">hostip=`docker inspect -f &#39;{{(index .NetworkSettings.Networks &#34;redis_cluster_net&#34;).IPAddress}}&#39; &#34;redis-&#34;$port`;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo &#34;IP for cluster node redis-&#34;$port &#34;is&#34; $hostip
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">cluster_hosts=&#34;$cluster_hosts$hostip:6379 &#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">done
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo &#34;cluster hosts &#34;$cluster_hosts
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo &#34;creating cluster....&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo &#39;yes&#39; | docker run -i --rm --restart=always -v /etc/localtime:/etc/localtime --net $network_name $redis_image redis-cli  -a Redis --cluster create $cluster_hosts --cluster-replicas 1;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="redis-50以下版本"><code>Redis 5.0</code>以下版本</h3>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://www.myfreax.com/how-to-install-ruby-on-centos-7/" rel="external" target="_self">如何在<code>CentOS 7</code>上安装<code>Ruby</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.jianshu.com/p/e4847f3926d1" rel="external" target="_self"><code>CentOS 7</code>安装<code>Ruby on Rails</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.cnblogs.com/xuliangxing/p/7132656.html" rel="external" target="_self"><code>Linux</code>安装<code>Ruby</code>详解(在线和离线安装)</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.cnblogs.com/tommy-huang/p/7279796.html" rel="external" target="_self"><code>CentOS 7</code>通过<code>RVM</code>来安装指定版本的<code>Ruby</code></a></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h4 id="安装ruby">安装<code>Ruby</code></h4>
<blockquote>
<ul>
<li><code>Redis 5.0</code>以下版本使用<code>Ruby</code>方式安装<code>Redis</code>集群</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">yum install gcc-c++ patch readline readline-devel zlib zlib-devel libyaml-devel libffi-devel openssl-devel make bzip2 autoconf automake libtool bison iconv-devel -y   #安装依赖库
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpg2 --keyserver hkp://keys.gnupg.net --recv-keys D39DC0E3    #安装RVM
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">curl -sSL https://rvm.io/mpapis.asc | gpg2 --import -
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">curl -sSL https://rvm.io/pkuczynski.asc | gpg2 --import -
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">curl -L get.rvm.io | bash -s stable
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sleep 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">source /etc/profile.d/rvm.sh    #设定rvm环境
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sleep 3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rvm -v          #查看是否安装正常
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rvm list known  #查询当前Ruby的版本列表
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rvm install 2.4.6   #安装指定版本的Ruby
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ruby -v             #测试是否成功
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rvm use 2.4.6  --default     #在安装多个版本ruby环境下指定默认版本：这里讲2.4.6 作为默认ruby版本
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rvm system --default    #使用会系统默认版本Ruby
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gem install redis       准备rubygem redis依赖
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;</span> &gt;install-ruby.sh</span></span></code></pre></div></blockquote>
<hr>
<h4 id="拷贝redis-tribrb到集群根目录">拷贝<code>redis-trib.rb</code>到集群根目录</h4>
<blockquote>
<ul>
<li><code>redis-trib.rb</code> 是<code>redis</code>官方推出的管理<code>redis</code>集群 的工具，集成在<code>redis</code>的源码<code>src</code>目录下，将基于 <code>redis</code>提供的 集群命令 封装成 简单、便捷、实用 的 操作工具</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cp /opt/apps/redis/src/redis-trib.rb /opt/apps/redis/</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->查看<!-- raw HTML omitted --><code>redis-trib.rb</code><!-- raw HTML omitted -->命令环境是否正确，输出如下<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ./redis-trib.rb 
</span></span><span style="display:flex;"><span>Usage: redis-trib &lt;command&gt; &lt;options&gt; &lt;arguments ...&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  create          host1:port1 ... hostN:portN
</span></span><span style="display:flex;"><span>                  --replicas &lt;arg&gt;
</span></span><span style="display:flex;"><span>  check           host:port
</span></span><span style="display:flex;"><span>  info            host:port
</span></span><span style="display:flex;"><span>  fix             host:port
</span></span><span style="display:flex;"><span>                  --timeout &lt;arg&gt;
</span></span><span style="display:flex;"><span>  reshard         host:port
</span></span><span style="display:flex;"><span>                  --from &lt;arg&gt;
</span></span><span style="display:flex;"><span>                  --to &lt;arg&gt;
</span></span><span style="display:flex;"><span>                  --slots &lt;arg&gt;
</span></span><span style="display:flex;"><span>                  --yes
</span></span><span style="display:flex;"><span>                  --timeout &lt;arg&gt;
</span></span><span style="display:flex;"><span>                  --pipeline &lt;arg&gt;
</span></span><span style="display:flex;"><span>  rebalance       host:port
</span></span><span style="display:flex;"><span>                  --weight &lt;arg&gt;
</span></span><span style="display:flex;"><span>                  --auto-weights
</span></span><span style="display:flex;"><span>                  --use-empty-masters
</span></span><span style="display:flex;"><span>                  --timeout &lt;arg&gt;
</span></span><span style="display:flex;"><span>                  --simulate
</span></span><span style="display:flex;"><span>                  --pipeline &lt;arg&gt;</span></span></code></pre></div><ul>
<li><code>redis-trib.rb</code><!-- raw HTML omitted -->是<!-- raw HTML omitted --><code>redis</code><!-- raw HTML omitted -->作者用<!-- raw HTML omitted --><code>ruby</code><!-- raw HTML omitted -->完成的。<!-- raw HTML omitted --><code>redis-trib.rb</code><!-- raw HTML omitted -->命令行工具 的具体功能如下:  <!-- raw HTML omitted --></li>
</ul>
<table>
<thead>
<tr>
<th>命令</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>create</code></td>
<td>创建集群</td>
</tr>
<tr>
<td><code>check</code></td>
<td>检查集群</td>
</tr>
<tr>
<td><code>info</code></td>
<td>查看集群信息</td>
</tr>
<tr>
<td><code>fix</code></td>
<td>修复集群</td>
</tr>
<tr>
<td><code>reshard</code></td>
<td>在线迁移<code>slot</code></td>
</tr>
<tr>
<td><code>rebalance</code></td>
<td>平衡集群节点<code>slot</code>数量</td>
</tr>
<tr>
<td><code>add-node</code></td>
<td>将新节点加入集群</td>
</tr>
<tr>
<td><code>del-node</code></td>
<td>从集群中删除节点</td>
</tr>
<tr>
<td><code>set-timeout</code></td>
<td>设置集群节点间心跳连接的超时时间</td>
</tr>
<tr>
<td><code>call</code></td>
<td>在集群全部节点上执行命令</td>
</tr>
<tr>
<td><code>import</code></td>
<td>将外部<code>redis</code>数据导入集群</td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->运行命令启动所有节点<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /opt/apps/redis/bin/redis-server /opt/conf/redis-conf/re_17693.conf &amp;
</span></span><span style="display:flex;"><span>$ /opt/apps/redis/bin/redis-server /opt/conf/redis-conf/re_17694.conf &amp;
</span></span><span style="display:flex;"><span>$ /opt/apps/redis/bin/redis-server /opt/conf/redis-conf/re_17695.conf &amp;</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->在每个<!-- raw HTML omitted --><code>redis</code><!-- raw HTML omitted -->节点的<!-- raw HTML omitted --><code>redis.conf</code><!-- raw HTML omitted -->文件中，我们都配置了<!-- raw HTML omitted --><code>cluster-config-file</code><!-- raw HTML omitted -->的文件路径，集群启动时<!-- raw HTML omitted --><code>conf</code><!-- raw HTML omitted -->目录会新生成 集群 节点配置文件。查看文件列表如下：<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install tree
</span></span><span style="display:flex;"><span>$ tree -L <span style="color:#ae81ff">3</span> .
</span></span><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>├── bin
</span></span><span style="display:flex;"><span>│   ├── redis-benchmark
</span></span><span style="display:flex;"><span>│   ├── redis-check-aof
</span></span><span style="display:flex;"><span>│   ├── redis-check-rdb
</span></span><span style="display:flex;"><span>│   ├── redis-cli
</span></span><span style="display:flex;"><span>│   ├── redis-sentinel -&gt; redis-server
</span></span><span style="display:flex;"><span>│   └── redis-server
</span></span><span style="display:flex;"><span>├── nodes-6379.conf
</span></span><span style="display:flex;"><span>├── redis.conf
</span></span><span style="display:flex;"><span>└── redis-trib.rb</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->配置密码<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ vim /usr/local/rvm/gems/ruby-2.4.6/gems/redis-4.1.3/lib/redis/client.rb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># frozen_string_literal: true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>require_relative <span style="color:#e6db74">&#34;errors&#34;</span>
</span></span><span style="display:flex;"><span>require <span style="color:#e6db74">&#34;socket&#34;</span>
</span></span><span style="display:flex;"><span>require <span style="color:#e6db74">&#34;cgi&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>class Redis
</span></span><span style="display:flex;"><span>class Client
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> DEFAULTS <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>   :url <span style="color:#f92672">=</span>&gt; lambda <span style="color:#f92672">{</span> ENV<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;REDIS_URL&#34;</span><span style="color:#f92672">]</span> <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>   :scheme <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;redis&#34;</span>,
</span></span><span style="display:flex;"><span>   :host <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;127.0.0.1&#34;</span>,
</span></span><span style="display:flex;"><span>   :port <span style="color:#f92672">=</span>&gt; 6379,
</span></span><span style="display:flex;"><span>   :path <span style="color:#f92672">=</span>&gt; nil,
</span></span><span style="display:flex;"><span>   :timeout <span style="color:#f92672">=</span>&gt; 5.0,
</span></span><span style="display:flex;"><span>   :password <span style="color:#f92672">=</span>&gt; Redis,  	<span style="color:#75715e"># 配置密码</span>
</span></span><span style="display:flex;"><span>   :db <span style="color:#f92672">=</span>&gt; 0,
</span></span><span style="display:flex;"><span>   :driver <span style="color:#f92672">=</span>&gt; nil,
</span></span><span style="display:flex;"><span>   :id <span style="color:#f92672">=</span>&gt; nil,
</span></span><span style="display:flex;"><span>   :tcp_keepalive <span style="color:#f92672">=</span>&gt; 0,
</span></span><span style="display:flex;"><span>   :reconnect_attempts <span style="color:#f92672">=</span>&gt; 1,
</span></span><span style="display:flex;"><span>   :reconnect_delay <span style="color:#f92672">=</span>&gt; 0,
</span></span><span style="display:flex;"><span>   :reconnect_delay_max <span style="color:#f92672">=</span>&gt; 0.5,
</span></span><span style="display:flex;"><span>   :inherit_socket <span style="color:#f92672">=</span>&gt; false
</span></span><span style="display:flex;"><span> <span style="color:#f92672">}</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><code>redis-trib</code><!-- raw HTML omitted -->关联集群节点<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->按照从主到从的方式从左到右依次排列 6 个<!-- raw HTML omitted --><code>redis</code><!-- raw HTML omitted -->节点，如果不通两个问题：密码、防火墙<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;yes&#39;</span>|./redis-trib.rb create --replicas <span style="color:#ae81ff">1</span> 192.168.176.142:6379 192.168.176.143:6379 192.168.176.144:6379 192.168.176.145:6379 192.168.176.142:6380 192.168.176.143:6380 192.168.176.144:6380 192.168.176.145:6380  
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; Creating cluster
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; Performing hash slots allocation on <span style="color:#ae81ff">8</span> nodes...
</span></span><span style="display:flex;"><span>Using <span style="color:#ae81ff">4</span> masters:
</span></span><span style="display:flex;"><span>192.168.176.142:6379
</span></span><span style="display:flex;"><span>192.168.176.143:6379
</span></span><span style="display:flex;"><span>192.168.176.144:6379
</span></span><span style="display:flex;"><span>192.168.176.145:6379
</span></span><span style="display:flex;"><span>Adding replica 192.168.176.143:6380 to 192.168.176.142:6379
</span></span><span style="display:flex;"><span>Adding replica 192.168.176.142:6380 to 192.168.176.143:6379
</span></span><span style="display:flex;"><span>Adding replica 192.168.176.145:6380 to 192.168.176.144:6379
</span></span><span style="display:flex;"><span>Adding replica 192.168.176.144:6380 to 192.168.176.145:6379
</span></span><span style="display:flex;"><span>M: 157bd250dd382b95a9289d8b44fd2cfd466fea98 192.168.176.142:6379
</span></span><span style="display:flex;"><span>   slots:0-4095 <span style="color:#f92672">(</span><span style="color:#ae81ff">4096</span> slots<span style="color:#f92672">)</span> master
</span></span><span style="display:flex;"><span>M: c6df79e7c60c03921b69e4d4342507e8d4d2afbd 192.168.176.143:6379
</span></span><span style="display:flex;"><span>   slots:4096-8191 <span style="color:#f92672">(</span><span style="color:#ae81ff">4096</span> slots<span style="color:#f92672">)</span> master
</span></span><span style="display:flex;"><span>M: a463232f96c66cd7f27395253b65d0be8909656e 192.168.176.144:6379
</span></span><span style="display:flex;"><span>   slots:8192-12287 <span style="color:#f92672">(</span><span style="color:#ae81ff">4096</span> slots<span style="color:#f92672">)</span> master
</span></span><span style="display:flex;"><span>M: 44b244a188185835b42d4489eac614e7f81b4cf8 192.168.176.145:6379
</span></span><span style="display:flex;"><span>   slots:12288-16383 <span style="color:#f92672">(</span><span style="color:#ae81ff">4096</span> slots<span style="color:#f92672">)</span> master
</span></span><span style="display:flex;"><span>S: 1cafdeeb6cb52bb96dd16ac84d2242f59973f83a 192.168.176.142:6380
</span></span><span style="display:flex;"><span>   replicates c6df79e7c60c03921b69e4d4342507e8d4d2afbd
</span></span><span style="display:flex;"><span>S: a6d87fb995f3f5e98e2a09f4b5a3078f7221a257 192.168.176.143:6380
</span></span><span style="display:flex;"><span>   replicates 157bd250dd382b95a9289d8b44fd2cfd466fea98
</span></span><span style="display:flex;"><span>S: 31a3f0b03244d30bbc7e47acc0ec06d327b62860 192.168.176.144:6380
</span></span><span style="display:flex;"><span>   replicates 44b244a188185835b42d4489eac614e7f81b4cf8
</span></span><span style="display:flex;"><span>S: fc22025eb5db7cc0d55fe7dc11a3c368daa468bb 192.168.176.145:6380
</span></span><span style="display:flex;"><span>   replicates a463232f96c66cd7f27395253b65d0be8909656e
</span></span><span style="display:flex;"><span>Can I set the above configuration? <span style="color:#f92672">(</span>type <span style="color:#e6db74">&#39;yes&#39;</span> to accept<span style="color:#f92672">)</span>: yes     <span style="color:#75715e">#此处输入：yes、然后redis-trib.rb 开始执行 节点握手 和 槽分配 操作，输出如下：</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; Nodes configuration updated
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; Assign a different config epoch to each node
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster
</span></span><span style="display:flex;"><span>Waiting <span style="color:#66d9ef">for</span> the cluster to join....
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; Performing Cluster Check <span style="color:#f92672">(</span>using node 192.168.176.142:6379<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>M: 157bd250dd382b95a9289d8b44fd2cfd466fea98 192.168.176.142:6379
</span></span><span style="display:flex;"><span>   slots:0-4095 <span style="color:#f92672">(</span><span style="color:#ae81ff">4096</span> slots<span style="color:#f92672">)</span> master
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">1</span> additional replica<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>S: 31a3f0b03244d30bbc7e47acc0ec06d327b62860 192.168.176.144:6380
</span></span><span style="display:flex;"><span>   slots: <span style="color:#f92672">(</span><span style="color:#ae81ff">0</span> slots<span style="color:#f92672">)</span> slave
</span></span><span style="display:flex;"><span>   replicates 44b244a188185835b42d4489eac614e7f81b4cf8
</span></span><span style="display:flex;"><span>M: a463232f96c66cd7f27395253b65d0be8909656e 192.168.176.144:6379
</span></span><span style="display:flex;"><span>   slots:8192-12287 <span style="color:#f92672">(</span><span style="color:#ae81ff">4096</span> slots<span style="color:#f92672">)</span> master
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">1</span> additional replica<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>M: 44b244a188185835b42d4489eac614e7f81b4cf8 192.168.176.145:6379
</span></span><span style="display:flex;"><span>   slots:12288-16383 <span style="color:#f92672">(</span><span style="color:#ae81ff">4096</span> slots<span style="color:#f92672">)</span> master
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">1</span> additional replica<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>S: fc22025eb5db7cc0d55fe7dc11a3c368daa468bb 192.168.176.145:6380
</span></span><span style="display:flex;"><span>   slots: <span style="color:#f92672">(</span><span style="color:#ae81ff">0</span> slots<span style="color:#f92672">)</span> slave
</span></span><span style="display:flex;"><span>   replicates a463232f96c66cd7f27395253b65d0be8909656e
</span></span><span style="display:flex;"><span>M: c6df79e7c60c03921b69e4d4342507e8d4d2afbd 192.168.176.143:6379
</span></span><span style="display:flex;"><span>   slots:4096-8191 <span style="color:#f92672">(</span><span style="color:#ae81ff">4096</span> slots<span style="color:#f92672">)</span> master
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">1</span> additional replica<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>S: a6d87fb995f3f5e98e2a09f4b5a3078f7221a257 192.168.176.143:6380
</span></span><span style="display:flex;"><span>   slots: <span style="color:#f92672">(</span><span style="color:#ae81ff">0</span> slots<span style="color:#f92672">)</span> slave
</span></span><span style="display:flex;"><span>   replicates 157bd250dd382b95a9289d8b44fd2cfd466fea98
</span></span><span style="display:flex;"><span>S: 1cafdeeb6cb52bb96dd16ac84d2242f59973f83a 192.168.176.142:6380
</span></span><span style="display:flex;"><span>   slots: <span style="color:#f92672">(</span><span style="color:#ae81ff">0</span> slots<span style="color:#f92672">)</span> slave
</span></span><span style="display:flex;"><span>   replicates c6df79e7c60c03921b69e4d4342507e8d4d2afbd
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>OK<span style="color:#f92672">]</span> All nodes agree about slots configuration.
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; Check <span style="color:#66d9ef">for</span> open slots...
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; Check slots coverage...
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>OK<span style="color:#f92672">]</span> All <span style="color:#ae81ff">16384</span> slots covered.</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><code>redis</code><!-- raw HTML omitted -->集群完整性检<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->使用<code>redis-trib.rb check</code>命令检测之前创建的 两个集群 是否成功，<code>check</code>命令只需要给出集群中 任意一个节点地址 就可以完成 整个集群 的 检查工作，命令如下：<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ./redis-trib.rb check 192.168.176.145:6379 
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; Performing Cluster Check <span style="color:#f92672">(</span>using node 192.168.176.142:6379<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>M: 157bd250dd382b95a9289d8b44fd2cfd466fea98 192.168.176.142:6379
</span></span><span style="display:flex;"><span>   slots:0-4095 <span style="color:#f92672">(</span><span style="color:#ae81ff">4096</span> slots<span style="color:#f92672">)</span> master
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">1</span> additional replica<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>S: 31a3f0b03244d30bbc7e47acc0ec06d327b62860 192.168.176.144:6380
</span></span><span style="display:flex;"><span>   slots: <span style="color:#f92672">(</span><span style="color:#ae81ff">0</span> slots<span style="color:#f92672">)</span> slave
</span></span><span style="display:flex;"><span>   replicates 44b244a188185835b42d4489eac614e7f81b4cf8
</span></span><span style="display:flex;"><span>M: a463232f96c66cd7f27395253b65d0be8909656e 192.168.176.144:6379
</span></span><span style="display:flex;"><span>   slots:8192-12287 <span style="color:#f92672">(</span><span style="color:#ae81ff">4096</span> slots<span style="color:#f92672">)</span> master
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">1</span> additional replica<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>M: 44b244a188185835b42d4489eac614e7f81b4cf8 192.168.176.145:6379
</span></span><span style="display:flex;"><span>   slots:12288-16383 <span style="color:#f92672">(</span><span style="color:#ae81ff">4096</span> slots<span style="color:#f92672">)</span> master
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">1</span> additional replica<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>S: fc22025eb5db7cc0d55fe7dc11a3c368daa468bb 192.168.176.145:6380
</span></span><span style="display:flex;"><span>   slots: <span style="color:#f92672">(</span><span style="color:#ae81ff">0</span> slots<span style="color:#f92672">)</span> slave
</span></span><span style="display:flex;"><span>   replicates a463232f96c66cd7f27395253b65d0be8909656e
</span></span><span style="display:flex;"><span>M: c6df79e7c60c03921b69e4d4342507e8d4d2afbd 192.168.176.143:6379
</span></span><span style="display:flex;"><span>   slots:4096-8191 <span style="color:#f92672">(</span><span style="color:#ae81ff">4096</span> slots<span style="color:#f92672">)</span> master
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">1</span> additional replica<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>S: a6d87fb995f3f5e98e2a09f4b5a3078f7221a257 192.168.176.143:6380
</span></span><span style="display:flex;"><span>   slots: <span style="color:#f92672">(</span><span style="color:#ae81ff">0</span> slots<span style="color:#f92672">)</span> slave
</span></span><span style="display:flex;"><span>   replicates 157bd250dd382b95a9289d8b44fd2cfd466fea98
</span></span><span style="display:flex;"><span>S: 1cafdeeb6cb52bb96dd16ac84d2242f59973f83a 192.168.176.142:6380
</span></span><span style="display:flex;"><span>   slots: <span style="color:#f92672">(</span><span style="color:#ae81ff">0</span> slots<span style="color:#f92672">)</span> slave
</span></span><span style="display:flex;"><span>   replicates c6df79e7c60c03921b69e4d4342507e8d4d2afbd
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>OK<span style="color:#f92672">]</span> All nodes agree about slots configuration.
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; Check <span style="color:#66d9ef">for</span> open slots...
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; Check slots coverage...
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>OK<span style="color:#f92672">]</span> All <span style="color:#ae81ff">16384</span> slots covered.</span></span></code></pre></div></blockquote>
<hr>
<h3 id="redis-sentinel模式"><code>Redis Sentinel</code>模式</h3>
<blockquote>
<ul>
<li><code>Redis Sentinel</code>哨兵模式</li>
<li><!-- raw HTML omitted -->节点-1<!-- raw HTML omitted --><code>sentinel_16380.conf</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>protected-mode no
</span></span><span style="display:flex;"><span>bind 192.168.176.131  	<span style="color:#75715e"># 本机IP</span>
</span></span><span style="display:flex;"><span>port <span style="color:#ae81ff">16380</span>
</span></span><span style="display:flex;"><span>daemonize yes
</span></span><span style="display:flex;"><span>sentinel monitor master 192.168.176.131 <span style="color:#ae81ff">6379</span> <span style="color:#ae81ff">2</span>  	<span style="color:#75715e"># 主IP与端口号</span>
</span></span><span style="display:flex;"><span>sentinel down-after-milliseconds master <span style="color:#ae81ff">5000</span>  	<span style="color:#75715e"># 指定主节点应答哨兵sentinel的最大时间间隔，超过这个时间，哨兵主观上认为主节点下线，默认30秒</span>
</span></span><span style="display:flex;"><span>sentinel failover-timeout master <span style="color:#ae81ff">180000</span>  	<span style="color:#75715e"># 故障转移的超时时间failover-timeout，默认三分钟，可以用在以下这些方面</span>
</span></span><span style="display:flex;"><span>sentinel parallel-syncs master <span style="color:#ae81ff">1</span>  	<span style="color:#75715e"># 指定了在发生failover主备切换时，最多可以有多少个slave同时对新的master进行同步。这个数字越小，完成failover所需的时间就越长；反之，但是如果这个数字越大，就意味着越多的slave因为replication而不可用。可以通过将这个值设为1，来保证每次只有一个slave，处于不能处理命令请求的状态。</span>
</span></span><span style="display:flex;"><span>sentinel auth-pass master <span style="color:#ae81ff">123456</span>  	<span style="color:#75715e"># 当在Redis实例中开启了requirepass &lt;foobared&gt;，所有连接Redis实例的客户端都要提供密码</span>
</span></span><span style="display:flex;"><span>logfile /var/log/redis/sentinel_16380.log</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->节点2~3<!-- raw HTML omitted --><code>centinel_16380.conf </code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>protected-mode no
</span></span><span style="display:flex;"><span>bind 192.168.176.132  	<span style="color:#75715e"># 此处修改为本机IP</span>
</span></span><span style="display:flex;"><span>port <span style="color:#ae81ff">16380</span>
</span></span><span style="display:flex;"><span>daemonize yes
</span></span><span style="display:flex;"><span>sentinel monitor master 192.168.176.131 <span style="color:#ae81ff">6379</span> <span style="color:#ae81ff">2</span>  	<span style="color:#75715e"># 主IP与端口号</span>
</span></span><span style="display:flex;"><span>sentinel down-after-milliseconds master <span style="color:#ae81ff">5000</span>
</span></span><span style="display:flex;"><span>sentinel failover-timeout master <span style="color:#ae81ff">180000</span>
</span></span><span style="display:flex;"><span>sentinel parallel-syncs master <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>sentinel auth-pass master <span style="color:#ae81ff">123456</span>
</span></span><span style="display:flex;"><span>logfile /var/log/redis/sentinel_16380.log</span></span></code></pre></div></blockquote>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_cassandra">Install_Cassandra</h1>

<h2 id="cassandra"><code>Cassandra</code></h2>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://cassandra.apache.org/doc/latest/cassandra/getting_started/index.html" rel="external" target="_self">开源<code>NoSQL</code>数据库<code>Cassandra</code></a></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_aerospike">Install_Aerospike</h1>

<h2 id="aerospike"><code>Aerospike</code></h2>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://aerospike.com/" rel="external" target="_self"><code>Aerospike</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://docs.aerospike.com/server/operations/install" rel="external" target="_self"><code>Aerospike</code>安装文档</a></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="configure_redis">Configure_Redis</h1>

<h2 id="编写启动文件">编写启动文件</h2>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://juejin.cn/post/6844903661223542792" rel="external" target="_self">深入剖析<code>Redis</code>系列</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.cnblogs.com/kismetv/p/9137897.html" rel="external" target="_self">深入学习<code>Redis</code>持久化</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.cnblogs.com/hopeofthevillage/p/11535683.html" rel="external" target="_self"><code>Redis</code>集群增加节点和删除节点</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/tair-opensource/RedisShake" rel="external" target="_self"><code>RedisShake</code></a>、<a href="https://github.com/tair-opensource/RedisShake/releases/download/v4.1.1/redis-shake-linux-amd64.tar.gz" rel="external" target="_self">redis-shake-linux-amd64.tar.gz</a></td>
<td><code>Redis</code>迁移工具</td>
</tr>
<tr>
<td><a href="https://www.volcengine.com/docs/6293/78099" rel="external" target="_self"><code>redis-shake</code>使用<code>RDB</code>文件迁移数据</a></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h3 id="redis桌面连接工具"><code>Redis</code>桌面连接工具</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>https://github.com/uglide/RedisDesktopManager/releases/tag/0.8.8  	<span style="color:#75715e"># 下载客户端连接工具 Redis 0.8.8  </span>
</span></span><span style="display:flex;"><span>https://github.com/uglide/RedisDesktopManager/releases/tag/0.9.3  	<span style="color:#75715e"># 下载客户端连接工具 Redis 0.9.3</span>
</span></span><span style="display:flex;"><span>https://github.com/qishibo/AnotherRedisDesktopManager/releases  	<span style="color:#75715e"># windows系统远程连接工具</span>
</span></span><span style="display:flex;"><span>https://github.com/quick123official/quick_redis_blog/releases </span></span></code></pre></div></blockquote>
<hr>
<h3 id="redis常用命令"><code>Redis</code>常用命令</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 查看Redis具体IP连接数 </span>
</span></span><span style="display:flex;"><span>$ netstat -n |grep <span style="color:#ae81ff">17693</span> |awk <span style="color:#e6db74">&#39;/^tcp/ {print $5}&#39;</span>| awk -F: <span style="color:#e6db74">&#39;{print $1}&#39;</span>|sort | uniq -c | sort -rn
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 统计Redis在线人数</span>
</span></span><span style="display:flex;"><span>$ redis-cli -h 127.0.0.1 -p <span style="color:#ae81ff">6379</span> -c -a <span style="color:#e6db74">&#34;password&#34;</span> KEYS SPORTS:session:* 2&lt;/dev/null | awk <span style="color:#e6db74">&#34;{print </span>$2<span style="color:#e6db74">}&#34;</span>| awk -F<span style="color:#e6db74">&#34;:&#34;</span> <span style="color:#e6db74">&#39; {print $2,$3}&#39;</span>| sed -e <span style="color:#e6db74">&#34;s/^/</span><span style="color:#e6db74">${</span>date<span style="color:#e6db74">}</span><span style="color:#e6db74">: /g&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; type 键值  	<span style="color:#75715e">#  查看值的类型</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; HGET  	<span style="color:#75715e"># 获取键值数据</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; HGETALL  	<span style="color:#75715e"># 获取键值数据</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; CONFIG GET databases  	<span style="color:#75715e"># 数据库的数量</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; INFO keyspace  	<span style="color:#75715e"># 使用以下命令列出定义了某些键的数据库</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; SELECT <span style="color:#ae81ff">14</span>  	<span style="color:#75715e"># 切换14db</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; info clients  	<span style="color:#75715e"># 查看客户端连接</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; client list  	<span style="color:#75715e"># 列出所有连接</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; CONFIG GET maxclients  	<span style="color:#75715e"># 获取支持最大连接数</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; save  <span style="color:#75715e"># 收到触发rdb存储数据</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; CONFIG SET appendonly yes  <span style="color:#75715e"># 动态配置</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; save
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; shutdown save <span style="color:#75715e"># 安全退出并存储数据</span>
</span></span><span style="display:flex;"><span>not connected&gt; </span></span></code></pre></div><p><a href="#R-image-fc3046f0cd230245890cb00969cd8166" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Redis_Server/Snipaste_2022-07-01_13-19-44.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-fc3046f0cd230245890cb00969cd8166"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Redis_Server/Snipaste_2022-07-01_13-19-44.png"></a></p>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          </section>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="rsyncd">Rsyncd</h1>


            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Rsyncd</h1>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_timesyncd">Install_TimeSyncd</h1>

<h2 id="部署时间同步服务">部署时间同步服务</h2>
<h3 id="部署ntp时间同步服务">部署<code>NTP</code>时间同步服务</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->下载安装包、解压、配置、安装<!-- raw HTML omitted --><a href="http://www.ntp.org/" rel="external" target="_self"><code>NTP</code>官网</a></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /usr/local/src/
</span></span><span style="display:flex;"><span>$ curl -O https://www.eecis.udel.edu/~ntp/ntp_spool/ntp4/ntp-4.2.8p13.tar.gz
</span></span><span style="display:flex;"><span>$ tar zxvf ntp-4.2.8p13.tar.gz
</span></span><span style="display:flex;"><span>$ cd ntp-4.2.8p13
</span></span><span style="display:flex;"><span>$ ./configure --prefix<span style="color:#f92672">=</span>/usr/local/ntp --enable-all-clocks --enable-parse-clocks
</span></span><span style="display:flex;"><span>$ make <span style="color:#f92672">&amp;&amp;</span> make install
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 注：如以上下载地址无法访问,请从ntp官方手动下载：http://www.ntp.org/downloads.html</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>ntp.conf</code><!-- raw HTML omitted -->配置文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>restrict default nomodify notrap noquery</code><!-- raw HTML omitted -->替换为<!-- raw HTML omitted --><code>restrict default nomodify</code><!-- raw HTML omitted -->允许任何客户机<!-- raw HTML omitted --><code>IP</code><!-- raw HTML omitted -->进行时间同步<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->在<!-- raw HTML omitted --><code>restrict default nomodify notrap noquery</code><!-- raw HTML omitted -->默认拒绝所有之后增加一行：<!-- raw HTML omitted --><code>restrict 192.168.18.0 mask 255.255.255.0 nomodify</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ vim /etc/ntp.conf
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 方式一、使用域名连接，要经过DNS解析，速度慢。</span>
</span></span><span style="display:flex;"><span>ntpdate pool.ntp.org
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 方式二、使用IP连接，超级快。</span>
</span></span><span style="display:flex;"><span>ntpdate 120.24.81.91</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->以守护进程启动<!-- raw HTML omitted --><code>ntpd</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>ntpd</code><!-- raw HTML omitted -->启动后，客户机要等几分钟再与其进行时间同步，否则会提示<!-- raw HTML omitted --><code>no server suitable for synchronization found</code><!-- raw HTML omitted -->错误<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /usr/local/ntp/bin/ntpd -c /etc/ntp.conf -p /tmp/ntpd.pid</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->在客户机器配置计划任务<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->每天的5点13分、9点13分、14点13分、19点13分与时间同步服务器进行同步<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum install -y ntpdate
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;13 5,9,14,19 * * * /usr/sbin/ntpdate 192.168.18.2&#34;</span> &gt;&gt;/var/spool/cron/root</span></span></code></pre></div></blockquote>
<hr>
<h3 id="部署chrony时间同步服务将替代ntp服务">部署<code>Chrony</code>时间同步服务。将替代<code>NTP</code>服务</h3>
<ul>
<li>
<ol>
<li><a href="https://chrony.tuxfamily.org/" rel="external" target="_self"><code>Chrony</code></a></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install chrony
</span></span><span style="display:flex;"><span>$ systemctl enable chronyd.service <span style="color:#f92672">&amp;&amp;</span> systemctl start chronyd.service</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_rsync">Install_Rsync</h1>

<h2 id="rsync部署"><code>Rsync</code>部署</h2>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->注意：<!-- raw HTML omitted -->两台服务器<!-- raw HTML omitted -->都需要安装<!-- raw HTML omitted --><code>Rsync</code><!-- raw HTML omitted -->服务， 只启动源服务器上的<!-- raw HTML omitted --><code>Rsync</code></li>
</ul>
<table>
<thead>
<tr>
<th>选项</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-a</code></td>
<td>包含：<code>-rtplgoD</code> 等选项</td>
</tr>
<tr>
<td><code>-r</code></td>
<td>同步目录选项</td>
</tr>
<tr>
<td><code>-v</code></td>
<td>显示同步的目录文件信息</td>
</tr>
<tr>
<td><code>-l</code></td>
<td>保留软连接</td>
</tr>
<tr>
<td><code>-L</code></td>
<td>同步软链接时把源文件也给同步</td>
</tr>
<tr>
<td><code>-p</code></td>
<td>保持文件权限属性</td>
</tr>
<tr>
<td><code>-o</code></td>
<td>保持文件属主</td>
</tr>
<tr>
<td><code>-g</code></td>
<td>保持文件属组</td>
</tr>
<tr>
<td><code>-D</code></td>
<td>保持设备文件信息</td>
</tr>
<tr>
<td><code>-t</code></td>
<td>保持文件时间属性</td>
</tr>
<tr>
<td><code>-delete</code></td>
<td>删除<!-- raw HTML omitted -->目标服务器<!-- raw HTML omitted -->目录中<!-- raw HTML omitted -->源服务器<!-- raw HTML omitted -->没有的文件</td>
</tr>
<tr>
<td><code>-exclude</code></td>
<td>忽略不需要同步的目录文件</td>
</tr>
<tr>
<td><code>-P</code></td>
<td>显示同步过程，速率等，比<code>-v</code>更加详细</td>
</tr>
<tr>
<td><code>-u</code></td>
<td>如果<!-- raw HTML omitted -->目标服务器<!-- raw HTML omitted -->比<!-- raw HTML omitted -->源服务器<!-- raw HTML omitted -->目录文件新<!-- raw HTML omitted -->则不同步<!-- raw HTML omitted --></td>
</tr>
<tr>
<td><code>-z</code></td>
<td>同步时压缩目录文件</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h3 id="源服务器">源服务器</h3>
<blockquote>
<ul>
<li></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;username:password&#34;</span> &gt;&gt;/etc/rsyncd.namelist  	<span style="color:#75715e"># 创建一个虚拟用户密码</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/etc/rsyncd.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># sample rsyncd.conf configuration file
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># GLOBAL OPTIONS 全局配置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># motd file=/etc/motd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># log file=/var/log/rsyncd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># for pid file, do not use /var/run/rsync.pid if
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># you are going to run rsync out of the init.d script.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># The init.d script does its own pid file handling,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># so omit the &#34;pid file&#34; line completely in that case.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># pid file=/var/run/rsyncd.pid
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># syslog facility=daemon
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># socket options=
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># MODULE OPTIONS 按组配置选项
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[ftp]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	comment = public archive
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# 要同步的目录
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	path = /var/www/pub
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	use chroot = yes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # max connections=10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	lock file = /var/lock/rsyncd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # 默认只读，如果源要推送目录文件到目标服务器， 目标服务器上需要修改为：
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	read only = yes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	list = yes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	uid = nobody
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	gid = nogroup
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# exclude = 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# exclude from = 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# include =
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# include from =
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# 授权访问的用户名
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# auth users = username
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# 授权访问的用户的密码文件
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# secrets file = /etc/rsyncd.secrets
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	strict modes = yes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# hosts allow =
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# hosts deny =
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	ignore errors = no
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	ignore nonreadable = yes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	transfer logging = no
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	# log format = %t: host %h (%a) %o %f (%l bytes). Total %b bytes.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	timeout = 600
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	refuse options = checksum dry-run
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	dont compress = *.gz *.tgz *.zip *.z *.rpm *.deb *.iso *.bz2 *.tbz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 权限一定要限制为最小，</span>
</span></span><span style="display:flex;"><span>$ chmod <span style="color:#ae81ff">600</span> /etc/rsyncd.namelist
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kill进程重启</span>
</span></span><span style="display:flex;"><span>$ kill -9 rsync
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 依后台运行方式启动</span>
</span></span><span style="display:flex;"><span>$ rsync --daemon</span></span></code></pre></div></blockquote>
<hr>
<h3 id="目标服务器">目标服务器</h3>
<blockquote>
<ul>
<li>查看源服务器下目录资源</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rsync --list-only 源服务器IP::ftp/  	<span style="color:#75715e"># ftp 为组名</span></span></span></code></pre></div><ul>
<li>同步源目录下资源</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rsync -avz 源服务器IP::ftp/ /usr/local/nginx/html</span></span></code></pre></div><ul>
<li>使用用户密码方式查看源服务器资源</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rsync --list-only username@源服务器IP::ftp/  	<span style="color:#75715e"># ftp 为组名</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 客户端保存密码</span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;password&#34;</span> &gt;&gt;/etc/rsyncd.passwordlist 
</span></span><span style="display:flex;"><span>$ chmod <span style="color:#ae81ff">600</span> /etc/rsyncd.passwordlist 
</span></span><span style="display:flex;"><span>$ rsync --list-only --password-file<span style="color:#f92672">=</span>/etc/rsyncd.passwordlist username@源服务器IP::ftp/  	<span style="color:#75715e"># ftp 为组名</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="安装配置inotify时时检测服务">安装配置<code>Inotify</code>时时检测服务</h3>
<blockquote>
<ul>
<li>
<ol>
<li>安装以及配置监控目录</li>
</ol>
</li>
</ul>
<table>
<thead>
<tr>
<th>选项</th>
<th>完整参数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-r</code></td>
<td><code>--recursive</code></td>
<td>递归查询目录</td>
</tr>
<tr>
<td><code>-q</code></td>
<td><code>--qulet</code></td>
<td>只打印监控事件信息</td>
</tr>
<tr>
<td><code>-m</code></td>
<td><code>--monitor</code></td>
<td>始终保持监控状态</td>
</tr>
<tr>
<td><code>--excludel</code></td>
<td></td>
<td>排除文件或目录，不区分大小写</td>
</tr>
<tr>
<td><code>--timefmt</code></td>
<td></td>
<td>指定事件输出格式</td>
</tr>
<tr>
<td><code>--format</code></td>
<td></td>
<td>使用指定的输出类似字符串格式</td>
</tr>
<tr>
<td><code>-e</code></td>
<td>`&ndash;event[-e</td>
<td>&ndash;event &hellip;]accessmodifyattrb`</td>
</tr>
</tbody>
</table>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget https://github.com/inotify-tools/inotify-tools/releases/download/3.20.2.2/inotify-tools-3.20.2.2.tar.gz
</span></span><span style="display:flex;"><span>$ tar zxvf inotify-tools-3.20.2.2.tar.gz
</span></span><span style="display:flex;"><span>$ cd inotify-tools-3.20.2.2/
</span></span><span style="display:flex;"><span>$ ./configure --prefix<span style="color:#f92672">=</span>/usr/local/inotify
</span></span><span style="display:flex;"><span>$ make <span style="color:#f92672">&amp;&amp;</span> make install
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 监控目录</span>
</span></span><span style="display:flex;"><span>$ inotifywait -mrq --timefmt <span style="color:#e6db74">&#39;%Y-%m-%d %H:%M:%S&#39;</span> --format <span style="color:#e6db74">&#39;%T %w%f %e&#39;</span> -e close_write,modify,delete,create,attrib,move //usr/local/nginx/html/</span></span></code></pre></div><ul>
<li>使用脚本监控</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;inotifywait_rsync.sh<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 监控目录， 有变化推送到目标服务器
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">inotifywait -mrq --timefmt &#39;%Y-%m-%d %H:%M:%S&#39; --format &#39;%T %w%f %e&#39; -e close_write,modify,delete,create,attrib,move //usr/local/nginx/html/ | while read file
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">do
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     rsync -az --delete --password-file=/etc/rsyncd.passwordlist /usr/local/nginx/html username@源服务器IP::ftp/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">done
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_lsyncd">Install_Lsyncd</h1>

<h2 id="lsyncd部署"><code>Lsyncd</code>部署</h2>
<blockquote>
<ul>
<li>**<code>Lsyncd</code>**是一个实时文件同步工具，它可以监视指定的目录树，一旦文件发生变化（如创建、修改、删除），就会立即将这些变化同步到另一个目标位置。它主要用于在多个服务器之间保持文件夹内容同步，并且可以实现高效的增量同步</li>
<li><strong>主要特点和用途：</strong></li>
</ul>
<blockquote>
<ul>
<li>
<p><strong>实时监控和同步</strong>：</p>
<p><code>Lsyncd</code>使用轮询或文件系统的通知机制（如<code>inotify</code>）来实时监控文件系统的变化。</p>
<p>当监控的目录发生变化时，它可以快速响应并将变更内容同步到目标位置。</p>
</li>
<li>
<p><strong>增量同步</strong>：</p>
<p><code>Lsyncd</code>不会简单地全量复制文件，而是通过增量方式同步文件变更，提高了同步效率。</p>
</li>
<li>
<p><strong>灵活的配置</strong>：</p>
<p>可以通过简单的配置文件定义监控源目录和目标位置，以及定义同步规则和行为。</p>
<p>支持通过<code>Lua</code>脚本来自定义处理逻辑，如过滤器、排除规则等。</p>
</li>
<li>
<p><strong>跨平台支持</strong>：</p>
<p><code>Lsyncd</code>可以运行在多种操作系统上，包括<code>Linux</code>、<code>BSD</code>和<code>macOS</code>等。</p>
</li>
<li>
<p><strong>高可靠性和可扩展性</strong>：</p>
<p><code>Lsyncd</code>设计用于高可靠性的文件同步，可以处理大量的文件系统变更和同步任务。</p>
<p>可以配置成为集群环境下的一部分，以实现更复杂的同步和备份策略。</p>
</li>
</ul>
</blockquote>
<ul>
<li><strong>使用场景：</strong></li>
</ul>
<blockquote>
<ul>
<li>
<p><strong>分布式系统的文件同步</strong>：</p>
<p>在多台服务器之间同步重要文件，确保文件内容的一致性和可用性。</p>
</li>
<li>
<p><strong>实时备份和数据保护</strong>：</p>
<p>将重要数据即时备份到另一个位置，以应对意外数据丢失或损坏的情况。</p>
</li>
<li>
<p><strong>网站和应用程序部署</strong>：</p>
<p>在不同的服务器上部署相同的网站或应用程序代码，确保所有服务器上的内容始终保持同步。</p>
</li>
</ul>
</blockquote>
</blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->安装扩展工具<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install expect epel-release lsyncd</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->生成密钥实现绵密登录<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ssh-keygen -t rsa -P <span style="color:#e6db74">&#34;&#34;</span> -f ~/.ssh/id_rsa  	<span style="color:#75715e"># -t指定SSH密钥的算法为RSA算法，-P设置密码为空，-f指定生成的密钥文件存放位置</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>expect</code><!-- raw HTML omitted -->工具使脚本推送密钥<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ expect <span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spawn ssh-copy-id myadmin@$IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">expect &#34;(yes/no)?&#34; {send &#34;yes\r&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">expect &#34;password:&#34; {send &#34;$passwd\r&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">expect &#34;#&#34; {send &#34;exit\r&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->给予普通用户授权，使普通用户可以使用<!-- raw HTML omitted --><code>Lsyncd</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;#####  	Start/Stop Service  	#####
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Cmnd_Alias MYADMIN_START_SERVICES = /etc/lsyncd.conf, /usr/bin/lsyncd, /bin/rsync, /var/log/lsyncd/*
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">myadmin ALL=(ALL)NOPASSWD:MYADMIN_START_SERVICES 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span> &gt;&gt;/etc/sudoers.d/myadmin
</span></span><span style="display:flex;"><span>$ chmod <span style="color:#ae81ff">660</span> /etc/sudoers.d/myadmin</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->编写<!-- raw HTML omitted --><code>Lsyncd.conf</code><!-- raw HTML omitted -->文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;--insist：继续运行，即使有失败的目标。
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--statusInterval：多少秒写入文件，默认是10s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--sync为同步配置，部分参数如下：
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--source：本地文件目录
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--host：远程服务器地址
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--targetdir：远程目标目录
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--port：目前主机SSH端口号，默认为22
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">settings {  --settings为全局配置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> logfile = &#34;</span>/var/log/lsyncd/lsyncd.log<span style="color:#e6db74">&#34;,  --logfile：日志文件路径
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> statusFile = &#34;</span>/var/log/lsyncd/lsyncd.status<span style="color:#e6db74">&#34;, --statusFile：进程路径
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> inotifyMode = &#34;</span>CloseWrite or Modify<span style="color:#e6db74">&#34;,   
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> maxProcesses = 100, --ssh同步修改为&#34;</span>1<span style="color:#e6db74">&#34; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> maxDelays    = 10,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sync {  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> default.rsyncssh,  --# ssh同步方式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> source = &#34;</span>/opt/backup<span style="color:#e6db74">&#34;,  --源服务器目录
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> host=&#34;</span>192.168.40.198<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> targetdir=&#34;</span>/opt/backup/<span style="color:#e6db74">&#34;, --目标服务器目录，源服务器和目标服务器相同
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> delay = 1,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> rsync = {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     binary = &#34;</span>/usr/bin/rsync<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     archive = true,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     compress = false,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     verbose = true,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sync {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> default.rsync,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> source = &#34;</span>/data/nginx/cache<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> target =&#34;</span>root@192.168.32.11:/data/nginx/cache<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> delay  = 1,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> rsync = {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     binary = &#34;</span>/usr/bin/rsync<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     archive = true,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     compress = false,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     verbose = true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">} &#34;</span>&gt;&gt;/etc/lsyncd.conf</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="6">
<li><!-- raw HTML omitted -->给予权限， 启动<!-- raw HTML omitted --><code>Lsyncd</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ chown -R myadmin. /var/log/lsyncd
</span></span><span style="display:flex;"><span>$ lsyncd -nodaemon /etc/lsyncd.conf  	<span style="color:#75715e"># 运行查看下是否有报错  </span>
</span></span><span style="display:flex;"><span>$ systemctl enable lsyncd <span style="color:#f92672">&amp;&amp;</span> systemctl start lsyncd</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          </section>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="script">Script</h1>


            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Script</h1>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="how_to_write_shell_scripts">How_To_Write_Shell_Scripts</h1>

<h2 id="shell脚本编写"><code>Shell</code>脚本编写</h2>
<h3 id="执行方式">执行方式</h3>
<blockquote>
<ul>
<li><code>sh -n bash.sh</code><!-- raw HTML omitted -->调试模式运行：<!-- raw HTML omitted --><code>-n</code></li>
<li><code>sh -vx bash.sh</code><!-- raw HTML omitted -->打印调试模式运行日志：<!-- raw HTML omitted --><code>-vx</code></li>
<li><code>bash</code><!-- raw HTML omitted -->执行环境<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->登录<!-- raw HTML omitted --><code>bash</code><!-- raw HTML omitted -->执行<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>系统级</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>/etc/profile
</span></span><span style="display:flex;"><span>/etc/bashrc</span></span></code></pre></div><ul>
<li>用户级</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>~/.bash_profile
</span></span><span style="display:flex;"><span>~/.bashrc</span></span></code></pre></div></blockquote>
<ul>
<li>退出<code>bash</code>执行</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>~/.bash_history
</span></span><span style="display:flex;"><span>~/.bash_logout</span></span></code></pre></div></blockquote>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->获取文件名<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ basename  	<span style="color:#75715e"># 获取最后文件名: basename /etc/passwd</span>
</span></span><span style="display:flex;"><span>$ dirname  	<span style="color:#75715e"># 获取文件名前缀</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->脚本补全、小游戏<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum install bash-completion  	<span style="color:#75715e"># 脚本补全服务</span>
</span></span><span style="display:flex;"><span>$ sudo apt-get install jq  	<span style="color:#75715e"># 安装json格式查看服务</span>
</span></span><span style="display:flex;"><span>$ yum -y install sl  	<span style="color:#75715e"># 小火车</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ vim scripts.sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>:set ff<span style="color:#f92672">=</span>unix  	<span style="color:#75715e"># 转换换行符</span>
</span></span><span style="display:flex;"><span>:set paste  	<span style="color:#75715e"># 解决文本粘贴后错乱</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->当前执行<!-- raw HTML omitted --><code>shell</code><!-- raw HTML omitted -->脚本以及嵌入其他语言<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ source shell.sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;#!/usr/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo &#34;</span>hello bash<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">. shell.sh  	# 在其他脚本中引用此脚本 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 嵌入python脚本
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/usr/bin/python &lt;&lt;-EOF  #&#34;</span>-<span style="color:#e6db74">&#34;支持Tab键,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">print &#34;</span>hello python<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF &#34;</span>&gt;bash.sh</span></span></code></pre></div></blockquote>
<hr>
<h3 id="crontab计划任务"><code>crontab</code>计划任务</h3>
<blockquote>
<ul>
<li><code>crontab</code>计划任务</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ man crontab
</span></span><span style="display:flex;"><span>@reboot ：重启后运行一次。
</span></span><span style="display:flex;"><span>@yearly ：每年运行一次，即。 “0 <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">1</span> *”。
</span></span><span style="display:flex;"><span>@annually ：每年运行一次，即。 “0 <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">1</span> *”。
</span></span><span style="display:flex;"><span>@monthly ：每月运行一次，即。 “0 <span style="color:#ae81ff">1</span> * *”。
</span></span><span style="display:flex;"><span>@weekly ：每周运行一次，即。 “0 * * 0”。
</span></span><span style="display:flex;"><span>@daily ：每天运行一次，即。 “0 * * *”。
</span></span><span style="display:flex;"><span>@hourly ：每小时运行一次，即。 “* * * *”。
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ls -l /var/spool/cron/root
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ls -l /var/spool/cron/crontabs/root  	<span style="color:#75715e"># Debian系统</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="test条件测试"><code>test</code>条件测试</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ man test</span></span></code></pre></div></blockquote>
<hr>
<h3 id="shell脚本颜色"><code>Shell</code>脚本颜色</h3>
<blockquote>
<ul>
<li>
<p><!-- raw HTML omitted -->若字符串中出现以下字符，则特别加以处理，而不会将它当成一般文字输出需要使用：<!-- raw HTML omitted --><code>-e</code></p>
</li>
<li>
<p><!-- raw HTML omitted -->脚本文字颜色<!-- raw HTML omitted --></p>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>30m:灰色、31m:红色、32m:绿色、33m:黄色、34m:蓝色、35m:紫色、36m:浅蓝色、37m:白色  	<span style="color:#75715e"># 文字颜色 </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ echo -e <span style="color:#e6db74">&#34;\e[1;30m我是灰色 \e[0m&#34;</span>  	<span style="color:#75715e"># 文字色号30~37，&#34;\e[0m&#34;:恢复原本色号 </span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->脚本背景颜色<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>40m:灰色、41m:红色、42m:绿色、43m:黄色、44m:蓝色、45m:紫色、46m:浅蓝色、47m:白色  	<span style="color:#75715e"># 背景颜色</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ echo -e <span style="color:#e6db74">&#34;\e[1;40m我是灰色 \e[0m&#34;</span>  	<span style="color:#75715e"># 背景色号40~47，&#34;\e[0m&#34;:恢复原本色号 </span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->文本格式控制<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>1m:粗体、4m:下划线、7m:反显、25h:显示光标
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo -e <span style="color:#e6db74">&#34;\033[?25h&#34;</span> 显示光标
</span></span><span style="display:flex;"><span>echo -e <span style="color:#e6db74">&#34;\033[?25l&#34;</span> 隐藏光标</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="变量">变量</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>IP<span style="color:#f92672">=</span>192.168.1.1  	<span style="color:#75715e"># 显示赋值</span>
</span></span><span style="display:flex;"><span>echo $IP
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>read -p <span style="color:#e6db74">&#34;请输入 IP: &#34;</span> IP 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 键盘读入赋值: IP:为变量名, 一次性可以定义多个变量名：read -p &#34;请输入你的姓名，年龄，性别: &#34; name age sex  </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>./ping.sh  192.168.1.1  192.168.1.2  
</span></span><span style="display:flex;"><span>$1           $2  <span style="color:#75715e"># 位置变量</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 环境变量(系统变量)</span>
</span></span><span style="display:flex;"><span>设置环境变量
</span></span><span style="display:flex;"><span>export IP<span style="color:#f92672">=</span>192.168.1.1
</span></span><span style="display:flex;"><span>export IP  	<span style="color:#75715e"># 变量名</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># /etc/profile</span>
</span></span><span style="display:flex;"><span>PATH<span style="color:#f92672">=</span>$PATH:/new/bin
</span></span><span style="display:flex;"><span>export PATH
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 自定义变量</span></span></span></code></pre></div></blockquote>
<hr>
<h4 id="变量运算">变量运算</h4>
<ul>
<li>
<ol>
<li>整数运算</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->方式一<!-- raw HTML omitted --><code>expr</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ expr <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">\*</span> <span style="color:#ae81ff">2</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->方式二<!-- raw HTML omitted --><code>$(())</code><!-- raw HTML omitted --># 脚本常用<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#66d9ef">$((</span><span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#ae81ff">2</span><span style="color:#66d9ef">))</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->方式三<!-- raw HTML omitted --><code>let</code><!-- raw HTML omitted -->  # 脚本常用<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>let i++ 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 先赋值,后运算: x=i :x=1、i=2</span>
</span></span><span style="display:flex;"><span>i<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>let x<span style="color:#f92672">=</span>i++
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 先运算,后赋值: ++j :y=2、j=2</span>
</span></span><span style="display:flex;"><span>j<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>let y<span style="color:#f92672">=</span>++j  	</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li>小数运算</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;2*4&#34;</span> |bc
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;2^4&#34;</span> |bc  	<span style="color:#75715e"># bc的次方: ^</span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;scale=2;6/4&#34;</span> |bc
</span></span><span style="display:flex;"><span>$ awk <span style="color:#e6db74">&#39;BEGIN{print 1/2}&#39;</span></span></span></code></pre></div></blockquote>
<hr>
<h4 id="删除替换变量">删除、替换变量</h4>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">#  	# 从头往后删除</span>
</span></span><span style="display:flex;"><span>%  	<span style="color:#75715e"># 从后往头删除</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>:0:3<span style="color:#f92672">}</span>  	<span style="color:#75715e"># 切片</span>
</span></span><span style="display:flex;"><span>/  	<span style="color:#75715e"># 内容替换</span>
</span></span><span style="display:flex;"><span>-  	<span style="color:#75715e"># 变量替代</span>
</span></span><span style="display:flex;"><span>:-  	<span style="color:#75715e">#变量替代，可替代空值、+、:+、=、:=、?、:?、</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 百度域名举例:www.baidu.com</span>
</span></span><span style="display:flex;"><span>url<span style="color:#f92672">=</span>www.baidu.com
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">${</span>url#*.<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>baidu.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">${</span>url#*bai<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>du.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">${</span>url##*.<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>com</span></span></code></pre></div></blockquote>
<hr>
<h3 id="expect使用"><code>expect</code>使用</h3>
<blockquote>
<ul>
<li>**<code>Expect</code>**是一个自动化工具，用于与交互式程序进行交互。它允许你编写脚本来模拟人类用户与程序的交互过程，从而自动化执行那些通常需要人工干预的任务</li>
<li><strong>主要特点和用途：</strong></li>
</ul>
<blockquote>
<ul>
<li>
<p><strong>自动化交互</strong>：</p>
<p><code>Expect</code>脚本可以编写为模拟用户输入和处理程序输出的行为。它通过捕获和分析程序的输出，并根据预定义的规则自动响应，来执行所需的操作。</p>
</li>
<li>
<p><strong>与交互式程序集成</strong>：</p>
<p>适用于需要用户输入或期望特定响应的程序，例如配置管理工具、网络设备配置、数据库管理等。</p>
</li>
<li>
<p><strong>简化复杂任务</strong>：</p>
<p>可以通过<code>Expect</code>自动化执行复杂的系统管理任务，如安装和配置软件、执行备份和恢复操作、模拟用户会话等。</p>
</li>
<li>
<p><strong>基于<code>TCL</code>语言</strong>：</p>
<p><code>Expect</code>的脚本语言基于<code>TCL</code>（<code>Tool Command Language</code>），这使得它结合了<code>TCL</code>的强大编程能力和<code>Expect</code>提供的交互式自动化功能。</p>
</li>
</ul>
</blockquote>
<ul>
<li><strong>使用场景：</strong></li>
</ul>
<blockquote>
<ul>
<li>
<p><strong>系统管理和自动化运维</strong>：</p>
<p>批量配置和管理服务器和网络设备。</p>
</li>
<li>
<p><strong>测试和仿真</strong>：</p>
<p>自动化测试脚本，模拟用户行为以测试程序的交互性。</p>
</li>
<li>
<p><strong>应用程序部署</strong>：</p>
<p>在多个环境中自动化部署和配置应用程序。</p>
</li>
<li>
<p><strong>远程管理</strong>：</p>
<p>通过<code>SSH</code>或<code>Telnet</code>等协议进行远程管理和操作。</p>
</li>
</ul>
</blockquote>
<ul>
<li><strong>示例：</strong></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0"><code class="language-expect" data-lang="expect">#!/usr/bin/expect

set username &#34;your_username&#34;
set password &#34;your_password&#34;
set hostname &#34;remote_host&#34;

spawn ssh $username@$hostname
expect &#34;password:&#34;
send &#34;$password\r&#34;
expect &#34;$ &#34;
send &#34;ls -l\r&#34;
expect &#34;$ &#34;
send &#34;exit\r&#34;
expect eof</code></pre></div></blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;expect.sh<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#!/use/bin/expect
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spawn ssh  root@192.168.1.1  	# spawn:开启一个会话
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">expect {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;yes/no&#34; { send &#34;yes\r&#34;; exp_continue }  	# send:传送参数，\r:回车键, exp_continue:没出现&#34;yes/no&#34;也提交 第二次连接不会出现，
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;password:&#34; { send &#34;密码\r&#34; };
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">interact  	# 停留在被连接系统中
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="运算符使用">运算符使用</h3>
<h4 id="关系数值运算符">关系(数值)运算符</h4>
<blockquote>
<table>
<thead>
<tr>
<th>关系(数值)运算符</th>
<th>说明</th>
<th>举例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-eq</code>、<code>==</code></td>
<td>等于：检测两个数是否相等，相等返回<code>true</code></td>
<td><code>[ $a -eq $b ]</code> 返回：<code>false</code></td>
</tr>
<tr>
<td><code>-ne</code>、<code>!=</code></td>
<td>不等于： 检测两个数是否不相等，不相等返回<code>true</code></td>
<td><code>[ $a -ne $b ]</code> 返回：<code>true</code></td>
</tr>
<tr>
<td><code>-gt</code>、<code>&gt;</code></td>
<td>大于：检测左边的数是否大于右边的数，如果是返回：<code>true</code></td>
<td><code>[ $a -gt $b ]</code> 返回：<code>false</code></td>
</tr>
<tr>
<td><code>-lt</code>、<code>&lt;</code></td>
<td>小于：检测左边的数是否小于右边的，如果是返回：<code>true</code></td>
<td><code>[ $a -lt $b ]</code> 返回：<code>true</code></td>
</tr>
<tr>
<td><code>-ge</code>、<code>&gt;=</code></td>
<td>大于等于：检测左边的数是否大于等于右边的，如果是返回：<code>true</code></td>
<td><code>[ $a -ge $b ]</code> 返回：<code>false</code></td>
</tr>
<tr>
<td><code>-le</code>、<code>&lt;=</code></td>
<td>小于等于：检测左边的数是否小于等于右边的，如果是返回：<code>true</code></td>
<td><code>[ $a -le $b ]</code> 返回：<code>frue</code></td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h4 id="字符串运算符">字符串运算符</h4>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->字符串都用双引号引起来<!-- raw HTML omitted --><code>&quot; &quot;</code></li>
</ul>
<table>
<thead>
<tr>
<th>字符串运算符</th>
<th>说明</th>
<th>举例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>=</code></td>
<td>等于：检测两个字符串是否相等，相等返回：<code>true</code></td>
<td><code>[ &quot;$a&quot; = &quot;$b&quot; ]</code> 返回：<code>false</code></td>
</tr>
<tr>
<td><code>!=</code></td>
<td>不等于：检测两个字符串是否相等，不相等返回：<code>true</code></td>
<td><code>[ &quot;$a&quot; != &quot;$b&quot; ]</code> 返回：<code>true</code></td>
</tr>
<tr>
<td><code>-z</code></td>
<td>表示 0：检测字符串长度是否为0，为0返回：<code>true</code></td>
<td><code>[ -z &quot;$a&quot; ]</code> 返回：<code>false</code></td>
</tr>
<tr>
<td><code>-n</code></td>
<td>表示非0：检测字符串长度是否为0，不为0返回：<code>true</code></td>
<td><code>[ -n &quot;$a&quot; ]</code></td>
</tr>
<tr>
<td><code>$</code></td>
<td>不为空：检测字符串是否为空，不为空返回：<code>true</code></td>
<td><code>[ $a ]</code> 返回：<code>true</code></td>
</tr>
<tr>
<td><code>str</code></td>
<td>检测<code>str</code>是否不是空字符串，如果为空返回：<code>false</code></td>
<td><code>[ $a ]</code> 不是假的</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h4 id="逻辑运算符">逻辑运算符</h4>
<blockquote>
<table>
<thead>
<tr>
<th>逻辑运算符</th>
<th>说明</th>
<th>举例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>&amp;&amp;</code></td>
<td>逻辑的：<code>and</code>，和/并且：的意思</td>
<td><code>[[ $a -lt 100 &amp;&amp; $b -gt 100 ]]</code> 返回：<code>false</code>，<!-- raw HTML omitted --><code>./configure &amp;&amp; make &amp;&amp; make install</code></td>
</tr>
<tr>
<td><code>||</code></td>
<td>逻辑的：<code>or</code>，或者/否则：的意思</td>
<td><code>[[ $a -lt 100 || $b -gt 100 ]]</code> 返回：<code>true</code>，<!-- raw HTML omitted --> <code>cat /opt/a.txt || touch /opt/a.txt</code></td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h4 id="布尔运算符">布尔运算符</h4>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->布尔运算符只有：真(<code>True</code>)/假(<code>False</code>)<!-- raw HTML omitted --></li>
</ul>
<table>
<thead>
<tr>
<th>布尔运算符</th>
<th>说明</th>
<th>举例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>!</code></td>
<td>非：运算符：表达式为<code>true</code>则返回<code>false</code>， 否则返回：<code>true</code></td>
<td><code>[ ! false ]</code> 返回：<code>true</code></td>
</tr>
<tr>
<td><code>-o</code></td>
<td>或：运算符：有一个表达式为：<code>true</code>则返回<code>true</code></td>
<td><code>[ $a -lt 20 -o $b -gt 100 ]</code>， 返回：<code>true</code></td>
</tr>
<tr>
<td><code>-a</code></td>
<td>与：运算符：两个表达式都为：<code>true</code>才返回：<code>true</code></td>
<td><code>[ $a -lt 20 -a $b -gt 100 ]</code>， 返回：<code>false</code></td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h4 id="算数运算符">算数运算符</h4>
<blockquote>
<table>
<thead>
<tr>
<th>算数运算符</th>
<th>说明</th>
<th>举例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>+</code></td>
<td>加法，<code>Python</code><!-- raw HTML omitted -->中支持：字符串、列表、元组合并<!-- raw HTML omitted --></td>
<td><code>expr $a + $b</code>结果为30</td>
</tr>
<tr>
<td><code>-</code></td>
<td>减法，<code>Python</code><!-- raw HTML omitted -->中支持：集合，求差异<!-- raw HTML omitted --></td>
<td><code>expr $a - $b</code>结果为<code>-10</code></td>
</tr>
<tr>
<td><code>*</code></td>
<td>乘法，<code>Python</code><!-- raw HTML omitted -->中支持：字符串、列表、元组，复制<!-- raw HTML omitted --></td>
<td><code>expr $a \* $b</code>结果为200</td>
</tr>
<tr>
<td><code>/</code></td>
<td>除法，<code>Python</code><!-- raw HTML omitted -->中整数相除得到浮点数<code>float</code>，<code>//</code>为整除<!-- raw HTML omitted --></td>
<td><code>expr $b / $a</code>结果为2</td>
</tr>
<tr>
<td><code>%</code></td>
<td>取余(模余)</td>
<td><code>expr $b % $a</code>结果为0</td>
</tr>
<tr>
<td><code>=</code></td>
<td>赋值</td>
<td><code>a=$b</code>将把变量<code>b</code>赋值给<code>a</code></td>
</tr>
<tr>
<td><code>==</code></td>
<td>相等：用于比较两个数字，相同则返回：<code>true</code></td>
<td><code>[ $a == $b ]</code> 返回：<code>false</code></td>
</tr>
<tr>
<td><code>**</code></td>
<td>幂运算，几的次方</td>
<td>2的5次方=<code>2*2</code>=<code>4*2</code>=<code>8*2</code>=<code>16*2</code>=32</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h4 id="文件测试">文件测试</h4>
<blockquote>
<table>
<thead>
<tr>
<th>文件参数</th>
<th>说明</th>
<th>举例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-e</code></td>
<td>如果文件存在则为真</td>
<td>`[ -e dir</td>
</tr>
<tr>
<td><code>-r</code></td>
<td>如果文件存在且当前用户可读则为真，是否可以读取</td>
<td><code>[ -r $file ]</code></td>
</tr>
<tr>
<td><code>-w</code></td>
<td>如果文件存在且当前用户可写则为真，是否有可以写入</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>-x</code></td>
<td>如果文件存在且当前用户可执行则为真，是否有执行权限</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>-s</code></td>
<td>如果文件存在且至少有一个字符则为真</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>-d</code></td>
<td>如果文件存在且为目录则为真</td>
<td><code>[ -d /home ]</code> 是否为目录<!-- raw HTML omitted --><code>[ ! -d /home ]</code> 取反</td>
</tr>
<tr>
<td><code>-f</code></td>
<td>如果文件存在且为普通文件则为真</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>-c</code></td>
<td>如果文件存在且为字符型特殊文件则为真</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>-b</code></td>
<td>如果文件存在且为块特殊文件则为真</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>-g</code></td>
<td>如果文件存在且设置<code>SGID</code>则为真</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>-k</code></td>
<td>如果文件存在且设置了<code>粘着位(Sticky Bit)</code>则为真</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>-p</code></td>
<td>如果文件存在且是：名管道，则为真</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>-u</code></td>
<td>如果文件存在且设置<code>SUID</code>则为真</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>-t</code></td>
<td>如果文件存在且文件描述符已打开并与终端关联则为真</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>-z</code></td>
<td>如果文件存在且大于<code>0</code>则为真</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>-o</code></td>
<td>如果文件存在且当前用户是文件所有者则为真</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>-S</code></td>
<td>如果文件存在且是<code>socket</code>文件则为真</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>-L</code></td>
<td>如果文件存在且是连接文件则为真</td>
<td>&mdash;</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h4 id="传参参数处理">传参参数处理</h4>
<blockquote>
<table>
<thead>
<tr>
<th>参数处理</th>
<th>说明</th>
<th>举例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>$#</code></td>
<td>传入脚本的参数个数</td>
<td><code>[ $# -eq 0 ]</code></td>
</tr>
<tr>
<td><code>$*</code></td>
<td>传入脚本的所有参数</td>
<td>如<code>&quot;$*&quot;</code>用<code>&quot; &quot;</code>括起来的情况，以<code>&quot;$1 $2 ... $n&quot;</code>的形式输出所有参数</td>
</tr>
<tr>
<td><code>$$</code></td>
<td>当前<code>shell</code>的进程号，对于<code>shell</code>脚本，这是它们执行的进程<code>ID</code></td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>$!</code></td>
<td><code>Shell</code>后台运行的最后一个进程<code>Process</code>的<code>PID</code></td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>$@</code></td>
<td>与<code>$*</code>相同，但是使用时加引号，并在引号中返回每个参数，如<code>&quot;$@&quot;</code>用<code>&quot; &quot;</code>括起来，以<code>&quot;$1&quot; &quot;$2&quot; ... &quot;$n&quot;</code>的形式输出所有参数</td>
<td>其中<code>$@</code>与<code>$*</code>正常情况下一样，当在脚本中将<code>$*</code>加上双引号作为<code>“$*”</code>引用时，此时将输入的所有参数当做一个整体字符串对待。比如输入参数有<code>a b c</code>三个参数，则<code>“$*”</code>表示<code>“a b c”</code>一个字符串</td>
</tr>
<tr>
<td><code>$-</code></td>
<td>显示<code>shell</code>使用的当前选项，与<code>set</code>命令功能相同</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>$?</code></td>
<td>显示最后命令退出状态，0表示没有错误，其他任何值表明有错误</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>$0</code></td>
<td>当前脚本文件名</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>$1～$n</code></td>
<td>这些变量对应调用脚本的参数，这里的<code>n</code>是对应于参数位置的正十进制数(第一个参数是<code>$1</code>，第二个参数是<code>$2</code>，依此类推)</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>$#</code></td>
<td>提供给脚本的参数数量</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>$</code></td>
<td>当前运行脚本的进程<code>ID</code>号</td>
<td>&mdash;</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h4 id="printf的转义序列"><code>Printf</code>的转义序列</h4>
<blockquote>
<table>
<thead>
<tr>
<th><code>printf</code>的转义序列</th>
<th>说明</th>
<th>举例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>\a</code></td>
<td>警告字符，通常为<code>ASCII</code>的<code>BEL</code>字符</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>\b</code></td>
<td>后退</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>\c</code></td>
<td>抑制(不显示)输出结果中任何结尾的换行字符(只在<code>%</code>格式指示符控制下的参数字符串中有效)，而且任何留在参数里的字符，任何接下来的参数以及任何留在格式字符串中的字符，都被忽略</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>\f</code></td>
<td>换页<code>formfedd</code></td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>\n</code></td>
<td>换行</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>\r</code></td>
<td>回车<code>Carriage return</code></td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>\t</code></td>
<td>水平制表符，类似：<code>Tab</code>键，四个空格键</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>\v</code></td>
<td>垂直制表符</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>\\</code></td>
<td>一个字面上的反斜杠字符</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>\ddd</code></td>
<td>表示1到3位数八进制值得字符，仅在格式字符串中有效</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>\0ddd</code></td>
<td>表示1到3位得八进制字符</td>
<td>&mdash;</td>
</tr>
</tbody>
</table>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 格式化输出两种方式</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 第一种</span>
</span></span><span style="display:flex;"><span>$ echo -e  <span style="color:#e6db74">&#34;a\tb&#34;</span>，<span style="color:#ae81ff">\t</span>:Tab<span style="color:#f92672">(</span>键<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 第二种</span>
</span></span><span style="display:flex;"><span>$ printf <span style="color:#e6db74">&#34;%-10s %-8s %-4s\n&#34;</span> 姓名 性别 体重kg  
</span></span><span style="display:flex;"><span>$ printf <span style="color:#e6db74">&#34;%-10s %-8s %-4.2f\n&#34;</span> 郭靖 男 66.1234
</span></span><span style="display:flex;"><span>$ printf <span style="color:#e6db74">&#34;%-10s %-8s %-4.2f\n&#34;</span> 杨过 男 48.6543
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>%s %c %d %f  	<span style="color:#75715e"># 都是格式替代符，</span>
</span></span><span style="display:flex;"><span>％s  	<span style="color:#75715e"># 输出一个字符串，</span>
</span></span><span style="display:flex;"><span>％d  	<span style="color:#75715e"># 整型输出，</span>
</span></span><span style="display:flex;"><span>％c  	<span style="color:#75715e"># 输出一个字符，</span>
</span></span><span style="display:flex;"><span>％f  	<span style="color:#75715e"># 输出实数，以小数形式输出。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>%-10s  	<span style="color:#75715e"># 指一个宽度为 10 个字符（- 表示左对齐，没有则表示右对齐），任何字符都会被显示在 10 个字符宽的字符内，如果不足则自动以空格填充，超过也会将内容全部显示出来。</span>
</span></span><span style="display:flex;"><span>%-4.2f  	<span style="color:#75715e"># 指格式化为小数，其中 .2 指保留2位小数。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ printf <span style="color:#e6db74">&#34;\e[?2004l&#34;</span>  	<span style="color:#75715e"># 解决命令行终端复制粘贴出现 0~ 1~ 问题，括号粘贴模式。 或者：reset</span></span></span></code></pre></div></blockquote>
<hr>
<h4 id="运算符描述">运算符描述</h4>
<blockquote>
<table>
<thead>
<tr>
<th>运算符描述</th>
<th>说明</th>
<th>举例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>()</code></td>
<td>改变优先顺序，</td>
<td>小括号子<code>shell</code>中执行命令：<code>(ls)</code></td>
</tr>
<tr>
<td><code>(())</code></td>
<td>数值比较，运算</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>$()</code></td>
<td>命令替换、相当于反撇号: ``</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>$(())</code></td>
<td>整数运算</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>[]</code></td>
<td>条件测试、匹配方括号中任意<code>一个</code>字符</td>
<td><code>[a-z] [0-9] [a-zA-Z0-9] 取反:[^a-zA-Z0-9]</code></td>
</tr>
<tr>
<td><code>[[]]</code></td>
<td>条件测试，支持正则 <code>=~</code></td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>$[]</code></td>
<td>整数运算</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>{}</code></td>
<td>打括号使用方式</td>
<td><code>mkdir -pv /opt/{aaa/{111,222},bbb}、cp nginx.conf{,.bak}、{1..9}</code></td>
</tr>
<tr>
<td><code>${}</code></td>
<td>&mdash;</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>~1</code></td>
<td>的补充</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>!</code></td>
<td>逻辑否定</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>!~</code></td>
<td>逻辑否定：二进制反转（一个补码）</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>&lt;&lt;</code></td>
<td>左移</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>&gt;&gt;</code></td>
<td>右移</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>=~</code></td>
<td>匹配模式</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>&amp;</code></td>
<td><code>Bitwise</code>和</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>^</code></td>
<td>按位&quot;独占或&quot;</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>|</code></td>
<td>按位&quot;包容性&quot; 或</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>++</code></td>
<td>递增</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>---</code></td>
<td>递减</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>*=</code></td>
<td>左侧乘以右侧并更新左侧</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>/=</code></td>
<td>将左侧除以</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>+=</code></td>
<td>将左侧添加到右侧并更新左侧</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>-+</code></td>
<td>将右侧减去左侧并更新左侧</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>^=</code></td>
<td>&ldquo;独占或&quot;左侧到右侧并更新左侧</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>%=</code></td>
<td>左侧除以右侧，余数更新再左侧</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>;</code></td>
<td>执行多个命令</td>
<td><code>cat /etc/passwd; ls</code></td>
</tr>
<tr>
<td><code>\</code></td>
<td>转意符</td>
<td><code>&quot;touch  linux\ nginx、\t:Tab(键)、\n:(换行)、\c:(不换行输出)&quot;</code></td>
</tr>
<tr>
<td><code>true</code></td>
<td>永远返回为真<code>0</code></td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>false</code></td>
<td>永远返回为假<code>1</code></td>
<td>&mdash;</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h4 id="条件语句">条件语句</h4>
<blockquote>
<table>
<thead>
<tr>
<th>条件语句</th>
<th>说明</th>
<th>举例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>if</code></td>
<td>如果什么什么</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>then</code></td>
<td>然后怎么怎么</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>elif</code></td>
<td>其它怎么怎么，<code>elif</code>是<code>if</code>有多个语句条件</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>else</code></td>
<td>否则怎么怎么</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>fi</code></td>
<td>结束：<code>if</code>判断句结束语</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>case</code></td>
<td>循环语句开始定义</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>esac</code></td>
<td>循环语句结束定义</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>while</code></td>
<td>条件为真循环</td>
<td>外循环控制行数，内循环控制列数，内循环小于等于外循环</td>
</tr>
<tr>
<td><code>unitl</code></td>
<td>条件为假循环</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>select</code></td>
<td>循环、查询</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>in</code></td>
<td>在什么什么</td>
<td><code>Python</code><!-- raw HTML omitted -->中支持：字符串、列表、元组、字典，检测元素是否存在，与之相反的是：<!-- raw HTML omitted --><code>not in</code></td>
</tr>
<tr>
<td><code>do</code></td>
<td>做/执行什么什么</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>done</code></td>
<td>结束循环</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>unset</code></td>
<td>删除变量</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>readonly</code></td>
<td>只读变量</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>read</code></td>
<td>读取输入变量名</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>clear</code></td>
<td>删除、清除</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>break</code></td>
<td>跳出整个循环，<code>n</code>指定的第<code>n</code>个封闭循环，退出可以是<code>1、2、3</code></td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>continue</code></td>
<td>当前迭代循环退出</td>
<td>&mdash;</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h4 id="重定向参数">重定向参数</h4>
<blockquote>
<table>
<thead>
<tr>
<th>重定向</th>
<th>说明</th>
<th>举例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command &gt; file</code></td>
<td>将输出重定向到：<code>file</code></td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>command &lt; file</code></td>
<td>将输入重定向到：<code>file</code></td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>command &gt;&gt; file</code></td>
<td>将输出以追加的方式重定向到：<code>file</code></td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>n &gt; file</code></td>
<td>将文件描述符为<code>n</code>的文件重定向到：<code>file</code></td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>n &gt;&gt; file</code></td>
<td>将文件描述符为<code>n</code>的文件以追加的方式重定向到：<code>file</code></td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>n &gt;&amp; m</code></td>
<td>将输出文件<code>m</code>和<code>n</code>合并</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>n &lt;&amp; m</code></td>
<td>将输入文件<code>m</code>和<code>n</code>合并</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>&lt;&lt; tag</code></td>
<td>将开始标记<code>tag</code>和结束标记<code>tag</code>之间的内容作为输入</td>
<td>&mdash;</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h4 id="多行注释">多行注释</h4>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>:<span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>:&lt;&lt;<span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>:&lt;&lt;!
</span></span><span style="display:flex;"><span>!</span></span></code></pre></div></blockquote>
<hr>
<h3 id="实战脚本">实战脚本</h3>
<h4 id="实战脚本一">实战脚本一</h4>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;#!/usr/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 提示用户没有加参数
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if [ $# -eq 0 ]; then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> echo &#34;执行方式: `basename $0` 文件名(file)&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> exit  # 退出
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 提示输入的不是文件: ! 取反:不是文件
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if [ ! -f $1 ];then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> echo &#34;错误的文件名&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> exit
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 正确执行
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">for IP in `cat $1`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">do 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> ping -c1 $IP &amp;&gt;/dev/null
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> if [ $? -eq 0 ];then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     echo &#34;${IP} is up&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> else
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     echo &#34;${IP} is down&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">done
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;</span> &gt;ping.sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ./ping.sh ip.txt</span></span></code></pre></div></blockquote>
<hr>
<h4 id="实战脚本二">实战脚本二</h4>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;#!/usr/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">read -p &#34;请输入数字: &#34; num
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">while true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">do
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    if [[ &#34;$num&#34; =~ ^[0-9]+$ ]];then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        break   # 跳出循环
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    else
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        echo &#34;你输入的不是数字！！！&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        read -p &#34;输入错误，请重新输入: &#34; num
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">done
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">read -p &#34;请输入创建的用户首字母: &#34; prefix
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if [ -z &#34;$prefix&#34; ];then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    echo &#34;错误的首字母(prefix)&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    exit
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">for i in `seq $num`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">do
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    user=$prefix$i
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    useradd $user
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    echo &#34;123&#34; |passwd --stdin $user &amp;&gt;/dev/null
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    if [ $? -eq 0 ];then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        echo &#34;$user 创建成功&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">done  &#39;</span> &gt;useradd.sh</span></span></code></pre></div></blockquote>
<hr>
<h4 id="实战脚本三">实战脚本三</h4>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->清理<!-- raw HTML omitted --><code>Nginx</code><!-- raw HTML omitted -->缓存<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;/opt/delete-cache.sh&#39;</span> &gt;&gt;/home/neek/.bash_profile  	<span style="color:#75715e"># 登录即执行脚本</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;delete-cache.sh<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#!/usr/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#trap &#34;&#34; HUP INT OUIT TSTP #防止在脚本中退出
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#clear
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">directory=/opt/data/cache
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/usr/bin/ansible web -i /etc/ansible/hosts -m shell  -a &#34;/usr/bin/rm -rf ${directory}/directory.log&#34; -f 5 &amp;&gt;/dev/null
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/usr/bin/rm -rf /opt/data/Tenant.txt
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sleep 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/usr/bin/ls ${directory}/ |tee /opt/data/Tenant.txt
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo -e &#34;\e[1;36m \t\t\t+------------------------------------------+\t\t\t \e[0m&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo -e &#34;\e[1;31m \t\t\t|	      	清理租户缓存		   |\t\t\t \e[0m&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo -e &#34;\e[1;36m \t\t\t+------------------------------------------+\t\t\t \e[0m&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo -e &#34;\e[1;36m \t\t\t|   (0) 退出				   |\t\t\t \e[0m&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo -e &#34;\e[1;33m \t\t\t|   (1)输入要删除的目录例如：h5、web、ldy。|\t\t\t \e[0m&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo -e &#34;\e[1;31m \t\t\t|   (2)输入&#39;2&#39;删除租户目录下所有缓存	   |\t\t\t \e[0m&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo -e &#34;\e[1;31m \t\t\t|   (3)输入&#39;3&#39;删除所有租户缓存		   |\t\t\t \e[0m&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo -e &#34;\e[1;36m \t\t\t+------------------------------------------+\t\t\t \e[0m&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo -en &#34;\e[1;36m选择要清理的租户缓存[0-3]: \e[0m&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">read ID
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">while :;do
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	if [[ &#34;$ID&#34; =~ ^[0-9]$ ]];then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		break
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	else
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		echo -en &#34;\e[1;31m输入错误请重新输入[0-3]: \e[0m&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		read ID
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">done
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">while :;do
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	case $ID in
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		0)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		 exit;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		1)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		 echo -en &#34;\e[1;36m请输入租户目录: \e[0m&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		 read  Name
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		 /usr/bin/ls ${directory}/${Name}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		 echo -en &#34;\e[1;36m请输入要清理缓存的终端:h5、web、ldy中的一个： \e[0m&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		 read  cache
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		 if [ -d ${directory}/${Name}/${cache}/ ];then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			/usr/bin/ansible web -i /etc/ansible/hosts -m shell  -a &#34;rm -rf ${directory}/${Name}/${cache}&#34; -f 5 &amp;&gt;/dev/null
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			echo &#34;已清理租户${Name}目录下${cache}目录中的缓存&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			exit
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		 else
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			echo &#34;目录不存在&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			exit
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		 fi;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		2)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		 echo -en &#34;\e[1;36m请输入要清理缓存的租户目录: \e[0m&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		 read  Name
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	 	 if [ -d ${directory}/${Name} ];then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			/usr/bin/ansible web -i /etc/ansible/hosts -m shell  -a &#34;rm -rf ${directory}/${Name}/*&#34; -f 5 &amp;&gt;/dev/null
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			echo &#34;已清理租户${Name}目录下所有缓存&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			exit
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		 fi;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		3)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		 echo -en &#34;\e[1;31m确认要清理所有租户缓存吗[y/n]: \e[0m&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		 read y
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		 if [ &#34;$y&#34; = &#34;y&#34; ];then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			/usr/bin/ansible web -i /etc/ansible/hosts -m shell  -a &#34;rm -rf ${directory}/*&#34; -f 5 &amp;&gt;/dev/null
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			echo &#34;已清理所有租户缓存&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			for mk in `cat /opt/data/Tenant.txt`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			do
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">				/usr/bin/ansible web -i /etc/ansible/hosts -m shell  -a &#34;/usr/bin/mkdir -pv ${directory}/${mk} &gt;&gt;${directory}/directory.log&#34; -f 5 &amp;&gt;/dev/null
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">				if [ $? -eq 0 ];then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">					echo &#34;${mk} create ok&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">				else
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">					echo &#34;${mk} create error&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">				fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			done
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			exit
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		else
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			echo &#34;输入不是’y‘退出&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			exit
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		fi;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	esac
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">done
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<hr>
<h4 id="实战脚本四">实战脚本四</h4>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->修改系统<!-- raw HTML omitted --><code>IP</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;Update-Ip.sh<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo &#34;###input ip you want change to ### &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ipfront=192.168.0.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">read -p &#34;请输入结尾IP:&#34; ip1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ip=&#34;${ipfront}${ip1}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo &#34;###ip====&#34; $ip &#34;###&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">eth=`find /etc/sysconfig/network-scripts/ -name &#34;ifcfg-e*&#34; |sort |head -1 |awk -F/ &#39;{print $5}&#39;`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ethfile=&#34;/etc/sysconfig/network-scripts/$eth&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo &#34;${ethfile}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sed -i &#34;s/BOOTPROTO=&#39;dhcp&#39;/BOOTPROTO=&#39;static&#39;/g&#34; &#34;${ethfile}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sed -i &#34;s/^ONBOOT=no/ONBOOT=yes/g&#34; &#34;${ethfile}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">testfile=&#34;/etc/sysconfig/network-scripts/test&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo &#34;IPADDR=${ip}&#34; &gt;&gt;${ethfile}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo &#34;NETMASK=255.255.255.0&#34; &gt;&gt;${ethfile}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo &#34;GATEWAY=192.168.0.1&#34; &gt;&gt;${ethfile}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo &#34;DNS1=8.8.8.8&#34; &gt;&gt;${ethfile}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo &#34;DNS2=1.1.1.1&#34; &gt;&gt;${ethfile}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sleep 3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">systemctl restart network
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo $?
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="配置linux系统登录告警">配置<code>Linux</code>系统登录告警</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>sshd</code><!-- raw HTML omitted -->登录告警<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/ssh/sshrc<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#!/bin/sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">TELEGRAM_TOKEN=&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">TELEGRAM_GROUP_ID=&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 获取用户、IP地址、时间和服务器信息
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">USER_NAME=$USER
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">HOST_NAME=$(hostname -s)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DATA_TIME=$(date +&#34;%F %H:%M:%S&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LOCALHOST=$(hostname -I | awk &#39;{print $1}&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LOGGIN_IP=$(echo $SSH_CLIENT | awk &#39;{print $1}&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 构造通知消息
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">msg=&#34;有白名单之外的 IP 登录服务器，请验证:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User: ${USER_NAME}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Host: ${LOCALHOST}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Login IP: ${LOGGIN_IP}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Login Time: ${DATA_TIME}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Host Name: ${HOST_NAME}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 定义信任的IP地址列表
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">IP_WhiteList=&#39;192.168.1.100&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">result=$(echo ${IP_WhiteList} | grep &#34;${LOGGIN_IP}&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if [ &#34;${result}&#34; != &#34;&#34; ]; then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        exit 0  # 如果在信任列表中，退出脚本
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">else
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        curl -X POST &#34;https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage&#34; -d &#34;chat_id=${TELEGRAM_GROUP_ID}&amp;text=${msg}&#34; &gt; /dev/null
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          </section>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="storage">Storage</h1>


            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Storage</h1>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_nfs">Install_NFS</h1>

<h1 id="nfs部署"><code>NFS</code>部署</h1>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->安装服务<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo apt-get install nfs-kernel-server  	<span style="color:#75715e"># Debian系统</span>
</span></span><span style="display:flex;"><span>$ yum install -y nfs-utils rpcbind  	<span style="color:#75715e"># CentOS系统</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ yum -y install nfs-utils  	<span style="color:#75715e"># 目录挂载节点只安装不启动</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改使用的默认端口<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span>$ rpcinfo -p localhost
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Centos</span>
</span></span><span style="display:flex;"><span>$ cat &gt;&gt;/etc/sysconfig/nfs&lt;-EOF
</span></span><span style="display:flex;"><span>STATD_PORT<span style="color:#f92672">=</span><span style="color:#ae81ff">4004</span>
</span></span><span style="display:flex;"><span>MOUNTD_PORT<span style="color:#f92672">=</span><span style="color:#ae81ff">2049</span>
</span></span><span style="display:flex;"><span>RQUOTAD_PORT<span style="color:#f92672">=</span><span style="color:#ae81ff">4001</span>
</span></span><span style="display:flex;"><span>LOCKD_TCPPORT<span style="color:#f92672">=</span><span style="color:#ae81ff">32768</span>
</span></span><span style="display:flex;"><span>LOCKD_UDPPORT<span style="color:#f92672">=</span><span style="color:#ae81ff">32768</span>
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>$ systemctl restart nfs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Debian</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/etc/default/nfs-kernel-server<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">RPCMOUNTDOPTS=&#34;--port 2045&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ systemctl restart rpcbind.service
</span></span><span style="display:flex;"><span>$ systemctl restart nfs-server.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ systemctl restart nfs-kernel-server</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->准备挂载目录，授权<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -pv /opt/data/nfs   <span style="color:#75715e"># 准备共享目录</span>
</span></span><span style="display:flex;"><span>$ chown -R user_naem:user_name /opt/data <span style="color:#f92672">&amp;&amp;</span> chmod <span style="color:#ae81ff">755</span> -R /opt/data/</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->挂载目录实现共享<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>访问权限设置</li>
</ul>
<blockquote>
<ul>
<li><code>ro</code><!-- raw HTML omitted -->：设置输出目录：只读<!-- raw HTML omitted --></li>
<li><code>rw</code><!-- raw HTML omitted -->：设置输出目录：读写<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li>用户映射选项</li>
</ul>
<blockquote>
<ul>
<li><code>all_squash</code><!-- raw HTML omitted -->：将远程访问的所有普通用户及所属组都映射为匿名用户或用户组<!-- raw HTML omitted --><code>nfsnobody</code></li>
<li><code>no_all_squash</code><!-- raw HTML omitted -->：与<code>all_squash</code>取反：默认设置<!-- raw HTML omitted --></li>
<li><code>root_squash</code><!-- raw HTML omitted -->：<code>root</code>用户对共享目录只有普通用户权限，限制<code>root</code>：默认设置<!-- raw HTML omitted --></li>
<li><code>no_root_squash</code><!-- raw HTML omitted -->：有此选项，<code>root</code>用户对共享目录拥有至高权限，就像对本机目录一样操作<!-- raw HTML omitted --></li>
<li><code>anonuid=xxx</code><!-- raw HTML omitted -->：将远程访问的所有用户都映射为匿名用户，并指定该用户为本地用户<!-- raw HTML omitted --><code>UID=xxx</code></li>
<li><code>anongid=xxx</code><!-- raw HTML omitted -->：将远程访问的所有用户组都映射为匿名用户组账户，并指定该匿名用户组账户为本地用户组账户<!-- raw HTML omitted --><code>GID=xxx</code></li>
</ul>
</blockquote>
<ul>
<li>其他选项</li>
</ul>
<blockquote>
<ul>
<li><code>secure</code><!-- raw HTML omitted -->：<code>NFS</code>通过<code>1024</code>以下的安全<code>TCP/IP</code>端口发送：默认设置<!-- raw HTML omitted --></li>
<li><code>insecure</code><!-- raw HTML omitted -->：<code>NFS</code>通过<code>1024</code>以上端口发送<!-- raw HTML omitted --></li>
<li><code>sync</code><!-- raw HTML omitted -->：同步模式，内存中的数据时时写入磁盘<!-- raw HTML omitted --></li>
<li><code>async</code><!-- raw HTML omitted -->：不同步，把内存中的数据定期写入磁盘<!-- raw HTML omitted --></li>
<li><code>wdelay</code><!-- raw HTML omitted -->：检查是否有相关的写操作，如果有则将这些写操作一起执行，这样可以提高效率：默认设置<!-- raw HTML omitted --></li>
<li><code>no_wdelay</code><!-- raw HTML omitted -->：若有写操作则立即执行，应与<code>sync</code>配合使用<!-- raw HTML omitted --></li>
<li><code>subtree</code><!-- raw HTML omitted -->：若输出目录是一个子目录，则<code>NFS</code>服务器将检查其父目录的权限：默认设置<!-- raw HTML omitted --></li>
<li><code>no_subtree</code><!-- raw HTML omitted -->：即使输出目录是一个子目录，<code>NFS</code>服务器也不检查其父目录的权限，这样可以提高效率<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li>授予多个<code>IP</code>网段访问<code>NFS</code>需要使用<!-- raw HTML omitted -->空格<!-- raw HTML omitted -->分隔<code>192.168.80.0/24 172.16.8.0/24</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;&gt;/etc/exports<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/opt/logs 192.168.80.0/32(rw,sync,no_root_squash,no_all_squash,no_subtree_check)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/opt/data/redis 192.168.80.0/24 172.16.8.0/24(rw,sync,no_root_squash,no_all_squash,no_subtree_check)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->加载配置、启动服务<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ exportfs -r  	<span style="color:#75715e"># 加载配置</span>
</span></span><span style="display:flex;"><span>$ systemctl start rpcbind <span style="color:#f92672">&amp;&amp;</span> systemctl enable rpcbind
</span></span><span style="display:flex;"><span>$ systemctl start nfs <span style="color:#f92672">&amp;&amp;</span> systemctl enable nfs  	<span style="color:#75715e"># 修改/etc/exports 配置文件后要重启nfs</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Debian 系统</span>
</span></span><span style="display:flex;"><span>$ sudo systemctl restart nfs-server</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->检测是否挂载成功<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo showmount -e 192.168.18.100  	<span style="color:#75715e"># 测试目录是否挂载成功</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->高可用备份方式，在所有节点执行如下挂载命令<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mount -t nfs 192.168.18.100:/opt/data/redis /opt/data/redis
</span></span><span style="display:flex;"><span>$ mount -t nfs 192.168.18.100:/opt/data/jenkins /opt/data/jenkins</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->网络远程挂载，然后再执行<code>mount</code>挂载命令<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;&gt;/etc/fstab<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">IP地址:/opt/nginx/logs   /opt/nginx/logs    nfs     defaults        0 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ mount -t  nfs 192.168.18.100:/opt/data/redis /opt/data/redis
</span></span><span style="display:flex;"><span>$ mount -t  nfs 192.168.18.100:/opt/data/jenkins /opt/data/jenkins</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->查看挂载情况<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 以树结构方式列出：apt install util-linux</span>
</span></span><span style="display:flex;"><span>$ findmnt  	<span style="color:#75715e"># -t：指定文件类型，例如：findmnt -t nfs4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ lsblk -f
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ mount</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->卸载挂载的目录<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ umount -l /opt/data/jenkins  	<span style="color:#75715e"># -l：强制，加本地目录</span></span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_moosefs">Install_MooseFS</h1>

<h2 id="moosefs"><code>MooseFS</code></h2>
<blockquote>
<ul>
<li>
<p><a href="https://moosefs.com/support/#documentation" rel="external" target="_self"><code>MooseFS</code></a></p>
<p><code>MooseFS[MFS]</code>是一个具有容错性，高可用，高性能，扩展性强的网络<a href="https://cloud.tencent.com/product/chdfs?from_column=20065&from=20065" rel="external" target="_self">分布式文件系统</a>。他将数据分布在多个存储<a href="https://cloud.tencent.com/product/cpm?from_column=20065&from=20065" rel="external" target="_self">物理服务器</a>上，这些存储服务器对用户而言就是一块虚拟磁盘，它符合<code>POSIX</code>并且像任何其他类UNIX文件系统一样支持</p>
</li>
</ul>
</blockquote>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_minio">Install_Minio</h1>

<h2 id="minio部署"><code>Minio</code>部署</h2>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://min.io/docs/minio/kubernetes/upstream/" rel="external" target="_self"><code>Minio</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://min.io/docs/minio/linux/index.html" rel="external" target="_self"><code>Linux</code>安装<code>Minio</code></a></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_fastdfs">Install_FastDFS</h1>

<h2 id="fastdfs分布式文件系统"><code>FastDFS</code>分布式文件系统</h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->参考文档<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://blog.csdn.net/kongdeqian1988/article/details/36930875" rel="external" target="_self"><code>FastDFS</code>海量数据分布式存储方案</a></td>
<td></td>
</tr>
<tr>
<td><a href="http://blog.csdn.net/mr_smile2014/article/details/52118541" rel="external" target="_self"><code>Fastdfs</code>分布式文件系统之文件同步机制</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://blog.csdn.net/ssoul_liu/article/details/51059139" rel="external" target="_self"><code>FastDFS</code>环境配置及<code>php FastDFS</code>扩展安装</a></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>
<ol start="2">
<li><code>FastDFS</code><!-- raw HTML omitted -->访问流程图<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<p><a href="#R-image-bd2047e1a362a418deeaefe973c0df9f" class="lightbox-link"><img alt="FastDFS-Access flow" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Distributed_File_Server/FastDFS-Access-flow.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-bd2047e1a362a418deeaefe973c0df9f"><img alt="FastDFS-Access flow" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/Distributed_File_Server/FastDFS-Access-flow.png"></a></p>
</blockquote>
<hr>
<h3 id="下载安装fastdfs以及扩展安装包">下载安装<code>FastDFS</code>以及扩展安装包</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->下载安装<!-- raw HTML omitted --><code>libfastcommon</code><!-- raw HTML omitted -->扩展包<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ $ yum -y install gcc gcc-c++ wget
</span></span><span style="display:flex;"><span>$ mkdir -p /opt/fastdfs/<span style="color:#f92672">{</span>client,data,logs<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -S打印服务器响应、-O将文件写入文件、-P 大P将文件下载指定目录</span>
</span></span><span style="display:flex;"><span>$ wget -P -S -O /usr/local/src/libfastcommon.tar.gz https://github.com/happyfish100/libfastcommon/archive/refs/tags/V1.0.45.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ tar -zxvf /usr/local/src/libfastcommon.tar.gz -C /usr/local/src/
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装libfastcommon</span>
</span></span><span style="display:flex;"><span>$ cd /usr/local/src/libfastcommon-1.0.45/  
</span></span><span style="display:flex;"><span>$ ./make.sh  
</span></span><span style="display:flex;"><span>$ ./make.sh install</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->下载安装<!-- raw HTML omitted --><code>FastDFS</code><!-- raw HTML omitted -->主包<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget -P -S -O /usr/local/src/fastdfs.tar.gz https://github.com/happyfish100/fastdfs/archive/refs/tags/V6.07.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ tar -zxvf /usr/local/src/fastdfs.tar.gz -C /usr/local/src/</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>FastDFS</code><!-- raw HTML omitted -->配置文件<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>make.sh</code><!-- raw HTML omitted -->定义默认工作目录<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 修改默认主目录：TARGET_PREFIX=$DESTDIR/usr 3行左右</span>
</span></span><span style="display:flex;"><span>$ sed -ri <span style="color:#e6db74">&#34;s#IR/usr#IR/opt/fastdfs#&#34;</span> /usr/local/src/fastdfs-6.07/make.sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改默认配置文件目录 ：TARGET_CONF_PATH=$DESTDIR/etc/fdfs 4行左右</span>
</span></span><span style="display:flex;"><span>$ sed -ri <span style="color:#e6db74">&#34;s#IR/etc/fdfs#IR/opt/fastdfs#&#34;</span> /usr/local/src/fastdfs-6.07/make.sh 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 编译安装</span>
</span></span><span style="display:flex;"><span>$ cd /usr/local/src/fastdfs-6.07/
</span></span><span style="display:flex;"><span>$ ./make.sh  
</span></span><span style="display:flex;"><span>$ ./make.sh install  
</span></span><span style="display:flex;"><span>$ <span style="color:#ae81ff">\c</span>p /usr/local/src/fastdfs-6.07/conf/* /opt/fastdfs/</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>tracker.conf</code><!-- raw HTML omitted -->文件配置<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 替换存储数据和日志文件的基本路径，23行左右</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;s#/home/yuqing/fastdfs#/opt/fastdfs/data#g&#34;</span> /opt/fastdfs/tracker.conf</span></span></code></pre></div><ul>
<li>2.1.3 <!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>storage.conf</code><!-- raw HTML omitted -->配置文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">#  工作目录 49行左右</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;s#/home/yuqing/fastdfs#/opt/fastdfs#g&#34;</span> /opt/fastdfs/storage.conf  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改配置tracker服务器，虽然是同一台机器上，但是不能写127.0.0.1。这项配置可以出现一次或多次，145行左右</span>
</span></span><span style="display:flex;"><span>$ sed -ri <span style="color:#e6db74">&#34;/tracker_server = /c\\tracker_server = </span><span style="color:#e6db74">${</span>FastDFS服务所在服务器IP<span style="color:#e6db74">}</span><span style="color:#e6db74">:22122&#34;</span> /etc/fdfs/storage.conf  	</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>client.conf</code><!-- raw HTML omitted -->配置文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;s#/home/yuqing/fastdfs#/opt/fastdfs#g&#34;</span> /opt/fastdfs/client.conf
</span></span><span style="display:flex;"><span>$ sed -ri <span style="color:#e6db74">&#34;/tracker_server = /c\\tracker_server = </span><span style="color:#e6db74">${</span>FastDFS服务所在服务器IP<span style="color:#e6db74">}</span><span style="color:#e6db74">:22122&#34;</span> /opt/fastdfs/client.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>http.tracker_server_port<span style="color:#f92672">=</span><span style="color:#ae81ff">9270</span>  	<span style="color:#75715e"># 根据需要修改端口号</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>mod_fastdfs.conf</code><!-- raw HTML omitted -->配置文件<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>配置<code>mod_fastdfs.conf</code>文件注意一些问题</li>
<li><code>mod_fastdfs.conf</code><!-- raw HTML omitted -->文件中<!-- raw HTML omitted --><code>tracker_server</code><!-- raw HTML omitted -->的端口应该跟<!-- raw HTML omitted --><code>tracker.conf</code><!-- raw HTML omitted -->中<!-- raw HTML omitted --><code>port</code><!-- raw HTML omitted -->一致<!-- raw HTML omitted --></li>
<li><code>mod_fastdfs.conf</code><!-- raw HTML omitted -->文件中<!-- raw HTML omitted --><code>storage_server_port</code><!-- raw HTML omitted -->的端口应该跟<!-- raw HTML omitted --><code>storage.conf</code><!-- raw HTML omitted -->中<!-- raw HTML omitted --><code>port</code><!-- raw HTML omitted -->一致<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cp /usr/local/src/fastdfs-6.07/docker/dockerfile_local/conf/mod_fastdfs.conf /opt/fastdfs/
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;s#/home/dfs#/opt/fastdfs#g&#34;</span> /opt/fastdfs/mod_fastdfs.conf  
</span></span><span style="display:flex;"><span>$ sed -ri <span style="color:#e6db74">&#34;/tracker_server=/c\\tracker_server=</span><span style="color:#e6db74">${</span>FastDFS服务所在服务器IP<span style="color:#e6db74">}</span><span style="color:#e6db74">:22122&#34;</span> /opt/fastdfs/mod_fastdfs.conf</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->其他配置或文件虽然不用修改，<!-- raw HTML omitted --><code>fastdfs-nginx-module</code><!-- raw HTML omitted -->模块会用到一些配置<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>anti-steal.jpg</code></li>
<li><code>http.conf</code></li>
<li><code>mime.types</code></li>
</ul>
</blockquote>
</blockquote>
</blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->启动<!-- raw HTML omitted --><code>tracker</code><!-- raw HTML omitted -->和<!-- raw HTML omitted --><code>storage</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ fdfs_trackerd /opt/fastdfs/tracker.conf start
</span></span><span style="display:flex;"><span>$ fdfs_storaged /opt/fastdfs/storage.conf start
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看日志</span>
</span></span><span style="display:flex;"><span>$ tail -n10 /opt/fastdfs/logs/storaged.log 
</span></span><span style="display:flex;"><span>mkdir data path: F7 ...
</span></span><span style="display:flex;"><span>mkdir data path: F8 ...
</span></span><span style="display:flex;"><span>mkdir data path: F9 ...
</span></span><span style="display:flex;"><span>mkdir data path: FA ...
</span></span><span style="display:flex;"><span>mkdir data path: FB ...  </span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->用<!-- raw HTML omitted --><code>fdfs_test</code><!-- raw HTML omitted -->测试上传<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /usr/bin/fdfs_upload_file /etc/fdfs/client.conf ~/512x512bb.jpg
</span></span><span style="display:flex;"><span>group1/M00/00/00/wKjVgWCEOCaABaIQAABPt05CHsw699.jpg</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->下载安装<!-- raw HTML omitted --><code>fastdfs-nginx-module</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>nginx</code><!-- raw HTML omitted -->编译添加支持模块<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 下载支持nginx插件</span>
</span></span><span style="display:flex;"><span>$ wget -P -S -O /usr/local/src/fastdfs-nginx-module.tar.gz https://github.com/happyfish100/fastdfs-nginx-module/archive/refs/tags/V1.22.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ tar -zxvf /usr/local/src/fastdfs-nginx-module.tar.gz -C /usr/local/src/  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 添加模块</span>
</span></span><span style="display:flex;"><span>$ ./configure --add-module<span style="color:#f92672">=</span>../fastdfs-nginx-module-master/src
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 配置文件添加配置启用模块</span>
</span></span><span style="display:flex;"><span>$ vim /usr/local/nginx/conf/nginx.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 80端口中添加</span>
</span></span><span style="display:flex;"><span>location ~/group<span style="color:#f92672">([</span>0-9<span style="color:#f92672">])</span>/M00 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>     ngx_fastdfs_module;
</span></span><span style="display:flex;"><span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 添加如下行，将 /group1/M00 映射到 /ljzsg/fastdfs/file/data</span>
</span></span><span style="display:flex;"><span> location /group1/M00 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>     alias /ljzsg/fastdfs/file/data;
</span></span><span style="display:flex;"><span> <span style="color:#f92672">}</span></span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="configur_storage">Configur_Storage</h1>

<h2 id="存储">存储</h2>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://docs.ceph.com/en/quincy/" rel="external" target="_self"><code>Ceph</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="http://docs.minio.org.cn/docs/" rel="external" target="_self"><code>MinIO</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://hadoop.apache.org/" rel="external" target="_self"><code>Hadoop</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://moosefs.com/" rel="external" target="_self"><code>MooseFS</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.gluster.org/" rel="external" target="_self"><code>GlusterFS</code></a></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>

            <footer class="footline">
            </footer>
          </article>

          </section>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="service_management">Service_Management</h1>


            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Service_Management</h1>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_apollo">Install_Apollo</h1>

<h2 id="apollo部署"><code>Apollo</code>部署</h2>
<blockquote>
<ul>
<li><a href="https://github.com/apolloconfig/apollo" rel="external" target="_self"><code>Apollo</code></a></li>
</ul>
</blockquote>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_nacos">Install_Nacos</h1>

<h2 id="nacos部署"><code>Nacos</code>部署</h2>
<blockquote>
<ul>
<li>
<p><a href="https://github.com/alibaba/nacos/tags" rel="external" target="_self"><code>Nacos</code>下载地址</a></p>
</li>
<li>
<p><!-- raw HTML omitted -->环境准备<!-- raw HTML omitted --></p>
<p><code>Nacos</code>依赖<code>Java</code>环境来运行。如果您是从代码开始构建并运行<code>Nacos</code>，还需要为此配置 <code>Maven</code>环境，请确保是在以下版本环境中安装使用:</p>
</li>
</ul>
<blockquote>
<ul>
<li><code>64 bit OS</code>，支持<code>Linux/Unix/Mac/Windows</code>，推荐选用<code>Linux/Unix/Mac</code>。</li>
<li><code>64 bit JDK 1.8+</code>下载 <code>&amp;</code> 配置。</li>
<li><code>Maven 3.2.x+</code>下载<code>&amp;</code>配置。</li>
</ul>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->下载安装包、解压、配置<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget https://github.com/alibaba/nacos/releases/download/2.0.4/nacos-server-2.0.4.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ tar -zxvf nacos-server-2.0.4.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建数据库、导入模板数据</span>
</span></span><span style="display:flex;"><span>mysql&gt; source  nacos/conf/nacos-mysql.sql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改配置</span>
</span></span><span style="display:flex;"><span>$ vim nacos/conf/application.properties
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>db.url.0<span style="color:#f92672">=</span>jdbc:mysql://127.0.0.1:16303/nacos?characterEncoding<span style="color:#f92672">=</span>utf8&amp;connectTimeout<span style="color:#f92672">=</span>1000&amp;socketTimeout<span style="color:#f92672">=</span>3000&amp;autoReconnect<span style="color:#f92672">=</span>true&amp;useUnicode<span style="color:#f92672">=</span>true&amp;useSSL<span style="color:#f92672">=</span>false&amp;serverTimezone<span style="color:#f92672">=</span>UTC  	<span style="color:#75715e"># 配置连接数据库地址</span>
</span></span><span style="display:flex;"><span>db.user<span style="color:#f92672">=</span>nacos  	<span style="color:#75715e"># 连接数据库用户</span>
</span></span><span style="display:flex;"><span>db.password<span style="color:#f92672">=</span>password  	<span style="color:#75715e"># 连接数据库密码</span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="nacos单节点启动"><code>Nacos</code>单节点启动</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 单节点启动(standalone代表着单机模式运行)</span>
</span></span><span style="display:flex;"><span>$ sh startup.sh -m standalone
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 服务注册</span>
</span></span><span style="display:flex;"><span>$ curl -X POST <span style="color:#e6db74">&#39;http://127.0.0.1:8848/nacos/v1/ns/instance?serviceName=nacos.naming.serviceName&amp;ip=20.18.7.10&amp;port=8080&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 服务发现</span>
</span></span><span style="display:flex;"><span>$ curl -X GET <span style="color:#e6db74">&#39;http://127.0.0.1:8848/nacos/v1/ns/instance/list?serviceName=nacos.naming.serviceName&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 发布配置</span>
</span></span><span style="display:flex;"><span>$ curl -X POST <span style="color:#e6db74">&#34;http://127.0.0.1:8848/nacos/v1/cs/configs?dataId=nacos.cfg.dataId&amp;group=test&amp;content=HelloWorld&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 获取配置</span>
</span></span><span style="display:flex;"><span>$ curl -X GET <span style="color:#e6db74">&#34;http://127.0.0.1:8848/nacos/v1/cs/configs?dataId=nacos.cfg.dataId&amp;group=test&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 关闭服务器</span>
</span></span><span style="display:flex;"><span>$ sh shutdown.sh</span></span></code></pre></div></blockquote>
<hr>
<h3 id="nacos集群部署"><code>Nacos</code>集群部署</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->节点之间防火墙开放<!-- raw HTML omitted --><!-- raw HTML omitted --><strong>9849、8848、7848、1001</strong><!-- raw HTML omitted --><!-- raw HTML omitted -->端口，<!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="2">
<li><!-- raw HTML omitted --><strong>9849、1001</strong>服务端<!-- raw HTML omitted --><code>gRPC</code><!-- raw HTML omitted -->请求服务端端口，用于服务间同步等<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>nacos</code><!-- raw HTML omitted -->集群配置文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ vim nacos/conf/cluster.conf
</span></span><span style="display:flex;"><span>192.168.1.10:8848
</span></span><span style="display:flex;"><span>192.168.1.11:8848
</span></span><span style="display:flex;"><span>192.168.1.12:8848</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改配置文件以及配置数据库连接<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ vim nacos/conf/application.properties
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">### Specify local server&#39;s IP:</span>
</span></span><span style="display:flex;"><span>nacos.inetutils.ip-address<span style="color:#f92672">=</span>192.168.30.144  	<span style="color:#75715e"># 本机服务器IP</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#*************** Config Module Related Configurations ***************#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">### If user MySQL as datasource:</span>
</span></span><span style="display:flex;"><span>spring.datasource.platform<span style="color:#f92672">=</span>mysql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">### Count of DB:</span>
</span></span><span style="display:flex;"><span>db.num<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>db.url.0<span style="color:#f92672">=</span>jdbc:mysql://127.0.0.1:16303/nacos?characterEncoding<span style="color:#f92672">=</span>utf8&amp;connectTimeout<span style="color:#f92672">=</span>1000&amp;socketTimeout<span style="color:#f92672">=</span>3000&amp;autoReconnect<span style="color:#f92672">=</span>true&amp;useUnicode<span style="color:#f92672">=</span>true&amp;useSSL<span style="color:#f92672">=</span>false&amp;serverTimezone<span style="color:#f92672">=</span>UTC  	<span style="color:#75715e"># 配置连接数据库地址</span>
</span></span><span style="display:flex;"><span>db.user<span style="color:#f92672">=</span>nacos  	<span style="color:#75715e"># 连接数据库用户</span>
</span></span><span style="display:flex;"><span>db.password<span style="color:#f92672">=</span>password  	<span style="color:#75715e"># 连接数据库密码</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->集群启动（使用外置数据库）<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ bash startup.sh</span></span></code></pre></div></blockquote>
<hr>
<h3 id="kubernetes部署nacos"><code>Kubernetes</code>部署<code>Nacos</code></h3>
<blockquote>
<ul>
<li><a href="https://nacos.io/zh-cn/docs/use-nacos-with-kubernetes.html" rel="external" target="_self"><code>Kubernetes</code>部署<code>Nacos</code></a></li>
</ul>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_mesos">Install_Mesos</h1>

<h2 id="apache-mesos"><code>Apache Mesos</code></h2>
<blockquote>
<ul>
<li>
<p><a href="https://mesos.apache.org/documentation/latest/" rel="external" target="_self"><code>Apache Mesos</code></a></p>
<p><code>Mesos</code>是一个开源的集群管理框架，它可以将数据中心/集群放在一台电脑里运行，对外提供简单的<code>API</code>，同时隐藏内部的很多复杂架构</p>
</li>
</ul>
</blockquote>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_hive">Install_Hive</h1>

<h2 id="apache-hive"><code>Apache Hive</code></h2>
<blockquote>
<ul>
<li>
<p><a href="https://hive.apache.org/" rel="external" target="_self"><code>Apache Hive</code></a></p>
<p><code>Apache Hive</code>是可实现大规模分析的分布式容错数据仓库系统。该数据仓库集中存储信息，您可以轻松对此类信息进行分析，从而做出明智的数据驱动决策。<code>Hive</code>让用户可以利用<code>SQL</code>读取、写入和管理<code>PB</code>级数据。</p>
<p><code>Hive</code>建立在<code>Apache Hadoop</code>基础之上，后者是一种开源框架，可被用于高效存储与处理大型数据集。因此，<code>Hive</code>与<code>Hadoop</code>紧密集成，其设计可快速对<code>PB</code>级数据进行操作。<code>Hive</code>的与众不同之处在于它可以利用<code>Apache Tez</code>或<code>MapReduce</code>通过类似于<code>SQL</code>的界面查询大型数据集。</p>
</li>
</ul>
</blockquote>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_consul">Install_Consul</h1>

<h2 id="consul"><code>Consul</code></h2>
<blockquote>
<ul>
<li>
<p><a href="https://www.consul.io/" rel="external" target="_self"><code>Consul</code></a></p>
</li>
<li>
<p><a href="https://zhuanlan.zhihu.com/p/126064282" rel="external" target="_self">5分钟看懂微服务<code>Consul</code>特性及搭建</a></p>
<p><code>Consul</code>是<code>HashiCorp</code>公司推出的开源工具，<code>Consul</code>由<code>Go</code>语言开发，部署起来非常容易，只需要极少的可执行程序和配置文件，具有绿色、轻量级的特点。<code>Consul</code>是<code>分布式</code>的、<code>高可用</code>的、 <code>可横向扩展</code>的用于实现分布式系统的服务发现与配置</p>
</li>
</ul>
</blockquote>

            <footer class="footline">
            </footer>
          </article>

          </section>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="web">Web</h1>


            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Web</h1>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="website_optimization_advertise">Website_Optimization_Advertise</h1>

<h2 id="网站优化">网站优化</h2>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://juejin.cn/post/7015464868237017119" rel="external" target="_self">博客接入谷歌广告<code>Google Ads</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://blog.csdn.net/fullbug/article/details/123894727" rel="external" target="_self"><code>hexo</code>博客加入<code>51LA</code>网站流量统计</a></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="website_http_status_messages">Website_HTTP_Status_Messages</h1>

<h2 id="web服务状态码"><code>Web</code>服务状态码</h2>
<blockquote>
<ul>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status#%E4%BF%A1%E6%81%AF%E5%93%8D%E5%BA%94" rel="external" target="_self"><code>HTTP</code></a></li>
<li><a href="https://www.tencentcloud.com/zh/document/product/1145/58009" rel="external" target="_self"><code>EdgeOne</code>自定义的状态码</a></li>
</ul>
</blockquote>
<h3 id="100199信息响应"><code>100~199</code>信息响应</h3>
<blockquote>
<table>
<thead>
<tr>
<th>消息</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/100" rel="external" target="_self"><code>100 Continue</code></a></td>
<td>服务器仅接收到部分请求，但是一旦服务器并没有拒绝该请求，客户端应该继续发送其余的请求</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/101" rel="external" target="_self"><code>101 Switching Protocols</code></a></td>
<td>服务器转换协议：服务器将遵守从客户的请求转换到另外一种协议</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/102" rel="external" target="_self"><code>102 Processing</code></a></td>
<td>此代码表示服务器已收到并正在处理该请求，但当前没有响应可用</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/103" rel="external" target="_self"><code>103 Early Hints</code></a></td>
<td>此状态代码主要用于与<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Link" rel="external" target="_self"><code>Link</code></a>链接头一起使用，以允许用户代理在服务器准备响应阶段时开始预加载<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTML/Attributes/rel/preload" rel="external" target="_self"><code>preloading</code></a>资源</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h3 id="200299成功响应"><code>200～299</code>成功响应</h3>
<blockquote>
<table>
<thead>
<tr>
<th>消息</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/200" rel="external" target="_self"><code>200 OK</code></a></td>
<td>请求成功(其后是对<code>GET</code>和<code>POST</code>请求的应答文档。)</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/201" rel="external" target="_self"><code>201 Created</code></a></td>
<td>该请求已成功，并因此创建了一个新的资源。这通常是在 POST 请求，或是某些 PUT 请求之后返回的响应</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/202" rel="external" target="_self"><code>202 Accepted</code></a></td>
<td>请求已经接收到，但还未响应，没有结果。意味着不会有一个异步的响应去表明当前请求的结果，预期另外的进程和服务去处理请求，或者批处理</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/203" rel="external" target="_self"><code>203 Non-Authoritative Information</code></a></td>
<td>服务器已成功处理了请求，但返回的实体头部元信息不是在原始服务器上有效的确定集合，而是来自本地或者第三方的拷贝。当前的信息可能是原始版本的子集或者超集。例如，包含资源的元数据可能导致原始服务器知道元信息的超集。使用此状态码不是必须的，而且只有在响应不使用此状态码便会返回<code>200 OK</code>的情况下才是合适的</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/204" rel="external" target="_self"><code>204 No Content</code></a></td>
<td>没有新文档。浏览器应该继续显示原来的文档。如果用户定期地刷新页面而<code>Servlet</code>可以确定用户文档足够新，这个状态代码是很有用的。</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/205" rel="external" target="_self"><code>205 Reset Content</code></a></td>
<td>没有新文档。但浏览器应该重置它所显示的内容。用来强制浏览器清楚表单输入内容。</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/206" rel="external" target="_self"><code>206 Partial Content</code></a></td>
<td>客户发送了一个带有<code>Range(范围)</code>的头<code>GET</code>请求，服务器完成了他</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/207" rel="external" target="_self"><code>207 Multi-Status</code></a></td>
<td>对于多个状态代码都可能合适的情况，传输有关多个资源的信息</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/208" rel="external" target="_self"><code>208 Already Reported</code></a></td>
<td>在<code>DAV</code>里面使用 <code>&lt;dav:propstat&gt;</code> 响应元素以避免重复枚举多个绑定的内部成员到同一个集合</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/226" rel="external" target="_self"><code>226 IM Used</code></a></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h3 id="300399重定向消息"><code>300～399</code>重定向消息</h3>
<blockquote>
<table>
<thead>
<tr>
<th>消息</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/300" rel="external" target="_self"><code>300 Multiple Choice</code></a></td>
<td>多重选择。链接列表。用户可以选择某链接达到目的地。最多允许五个地址。</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/301" rel="external" target="_self"><code>301 Moved Permanently</code></a></td>
<td>请求资源的<code>URL</code>已永久更改。在响应中给出了新的<code>URL</code></td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/302" rel="external" target="_self"><code>302 Found</code></a></td>
<td>此响应代码表示所请求资源的<code>URI</code>已<strong>暂时</strong>更改。未来可能会对<code>URI</code>进行进一步的改变。因此，客户机应该在将来的请求中使用这个相同的<code>URI</code></td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/303" rel="external" target="_self"><code>303 See Other</code></a></td>
<td>服务器发送此响应，以指示客户端通过一个<code>GET</code>请求在另一个<code>URI</code>中获取所请求的资源</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/304" rel="external" target="_self"><code>304 Not Modified</code></a></td>
<td>这是用于缓存的目的。它告诉客户端响应还没有被修改，因此客户端可以继续使用相同的缓存版本的响应</td>
</tr>
<tr>
<td><code>305 Use Proxy</code></td>
<td>在<code>HTTP</code>规范中定义，以指示请求的响应必须被代理访问。由于对代理的带内配置的安全考虑，它已被弃用</td>
</tr>
<tr>
<td><code>306 Unused</code></td>
<td>此响应代码不再使用；它只是保留。它曾在<code>HTTP/1.1</code>规范的早期版本中使用过。</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/307" rel="external" target="_self"><code>307 Temporary Redirect</code></a></td>
<td>服务器发送此响应，以指示客户端使用在前一个请求中使用的相同方法在另一个<code>URI</code>上获取所请求的资源。这与<code>302 Found HTTP</code>响应代码具有相同的语义，但用户代理 <em>不能</em> 更改所使用的<code>HTTP</code>方法：如果在第一个请求中使用了<code>POST</code>，则在第二个请求中必须使用<code>POST</code></td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/308" rel="external" target="_self"><code>308 Permanent Redirect</code></a></td>
<td>这意味着资源现在永久位于由<code>Location:</code> HTTP Response 标头指定的另一个<code>URI</code>。这与 <code>301 Moved Permanently</code> HTTP 响应代码具有相同的语义，但用户代理不能更改所使用的<code>HTTP</code>方法：如果在第一个请求中使用<code>POST</code>，则必须在第二个请求中使用<code>POST</code>。</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h3 id="400499客户端错误响应"><code>400～499</code>客户端错误响应</h3>
<blockquote>
<table>
<thead>
<tr>
<th>消息</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/400" rel="external" target="_self"><code>400 Bad Request</code></a></td>
<td>客户端请求不合法（例如，错误的请求语法、无效的请求消息帧或欺骗性的请求路由），服务器无法或不会处理请求</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/401" rel="external" target="_self"><code>401 Unauthorized</code></a></td>
<td>虽然<code>HTTP</code>标准指定了<code>unauthorized</code>，但从语义上来说，这个响应意味着<code>unauthenticated</code>。也就是说，客户端必须对自身进行身份验证才能获得请求的响应</td>
</tr>
<tr>
<td><code>401.1</code></td>
<td>登录失败。</td>
</tr>
<tr>
<td><code>401.2</code></td>
<td>服务器配置导致登录失败。</td>
</tr>
<tr>
<td><code>401.3</code></td>
<td>由于<code>ACL</code>对资源的限制而未获得授权。</td>
</tr>
<tr>
<td><code>401.4</code></td>
<td>筛选器授权失败。</td>
</tr>
<tr>
<td><code>401.5</code></td>
<td><code>ISAPI/CGI</code>应用程序授权失败</td>
</tr>
<tr>
<td><code>401.7</code></td>
<td>访问被<code>Web</code>服务器上的<code>URL</code>授权策略拒绝。这个错误代码为<code>IIS 6.0</code>所专用</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/402" rel="external" target="_self"><code>402 Payment Required</code></a></td>
<td>此响应代码保留供将来使用。创建此代码的最初目的是将其用于数字支付系统，但是此状态代码很少使用，并且不存在标准约定</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/403" rel="external" target="_self"><code>403 Forbidden</code></a></td>
<td>客户端没有访问内容的权限；也就是说，它是未经授权的，因此服务器拒绝提供请求的资源。与<code>401 Unauthorized</code>不同，服务器知道客户端的身份</td>
</tr>
<tr>
<td><code>403.1</code></td>
<td>执行访问被禁止</td>
</tr>
<tr>
<td><code>403.2</code></td>
<td>读访问被禁止</td>
</tr>
<tr>
<td><code>403.3</code></td>
<td>写访问被禁止</td>
</tr>
<tr>
<td><code>403.4</code></td>
<td>要求<code>SSL</code></td>
</tr>
<tr>
<td><code>403.5</code></td>
<td>要求<code>SSL 128</code></td>
</tr>
<tr>
<td><code>403.6</code></td>
<td><code>IP</code>地址被拒绝</td>
</tr>
<tr>
<td><code>403.7</code></td>
<td>要求客户端证书</td>
</tr>
<tr>
<td><code>403.8</code></td>
<td>站点访问被拒绝</td>
</tr>
<tr>
<td><code>403.9</code></td>
<td>用户数过多</td>
</tr>
<tr>
<td><code>403.10</code></td>
<td>配置无效</td>
</tr>
<tr>
<td><code>403.11</code></td>
<td>密码更改</td>
</tr>
<tr>
<td><code>403.12</code></td>
<td>拒绝访问映射表</td>
</tr>
<tr>
<td><code>403.13</code></td>
<td>客户端证书被吊销</td>
</tr>
<tr>
<td><code>403.14</code></td>
<td>拒绝目录列表</td>
</tr>
<tr>
<td><code>403.15</code></td>
<td>超出客户端访问许可</td>
</tr>
<tr>
<td><code>403.16</code></td>
<td>客户端证书不受信任或无效</td>
</tr>
<tr>
<td><code>403.17</code></td>
<td>客户端证书已过期或尚未生效</td>
</tr>
<tr>
<td><code>403.18</code></td>
<td>再当前的应用程序池中不能执行所请求的URL。这个错误码为<code>IIS 6.0</code>所专用。</td>
</tr>
<tr>
<td><code>403.19</code></td>
<td>不能为这个应用程序池中的客户端执行<code>CGI</code>。这个错误代码为<code>IIS 6.0</code>所专用</td>
</tr>
<tr>
<td><code>403.20</code></td>
<td><code>Passport</code>登录失败。这个错误代码为<code>IIS 6.0</code>所专用</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/404" rel="external" target="_self"><code>404 Not Found</code></a></td>
<td>服务器找不到请求的资源。在浏览器中，这意味着无法识别<code>URL</code>。在<code>API</code>中，这也可能意味着端点有效，但资源本身不存在。服务器也可以发送此响应，而不是 <code>403 Forbidden</code>，以向未经授权的客户端隐藏资源的存在。这个响应代码可能是最广为人知的，因为它经常出现在网络上</td>
</tr>
<tr>
<td><code>404.0</code></td>
<td>(无)-没有找到文件或目录</td>
</tr>
<tr>
<td><code>404.1</code></td>
<td>无法在所请求的端口上访问<code>Web</code>站点</td>
</tr>
<tr>
<td><code>404.2</code></td>
<td><code>Web</code>服务扩展锁定策略组织本请求</td>
</tr>
<tr>
<td><code>404.3</code></td>
<td><code>MIME</code>映射策略阻止本请求</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/405" rel="external" target="_self"><code>405 Method Not Allowed</code></a></td>
<td>服务器知道请求方法，但目标资源不支持该方法。例如，<code>API</code>可能不允许调用<code>DELETE</code>来删除资源。</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/406" rel="external" target="_self"><code>406 Not Acceptable</code></a></td>
<td>当<code>web</code>服务器在执行<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Content_negotiation#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E9%A9%B1%E5%8A%A8%E5%9E%8B%E5%86%85%E5%AE%B9%E5%8D%8F%E5%95%86%E6%9C%BA%E5%88%B6" rel="external" target="_self">服务端驱动型内容协商机制</a>后，没有发现任何符合用户代理给定标准的内容时，就会发送此响应，服务器生成的响应无法被客户端所接受</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/407" rel="external" target="_self"><code>407 Proxy Authentication Required</code></a></td>
<td>类似于<code>401 Unauthorized</code>，但是用户必须首先使用代理服务器进行验证，这样请求才会被处理</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/408" rel="external" target="_self"><code>408 Request Timeout</code></a></td>
<td>此响应由一些服务器在空闲连接上发送，即使客户端之前没有任何请求。这意味着服务器想关闭这个未使用的连接。由于一些浏览器，如<code>Chrome</code>、<code>Firefox 27+</code>或<code>IE9</code>，使用<code>HTTP</code>预连接机制来加速冲浪，所以这种响应被使用得更多。还要注意的是，有些服务器只是关闭了连接而没有发送此消息</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/409" rel="external" target="_self"><code>409 Conflict</code></a></td>
<td>请求与服务器的当前状态冲突，请求无法被完成</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/410" rel="external" target="_self"><code>410 Gone</code></a></td>
<td>当请求的内容已从服务器中永久删除且<strong>页面不可用</strong>也没有转发地址时，将发送此响应。客户端需要删除缓存和指向资源的链接。<code>HTTP</code>规范打算将此状态代码用于<strong>有限时间的促销服务</strong>。<code>API</code>不应被迫指出已使用此状态代码删除的资源</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/411" rel="external" target="_self"><code>411 Length Required</code></a></td>
<td>服务端拒绝该请求因为<code>Content-Length</code>头部字段未定义但是服务端需要它</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/412" rel="external" target="_self"><code>412 Precondition Failed</code></a></td>
<td>客户端在其头文件中指出了服务器不满足的先决条件</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/413" rel="external" target="_self"><code>413 Payload Too Large</code></a></td>
<td>请求实体大于服务器定义的限制。服务器可能会关闭连接，或在标头字段后返回重试<code>Retry-After</code></td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/414" rel="external" target="_self"><code>414 URI Too Long</code></a></td>
<td>客户端请求的<code>URI</code>比服务器愿意接收的长度长。当<code>post</code>请求被转换为带有很长的查询信息的<code>get</code>请求时，就会发生这种情况</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/415" rel="external" target="_self"><code>415 Unsupported Media Type</code></a></td>
<td>服务器不支持请求数据的媒体格式，因此服务器拒绝请求</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/416" rel="external" target="_self"><code>416 Range Not Satisfiable</code></a></td>
<td>无法满足请求中<code>Range</code>标头字段指定的范围。该范围可能超出了目标<code>URI</code>数据的大小，<code>range</code>范围异常，如**<code>rangeStart&lt; 0</code><strong>、</strong><code>rangeStart&gt;rangeEnd</code><strong>、</strong><code>rangeStart&gt;FileSize</code>**</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/417" rel="external" target="_self"><code>417 Expectation Failed</code></a></td>
<td>此响应代码表示服务器无法满足<code>Expect</code>请求标头字段所指示的期望</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/418" rel="external" target="_self"><code>418 I'm a teapot</code></a></td>
<td>服务端拒绝用茶壶煮咖啡。笑话典故来源<a href="https://zh.wikipedia.org/wiki/%E8%B6%85%E6%96%87%E6%9C%AC%E5%92%96%E5%95%A1%E5%A3%B6%E6%8E%A7%E5%88%B6%E5%8D%8F%E8%AE%AE" rel="external" target="_self">茶壶冲泡咖啡</a><!-- raw HTML omitted -->对于接入<code>EdgeOne</code>的域名，系统会自动为域名分配服务节点，且对应的节点均会下发该域名的配置文件，其中文件内容取决于域名的配置，如源站、缓存、头部等。当请求发送给节点时，节点会读取域名的配置文件，当发现配置文件不存在时，则响应<code>418</code>状态码。 例如，客户端请求：<code>http://example.com/test.jpg</code>，则节点会读取域名 <code>example.com</code>的配置文件，可能由于绑定了<code>非 example.com</code> 域名的服务节点，<code>CNAME</code>配置错误或者调度系统异常等原因，客户端会接收到<code>418</code>响应。</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/421" rel="external" target="_self"><code>421 Misdirected Request</code></a></td>
<td>请求被定向到无法生成响应的服务器。这可以由未配置为针对请求<code>URI</code>中包含的方案和权限组合生成响应的服务器发送</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/422" rel="external" target="_self"><code>422 Unprocessable Entity</code></a></td>
<td>请求格式正确，但由于语义错误而无法遵循</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/423" rel="external" target="_self"><code>423 Locked</code></a></td>
<td>正在访问的资源已锁定<!-- raw HTML omitted -->触发请求回环，有以下 2 个场景：<!-- raw HTML omitted --><code>CDN-Loop</code>头部的<code>Loops</code>数值<code>≥ 16</code>，详情请参见 <a href="https://www.tencentcloud.com/document/product/1145/54211#3840f0f9-aacb-408f-a519-31c89191b9ac" rel="external" target="_self"><code>CDN-Loop</code></a><!-- raw HTML omitted -->同一个请求，两次经过同一台节点设备</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/424" rel="external" target="_self"><code>424 Failed Dependency</code></a></td>
<td>由于前一个请求失败，请求失败</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/425" rel="external" target="_self"><code>425 Too Early</code></a></td>
<td>表示服务器不愿意冒险处理可能被重播的请求</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/426" rel="external" target="_self"><code>426 Upgrade Required</code></a></td>
<td>服务器拒绝使用当前协议执行请求，但在客户端升级到其他协议后可能愿意这样做。 服务端发送带有<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Upgrade" rel="external" target="_self"><code>Upgrade</code></a>字段的<code>426</code>响应 来表明它所需的协议（们）</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/428" rel="external" target="_self"><code>428 Precondition Required</code></a></td>
<td>源服务器要求请求是有条件的。此响应旨在防止&rsquo;丢失更新&rsquo;问题，即当第三方修改服务器上的状态时，客户端<code>GET</code>获取资源的状态，对其进行修改并将其<code>PUT</code>放回服务器，从而导致冲突</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/429" rel="external" target="_self"><code>429 Too Many Requests</code></a></td>
<td>用户在给定的时间内发送了太多请求（<strong>限制请求速率</strong>）</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/431" rel="external" target="_self"><code>431 Request Header Fields Too Large</code></a></td>
<td>服务器不愿意处理请求，因为其头字段太大。在减小请求头字段的大小后，可以重新提交请求</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/451" rel="external" target="_self"><code>451 Unavailable For Legal Reasons</code></a></td>
<td>用户代理请求了无法合法提供的资源，例如政府审查的网页</td>
</tr>
<tr>
<td><code>EdgeOne</code>自定义状态码：499</td>
<td>客户端请求到节点，还没等到节点响应就主动断开请求，如关闭请求页面等，则日志&amp;监控会记录为<code>499</code>状态码</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h3 id="500599服务器错误响应"><code>500～599</code>服务器错误响应</h3>
<blockquote>
<table>
<thead>
<tr>
<th>消息</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/500" rel="external" target="_self"><code>500 Internal Server Error</code></a></td>
<td>请求未完成。服务器遇到了不知道如何处理的情况</td>
</tr>
<tr>
<td><code>500.12</code></td>
<td>应用程序正忙于在<code>Web</code>服务器上重启</td>
</tr>
<tr>
<td><code>500.13</code></td>
<td><code>Web</code>服务器太忙</td>
</tr>
<tr>
<td><code>500.15</code></td>
<td>不允许直接请求<code>Global.asa</code></td>
</tr>
<tr>
<td><code>500.16</code></td>
<td><code>UNC</code>授权凭据不正确。这个错误代码为<code>IIS 6.0</code>所专用</td>
</tr>
<tr>
<td><code>500.18</code></td>
<td><code>URL</code>授权存储不能打开。这个错误代码为<code>IIS 6.0</code>所专用</td>
</tr>
<tr>
<td><code>500.100</code></td>
<td>内部<code>ASP</code>错误</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/501" rel="external" target="_self"><code>501 Not Implemented</code></a></td>
<td>服务器不支持请求方法，因此无法处理。服务器需要支持的唯二方法（因此不能返回此代码）是<code>GET and HEAD</code></td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/502" rel="external" target="_self"><code>502 Bad Gateway</code></a></td>
<td>请求未完成。服务器从上游服务器收到一个无效的响应</td>
</tr>
<tr>
<td><code>502.1</code></td>
<td><code>CGI</code>应用程序超时</td>
</tr>
<tr>
<td><code>502.2</code></td>
<td><code>CGI</code>应用程序出错</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/503" rel="external" target="_self"><code>503 Service Unavailable</code></a></td>
<td>服务器没有准备好处理请求，常见原因是<strong>服务器临时过载</strong>或<strong>当机</strong> 请注意，与此响应一起，应发送解释问题的用户友好页面。这个响应应该用于临时条件和如果可能的话，<code>HTTP</code>标头<code>Retry-After</code>字段应该包含恢复服务之前的估计时间。网站管理员还必须注意与此响应一起发送的与缓存相关的标头，因为这些临时条件响应通常不应被缓存</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/504" rel="external" target="_self"><code>504 Gateway Timeout</code></a></td>
<td>当服务器充当网关且<strong>无法及时获得响应</strong>时、<!-- raw HTML omitted -->后端服务执行超时（数据库取数据很慢的时候、后端负载很高、连接超时），<code>Nginx</code>默认的等待时间是<code>60</code>秒，超过<code>60</code>秒<code>Nginx</code>就会返回<!-- raw HTML omitted --><code>504</code></td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/505" rel="external" target="_self"><code>505 HTTP Version Not Supported</code></a></td>
<td>服务器不支持请求中使用的<code>HTTP</code>版本</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/506" rel="external" target="_self"><code>506 Variant Also Negotiates</code></a></td>
<td>服务器存在内部配置错误：所选的变体资源被配置为参与透明内容协商本身，因此不是协商过程中的适当终点</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/507" rel="external" target="_self"><code>507 Insufficient Storage</code></a></td>
<td>无法在资源上执行该方法，因为服务器无法存储成功完成请求所需的表示</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/508" rel="external" target="_self"><code>508 Loop Detected</code></a></td>
<td>服务器在处理请求时检测到无限循环</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/510" rel="external" target="_self"><code>510 Not Extended</code></a></td>
<td>服务器需要对请求进行进一步扩展才能完成请求</td>
</tr>
<tr>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/511" rel="external" target="_self"><code>511 Network Authentication Required</code></a></td>
<td>指示客户端需要进行身份验证才能获得网络访问权限</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h2 id="websocket状态码"><code>WebSocket</code>状态码</h2>
<blockquote>
<ul>
<li><code>websocat</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ websocat <span style="color:#e6db74">&#34;wss://your-websocket-url&#34;</span></span></span></code></pre></div></blockquote>
<ul>
<li><code>wscat</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wscat -c <span style="color:#e6db74">&#34;wss://your-websocket-url&#34;</span> </span></span></code></pre></div></blockquote>
<ul>
<li>正常关闭</li>
</ul>
<blockquote>
<ul>
<li>
<p><strong>1000</strong>: 正常关闭(<code>Normal Closure</code>)</p>
<p>这意味着<code>WebSocket</code>连接已建立并且请求已完成。会话处于空闲状态时，可以观察到此状态，从而导致连接超时</p>
</li>
</ul>
</blockquote>
<ul>
<li>服务器关闭</li>
</ul>
<blockquote>
<ul>
<li>
<p><strong>1001</strong>: 区域或终端设备离开<code>Going Away</code>)</p>
<p>服务器正在关闭，或由于客户端离开或者终端设备关闭，连接即将关闭</p>
</li>
</ul>
</blockquote>
<ul>
<li>协议错误</li>
</ul>
<blockquote>
<ul>
<li>
<p><strong>1002</strong>: 协议错误(<code>Protocol Error</code>)</p>
<p>表示端点由于协议错误，服务器不能处理请求而终止连接</p>
</li>
</ul>
</blockquote>
<ul>
<li>无法接受</li>
</ul>
<blockquote>
<ul>
<li>
<p><strong>1003</strong>: 不支持的数据类型(<code>Unsupported Data</code>)</p>
<p>此状态代码表示错误状态，其中端点以无法接受的格式接收数据而终止连接。端点仅支持文本数据，如果它收到来自客户端的二进制消息或使用不受支持的格式的消息，可能会显示此状态代码</p>
</li>
</ul>
</blockquote>
<ul>
<li>连接超时</li>
</ul>
<blockquote>
<ul>
<li>
<p><strong>1004</strong>: 保留状态码(<code>Reserved</code>)</p>
<p>这个状态码在<code>WebSocket</code>协议中是保留的，通常在实现中不会被使用。它可能在未来被定义用于某些特定的目的</p>
</li>
</ul>
</blockquote>
<ul>
<li>断言失败</li>
</ul>
<blockquote>
<ul>
<li>
<p><strong>1005</strong>: 无状态码(<code>No Status Received</code>)</p>
<p>这个状态码也是保留的，表示连接关闭时没有返回状态码。通常，它由客户端和服务器在不同的上下文中使用来表示关闭时未包含状态码的情况</p>
</li>
</ul>
</blockquote>
<ul>
<li>处理过快</li>
</ul>
<blockquote>
<ul>
<li>
<p><strong>1006</strong>: 异常关闭(<code>Abnormal Closure</code>)</p>
<p>连接由于错误或异常被关闭，没有收到关闭帧</p>
</li>
</ul>
</blockquote>
<ul>
<li>不符合协议</li>
</ul>
<blockquote>
<ul>
<li>
<p><strong>1007</strong>: 不一致的数据(<code>Invalid Frame Payload Data</code>)</p>
<p>服务器收到一个格式不符合协议的数据帧</p>
</li>
</ul>
</blockquote>
<ul>
<li>恶意关闭</li>
</ul>
<blockquote>
<ul>
<li>
<p><strong>1008</strong>: 不合适的关闭(<code>Policy Violation</code>)</p>
<p>此状态代码表示错误状态，端点因收到违反其策略的消息而终止连接。此状态为通用状态，当其他状态代码（例如<code>1003</code>或<code>1009</code>）不适用时显示。如果需要隐藏策略或授权失败（例如签名过期），您还会看到此状态显示</p>
</li>
</ul>
</blockquote>
<ul>
<li>数据太大</li>
</ul>
<blockquote>
<ul>
<li>
<p><strong>1009</strong>: 消息太大(<code>Message Too Big</code>)</p>
<p>服务器无法处理请求的消息，因为它太大</p>
</li>
</ul>
</blockquote>
<ul>
<li>扩展未协商</li>
</ul>
<blockquote>
<ul>
<li>
<p><strong>1010</strong>: 扩展未协商(<code>Missing Extension</code>)</p>
<p>服务器需要客户端支持某些扩展，但客户端没有协商这些扩展</p>
</li>
</ul>
</blockquote>
<ul>
<li>服务器错误</li>
</ul>
<blockquote>
<ul>
<li>
<p><strong>1011</strong>: 服务器错误(<code>Internal Server Error</code>)</p>
<p>此状态代码表示错误状态，其中服务器因遇到意外情况或内部错误而导致无法完成请求而终止连接</p>
</li>
</ul>
</blockquote>
<ul>
<li>服务重启</li>
</ul>
<blockquote>
<ul>
<li>
<p><strong>1012</strong>: 服务器重启(<code>Service Restart</code>)</p>
<p>服务器正在重启</p>
</li>
</ul>
</blockquote>
<ul>
<li>不符合协议的操作</li>
</ul>
<blockquote>
<ul>
<li>
<p><strong>1013</strong>: 不支持的操作(<code>Try Again Later</code>)</p>
<p>服务器无法处理请求，因为它当前无法支持操作，建议稍后重试</p>
</li>
</ul>
</blockquote>
</blockquote>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install-nginx">Install Nginx</h1>

<h2 id="安装nginx">安装<code>nginx</code></h2>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://www.dedecms.com/" rel="external" target="_self"><code>DedeCms</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.discuz.net/" rel="external" target="_self"><code>Discuz!</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://wordpress.com/zh-cn/" rel="external" target="_self"><code>WordPress</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/bettershop/LaikeTui" rel="external" target="_self"><code>LaikeTui</code></a></td>
<td>来客推商城</td>
</tr>
<tr>
<td><a href="https://github.com/crmeb/CRMEB?tab=readme-ov-file" rel="external" target="_self"><code>CRMEB</code></a></td>
<td>商城</td>
</tr>
<tr>
<td><a href="https://www.drupal.org/" rel="external" target="_self"><code>drupal CMS</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://tengine.taobao.org/" rel="external" target="_self"><code>Nginx-Tengine</code></a>、<a href="https://github.com/alibaba/tengine" rel="external" target="_self"><code>Nginx_Github_Tengine</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://openresty.org/cn/" rel="external" target="_self"><code>Nginx-OpenResty</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.cainiao.io/archives/988" rel="external" target="_self"><code>CentOS7</code>上编译安装<code>Tengine</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://metasploit.com/" rel="external" target="_self"><code>Metasploit</code>渗透靶机</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/digininja/DVWA" rel="external" target="_self"><code>DVWA</code>渗透测试靶机</a></td>
<td></td>
</tr>
<tr>
<td><a href="http://redtiger.labs.overthewire.org/" rel="external" target="_self">红虎的黑客<code>SQL</code>注入</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://nginx.org/en/docs/" rel="external" target="_self"><code>nginx documentation</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.businessprocessincubator.com/content/top-20-python-based-cms-that-every-developer-should-know/" rel="external" target="_self">每个开发人员都应该知道的基于<code>Python</code>的<code>20</code>大<code>CMS</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.hws.com/soft/wzs/" rel="external" target="_self">护卫神</a></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->安装依赖扩展包<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># Debian 系统</span>
</span></span><span style="display:flex;"><span>$ sudo apt-get install libpcre3 libpcre3-dev zlib1g-dev
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ yum -y install wget gcc gcc-c++ pcre-devel zlib-devel openssl openssl-devel</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><code>root</code><!-- raw HTML omitted -->用户下载<!-- raw HTML omitted --><code>nginx</code><!-- raw HTML omitted -->安装<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget http://nginx.org/download/nginx-1.20.2.tar.gz -P /usr/local/src/
</span></span><span style="display:flex;"><span>$ tar -zxvf /usr/local/src/nginx-1.20.2.tar.gz  -C /usr/local/src/</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->进入到解压后的目录进行编译安装<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>SSL/TLS</code><!-- raw HTML omitted -->和安全模块<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<p>**<code>--with-http_ssl_module</code>**使用<code>HTTPS</code>协议来<!-- raw HTML omitted -->加密<!-- raw HTML omitted -->客户端与服务器之间的通信
**<code>--with-http_limit_conn_module</code>**限制连接数
**<code>--with-http_limit_req_module</code>**限制请求速率
**<code>--with-http_realip_module</code>**用于从代理服务器中获取真实的客户端<code>IP</code>地址，解决客户端<code>IP</code>被伪造的问题<br>
**<code>--with-http_access_module</code>**提供<code>IP</code>地址访问控制功能，可以限制访问某些<code>IP</code>或<code>IP</code>范围<br>
**<code>--with-http_auth_basic_module</code>**提供基本的<code>HTTP</code>认证功能，可以实现基于用户名和密码的认证<br>
**<code>--with-http_userid_module</code>**提供基于<code>Cookie</code>的会话跟踪功能</p>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->性能优化模块<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<p>**<code>--with-http_v2_module</code>**支持 HTTP/2 协议，可以提高性能和并发处理能力，提供了<!-- raw HTML omitted -->多路复用、头部压缩和服务器推送<!-- raw HTML omitted -->等功能
**<code>--with-http_stub_status_module</code>**允许查看<code>Nginx</code>实例运行<!-- raw HTML omitted -->状态信息<!-- raw HTML omitted -->，如活动连接、处理的请求数等<br>
**<code>--with-http_gzip_static_module</code>**允许<code>Nginx</code>直接提供已经<!-- raw HTML omitted -->压缩<!-- raw HTML omitted -->的静态文件，避免重复压缩，减少服务器负载<br>
**<code>--with-http_upstream_module</code>**支持<!-- raw HTML omitted -->负载均衡<!-- raw HTML omitted --><br>
**<code>--with-http_proxy_module</code>**提供代理功能，可以将请求代理到其他服务器上<br>
**<code>--with-stream_ssl_module</code>**支持流式<code>SSL/TLS</code>，适用于<code>TCP</code>代理和负载均衡</p>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->文件处理模块<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<p>**<code>--with-http_dav_module</code>**提供<code>HTTP</code>协议的扩展功能，支持文件的上传、删除、复制、移动等操作<br>
**<code>--with-http_flv_module</code>**允许<code>Nginx</code>提供<code>FLV</code>视频流服务<br>
**<code>--with-http_mp4_module</code>**允许<code>Nginx</code>处理<code>MP4</code>格式的视频文件，并支持<code>HTTP</code>断点续传<br>
**<code>--with-http_image_filter_module</code>**提供图像处理功能，可以对图像进行缩放、裁剪等操作</p>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->其他模块<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<p>**<code>--with-pcre</code>**提供正则表达式支持，使<code>Nginx</code>能够使用正则表达式进行<code>URL</code>重写、过滤等操作<br>
**<code>--with-http_sub_module</code>**允许在响应内容中进行简单的<!-- raw HTML omitted -->字符串替换<!-- raw HTML omitted -->操作<br>
**<code>--with-http_slice_module</code>**用于将大文件分割成更小的块进行<!-- raw HTML omitted -->分片传输<!-- raw HTML omitted -->
**<code>--with-http_addition_module</code>**允许在响应的头部和主体中<!-- raw HTML omitted -->插入额外的内容<!-- raw HTML omitted -->，如添加自定义的<code>HTTP</code>头部或响应片段<br>
**<code>--with-http_rewrite_module</code>**提供<code>URL</code>重写功能，支持复杂的<code>URL</code>重写规则</p>
</blockquote>
<ul>
<li><!-- raw HTML omitted --><!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /usr/local/src/nginx-1.20.2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 配置</span>
</span></span><span style="display:flex;"><span>$ ./configure --prefix<span style="color:#f92672">=</span>/usr/local/nginx --with-http_ssl_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_v2_module --with-http_stub_status_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-pcre --with-http_gzip_static_module --with-http_dav_module  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_addition_module  --with-http_sub_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_flv_module  --with-http_mp4_module
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 编译、安装</span>
</span></span><span style="display:flex;"><span>$ make -j4 <span style="color:#f92672">&amp;&amp;</span> make install</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->编写启动文件 <!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## chkconfig: - 99 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## description: Nginx Service Control Script
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">PROG=&#34;/usr/local/nginx/sbin/nginx&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">PIDF=&#34;/usr/local/nginx/logs/nginx.pid&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">case &#34;$1&#34; in
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        start)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        $PROG
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        stop)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        kill -3 $(cat $PIDF)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        restart)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        $0 stop &amp;&gt; /dev/null
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        if [ $? -ne 0 ] ; then continue ; fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        $0 start
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        reload)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        kill -1 $(cat $PIDF)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        *)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        echo &#34;Userage: $0 { start | stop | restart | reload }&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        exit 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">esac
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">exit 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;</span> &gt;/etc/init.d/nginx</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->赋予执行权限，并设置开机自启  <!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ chmod +x /etc/init.d/nginx
</span></span><span style="display:flex;"><span>$ chkconfig --add nginx
</span></span><span style="display:flex;"><span>$ chkconfig nginx on
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动nginx服务</span>
</span></span><span style="display:flex;"><span>$ /usr/local/nginx/sbin/nginx
</span></span><span style="display:flex;"><span>$ netstat -nuplt | grep :80</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->非常规安装<!-- raw HTML omitted --><code>Nginx</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>3.1 <!-- raw HTML omitted -->判断用户是否存在，不存在创建，赋予权限<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 判断是否存在  </span>
</span></span><span style="display:flex;"><span>$ id myadmin 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 不存在创建</span>
</span></span><span style="display:flex;"><span>$ <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $? -eq <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>;<span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    groupadd group <span style="color:#f92672">&amp;&amp;</span> useradd -g myadmin myadmin
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;password&#34;</span>|passwd --stdin myadmin &amp;&gt;/dev/null
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 赋予权限</span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;#####  	Start/Stop Service  	#####
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Cmnd_Alias MYADMIN_START_SERVICES = /opt/*, /usr/bin/kill, /etc/init.d/nginx, /opt/data/nginx/sbin/nginx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">myadmin ALL=(ALL)NOPASSWD:MYADMIN_START_SERVICES&#34;</span> &gt;/etc/sudoers.d/myadmin
</span></span><span style="display:flex;"><span>$ chmod <span style="color:#ae81ff">660</span> /etc/sudoers.d/myadmin</span></span></code></pre></div><ul>
<li>3.2 <!-- raw HTML omitted -->创建目录,赋予权限  <!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -p /opt/<span style="color:#f92672">{</span>apps,src,conf,scripts<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ chown -R admin:admin /opt/*</span></span></code></pre></div><ul>
<li>3.3 <!-- raw HTML omitted -->进入解压目录，配置、编译、安装 <!-- raw HTML omitted --></li>
</ul>
<blockquote>
<p>3.3.1 <!-- raw HTML omitted --><code>nginx-auth-ldap、--with-http_auth_request_module</code><!-- raw HTML omitted --></p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ su admin -c <span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">cd /opt/src/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">wget http://nginx.org/download/nginx-1.20.2.tar.gz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">tar -zxvf nginx-1.20.2.tar.gz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">cd nginx-1.20.2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">./configure --prefix=/opt/lucky/nginx \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--with-http_stub_status_module --with-http_ssl_module \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--with-http_gzip_static_module --with-ipv6 --with-stream \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--with-stream_ssl_module --with-http_v2_module \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--with-pcre --with-http_gzip_static_module \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--with-http_dav_module --with-http_addition_module \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--with-http_sub_module --with-http_flv_module \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--with-http_mp4_module --with-stream --user=myadmin --group=myadmin·
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sleep 3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">make -j4 &amp;&amp; make install
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sleep 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sudo /opt/data/nginx/sbin/nginx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo &#34;</span>alias nginx<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;sudo /etc/init.d/nginx&#39;</span><span style="color:#e6db74">&#34; &gt;&gt;/home/myadmin/.bashrc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>$ ss -unplt|grep <span style="color:#ae81ff">80</span></span></span></code></pre></div></blockquote>
<ul>
<li>3.4 <!-- raw HTML omitted -->编写启动文件 <!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/init.d/nginx<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 目录
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">NGINX_PATH=&#34;/opt/apps/nginx&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">start_nginx(){
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ${NGINX_PATH}/sbin/nginx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">stop_nginx(){
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	${NGINX_PATH}/sbin/nginx -s stop
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">reload_nginx(){
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	${NGINX_PATH}/sbin/nginx -s reload
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">check_nginx(){
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	${NGINX_PATH}/sbin/nginx -t
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">### Finally the input handling.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">case &#34;$1&#34; in
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  start)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        start_nginx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  stop)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        stop_nginx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  reload)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        reload_nginx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -t)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        check_nginx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  *)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        echo &#34;Usage: service nginx {start|stop|reload|-t}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        exit 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">esac
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">exit
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>$ chmod +x /etc/init.d/nginx
</span></span><span style="display:flex;"><span>$ chkconfig --add nginx
</span></span><span style="display:flex;"><span>$ chkconfig nginx on</span></span></code></pre></div><div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/usr/lib/systemd/system/nginx.service<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=nginx - high performance web server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Documentation=http://nginx.org/en/docs/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network-online.target remote-fs.target nss-lookup.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Type=forking
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">PidFile=/var/run/nginx.pid
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStartPre=/usr/local/nginx/sbin/nginx -t -c /usr/local/nginx/conf/nginx.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecReload=/usr/local/nginx/sbin/nginx -s reload
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStop=/usr/local/nginx/sbin/nginx -s stop
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecQuit=/usr/local/nginx/sbin/nginx -s quit
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ExecReload=/bin/kill -s HUP $MAINPID
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># ExecStop=/bin/kill -s QUIT $MAINPID
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">PrivateTmp=true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ systemctl daemon-reload
</span></span><span style="display:flex;"><span>$ systemctl enable nginx.service <span style="color:#f92672">&amp;&amp;</span> systemctl start nginx</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->添加系统环境变量、防火墙放行<!-- raw HTML omitted --><code>http、https</code><!-- raw HTML omitted -->服务<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;N;56iexport PATH=/usr/local/nginx/sbin:</span>$PATH<span style="color:#e6db74">&#34;</span> /etc/profile
</span></span><span style="display:flex;"><span>$ source /etc/profile
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ firewall-cmd --zone<span style="color:#f92672">=</span>public --add-service<span style="color:#f92672">={</span>http,https<span style="color:#f92672">}</span> --permanent
</span></span><span style="display:flex;"><span>$ firewall-cmd --reload</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_nginx_third_party_modules">Install_Nginx_Third_Party_Modules</h1>

<h2 id="geoip2定位模块"><code>GeoIP2</code>定位模块</h2>
<blockquote>
<ul>
<li><code>GeoIP2</code><!-- raw HTML omitted -->模块依赖<!-- raw HTML omitted --><code>libmaxminddb</code>库</li>
<li><a href="https://www.miyuru.lk/geoiplegacy" rel="external" target="_self"><code>GeoIP Legacy Databases</code></a></li>
</ul>
</blockquote>
<h3 id="libmaxminddb库"><code>libmaxminddb</code>库</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$  wget -c https://github.com/maxmind/libmaxminddb/releases/download/1.7.1/libmaxminddb-1.7.1.tar.gz -P /usr/local/src  	<span style="color:#75715e"># 下载到指定目录下:-c断点续传、-P下载指定目录，  </span>
</span></span><span style="display:flex;"><span>$ tar -zxvf /usr/local/src/libmaxminddb-1.7.1.tar.gz -C /usr/local/src/
</span></span><span style="display:flex;"><span>$ cd /usr/local/src/libmaxminddb-1.7.1
</span></span><span style="display:flex;"><span>$ ./configure
</span></span><span style="display:flex;"><span>$ make -j6 <span style="color:#f92672">&amp;&amp;</span> make install</span></span></code></pre></div></blockquote>
<h3 id="安装geoip2">安装<code>GeoIP2</code></h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git clone https://github.com/leev/ngx_http_geoip2_module.git /usr/local/nginx/ngx_http_geoip2_module
</span></span><span style="display:flex;"><span>$ ./configure --prefix<span style="color:#f92672">=</span>/usr/local/nginx --add-module<span style="color:#f92672">=</span>/usr/local/nginx/ngx_http_geoip2_module</span></span></code></pre></div></blockquote>
<hr>
<h2 id="ngx_brotli压缩算法"><code>ngx_brotli</code>压缩算法</h2>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->下载安装<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 下载算法包，执行更新ngx_brotli依赖算法，算法依赖自动下载</span>
</span></span><span style="display:flex;"><span>$ wget -c https://codeload.github.com/google/brotli/tar.gz/refs/tags/v1.1.0 -P /usr/local/src
</span></span><span style="display:flex;"><span>$ tar zxvf /usr/local/src/brotli-1.1.0.tar.gz -C /usr/local/src/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 下载安装模块</span>
</span></span><span style="display:flex;"><span>$ git clone https://github.com/google/ngx_brotli /usr/local/nginx/ngx_brotli
</span></span><span style="display:flex;"><span>$ cd /usr/local/nginx/ngx_brotli
</span></span><span style="display:flex;"><span>$ git submodule update --init  	<span style="color:#75715e"># 更新ngx_brotli以来算法</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ mv /usr/local/src/brotli-1.1.0/* /usr/local/nginx/ngx_brotli/deps/brotli/</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->动态编译<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /usr/local/src/nginx-1.20.2
</span></span><span style="display:flex;"><span>$ ./configure --with-compat --add-dynamic-module<span style="color:#f92672">=</span>/usr/local/src/ngx_brotli --prefix<span style="color:#f92672">=</span>/usr/local/nginx
</span></span><span style="display:flex;"><span>$ make modules
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 拷贝模块和主程序到Nginx安装目录下新创建的文件夹内：modules</span>
</span></span><span style="display:flex;"><span>$ cp /usr/local/src/nginx-1.20.2/objs/ngx_http_brotli_static_module.so /usr/local/nginx/modules/ngx_http_brotli_static_module.so
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cp /usr/local/src/nginx-1.20.2/objs/ngx_http_brotli_filter_module.so /usr/local/nginx/modules/ngx_http_brotli_filter_module.so
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cp /usr/local/src/nginx-1.20.2/objs/nginx /usr/local/nginx/sbin/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在ngixn.conf配置文件最上面动态加载模块</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/usr/local/nginx/conf/nginx.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">load_module /usr/local/nginx/modules/ngx_http_brotli_filter_module.so;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">load_module /usr/local/nginx/modules/ngx_http_brotli_static_module.so;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->静态编译<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /usr/local/src/nginx-1.20.2
</span></span><span style="display:flex;"><span>$ ./configure --prefix<span style="color:#f92672">=</span>/usr/local/nginx --add-module<span style="color:#f92672">=</span>/usr/local/nginx/ngx_brotli</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h2 id="nginx-redis2模块"><code>Nginx-Redis2</code>模块</h2>
<blockquote>
<ul>
<li>
<ol>
<li><a href="https://github.com/openresty/redis2-nginx-module" rel="external" target="_self"><code>Redis2-Nginx-Module</code></a></li>
</ol>
</li>
<li><!-- raw HTML omitted -->写入请求<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>location <span style="color:#f92672">=</span> /foo <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    default_type text/html;
</span></span><span style="display:flex;"><span>    redis2_query auth password;
</span></span><span style="display:flex;"><span>    set $value <span style="color:#e6db74">&#39;first&#39;</span>;  	<span style="color:#75715e"># 设置一个变量</span>
</span></span><span style="display:flex;"><span>    redis2_query set one $value;  <span style="color:#75715e"># 变量写入值</span>
</span></span><span style="display:flex;"><span>    redis2_pass 127.0.0.1:6379;
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div><ul>
<li><code>get</code><!-- raw HTML omitted -->获取值<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>location <span style="color:#f92672">=</span> /get <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    default_type text/html;
</span></span><span style="display:flex;"><span>    redis2_pass 127.0.0.1:6379;
</span></span><span style="display:flex;"><span>    redis2_query auth password;
</span></span><span style="display:flex;"><span>    set_unescape_uri $key $arg_key;  <span style="color:#75715e"># 第三方转义模块：ngx_set_misc 进行url编码转义</span>
</span></span><span style="display:flex;"><span>    redis2_query get $key;  	<span style="color:#75715e"># 获取键值</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted --><!-- raw HTML omitted --></li>
</ul>
</blockquote>
<hr>
<h2 id="sticky会话保持模块"><code>Sticky</code>会话保持模块</h2>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html#sticky" rel="external" target="_self">官网<code>Sticky</code>文档</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/bymaximus/nginx-sticky-module-ng" rel="external" target="_self"><code>Github</code>代码托管<code>Sticky</code>文档</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://bitbucket.org/nginx-goodies/nginx-sticky-module-ng/src/master/" rel="external" target="_self"><code>Google</code>开发<code>Sticky</code>模块托管在<code>Bitbuckey</code></a></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git clone git clone https://huanggua1234@bitbucket.org/nginx-goodies/nginx-sticky-module-ng.git
</span></span><span style="display:flex;"><span>$ ./configure --prefix<span style="color:#f92672">=</span>/usr/local/nginx --add-module<span style="color:#f92672">=</span>/usr/local/nginx/nginx_goodies-nginx-sticky-module-ng-c78b7dd79d0d
</span></span><span style="display:flex;"><span>$ make
</span></span><span style="display:flex;"><span>$ make upgrade  	<span style="color:#75715e"># 检测甄别第三方模块，检查好后拷贝替换make后的可执行文件</span></span></span></code></pre></div><ul>
<li>
<ol>
<li><code>openssl</code><!-- raw HTML omitted -->编译报错修改原文件，在第12行添加一下两行内容<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;ngx_http_sticky_misc.c<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#include &lt;openssl/sha.h&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#include &lt;openssl/md5.h&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li>
<ol start="2">
<li>使用<code>Sticky</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>name=route</code><!-- raw HTML omitted -->下发<!-- raw HTML omitted --><code>cookie</code><!-- raw HTML omitted -->名称<!-- raw HTML omitted --></li>
<li><code>expires=6h;</code><!-- raw HTML omitted -->定义过期时间<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;upstream.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    sticky;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    server 192.168.1.1:8080;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    server 192.168.1.2:8080;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h2 id="concat合并请求模块"><code>concat</code>合并请求模块</h2>
<blockquote>
<ul>
<li>
<ol>
<li><a href="https://github.com/alibaba/nginx-http-concat" rel="external" target="_self"><code>Alibaba Concat</code>请求合并模块</a></li>
</ol>
</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git clone https://github.com/alibaba/nginx-http-concat.git /usr/local/nginx/nginx-http-concat
</span></span><span style="display:flex;"><span>$ cd /usr/local/src/nginx-1.20.2/
</span></span><span style="display:flex;"><span>$ ./configure --prefix<span style="color:#f92672">=</span>/usr/local/nginx --add-module<span style="color:#f92672">=</span>/usr/local/nginx/nginx-http-concat</span></span></code></pre></div></blockquote>
<hr>
<h2 id="slab_stat共享内存的状态信息"><code>slab_stat</code>共享内存的状态信息</h2>
<blockquote>
<ul>
<li><a href="https://tengine.taobao.org/document_cn/ngx_slab_stat_cn.html" rel="external" target="_self"><code>ngx_slab_stat</code></a></li>
</ul>
</blockquote>
<hr>
<h2 id="upstream_check后端服务端口检测模块"><code>upstream_check</code>后端服务端口检测模块</h2>
<blockquote>
<ul>
<li>
<ol>
<li>访问<code>http://ip/status</code><!-- raw HTML omitted -->就看到监控页面<!-- raw HTML omitted --></li>
</ol>
</li>
<li>
<ol start="2">
<li><a href="http://tengine.taobao.org/document_cn/http_upstream_check_cn.html" rel="external" target="_self"><code>Tengine.taobao ngx_http_upstream_check_module</code></a></li>
</ol>
</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git clone https://github.com/yaoweibin/nginx_upstream_check_module.git /usr/local/nginx/nginx_upstream_check_module  	<span style="color:#75715e"># 下载检测包  </span>
</span></span><span style="display:flex;"><span>$ cd /usr/local/src/nginx-1.20.2/
</span></span><span style="display:flex;"><span>$ ./configure --prefix<span style="color:#f92672">=</span>/usr/local/nginx --add-module<span style="color:#f92672">=</span>/usr/local/nginx/nginx_upstream_check_module</span></span></code></pre></div></blockquote>
<hr>
<h2 id="ngx_cache_purge缓存清理模块"><code>ngx_cache_purge</code>缓存清理模块</h2>
<blockquote>
<ul>
<li>
<ol>
<li><a href="https://github.com/FRICKLE/ngx_cache_purge" rel="external" target="_self"><code>Ngx_cache_purge</code></a></li>
</ol>
</li>
<li><!-- raw HTML omitted -->相同位置语法<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>http <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    proxy_cache_path  /tmp/cache  keys_zone<span style="color:#f92672">=</span>tmpcache:10m;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    server <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        location / <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            proxy_pass         http://127.0.0.1:8000;
</span></span><span style="display:flex;"><span>            proxy_cache        tmpcache;
</span></span><span style="display:flex;"><span>            proxy_cache_key    $uri$is_args$args;
</span></span><span style="display:flex;"><span>            proxy_cache_purge  PURGE from 127.0.0.1;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->单独位置语法<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>http <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    proxy_cache_path  /tmp/cache  keys_zone<span style="color:#f92672">=</span>tmpcache:10m;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    server <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        location / <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            proxy_pass         http://127.0.0.1:8000;
</span></span><span style="display:flex;"><span>            proxy_cache        tmpcache;
</span></span><span style="display:flex;"><span>            proxy_cache_key    $uri$is_args$args;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        location ~ /purge<span style="color:#f92672">(</span>/.*<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            allow              127.0.0.1;
</span></span><span style="display:flex;"><span>            deny               all;
</span></span><span style="display:flex;"><span>            proxy_cache_purge  tmpcache $1$is_args$args;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="configure_nginx">Configure_Nginx</h1>

<h2 id="配置nginx">配置<code>Nginx</code></h2>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://www.freenom.com/zh/index.html?lang=zh" rel="external" target="_self">免费域名申请</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://vercel.com/" rel="external" target="_self"><code>Vercel CDN</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://beian.miit.gov.cn/#/Integrated/index" rel="external" target="_self">工信部备案查询</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.serverhunter.com/" rel="external" target="_self">查找便宜服务器</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.cnblogs.com/zhongyehai/category/1406152.html?page=1" rel="external" target="_self">随笔分类 - <code>Nginx</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://fly.io/" rel="external" target="_self"><code>fly.io</code>边缘服务器</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://porkbun.com/" rel="external" target="_self"><code>Porkbun</code>域名购买商</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.domcomp.com/" rel="external" target="_self"><code>Domcomp</code>域名价格对比网站</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://tld-list.com/" rel="external" target="_self"><code>TLD List</code>域名价格对比网站</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/oneinstack/oneinstack" rel="external" target="_self"><code>Oneinstack</code></a></td>
<td>服务安装脚本</td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>
<ol>
<li><code>ab</code><!-- raw HTML omitted -->压力测试工具<!-- raw HTML omitted -->，<a href="https://www.charlesproxy.com/" rel="external" target="_self"><code>Charles</code>抓包工具</a></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install httpd-tools
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ab -n <span style="color:#ae81ff">50</span> -c <span style="color:#ae81ff">20</span> http://127.0.0.1/index.html  	<span style="color:#75715e"># -n：总共发起的请求数，这里设置为50、</span>
</span></span><span style="display:flex;"><span>								<span style="color:#75715e"># -c：同时并发的请求，这里设置为20个、</span>
</span></span><span style="display:flex;"><span>								<span style="color:#75715e"># -k：是否开启长连接</span></span></span></code></pre></div><ul>
<li><code>ab</code><!-- raw HTML omitted -->探测到性能指标<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>Concurrency Level</code><!-- raw HTML omitted -->：设定的并发数<!-- raw HTML omitted --></li>
<li><code>Time taken for tests</code><!-- raw HTML omitted -->：压测总共花费的时间<!-- raw HTML omitted --></li>
<li><code>Complete requests</code><!-- raw HTML omitted -->：总请求数<!-- raw HTML omitted --></li>
<li><code>Failed requests</code><!-- raw HTML omitted -->：失败的个数<!-- raw HTML omitted --></li>
<li><code>Requests per second</code><!-- raw HTML omitted -->：每秒请求数<!-- raw HTML omitted --><code>TPS</code></li>
<li><code>Time per request</code><!-- raw HTML omitted -->：从客户端来看，一个请求需要用到的时间<!-- raw HTML omitted --></li>
<li><code>Time per request</code><!-- raw HTML omitted -->：从服务端来看，处理一个请求要花费的时间<!-- raw HTML omitted --></li>
<li><code>Transfer rate</code><!-- raw HTML omitted -->：传输的速率<!-- raw HTML omitted --></li>
</ul>
</blockquote>
</blockquote>
<ul>
<li>
<ol start="2">
<li><code>Nginx</code><!-- raw HTML omitted -->基于<!-- raw HTML omitted --><code>Lua</code><!-- raw HTML omitted -->做<!-- raw HTML omitted --><code>Waf</code><!-- raw HTML omitted -->规则过滤<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><a href="https://github.com/loveshell/ngx_lua_waf" rel="external" target="_self"><code>ngx_lua_waf</code></a></li>
</ul>
</blockquote>
<hr>
<h3 id="logrodate使用"><code>logrodate</code>使用</h3>
<blockquote>
<ul>
<li></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ man logrotate  	<span style="color:#75715e">#  查看使用详情 </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;/etc/logrotate.d/nginx<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/opt/apps/nginx/logs/*.log{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">copytruncate  	# 用于还在打开中的日志文件，把当前日志备份并截断
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">daily  	# 安日期轮转日志：daily(天)、weekly(月)、monthly(月)、yearly(年)。
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">dateext  	# 文件后缀是日期格式,也就是切割后文件是:xxx.log-20150828.gz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rotate 7  	# 指定日志文件删除之前转储的次数，0指没有备份，7指保留7个备份
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">missingok  	# 如果日志不存在则忽略该警告信息
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">compress  	# 通过gzip压缩转储以后的日志（gzip -d xxx.gz解压）
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">notifempty  	# 如果是空文件的话，不转储
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">size 100k	# 在日志大小大于 logsize（例如 100K，4M）时轮换
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">su root root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">} 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 手动调试验证：-d</span>
</span></span><span style="display:flex;"><span>$ /usr/sbin/logrotate -d /etc/logrotate.d/nginx
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 手动强制执行：-f</span>
</span></span><span style="display:flex;"><span>$ /usr/sbin/logrotate -f /etc/logrotate.d/nginx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 新增刪除7天以前log定時腳本  </span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;###nginx超過七天log刪除
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">1 0 * * * /bin/bash /opt/scripts/DEL_NGINX.sh &gt;&gt; ~/del_tom.log 2&gt;&amp;1&#34;</span> &gt;&gt; /var/spool/cron/admin</span></span></code></pre></div></blockquote>
<hr>
<h3 id="json日志格式"><code>Json</code>日志格式</h3>
<blockquote>
<table>
<thead>
<tr>
<th>变量名</th>
<th>描述</th>
<th>举例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>'&quot;@timestamp&quot;:&quot;$time_iso8601&quot;,'</code></td>
<td><code>ISO 8601</code>标准格式的当地时间</td>
<td></td>
</tr>
<tr>
<td><code>'&quot;uri&quot;:&quot;$uri&quot;,'</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>'&quot;args&quot;:&quot;$args&quot;,'</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>'&quot;host&quot;:&quot;$host&quot;,'</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>'&quot;https&quot;:&quot;$https&quot;,'</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>'&quot;scheme&quot;:&quot;$scheme&quot;,' </code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>'&quot;domain&quot;:&quot;$domain&quot;,'</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>'&quot;status&quot;:&quot;$status&quot;,'</code></td>
<td><code>HTTP</code>请求状态码</td>
<td><code>200 403 499 502 503</code></td>
</tr>
<tr>
<td><code>'&quot;request&quot;:&quot;$request&quot;,'</code></td>
<td>请求的<code>URI</code>和<code>HTTP</code>协议</td>
<td><code>&quot;GET /api/img/home/logo-aipay.png HTTP/1.1&quot;</code></td>
</tr>
<tr>
<td><code>'&quot;hostname&quot;:&quot;$hostname&quot;,'</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>'&quot;http_host&quot;:&quot;$http_host&quot;,'</code></td>
<td>访问的域名或者<code>IP</code></td>
<td><code>www.domain.com</code><!-- raw HTML omitted -->192.168.1.1</td>
</tr>
<tr>
<td><code>'&quot;time_local&quot;:&quot;$time_local&quot;,'</code></td>
<td>通用日志格式中的本地时间</td>
<td><code>18/Jul/2021:13:00:00 +0800</code></td>
</tr>
<tr>
<td><code>'&quot;ssl_cipher&quot;:&quot;$ssl_cipher&quot;,'</code></td>
<td>交换数据中的算法</td>
<td><code>RC4-SHA</code></td>
</tr>
<tr>
<td><code>'&quot;requesturl&quot;:&quot;$request_uri&quot;,'</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>'&quot;remote_addr&quot;:&quot;$remote_addr&quot;,'</code></td>
<td>客户端地址</td>
<td></td>
</tr>
<tr>
<td><code>'&quot;remote_user&quot;:&quot;$remote_user&quot;,'</code></td>
<td>客户端用户名称</td>
<td></td>
</tr>
<tr>
<td><code>'&quot;server_addr&quot;:&quot;$server_addr&quot;,'</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>'&quot;http_cookie&quot;:&quot;$http_cookie&quot;,'</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>'&quot;http_gp_xreal&quot;:&quot;$http_GP_IP&quot;,' </code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>'&quot;ssl_protocol&quot;:&quot;$ssl_protocol&quot;,'</code></td>
<td><code>SSL</code>协议版本</td>
<td><code>TLSv1</code></td>
</tr>
<tr>
<td><code>'&quot;request_body&quot;:&quot;$request_body&quot;,'</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>'&quot;request_time&quot;:&quot;$request_time&quot;,' </code></td>
<td>整个请求的总时间</td>
<td></td>
</tr>
<tr>
<td><code>'&quot;http_referer&quot;:&quot;$http_referer&quot;,' </code></td>
<td>跳转来源</td>
<td></td>
</tr>
<tr>
<td><code>'&quot;client_realip&quot;:&quot;$clientRealIp&quot;,'</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>'&quot;upstream_addr&quot;:&quot;$upstream_addr&quot;,'</code></td>
<td><code>upstream</code>代理的后端服务地址</td>
<td><code>java tomcat php</code></td>
</tr>
<tr>
<td><code>'&quot;request_length&quot;:&quot;$request_length&quot;,'</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>'&quot;upstream_status&quot;:&quot;$upstream_status&quot;,'</code></td>
<td><code>upstream</code>状态码</td>
<td><code>200 403 499 502 503</code></td>
</tr>
<tr>
<td><code>'&quot;body_bytes_sent&quot;:&quot;$body_bytes_sent&quot;,'</code></td>
<td>发送给客户的文件大小</td>
<td></td>
</tr>
<tr>
<td><code>'&quot;http_user_agent&quot;:&quot;$http_user_agent&quot;,'</code></td>
<td>用户浏览器访问类型</td>
<td></td>
</tr>
<tr>
<td><code>'&quot;http_wangsu_xreal&quot;:&quot;$http_cdn_src_IP&quot;,'</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>'&quot;http_ali_xreal&quot;:&quot;$http_Ali_CDN_Real_IP&quot;,'</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>'&quot;http_cf_xreal&quot;:&quot;$http_CF_Connecting_IP&quot;,'</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>'&quot;http_x_forwarded_for&quot;:&quot;$http_x_forwarded_for&quot;,'</code></td>
<td></td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>'&quot;upstream_response_time&quot;:&quot;$upstream_response_time&quot;,'</code></td>
<td>请求过程中，<code>upstream</code>响应时间</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>'&quot;proxy_add_x_forwarded_for&quot;:&quot;$proxy_add_x_forwarded_for&quot;,'</code></td>
<td>&mdash;</td>
<td>&mdash;</td>
</tr>
</tbody>
</table>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">log_format</span> <span style="color:#e6db74">json</span> <span style="color:#e6db74">escape=json</span>  <span style="color:#e6db74">&#39;</span>{<span style="color:#f92672">&#34;@timestamp&#34;:&#34;$time_iso8601&#34;,&#39;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;client_realip&#34;:&#34;</span>$clientRealIp&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;remote_addr&#34;:&#34;</span>$remote_addr&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;status&#34;:&#34;</span>$status&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;upstream_status&#34;:&#34;</span>$upstream_status&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;request_time&#34;:&#34;</span>$request_time&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;upstream_response_time&#34;:&#34;</span>$upstream_response_time&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;upstream_addr&#34;:&#34;</span>$upstream_addr&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;request&#34;:&#34;</span>$request&#34;,&#39;
</span></span><span style="display:flex;"><span>  	<span style="color:#e6db74">&#39;&#34;http_scheme&#34;:&#34;</span>$http_X_Forwarded_Proto&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;server_name&#34;:&#34;</span>$host&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;uri&#34;:&#34;</span>$uri&#34;,&#39;
</span></span><span style="display:flex;"><span>  	<span style="color:#e6db74">&#39;&#34;request_body&#34;:&#34;</span>$request_body&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;body_bytes_sent&#34;:&#34;</span>$body_bytes_sent&#34;,&#39;
</span></span><span style="display:flex;"><span>  	<span style="color:#e6db74">&#39;&#34;bytes_sent&#34;:&#34;</span>$body_bytes_sent&#34;, <span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;request_length&#34;:&#34;</span>$request_length&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;http_referer&#34;:&#34;</span>$http_referer&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;http_wangsu_xreal&#34;:&#34;</span>$http_cdn_src_IP&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;http_ali_xreal&#34;:&#34;</span>$http_Ali_CDN_Real_IP&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;http_cf_xreal&#34;:&#34;</span>$http_CF_Connecting_IP&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;http_gp_xreal&#34;:&#34;</span>$http_GP_IP&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;http_x_forwarded_for&#34;:&#34;</span>$proxy_add_x_forwarded_for&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;http_user_agent&#34;:&#34;</span>$http_user_agent&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;xdevice&#34;:&#34;</span>$http_x_device&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;xversion&#34;:&#34;</span>$http_x_version&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;trace-id&#34;:&#34;</span>$http_x_trace_id&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;uid&#34;:&#34;</span>$http_x_id&#34;&#39;
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;</span><span style="color:#960050;background-color:#1e0010">}</span><span style="color:#e6db74">&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#f92672">这里注意使用下划线，</span></span></span></code></pre></div><ul>
<li><code>Json</code><!-- raw HTML omitted -->方式查看日志<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ tail -n1 /var/log/nginx/gitlab.log | awk -F <span style="color:#e6db74">&#39;&#34;&#39;</span> <span style="color:#e6db74">&#39;{if($3 == &#34;x.x.x.x&#34; &amp;&amp; $6 != &#34;403&#34;) {print $0}}&#39;</span> | jq</span></span></code></pre></div></blockquote>
<hr>
<h3 id="系统排查">系统排查</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># URL解码、编码</span>
</span></span><span style="display:flex;"><span>$ yum -y install gridsite-clients
</span></span><span style="display:flex;"><span>$ tail -n10 nginx.logs | awk -F <span style="color:#e6db74">&#39;[:]&#39;</span> <span style="color:#e6db74">&#39;{print $24}&#39;</span> | xargs urlencode -d decode
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 后台加白</span>
</span></span><span style="display:flex;"><span>$ sed -Ei <span style="color:#e6db74">&#34;s@((([0-9]{1,3}\.?){4})+)@\1|{{ ip }}@&#34;</span> /usr/local/nginx/conf/vhosts/ white_list.ini
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除加白</span>
</span></span><span style="display:flex;"><span>$ sed -Ei <span style="color:#e6db74">&#34;s@((\|?){{ ip }}\|?)@\2@&#34;</span> /usr/local/nginx/conf/vhosts/ white_list.ini
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 排查系统中内存占用前 5 的进程</span>
</span></span><span style="display:flex;"><span>$ ps -eo pid,ppid,cmd,%mem,%cpu --sort<span style="color:#f92672">=</span>-%mem |head -5
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># nginx</span>
</span></span><span style="display:flex;"><span>$ netstat -ntu|awk <span style="color:#e6db74">&#39;{print $5}&#39;</span>|cut -d: -f1|wc -l  	<span style="color:#75715e"># 查看文件打开数量</span>
</span></span><span style="display:flex;"><span>$ netstat -n | awk <span style="color:#e6db74">&#39;/^tcp/ {++S[$NF]} END {for(a in S) print a, S[a]}&#39;</span>  	<span style="color:#75715e"># 查看服务器网络负载</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ tail -n100 /opt/logs/nginx/web_access.log |awk <span style="color:#e6db74">&#39;{print $1}&#39;</span> |sort -rn |uniq -c |sort -rn |head
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 命令行跨域测试 -i：允许跨域的域名，-H：访问域名</span>
</span></span><span style="display:flex;"><span>$ curl -i https://baidu.com/text.txt -H <span style="color:#e6db74">&#34;Origin: http://www.example.com&#34;</span></span></span></code></pre></div><ul>
<li>打开浏览器按<code>F12</code>然后访问跨域域名，查看是否显示有：<code>access-control-allow-origin: *</code>跨域参数</li>
</ul>
</blockquote>
<hr>
<h3 id="nginxconf配置文件"><code>nginx.conf</code>配置文件</h3>
<blockquote>
<ul>
<li><code>pcretest</code>允许用户直接在命令行中测试和调试<code>PCRE</code>正则表达式的行为和功能</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ pcretest
</span></span><span style="display:flex;"><span>PCRE version 8.43 2019-02-23
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  re&gt; /<span style="color:#f92672">(</span><span style="color:#ae81ff">\d</span>+<span style="color:#f92672">)</span><span style="color:#ae81ff">\.</span><span style="color:#f92672">(</span><span style="color:#ae81ff">\d</span>+<span style="color:#f92672">)</span><span style="color:#ae81ff">\.</span><span style="color:#f92672">(</span><span style="color:#ae81ff">\d</span>+<span style="color:#f92672">)</span><span style="color:#ae81ff">\.</span><span style="color:#f92672">(</span><span style="color:#ae81ff">\d</span>+<span style="color:#f92672">)</span>/
</span></span><span style="display:flex;"><span>data&gt; 192.168.1.1
</span></span><span style="display:flex;"><span> 0: 192.168.1.1
</span></span><span style="display:flex;"><span> 1: <span style="color:#ae81ff">192</span>
</span></span><span style="display:flex;"><span> 2: <span style="color:#ae81ff">168</span>
</span></span><span style="display:flex;"><span> 3: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span> 4: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ pcretest -f patterns.txt -e <span style="color:#e6db74">&#34;input-string&#34;</span></span></span></code></pre></div><table>
<thead>
<tr>
<th>代码</th>
<th>描述</th>
<th>元字符</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>.</code></td>
<td>匹配除换行符意外的任意字符</td>
<td></td>
</tr>
<tr>
<td><code>\w</code></td>
<td>匹配字母、数字、下划线、汉字等</td>
<td></td>
</tr>
<tr>
<td><code>\s</code></td>
<td>匹配任意的空白符</td>
<td></td>
</tr>
<tr>
<td><code>\d</code></td>
<td>匹配数字</td>
<td></td>
</tr>
<tr>
<td><code>\b</code></td>
<td>匹配单词的开始或结束</td>
<td></td>
</tr>
<tr>
<td><code>^</code></td>
<td>匹配字符串的开始</td>
<td></td>
</tr>
<tr>
<td><code>$</code></td>
<td>匹配字符串的结束</td>
<td></td>
</tr>
<tr>
<td><code>()</code></td>
<td>分组</td>
<td></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>代码</th>
<th>说明</th>
<th>重复</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>*</code></td>
<td>重复零次或更多次</td>
<td></td>
</tr>
<tr>
<td><code>+</code></td>
<td>重复一次或更多次</td>
<td></td>
</tr>
<tr>
<td><code>?</code></td>
<td>重复零次或一次</td>
<td></td>
</tr>
<tr>
<td><code>{n}</code></td>
<td>重复<code>n</code>次</td>
<td></td>
</tr>
<tr>
<td><code>{n,}</code></td>
<td>重复<code>n</code>次或更多次</td>
<td></td>
</tr>
<tr>
<td><code>{n,m}</code></td>
<td>重复<code>n</code>次到<code>m</code>次</td>
<td></td>
</tr>
</tbody>
</table>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e"># 用户和组: user nobody nogroup;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">user</span> <span style="color:#e6db74">nobody</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># nginx进程数，auto为自动
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">worker_processes</span> <span style="color:#e6db74">auto</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">worker_cpu_affinity</span>  <span style="color:#e6db74">auto</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># nginx进程打开的最多文件描述符数目，理论值应该是最多打开文件数（ulimit -n）与 nginx 进程数相除，但是 nginx 分配请求并不是那么均匀，所以最好与 ulimit -n 的值保持一致
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">worker_rlimit_nofile</span> <span style="color:#ae81ff">51200</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">error_log</span> <span style="color:#e6db74">/usr/local/nginx/logs/web_error.log</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pid</span> <span style="color:#e6db74">/usr/local/nginx/logs/nginx.pid</span>;</span></span></code></pre></div><ul>
<li><code>events</code><!-- raw HTML omitted -->参数配置<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">events</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 使用epoll的I/O模型
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">use</span> <span style="color:#e6db74">epoll</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 每个进程允许的最多连接数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">worker_connections</span>  <span style="color:#ae81ff">2048</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">multi_accept</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>	}</span></span></code></pre></div></blockquote>
<ul>
<li><code>http</code><!-- raw HTML omitted -->参数配置<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">http</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">log_format</span> <span style="color:#e6db74">main</span> <span style="color:#e6db74">&#39;</span>$remote_addr <span style="color:#e6db74">-</span> $remote_user <span style="color:#e6db74">[</span>$time_iso8601] <span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#39;fwf[</span>$http_x_forwarded_for] <span style="color:#e6db74">tip[</span>$http_true_client_ip] <span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#39;</span>$upstream_addr $upstream_response_time $request_time <span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#39;</span>$http_host $request <span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#39;&#34;</span>$status&#34; $body_bytes_sent $request_body <span style="color:#e6db74">&#34;</span>$http_referer&#34; <span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#39;&#34;</span>$http_accept_language&#34; <span style="color:#e6db74">&#34;</span>$http_user_agent&#34; <span style="color:#e6db74">&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">access_log</span>  <span style="color:#e6db74">/usr/local/nginx/logs/web_access.log</span>  <span style="color:#e6db74">main</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 调用 mime.types 请求头
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">include</span>             <span style="color:#e6db74">mime.types</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 默认数据流模式
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">default_type</span>        <span style="color:#e6db74">application/octet-stream</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 基本配置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">include</span> <span style="color:#e6db74">inc.d/basic.ini</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 缓存配置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e"># include inc.d/cache.ini;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># fastcgi 配置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">include</span> <span style="color:#e6db74">inc.d/fastcgi.ini</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 压缩配置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">include</span> <span style="color:#e6db74">inc.d/compaction.ini</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># IP 限制配置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">include</span> <span style="color:#e6db74">inc.d/ip-limits.ini</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 请求头
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">include</span> <span style="color:#e6db74">inc.d/proxy_set_header.ini</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 日志配置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">include</span> <span style="color:#e6db74">inc.d/logs.ini</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 访问频率限制
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">include</span> <span style="color:#e6db74">inc.d/limit-speed.ini</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 跨域
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">include</span> <span style="color:#e6db74">inc.d/cross-domain.ini</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 反代缓存
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">include</span> <span style="color:#e6db74">inc.d/reverse-proxy.ini</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">include</span> <span style="color:#e6db74">vhosts/*.conf</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">include</span> <span style="color:#e6db74">vhosts/*/*.conf</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->基本配置<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e"># include inc.d/basic.ini;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改lua脚本后不重启nginx配置， 对服务性能不友好，脚本编写期间使用此配置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">lua_code_cache</span> <span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生命一个名称为：shared_data，大小：1Mb内存空间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">lua_shared_dict</span> <span style="color:#e6db74">shared_data</span> <span style="color:#ae81ff">1m</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 显示json数据中文乱码问题
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">charset</span> <span style="color:#e6db74">utf-8</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 零拷贝模式
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">sendfile</span>	<span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 作用：sendfile开启的情况下，提高网络包的传输效率
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">tcp_nopush</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">tcp_nodelay</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># keepalive 超时时间 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">keepalive_timeout</span>  <span style="color:#ae81ff">90</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 一个Tcp复用中，可以并发接受的请求
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">keepalive_requests</span> <span style="color:#ae81ff">1000</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">server_names_hash_max_size</span> <span style="color:#ae81ff">1024</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># nginx关掉版本号
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">server_tokens</span> <span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">server_names_hash_bucket_size</span> <span style="color:#ae81ff">128</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">large_client_header_buffers</span> <span style="color:#ae81ff">8</span> <span style="color:#ae81ff">128k</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 允许客户端请求的最大单文件字节数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">client_max_body_size</span> <span style="color:#ae81ff">8m</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 缓冲区代理缓冲用户端请求的最大字节数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">client_body_buffer_size</span> <span style="color:#ae81ff">16m</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">client_header_buffer_size</span> <span style="color:#ae81ff">4k</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 不配置或者是off,请求头中的自定义请求头用 - 连接是支持的，不要配置 _ 来接收,如果是下划线 _ 自定义请求头会丢失
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">underscores_in_headers</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">proxy_buffer_size</span> <span style="color:#ae81ff">32k</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 读取上游服务器资源，边读边发送数据资源
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">proxy_buffering</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在内存中划分32个128K大小的内存缓冲块，缓冲数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">proxy_buffers</span> <span style="color:#ae81ff">32</span> <span style="color:#ae81ff">128k</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">proxy_connect_timeout</span> <span style="color:#ae81ff">60</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">proxy_read_timeout</span> <span style="color:#ae81ff">60</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">proxy_send_timeout</span> <span style="color:#ae81ff">5</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 读取proxy_pass数据写入到磁盘的最大值，默认1G，0:表示关闭缓存限制
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">proxy_max_temp_file_size</span> <span style="color:#ae81ff">1024m</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">proxy_busy_buffers_size</span> <span style="color:#ae81ff">128k</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 缓存文件夹大小
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">proxy_temp_file_write_size</span> <span style="color:#ae81ff">128k</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">proxy_headers_hash_max_size</span> <span style="color:#ae81ff">51200</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">proxy_headers_hash_bucket_size</span> <span style="color:#ae81ff">6400</span>;</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->缓存配置<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e"># include inc.d/cache.ini;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 打开文件指定缓存，默认没启用，max指定缓存数量，建议和打开文件数一致，inactive是指经过多长时间文件没被请求后删除缓存。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">open_file_cache</span> <span style="color:#e6db74">max=102400</span> <span style="color:#e6db74">inactive=20s</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 是指多长时间检查一次缓存的有效信息。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">open_file_cache_valid</span> <span style="color:#e6db74">30s</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># open_file_cache 指令中的 inactive 参数时间内文件的最少使用次数，如果有一个文件在 inactive 时间内一次没被使用，它将被移除
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">open_file_cache_min_uses</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 指令为 FastCGI 缓存指定一个路径，目录结构等级，关键字区域存储时间和非活动删除时间。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">fastcgi_cache_path</span> <span style="color:#e6db74">/usr/local/nginx/fastcgi_cache</span> <span style="color:#e6db74">levels=1:2</span> <span style="color:#e6db74">keys_zone=TEST:10m</span> <span style="color:#e6db74">inactive=5m</span>;</span></span></code></pre></div><ul>
<li><code>fastcgi</code><!-- raw HTML omitted -->配置<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e"># include inc.d/fastcgi.ini;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fastcgi_connect_timeout</span> <span style="color:#ae81ff">300</span>;  	<span style="color:#75715e"># 指定连接到后端 FastCGI 的超时时间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">fastcgi_send_timeout</span> <span style="color:#ae81ff">300</span>;  	<span style="color:#75715e"># 向 FastCGI 传送请求的超时时间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">fastcgi_read_timeout</span> <span style="color:#ae81ff">300</span>;  	<span style="color:#75715e"># 接收 FastCGI 应答的超时时间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">fastcgi_buffer_size</span> <span style="color:#ae81ff">64k</span>;  	<span style="color:#75715e"># 指定读取FastCGI应答第一部分需用多大缓冲区
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">fastcgi_buffers</span> <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">64k</span>;  	<span style="color:#75715e"># 指定本地需用多少和多大缓冲区缓冲FastCGI的应答。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">fastcgi_busy_buffers_size</span> <span style="color:#ae81ff">128k</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fastcgi_temp_file_write_size</span> <span style="color:#ae81ff">128k</span>;  	<span style="color:#75715e"># 在写入 fastcgi_temp_path 时将用多大的数据块，默认值是 fastcgi_buffers 的两倍。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># fastcgi_cache TEST  	# 开启FastCGI缓存并且为其制定一个名称，可以有效降低CPU 负载，并且防止 502 错误
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># fastcgi_cache_valid 200 302 1h;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># fastcgi_cache_valid 301 1d;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># fastcgi_cache_valid any 1m;  	# 为指定应答代码指定缓存时间,如将200,302应答缓存一小时,301应答缓存1天.其他为1分钟。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#66d9ef">fastcgi_cache_min_uses</span> <span style="color:#ae81ff">1</span>;  	<span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#66d9ef">缓存在</span> <span style="color:#e6db74">fastcgi_cache_path指令inactive参数值时间内的最少使用次数,如果在5分钟内某文件1次也没有被使用,那么这个文件将被移除。</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->压缩配置<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e"># include inc.d/compaction.ini;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># brotli压缩算法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">brotli</span>			<span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">brotli_comp_level</span>	<span style="color:#ae81ff">6</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">brotli_buffers</span>		<span style="color:#ae81ff">16</span> <span style="color:#ae81ff">8k</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">brotli_min_length</span>	<span style="color:#ae81ff">256</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">brotli_types</span>		<span style="color:#e6db74">text/plain</span> <span style="color:#e6db74">application/javascript</span> <span style="color:#e6db74">application/x-javascript</span> <span style="color:#e6db74">text/javascript</span> <span style="color:#e6db74">text/css</span> <span style="color:#e6db74">application/xml</span> <span style="color:#e6db74">application/json</span> <span style="color:#e6db74">image/jpeg</span> <span style="color:#e6db74">image/gif</span> <span style="color:#e6db74">image/png</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">brotli_window</span>		<span style="color:#ae81ff">512k</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># gzip压缩算法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">gzip</span>	<span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">gzip_comp_level</span>  <span style="color:#ae81ff">6</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 根据操作系统选择：64位操作系统为：16 8k，32位操作系统：32 4k
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">gzip_buffers</span>     <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">8k</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">gzip_min_length</span>  <span style="color:#ae81ff">1k</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">gzip_types</span>       <span style="color:#e6db74">text/plain</span> <span style="color:#e6db74">application/javascript</span> <span style="color:#e6db74">application/x-javascript</span> <span style="color:#e6db74">text/javascript</span> <span style="color:#e6db74">text/css</span> <span style="color:#e6db74">application/xml</span> <span style="color:#e6db74">application/xml+rss</span> <span style="color:#e6db74">application/json</span> <span style="color:#e6db74">text/xml</span> <span style="color:#e6db74">image/jpeg</span> <span style="color:#e6db74">image/gif</span> <span style="color:#e6db74">image/png</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">gzip_disable</span>     <span style="color:#e6db74">&#34;msie6&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">gzip_http_version</span> <span style="color:#ae81ff">1</span><span style="color:#e6db74">.1</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">gzip_vary</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">gzip_proxied</span>     <span style="color:#e6db74">any</span> <span style="color:#e6db74">expired</span> <span style="color:#e6db74">no-cache</span> <span style="color:#e6db74">no-store</span> <span style="color:#e6db74">private</span> <span style="color:#e6db74">auth</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">gzip_disable</span> <span style="color:#e6db74">&#34;MSIE</span> <span style="color:#e6db74">[1-6]\.&#34;</span>;</span></span></code></pre></div><ul>
<li><code>IP</code><!-- raw HTML omitted -->限制配置<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e"># include inc.d/ip-limits.ini;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">map</span> $http_upgrade $connection_upgrade {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">default</span> <span style="color:#e6db74">upgrade</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&#39;&#39;</span>	<span style="color:#e6db74">close</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">map</span> $http_cdn-src-IP $ali_xreal {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&#34;&#34;</span>   $http_Ali-CDN-Real-IP;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">~^(?P&lt;firstAddr&gt;[0-9\.]+),?.*$</span> $firstAddr;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">map</span> $ali_xreal $cf_xreal {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&#34;&#34;</span>  $http_CF-Connecting-IP;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">~^(?P&lt;firstAddr&gt;[0-9\.]+),?.*$</span> $firstAddr;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">map</span> $cf_xreal  $gp_xreal {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&#34;&#34;</span> $http_GP_IP;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">~^(?P&lt;firstAddr&gt;[0-9\.]+),?.*$</span> $firstAddr;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">map</span> $gp_xreal  $xrealip {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&#34;&#34;</span> $http_x_forwarded_for ;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">~^(?P&lt;firstAddr&gt;[0-9\.]+),?.*$</span> $firstAddr;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">map</span> $xrealip  $clientRealIp {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&#34;&#34;</span> $remote_addr;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">~^(?P&lt;firstAddr&gt;[0-9\.]+),?.*$</span> $firstAddr;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#####  	GeoIP访问IP限制  #####
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># geoip_country	GeoIP/GeoIP.dat;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># geoip_city		GeoIP/GeoLiteCity.dat;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># geoip_proxy		0.0.0.0/0;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># geoip_proxy_recursive on;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># geo $remote_addr $ip_whitelist {
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#	default 0;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#	include ip.conf;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># }
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">geoip2</span> <span style="color:#e6db74">/usr/local/nginx/conf/GeoLite2-Country/GeoLite2-Country.mmdb</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">$geoip2_data_country_code</span> <span style="color:#e6db74">country</span> <span style="color:#e6db74">iso_code</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">$geoip2_data_country_name</span> <span style="color:#e6db74">country</span> <span style="color:#e6db74">iso_code</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">geoip2</span> <span style="color:#e6db74">/usr/local/nginx/conf/GeoLite2-City/GeoLite2-City.mmdb</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">$geoip2_data_city_name</span> <span style="color:#e6db74">city</span> <span style="color:#e6db74">iso_code</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 配置1: 允许所有国家访问，除了美国和日本
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">map</span> $geoip2_data_country_code $allowed_country {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">default</span> <span style="color:#e6db74">yes</span>;  	<span style="color:#75715e"># 默认配置 yes：允许所有，no：拒绝所有
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">US</span> <span style="color:#e6db74">no</span>;  	<span style="color:#75715e"># 单独配置拒绝
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">JP</span> <span style="color:#e6db74">no</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">CN</span> <span style="color:#e6db74">yes</span>;  	<span style="color:#75715e"># 单独配置允许，前提是：default no;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># geoip_country /usr/local/nginx/GeoIP/GeoIP.dat;  # Geoip所在目录
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># map $geoip_country_code $allowed_country {
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#	default yes;    # 允许
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#	CN no;      # 中国大陆区命名为no
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#66d9ef">}</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->请求头<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e"># include inc.d/proxy_set_header.ini;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">proxy_set_header</span> <span style="color:#e6db74">X-Real-IP</span> $clientRealIp;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $remote_addr;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $proxy_add_x_forwarded_for;</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->日志配置，以及配置<!-- raw HTML omitted --><code>Json</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e"># include inc.d/logs.ini;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">map</span> $upstream_response_time $upstream_response_timer {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">default</span> $upstream_response_time;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&#34;&#34;</span>        <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">log_format</span> <span style="color:#e6db74">json</span> <span style="color:#e6db74">escape=json</span>  <span style="color:#e6db74">&#39;</span>{<span style="color:#f92672">&#34;@timestamp&#34;:&#34;$time_iso8601&#34;,&#39;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;client_realip&#34;:&#34;</span>$clientRealIp&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;remote_addr&#34;:&#34;</span>$remote_addr&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;status&#34;:&#34;</span>$status&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;upstream_status&#34;:&#34;</span>$upstream_status&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;request_time&#34;:&#34;</span>$request_time&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;upstream_response_time&#34;:&#34;</span>$upstream_response_time&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;upstream_addr&#34;:&#34;</span>$upstream_addr&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;request&#34;:&#34;</span>$request&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;http_scheme&#34;:&#34;</span>$http_X_Forwarded_Proto&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;server_name&#34;:&#34;</span>$host&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;uri&#34;:&#34;</span>$uri&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;request_body&#34;:&#34;</span>$request_body&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;body_bytes_sent&#34;:&#34;</span>$body_bytes_sent&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;bytes_sent&#34;:&#34;</span>$body_bytes_sent&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;request_length&#34;:&#34;</span>$request_length&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;http_referer&#34;:&#34;</span>$http_referer&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;http_wangsu_xreal&#34;:&#34;</span>$http_cdn_src_IP&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;http_ali_xreal&#34;:&#34;</span>$http_Ali_CDN_Real_IP&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;http_cf_xreal&#34;:&#34;</span>$http_CF_Connecting_IP&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;http_gp_xreal&#34;:&#34;</span>$http_GP_IP&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;http_x_forwarded_for&#34;:&#34;</span>$proxy_add_x_forwarded_for&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;http_user_agent&#34;:&#34;</span>$http_user_agent&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;xdevice&#34;:&#34;</span>$http_x_device&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;xversion&#34;:&#34;</span>$http_x_version&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;trace-id&#34;:&#34;</span>$http_x_trace_id&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;uid&#34;:&#34;</span>$http_x_id&#34;&#39;
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;</span><span style="color:#960050;background-color:#1e0010">}</span><span style="color:#e6db74">&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#f92672">这里注意使用下划线，</span>		</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->访问频率限制<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e"># include inc.d/limit-speed.ini; 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 限速配置指令
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">limit_conn_log_level</span> <span style="color:#e6db74">error</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 客户端并发访问数限制，名字为ip_limit，大小为15Mb的内存空间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">limit_conn_zone</span> $binary_remote_addr <span style="color:#e6db74">zone=ip_limit:15m</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 客户端 qps 频率访问限制配置、分配一个10Mb的内存空间，同一个IP一秒钟允许5r(5次请求)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">limit_req_zone</span> $binary_remote_addr <span style="color:#e6db74">zone=one:10m</span> <span style="color:#e6db74">rate=5r/s</span>;</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->跨域配置<!-- raw HTML omitted --></li>
<li>
<ul>
<li><a href="https://blog.csdn.net/weixin_37288522/article/details/123838801" rel="external" target="_self">分片下载</a></li>
</ul>
</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e"># include inc.d/cross-domain.ini;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">add_header</span> <span style="color:#e6db74">Access-Control-Allow-Origin</span> <span style="color:#e6db74">*</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">add_header</span> <span style="color:#e6db74">Accept-Ranges</span> <span style="color:#e6db74">bytes</span>;  <span style="color:#75715e"># 分段下载配置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">add_header</span> <span style="color:#e6db74">Access-Control-Allow-Methods</span> <span style="color:#e6db74">GET,POST,OPTIONS</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">add_header</span> <span style="color:#e6db74">Access-Control-Allow-Headers</span> <span style="color:#e6db74">DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization</span>;</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->反代缓存<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e"># include inc.d/reverse-proxy.ini; 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 缓存目录
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">proxy_temp_path</span>   <span style="color:#e6db74">/opt/cache/www</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 反代缓存配置，keys_zone=baidu:1024m 中的：1024m是在内存中占用的空间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">proxy_cache_path</span> <span style="color:#e6db74">/opt/cache/www/jd</span> <span style="color:#e6db74">levels=1:2</span> <span style="color:#e6db74">keys_zone=jd:1024m</span> <span style="color:#e6db74">inactive=1h</span> <span style="color:#e6db74">max_size=10g</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">proxy_cache_path</span> <span style="color:#e6db74">/opt/cache/www/ali</span> <span style="color:#e6db74">levels=1:2</span> <span style="color:#e6db74">keys_zone=ali:1024m</span> <span style="color:#e6db74">inactive=1h</span> <span style="color:#e6db74">max_size=10g</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">proxy_cache_path</span> <span style="color:#e6db74">/opt/cache/www/baidu</span> <span style="color:#e6db74">levels=1:2</span> <span style="color:#e6db74">keys_zone=baidu:1024m</span> <span style="color:#e6db74">inactive=1h</span> <span style="color:#e6db74">max_size=10g</span>;</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted --><!-- raw HTML omitted --></li>
</ul>
</blockquote>
</blockquote>
<hr>
<h3 id="conf子配置文件"><code>conf</code>子配置文件</h3>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="http://zyan.cc/nginx_php_v5" rel="external" target="_self"><code>Nginx</code>主配置文件参考资料</a></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li><code>server</code><!-- raw HTML omitted -->参数配置<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><blockquote>
<ul>
<li><code>HSTS</code><!-- raw HTML omitted -->安全策略机制<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>Strict-Transport-Security</code>这是<code>HSTS</code>头部的名称。<code>HSTS</code>是一种<code>web</code>安全策略机制，帮助保护网站免受中间人攻击，确保用户与服务器之间的通信始终使用<code>HTTPS</code></li>
<li><code>max-age</code>指定了浏览器应当缓存该策略的有效时间，单位为秒，<code>86400</code>秒等于<code>24</code>小时</li>
<li><code>includeSubdomains</code>这个参数指示浏览器对所有子域名也应用<code>HSTS</code>策略</li>
<li><code>preload</code>参数后，应该确保网站始终支持<code>HTTPS</code>，否则会导致访问错误。</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">add_header</span> <span style="color:#e6db74">Strict-Transport-Security</span> <span style="color:#e6db74">&#34;max-age=86400</span>; <span style="color:#f92672">includeSubdomains</span>; <span style="color:#f92672">preload&#34;</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></blockquote>
<ul>
<li><code>server_name</code><!-- raw HTML omitted -->配置<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">listen</span> <span style="color:#ae81ff">80</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">listen</span> <span style="color:#ae81ff">80</span> <span style="color:#e6db74">default_server</span>;  	<span style="color:#75715e"># 如果没有其他server块匹配请求的Host头，使用这个作为默认处理
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">listen</span> <span style="color:#ae81ff">443</span> <span style="color:#e6db74">ssl</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">listen</span> <span style="color:#ae81ff">8443</span> <span style="color:#e6db74">ssl</span> <span style="color:#e6db74">proxy_protocol</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">ssl</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 第一个域名默认为主域名，.domain.com匹配 二级主域名以及所有依 * 的泛域名，^baidu\d+\.com 包含任意数字
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">server_name</span> <span style="color:#e6db74">domain.com</span> <span style="color:#e6db74">.domain.com</span>$ <span style="color:#e6db74">^baidu\d+\.com</span>$;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 禁止主域名返回响应， 开启为：on
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#f92672">server_name_in_redirect</span> <span style="color:#66d9ef">off</span>; 
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->证书配置<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">ssl_certificate</span>      <span style="color:#e6db74">certs/domain/domain.com.crt</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">ssl_certificate_key</span>  <span style="color:#e6db74">certs/domain/domain.com.key</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">include</span> <span style="color:#e6db74">certs/ssl-options.conf</span>  	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># ssl_dhparam certs/domain/dhparam.pem;  	# 使用非对称加密使用的参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">}</span> </span></span></code></pre></div><div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;certs/ssl-options.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	ssl_session_cache    shared:SSL:10m;  	# 为了降低握手开启10m缓存，1m可以有4000个连接
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	ssl_session_timeout  30m;  	# m为分钟， 这里设置为 30分钟超时
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ssl_prefer_server_ciphers on;  	# 开启使用协议与浏览器通讯 	
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	ssl_ciphers &#39;ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:!RC4:!MD5:!aNULL:!NULL&#39;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # 优先使用服务器配置的加密套件
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	resolver 8.8.8.8 valid=300;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	resolver_timeout 10s;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # 开启 OCSP Stapling
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	ssl_stapling on;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # 验证 OCSP 响应
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	ssl_stapling_verify on;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->强跳证书以及主域名<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># http强跳443， 或使用 $host 字段
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">if</span> <span style="color:#e6db74">(</span> $scheme = <span style="color:#e6db74">http</span> <span style="color:#e6db74">)</span>{ 
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">return</span> <span style="color:#ae81ff">301</span> <span style="color:#e6db74">https://</span>$server_name$request_uri; 
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 强跳主域名
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">if</span> <span style="color:#e6db74">(</span> $host <span style="color:#e6db74">!=</span> <span style="color:#e6db74">&#39;domain.com&#39;</span> <span style="color:#e6db74">)</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^(.*)</span>$ <span style="color:#e6db74">https://domain.com/</span>$1 <span style="color:#e6db74">permanent</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 避免直接返回 404，而是返回应用的主入口
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">try_files</span> $uri $uri/ <span style="color:#e6db74">/index.html</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><ul>
<li><code>location</code><!-- raw HTML omitted -->配置<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>
<p><code>location</code><!-- raw HTML omitted -->匹配规则以及优先级：<!-- raw HTML omitted --><code>=</code> <strong>&gt;</strong> <code>^~</code>  <strong>&gt;</strong>  <code>~</code>  <strong>&gt;</strong>  <code>~*</code></p>
<p><!-- raw HTML omitted -->精确匹配<!-- raw HTML omitted -->和<!-- raw HTML omitted -->前缀匹配<!-- raw HTML omitted -->优先级是最高的，一旦匹配到一个就直接走此<code>location</code>，则不会再往下匹配。
<!-- raw HTML omitted -->正则匹配<!-- raw HTML omitted -->就算匹配到一个<code>location</code>，也还是会接着匹配，看时候还有比当前<code>location</code>更完整，更匹配的<code>location</code>存在，后面没有了，才匹配本身</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>正则符号</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>空</td>
<td><code>location</code>后没有参数直接跟着<strong>标准</strong><code>URI</code>，表示前缀匹配，代表跟请求中的 <code>URI</code>从头开始匹配。</td>
</tr>
<tr>
<td><code>=</code></td>
<td>用于<strong>标准</strong><code>URI</code>前，要求请求字符串与其<!-- raw HTML omitted -->精准匹配<!-- raw HTML omitted -->，成功则立即处理，<code>nginx</code>停止搜索其他匹配</td>
</tr>
<tr>
<td><code>^~</code></td>
<td>使用<!-- raw HTML omitted -->前缀匹配<!-- raw HTML omitted -->，用于<strong>标准</strong><code>URI</code>前，并要求一旦匹配到就会立即处理，不再去匹配其他的那些个正则<code>URI</code>，一般用来<!-- raw HTML omitted -->匹配目录<!-- raw HTML omitted --></td>
</tr>
<tr>
<td><code>~</code></td>
<td>表示开始<!-- raw HTML omitted -->正则匹配<!-- raw HTML omitted -->，表示<code>URI</code>包含正则表达式， <!-- raw HTML omitted -->区分大小写<!-- raw HTML omitted --></td>
</tr>
<tr>
<td><code>~*</code></td>
<td>表示正则匹配<!-- raw HTML omitted -->不区分大小写<!-- raw HTML omitted --></td>
</tr>
<tr>
<td><code>~ \~*</code></td>
<td>表示执行一个正则匹配（）</td>
</tr>
<tr>
<td>`/(xxx</td>
<td>xxx</td>
</tr>
<tr>
<td><code>@</code></td>
<td><code>@</code>定义一个命名的<code>location</code>，<code>@</code>定义的<code>locaiton</code>名字一般用在内部跳转，类似变量饮用，例如<code>error_page</code>, <code>try_files</code>命令中。它的功能类似于编程中的<code>goto(转到)</code></td>
</tr>
<tr>
<td><code>/</code></td>
<td>任何没有匹配成功的，都会匹配这里处理</td>
</tr>
<tr>
<td><code>$</code></td>
<td>表示<!-- raw HTML omitted -->正则结束符<!-- raw HTML omitted -->号</td>
</tr>
</tbody>
</table>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># 这个非常重要，如果git库里有大文件，设置太小，文件push会失败，根据情况调整
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">client_max_body_size</span> <span style="color:#ae81ff">50m</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 禁用重定向处理，默认重定向：default
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">proxy_redirect</span> <span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># 以下确保 gitlab中项目的 url 是域名而不是 http://git，不可缺少
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Real-IP</span> $remote_addr;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Real-Port</span> $remote_port;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_connect_timeout</span> <span style="color:#e6db74">15s</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_read_timeout</span> <span style="color:#e6db74">600s</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_send_timeout</span> <span style="color:#e6db74">60s</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 设定可信的代理服务器的 IP 地址或 CIDR
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e"># set_real_ip_from 192.168.1.0/24;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e"># 从指定的请求头提取真实 IP 地址
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e"># real_ip_header X-Real-IP;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e"># real_ip_recursive off;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e"># real_ip_recursive on;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e"># real_ip_header X-Forwarded_For;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># 设置http版本为1.1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">proxy_http_version</span> <span style="color:#ae81ff">1</span><span style="color:#e6db74">.1</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># 升级协议头 websocket
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Upgrade</span> $http_upgrade;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Connection</span> <span style="color:#e6db74">&#34;upgrade&#34;</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># 升级协议头为https
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Upgrade-Insecure-Requests</span> <span style="color:#ae81ff">1</span>;   
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-Proto</span> <span style="color:#e6db74">https</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">add_header</span> <span style="color:#e6db74">Content-Security-Policy</span> <span style="color:#e6db74">upgrade-insecure-requests</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">add_header</span> <span style="color:#e6db74">Nginx-Cache</span> <span style="color:#e6db74">“</span>$upstream_cache_status”;
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># nginx 反向代理到 gitlab 容器暴露的端口
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://127.0.0.1:8080</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">index</span> <span style="color:#e6db74">index.html</span> <span style="color:#e6db74">index.htm</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 启用客户端并发访问数限制
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e"># limit_conn_status 503;  	# 返回状态吗
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e"># limit_conn_log_level warn;  	# 返回日志级别
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e"># limit_rate 50;  	# 每秒返回字节，50代表50字节
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e"># limit_conn addr 1;  	# 允许一个请求
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 启用频率限制，burst：访问次数，频率限制优先级高
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e"># limit_req zone=one burst=1 nodelay;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">location</span> <span style="color:#e6db74">/ip</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">return</span> <span style="color:#ae81ff">200</span> <span style="color:#e6db74">&#34;Client</span> <span style="color:#e6db74">real</span> <span style="color:#e6db74">ip:</span> $remote_addr\n&#34;;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 如果出现404， 可能需要针对某个接口配置 location
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">location</span> = <span style="color:#e6db74">/alive</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://upstream_api</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_http_version</span> <span style="color:#ae81ff">1</span><span style="color:#e6db74">.1</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Upgrade</span> $http_upgrade;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_connect_timeout</span> <span style="color:#e6db74">180s</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_read_timeout</span> <span style="color:#e6db74">180s</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_send_timeout</span> <span style="color:#e6db74">180s</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">location</span> <span style="color:#e6db74">^~</span> <span style="color:#e6db74">/v1</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_buffering</span> <span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://upstream_api</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_http_version</span> <span style="color:#ae81ff">1</span><span style="color:#e6db74">.1</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Upgrade</span> $http_upgrade;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_connect_timeout</span> <span style="color:#e6db74">180s</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_read_timeout</span> <span style="color:#e6db74">180s</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_send_timeout</span> <span style="color:#e6db74">180s</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">location</span> ~ <span style="color:#e6db74">.*\.(gif|jpg|jpeg|png|bmp|swf)$</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://127.0.0.1:8082</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_redirect</span> <span style="color:#e6db74">default</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $remote_addr;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">add_header</span> <span style="color:#e6db74">Nginx-Cache</span> <span style="color:#e6db74">&#34;</span>$upstream_cache_status&#34;;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">expires</span> <span style="color:#e6db74">30d</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">location</span> ~ <span style="color:#e6db74">.*\.(js|css)?$</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">expires</span> <span style="color:#e6db74">12h</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">location</span> ~ <span style="color:#e6db74">/\.</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">deny</span> <span style="color:#e6db74">all</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 过滤只允许GET，HEAD和POST方法请求
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">if</span> <span style="color:#e6db74">(</span>$request_method <span style="color:#e6db74">!~</span> <span style="color:#e6db74">^(GET|HEAD|POST)</span>$ <span style="color:#e6db74">)</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">return</span> <span style="color:#ae81ff">444</span>;
</span></span><span style="display:flex;"><span>	}   
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">### 阻止User-Agents,如扫描器，机器人以及滥用你服务器的垃圾邮件发送者。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">if</span> <span style="color:#e6db74">(</span>$http_user_agent ~<span style="color:#e6db74">*</span> <span style="color:#e6db74">LWP::Simple|BBBike|wget|&#34;Windows</span> <span style="color:#ae81ff">5</span><span style="color:#e6db74">.1&#34;)</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">return</span> <span style="color:#ae81ff">405</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->禁止<!-- raw HTML omitted --><code>IP</code><!-- raw HTML omitted -->访问<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><a href="https://developer.aliyun.com/article/548497" rel="external" target="_self"><code>Nginx</code>禁止<code>IP</code>访问 只允许域名访问</a></li>
<li><!-- raw HTML omitted -->方式一<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">listen</span> <span style="color:#ae81ff">80</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">server_name</span> <span style="color:#e6db74">www.domain.com</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">if</span> <span style="color:#e6db74">(</span>$host <span style="color:#e6db74">!=</span> <span style="color:#e6db74">&#39;www.domain.com&#39;)</span>{ <span style="color:#f92672">return</span> <span style="color:#ae81ff">403</span>; }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->方式二<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->添加一个<!-- raw HTML omitted --><code>server</code>，<!-- raw HTML omitted -->新加的<!-- raw HTML omitted --><code>server</code><!-- raw HTML omitted -->（注意是新增，并不是在原有的<!-- raw HTML omitted --><code>server</code><!-- raw HTML omitted -->基础上修改） <!-- raw HTML omitted --></li>
<li><code>rewrite</code><!-- raw HTML omitted -->重定向<!-- raw HTML omitted --></li>
</ul>
<table>
<thead>
<tr>
<th>开始字符</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>.</code></td>
<td>匹配除换行符以外的任意字符</td>
</tr>
<tr>
<td><code>?</code></td>
<td>重复0次或1次</td>
</tr>
<tr>
<td><code>+</code></td>
<td>重复1次或多次</td>
</tr>
<tr>
<td><code>*</code></td>
<td>最少连接数、那个机器连接数少就分发</td>
</tr>
<tr>
<td><code>\d</code></td>
<td>匹配数字</td>
</tr>
<tr>
<td><code>^</code></td>
<td>匹配字符串的开始</td>
</tr>
<tr>
<td><code>$</code></td>
<td>匹配字符串的结束</td>
</tr>
<tr>
<td><code>{n}</code></td>
<td>重复<code>n</code>此</td>
</tr>
<tr>
<td><code>{n,}</code></td>
<td>重复<code>n</code>或更多次</td>
</tr>
<tr>
<td><code>[c]</code></td>
<td>匹配单个字符<code>c</code></td>
</tr>
<tr>
<td><code>[a-z]</code>，<code>[A-Z]</code></td>
<td>匹配<code>a-z</code>小写字母的任意一个，<code>[^a-z]</code>表示取反，匹配<code>A-z</code>大写字母中任意一个，<code>[^A-Z]</code>表示取反</td>
</tr>
<tr>
<td><code>[0-9]</code></td>
<td>匹配<code>0-9</code>数字的任意一个，<code>[^0-9]</code>表示取反</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>结尾定义字符</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>last</code></td>
<td>匹配完成后，继续向下匹配新的<code>location URL</code>规则</td>
</tr>
<tr>
<td><code>break</code></td>
<td>匹配完成即停止向下匹配</td>
</tr>
<tr>
<td><code>redirect</code></td>
<td>返回302临时重定向、地址栏会显示跳转后地址</td>
</tr>
<tr>
<td><code>permanent</code></td>
<td>返回301永久重定向、地址栏会显示跳转后地址</td>
</tr>
</tbody>
</table>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">listen</span> <span style="color:#ae81ff">80</span> <span style="color:#e6db74">dufault</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">server_name</span> <span style="color:#e6db74">_</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">return</span> <span style="color:#ae81ff">403</span>;  	<span style="color:#75715e"># 直接返回一个403
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^(.*)</span> <span style="color:#e6db74">http://domain.com</span> <span style="color:#e6db74">permanent</span>;  	<span style="color:#75715e"># 或者跳转到其他域名
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 禁止IP访问 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">server</span> { 
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">listen</span> <span style="color:#ae81ff">80</span> <span style="color:#e6db74">default</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">server_name</span> <span style="color:#e6db74">_</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">server_name</span>  <span style="color:#e6db74">domain.com</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">return</span> <span style="color:#ae81ff">500</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></blockquote>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->文件下载<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 启用目录浏览
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">autoindex</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 设置为off 时，显示文件大小，易于理解的单位（如 KB、MB 等）。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#f92672">autoindex_exact_size</span> <span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 设置为on 时，显示的时间将根据服务器的本地时间来显示
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#f92672">autoindex_localtime</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">location</span> ~ {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->日志切割<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">if</span> <span style="color:#e6db74">(</span>$time_iso8601 ~ <span style="color:#e6db74">&#34;^(\d</span>{<span style="color:#f92672">4})-(\d{2})-(\d{2})&#34;)</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">set</span> $year $1;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">set</span> $month $2;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">set</span> $day $3;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">error_page</span> <span style="color:#ae81ff">404</span> <span style="color:#e6db74">http://domain.com</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">access_log</span>  <span style="color:#e6db74">/home/logs/nginx/domain.access_</span>$year-$month-$day.log  <span style="color:#e6db74">main</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">error_log</span>   <span style="color:#e6db74">/home/logs/nginx/domain.error.log</span>  <span style="color:#e6db74">info</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->配置跳转<!-- raw HTML omitted --><code>Web</code><!-- raw HTML omitted -->或<!-- raw HTML omitted --><code>H5</code></li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://blog.csdn.net/weixin_34128501/article/details/91370181?utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-4.vipsorttest&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-4.vipsorttest" rel="external" target="_self"><code>nginx</code>配置手机端<code>PC</code>端访问不同的项目</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://blog.csdn.net/weixin_37008947/article/details/105725236" rel="external" target="_self"><code>nginx</code>根据<code>PC</code>端还是手机端设置不同的网站根目录</a></td>
<td></td>
</tr>
</tbody>
</table>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">root</span> <span style="color:#e6db74">/var/www/web/pc</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">index</span>  <span style="color:#e6db74">index.php</span> <span style="color:#e6db74">index.html</span> <span style="color:#e6db74">index.htm</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">location</span> <span style="color:#e6db74">^~</span> <span style="color:#e6db74">/api</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^/api/(.*)</span>$ <span style="color:#e6db74">/</span>$1 <span style="color:#e6db74">break</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://swofit/</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Real-IP</span> $remote_addr;
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Real-Port</span> $remote_port;
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># 如果是手机移动端访问内容
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">if</span> <span style="color:#e6db74">(</span> $http_user_agent ~<span style="color:#e6db74">*</span> <span style="color:#e6db74">&#34;(MIDP)|(WAP)|(UP.Browser)|(Smartphone)|(Obigo)|(Mobile)|(AU.Browser)|(wxd.Mms)|(WxdB.Browser)|(CLDC)|(UP.Link)|(KM.Browser)|(UCWEB)|(SEMC-Browser)|(Mini)|(Symbian)|(Palm)|(Nokia)|(Panasonic)|(MOT-)|(SonyEricsson)|(NEC-)|(Alcatel)|(Ericsson)|(BENQ)|(BenQ)|(Amoisonic)|(Amoi-)|(Capitel)|(PHILIPS)|(SAMSUNG)|(Lenovo)|(Mitsu)|(Motorola)|(SHARP)|(WAPPER)|(LG-)|(LG/)|(EG900)|(CECT)|(Compal)|(kejian)|(Bird)|(BIRD)|(G900/V1.0)|(Arima)|(CTL)|(TDG)|(Daxian)|(DAXIAN)|(DBTEL)|(Eastcom)|(EASTCOM)|(PANTECH)|(Dopod)|(Haier)|(HAIER)|(KONKA)|(KEJIAN)|(LENOVO)|(Soutec)|(SOUTEC)|(SAGEM)|(SEC-)|(SED-)|(EMOL-)|(INNO55)|(ZTE)|(iPhone)|(ipad)|(Android)|(Windows</span> <span style="color:#e6db74">CE)|(Wget)|(Java)|(curl)|(Opera)|(htc)|(blackberry)&#34;</span> <span style="color:#e6db74">)</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">root</span> <span style="color:#e6db74">/var/www/web/mobile</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">index</span> <span style="color:#e6db74">index.html</span> <span style="color:#e6db74">index.htm</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">try_files</span> $uri $uri/ <span style="color:#e6db74">@router</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">location</span> ~ <span style="color:#e6db74">.*\.(gif|jpg|jpeg|png|bmp|swf)$</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">expires</span>      <span style="color:#e6db74">30d</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">location</span> ~ <span style="color:#e6db74">.*\.(js|css)?$</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">expires</span>      <span style="color:#e6db74">12h</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">location</span> ~ <span style="color:#e6db74">/\.</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">deny</span> <span style="color:#e6db74">all</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">if</span> <span style="color:#e6db74">(</span>$time_iso8601 ~ <span style="color:#e6db74">&#34;^(\d</span>{<span style="color:#f92672">4})-(\d{2})-(\d{2})&#34;)</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">set</span> $year $1;
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">set</span> $month $2;
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">set</span> $day $3;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">error_page</span> <span style="color:#ae81ff">404</span> <span style="color:#e6db74">http://domian.com</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">access_log</span>  <span style="color:#e6db74">/home/logs/nginx/domain.access_</span>$year-$month-$day.log  <span style="color:#e6db74">main</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">error_log</span>   <span style="color:#e6db74">/home/logs/nginx/domain.error.log</span>  <span style="color:#e6db74">info</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 或者使用下面方法、try_files用于按顺序检测文件是否存在，如果存在就返回文件内容，如果不存在，则进行配的对应规则
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">root</span> <span style="color:#e6db74">/opt/www/cms-web</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">index</span>  <span style="color:#e6db74">index.html</span> <span style="color:#e6db74">index.htm</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">try_files</span> $uri $uri/ <span style="color:#e6db74">/index.html</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">location</span> <span style="color:#e6db74">/m/</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">alias</span> <span style="color:#e6db74">/opt/www/cms-web/m/</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">index</span>  <span style="color:#e6db74">index.html</span> <span style="color:#e6db74">index.htm</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">try_files</span> $uri $uri/ <span style="color:#e6db74">/m/index.html</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></blockquote>
<ul>
<li><code>Nginx</code><!-- raw HTML omitted -->代理<!-- raw HTML omitted --><code>Gitlab</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">listen</span> <span style="color:#ae81ff">80</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">listen</span> <span style="color:#ae81ff">443</span> <span style="color:#e6db74">ssl</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">listen</span> <span style="color:#ae81ff">8081</span> <span style="color:#e6db74">ssl</span> <span style="color:#e6db74">default_server</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 此域名是提供给最终用户的访问地址
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">server_name</span> <span style="color:#e6db74">gitlab.com</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 避免直接返回 404，而是返回应用的主入口
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">try_files</span> $uri $uri/ <span style="color:#e6db74">/index.html</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 主页面不允许缓存（避免项目升级 空白页的问题）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">location</span> <span style="color:#e6db74">/index.html</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">add_header</span> <span style="color:#e6db74">Expires</span> <span style="color:#e6db74">-1</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">add_header</span> <span style="color:#e6db74">Cache-Control</span> <span style="color:#e6db74">no-cache</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># 这个非常重要，如果git库里有大文件，设置太小，文件push会失败，根据情况调整
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">client_max_body_size</span> <span style="color:#ae81ff">50m</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_redirect</span> <span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># 以下确保 gitlab中项目的 url 是域名而不是 http://git，不可缺少
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Real-IP</span> $remote_addr;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># 升级协议头 websocket
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">proxy_http_version</span> <span style="color:#ae81ff">1</span><span style="color:#e6db74">.1</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Upgrade</span> $http_upgrade;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Connection</span> <span style="color:#e6db74">&#34;upgrade&#34;</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># 升级协议头为https
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Upgrade-Insecure-Requests</span> <span style="color:#ae81ff">1</span>;   
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-Proto</span> <span style="color:#e6db74">https</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">add_header</span> <span style="color:#e6db74">Content-Security-Policy</span> <span style="color:#e6db74">upgrade-insecure-requests</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># nginx 反向代理到 gitlab 容器暴露的端口
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://127.0.0.1:8080</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">index</span> <span style="color:#e6db74">index.html</span> <span style="color:#e6db74">index.htm</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">error_page</span> <span style="color:#ae81ff">404</span> <span style="color:#e6db74">http://gitlab.com</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">access_log</span>  <span style="color:#e6db74">/usr/local/nginx/logs/gitlab.access.log</span>  <span style="color:#e6db74">main</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">error_log</span>   <span style="color:#e6db74">/usr/local/nginx/logs/gitlab.error.log</span>  <span style="color:#e6db74">info</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">}</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted --><!-- raw HTML omitted --></li>
</ul>
</blockquote>
</blockquote>
<hr>
<h3 id="nginx集群反向代理"><code>nginx</code>集群，反向代理</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->集群介绍<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>集群就是一组相互独立的计算机，利用高速相同的通信网络组成一个较大的计算机服务系统，每个集群节点都可以各自运行服务，并且能彼此通信，协同向客户提供服务。统一管理的模式。用户请求集群系统时，集群系统给用户的感受是一个单独的服务器，实际上用户请求的是一组集群服务器</li>
<li>打开谷歌、百度的页面，看到起来是好简单、也许你觉得几分钟可以制作出类似的网页，而实际上，这个页面背后是由成千上万台服务器协同工作的结果。那么多台服务器维护和管理，以及相互协调工作就是读者未来的工作职责</li>
<li>一般是指在集群中任意一个节点失效的情况下，该节点上的所有任务会自动转移到其他正常的节点上。此过程并不影响整个集群的运行</li>
<li>当集群中的一个节点系统发生故障时，运行着的集群服务会迅速做出反应，将该系统的服务分配到集群中其他正在工作的系统上运行。考虑到计算机硬件和软件的容错性，高可用性集群的主要目的是使集群的整体服务尽可能可用。如果高可用性集群中的主节点发生了故障，那么这段时间内将由备节点代替它。备节点通常是主节点的镜像。当它代替主节点时，它可以完全接管主节点（包括<code>IP</code>地址及其他资源）提供服务，因此，使集群系统环境对于用户来说是一致的，即不会影响用户的访问。高可用性集群使服务器系统的运行速度和响应速度会尽可能的快。它们经常利用在多台机器上运行的冗余节点和服务来相互跟踪。如果某个节点失败，它的替补者将在几秒钟或更短时间内接管它的职责。因此，对于用户而言，集群里的任意一台机器宕机，业务都不会受影响</li>
<li>高性能计算集群也称并行计算。通常，高性能计算集群涉及为集群开发的并行应用程序，以解决复杂的科学问题（天气预报、石油勘探、核反应模拟等）。高性能计算集群对外就好像一个超级计算机，这种超级计算机内部由数十至上万个独立服务器组成，并且在公共消息传递层上进行通信以运行并行应用程序。在老男孩的工作中实际是把任务切成蛋糕，然后下发到集群节点计算，计算后返回结果，然后继续领新任务计算，如此往复</li>
</ul>
</blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->集群的优势特点<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->高性能<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->廉价性<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->可伸缩性<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->高可用性<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->透明性<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->可管理性<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->可编程性<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->集群分类<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->负载均衡集群<!-- raw HTML omitted -->(<code>Load balancing clusters</code>)简称<code>LBC</code>或者<code>LB</code></li>
<li><!-- raw HTML omitted -->高可用性集群<!-- raw HTML omitted -->(<code>High-availavlability (HA) clusters</code>)简称<code>HAC</code></li>
<li><!-- raw HTML omitted -->高性能计算集群<!-- raw HTML omitted -->(<code>Hight-perfomance (HPC) clusters</code>)简称<code>HPC</code></li>
<li><!-- raw HTML omitted -->网格计算<!-- raw HTML omitted -->(<code>Grid computing</code>)</li>
</ul>
</blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->负载均衡集群<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>负载均衡集群为了强企业提供更为实用、性价比更高的系统架构解决方案。负载均衡集群可以将很多客户集中访问负载压力尽可能地平均分摊在计算机集群中处理。客户访问请求负载包括应用程序处理负载和网络流量负载。这样使同一组应用程序为大量用户提供服务的模式，每个节点都可以承担一定的访问求负载压力并且可以实现访问请求在各节点之间动态分配，以实现负载均衡</li>
<li>负载均衡（<code>LoadBalance</code>）集群提供了一种廉价、有效、透明的方法，来扩展网络设备和服务器的负载、带宽和吞吐量，同时加强了网络数据处理能力，提高了网络的灵活性和可用性</li>
<li>把单台计算机无法承受的大规模并发访问或数据流量分担到多台节点设备上，分别进行处理，减少用户等待响应的时间，提升用户体验</li>
<li>单个重负载的运算分担到多台节点设备上做并行处理，每个节点设备处理结束后，将结果汇总，返回给用户，系统处理能力得到大幅度提高</li>
<li><code>7×24</code>小时的服务保证，任意一个或多个有限后面节点设备宕机，不能影响业务</li>
<li>在负载均衡集群中，同组集群的所有计算机节点都应该提供相同的服务。集群负载均衡器会截获所有对该服务的入站请求。然后将这些请求尽可能地平均地分配在所有集群节点上</li>
</ul>
</blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->负载均衡集群的作用 <!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->分担用户访问请求及数据流量（负载均衡） - 保持业务连续性，即<!-- raw HTML omitted --><code>7×24</code><!-- raw HTML omitted -->小时服务（高可用性）<!-- raw HTML omitted --></li>
<li>于<code>Web</code><!-- raw HTML omitted -->业务及数据库从库等服务器的业务<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->负载均衡集群典型的开源软件包括<!-- raw HTML omitted --><code>LVS</code>、<code>Nginx</code>、<code>Haproxy</code>等</li>
<li><!-- raw HTML omitted -->高可用性集群的作用 <!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->当一台机器宕机时，另外一台机器接管宕机的机器的<!-- raw HTML omitted --><code>IP</code><!-- raw HTML omitted -->资源和服务资源，提供服务<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->常用于不易实现负载均衡的应用，比如负载均衡器，主数据库、主存储对之间<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->高可用性集群常用的开源软件包括<!-- raw HTML omitted --><code>Keepalived</code>、<code>Heartbeat</code>等</li>
</ul>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->运维中常见的集群软硬件产品<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>互联网企业常用的开源集群软件有：<code>Nginx</code>、<code>LVS</code>、<code>Haproxy</code>、<code>Keepalived</code>、<code>Heartbeat</code>。互联网企业常用的商业集群硬件有：<code>F5</code>、<code>Netscaler</code>、<code>Rad-ware</code>、<code>A10</code>等，工作模式相当于<code>Haproxy</code>的工作模式。淘宝、赶集网、新浪等公司曾使用过<code>Netscaler</code>负载均衡产品。集群硬件<code>Netscaler</code>的产品</li>
</ul>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->集群软硬件产品如何选型<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>当企业业务重要，技术力量又薄弱，并且希望出钱购买产品及获取更好的服务时，可以选择硬件负载均衡产品，如<code>F5</code>、<code>Netscaler</code>、<code>Radware</code>等，此类公司多为传统的大型非互联网企业，如银行、证券、金融业及宝马、奔驰公司等</li>
<li>对于门户网站来说，大多会并用软件及硬件产品来分担单一产品的风险，如淘宝、腾讯、新浪等。融资了的企业会购买硬件产品，如赶集等网站</li>
<li>中小型互联网企业，由于起步阶段无利润可赚或者利润很低，会希望通过使用开源免费的方案来解决问题，因此会雇佣专门的运维人员进行维护。例如：<code>51CTO</code>等</li>
</ul>
</blockquote>
<p>相比较而言，商业的负载均衡产品成本高，性能好，更稳定，缺点是不能二次开发，开源的负载均衡软件对运维人员的能力要求较高，如果运维及开发能力强，那么开源的负载均衡软件是不错的选择，目前的互联网行业更倾向于使用开源的负载均衡软件</p>
<ul>
<li><!-- raw HTML omitted -->如何选择开源集群软件产品<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>中小企业互联网公司网站在并发访问和总访问量不是很大的情况下，建议首选<code>Nginx</code>负载均衡，理由是<code>Nginx</code>负载均衡配置简单、使用方便、安全稳定、社区活跃，使用的人逐渐增多，成为流行趋势，另外一个实现负载均衡的类似产品为<code>Haproxy</code>（支持<code>L4</code>和<code>L7</code>负载，同样优秀，但社区不如<code>Nginx</code>活跃）</li>
<li>如果要考虑<code>Nginx</code>负载均衡的高可用功能，建议首选<code>Keepalived</code>软件，理由是安装和配置简单，使用方便，安全稳定，与<code>Keepalived</code>服务类似的高可用软件还有<code>Heartbeat</code>（使用比较复杂，不建议初学者使用）</li>
<li>如果是大型企业互联网公司，负载均衡产品可以使用<code>LVS</code>+<code>Keepalived</code>在前端做四层转发（一般是主备或主主，如果需要扩展可以使用<code>DNS</code>或前端使用<code>OSPF</code>），后端使用<code>Nginx</code>或者<code>Haproxy</code>做<code>7</code>层转发（可以扩展到百台），再后面是应用服务器，如果是数据库与存储的负载均衡和高可用，建议选择<code>LVS</code>+<code>Heart-beat</code>，<code>LVS</code>支持<code>TCP</code>转发且<code>DR</code>模式效率很高，<code>Heartbeat</code>可以配合<code>drbd</code>，不但可以进行<code>VIP</code>的切换，还可以支持块设备级别的数据同步（<code>drbd</code>），以及资源服务的管理</li>
</ul>
</blockquote>
</blockquote>
<ul>
<li>
<ol start="6">
<li><!-- raw HTML omitted -->反向代理与负载均衡概念<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>严格地说，<code>Nginx</code>仅仅是作为<code>Nginx Proxy</code>反向代理使用的，因为这个反向代理功能表现的效果是负载均衡集群的效果，所以本文称之为<code>Nginx</code>负载均衡。那么，反向代理和负载均衡有什么区别呢？</li>
<li>普通负载均衡软件，例如大名鼎鼎的<code>LVS</code>，其实现的功能只是对请求数据包的转发（也可能会改写数据包）、传递，其中<code>DR</code>模式明显的特征是从负载均衡下面的节点服务器来看，接收到的请求还是来自访问负载均衡器的客户端的真实用户，而反向代理就不一样了，反向代理接收访问用户的请求后，会代理用户重新发起请求代理下的节点服务器，最后把数据返回给客户端用户，在节点服务器看来，访问的节点服务器的客户端用户就是反向代理服务器了，而非真实的网站访问用户</li>
<li>一句话，<code>LVS</code>等的负载均衡是转发用户请求的数据包，而<code>Nginx</code>反向代理是接收用户的请求然后重新发起请求去请求其后面的节点。2. 实现<code>Nginx</code>负载均衡的组件说明实现<code>Nginx</code>负载均衡的组件主要有两个</li>
</ul>
<p><a href="#R-image-805c207453f78664eb37c1d22aed9af8" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="http://static.zybuluo.com/WindWhisperer/37fcolxnhiou5s9t0pb0vm8l/image_1akuo4vrcpke1vb010f3rdd14gi9.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-805c207453f78664eb37c1d22aed9af8"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="http://static.zybuluo.com/WindWhisperer/37fcolxnhiou5s9t0pb0vm8l/image_1akuo4vrcpke1vb010f3rdd14gi9.png"></a></p>
<p><a href="#R-image-17efa8e6ac3038f61405ebf24ea14048" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="http://static.zybuluo.com/WindWhisperer/xd2ms7ck0a33wxf36vwwktgs/image_1akv2ig1519723ljs261b4d1kbo9.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-17efa8e6ac3038f61405ebf24ea14048"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="http://static.zybuluo.com/WindWhisperer/xd2ms7ck0a33wxf36vwwktgs/image_1akv2ig1519723ljs261b4d1kbo9.png"></a></p>
<p><a href="#R-image-6be87a9c882bf2754337e520403b41b2" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="http://static.zybuluo.com/WindWhisperer/7dalazu3amny9rg192ing2l9/image_1akv2hcu286b1piavpv9jdsunm.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-6be87a9c882bf2754337e520403b41b2"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="http://static.zybuluo.com/WindWhisperer/7dalazu3amny9rg192ing2l9/image_1akv2hcu286b1piavpv9jdsunm.png"></a></p>
<p><a href="#R-image-afbe0a1d3ae6d9ae2988d4df4e6213c9" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="http://static.zybuluo.com/WindWhisperer/c4i7xy39l9tymsjbb0fem2l1/image_1akv8kcjorbhsq917bq9h382t13.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-afbe0a1d3ae6d9ae2988d4df4e6213c9"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="http://static.zybuluo.com/WindWhisperer/c4i7xy39l9tymsjbb0fem2l1/image_1akv8kcjorbhsq917bq9h382t13.png"></a></p>
<p><a href="#R-image-cc78097093ce0a6a560c94f7a5b464b4" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="http://static.zybuluo.com/WindWhisperer/f3esrb2do4bgexfvltp6l9im/%E5%8F%82%E6%95%B01.jpg" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-cc78097093ce0a6a560c94f7a5b464b4"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="http://static.zybuluo.com/WindWhisperer/f3esrb2do4bgexfvltp6l9im/%E5%8F%82%E6%95%B01.jpg"></a></p>
<p><a href="#R-image-e1bd5f527791fd59d257bf059e50dd64" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="http://static.zybuluo.com/WindWhisperer/x676usyjxgo3idhklzrkqaz5/%E5%8F%82%E6%95%B02.jpg" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-e1bd5f527791fd59d257bf059e50dd64"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="http://static.zybuluo.com/WindWhisperer/x676usyjxgo3idhklzrkqaz5/%E5%8F%82%E6%95%B02.jpg"></a></p>
<p><a href="#R-image-c1baca44773bd604c52dc64ddacf50cd" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="http://static.zybuluo.com/WindWhisperer/i9cazzd6tqyik5hpa0opxjuc/image_1akvc4rs112et1noc12s3d711h49.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-c1baca44773bd604c52dc64ddacf50cd"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="http://static.zybuluo.com/WindWhisperer/i9cazzd6tqyik5hpa0opxjuc/image_1akvc4rs112et1noc12s3d711h49.png"></a></p>
<ul>
<li><!-- raw HTML omitted -->实现负载均衡组件说明<!-- raw HTML omitted --></li>
</ul>
<table>
<thead>
<tr>
<th><code>Nginx http</code>功能模块</th>
<th>模块说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ngx_http_proxy_module</code></td>
<td><code>proxy</code>代理模块，用户把请求抛给节点服务器或<code>upstream</code>服务池</td>
</tr>
<tr>
<td><code>ngx_http_upstream_module</code></td>
<td>负载均衡模块，可以实现网站负载均衡功能及节点健康检查</td>
</tr>
</tbody>
</table>
<ul>
<li><code>nginx upstream</code><!-- raw HTML omitted -->模块<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>Nginx</code>的负载均衡基于<code>ngx_http_upstream_module</code>所支持的代理方式包括<code>proxy_pass</code>、<code>fastcgi_pass</code>、<code>memcached_pass</code>等</li>
<li><code>rr</code><!-- raw HTML omitted -->：轮询（性能相近，业务一样）<!-- raw HTML omitted --></li>
<li><code>wrr</code><!-- raw HTML omitted -->：权重轮询<!-- raw HTML omitted --></li>
<li><code>ip_hash;</code><!-- raw HTML omitted -->：每个请求按访问<!-- raw HTML omitted --><code>IP</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>hash</code><!-- raw HTML omitted -->结果分配、同一个<!-- raw HTML omitted --><code>IP</code><!-- raw HTML omitted -->固定访问同一个后端服务器<!-- raw HTML omitted --></li>
<li><code>hash $request_uri;</code><!-- raw HTML omitted -->：每个请求按访问<!-- raw HTML omitted --><code>IP</code>的<code>hash</code><!-- raw HTML omitted -->结果分配、同一个<!-- raw HTML omitted --><code>IP</code><!-- raw HTML omitted -->固定访问同一个后端服务器<!-- raw HTML omitted -->，<code>$cookie_jsessionid;</code><!-- raw HTML omitted -->按照后端分配<!-- raw HTML omitted --><code>JSESSIONID</code><!-- raw HTML omitted -->进行负载<!-- raw HTML omitted --></li>
<li><code>least_conn;</code><!-- raw HTML omitted -->：最少连接数、分配给连接数最少的后端服务器<!-- raw HTML omitted --></li>
<li><code>server IP:port xxx;</code><!-- raw HTML omitted -->：字段<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>down;</code><!-- raw HTML omitted -->： 当前<!-- raw HTML omitted --><code>server</code><!-- raw HTML omitted -->暂时不参与负载均衡<!-- raw HTML omitted --></li>
<li><code>backup;</code><!-- raw HTML omitted -->：预留备份服务器，只有主参与节点<!-- raw HTML omitted --><code>down</code>掉才启用</li>
<li><code>weigh=3;</code><!-- raw HTML omitted -->：加权轮询、值越大分配到访问几率越高<!-- raw HTML omitted --></li>
<li><code>check=3</code><!-- raw HTML omitted -->：开启对该服务器健康检查<!-- raw HTML omitted --></li>
<li><code>inter</code><!-- raw HTML omitted -->：设置连续两次健康检查的间隔时间，单位毫秒，默认值<!-- raw HTML omitted --><code>2000</code></li>
<li><code>rise</code><!-- raw HTML omitted -->：指定多少次连续成功健康检查后，即可认定服务器可用状态<!-- raw HTML omitted --></li>
<li><code>max_fails=3</code><!-- raw HTML omitted -->：指定多少次不成功后，即认为宕机状态，默认值<!-- raw HTML omitted --><code>1</code></li>
<li><code>fail_timeout=10 </code><!-- raw HTML omitted -->：经过<!-- raw HTML omitted --><code>max_fails</code><!-- raw HTML omitted -->失败后，在<!-- raw HTML omitted --><code>fail_timeout</code><!-- raw HTML omitted -->时间内不再去请求它，<!-- raw HTML omitted --><code>fail_timeout</code><!-- raw HTML omitted -->默认是<!-- raw HTML omitted --><code>10s</code></li>
<li><code>maxconn：</code>：</li>
</ul>
</blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 负载均衡UDP转发</span>
</span></span><span style="display:flex;"><span>stream <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    upstream dns <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 每个请求按访问IP的hash结果分配、同一个IP固定访问同一个后端服务器</span>
</span></span><span style="display:flex;"><span>        ip_hash;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 最少连接数、分配给连接数最少的后端服务器</span>
</span></span><span style="display:flex;"><span>        least_conn;
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># 当前server暂时不参与负载均衡</span>
</span></span><span style="display:flex;"><span>        server 192.168.111.99:10086 down;
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># 预留备份服务器，只有主参与节点down掉才启用</span>
</span></span><span style="display:flex;"><span>        server 192.168.111.100:10086 weigh<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> backup;
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># weigh：加权轮询、值越大分配到访问几率越高，max_fails：允许请求失败次数，fail_timeout：经过max_fails失败后，服务暂定时间、mac_conns：限制最大连接数</span>
</span></span><span style="display:flex;"><span>        server 192.168.111.100:10086 weigh<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> max_fails<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> fail_timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span> max_conns<span style="color:#f92672">=</span>128;
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># 向上游服务器保留的连接数</span>
</span></span><span style="display:flex;"><span>        keepalive 300;
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># 连接保留时间、默认60秒，</span>
</span></span><span style="display:flex;"><span>		keepalive_timeout 60;
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># 一个Tcp复用中可以并发接收的请求数</span>
</span></span><span style="display:flex;"><span>		keepalive_requests 1000;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div><div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>check interval<span style="color:#f92672">=</span><span style="color:#ae81ff">3000</span> rise<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> fall<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span> timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">1000</span> type<span style="color:#f92672">=</span>http;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># check interval=3000 rise=2 fall=5 timeout=1000 type=http;</span>
</span></span><span style="display:flex;"><span>上面配置的意思是，对static、upload、这个负载均衡条目中的所有节点，每隔3秒检测一次，请求2次正常则标记realserver状态为up，如果检测5次都失败，则标记realserver的状态为down，超时时间为1秒，检查的协议是http。</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->配置转发到<!-- raw HTML omitted --><code>Mysql</code></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->添加<!-- raw HTML omitted --><code>--with-stream</code><!-- raw HTML omitted -->模块支持<!-- raw HTML omitted --><code>TCP/UDP</code><!-- raw HTML omitted -->协议<!-- raw HTML omitted --></li>
<li><a href="https://cloud.tencent.com/developer/article/1768431" rel="external" target="_self"><code>Nginx</code>代理转发<code>Mysql</code></a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ nginx -V
</span></span><span style="display:flex;"><span>configure arguments: --prefix<span style="color:#f92672">=</span>/usr/local/nginx --with-stream</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>Nginx</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>conf</code><!-- raw HTML omitted -->文件中<!-- raw HTML omitted --><code>server</code><!-- raw HTML omitted -->字段<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">stream</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">upstream</span> <span style="color:#e6db74">cloudsocket</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">hash</span> $remote_addr <span style="color:#e6db74">consistent</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">server</span> 192.168.182.155:<span style="color:#ae81ff">3306</span> <span style="color:#e6db74">weight=5</span> <span style="color:#e6db74">max_fails=3</span> <span style="color:#e6db74">fail_timeout=30s</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">listen</span> <span style="color:#ae81ff">3306</span>;     <span style="color:#75715e"># 数据库服务器监听端口
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">proxy_connect_timeout</span> <span style="color:#e6db74">10s</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_timeout</span> <span style="color:#e6db74">300s</span>;      <span style="color:#75715e"># 客户端与代理之间的超时时间，如果5分钟内没操作将自动断开。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">cloudsocket</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 负载均衡UDP转发
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">stream</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">upstream</span> <span style="color:#e6db74">dns</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">ip_hash</span>;  	<span style="color:#75715e"># 每个请求按访问IP的hash结果分配、同一个IP固定访问同一个后端服务器
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">hash</span> $request_uri;  	<span style="color:#75715e"># 按照访问URL的hash结果分配请求、每个URL定向到同一个后端服务器
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">least_conn</span>;  	<span style="color:#75715e"># 最少连接数、分配给连接数最少的后端服务器
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">server</span> 192.168.111.99:<span style="color:#ae81ff">10086</span> <span style="color:#e6db74">down</span>;  	<span style="color:#75715e"># 当前server暂时不参与负载均衡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">server</span> 192.168.111.100:<span style="color:#ae81ff">10086</span> <span style="color:#e6db74">backup</span>;  	<span style="color:#75715e"># 预留备份服务器，只有主参与节点down掉才启用
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">server</span> 192.168.111.100:<span style="color:#ae81ff">10086</span> <span style="color:#e6db74">weigh=3</span> <span style="color:#e6db74">max_fails=3</span> <span style="color:#e6db74">fail_timeout=10</span> <span style="color:#e6db74">max_conns=128</span>;  	<span style="color:#75715e"># weigh：加权轮询、值越大分配到访问几率越高，max_fails：允许请求失败次数，fail_timeout：经过max_fails失败后，服务暂定时间、mac_conns：限制最大连接数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">listen</span> 192.168.111.98:<span style="color:#ae81ff">10086</span> <span style="color:#e6db74">udp</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_responses</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_timeout</span> <span style="color:#e6db74">20s</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_bind</span> $server_addr:$remote_port;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">dns</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></blockquote>
</blockquote>
</blockquote>
<hr>
<h3 id="nginx使用lua脚本"><code>Nginx</code>使用<code>Lua</code>脚本</h3>
<blockquote>
<ul>
<li><code>set_by_lua</code><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>Nginx</code><!-- raw HTML omitted -->变量<!-- raw HTML omitted --></li>
<li><code>loa_by_lua</code><!-- raw HTML omitted -->日志<!-- raw HTML omitted --></li>
<li><code>access_by_lua</code><!-- raw HTML omitted -->访问控制<!-- raw HTML omitted --></li>
<li><code>rewrite_by_lua</code><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>uri</code></li>
<li><code>boy_filter_by_lua</code><!-- raw HTML omitted -->修改响应体<!-- raw HTML omitted --></li>
<li><code>header_filter_by_lua</code><!-- raw HTML omitted -->修改响应头<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listen</span> <span style="color:#ae81ff">80</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server_name</span> <span style="color:#e6db74">lua.erge.com</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">location</span> <span style="color:#e6db74">/lua</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">default_type</span> <span style="color:#e6db74">text/html</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 直接使用lua语言方式
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">content_by_lua</span> <span style="color:#e6db74">&#39;ngx_say(&#34;&lt;p&gt;Hello</span> <span style="color:#e6db74">World!!!&lt;/p&gt;&#34;)&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 引用lua脚本方式
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">content_by_lua_file</span> <span style="color:#e6db74">conf/lua/hello.lua</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><ul>
<li><code>lua</code><!-- raw HTML omitted -->脚本<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;conf/lua/hello.lua<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ngx_say(&#34;&lt;p&gt;Hello World!!!&lt;/p&gt;&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->获取<!-- raw HTML omitted --><code>Nginx</code><!-- raw HTML omitted -->请求头信息<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;conf/lua/headers.lua<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">local headers = ngx_req.get_headers()
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ngx.say(&#34;Host : &#34;, headers[&#34;Host&#34;], &#34;&lt;br/&gt;&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ngx.say(&#34;user-agent : &#34;, headers[&#34;user-agent&#34;], &#34;&lt;br/&gt;&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ngx.say(&#34;user-agent : &#34;, headers.user_agent, &#34;&lt;br/&gt;&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">for key, values in pairs(headers)do
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   if type(values) == &#39;table&#39; then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       ngx.say(key, &#34; : &#34;, table.concat(values, &#34;,&#34;), &#34;&lt;br/&gt;&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   else
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       ngx.say(key, &#34; : &#34;, values, &#34;&lt;br/&gt;&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   end
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">end
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->获取<!-- raw HTML omitted --><code>Post</code><!-- raw HTML omitted -->请求参数<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;conf/lua/post.lua<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ngx.req.read_body()
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ngx.say(&#34;Post Args Begin&#34;, &#34;&lt;br/&gt;&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">local post_args = ngx.req.get_post_args()
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">for key,values in pairs(post_args) do
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    if type(values) == &#34;table&#34; then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ngx.say(key, &#34; : &#34;, table.concat(values, &#34;, &#34;), &#34;&lt;br/&gt;&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    else
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ngx.say(key, &#34; : &#34;, values, &#34;&lt;br/&gt;&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    end
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">end
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->获取<!-- raw HTML omitted --><code>Nginx</code><!-- raw HTML omitted -->版本<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;conf/lua/nginx_version.lua<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ngx.say(&#34;http_version : &#34;, ngx.req.http_version(), &#34;&lt;br/&gt;&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->获取请求方法<!-- raw HTML omitted --><code>GET、POST、PUT</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;conf/lua/method.lua<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ngx.say(&#34;get_method : &#34;, ngx.req.get_method(), &#34;&lt;br/&gt;&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->原始的请求内容<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;conf/lua/original.lua<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ngx.say(&#34;raw_hader : &#34;, ngx.req.raw_header(), &#34;&lt;br/&gt;&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><code>body</code><!-- raw HTML omitted -->内容体<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;conf/lua/body.lua<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ngx.say(&#34;get_body_date() : &#34;, ngx.req.get_body_data(), &#34;&lt;br/&gt;&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><code>Nginx</code><!-- raw HTML omitted -->全局内存缓存<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;conf/lua/shared.lua<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">local shared_data = ngx.shared.shared_data  	# 获取缓存
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">local key = shared_data:get(&#34;key&#34;)  	# 缓存里面取值
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if not key then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    key = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    shared_data:set(&#34;key&#34;, key)  	# 调用set 方法
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ngx.say(&#34;lazy set key &#34;, key, &#34;&lt;br/&gt;&#34;)  	# 等于什么
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">end
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">key = shared_data:incr(&#34;key&#34;, 1)  	# 自增加一
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ngx.say(&#34;key=&#34;, key, &#34;&lt;br/&gt;&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><a href="https://github.com/openresty/lua-resty-lrucache" rel="external" target="_self"><code>lua-resty-lrucache</code></a><!-- raw HTML omitted -->缓存<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;conf/vhosts/server.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">server {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    listen 80;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    server_name lua.erge.com;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    location /lua {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        default_type text/html;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        # 直接使用lua语言方式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        content_by_lua &#39;ngx_say(&#34;&lt;p&gt;Hello World!!!&lt;/p&gt;&#34;)&#39;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        # 引用lua脚本方式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        content_by_lua_file conf/lua/hello.lua;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        content_by_lua_block {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            require(&#34;my/cache&#34;).go()
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="过滤登录和状态码">过滤登录和状态码</h3>
<blockquote>
<ul>
<li>脚本使用<code>nslookup</code>命令获取用户<code>IP</code>地址的远程主机名，并使用<code>curl</code>命令获取远程主机的状态码。然后，它将检查远程主机的域名和状态码是否在允许的列表中。如果是，则显示<code>Access granted</code>否则显示<code>Access denied</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 定义允许登录的域名和状态码</span>
</span></span><span style="display:flex;"><span>ALLOWED_DOMAINS<span style="color:#f92672">=(</span><span style="color:#e6db74">&#34;example.com&#34;</span> <span style="color:#e6db74">&#34;example.org&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>ALLOWED_STATUS_CODES<span style="color:#f92672">=(</span><span style="color:#e6db74">&#34;200&#34;</span> <span style="color:#e6db74">&#34;301&#34;</span> <span style="color:#e6db74">&#34;302&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 获取用户IP地址</span>
</span></span><span style="display:flex;"><span>USER_IP<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo $SSH_CLIENT | awk <span style="color:#e6db74">&#39;{print $1}&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 获取用户登录时远程主机的域名和状态码</span>
</span></span><span style="display:flex;"><span>REMOTE_DOMAIN<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>nslookup $USER_IP | awk -F<span style="color:#e6db74">&#39;=&#39;</span> <span style="color:#e6db74">&#39;/name/{print $2}&#39;</span> | sed <span style="color:#e6db74">&#39;s/\.$//&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>REMOTE_STATUS_CODE<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>curl -s -o /dev/null -I -w <span style="color:#e6db74">&#34;%{http_code}&#34;</span> http://$REMOTE_DOMAIN<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 检查远程主机的域名和状态码是否被允许</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34; </span><span style="color:#e6db74">${</span>ALLOWED_DOMAINS[*]<span style="color:#e6db74">}</span><span style="color:#e6db74"> &#34;</span> <span style="color:#f92672">=</span>~ <span style="color:#e6db74">&#34; </span><span style="color:#e6db74">${</span>REMOTE_DOMAIN<span style="color:#e6db74">}</span><span style="color:#e6db74"> &#34;</span> <span style="color:#f92672">]]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34; </span><span style="color:#e6db74">${</span>ALLOWED_STATUS_CODES[*]<span style="color:#e6db74">}</span><span style="color:#e6db74"> &#34;</span> <span style="color:#f92672">=</span>~ <span style="color:#e6db74">&#34; </span><span style="color:#e6db74">${</span>REMOTE_STATUS_CODE<span style="color:#e6db74">}</span><span style="color:#e6db74"> &#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;Access granted to </span>$REMOTE_DOMAIN<span style="color:#e6db74"> with status code </span>$REMOTE_STATUS_CODE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    exit <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;Access denied to </span>$REMOTE_DOMAIN<span style="color:#e6db74"> with status code </span>$REMOTE_STATUS_CODE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span></span></span></code></pre></div></blockquote>
<ul>
<li>示例脚本，它会过滤网站后台登录的<code>IP</code>地址和状态码，将不在预定义文件列表中的IP地址发送到<code>Telegram</code>通知组。</li>
</ul>
<blockquote>
<ul>
<li>脚本会检查远程主机的状态码是否为<code>200</code>。如果是，则它将从文件中检查远程主机的IP地址是否在允许的列表中。如果是，则显示<code>Access granted</code>，否则将发送<code>Telegram</code>告警，并显示<code>Access denied</code>。请注意，您需要将<code>YOUR_TELEGRAM_API_TOKEN</code>和<code>YOUR_TELEGRAM_CHAT_ID</code>替换为您自己的<code>Telegram API Token</code>和<code>Chat ID</code>。</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 预定义允许登录的IP地址列表文件</span>
</span></span><span style="display:flex;"><span>ALLOWED_IP_LIST<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;allowed_ips.txt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 定义Telegram通知组的API Token和Chat ID</span>
</span></span><span style="display:flex;"><span>TELEGRAM_API_TOKEN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;YOUR_TELEGRAM_API_TOKEN&#34;</span>
</span></span><span style="display:flex;"><span>TELEGRAM_CHAT_ID<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;YOUR_TELEGRAM_CHAT_ID&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 获取用户IP地址</span>
</span></span><span style="display:flex;"><span>USER_IP<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo $SSH_CLIENT | awk <span style="color:#e6db74">&#39;{print $1}&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 获取用户登录时远程主机的状态码</span>
</span></span><span style="display:flex;"><span>REMOTE_STATUS_CODE<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>curl -s -o /dev/null -I -w <span style="color:#e6db74">&#34;%{http_code}&#34;</span> http://example.com/login<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 检查远程主机的状态码是否为200</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;</span>$REMOTE_STATUS_CODE<span style="color:#e6db74">&#34;</span> -eq <span style="color:#e6db74">&#34;200&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 检查远程主机的IP地址是否在允许的列表中</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> grep -Fxq <span style="color:#e6db74">&#34;</span>$USER_IP<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span>$ALLOWED_IP_LIST<span style="color:#e6db74">&#34;</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        echo <span style="color:#e6db74">&#34;Access granted to </span>$USER_IP<span style="color:#e6db74"> with status code </span>$REMOTE_STATUS_CODE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        exit <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 发送Telegram告警</span>
</span></span><span style="display:flex;"><span>        MESSAGE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Unauthorized login attempt from IP </span>$USER_IP<span style="color:#e6db74"> with status code </span>$REMOTE_STATUS_CODE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        URL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://api.telegram.org/bot</span>$TELEGRAM_API_TOKEN<span style="color:#e6db74">/sendMessage&#34;</span>
</span></span><span style="display:flex;"><span>        curl -s -X POST $URL -d chat_id<span style="color:#f92672">=</span>$TELEGRAM_CHAT_ID -d text<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$MESSAGE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        echo <span style="color:#e6db74">&#34;Access denied to </span>$USER_IP<span style="color:#e6db74"> with status code </span>$REMOTE_STATUS_CODE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;Access denied to </span>$USER_IP<span style="color:#e6db74"> with status code </span>$REMOTE_STATUS_CODE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span></span></span></code></pre></div></blockquote>
<ul>
<li>示例脚本，用于过滤网站后台登录<code>URL</code>的<code>IP</code>地址和状态码，将不在预定义文件列表中的<code>IP</code>地址发送到<code>Telegram</code>通知组。</li>
</ul>
<blockquote>
<ul>
<li>脚本会发送一个<code>HTTP</code>请求来检查网站后台登录<code>URL</code>的<code>IP</code>地址和状态码。如果状态码为<code>200</code>，则它将从<code>HTTP</code>响应中提取远程主机的IP地址，并从文件中检查它是否在允许的列表中。如果是，则显示<code>Access granted</code>，否则将发送<code>Telegram</code>告警，并显示<code>Access denied</code>。请注意，您需要将<code>YOUR_TELEGRAM_API_TOKEN</code>和<code>YOUR_TELEGRAM_CHAT_ID</code>替换为您自己的<code>Telegram API Token</code>和<code>Chat ID</code>，并根据需要修改<code>LOGIN_URL</code>和<code>REQUEST_HEADERS</code>。</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 预定义允许登录的IP地址列表文件</span>
</span></span><span style="display:flex;"><span>ALLOWED_IP_LIST<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;allowed_ips.txt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 定义需要检查的网站后台登录URL和请求头信息</span>
</span></span><span style="display:flex;"><span>LOGIN_URL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://example.com/admin/login&#34;</span>
</span></span><span style="display:flex;"><span>REQUEST_HEADERS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-H &#39;User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:90.0) Gecko/20100101 Firefox/90.0&#39; -H &#39;Accept-Language: en-US,en;q=0.5&#39;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 定义Telegram通知组的API Token和Chat ID</span>
</span></span><span style="display:flex;"><span>TELEGRAM_API_TOKEN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;YOUR_TELEGRAM_API_TOKEN&#34;</span>
</span></span><span style="display:flex;"><span>TELEGRAM_CHAT_ID<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;YOUR_TELEGRAM_CHAT_ID&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 获取用户IP地址</span>
</span></span><span style="display:flex;"><span>USER_IP<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>curl -s -o /dev/null -w <span style="color:#e6db74">&#34;%{http_code}:%{remote_ip}&#34;</span> $LOGIN_URL -H <span style="color:#e6db74">&#34;</span>$REQUEST_HEADERS<span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 获取远程主机的状态码</span>
</span></span><span style="display:flex;"><span>REMOTE_STATUS_CODE<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;</span>$USER_IP<span style="color:#e6db74">&#34;</span> | cut -d<span style="color:#e6db74">&#39;:&#39;</span> -f1<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 检查远程主机的状态码是否为200</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;</span>$REMOTE_STATUS_CODE<span style="color:#e6db74">&#34;</span> -eq <span style="color:#e6db74">&#34;200&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 获取远程主机的IP地址</span>
</span></span><span style="display:flex;"><span>    REMOTE_IP<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;</span>$USER_IP<span style="color:#e6db74">&#34;</span> | cut -d<span style="color:#e6db74">&#39;:&#39;</span> -f2<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 检查远程主机的IP地址是否在允许的列表中</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> grep -Fxq <span style="color:#e6db74">&#34;</span>$REMOTE_IP<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span>$ALLOWED_IP_LIST<span style="color:#e6db74">&#34;</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        echo <span style="color:#e6db74">&#34;Access granted to </span>$REMOTE_IP<span style="color:#e6db74"> with status code </span>$REMOTE_STATUS_CODE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        exit <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 发送Telegram告警</span>
</span></span><span style="display:flex;"><span>        MESSAGE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Unauthorized login attempt from IP </span>$REMOTE_IP<span style="color:#e6db74"> with status code </span>$REMOTE_STATUS_CODE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        URL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://api.telegram.org/bot</span>$TELEGRAM_API_TOKEN<span style="color:#e6db74">/sendMessage&#34;</span>
</span></span><span style="display:flex;"><span>        curl -s -X POST $URL -d chat_id<span style="color:#f92672">=</span>$TELEGRAM_CHAT_ID -d text<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$MESSAGE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        echo <span style="color:#e6db74">&#34;Access denied to </span>$REMOTE_IP<span style="color:#e6db74"> with status code </span>$REMOTE_STATUS_CODE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;Access denied with status code </span>$REMOTE_STATUS_CODE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span></span></span></code></pre></div></blockquote>
<ul>
<li>稍微修改的脚本，用于过滤网站后台登录日志文件中的<code>URL</code>、<code>IP</code>地址和状态码，将不在预定义文件列表中的<code>IP</code>地址发送到<code>Telegram</code>通知组：</li>
</ul>
<blockquote>
<ul>
<li>该脚本会从日志文件中过滤出登录<code>URL</code>、<code>IP</code>地址和状态码信息，并遍历这些信息。对于每个<code>IP</code>地址和状态码，它将检查状态码是否为<code>200</code>，然后检查<code>IP</code>地址是否在允许的列表中。如果是，则显示<code>Access granted</code>，否则将发送<code>Telegram</code>告警，并显示<code>Access denied</code>。请注意，您需要将<code>YOUR_TELEGRAM_API_TOKEN</code>和<code>YOUR_TELEGRAM_CHAT_ID</code>替换为您自己的<code>Telegram API Token</code>和<code>Chat ID</code>，并根据需要修改<code>ALLOWED_IP_LIST</code>和<code>LOG_FILE</code>。</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 预定义允许登录的IP地址列表文件</span>
</span></span><span style="display:flex;"><span>ALLOWED_IP_LIST<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;allowed_ips.txt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 定义需要检查的网站后台登录日志文件</span>
</span></span><span style="display:flex;"><span>LOG_FILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/var/log/nginx/access.log&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 定义Telegram通知组的API Token和Chat ID</span>
</span></span><span style="display:flex;"><span>TELEGRAM_API_TOKEN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;YOUR_TELEGRAM_API_TOKEN&#34;</span>
</span></span><span style="display:flex;"><span>TELEGRAM_CHAT_ID<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;YOUR_TELEGRAM_CHAT_ID&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用grep命令从日志文件中过滤出登录URL、IP地址和状态码</span>
</span></span><span style="display:flex;"><span>LOG_FILTER<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>grep -E <span style="color:#e6db74">&#39;\/admin\/login.*HTTP\/1\.[01]&#34; 200&#39;</span> $LOG_FILE | awk <span style="color:#e6db74">&#39;{print $1, $7, $9}&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 遍历过滤出的日志信息</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> read -r log_info; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 分别提取IP地址和状态码</span>
</span></span><span style="display:flex;"><span>    REMOTE_IP<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;</span>$log_info<span style="color:#e6db74">&#34;</span> | awk <span style="color:#e6db74">&#39;{print $1}&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>    REMOTE_STATUS_CODE<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;</span>$log_info<span style="color:#e6db74">&#34;</span> | awk <span style="color:#e6db74">&#39;{print $2}&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 检查状态码是否为200</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;</span>$REMOTE_STATUS_CODE<span style="color:#e6db74">&#34;</span> -eq <span style="color:#e6db74">&#34;200&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 检查IP地址是否在允许的列表中</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> grep -Fxq <span style="color:#e6db74">&#34;</span>$REMOTE_IP<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span>$ALLOWED_IP_LIST<span style="color:#e6db74">&#34;</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#34;Access granted to </span>$REMOTE_IP<span style="color:#e6db74"> with status code </span>$REMOTE_STATUS_CODE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 发送Telegram告警</span>
</span></span><span style="display:flex;"><span>            MESSAGE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Unauthorized login attempt from IP </span>$REMOTE_IP<span style="color:#e6db74"> with status code </span>$REMOTE_STATUS_CODE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>            URL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://api.telegram.org/bot</span>$TELEGRAM_API_TOKEN<span style="color:#e6db74">/sendMessage&#34;</span>
</span></span><span style="display:flex;"><span>            curl -s -X POST $URL -d chat_id<span style="color:#f92672">=</span>$TELEGRAM_CHAT_ID -d text<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$MESSAGE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#34;Access denied to </span>$REMOTE_IP<span style="color:#e6db74"> with status code </span>$REMOTE_STATUS_CODE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span> <span style="color:#f92672">&lt;&lt;&lt;</span> <span style="color:#e6db74">&#34;</span>$LOG_FILTER<span style="color:#e6db74">&#34;</span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          </section>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="work_order">Work_Order</h1>


            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Work_Order</h1>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_ferry">Install_Ferry</h1>

<h2 id="安装ferry工单系统">安装<code>Ferry</code>工单系统</h2>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/lanyulei/ferry" rel="external" target="_self"><code>Github Ferry</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.fdevops.com/docs/ferry-tutorial-document/introduction" rel="external" target="_self">安装<code>Ferry</code>官方文档</a></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->以来服务版本要求<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>MySQL &gt; 5.7</code></li>
<li><code>Go &gt;= 1.14</code></li>
<li><code>Redis</code></li>
<li><code>node &gt;= v12</code>(稳定版本)</li>
<li><code>npm &gt;= v6.14.8</code></li>
<li><!-- raw HTML omitted -->若是安装出错，请先确认<!-- raw HTML omitted --><code>redis</code><!-- raw HTML omitted -->及<!-- raw HTML omitted --><code>MySQL</code><!-- raw HTML omitted -->是否安装配置成功<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<hr>
<h3 id="部署方式">部署方式</h3>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://www.fdevops.com/docs/ferry-tutorial-document/install" rel="external" target="_self">手动部署</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.fdevops.com/docs/ferry-tutorial-document/juebenbushu" rel="external" target="_self">脚本自动部署</a></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h2 id="导航页">导航页</h2>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/Tencent/bk-sops" rel="external" target="_self"><code>bk-sops</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://bk.tencent.com/download/" rel="external" target="_self">蓝鲸智云</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://nas.asmrs.xyz:48091/archives/easy-nav" rel="external" target="_self">部署导航页</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://zhuanlan.zhihu.com/p/109425587" rel="external" target="_self">自己搭建导航页</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/zhuima/daohang" rel="external" target="_self"><code>OP</code>内部导航系统</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://post.smzdm.com/p/ag82pkd3/" rel="external" target="_self">威联通<code>web</code>导航页</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://zhuanlan.zhihu.com/p/441573312" rel="external" target="_self">部署一个简单的导航页</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://cloud.tencent.com/developer/article/1655221" rel="external" target="_self">运维内部网址导航系统</a></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          </section>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="docker">Docker</h1>


            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Docker</h1>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="use_docker">Use_Docker</h1>

<h2 id="使用docker">使用<code>Docker</code></h2>
<h3 id="docker命令"><code>Docker</code>命令</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->现有启动中容器打包成镜像<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ docker commit f61b39f3bb7e flanneld:<span style="color:#66d9ef">$(</span>date  <span style="color:#e6db74">&#34;+%Y%m%d%H%M%S&#34;</span><span style="color:#66d9ef">)</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->构建镜像<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ docker build -t container_name/nginx:<span style="color:#66d9ef">$(</span>date +%Y%m%d%H%M<span style="color:#66d9ef">)</span> --rm .</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->打标签<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 查看 tag 使用帮助</span>
</span></span><span style="display:flex;"><span>$ docker tag -h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ docker tag nginx:v1 container_name/nginx:<span style="color:#e6db74">`</span>date +%Y%m%d%H%M<span style="color:#e6db74">`</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->推送到远程仓库<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ docker push container_name/nginx:tagname
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 推送到自建harbor</span>
</span></span><span style="display:flex;"><span>$ docker tag SOURCE_IMAGE<span style="color:#f92672">[</span>:TAG<span style="color:#f92672">]</span> 192.168.35.128:9527/test/IMAGE<span style="color:#f92672">[</span>:TAG<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 推送镜像到当前项目</span>
</span></span><span style="display:flex;"><span>$ docker push 192.168.35.128:9527/test/IMAGE<span style="color:#f92672">[</span>:TAG<span style="color:#f92672">]</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->启动停止命令<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ docker-compose -f /opt/docker-compose.yml down &gt;&gt; $log 2&gt;&amp;<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>$ docker-compose -f /opt/docker-compose.yml up -d &gt;&gt; $log 2&gt;&amp;<span style="color:#ae81ff">1</span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="dockerfile文件"><code>Dockerfile</code>文件</h3>
<blockquote>
<ul>
<li>d</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> nginx  	# 构建镜像基于哪个镜像</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">MAINTAINER</span><span style="color:#e6db74">：镜像维护者姓名或邮箱地址</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> yum -y install wget <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    <span style="color:#f92672">&amp;&amp;</span> wget -O redis.tar.gz <span style="color:#e6db74">&#34;http://download.redis.io/releases/redis-5.0.3.tar.gz&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    <span style="color:#f92672">&amp;&amp;</span> tar -xvf redis.tar.gz  	<span style="color:#75715e"># 是在 docker build。构建镜像执行的命令，每一次RUN都会构建一层</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;/etc/nginx/nginx.conf&#34;</span>] <span style="color:#75715e"># 变参，运行容器时执行的shell环境，如果有多个则以最后一个为准，也可以为ENTRYPOINT提供参数</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">VOLUME</span><span style="color:#e6db74">：指定容器挂载点到宿主机自动生成的目录或其他容器，如果没有定义则使用默认</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">USER</span><span style="color:#e6db74"> &lt;用户名&gt;[:&lt;用户组&gt;]  	# 为RUN、CMD、和 ENTRYPOINT 执行命令指定运行用户和如果没有定义则使用默认</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> &lt;工作目录路径&gt;  # 为 RUN、CMD、ENTRYPOINT、COPY 和 ADD 设置工作目录，就是切换目录</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>HEALTHCHECH：健康检查<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ARG</span>：变量属性值，不在容器内部起作用，只有 docker build 的过程中有效<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 80 443  	# 声明容器的服务端口（仅仅是声明），使用端口需要做映射</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span>：设置容器环境变量<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ADD</span>：拷贝文件或目录到容器中，如果是URL或压缩包便会自动下载或自动解压<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> hom?.txt /opt/data/  	<span style="color:#75715e"># 拷贝文件或目录到容器中，跟ADD类似，但不具备自动下载或解压的功能</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [<span style="color:#e6db74">&#34;nginx&#34;</span>, <span style="color:#e6db74">&#34;-c&#34;</span>] <span style="color:#75715e"># 定参，运行容器时执行的shell命令，如果存在多个 ENTRYPOINT 指令，仅最后一个生效</span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="docker-compose文件"><code>docker-compose</code>文件</h3>
<blockquote>
<ul>
<li><code>docker-compose-test.yml</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;3&#34;</span>    <span style="color:#75715e"># docker-compose版本</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">services</span>:   <span style="color:#75715e"># 定义container</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">mysql</span>:    <span style="color:#75715e"># container名称-相当于--name web</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">mysql </span> <span style="color:#75715e"># 启动后名称</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">network_mode</span>: <span style="color:#ae81ff">bridge</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">mysql:8     </span> <span style="color:#75715e"># image来源</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">MYSQL_ROOT_PASSWORD</span>: <span style="color:#e6db74">&#34;root&#34;</span>   <span style="color:#75715e"># 设置root账号密码</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">MYSQL_USER</span>: <span style="color:#e6db74">&#34;user_name&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">MYSQL_PASSWORD</span>: <span style="color:#e6db74">&#34;password&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">MYSQL_DATABASE</span>: <span style="color:#e6db74">&#34;databases_name&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">MYSQL_ALLOW_EMPTY_PASSWORD</span>: <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">TZ</span>: <span style="color:#ae81ff">Asia/Shanghai          </span> <span style="color:#75715e"># 指定东八时区</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">user</span>: <span style="color:#e6db74">&#34;1001:1001&#34;</span>   <span style="color:#75715e"># 启动后容器中用户id和组id，也可以指定用户名和组名</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ulimits</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">memlock</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">soft</span>: -<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">hard</span>: -<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:    <span style="color:#75715e"># 设置持久化映射关系，</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">../data/mysql:/var/lib/mysql</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">../conf/mysql/conf.d:/etc/mysql/conf.d</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">../conf/mysql/my.cnf:/etc/mysql/my.cnf</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;/etc/localtime:/etc/localtime:ro&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:      <span style="color:#75715e"># 指定端口映射</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;3306:3306&#34;</span>     <span style="color:#75715e"># 端口映射关系 和ports一起相当于-p 9001:9989</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:   <span style="color:#75715e"># 指定network-相当于--network springboot</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">overlay</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">springboot</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ipv4_address</span>: <span style="color:#ae81ff">172.20.0.6</span>    <span style="color:#75715e"># 指定容器ip地址-相当于--ip 172.20.0.6</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;--lower_case_table_names=1&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      - &#34;--init-connect=&#39;SET NAMES UTF8MB4;&#39;&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;--character-set-server=utf8mb4&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;--collation-server=utf8mb4_unicode_ci&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#####  	第二个容器es参数配置  	#####</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">es</span>:   <span style="color:#75715e"># container名称-相当于--name es</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">docker.elastic.co/elasticsearch/elasticsearch:7.11.1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">es</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">discovery.type=single-node</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;ES_JAVA_OPTS=-Xms512m -Xmx512m&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ulimits</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">memlock</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">soft</span>: -<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">hard</span>: -<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;../data/es:/usr/share/elasticsearch/data&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;/etc/localtime:/etc/localtime:ro&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;../conf/es/ik:/usr/share/elasticsearch/plugins/ik&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">9100</span>:<span style="color:#ae81ff">9100</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">9200</span>:<span style="color:#ae81ff">9200</span>   <span style="color:#75715e"># 前面为宿主机映射端口，后面为容器内端口</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">overlay</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rabbit</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">rabbit</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">rabbitmq:3-management</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">RABBITMQ_DEFAULT_USER</span>: <span style="color:#e6db74">&#34;user_name&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">RABBITMQ_DEFAULT_PASS</span>: <span style="color:#e6db74">&#34;password&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">RABBITMQ_DEFAULT_VHOST</span>: <span style="color:#e6db74">&#34;develop&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;5672:5672&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;15672:15672&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;/etc/localtime:/etc/localtime:ro&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">overlay</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#####  	第三个容器redis参数配置  	##### </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">redis</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">redis</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">redis:6</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;6379:6379&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: <span style="color:#e6db74">&#34;redis-server --requirepass password&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;/etc/localtime:/etc/localtime:ro&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">overlay</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;7474:7474&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;7687:7687&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">overlay</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#####  	第四个容器参数配置  	#####</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">javaapp</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name </span>: <span style="color:#ae81ff">javaapp</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image </span>: <span style="color:#ae81ff">javaapp</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">build</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">context</span>: <span style="color:#ae81ff">./</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">dockerfile</span>: <span style="color:#ae81ff">./javaapp</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;/etc/localtime:/etc/localtime:ro&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;/tmp/logs:/opt/logs&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;../service/javaapp-0.0.1-SNAPSHOT.jar:/javaapp-0.0.1-SNAPSHOT.jar&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">LOCAL_TEST</span>: <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">MYSQL_URL</span>: <span style="color:#e6db74">&#34;jdbc:mysql://mysql:3306/gcgdata?characterEncoding=utf-8&amp;useSSL=true&amp;serverTimezone=GMT&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">MYSQL_USER</span>: <span style="color:#e6db74">&#34;user_name&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">MYSQL_PASSWD</span>: <span style="color:#e6db74">&#34;password&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">REDIS_HOST</span>: <span style="color:#e6db74">&#34;redis&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">REDIS_PORT</span>: <span style="color:#e6db74">&#34;6379&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">REDIS_PASSWD</span>: <span style="color:#e6db74">&#34;password&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">RABBITMQ_HOST</span>: <span style="color:#e6db74">&#34;rabbit&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">RABBITMQ_PORT</span>: <span style="color:#e6db74">&#34;5672&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">RABBITMQ_USER</span>: <span style="color:#e6db74">&#34;user_name&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">RABBITMQ_PASSWD</span>: <span style="color:#e6db74">&#34;password&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">RABBITMQ_VHOST</span>: <span style="color:#e6db74">&#34;develop&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">RABBITMQ_SSL_ENABLED</span>: <span style="color:#e6db74">&#34;false&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ES_SCHEME</span>: <span style="color:#e6db74">&#34;http&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ES_HOSTS</span>: <span style="color:#e6db74">&#34;es:9200&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ES_USER</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ES_PASSWD</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">XXXAPP_USER_DEFAULTAVATAR</span>: <span style="color:#e6db74">&#34;https://oss.domain.com/xxx/default/icon_user_default.png&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">XXXAPP_USER_NICKNAMEPREFIX</span>: <span style="color:#e6db74">&#34;xxx_&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">XXXAPP_URL_PREFIX</span>: <span style="color:#e6db74">&#34;http://domain.com/appApi&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">XXXAPP_SHARE_URL</span>: <span style="color:#e6db74">&#39;{scheme}://domain.com/{inviteCode}&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">XXXAPP_DOWNLOAD_URL_IOS_STORE</span>: <span style="color:#e6db74">&#34;http://fir.domain.com/downapple?randStr=3psgechs0g&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">CN_MSG_URL</span>: <span style="color:#e6db74">&#39;http://IP:8000&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">DEFAUTL_SMS_URL</span>: <span style="color:#e6db74">&#34;http://IP:80001&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">DEFAULT_SMS_CONTENT</span>: <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">XXX_DOMAINS</span>: <span style="color:#e6db74">&#34;http://domain.com,http://domain.vip&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">XXX_API_DOMAINS</span>: <span style="color:#e6db74">&#34;http://domain.com,http://domain.vip&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">FORBID_MOBILE</span>: <span style="color:#e6db74">&#34;165,171,172,1700,1701,1702,162,1703,1705,1706,1704,1707,1708,1709,167&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">DATA_CENTER_ID</span>: <span style="color:#e6db74">&#34;1&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">XXX_SHARE_DOMAINS</span>: <span style="color:#e6db74">&#34;domain.vip&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">QINIU_AK</span>: <span style="color:#e6db74">&#34;gXAT245FwtyTFqutHpouoc7oKg8tsfOUaawjTkqe&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">QINIU_KK</span>: <span style="color:#e6db74">&#34;YCMdEVi2cdZPqKm6N5dHv8H6UNdGAtDJ2OQBwI9G&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">QINIU_BUCKET</span>: <span style="color:#e6db74">&#34;ossprod&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">depends_on</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">mysql</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">es</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">rabbit</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">redis</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">overlay</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#####  	第五个容器参数配置  	##### </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nginx</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;/etc/localtime:/etc/localtime:ro&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;../conf/nginx/nginx.conf:/etc/nginx/nginx.conf&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;../conf/nginx/mime.types:/etc/nginx/mime.types&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;../conf/nginx/conf.d:/etc/nginx/conf.d&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;../html:/usr/share/nginx/html&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;80:80&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    depends_on:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">overlay</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">overlay</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">networks</span>:   <span style="color:#75715e"># 定义network-相当于 docker network create --subnet=172.20.0.0/24 springboot 该命令创建的network默认也是桥接模式</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">springboot</span>:   <span style="color:#75715e"># network名称</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">driver</span>: <span style="color:#ae81ff">bridge     </span> <span style="color:#75715e"># 定义network类型为桥接模式</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ipam</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">driver</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">config</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">subnet</span>: <span style="color:#ae81ff">172.20.0.0</span><span style="color:#ae81ff">/24    </span> <span style="color:#75715e"># 指定网段信息</span></span></span></code></pre></div></blockquote>
</blockquote>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_docker">Install_Docker</h1>

<h2 id="docker部署"><code>Docker</code>部署</h2>
<h3 id="debian部署docker"><code>Debian</code>部署<code>Docker</code></h3>
<blockquote>
<ul>
<li>卸载所有冲突的包</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ <span style="color:#66d9ef">for</span> pkg in docker.io docker-doc docker-compose podman-docker containerd runc; <span style="color:#66d9ef">do</span> sudo apt-get remove $pkg; <span style="color:#66d9ef">done</span></span></span></code></pre></div></blockquote>
<ul>
<li>设置<code>Docker</code>的<code>apt</code>存储库</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 添加Docker的官方GPG密钥</span>
</span></span><span style="display:flex;"><span>$ sudo apt-get update
</span></span><span style="display:flex;"><span>$ sudo apt-get install ca-certificates curl
</span></span><span style="display:flex;"><span>$ sudo install -m <span style="color:#ae81ff">0755</span> -d /etc/apt/keyrings
</span></span><span style="display:flex;"><span>$ sudo curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc
</span></span><span style="display:flex;"><span>$ sudo chmod a+r /etc/apt/keyrings/docker.asc
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 将存储库添加到 Apt 源</span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  <span style="color:#e6db74">&#34;deb [arch=</span><span style="color:#66d9ef">$(</span>dpkg --print-architecture<span style="color:#66d9ef">)</span><span style="color:#e6db74"> signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  </span><span style="color:#66d9ef">$(</span>. /etc/os-release <span style="color:#f92672">&amp;&amp;</span> echo <span style="color:#e6db74">&#34;</span>$VERSION_CODENAME<span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74"> stable&#34;</span> | <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null
</span></span><span style="display:flex;"><span>$ sudo apt-get update</span></span></code></pre></div></blockquote>
<ul>
<li>按照<code>Docker</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 安装最新版本 </span>
</span></span><span style="display:flex;"><span>$ sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 列出可用的版本</span>
</span></span><span style="display:flex;"><span>$ apt-cache madison docker-ce | awk <span style="color:#e6db74">&#39;{ print $3 }&#39;</span>
</span></span><span style="display:flex;"><span>5:26.1.0-1~debian.12~bookworm
</span></span><span style="display:flex;"><span>5:26.0.2-1~debian.12~bookworm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ VERSION_STRING<span style="color:#f92672">=</span>5:26.1.0-1~debian.12~bookworm
</span></span><span style="display:flex;"><span>$ sudo apt-get install docker-ce<span style="color:#f92672">=</span>$VERSION_STRING docker-ce-cli<span style="color:#f92672">=</span>$VERSION_STRING containerd.io docker-buildx-plugin docker-compose-plugin</span></span></code></pre></div></blockquote>
<ul>
<li>启动</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo systemctl enable docker <span style="color:#f92672">&amp;&amp;</span> sudo systemctl start docker</span></span></code></pre></div></blockquote>
<ul>
<li>配置普通用户加入<code>Docker</code>组</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo usermod -aG docker user_name</span></span></code></pre></div></blockquote>
<ul>
<li>配置<code>docker-compose</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ln -s /usr/libexec/docker/cli-plugins/docker-compose /usr/bin/docker-compose</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="centos部署docker"><code>CentOS</code>部署<code>Docker</code></h3>
<blockquote>
<ul>
<li>卸载旧版本</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo yum remove docker <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>                  docker-client <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>                  docker-client-latest <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>                  docker-common <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>                  docker-latest <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>                  docker-latest-logrotate <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>                  docker-logrotate <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>                  docker-engine</span></span></code></pre></div></blockquote>
<ul>
<li>使用<code>rpm</code>存储库安装</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo yum install -y yum-utils
</span></span><span style="display:flex;"><span>$ sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span></span></code></pre></div></blockquote>
<ul>
<li>安装<code>Docker Engine</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 安装最新版本</span>
</span></span><span style="display:flex;"><span>$ sudo yum install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装特定版本</span>
</span></span><span style="display:flex;"><span>$ yum list docker-ce --showduplicates | sort -r
</span></span><span style="display:flex;"><span>docker-ce.x86_64    3:26.1.3-1.el9    docker-ce-stable
</span></span><span style="display:flex;"><span>docker-ce.x86_64    3:26.1.2-1.el9    docker-ce-stable
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo yum install docker-ce-&lt;VERSION_STRING&gt; docker-ce-cli-&lt;VERSION_STRING&gt; containerd.io docker-buildx-plugin docker-compose-plugin</span></span></code></pre></div></blockquote>
<ul>
<li>启动</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ $ sudo systemctl enable docker <span style="color:#f92672">&amp;&amp;</span> sudo systemctl start docker</span></span></code></pre></div></blockquote>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          </section>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="use_linux">Use_Linux</h1>


            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Use_Linux</h1>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="system_optimization">System_Optimization</h1>

<h2 id="linux系统优化"><code>Linux</code>系统优化</h2>
<h3 id="系统初始化">系统初始化</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install vim lrzsz epel-release
</span></span><span style="display:flex;"><span>$ yum -y update
</span></span><span style="display:flex;"><span>$ setenforce <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> sed -i <span style="color:#e6db74">&#34;s/SELINUX=enforcing/SELINUX=disabled/g&#34;</span> /etc/selinux/config</span></span></code></pre></div></blockquote>
<hr>
<h3 id="优化系统内核">优化系统内核</h3>
<ul>
<li>
<ol>
<li><a href="https://wiki.archlinux.org/title/sysctl#Installation" rel="external" target="_self">系统控制</a></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo  <span style="color:#e6db74">&#34;# 所有配置都是：0：为关闭，1：为开启
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 关闭ipv6
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv6.conf.all.disable_ipv6 = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv6.conf.default.disable_ipv6 = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 调整 IPv6
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv6.conf.default.router_solicitations = 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv6.conf.default.accept_ra_rtr_pref = 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv6.conf.default.accept_ra_pinfo = 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv6.conf.default.accept_ra_defrtr = 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv6.conf.default.autoconf = 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv6.conf.default.dad_transmits = 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv6.conf.default.max_addresses = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 忽略 ICMP 回显请求、设置服务器禁ping
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.icmp_echo_ignore_all = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv6.icmp.echo_ignore_all = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 避免放大攻击
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.icmp_echo_ignore_broadcasts = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 开启恶意icmp错误消息保护
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.icmp_ignore_bogus_error_responses = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 开启/关闭路由转发 1：为开启，0：为关闭
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.ip_forward = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.conf.all.forwarding = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv6.conf.all.forwarding = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 开启反向路径过滤、通过启用反向路径过滤，内核将对从机器上所有接口接收到的数据包进行源验证。这可以防止攻击者使用 IP 欺骗方法造成伤害
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.conf.default.rp_filter = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.conf.all.rp_filter = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 打开并记录欺骗、源路由和重定向数据包
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.conf.default.log_martians = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.conf.all.log_martians = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 处理无源路由的包
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.conf.all.accept_source_route = 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.conf.default.accept_source_route = 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 关闭sysrq功能
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kernel.sysrq = 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># core文件名中添加pid作为扩展名
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kernel.core_uses_pid = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># TCP/IP 堆栈加固、开启SYNCookies,当出现SYN等待队列溢出时,启用cookies 来处理
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.tcp_syncookies = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 修改消息队列长度
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kernel.msgmnb = 65536
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kernel.msgmax = 65536
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 优化 LB 端口使用 增加系统文件描述符限制
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fs.file-max = 65535
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 允许更多的 PID（以减少翻转问题）； 可能会破坏某些程序 32768
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kernel.pid_max = 65535
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 设置最大内存共享段大小bytes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kernel.shmmax = 68719476736
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kernel.shmall = 4294967296
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 启用timewait快速回收
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.tcp_tw_recycle = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.tcp_sack = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.tcp_window_scaling = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 增加专用于网络接口的内存
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.core.rmem_default = 1048576
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.core.rmem_max = 16777216
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.core.wmem_default = 1048576
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.core.wmem_max = 16777216
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.core.optmem_max = 65536
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.tcp_rmem = 4096 1048576 2097152
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.tcp_wmem = 4096 65536 16777216
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.udp_rmem_min = 8192
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.udp_wmem_min = 8192
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 启用 TCP 快速打开、通过在发送方的初始 TCP SYN 期间启用数据交换来帮助减少网络延迟。使用该值3而不是默认值1允许
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.tcp_fastopen = 3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 增加最大连接数、警告：增加此值可能只会提高高负载服务器的性能，并可能导致处理速度变慢（例如单线程阻塞服务器）或工作线程/进程数量不足
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># net.core.somaxconn = 8192
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 下述内存单位是页，而不是字节。可参考的优化值是:786432 1048576 1572864
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># net.ipv4.tcp_tw_len = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 增加接收队列的大小、每个网络接口接收数据包的速率比内核处理这些包的速率快时，允许送到队列的数据包的最大数目
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.core.netdev_max_backlog = 262144
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 限制仅仅是为了防止简单的DoS 攻击
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.tcp_max_orphans = 3276800
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 调整挂起的连接处理、未收到客户端确认信息的连接请求的最大值
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.tcp_max_syn_backlog = 8192
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 等待时间，默认是:180000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.tcp_max_tw_buckets = 6000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 开启重用。允许将TIME-WAIT sockets 重新用于新的TCP 连接
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.tcp_tw_reuse = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.tcp_fin_timeout = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.tcp_slow_start_after_idle = 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># TCP 时间戳
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.tcp_timestamps = 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 内核放弃建立连接之前发送SYNACK 包的数量
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.tcp_synack_retries = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 内核放弃建立连接之前发送SYN 包的数量
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.tcp_syn_retries = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.tcp_mem = 94500000 915000000 927000000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 启用 MTU 探测、最大传输单元 (MTU)越长，性能越好，但可靠性越差
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># net.ipv4.tcp_mtu_probing = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 更改 TCP 保活参数、当keepalive 起用的时候，TCP 发送keepalive 消息的频度。缺省是2 小时
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.tcp_keepalive_time = 60
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.tcp_keepalive_intvl = 10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.tcp_keepalive_probes = 6
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.tcp_keepalive_time = 30
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 增加临时端口范围、允许系统打开的端口范围
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.ip_local_port_range = 1024 65000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 修改防火墙表大小，默认65536
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># net.netfilter.nf_conntrack_max=655350
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># net.netfilter.nf_conntrack_tcp_timeout_established=1200
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 可选值：0、1、2，1， 表示内核允许分配所有的物理内存，而不管当前的内存状态如何
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">vm.overcommit_memory=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">vm.swappiness = 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 禁用 ICMP 重定向、确保无人能修改路由表
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.conf.all.accept_redirects = 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.conf.default.accept_redirects = 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.conf.all.secure_redirects = 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.conf.default.secure_redirects = 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv6.conf.all.accept_redirects = 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv6.conf.default.accept_redirects = 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 在非路由器上禁用 ICMP 重定向发送
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.conf.all.send_redirects = 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.conf.default.send_redirects = 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># Other tunings
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.tcp_no_metrics_save = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">vm.min_free_kbytes = 65536
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 启用 BBR 拥塞控制算法可以帮助实现更高的带宽和更低的互联网流量延迟。首先，加载模块tcp_bbr。
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># net.core.default_qdisc = cake
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># net.ipv4.tcp_congestion_control = bbr
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 将脏字节设置为足够小的值、例如 4M
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># vm.dirty_background_bytes = 4194304
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># vm.dirty_bytes = 4194304
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 磁盘IO配置，linux会设置40%的可用内存用来做系统cache，当flush数据时这40%内存中的数据由于和IO同步问题导致超时(120s)，所将40%减小到10%，避免超时
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># vm.dirty_ratio=10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># vm.dirty_background_ratio=5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># nfs
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fs.nfs.nfs_callback_tcpport = 32764
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fs.nfs.nlm_tcpport = 32768
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fs.nfs.nlm_udpport = 32768 &#34;</span> &gt;&gt; /etc/sysctl.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sysctl -p  	<span style="color:#75715e"># 重载使之生效</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="修改系统ulimit">修改系统<code>Ulimit</code></h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 临时修改</span>
</span></span><span style="display:flex;"><span>$ ulimit -n <span style="color:#ae81ff">65535</span>  	
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 写到配置文件永久生效</span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* soft nproc 65535  	# soft 软限制
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* hard nproc 65535  	# hard 硬限制
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">root soft nofile 65535  	# 针对用户单独做限制
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">root hard nofile 65535
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* soft nofile 25535
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* hard nofile 25535
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* soft memlock unlimited
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* soft memlock unlimited &#34;</span> &gt;&gt;/etc/security/limits.conf</span></span></code></pre></div></blockquote>
<hr>
<h3 id="修改sshd">修改<code>sshd</code></h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;AllowUsers myadmin@0.0.0.0/0&#34;</span> &gt;&gt;/etc/ssh/sshd_config
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;AllowUsers myadmin@192.168.0.115&#34;</span> &gt;&gt;/etc/ssh/sshd_config  	<span style="color:#75715e"># 限制用指定IP登录</span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;StrictHostKeyChecking no&#34;</span> &gt;&gt;/etc/ssh/sshd_config  	<span style="color:#75715e"># 关闭首次连接询问 </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 禁止root用户远程登录服务器</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;s/#PermitRootLogin yes/PermitRootLogin no/g&#34;</span> /etc/ssh/sshd_config
</span></span><span style="display:flex;"><span>$ systemctl restart sshd  </span></span></code></pre></div></blockquote>
<hr>
<h3 id="优化系统服务cgroup">优化系统服务<code>Cgroup</code></h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 限制CPU</span>
</span></span><span style="display:flex;"><span>$ mkdir /sys/fs/cgroup/cpu,cpuacct/cgroup_mysql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;30000&#34;</span> &gt;/sys/fs/cgroup/cpu,cpuacct/cgroup_mysql/cpu.cfs_quota_us
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;mysql pid&#34;</span> &gt;/sys/fs/cgroup/cpu,cpuacct/cgroup_mysql/task
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 限制内存， 限制单位为：字节(Bytes)</span>
</span></span><span style="display:flex;"><span>$ mkdir /sys/fs/cgroup/memory/cgroup_mysql
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;1073741824&#34;</span> &gt;/sys/fs/cgroup/memory/cgroup_mysql/memory.limit_in_bytes  	<span style="color:#75715e"># 1G 为：1073741824Bytes(字节)</span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;mysql pid&#34;</span> &gt;/sys/fs/cgroup/memory/cgroup_mysql/task</span></span></code></pre></div></blockquote>
<hr>
<h3 id="优化histsize显示操作时间连接ip以及用户">优化<code>HISTSIZE</code>显示操作时间、连接<code>IP</code>以及用户</h3>
<ul>
<li>
<ol>
<li><a href="https://www.51cto.com/article/639680.html" rel="external" target="_self">谁动了我的主机? 之活用<code>History</code>命令</a></li>
</ol>
</li>
<li>
<ol start="2">
<li><a href="https://ftp.gnu.org/gnu/" rel="external" target="_self">下载<code>GNU</code>软件</a></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 监控登陆过系统的用户、IP地址、操作命令以及操作时间</span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;export HISTTIMEFORMAT=&#34;</span>%F %T <span style="color:#e6db74">`</span>who <span style="color:#ae81ff">\-</span>u am i 2&gt;/dev/null | awk <span style="color:#e6db74">&#39;{print $NF}&#39;</span> | sed <span style="color:#ae81ff">\-</span>e <span style="color:#e6db74">&#39;s/[()]//g&#39;</span><span style="color:#e6db74">`</span> <span style="color:#e6db74">`</span>whoami<span style="color:#e6db74">`</span> <span style="color:#e6db74">&#34;&#34;</span> &gt;&gt;/etc/profile.d/history.sh</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted --><code>Ubuntu</code>安装<code>messages</code><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo apt-get install --reinstall rsyslog
</span></span><span style="display:flex;"><span>$ cat &gt;/etc/rsyslog.d/50-default.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">*.=info;*.=notice;*.=warn;\  	# 31 行左右取消注释
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     auth,authpriv.none;\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     cron,daemon.none;\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     mail,news.none          -/var/log/messages
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>$ sudo service rsyslog restart</span></span></code></pre></div><ul>
<li>3.1 <!-- raw HTML omitted --><code>Ubuntu</code>安装<code>bash</code><!-- raw HTML omitted --></li>
</ul>
<p><a href="#R-image-e5c28887dad385389e810acd635f5834" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/System-Architecture-Planning-Diagram/Snipaste_2023-03-02_18-13-52.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-e5c28887dad385389e810acd635f5834"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/System-Architecture-Planning-Diagram/Snipaste_2023-03-02_18-13-52.png"></a></p>
<p><a href="#R-image-79ecd95dbafe5cda4c8d5bc7448e08e2" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/imgs/master/System-Architecture-Planning-Diagram/Snipaste_2023-03-02_18-15-53.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-79ecd95dbafe5cda4c8d5bc7448e08e2"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/imgs/master/System-Architecture-Planning-Diagram/Snipaste_2023-03-02_18-15-53.png"></a></p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo wget https://ftp.gnu.org/gnu/bash/bash-5.2.tar.gz
</span></span><span style="display:flex;"><span>$ sudo tar zxvf bash-5.2.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改配置文件</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/usr/local/src/bash-5.2/bashhist.c<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">hdrlen = snprintf (loghdr, sizeof(loghdr), &#34;HISTORY: PID=%d UID=%d User=%s &#34;, getpid(), current_user.uid, current_user.user_name, line);  	# 843 行左右添加 User=%s current_user.user_name, line
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;/usr/local/src/bash-5.2/config-top.h<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/* #define SSH_SOURCE_BASHRC */  	# 113 行左右复制一份 去掉注释
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#define SSH_SOURCE_BASHRC
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/* #define SYSLOG_HISTORY */  	# 128 行左右复制一份 去掉注释
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#define SYSLOG_HISTORY
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 配置、编译、安装</span>
</span></span><span style="display:flex;"><span>$ sudo ./configure --prefix<span style="color:#f92672">=</span>/usr/local/bash
</span></span><span style="display:flex;"><span>$ sudo make
</span></span><span style="display:flex;"><span>$ sudo make install
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改用户环境文件</span>
</span></span><span style="display:flex;"><span>$ cat &gt;/etc/passwd<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">user_name:x:1000:1000:user_name:/home/user_name:/usr/local/bash/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="安装配置linux系统的irq均衡工具irqbalance-">安装配置<code>Linux</code>系统的<code>IRQ</code>均衡工具<code>Irqbalance </code></h3>
<ul>
<li>
<ol>
<li>安装配置</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo apt-get update
</span></span><span style="display:flex;"><span>$ sudo apt-get install irqbalance
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo cat &gt;&gt;/etc/default/irqbalance<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ENABLED=&#34;1&#34;  	# ENABLED=1 表示启用
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">BALANCE_INTERVAL=1  	# BALANCE_INTERVAL=1 表示每秒进行一次 IRQ 均衡
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo systemctl restart irqbalance.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 检查是否生效</span>
</span></span><span style="display:flex;"><span>$ cat /proc/interrupts</span></span></code></pre></div></blockquote>
<hr>
<h3 id="关闭透明大页">关闭透明大页</h3>
<ul>
<li>
<ol>
<li>修改<code>grub.conf</code>文件</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 确实是否开启</span>
</span></span><span style="display:flex;"><span>$ cat /sys/kernel/mm/redhat_transparent_hugepage/enabled
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>always<span style="color:#f92672">]</span> madvise never  	<span style="color:#75715e"># [always] 表示开启</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ grep HugePage /proc/meminfo
</span></span><span style="display:flex;"><span>AnonHugePages:    <span style="color:#ae81ff">585728</span> kB  	<span style="color:#75715e"># 不是 0 就代表启动</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改grub.conf文件</span>
</span></span><span style="display:flex;"><span>$ cat &gt;&gt;/etc/grub.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kernel /vmlinuz-2.6.32-431.el6.x86_64 ro root=/dev/mapper/vg_linuxbase-lv_root rd_NO_LUKS LANG=en_US.UTF-8 rd_LVM_LV=vg_linuxbase/lv_root rd_NO_MD rd_LVM_LV=vg_linuxbase/lv_swap SYSFONT=latarcyrheb-sun16 crashkernel=auto  KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM rhgb quiet transparent_hugepage=never  	# 在kernel 行新添参数配置
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 重启主机</span>
</span></span><span style="display:flex;"><span>$ shutdown -Fr now</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li>使用脚本方式</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> test -f /sys/kernel/mm/transparent_hugepage/enabled; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span> echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> test -f /sys/kernel/mm/transparent_hugepage/defrag; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span> echo never &gt; /sys/kernel/mm/transparent_hugepage/defrag
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="调节cpu频率">调节CPU频率</h3>
<ul>
<li>
<ol>
<li>不安装工具方式</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo cat /proc/cpuinfo | sudo grep MHz
</span></span><span style="display:flex;"><span>$ sudo echo performance | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor &gt;/dev/null</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li>使用<code>cpupower</code>工具</li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo apt-get install linux-cpupower -y 或者 apt-get install -y linux-tools-<span style="color:#66d9ef">$(</span>uname -r<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>$ sudo cpupower -c all frequency-set -g performance  	<span style="color:#75715e"># 设置所有CPU为性能模式</span>
</span></span><span style="display:flex;"><span>$ sudo cpupower -c all frequency-set -g powersave  	<span style="color:#75715e"># 设置所有CPU为节能模式</span>
</span></span><span style="display:flex;"><span>$ sudo cpupower -c all frequency-info  	<span style="color:#75715e"># 查看当前所有CPU的信息</span>
</span></span><span style="display:flex;"><span>$ sudo watch -n <span style="color:#ae81ff">1</span> cpupower monitor  	<span style="color:#75715e"># CPU实时频率查看</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="修改系统io调度算法">修改系统<code>I/O</code>调度算法</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo cat /sys/block/sda/queue/scheduler  	<span style="color:#75715e"># sda 磁盘名称 </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>mq-deadline<span style="color:#f92672">]</span> none  	<span style="color:#75715e"># 代表使用得是 [mq-deadline]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 临时修改为：noop 算法</span>
</span></span><span style="display:flex;"><span>$ echo noop &gt;/sys/block/sda/queue/scheduler
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 永久生效</span>
</span></span><span style="display:flex;"><span>$ cp -p /boot/grub/menu.lst /boot/grub/menu.lst-backup  	<span style="color:#75715e"># 提前备份配置文件</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo cat &gt;&gt;/boot/grub/menu.lst<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kernel /vmlinuz-2.6.16.60-0.91.1-smp root=/dev/sysvg/root splash=silent splash=off showopts elevator=noop  	# 行最后添加
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="system_architecture_planning_diagram">System_Architecture_Planning_Diagram</h1>

<h2 id="system-architecture-planning-diagram"><code>System Architecture Planning Diagram</code></h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->在线协同编写系统<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th><a href="https://github.com/phachon/mm-wiki" rel="external" target="_self"><code>MM-wiki</code></a></th>
<th><a href="https://github.com/requarks/wiki" rel="external" target="_self"><code>WiKi.js</code></a></th>
<th><a href="https://www.atlassian.com/zh/software/confluence" rel="external" target="_self"><code>Confluence</code></a></th>
<th><a href="https://github.com/GitbookIO/gitbook" rel="external" target="_self"><code>GitBook</code>多人协作文档</a>、<!-- raw HTML omitted --><a href="https://zhuanlan.zhihu.com/p/108276695" rel="external" target="_self"><code>GitBook</code>安装部署实操手册</a>、<!-- raw HTML omitted --><a href="https://cloud.tencent.com/developer/article/1605621" rel="external" target="_self"><code>CentOS7</code>下部署<code>GitBook</code></a></th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://www.oschina.net/news/204901/mrdoc-0-8-1-released" rel="external" target="_self"><code>MrDoc</code>在线文档系统</a></td>
<td><a href="https://www.mediawiki.org/wiki/MediaWiki" rel="external" target="_self"><code>MediaWiki</code></a></td>
<td><a href="https://github.com/docsifyjs/docsify/" rel="external" target="_self"><code>Docsify</code></a></td>
<td><a href="https://typecho.org/" rel="external" target="_self"><code>Typecho</code></a></td>
</tr>
<tr>
<td><a href="https://www.dokuwiki.org/dokuwiki" rel="external" target="_self"><code>DokuWiki</code></a></td>
<td><a href="https://worktile.com/kb/p/19579" rel="external" target="_self">开源免费的<code>Wiki</code>系统</a></td>
<td><a href="https://swagger.io/" rel="external" target="_self"><code>swagger API</code>接口文档开发</a></td>
<td><a href="https://github.com/mindoc-org/mindoc" rel="external" target="_self"><code>MinDoc</code></a></td>
</tr>
<tr>
<td><a href="https://www.notion.so/pricing" rel="external" target="_self"><code>notion</code></a></td>
<td><a href="https://github.com/lanyulei/fiy" rel="external" target="_self"><code>Go CMDB</code></a></td>
<td><a href="https://www.cnblogs.com/Erik_Xu/p/10092028.html" rel="external" target="_self"><code>Kubernetes</code>-蓝鲸<code>CMDB</code></a></td>
<td><a href="https://learnku.com/articles/45958" rel="external" target="_self">分享<code>10</code>个我常逛的国外技术社区</a>、<a href="https://cloud.tencent.com/developer/news/398171" rel="external" target="_self">11个国外IT技术交流网站汇总</a></td>
</tr>
<tr>
<td><a href="https://www.onlyoffice.com/download-docs.aspx?from=helpcenter#docs-community" rel="external" target="_self"><code>OnlyOffice</code></a></td>
<td><a href="https://www.libreoffice.org/discover/libreoffice/" rel="external" target="_self"><code>LibreOffice</code></a></td>
<td><a href="https://www.openoffice.org/" rel="external" target="_self"><code>Apache OpenOffice</code></a></td>
<td><a href="https://www.freeoffice.com/zh/" rel="external" target="_self"><code>freeoffice</code></a></td>
</tr>
<tr>
<td><a href="https://ngx.hk/" rel="external" target="_self"><code>Ngx</code></a>、<a href="https://www.youtube.com/channel/UCJYkp0cVLaTzk488qnwyPLw" rel="external" target="_self"><code>Youtube</code></a></td>
<td><a href="https://blog.laoda.de/" rel="external" target="_self">我不是咕咕鸽<code>Youtube</code></a></td>
<td><a href="https://www.youtube.com/@deeplearncloud/playlists" rel="external" target="_self">小马技术</a></td>
<td></td>
</tr>
</tbody>
</table>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ docker pull swaggerapi/swagger-editor:v4.9.1
</span></span><span style="display:flex;"><span>$ docker run -d -p 19090:8080 swaggerapi/swagger-editor:v4.9.1</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><a href="https://blog.csdn.net/yanhanhui1/article/details/103134944" rel="external" target="_self">把<code>Kali Linux</code>装进<code>U</code>盘使其可以在<code>UEFI</code>的机器上启动使用</a></li>
</ol>
</li>
<li>
<ol start="3">
<li><!-- raw HTML omitted --><code>CICD Network Architecture</code><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<p><a href="#R-image-4208ec1ed50e5d280e6944f4f4e38fce" class="lightbox-link"><img alt="CICD Network Architecture" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/System-Architecture-Planning-Diagram/CICD-Network-Architecture.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-4208ec1ed50e5d280e6944f4f4e38fce"><img alt="CICD Network Architecture" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/System-Architecture-Planning-Diagram/CICD-Network-Architecture.png"></a></p>
</blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted --><code>Client Online Process</code><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<p><a href="#R-image-179186415a97b2e5b8972cd304db0036" class="lightbox-link"><img alt="Client Online Process" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/System-Architecture-Planning-Diagram/Client-Online-Process.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-179186415a97b2e5b8972cd304db0036"><img alt="Client Online Process" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/System-Architecture-Planning-Diagram/Client-Online-Process.png"></a></p>
</blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted --><code>Initial Architecture Diagram</code><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<p><a href="#R-image-610659a8e4ac0ec2a80dd7b7849dc6b8" class="lightbox-link"><img alt="Initial Architecture Diagram" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/System-Architecture-Planning-Diagram/Initial-Architecture-Diagram.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-610659a8e4ac0ec2a80dd7b7849dc6b8"><img alt="Initial Architecture Diagram" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/System-Architecture-Planning-Diagram/Initial-Architecture-Diagram.png"></a></p>
</blockquote>
<ul>
<li>
<ol start="6">
<li><!-- raw HTML omitted --><code>Jnekins Process</code><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<p><a href="#R-image-e5758460bd5f97ef42dffb8090ca1117" class="lightbox-link"><img alt="Jnekins Process" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/System-Architecture-Planning-Diagram/Jnekins-Process.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-e5758460bd5f97ef42dffb8090ca1117"><img alt="Jnekins Process" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/System-Architecture-Planning-Diagram/Jnekins-Process.png"></a></p>
</blockquote>
<ul>
<li>
<ol start="7">
<li><!-- raw HTML omitted --><code>Jumpserver Master</code><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<p><a href="#R-image-5e87353774ab1dfba3f7be6352947973" class="lightbox-link"><img alt="Jumpserver Master" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/System-Architecture-Planning-Diagram/Jumpserver-Master.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-5e87353774ab1dfba3f7be6352947973"><img alt="Jumpserver Master" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/System-Architecture-Planning-Diagram/Jumpserver-Master.png"></a></p>
</blockquote>
<ul>
<li>
<ol start="8">
<li><!-- raw HTML omitted --><code>K8s Online process</code><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<p><a href="#R-image-2cf4b52d5f9de280145c6800a14cdf39" class="lightbox-link"><img alt="K8s Online process" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/System-Architecture-Planning-Diagram/K8s-Online-process.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-2cf4b52d5f9de280145c6800a14cdf39"><img alt="K8s Online process" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/System-Architecture-Planning-Diagram/K8s-Online-process.png"></a></p>
</blockquote>
<ul>
<li>
<ol start="9">
<li><!-- raw HTML omitted --><code>Lua-Games</code><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<p><a href="#R-image-b66860fd06af5afbcc742f0fd19aebe4" class="lightbox-link"><img alt="Lua-Games" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/System-Architecture-Planning-Diagram/Lua-Games.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-b66860fd06af5afbcc742f0fd19aebe4"><img alt="Lua-Games" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/System-Architecture-Planning-Diagram/Lua-Games.png"></a></p>
</blockquote>
<ul>
<li>
<ol start="10">
<li><!-- raw HTML omitted --><code>Online Process</code><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<p><a href="#R-image-7944310be4374e58077fcad482279b37" class="lightbox-link"><img alt="Online Process" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/System-Architecture-Planning-Diagram/Online-Process.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-7944310be4374e58077fcad482279b37"><img alt="Online Process" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/System-Architecture-Planning-Diagram/Online-Process.png"></a></p>
</blockquote>
<ul>
<li>
<ol start="11">
<li><!-- raw HTML omitted --><code>Server Code Online process</code><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<p><a href="#R-image-22573e3568b38b96630904d290b507a9" class="lightbox-link"><img alt="Server Code Online process" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/System-Architecture-Planning-Diagram/Server-Code-Online-process.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-22573e3568b38b96630904d290b507a9"><img alt="Server Code Online process" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/System-Architecture-Planning-Diagram/Server-Code-Online-process.png"></a></p>
</blockquote>
<ul>
<li>
<ol start="12">
<li><!-- raw HTML omitted --><code>Zabbix Monitor And Alert</code><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<p><a href="#R-image-9795a36d079996b6116afa5821ee0c61" class="lightbox-link"><img alt="Zabbix Monitor And Alert" class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/System-Architecture-Planning-Diagram/Zabbix-Monitor-And-Alert.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-9795a36d079996b6116afa5821ee0c61"><img alt="Zabbix Monitor And Alert" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/System-Architecture-Planning-Diagram/Zabbix-Monitor-And-Alert.png"></a></p>
</blockquote>
<ul>
<li>
<ol start="13">
<li>运维体系</li>
</ol>
</li>
</ul>
<blockquote>
<p><a href="https://www.unixhot.com/page/ops" rel="external" target="_self">运维架构层级/运维角度</a></p>
</blockquote>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="regular_expression">Regular_Expression</h1>

<h2 id="正则表达式">正则表达式</h2>
<blockquote>
<ul>
<li><a href="https://www.runoob.com/regexp/regexp-rule.html" rel="external" target="_self">正则表达式</a></li>
</ul>
</blockquote>
<hr>
<h3 id="运算符优先级">运算符优先级</h3>
<blockquote>
<table>
<thead>
<tr>
<th style="text-align:left">运算符</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>\</code></td>
<td style="text-align:left">转义符</td>
</tr>
<tr>
<td style="text-align:left"><code>()</code>，<code>(?:)</code>，<code>(?=)</code>，<code>[]</code></td>
<td style="text-align:left">圆括号和方括号</td>
</tr>
<tr>
<td style="text-align:left"><code>*</code>，<code>+</code>，<code>?</code>，<code>{n}</code>，<code>{n,}</code>，<code>{n,m}</code></td>
<td style="text-align:left">限定符</td>
</tr>
<tr>
<td style="text-align:left"><code>^</code>，<code>$</code>，<code>\</code>任何元字符、任何字符</td>
<td style="text-align:left">定位点和序列（即：位置和顺序）</td>
</tr>
<tr>
<td style="text-align:left"><code>|</code></td>
<td style="text-align:left">替换，&ldquo;或&quot;操作 字符具有高于替换运算符的优先级，使得<code>m|food</code>匹配<code>m</code>或<code>food</code>。若要匹配<code>mood</code>或<code>food</code>，请使用括号创建子表达式，从而产生<code>(m|f)ood</code>。</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h3 id="非打印字符">非打印字符</h3>
<blockquote>
<table>
<thead>
<tr>
<th style="text-align:left">字符</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>\cx</code></td>
<td style="text-align:left">匹配由<code>x</code>指明的控制字符。例如， <code>\cM</code>匹配一个<code>Control-M</code>或<!-- raw HTML omitted -->回车符<!-- raw HTML omitted -->。<code>x</code>的值必须为<code>A-Z</code>或<code>a-z</code>之一。否则，将<code>c </code>为一个原义的<code>c</code>字符。</td>
</tr>
<tr>
<td style="text-align:left"><code>\f</code></td>
<td style="text-align:left">匹配一个换页符。等价于<code>\x0c</code>和<code>\cL</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>\n</code></td>
<td style="text-align:left">匹配一个换行符。等价于<code>\x0a</code>和<code>\cJ</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>\r</code></td>
<td style="text-align:left">匹配一个回车符。等价于<code>\x0d</code>和<code>\cM</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>\s</code></td>
<td style="text-align:left">匹配任何空白字符，包括空格、制表符、换页符等等。等价于<code>[ \f\n\r\t\v]</code>。注意<code>Unicode</code>正则表达式会匹配全角空格符。</td>
</tr>
<tr>
<td style="text-align:left"><code>\S</code></td>
<td style="text-align:left">匹配任何非空白字符。等价于 <code>[^ \f\n\r\t\v]</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>\t</code></td>
<td style="text-align:left">匹配一个制表符。等价于<code>\x09</code>和<code>\cI</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>\v</code></td>
<td style="text-align:left">匹配一个垂直制表符。等价于<code>\x0b</code>和<code>\cK</code>。</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h3 id="特殊字符">特殊字符</h3>
<blockquote>
<table>
<thead>
<tr>
<th style="text-align:left">特别字符</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>$</code></td>
<td style="text-align:left">匹配输入字符串的结尾位置。如果设置了<code>RegExp</code>对象的<code>Multiline</code>属性，则<code>$</code>也匹配<code>\n</code>或<code>\r</code>。要匹配<code>$</code>字符本身，请使用<code>\$</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>()</code></td>
<td style="text-align:left">标记一个子表达式的开始和结束位置。子表达式可以获取供以后使用。要匹配这些字符，请使用<code>\(</code>和<code>\)</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>*</code></td>
<td style="text-align:left">匹配前面的子表达式零次或多次。要匹配<code>*</code>字符，请使用<code>\*</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>+</code></td>
<td style="text-align:left">匹配前面的子表达式一次或多次。要匹配<code>+</code>字符，请使用<code>\+</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>.</code></td>
<td style="text-align:left">匹配除换行符<code>\n</code>之外的任何单字符。要匹配<code>.</code>，请使用<code>\.</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>[</code></td>
<td style="text-align:left">标记一个中括号表达式的开始。要匹配<code>[</code>，请使用<code>\[</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>?</code></td>
<td style="text-align:left">匹配前面的子表达式零次或一次，或指明一个非贪婪限定符。要匹配<code>?</code>字符，请使用<code>\?</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>\</code></td>
<td style="text-align:left">将下一个字符标记为或特殊字符、或原义字符、或向后引用、或八进制转义符。例如， <code>n</code>匹配字符<code>n</code>。<code>\n</code>匹配换行符。序列<code>\\</code>匹配<code>\</code>，而<code>\(</code>则匹配<code>(</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>^</code></td>
<td style="text-align:left">匹配输入字符串的开始位置，除非在方括号表达式中使用，当该符号在方括号表达式中使用时，表示不接受该方括号表达式中的字符集合。要匹配<code>^</code>字符本身，请使用<code>\^</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>{</code></td>
<td style="text-align:left">标记限定符表达式的开始。要匹配<code>{</code>，请使用<code>\{</code>。</td>
</tr>
<tr>
<td style="text-align:left">`</td>
<td style="text-align:left">`</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h3 id="限定符">限定符</h3>
<blockquote>
<table>
<thead>
<tr>
<th style="text-align:left">字符</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>*</code></td>
<td style="text-align:left">匹配前面的子表达式零次或多次。例如<code>zo\</code>能匹配<code>z</code>以及<code>zoo</code>。<code>*</code>等价于<code>{0,}</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>+</code></td>
<td style="text-align:left">匹配前面的子表达式一次或多次。例如，<code>zo+</code>能匹配<code>zo</code>以及<code>zoo</code>，但不能匹配<code>z</code>。<code>+</code>等价于<code>{1,}</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>?</code></td>
<td style="text-align:left">匹配前面的子表达式零次或一次。例如，<code>do(es)?</code>可以匹配<code>do</code>、 <code>does</code>、<code>doxy</code>中的<code>do</code>和<code>does</code>。<code>?</code> 等价于<code>{0,1}</code></td>
</tr>
<tr>
<td style="text-align:left"><code>{n}</code></td>
<td style="text-align:left"><code>n</code>是一个非负整数。匹配确定的<code>n</code>次。例如，<code>o{2}</code>不能匹配<code>Bob</code>中的<code>o</code>，但是能匹配<code>food</code>中的两个<code>o</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>{n,}</code></td>
<td style="text-align:left"><code>n</code>是一个非负整数。至少匹配<code>n</code>次。例如，<code>o{2,}</code>不能匹配<code>Bob</code>中的<code>o</code>，但能匹配<code>foooood</code>中的所有<code>o</code>。<code>o{1,}</code>等价于<code>o+</code>。<code>o{0,}</code>则等价于<code>o\*</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>{n,m}</code></td>
<td style="text-align:left"><code>m</code>和<code>n</code>均为非负整数，其中<code>n &lt;= m</code>。最少匹配<code>n</code>次且最多匹配<code>m</code>次。例如，<code>o{1,3}</code>将匹配<code>fooooood</code>中的前三个 <code>o</code>。<code>o{0,1}</code>等价于<code>o?</code>。请注意在逗号和两个数之间不能有空格。</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h3 id="定位符">定位符</h3>
<blockquote>
<table>
<thead>
<tr>
<th style="text-align:left">字符</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>^</code></td>
<td style="text-align:left">匹配输入字符串开始的位置。如果设置了<code>RegExp</code>对象的<code>Multiline</code>属性，<code>^</code>还会与<code>\n</code>或<code>\r</code>之后的位置匹配。</td>
</tr>
<tr>
<td style="text-align:left"><code>$</code></td>
<td style="text-align:left">匹配输入字符串结尾的位置。如果设置了<code>RegExp</code>对象的<code>Multiline</code>属性，<code>$</code>还会与<code>\n</code>或<code>\r</code>之前的位置匹配。</td>
</tr>
<tr>
<td style="text-align:left"><code>\b</code></td>
<td style="text-align:left">匹配一个单词边界，即字与空格间的位置。</td>
</tr>
<tr>
<td style="text-align:left"><code>\B</code></td>
<td style="text-align:left">非单词边界匹配。</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h3 id="修饰符">修饰符</h3>
<blockquote>
<table>
<thead>
<tr>
<th style="text-align:left">修饰符</th>
<th style="text-align:left">含义</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>i</code></td>
<td style="text-align:left"><code>ignore</code> - 不区分大小写</td>
<td style="text-align:left">将匹配设置为不区分大小写，搜索时不区分大小写: <code>A</code>和<code>a</code>没有区别。</td>
</tr>
<tr>
<td style="text-align:left"><code>g</code></td>
<td style="text-align:left"><code>global</code> - 全局匹配</td>
<td style="text-align:left">查找所有的匹配项。</td>
</tr>
<tr>
<td style="text-align:left"><code>m</code></td>
<td style="text-align:left"><code>multi line</code> - 多行匹配</td>
<td style="text-align:left">使边界字符<code>^</code>和<code>$</code>匹配每一行的开头和结尾，记住是多行，而不是整个字符串的开头和结尾。</td>
</tr>
<tr>
<td style="text-align:left"><code>s</code></td>
<td style="text-align:left">特殊字符圆点 <strong>.</strong> 中包含换行符 <code>\n</code></td>
<td style="text-align:left">默认情况下的圆点 <strong>.</strong> 是匹配除换行符<code>\n</code>之外的任何字符，加上<code>s</code>修饰符之后, <strong>.</strong> 中包含换行符<code>\n</code>。</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h3 id="元字符">元字符</h3>
<blockquote>
<table>
<thead>
<tr>
<th style="text-align:left">字符</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>\</code></td>
<td style="text-align:left">将下一个字符标记为一个特殊字符、或一个原义字符、或一个 向后引用、或一个八进制转义符。例如，<code>n</code>匹配字符<code>n</code>。<code>\n</code>匹配一个换行符。序列<code>\\</code>匹配 &ldquo;&quot; 而<code>\(</code>则匹配<code>(</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>^</code></td>
<td style="text-align:left">匹配输入字符串的开始位置。如果设置了<code>RegExp</code>对象的<code>Multiline</code>属性，<code>^</code>也匹配<code>\n</code>或<code>\r</code>之后的位置。</td>
</tr>
<tr>
<td style="text-align:left"><code>$</code></td>
<td style="text-align:left">匹配输入字符串的结束位置。如果设置了<code>RegExp</code>对象的<code>Multiline</code>属性，<code>$</code>也匹配<code>\n</code>或<code>\r</code>之前的位置。</td>
</tr>
<tr>
<td style="text-align:left"><code>*</code></td>
<td style="text-align:left">匹配前面的子表达式零次或多次。例如，<code>zo*</code>能匹配<code>z</code>以及<code>zoo</code>。<code>*</code>等价于<code>{0,}</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>+</code></td>
<td style="text-align:left">匹配前面的子表达式一次或多次。例如，<code>zo+</code>能匹配<code>zo</code>以及<code>zoo</code>，但不能匹配<code>z</code>。<code>+</code>等价于<code>{1,}</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>?</code></td>
<td style="text-align:left">匹配前面的子表达式零次或一次。例如，<code>do(es)?</code>可以匹配<code>do</code>或<code>does</code>。? 等价于<code>{0,1}</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>{n}</code></td>
<td style="text-align:left"><code>n</code>是一个非负整数。匹配确定的<code>n</code>次。例如，<code>o{2}</code>不能匹配<code>Bob</code>中的<code>o</code>，但是能匹配<code>food</code>中的两个<code>o</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>{n,}</code></td>
<td style="text-align:left"><code>n</code>是一个非负整数。至少匹配<code>n</code>次。例如，<code>o{2,}</code>不能匹配<code>Bob</code>中的<code>o</code>，但能匹配<code>foooood</code>中的所有<code>o</code>。<code>o{1,}</code>等价于<code>o+</code>。<code>o{0,}</code>则等价于<code>o*</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>{n,m}</code></td>
<td style="text-align:left"><code>m</code>和<code>n</code>均为非负整数，其中<code>n &lt;= m</code>。最少匹配<code>n</code>次且最多匹配<code>m</code>次。例如，<code>o{1,3}</code>将匹配<code>fooooood</code>中的前三个<code>o</code>。<code>o{0,1}</code>等价于<code>o?</code>。请注意在逗号和两个数之间不能有空格。</td>
</tr>
<tr>
<td style="text-align:left"><code>?</code></td>
<td style="text-align:left">当该字符紧跟在任何一个其他限制符<code>(*, +, ?, {n}, {n,}, {n,m})</code>后面时，匹配模式是非贪婪的。非贪婪模式尽可能少的匹配所搜索的字符串，而默认的贪婪模式则尽可能多的匹配所搜索的字符串。例如，对于字符串 <code>oooo</code>，<code>o+?</code>将匹配单个<code>o</code>，而<code>o+</code>将匹配所有<code>o</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>.</code></td>
<td style="text-align:left">匹配除换行符<code>(\n、\r)</code>之外的任何单个字符。要匹配包括<code>\n</code>在内的任何字符，请使用像`(.</td>
</tr>
<tr>
<td style="text-align:left"><code>(pattern)</code></td>
<td style="text-align:left">匹配<code>pattern</code>并获取这一匹配。所获取的匹配可以从产生的<code>Matches</code>集合得到，在<code>VBScript</code>中使用 <code>SubMatches</code>集合，在<code>JScript</code>中则使用<code>$0…$9</code>属性。要匹配圆括号字符，请使用 <code>\(</code>或<code>\)</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>(?:pattern)</code></td>
<td style="text-align:left">匹配<code>pattern</code>但不获取匹配结果，也就是说这是一个非获取匹配，不进行存储供以后使用。这在使用 &ldquo;或&rdquo; 字符`(</td>
</tr>
<tr>
<td style="text-align:left"><code>(?=pattern)</code></td>
<td style="text-align:left">正向肯定预查<code>look ahead positive assert</code>，在任何匹配<code>pattern</code>的字符串开始处匹配查找字符串。这是一个非获取匹配，也就是说，该匹配不需要获取供以后使用。例如，`Windows(?=95</td>
</tr>
<tr>
<td style="text-align:left"><code>(?!pattern)</code></td>
<td style="text-align:left">正向否定预查<code>negative assert</code>，在任何不匹配<code>pattern</code>的字符串开始处匹配查找字符串。这是一个非获取匹配，也就是说，该匹配不需要获取供以后使用。例如`Windows(?!95</td>
</tr>
<tr>
<td style="text-align:left"><code>(?&lt;=pattern)</code></td>
<td style="text-align:left">反向<code>look behind</code>肯定预查，与正向肯定预查类似，只是方向相反。例如，`(?&lt;=95</td>
</tr>
<tr>
<td style="text-align:left"><code>(?&lt;!pattern)</code></td>
<td style="text-align:left">反向否定预查，与正向否定预查类似，只是方向相反。例如`(?&lt;!95</td>
</tr>
<tr>
<td style="text-align:left">`x</td>
<td style="text-align:left">y`</td>
</tr>
<tr>
<td style="text-align:left"><code>[xyz]</code></td>
<td style="text-align:left">字符集合。匹配所包含的任意一个字符。例如，<code>[abc]</code>可以匹配<code>plain</code>中的<code>a</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>[^xyz]</code></td>
<td style="text-align:left">负值字符集合。匹配未包含的任意字符。例如， <code>[^abc]</code>可以匹配<code>plain</code>中的<code>p</code>、<code>l</code>、<code>i</code>、<code>n</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>[a-z]</code></td>
<td style="text-align:left">字符范围。匹配指定范围内的任意字符。例如，<code>[a-z]</code>可以匹配<code>a</code>到<code>z</code>范围内的任意小写字母字符。</td>
</tr>
<tr>
<td style="text-align:left"><code>[^a-z]</code></td>
<td style="text-align:left">负值字符范围。匹配任何不在指定范围内的任意字符。例如，<code>[^a-z]</code>可以匹配任何不在<code>a</code>到<code>z</code>范围内的任意字符。</td>
</tr>
<tr>
<td style="text-align:left"><code>\b</code></td>
<td style="text-align:left">匹配一个单词边界，也就是指单词和空格间的位置。例如， <code>er\b</code>可以匹配<code>never</code>中的<code>er</code>，但不能匹配 <code>verb</code>中的<code>er</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>\B</code></td>
<td style="text-align:left">匹配非单词边界。<code>er\B</code>能匹配<code>verb</code>中的<code>er</code>，但不能匹配<code>never</code>中的<code>er</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>\cx</code></td>
<td style="text-align:left">匹配由<code>x</code>指明的控制字符。例如， <code>\cM</code>匹配一个<code>Control-M</code>或回车符。<code>x</code>的值必须为<code>A-Z</code>或<code>a-z</code>之一。否则，将<code>c</code>视为一个原义的<code>c</code>字符。</td>
</tr>
<tr>
<td style="text-align:left"><code>\d</code></td>
<td style="text-align:left">匹配一个数字字符。等价于<code>[0-9]</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>\D</code></td>
<td style="text-align:left">匹配一个非数字字符。等价于 <code>[^0-9]</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>\f</code></td>
<td style="text-align:left">匹配一个换页符。等价于<code>\x0c</code>和<code>\cL</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>\n</code></td>
<td style="text-align:left">匹配一个换行符。等价于<code>\x0a</code>和<code>\cJ</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>\r</code></td>
<td style="text-align:left">匹配一个回车符。等价于<code>\x0d</code>和<code>\cM</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>\s</code></td>
<td style="text-align:left">匹配任何空白字符，包括空格、制表符、换页符等等。等价于<code>[ \f\n\r\t\v]</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>\S</code></td>
<td style="text-align:left">匹配任何非空白字符。等价于 <code>[^ \f\n\r\t\v]</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>\t</code></td>
<td style="text-align:left">匹配一个制表符。等价于<code>\x09</code>和<code>\cI</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>\v</code></td>
<td style="text-align:left">匹配一个垂直制表符。等价于<code>\x0b</code>和<code>\cK</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>\w</code></td>
<td style="text-align:left">匹配字母、数字、下划线。等价于<code>[A-Za-z0-9_]</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>\W</code></td>
<td style="text-align:left">匹配非字母、数字、下划线。等价于<code>[^A-Za-z0-9_]</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>\xn</code></td>
<td style="text-align:left">匹配<code>n</code>，其中<code>n</code>为十六进制转义值。十六进制转义值必须为确定的两个数字长。例如，<code>\x41</code>匹配 &ldquo;A&rdquo;。<code>\x041</code>则等价于<code>\x04</code>&amp;<code>1</code>。正则表达式中可以使用 ASCII 编码。</td>
</tr>
<tr>
<td style="text-align:left"><code>\num</code></td>
<td style="text-align:left">匹配<code>num</code>，其中<code>num</code>是一个正整数。对所获取的匹配的引用。例如，<code>(.)\1</code>匹配两个连续的相同字符。</td>
</tr>
<tr>
<td style="text-align:left"><code>\n</code></td>
<td style="text-align:left">标识一个八进制转义值或一个向后引用。如果<code>\n</code>之前至少<code>n</code>个获取的子表达式，则<code>n</code>为向后引用。否则，如果<code>n</code>为八进制数字<code>(0-7)</code>，则<code>n</code>为一个八进制转义值。</td>
</tr>
<tr>
<td style="text-align:left"><code>\nm</code></td>
<td style="text-align:left">标识一个八进制转义值或一个向后引用。如果<code>\nm</code>之前至少有<code>nm</code>个获得子表达式，则<code>nm</code>为向后引用。如果<code>\nm</code>之前至少有<code>n</code>个获取，则<code>n</code>为一个后跟文字<code>m</code>的向后引用。如果前面的条件都不满足，若<code>n</code>和<code>m</code>均为八进制数字<code>(0-7)</code>，则<code>\nm</code>将匹配八进制转义值<code>nm</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>\nml</code></td>
<td style="text-align:left">如果<code>n</code>为八进制数字<code>(0-3)</code>，且<code>m</code>和<code>l</code>均为八进制数字<code>(0-7)</code>，则匹配八进制转义值<code>nml</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>\un</code></td>
<td style="text-align:left">匹配<code>n</code>，其中<code>n</code>是一个用四个十六进制数字表示的<code>Unicode</code>字符。例如，<code>\u00A9</code>匹配版权符号<code>(?)</code>。</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="linux_document">Linux_Document</h1>

<h2 id="工具软件">工具、软件</h2>
<blockquote>
<table>
<thead>
<tr>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/kingToolbox/WindTerm" rel="external" target="_self"><code>WindTerm</code></a></td>
<td>适用于<code>DevOps</code>的更快、更好的<code>SSH/Telnet/Serial/Shell/Sftp</code>客户端</td>
</tr>
<tr>
<td><a href="https://www.hostbuf.com/t/988.html" rel="external" target="_self"><code>FinalShell</code></a></td>
<td><code>FinalShell</code>是一体化的的服务器,网络管理软件,不仅是ssh客户端,还是功能强大的开发,运维工具,充分满足开发,运维需求</td>
</tr>
<tr>
<td><a href="https://mobaxterm.mobatek.net/" rel="external" target="_self"><code>MobaXterm</code></a></td>
<td>带有<code>X11</code>服务器、选项卡式<code>SSH</code>客户端、网络工具等的增强型<code>Windows</code>终端</td>
</tr>
<tr>
<td><a href="https://termius.com/pricing" rel="external" target="_self"><code>Termius</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://hyper.is/#installation" rel="external" target="_self"><code>Hyper</code></a></td>
<td><code>Hyper</code>是一个基于<code>Electron</code>的终端，基于<code>HTML/CSS/JS</code>构建，完全可扩展，从命令行安装主题和插件。<code>hyper i hyper-rose-pine</code>、<code>hyper-rose-pine installed successfully!</code></td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h2 id="社区官网文档">社区、官网文档</h2>
<blockquote>
<table>
<thead>
<tr>
<th>名称</th>
<th>描述</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://www.truenas.com/docs/core/gettingstarted/install/" rel="external" target="_self"><code>TrueNAS</code></a></td>
<td>存储</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h2 id="博客">博客</h2>
<blockquote>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="linux_conmmon_commands">Linux_Conmmon_Commands</h1>

<h2 id="linux常用命令总结"><code>Linux</code>常用命令总结</h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->生成密码<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://rockylinux.org/" rel="external" target="_self"><code>Rocky Linux</code></a></td>
<td><code>Centos</code>系统的替代品</td>
</tr>
<tr>
<td><a href="https://www.debian.org/releases/stable/" rel="external" target="_self"><code>Debian Stable</code></a></td>
<td><code>Debian</code>系统镜像</td>
</tr>
<tr>
<td><a href="https://www.alpinelinux.org/" rel="external" target="_self"><code>Alpine Linux</code></a></td>
<td><code>Linux</code>高山系统镜像</td>
</tr>
<tr>
<td><a href="https://wangchujiang.com/linux-command/" rel="external" target="_self"><code>Linux</code></a></td>
<td><code>Linux</code>命令搜索</td>
</tr>
<tr>
<td><a href="https://www.linuxcool.com/" rel="external" target="_self"><code>Linux</code>命令大全(手册)</a></td>
<td><code>Linux</code>命令大全(手册)</td>
</tr>
<tr>
<td><a href="https://www.runoob.com/linux/linux-command-manual.html" rel="external" target="_self">菜鸟<code>Linux</code>命令大全</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://ftp.isc.org/isc/bind9/" rel="external" target="_self"><code>Dig</code>命令</a></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li><!-- raw HTML omitted -->如果复制密钥到客户端后不生效， 优先排查宿主家目录权限<!-- raw HTML omitted --> <code>/home/user</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ openssl rand -base64 <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>$ gpg --gen-random --armor <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">14</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ gzip -d     <span style="color:#75715e"># 解压缩  </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kill -9 <span style="color:#e6db74">`</span>ps -ef |grep xxx|awk <span style="color:#e6db74">&#39;{print $2}&#39;</span> <span style="color:#e6db74">`</span>  	<span style="color:#75715e"># 杀掉服务进程</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 谷歌云普通用户远程登录</span>
</span></span><span style="display:flex;"><span>$ chown -R user:user /home/user
</span></span><span style="display:flex;"><span>$ chmod <span style="color:#ae81ff">600</span> authorized_keys  	<span style="color:#75715e"># 次文件一定属主读写，其他为0 </span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="yum命令"><code>yum</code>命令</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum install -y nodejs  	<span style="color:#75715e"># 安装node</span>
</span></span><span style="display:flex;"><span>$ yum install -y chrony  	<span style="color:#75715e"># 设置时间服务</span>
</span></span><span style="display:flex;"><span>$ yum install -y psmisc  	<span style="color:#75715e"># 安装killall</span>
</span></span><span style="display:flex;"><span>$ yum install -y epel-release  	<span style="color:#75715e"># 安装epel源</span>
</span></span><span style="display:flex;"><span>$ yum whatprovides ifconfig  	<span style="color:#75715e"># 查找某个命令属于那个rpm包  </span>
</span></span><span style="display:flex;"><span>$ yum -y groupinstall <span style="color:#e6db74">&#34;GNOME Desktop&#34;</span>  	<span style="color:#75715e"># Linux命令行安装图形化</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 升级gcc到6.3版本</span>
</span></span><span style="display:flex;"><span>$ yum -y install centos-release-scl
</span></span><span style="display:flex;"><span>$ yum -y install devtoolset-6-gcc devtoolset-6-gcc-c++ devtoolset-6-binutils
</span></span><span style="display:flex;"><span>$ scl enable devtoolset-6 bash
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;source /opt/rh/devtoolset-6/enable&#34;</span> &gt;&gt;/etc/profile
</span></span><span style="display:flex;"><span>$ source /etc/profile
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 高版本node.js需升级gcc、7.3版本</span>
</span></span><span style="display:flex;"><span>$ yum -y install centos-release-scl
</span></span><span style="display:flex;"><span>$ yum -y install devtoolset-7-gcc devtoolset-7-gcc-c++ devtoolset-7-binutils
</span></span><span style="display:flex;"><span>$ scl enable devtoolset-7 bash
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;source /opt/rh/devtoolset-7/enable&#34;</span> &gt;&gt;/etc/profile
</span></span><span style="display:flex;"><span>$ source /etc/profile
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 升级gcc到9版本</span>
</span></span><span style="display:flex;"><span>$ yum -y install devtoolset-9-gcc devtoolset-9-gcc-c++ devtoolset-9-binutils
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;scl enable devtoolset-9 bash&#39;</span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;source /opt/rh/devtoolset-9/enable&#34;</span> &gt;&gt;/etc/profile
</span></span><span style="display:flex;"><span>$ source /etc/profile</span></span></code></pre></div></blockquote>
<hr>
<h3 id="find命令"><code>find</code>命令</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ find . -type f -size +500M  	<span style="color:#75715e"># 查询当前超过500M的文件</span>
</span></span><span style="display:flex;"><span>$ find . -type f -exec ls -l <span style="color:#f92672">{}</span> <span style="color:#ae81ff">\;</span>  	<span style="color:#75715e"># 查询当前文件，并以长格式列出</span>
</span></span><span style="display:flex;"><span>$ find . -type f -exec chmod <span style="color:#ae81ff">644</span> <span style="color:#f92672">{}</span> <span style="color:#ae81ff">\;</span>   <span style="color:#75715e"># f:代表文件，设置644权限</span>
</span></span><span style="display:flex;"><span>$ find . -type d -exec chmod <span style="color:#ae81ff">755</span> <span style="color:#f92672">{}</span> <span style="color:#ae81ff">\;</span>   <span style="color:#75715e"># d代表目录，设置755权限</span>
</span></span><span style="display:flex;"><span>$ find ./* -type f -mtime +15 | xargs ls -lt  	<span style="color:#75715e"># 过滤出来文件按时间排序</span>
</span></span><span style="display:flex;"><span>$ find . -type f -mtime -30 -exec gzip -c ./* &gt;/tmp/nginx-wwwlogs-09-27.gz <span style="color:#f92672">{}</span> <span style="color:#ae81ff">\;</span>  	<span style="color:#75715e"># atime：最后一次访问时间，ctime：最后一次改变权限时间，mtime：最后一次修改时间</span>
</span></span><span style="display:flex;"><span>$ find . -name <span style="color:#e6db74">&#34;*.log&#34;</span> -exec cp <span style="color:#f92672">{}</span> test <span style="color:#ae81ff">\;</span>  	<span style="color:#75715e"># 查找当前目录下以.log结尾文件，</span>
</span></span><span style="display:flex;"><span>													<span style="color:#75715e"># 拷贝并且新文件重新命名为：test</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ find . -name <span style="color:#e6db74">&#34;*.log&#34;</span> -mtime +5 -ok rm <span style="color:#f92672">{}</span> <span style="color:#ae81ff">\;</span>  	<span style="color:#75715e"># 和-exec的作用相同，</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 只不过以一种更为安全的模式来执行该参数所给出的shell命令，</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 在执行每一个命令之前，都会给出提示，让用户来确定是否执行</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ find . -name <span style="color:#e6db74">&#34;*.log&#34;</span> -mtime +6 -exec du -sh <span style="color:#f92672">{}</span> <span style="color:#ae81ff">\;</span>  	<span style="color:#75715e"># 查看当前目录下以.log结尾并超过七天的文件大小</span>
</span></span><span style="display:flex;"><span>$ find /etc -name <span style="color:#e6db74">&#34;passwd*&#34;</span> -exec grep <span style="color:#e6db74">&#34;root&#34;</span> <span style="color:#f92672">{}</span> <span style="color:#ae81ff">\;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查找并且打包</span>
</span></span><span style="display:flex;"><span>$ find /your/directory/path -name <span style="color:#e6db74">&#34;*.tar&#34;</span> -exec tar -xvf <span style="color:#f92672">{}</span> <span style="color:#ae81ff">\;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查找并打包到指定目录</span>
</span></span><span style="display:flex;"><span>$ find /your/directory/path -name <span style="color:#e6db74">&#34;*.tar&#34;</span> -exec tar -xvf <span style="color:#f92672">{}</span> -C /path/to/extracted/directory <span style="color:#ae81ff">\;</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="nodenpm命令"><code>node、npm</code>命令</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum groupinstall <span style="color:#e6db74">&#34;Development Tools&#34;</span> <span style="color:#e6db74">&#34;Development Libraries&#34;</span>
</span></span><span style="display:flex;"><span>$ yum install make automake gcc gcc-c++ kernel-devel
</span></span><span style="display:flex;"><span>$ yum -y install install build-essential
</span></span><span style="display:flex;"><span>$ curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.0/install.sh | bash
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># nvm 使用</span>
</span></span><span style="display:flex;"><span>$ nvm install 18.0.0  	<span style="color:#75715e"># 安装 nodejs 18.0.0</span>
</span></span><span style="display:flex;"><span>$ nvm ls  	<span style="color:#75715e"># 列出已经安装的node版本</span>
</span></span><span style="display:flex;"><span>$ nvm use v12.13.0  	<span style="color:#75715e"># 切换node版本</span>
</span></span><span style="display:flex;"><span>$ nvm alias default v12.13.0  	<span style="color:#75715e"># 指定默认的node版本</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ npm install -g n  	<span style="color:#75715e"># 安装n模块</span>
</span></span><span style="display:flex;"><span>$ n  	<span style="color:#75715e"># 选择版本直接用n命令</span>
</span></span><span style="display:flex;"><span>$ n v10.16.0  	<span style="color:#75715e"># &#34;n&#34;加版本号,用n命令下载所需的版本</span>
</span></span><span style="display:flex;"><span>$ n latest  	<span style="color:#75715e"># 下载最新版</span>
</span></span><span style="display:flex;"><span>$ n rm 版本号  	<span style="color:#75715e"># 删除版本</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># build执行打包命令、如果dist目录存在删除、node_modules目录可选择删除或者保留</span>
</span></span><span style="display:flex;"><span>$ npm install
</span></span><span style="display:flex;"><span>$ npm run build
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装wscat 测试websocket</span>
</span></span><span style="display:flex;"><span>$ npm install -g wscat 
</span></span><span style="display:flex;"><span>$ ./wscat --connect ws://192.168.2.210
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ curl -i <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --header <span style="color:#e6db74">&#34;Upgrade: websocket&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --header <span style="color:#e6db74">&#34;Sec-WebSocket-Key: AQIDBAUGBwgJCgsMDQ4PEA==&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --header <span style="color:#e6db74">&#34;Sec-WebSocket-Version: 13&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --header <span style="color:#e6db74">&#34;Connection: upgrade&#34;</span> <span style="color:#ae81ff">\ </span><span style="color:#75715e">#直接访问后端服务的 Websocket 需要带上该头部</span>
</span></span><span style="display:flex;"><span>http://192.168.1.141 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Build complete.
</span></span><span style="display:flex;"><span>Tip: built files are meant to be served over an HTTP server.
</span></span><span style="display:flex;"><span>Opening index.html over file:// won<span style="color:#960050;background-color:#1e0010">&#39;</span>t work.
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 处理办法、在npm run build 运行完之后，再运行</span>
</span></span><span style="display:flex;"><span>$ cd dist
</span></span><span style="display:flex;"><span>$ npm install -g http-server  	<span style="color:#75715e"># 该命令只需执行一次,安装过之后, 以后就不需要重复安装了.hs</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="后台运行命令">后台运行命令</h3>
<blockquote>
<table>
<thead>
<tr>
<th>名称</th>
<th>使用方式</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>nohup</code></td>
<td><code>$ nohup &amp;</code></td>
<td>使用<code>nohup</code>+ <code>&amp;</code>让服务后台运行</td>
</tr>
<tr>
<td><code>setsid</code></td>
<td><code>$ setsid</code></td>
<td></td>
</tr>
<tr>
<td><code>screen</code></td>
<td><code>$ screen</code></td>
<td><code>screen</code>属于第三方工具需要单独安装</td>
</tr>
</tbody>
</table>
<ul>
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>screen</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install screen  	<span style="color:#75715e"># 安装  </span>
</span></span><span style="display:flex;"><span>$ screen  	<span style="color:#75715e"># 启动  </span>
</span></span><span style="display:flex;"><span>$ screen ls  	<span style="color:#75715e"># 查看  </span>
</span></span><span style="display:flex;"><span>$ screen r 进程号  	<span style="color:#75715e"># 进入程序 </span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->使用：<!-- raw HTML omitted --><code>screen [-opts] [cmd [args]或：screen -r [host.tty]</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 选项：</span>
</span></span><span style="display:flex;"><span>-4  	<span style="color:#75715e"># 仅将主机名解析为IPv4地址。  </span>
</span></span><span style="display:flex;"><span>-6  	<span style="color:#75715e"># 仅将主机名解析为IPv6地址。</span>
</span></span><span style="display:flex;"><span>-a  	<span style="color:#75715e"># 强制所有功能进入每个窗口的termcap。</span>
</span></span><span style="display:flex;"><span>-A  	<span style="color:#75715e"># - [r | R]使所有窗口适应新的显示宽度和高度。</span>
</span></span><span style="display:flex;"><span>-c  	<span style="color:#75715e"># file读取配置文件而不是&#39;.screenrc&#39;。</span>
</span></span><span style="display:flex;"><span>-d  	<span style="color:#75715e"># （-r）分离其他正在运行的屏幕（并在此处重新连接）。</span>
</span></span><span style="display:flex;"><span>-dmS  	<span style="color:#75715e"># name作为守护程序启动：处于分离模式的屏幕会话。</span>
</span></span><span style="display:flex;"><span>-D  	<span style="color:#75715e"># （-r）分离和注销远程（并在此处重新连接）。</span>
</span></span><span style="display:flex;"><span>-D  	<span style="color:#75715e"># -RR执行屏幕会话所需的任何操作。</span>
</span></span><span style="display:flex;"><span>-e  	<span style="color:#75715e"># xy更改命令字符。</span>
</span></span><span style="display:flex;"><span>-f  	<span style="color:#75715e"># 流控制开启，-fn=关闭，-fa=auto。-h lines设置回滚历史记录缓冲区的大小。</span>
</span></span><span style="display:flex;"><span>-i  	<span style="color:#75715e"># 当流量控制打开时，中断输出更快。</span>
</span></span><span style="display:flex;"><span>-l  	<span style="color:#75715e"># 登录模式打开（update /var/run/utmp,-ln = off。</span>
</span></span><span style="display:flex;"><span>-ls  	<span style="color:#75715e"># [匹配]或-list什么都不做，只列出我们的SockDir [在可能的比赛中]。</span>
</span></span><span style="display:flex;"><span>-L  	<span style="color:#75715e"># 打开输出日志记录。</span>
</span></span><span style="display:flex;"><span>-m  	<span style="color:#75715e"># 忽略$ STY变量，创建一个新的屏幕会话。</span>
</span></span><span style="display:flex;"><span>-O  	<span style="color:#75715e"># 选择最佳输出而不是精确的vt100仿真。</span>
</span></span><span style="display:flex;"><span>-p  	<span style="color:#75715e"># window预选指定的窗口（如果存在）。</span>
</span></span><span style="display:flex;"><span>-q  	<span style="color:#75715e"># 安静的启动。如果不成功，则退出非零返回码。</span>
</span></span><span style="display:flex;"><span>-Q  	<span style="color:#75715e"># Commands将响应发送到查询过程的stdout。</span>
</span></span><span style="display:flex;"><span>-r  	<span style="color:#75715e"># [session]重新连接到分离的屏幕进程。</span>
</span></span><span style="display:flex;"><span>-R  	<span style="color:#75715e"># 如果可能重新连接，否则启动新会话。</span>
</span></span><span style="display:flex;"><span>-s  	<span style="color:#75715e"># shell shell执行而不是$ SHELL。</span>
</span></span><span style="display:flex;"><span>-S  	<span style="color:#75715e"># sockname将此会话命名为&lt;pid&gt; .sockname而不是&lt;pid&gt;。&lt;tty&gt;。&lt;host&gt;。</span>
</span></span><span style="display:flex;"><span>-t  	<span style="color:#75715e"># title设置标题。（窗口的名字）。</span>
</span></span><span style="display:flex;"><span>-T  	<span style="color:#75715e"># 术语使用术语作为Windows的$ TERM，而不是“屏幕”。</span>
</span></span><span style="display:flex;"><span>-U  	<span style="color:#75715e"># 告诉屏幕使用UTF-8编码。</span>
</span></span><span style="display:flex;"><span>-v  	<span style="color:#75715e"># 打印“屏幕版本4.01.00devel（GNU）2-May-06”。</span>
</span></span><span style="display:flex;"><span>-wipe  	<span style="color:#75715e"># [match]什么都不做，只是清理SockDir [在可能的比赛中]。</span>
</span></span><span style="display:flex;"><span>-x  	<span style="color:#75715e"># 附加到未分离的屏幕。（多显示模式）。</span>
</span></span><span style="display:flex;"><span>-X  	<span style="color:#75715e"># 在指定的会话中执行&lt;cmd&gt;作为屏幕命令。</span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="系统排查抓包分析命令">系统排查、抓包、分析命令</h3>
<blockquote>
<ul>
<li><a href="https://github.com/esnet/iperf" rel="external" target="_self"><code>iperf</code></a>、</li>
<li><a href="https://www.w3cschool.cn/linuxc/linuxc-ujgo3lgk.html" rel="external" target="_self"><code>Linux</code>命令、工具</a></li>
<li><a href="https://juejin.cn/post/6994232948618690591" rel="external" target="_self"><code>wireshark</code>的命令行抓包工具<code>tshark</code></a>、<a href="https://www.cnblogs.com/liun1994/p/6142505.html" rel="external" target="_self"><code>Wireshark</code>命令行工具<code>tshark</code>详解(含例子)-01</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ss  	<span style="color:#75715e"># 连接查看工具</span>
</span></span><span style="display:flex;"><span>$ iperf3  	<span style="color:#75715e"># 网络性能测试工具</span>
</span></span><span style="display:flex;"><span>$ ethtool  	<span style="color:#75715e"># 诊断工具</span>
</span></span><span style="display:flex;"><span>$ tcpdump  	<span style="color:#75715e"># 抓包工具</span>
</span></span><span style="display:flex;"><span>$ tracert  	<span style="color:#75715e"># 追踪路由命令</span>
</span></span><span style="display:flex;"><span>$ nethogs  	<span style="color:#75715e"># 按进程查看流量占用</span>
</span></span><span style="display:flex;"><span>$ iptraf  	<span style="color:#75715e"># 按连接/端口查看流量</span>
</span></span><span style="display:flex;"><span>$ ifstat  	<span style="color:#75715e"># 按设备查看流量</span>
</span></span><span style="display:flex;"><span>$ pidof nginx  	<span style="color:#75715e"># 获取服务运行的pid</span>
</span></span><span style="display:flex;"><span>$ strace -p pid  	<span style="color:#75715e"># 查看进程工作</span>
</span></span><span style="display:flex;"><span>$ tcptraceroute  	<span style="color:#75715e"># 路由追踪工具</span>
</span></span><span style="display:flex;"><span>$ ifup/ifdown  	<span style="color:#75715e"># 启动和停止网卡,可以接网卡名：ifup eth0。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 其它排查命令: dstat, slurm, nload, bmon</span>
</span></span><span style="display:flex;"><span>$ sudo opensnoop-bpfcc  	<span style="color:#75715e"># 安装目录在：/usr/sbin/</span>
</span></span><span style="display:flex;"><span>$ wireshark  	<span style="color:#75715e"># 命令行抓包工具</span></span></span></code></pre></div><ul>
<li><a href="https://github.com/iovisor/bcc/blob/master/INSTALL.md" rel="external" target="_self"><code>Installing BCC</code></a></li>
<li><a href="https://github.com/iovisor/bcc" rel="external" target="_self"><code>BPF Compiler Collection (BCC)</code></a></li>
<li><code>TCP</code><strong>传输控制协议</strong></li>
</ul>
<blockquote>
<ul>
<li>
<p><code>SYN</code><strong>同步</strong>包，用于建立连接</p>
<p><strong>功能</strong>: 用于建立连接。<code>SYN</code>包是<code>TCP</code>三次握手过程中的第一步</p>
<p><strong>使用场景</strong>: 客户端向服务器发送<code>SYN</code>包以开始连接的建立</p>
</li>
<li>
<p><code>SYN-ACK</code><strong>同步-确认</strong>包，响应 <code>SYN</code>包以确认建立连接</p>
<p><strong>功能</strong>: 用于响应<code>SYN</code>包，并确认接收到的<code>SYN</code>包，表示服务器准备建立连接</p>
<p><strong>使用场景</strong>: 服务器向客户端回复<code>SYN-ACK</code>包，作为三次握手的第二步</p>
</li>
<li>
<p><code>ACK</code><strong>确认</strong>包，用于确认数据包的接收</p>
<p><strong>功能</strong>: 用于确认接收到的数据包。<code>ACK</code>包是<code>TCP</code>协议中的确认机制</p>
<p><strong>使用场景</strong>: 客户端收到服务器的<code>SYN-ACK</code>包后，发送<code>ACK</code>包以完成三次握手，建立连接</p>
</li>
<li>
<p><code>FIN</code><strong>结束</strong>包，用于结束连接</p>
<p><strong>功能</strong>: 用于结束连接。<code>FIN</code>包是 TCP`四次挥手中的一部分</p>
<p><strong>使用场景</strong>: 连接的一方发送<code>FIN</code>包，表示该端已经完成数据发送并希望关闭连接</p>
</li>
<li>
<p><code>RST</code><strong>重置</strong>包，用于重置连接</p>
<p><strong>功能</strong>: 用于强制重置连接，立即终止连接。<code>RST</code>包用于通知对方连接发生异常，需要立即关闭</p>
<p><strong>使用场景</strong>: 当发生错误或不需要的连接时使用，如端口未开放、应用异常等</p>
</li>
<li>
<p><code>PSH</code><strong>推送</strong>包，用于推送数据，要求接收方立即处理</p>
<p><strong>功能</strong>: 用于通知接收方立即处理数据，而不是等待缓冲区填满</p>
<p><strong>使用场景</strong>: 发送方希望接收方立即处理数据，通常用于实时应用</p>
</li>
<li>
<p><code>URG</code><strong>紧急</strong>包，指示紧急数据</p>
<p><strong>功能</strong>: 指示数据中的紧急信息，并通知接收方优先处理这些数据</p>
<p><strong>使用场景</strong>: 数据包中包含紧急数据，要求接收方立即处理</p>
</li>
</ul>
</blockquote>
<ul>
<li><code>UDP</code><strong>用户数据报协议</strong></li>
</ul>
<blockquote>
<ul>
<li>
<p>数据报<code>Datagram</code></p>
<p><strong>功能</strong>: 这是<code>UDP</code>协议中最基本的包类型，包含了数据的完整内容和必要的头部信息</p>
<p><strong>组成部分</strong>:</p>
<ul>
<li><strong>头部</strong>:
<ul>
<li><strong>源端口号</strong>（16 位）</li>
<li><strong>目的端口号</strong>（16 位）</li>
<li><strong>长度</strong>（16 位）：包括头部和数据的总长度</li>
<li><strong>校验和</strong>（16 位）：用于检测数据包在传输过程中是否出现错误</li>
</ul>
</li>
<li><strong>数据</strong>: 实际传输的数据内容</li>
</ul>
</li>
<li>
<p>空数据报<code>Empty Datagram</code></p>
<p><strong>功能</strong>: 一个没有数据负载的 UDP 数据报，主要用于保持连接的状态或作为信号量。</p>
<p><strong>场景</strong>: 例如，心跳检测或网络测试等场景中，可能会使用空数据报来保持连接或检查网络状态</p>
</li>
<li>
<p><code>UDP</code>协议特点</p>
<p><strong>无连接</strong>: <code>UDP</code>不建立连接，每个数据报都是独立的</p>
<p><strong>无序</strong>: 数据包的顺序不保证，因此接收方可能收到乱序的数据</p>
<p><strong>无可靠性</strong>: <code>UDP</code>不保证数据包的交付，也没有重传机制。如果数据包在传输过程中丢失，<code>UDP</code>不会进行重发</p>
<p><strong>无流量控制</strong>: <code>UDP</code>不控制数据流量，也不进行流量调节</p>
</li>
<li>
<p><code>UDP</code>数据报的基本结构</p>
<p><strong>头部</strong><code>Header</code>:</p>
<ul>
<li><strong>源端口号</strong>: 表示发送方的端口</li>
<li><strong>目的端口号</strong>: 表示接收方的端口</li>
<li><strong>长度</strong>: 包括头部和数据的总长度</li>
<li><strong>校验和</strong>: 用于检查数据的完整性</li>
</ul>
</li>
<li>
<p><strong>数据</strong><code>Data</code>:</p>
<ul>
<li>实际传输的应用数据</li>
</ul>
</li>
</ul>
</blockquote>
<p><a href="#R-image-2ca108a0151145c5b19ed67d433f96de" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/System-Architecture-Planning-Diagram/bcc_tracing_tools_2019.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-2ca108a0151145c5b19ed67d433f96de"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="https://raw.githubusercontent.com/usermice/images/master/System-Architecture-Planning-Diagram/bcc_tracing_tools_2019.png"></a></p>
</blockquote>
<hr>
<h3 id="快捷键">快捷键</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->删除快捷键<!-- raw HTML omitted --></li>
</ul>
<table>
<thead>
<tr>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ctrl + d</code></td>
<td>删除光标所在位置上的字符相当于<code>VIM</code>里<code>x</code>或者<code>dl </code></td>
</tr>
<tr>
<td><code>ctrl + h</code></td>
<td>删除光标所在位置前的字符相当于<code>VIM</code>里<code>hx</code>或者<code>dh</code></td>
</tr>
<tr>
<td><code>ctrl + k </code></td>
<td>删除光标后面所有字符相当于<code>VIM</code>里<code>d shift+$</code></td>
</tr>
<tr>
<td><code>ctrl + u </code></td>
<td>删除光标前面所有字符相当于<code>VIM</code>里<code>d shift+^ </code></td>
</tr>
<tr>
<td><code>ctrl + w</code></td>
<td>删除光标前一个单词相当于<code>VIM</code>里<code>db</code></td>
</tr>
<tr>
<td><code>ctrl + y </code></td>
<td>恢复<code>ctrl+u</code>上次执行时删除的字符</td>
</tr>
<tr>
<td><code>ctrl + ?</code></td>
<td>撤消前一次输入</td>
</tr>
<tr>
<td><code>alt + r</code></td>
<td>撤消前一次动作</td>
</tr>
<tr>
<td><code>alt + d</code></td>
<td>删除光标所在位置的后单词</td>
</tr>
</tbody>
</table>
<ul>
<li><!-- raw HTML omitted -->移动快捷键<!-- raw HTML omitted --></li>
</ul>
<table>
<thead>
<tr>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ctrl + a</code></td>
<td>将光标移动到命令行开头相当于<code>VIM</code>里<code>shift+^</code></td>
</tr>
<tr>
<td><code>ctrl + e</code></td>
<td>将光标移动到命令行结尾处相当于<code>VIM</code>里<code>shift+$</code></td>
</tr>
<tr>
<td><code>ctrl + f</code></td>
<td>光标向后移动一个字符相当于<code>VIM</code>里<code>l</code></td>
</tr>
<tr>
<td><code>ctrl + b</code></td>
<td>光标向前移动一个字符相当于<code>VIM</code>里<code>h</code></td>
</tr>
<tr>
<td><code>ctrl + 方向键左键</code></td>
<td>光标移动到前一个单词开头</td>
</tr>
<tr>
<td><code>ctrl + 方向键右键</code></td>
<td>光标移动到后一个单词结尾</td>
</tr>
<tr>
<td><code>ctrl + x</code></td>
<td>在上次光标所在字符和当前光标所在字符之间跳转</td>
</tr>
<tr>
<td><code>alt + f</code></td>
<td>跳到光标所在位置单词尾部</td>
</tr>
</tbody>
</table>
<ul>
<li><!-- raw HTML omitted -->替换快捷键<!-- raw HTML omitted --></li>
</ul>
<table>
<thead>
<tr>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ctrl + t</code></td>
<td>将光标当前字符与前面一个字符替换</td>
</tr>
<tr>
<td><code>alt + t</code></td>
<td>交换两个光标当前所处位置单词和光标前一个单词</td>
</tr>
<tr>
<td><code>alt + u</code></td>
<td>把光标当前位置单词变为大写</td>
</tr>
<tr>
<td><code>alt + l</code></td>
<td>把光标当前位置单词变为小写</td>
</tr>
<tr>
<td><code>alt + c</code></td>
<td>把光标当前位置单词头一个字母变为大写</td>
</tr>
<tr>
<td><code>^oldstr^newstr</code></td>
<td>替换前一次命令中字符串历史命令编辑</td>
</tr>
<tr>
<td><code>ctrl + p</code></td>
<td>返回上一次输入命令字符</td>
</tr>
<tr>
<td><code>ctrl + r</code></td>
<td>输入单词搜索历史命令</td>
</tr>
<tr>
<td><code>alt + p</code></td>
<td>输入字符查找与字符相接近的历史命令</td>
</tr>
<tr>
<td><code>alt + &gt;</code></td>
<td>返回上一次执行命令</td>
</tr>
</tbody>
</table>
<ul>
<li><!-- raw HTML omitted -->其它操作<!-- raw HTML omitted --></li>
</ul>
<table>
<thead>
<tr>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ctrl + c</code></td>
<td>另起一行</td>
</tr>
<tr>
<td><code>ctrl + r</code></td>
<td>输入单词搜索历史命令</td>
</tr>
<tr>
<td><code>ctrl + s</code></td>
<td>锁住终端</td>
</tr>
<tr>
<td><code>ctrl + q</code></td>
<td>解锁终端</td>
</tr>
<tr>
<td><code>ctrl + l</code></td>
<td>清屏相当于命令<code>clear</code></td>
</tr>
<tr>
<td><code>ctrl + c</code></td>
<td>另起一行</td>
</tr>
<tr>
<td><code>ctrl + i</code></td>
<td>类似<code>TAB</code>健补全功能</td>
</tr>
<tr>
<td><code>ctrl + o</code></td>
<td>重复执行命令</td>
</tr>
<tr>
<td><code>alt + 数字键</code></td>
<td>操作</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h3 id="systemctl命令"><code>systemctl</code>命令</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl list-unit-files  	<span style="color:#75715e"># 列出所有服务状态</span>
</span></span><span style="display:flex;"><span>$ systemctl list-dependencies     <span style="color:#75715e"># 列出所有服务以及依赖状态</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ systemctl list-unit-files --type<span style="color:#f92672">=</span>service|grep enabled   <span style="color:#75715e"># 查看开启的服务</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="安装kvmvnc">安装<code>KVM</code>、<code>VNC</code></h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>KVM</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install virt-manager
</span></span><span style="display:flex;"><span>$ virsh list --all
</span></span><span style="display:flex;"><span>$ virsh start server_15
</span></span><span style="display:flex;"><span>$ virsh autostart server_15  	<span style="color:#75715e"># 开机自启</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 检查在/etc/libvirt/qemu/autostart/下会生成一个（虚拟机名.xml）文件</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>vnc</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install vnc*
</span></span><span style="display:flex;"><span>$ vncserver
</span></span><span style="display:flex;"><span>$ netstat -nuptl
</span></span><span style="display:flex;"><span>$ firewall-cmd --add-port<span style="color:#f92672">=</span>5905/tcp --permanent
</span></span><span style="display:flex;"><span>$ firewall-cmd --reload
</span></span><span style="display:flex;"><span>软件包 tigervnc-server-1.8.0-13.el7.x86_64 已安装并且是最新版本
</span></span><span style="display:flex;"><span>软件包 tigervnc-1.8.0-13.el7.x86_64 已安装并且是最新版本
</span></span><span style="display:flex;"><span>软件包 tigervnc-server-module-1.8.0-13.el7.x86_64 已安装并且是最新版本</span></span></code></pre></div></blockquote>
<hr>
<h3 id="其他命令">其他命令</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->创建、删除用户以及用户组命令<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ useradd  	<span style="color:#75715e"># 添加用户语法：useradd 用户名,例子:useradd oldboy</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e"># -u:指定uid，-g:添加主组，-G:添加用户附属组，</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e"># -s:指定登录的shell，-e:指定过期时间，-M:不创建家目录，</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e"># -D:修改/etc/default/useradd参数，一般用 vi 直接编辑。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ usermod  	<span style="color:#75715e"># -d:指定就改目录,-g:改主组,-G:附加组</span>
</span></span><span style="display:flex;"><span>$ chage  	<span style="color:#75715e"># 设置或修改用户密码有效期限,-e:修改密码文件,-l:查看密码有效期</span>
</span></span><span style="display:flex;"><span>$ userdel  	<span style="color:#75715e"># 删除用户,-r:删除家目录</span>
</span></span><span style="display:flex;"><span>$ groups  	<span style="color:#75715e"># 查看用户属组</span>
</span></span><span style="display:flex;"><span>$ groupadd  	<span style="color:#75715e"># 添加组group</span>
</span></span><span style="display:flex;"><span>$ groupdel  	<span style="color:#75715e"># 删除组</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->创建、修改密码<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ passwd  	<span style="color:#75715e"># 为用户设置或修改密码,例子:passwd oldboy 为oldboy设置修改密码,直接passwd是当前用户修改密码。</span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;123456&#34;</span>|passwd --stdin username  	<span style="color:#75715e"># 非交互式更改密码，一般用于脚本使用</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->权限、更改、授予操作<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ su  	<span style="color:#75715e"># 切换用户身份 - 加载环境变量 -c以指定用户身份执行任务</span>
</span></span><span style="display:flex;"><span>$ sudo  	<span style="color:#75715e"># 可以让普通用户拥有root权限去执行命令,sudo配置文件/etc/sudoers</span>
</span></span><span style="display:flex;"><span>$ visudo  	<span style="color:#75715e"># 通过visudo编辑/etc/sudoers,可以去检查配置文件的语法。</span>
</span></span><span style="display:flex;"><span>$ alias  	<span style="color:#75715e"># 查看和设置别名,例子:查看别名直接输入alias,设置别名:alias cp=&#39;cp -i&#39;</span>
</span></span><span style="display:flex;"><span>$ unalias  	<span style="color:#75715e"># 取消别名 unalias cp</span>
</span></span><span style="display:flex;"><span>$ chmod  	<span style="color:#75715e"># 更改及设置文件对应权限</span>
</span></span><span style="display:flex;"><span>$ chown  	<span style="color:#75715e"># 更改及设置文件对应的用户和组</span>
</span></span><span style="display:flex;"><span>$ last  	<span style="color:#75715e"># 显示用户登录信息， /var/log/wtmp数据文件</span>
</span></span><span style="display:flex;"><span>$ lastlog  	<span style="color:#75715e"># 所有用户最近登录的情况</span>
</span></span><span style="display:flex;"><span>$ umask  	<span style="color:#75715e"># 控制文件默认权限</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->查看、查找命令<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><a href="https://segmentfault.com/a/1190000041912631" rel="external" target="_self"><code>jq</code>命令用法总结</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ id  	<span style="color:#75715e"># 查看用户信息和组信息、</span>
</span></span><span style="display:flex;"><span>$ w  	<span style="color:#75715e"># 显示登录信息 及操作信息</span>
</span></span><span style="display:flex;"><span>$ who  	<span style="color:#75715e"># 显示谁登录</span>
</span></span><span style="display:flex;"><span>$ ps  	<span style="color:#75715e"># 查找启动的服务</span>
</span></span><span style="display:flex;"><span>$ cd  	<span style="color:#75715e"># 切换目录，例子:cd /etc</span>
</span></span><span style="display:flex;"><span>$ pwd  	<span style="color:#75715e"># print work directory打印工作目录(显示当前所在路径)</span>
</span></span><span style="display:flex;"><span>$ cat  	<span style="color:#75715e"># 查看文件内容 例子:cat oldboy.txt,-n:显示行号</span>
</span></span><span style="display:flex;"><span>$ wc  	<span style="color:#75715e"># 显示,-l(lines)总行数，-L:最大行的长度。</span>
</span></span><span style="display:flex;"><span>$ nl  	<span style="color:#75715e"># nl - number lines显示行号</span>
</span></span><span style="display:flex;"><span>$ jq  	<span style="color:#75715e"># 轻量级命令行JSON处理器，-r：去除字符串引号，&#34;,&#34;：逗号执行多个参数，cat text.jsonl | jq -r &#39;.status&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ls  	<span style="color:#75715e"># list(列表)列表目录文件例子：ls /，列出根目录下所有文件、目录</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e"># -a(all)显示所有文件(包括隐藏文件)，默认不显示以&#34;.&#34;开头的隐藏文件</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e"># -l(long)长格式，-d(directorys)查看目录，-t:按修改时间排序，-r:反转排序(倒序)，</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e"># -p:给目录结尾加斜线，-F:给不同文件结尾加不同标识，-i:打印文件的索引号</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e"># --color=auto:显示颜色，-h:人类可读,--time-style=long-iso</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ iotop -oP  	<span style="color:#75715e"># 时时查看磁盘IO情况</span>
</span></span><span style="display:flex;"><span>$ pgrep  	<span style="color:#75715e"># 以名称为依据从运行进程队列中查找进程，并显示查找到的进程id，例如：pgrep mysqld</span>
</span></span><span style="display:flex;"><span>$ date +%s  	<span style="color:#75715e"># 获取时间戳</span>
</span></span><span style="display:flex;"><span>$ file  	<span style="color:#75715e"># 查看文件的类型</span>
</span></span><span style="display:flex;"><span>$ stat  	<span style="color:#75715e"># 显示文件和文件系统状态(查看文件属性)			</span>
</span></span><span style="display:flex;"><span>$ head  	<span style="color:#75715e"># 头，头部读取文件的前n行,默认前10行,-n数字,习惯-5,忽略-n。</span>
</span></span><span style="display:flex;"><span>$ tail  	<span style="color:#75715e"># 尾，尾巴输出文件的后n行,默认后10行,-n数字，习惯-5,忽略-n。</span>
</span></span><span style="display:flex;"><span>$ less  	<span style="color:#75715e"># 和more相反回车一次一行，空格向下一次一屏，按b可以一次回退一屏。</span>
</span></span><span style="display:flex;"><span>$ more  	<span style="color:#75715e"># 按页一次一屏。回车一次一行，空格向下一次一屏。不能回退。</span>
</span></span><span style="display:flex;"><span>$ history  	<span style="color:#75715e"># 查看及清理历史记录-c清空所有,-d删除指定历史记录</span>
</span></span><span style="display:flex;"><span>$ tree  	<span style="color:#75715e"># 大树的意思，显示目录树,-L layer层数,-d显示目录</span>
</span></span><span style="display:flex;"><span>$ xargs  	<span style="color:#75715e"># 从标注你输入获取内容创建和执行命令-n数字,分组</span>
</span></span><span style="display:flex;"><span>$ which  	<span style="color:#75715e"># 查看二进制命令所在路径(从PATH变量所在的路劲查找)</span>
</span></span><span style="display:flex;"><span>$ whereis  	<span style="color:#75715e"># 查找文件的帮助、源代码，-b:二进制54、</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e"># locate find files by name 只能查updatedb库里内容，</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e"># locate从/var/lib/mlocate/mlocate.db查找目录。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ find  	<span style="color:#75715e"># -name 按名称查找，</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e"># -type 按类型查找，</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e"># f(file)文件，d(directory)目录，c(character)字符，</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e"># b(block)块设备，s(socket)，l(link)链接，</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e"># -mtime 按时间查找，+7:7天以前，-7最近7天，</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e"># -mtime -ctime -atime！取反，</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e"># -a:and并且，-o:or 或者，-maxdepth查找深度，－perm：按权限查找</span>
</span></span><span style="display:flex;"><span>$ netstat -lnutp -a
</span></span><span style="display:flex;"><span>$ lsof list open file</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->关机、重启命令<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ init  	<span style="color:#75715e"># 按后面对应的数字切换运行级别，例如:init 6重启服务器</span>
</span></span><span style="display:flex;"><span>$ reboot  	<span style="color:#75715e"># 等同于：init 6，以及：shutdown -r now：立即重启</span>
</span></span><span style="display:flex;"><span>$ poweroff  	<span style="color:#75715e"># 关机</span>
</span></span><span style="display:flex;"><span>$ runlevel  	<span style="color:#75715e"># 查看当前系统运行级别</span>
</span></span><span style="display:flex;"><span>$ shutdown  	<span style="color:#75715e"># (halt、init 0)关机，shutdown -h now：立即关机，</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e"># -r：代表重启，可按需要定时重启，</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e"># -h：代表关机，可按需要定时关机。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ chkconfig  	<span style="color:#75715e"># 设置服务开机自启动命令, --list:查看自动服务，--level levels</span>
</span></span><span style="display:flex;"><span>$ chkconfig --list  	<span style="color:#75715e"># 列出所有服务开机在那个运行级别情况下启动或关闭</span>
</span></span><span style="display:flex;"><span>$ chkconfig --list network  	<span style="color:#75715e"># 查看指定服务在运行级别下是否自启或关闭</span>
</span></span><span style="display:flex;"><span>$ chkconfig --level levels sshd off<span style="color:#f92672">[</span>on<span style="color:#f92672">]</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->查看系统命令<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ dmesg  	<span style="color:#75715e"># 命令用于显示开机信息</span>
</span></span><span style="display:flex;"><span>$ uname  	<span style="color:#75715e"># 打印系统信息,-m32or64,-r内核版本,-a(all),-n(显示主机名)hostname 命令</span>
</span></span><span style="display:flex;"><span>$ hostname  	<span style="color:#75715e"># 显示和设置主机名默认是显示主机名，设置主机名可以 hostname 名字(临时生效)</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->创建、修改文件命令<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ vi  	<span style="color:#75715e"># 编辑器，例子：vi oldboy.txt</span>
</span></span><span style="display:flex;"><span>$ vim  	<span style="color:#75715e"># 复杂编辑器，功能复杂,高亮，写shell/python脚本用</span>
</span></span><span style="display:flex;"><span>$ mv  	<span style="color:#75715e"># move 移动文件或目录</span>
</span></span><span style="display:flex;"><span>$ cp  	<span style="color:#75715e"># copy拷贝文件或目录，默认不能拷贝目录，</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># -r:递归，用于复制目录。-a:相当于-pdr，</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># -p:连同档案的属性一起复制过去，而非使用默认属性。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ rm  	<span style="color:#75715e"># remove 删除目录和文件，-f(force)强制，-r(recursive)递归、用于删除多级目录，</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># 删除命令要慎用，非常危险，删除前一定要先备份一份。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ touch  	<span style="color:#75715e"># 创建文件或更新文件的时间戳，如果文件不存在创建新文件，</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e"># 如果存在改变文件的访问时间atime等时间戳信息。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ echo  	<span style="color:#75715e"># 打印输出内容，配合 &#34;&gt;&#34; 或 &#34;&gt;&gt;&#34; 可以为文件覆盖及追加内容，</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e"># 还有一个较复杂不常用的类似命令printf。-n:不换行输出,-e:可以一起使用：-e &#34;\n&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ mkdir  	<span style="color:#75715e"># make directorys 创建目录，例子：mkdir /opt/data 在/opt目录下创建data目录，</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e"># -p：递归创建目录、mkdir -p /opt/{data/conf,logs}。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ rsync -avz --exclude<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;*.out&#39;</span> --delete </span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->磁盘命令<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ du  	<span style="color:#75715e"># 查看文件和目录大小,-sh</span>
</span></span><span style="display:flex;"><span>$ df  	<span style="color:#75715e"># 查看磁盘信息：-i、-h、-T文件类型</span>
</span></span><span style="display:flex;"><span>$ dd  	<span style="color:#75715e"># 转换或者复制文件</span>
</span></span><span style="display:flex;"><span>$ fsck  	<span style="color:#75715e"># 磁盘检查</span>
</span></span><span style="display:flex;"><span>$ fdisk  	<span style="color:#75715e"># 磁盘分区工具小于2T</span>
</span></span><span style="display:flex;"><span>$ tune2fs  	<span style="color:#75715e"># 修改文件系统信息</span>
</span></span><span style="display:flex;"><span>$ megacli  	<span style="color:#75715e"># 查看raid信息</span>
</span></span><span style="display:flex;"><span>$ mount  	<span style="color:#75715e"># -t type -o 选项</span>
</span></span><span style="display:flex;"><span>$ umount  	<span style="color:#75715e"># 卸载，强制卸载：-lF</span>
</span></span><span style="display:flex;"><span>$ parted  	<span style="color:#75715e"># 分区工具（常用于2T的文件系统）</span>
</span></span><span style="display:flex;"><span>$ mkswap  	<span style="color:#75715e"># 格式化swap分区</span>
</span></span><span style="display:flex;"><span>$ dumpe2fs  	<span style="color:#75715e"># 查看ext文件系统信息</span>
</span></span><span style="display:flex;"><span>$ dumper2fs  	<span style="color:#75715e"># 查看文件系统内部信息(元数据)</span>
</span></span><span style="display:flex;"><span>$ ipmitools  	<span style="color:#75715e"># 查看硬件系统工具</span>
</span></span><span style="display:flex;"><span>$ resize2fs  	<span style="color:#75715e"># 调整文件系统大小（LVM drbd）</span>
</span></span><span style="display:flex;"><span>$ partprobe  	<span style="color:#75715e"># 把分区表的修改变化通知内核</span>
</span></span><span style="display:flex;"><span>$ mkfs.ext4  	<span style="color:#75715e"># (mkfs -t ext4 )格式化 -b block -I inode</span>
</span></span><span style="display:flex;"><span>$ swapon/swapoff  	<span style="color:#75715e"># 使用swap分区，例如swapon /dev/sdb1</span></span></span></code></pre></div><ul>
<li><code>Linux</code><!-- raw HTML omitted -->三剑客<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><a href="http://blog.51yip.com/shell/985.html/comment-page-1#comment-25486" rel="external" target="_self"><code>awk</code>是命令还是编程语言</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ tr  	<span style="color:#75715e"># 替换translate or delete characters(逐个字符替换)</span>
</span></span><span style="display:flex;"><span>$ seq  	<span style="color:#75715e"># sequence序列 -s指定分隔符,seq -s&#34; &#34; -f&#34;str%03g&#34; 9 11 str009 str010 str011</span>
</span></span><span style="display:flex;"><span>$ sed  	<span style="color:#75715e"># stream editorlinux三剑客老二，流编辑器，实现对文件的增删改替换查，</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># 参数：-n:取消默认输出，-i:修改文件内容，-e:允许多项编辑功能，-p:打印，</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># s与g联合使用时,表示对当前行全局匹配替换，s:常说的查找并替换,用一个字符串替换成另一个</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># \：使用转义符</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># sed -i s#oldboy#oldgirl#g a.txt #:是分隔符，可以用/@等替换。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sed -n  <span style="color:#e6db74">&#39;/10\/Sep\/2022:20:00:00/,/10\/Sep\/2022:21:00/p&#39;</span> app.jsonl | awk -F <span style="color:#e6db74">&#39;[&#34;,]+&#39;</span> <span style="color:#e6db74">&#39;{print $10,$13}&#39;</span> |grep -v <span style="color:#ae81ff">200</span> | sort |uniq -c | sort -nr | head -10
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ awk  	<span style="color:#75715e"># 过滤、输出内容，$1:第一列，$2:第二列依次类推，但$0:表示一行，</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e"># NR:行号，NF:表示最后结尾一列，-F:指定分隔符、使用：[]可以过滤多个参数，</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e"># awk -F &#39;[:]&#39; &#39;NR==1 {print $1,$4,$NF}&#39; /etc/passwd</span>
</span></span><span style="display:flex;"><span>$ awk <span style="color:#e6db74">&#39;$0 &gt;= &#34;2023/12/01 00:00:00&#34; &amp;&amp; $0 &lt;= &#34;2023/12/01 23:59:59&#34;&#39;</span> live_go_chat_pre.log &gt; 2023-12-01.txt
</span></span><span style="display:flex;"><span>$ cat nginx.jsonl | awk -F <span style="color:#e6db74">&#39;&#34;&#39;</span> <span style="color:#e6db74">&#39;{if($50 != &#34;XXXIP&#34; &amp;&amp; $50 == &#34;XXXIP&#34;) {print $0}}&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ grep  	<span style="color:#75715e"># linux三剑客老三过滤需要的内容，例子：grep -v oldboy test.txt，</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e"># grep一般常用参数:</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e"># -a:在二进制文件中，以文件文件的方式搜素数据</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e"># -c:计算找到&#39;搜索字符串&#39;的次数</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e"># -o:仅显示出匹配regexp的内容(用于统计出现在文中的次数)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e"># -i:不区分大小写，所以大小写视为相同</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e"># -n:匹配的内容在其行首显示行号</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e"># -v:反向选择，即显示没有&#39;搜索字符串&#39;内容的那一行</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e"># -E:扩展的grep，即egrep</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e"># -v:后面接要排除的内容</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e"># -n:对匹配的内容打印行号</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e"># -w:按单词搜索，相当于\ \b。</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e"># Context control:</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e"># -B:(before)除了显示匹配的一行之外,并显示该行之前的num行</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e"># -A:(after)除了显示匹配的一行之外,并显示该行之后的num行</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e"># -C:(Context)除了显示匹配的一行之外,并显示该行之前后各num行</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e"># --color=auto:对过滤的匹配的字符串加颜色</span>
</span></span><span style="display:flex;"><span>$ sort  	<span style="color:#75715e"># 排序命令，-n：依照数值的大小排序，-r：以相反的顺序来排序</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ uniq  	<span style="color:#75715e"># 去重命令，-c或--count 在每列旁边显示该行重复出现的次数</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->其他命令<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>:set fileformat<span style="color:#f92672">=</span>unix  	<span style="color:#75715e"># windows 换行符缓存Linux</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ echo -e <span style="color:#e6db74">&#34;\033[?25h&#34;</span>  	<span style="color:#75715e"># 显示光标</span>
</span></span><span style="display:flex;"><span>$ dos2unix bash.sh
</span></span><span style="display:flex;"><span>$ ln  	<span style="color:#75715e"># 创建软硬连接,-s软(readlink)、修改软连接：ln -snf 源文件地址 链接名称， ln -s dist_commit pro，ln -s dist_commit pre， </span>
</span></span><span style="display:flex;"><span>$ cut  	<span style="color:#75715e"># 切割 取列,-d分隔符,-f取列,-c字符</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ tar  	<span style="color:#75715e"># z:压缩、c:备份、v:屏幕输出过程、f:指定备份文件、j:bzip2压缩/解压缩、</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># x:归档中提取文件 X N:日期格式、p:保留原来的文件权限与属性、</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># P:使用文件名的绝对路径，不移除文件名称前的“/”号、</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># C:仅压缩指定目录里的内容或解压缩到指定目录、</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># --exclude=/usr/local/nginx/log:排除不需要打包目录</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># tar -c --lzma -f nginx-logs.tar.lzma /opt/logs/nginx 极限压缩格式</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># tar zcvf /opt/backup/nginx-$(date +%F).tar.gz --exclude=/usr/local/nginx/log nginx 忽略log 目录压缩</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ wget  	<span style="color:#75715e"># 下载 -q 安静 -O 指定文件名</span>
</span></span><span style="display:flex;"><span>$ curl  	<span style="color:#75715e"># -I查看响应header信息 -s安静的 -w获取</span>
</span></span><span style="display:flex;"><span>$ lynx  	<span style="color:#75715e"># 命令行纯文本浏览器</span>
</span></span><span style="display:flex;"><span>$ test  	<span style="color:#75715e"># 测试命令，-f:测试文件是否存在，-d:测试目录是否存在</span>
</span></span><span style="display:flex;"><span>$ crontab  	<span style="color:#75715e"># 计划任务，如果任务没执行需要查看文件权限：/var/spool/cron/crontabs/root 是否为：600权限，以及组权限是否属于：crontab</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ split  	<span style="color:#75715e"># 手动切割日志、文件，-b：指定文件压缩后大小，</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e"># -d：指定文件命后缀使用数字(默认使用字母)，</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e"># -a 3：指定后缀文件名是三位数，举例：</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e"># split -b 200M nginx.log -d -a 3 nginx.log，按照nginx.log后缀添加命名</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ diff -c -a -r cms1 cms2  	<span style="color:#75715e"># -a:逐行比较文本文件、</span>
</span></span><span style="display:flex;"><span>									<span style="color:#75715e"># -c:显示全部内文，并标出不同之处、 </span>
</span></span><span style="display:flex;"><span>									<span style="color:#75715e"># -r:比较子目录中的文件</span>
</span></span><span style="display:flex;"><span>									
</span></span><span style="display:flex;"><span>$ kill -l  	<span style="color:#75715e"># 获取kill 信号指令</span>
</span></span><span style="display:flex;"><span> 1<span style="color:#f92672">)</span> SIGHUP       2<span style="color:#f92672">)</span> SIGINT       3<span style="color:#f92672">)</span> SIGQUIT      4<span style="color:#f92672">)</span> SIGILL       5<span style="color:#f92672">)</span> SIGTRAP
</span></span><span style="display:flex;"><span> 6<span style="color:#f92672">)</span> SIGABRT      7<span style="color:#f92672">)</span> SIGBUS       8<span style="color:#f92672">)</span> SIGFPE       9<span style="color:#f92672">)</span> SIGKILL     10<span style="color:#f92672">)</span> SIGUSR1
</span></span><span style="display:flex;"><span>11<span style="color:#f92672">)</span> SIGSEGV     12<span style="color:#f92672">)</span> SIGUSR2     13<span style="color:#f92672">)</span> SIGPIPE     14<span style="color:#f92672">)</span> SIGALRM     15<span style="color:#f92672">)</span> SIGTERM
</span></span><span style="display:flex;"><span>16<span style="color:#f92672">)</span> SIGSTKFLT   17<span style="color:#f92672">)</span> SIGCHLD     18<span style="color:#f92672">)</span> SIGCONT     19<span style="color:#f92672">)</span> SIGSTOP     20<span style="color:#f92672">)</span> SIGTSTP
</span></span><span style="display:flex;"><span>21<span style="color:#f92672">)</span> SIGTTIN     22<span style="color:#f92672">)</span> SIGTTOU     23<span style="color:#f92672">)</span> SIGURG      24<span style="color:#f92672">)</span> SIGXCPU     25<span style="color:#f92672">)</span> SIGXFSZ
</span></span><span style="display:flex;"><span>26<span style="color:#f92672">)</span> SIGVTALRM   27<span style="color:#f92672">)</span> SIGPROF     28<span style="color:#f92672">)</span> SIGWINCH    29<span style="color:#f92672">)</span> SIGIO       30<span style="color:#f92672">)</span> SIGPWR
</span></span><span style="display:flex;"><span>31<span style="color:#f92672">)</span> SIGSYS      34<span style="color:#f92672">)</span> SIGRTMIN    35<span style="color:#f92672">)</span> SIGRTMIN+1  36<span style="color:#f92672">)</span> SIGRTMIN+2  37<span style="color:#f92672">)</span> SIGRTMIN+3
</span></span><span style="display:flex;"><span>38<span style="color:#f92672">)</span> SIGRTMIN+4  39<span style="color:#f92672">)</span> SIGRTMIN+5  40<span style="color:#f92672">)</span> SIGRTMIN+6  41<span style="color:#f92672">)</span> SIGRTMIN+7  42<span style="color:#f92672">)</span> SIGRTMIN+8
</span></span><span style="display:flex;"><span>43<span style="color:#f92672">)</span> SIGRTMIN+9  44<span style="color:#f92672">)</span> SIGRTMIN+10 45<span style="color:#f92672">)</span> SIGRTMIN+11 46<span style="color:#f92672">)</span> SIGRTMIN+12 47<span style="color:#f92672">)</span> SIGRTMIN+13
</span></span><span style="display:flex;"><span>48<span style="color:#f92672">)</span> SIGRTMIN+14 49<span style="color:#f92672">)</span> SIGRTMIN+15 50<span style="color:#f92672">)</span> SIGRTMAX-14 51<span style="color:#f92672">)</span> SIGRTMAX-13 52<span style="color:#f92672">)</span> SIGRTMAX-12
</span></span><span style="display:flex;"><span>53<span style="color:#f92672">)</span> SIGRTMAX-11 54<span style="color:#f92672">)</span> SIGRTMAX-10 55<span style="color:#f92672">)</span> SIGRTMAX-9  56<span style="color:#f92672">)</span> SIGRTMAX-8  57<span style="color:#f92672">)</span> SIGRTMAX-7
</span></span><span style="display:flex;"><span>58<span style="color:#f92672">)</span> SIGRTMAX-6  59<span style="color:#f92672">)</span> SIGRTMAX-5  60<span style="color:#f92672">)</span> SIGRTMAX-4  61<span style="color:#f92672">)</span> SIGRTMAX-3  62<span style="color:#f92672">)</span> SIGRTMAX-2</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->获取公网<!-- raw HTML omitted --><code>IP</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ curl ip.gs
</span></span><span style="display:flex;"><span>$ curl -4 ip.gs
</span></span><span style="display:flex;"><span>$ curl -6 ip.gs
</span></span><span style="display:flex;"><span>$ curl ip.sb
</span></span><span style="display:flex;"><span>$ curl -4 ip.sb
</span></span><span style="display:flex;"><span>$ curl -6 ip.sb
</span></span><span style="display:flex;"><span>$ curl cip.cc
</span></span><span style="display:flex;"><span>$ curl -4 cip.cc
</span></span><span style="display:flex;"><span>$ curl icanhazip.com
</span></span><span style="display:flex;"><span>$ curl -4 icanhazip.com
</span></span><span style="display:flex;"><span>$ curl -6 icanhazip.com
</span></span><span style="display:flex;"><span>$ curl api.ipify.org
</span></span><span style="display:flex;"><span>$ curl -4 api.ipify.org
</span></span><span style="display:flex;"><span>$ curl bot.whatismyipaddress.com
</span></span><span style="display:flex;"><span>$ curl -4 bot.whatismyipaddress.com
</span></span><span style="display:flex;"><span>$ curl -6 bot.whatismyipaddress.com
</span></span><span style="display:flex;"><span>$ curl ipinfo.io/ip
</span></span><span style="display:flex;"><span>$ curl -4 ipinfo.io/ip
</span></span><span style="display:flex;"><span>$ curl ipecho.net/plain
</span></span><span style="display:flex;"><span>$ curl -4 ipecho.net/plain
</span></span><span style="display:flex;"><span>$ curl ipinfo.io
</span></span><span style="display:flex;"><span>$ curl -4 ipinfo.io
</span></span><span style="display:flex;"><span>$ curl -4 myip.ipip.net
</span></span><span style="display:flex;"><span>$ curl -4 ifconfig.me
</span></span><span style="display:flex;"><span>$ curl -4 http://members.3322.org/dyndns/getip
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ curl ifconfig.me
</span></span><span style="display:flex;"><span>$ curl icanhazip.com
</span></span><span style="display:flex;"><span>$ curl curlmyip.com
</span></span><span style="display:flex;"><span>$ curl ip.appspot.com
</span></span><span style="display:flex;"><span>$ curl ipinfo.io/ip
</span></span><span style="display:flex;"><span>$ curl ipecho.net/plain
</span></span><span style="display:flex;"><span>$ curl www.trackip.net/i
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 补充</span>
</span></span><span style="display:flex;"><span>$ curl ip.sb
</span></span><span style="display:flex;"><span>$ curl ip.6655.com/ip.aspx
</span></span><span style="display:flex;"><span>$ curl whatismyip.akamai.com
</span></span><span style="display:flex;"><span>$ wget -qO - ifconfig.co
</span></span><span style="display:flex;"><span>$ dig +short myip.opendns.com @resolver1.opendns.com
</span></span><span style="display:flex;"><span>$ curl ident.me
</span></span><span style="display:flex;"><span>$ curl v4.ident.me
</span></span><span style="display:flex;"><span>$ curl v6.ident.me
</span></span><span style="display:flex;"><span>$ curl inet-ip.info
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 返回IP和地区</span>
</span></span><span style="display:flex;"><span>$ curl ip.6655.com/ip.aspx?area<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>$ curl 1111.ip138.com/ic.asp
</span></span><span style="display:flex;"><span>$ curl ip.cn
</span></span><span style="display:flex;"><span>$ curl cip.cc</span></span></code></pre></div><ul>
<li><code>history</code>历史命令添加时间</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 显示时间</span>
</span></span><span style="display:flex;"><span>export HISTTIMEFORMAT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;%F %T&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 详细显示</span>
</span></span><span style="display:flex;"><span>export HISTTIMEFORMAT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;%F %T </span><span style="color:#66d9ef">$(</span>who -u 2&gt;/dev/null | awk <span style="color:#e6db74">&#39;{print $NF}&#39;</span>| sed <span style="color:#e6db74">&#39;s/[()]//g&#39;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74"> </span><span style="color:#66d9ef">$(</span>whoami<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_cloud_foundry">Install_Cloud_Foundry</h1>

<h2 id="heading"></h2>
<blockquote>
<ul>
<li>
<p><a href="https://docs.cloudfoundry.org/#read-the-docs" rel="external" target="_self"><code>Cloud Foundry</code></a></p>
<p><code>Cloud Foundr</code>y是一个开源的平台即服务<code>PaaS</code>，它提供了一个统一的接口，可以让开发者使用任何语言、框架和工具，在任何云上快速部署和管理应用程序。 它的主要功能包括： 1. 多云支持：<code>Cloud Foundry</code>支持多种不同的云平台，包括<code>Amazon Web Services（AWS）</code>、<code>Google Cloud Platform（GCP）</code>、<code>Microsoft Azure</code>、<code>IBM Cloud</code>、<code>OpenStack</code>和<code>VMWare vSphere</code>等。 2. 自动伸缩：<code>Cloud Foundry</code>可以自动伸缩，根据负载情况增加或减少实例数量，以保证服务的可用性和性能。 3. 可靠的运行时环境：<code>Cloud Foundry</code>有一个功能强大的运行时环境，可以在多个云上提供稳定的服务。 4. 云服务支持：<code>Cloud Foundry</code>支持多种不同的云服务，包括数据库、存储、消息队列、监控等，可以让开发者更方便快捷地部署和管理应用程序。 5. 简化开发流程：<code>Cloud Foundry</code>提供了一个易于使用的命令行界面，可以让开发者轻松的部署和管理应用程序，简化开发流程</p>
</li>
</ul>
</blockquote>

            <footer class="footline">
            </footer>
          </article>

          </section>
          </section>
        </div>
      </main>
    </div>
    <script src="../../js/clipboard.min.js?1727790691" defer></script>
    <script src="../../js/perfect-scrollbar.min.js?1727790691" defer></script>
    <script src="../../js/d3/d3-color.min.js?1727790691" defer></script>
    <script src="../../js/d3/d3-dispatch.min.js?1727790691" defer></script>
    <script src="../../js/d3/d3-drag.min.js?1727790691" defer></script>
    <script src="../../js/d3/d3-ease.min.js?1727790691" defer></script>
    <script src="../../js/d3/d3-interpolate.min.js?1727790691" defer></script>
    <script src="../../js/d3/d3-selection.min.js?1727790691" defer></script>
    <script src="../../js/d3/d3-timer.min.js?1727790691" defer></script>
    <script src="../../js/d3/d3-transition.min.js?1727790691" defer></script>
    <script src="../../js/d3/d3-zoom.min.js?1727790691" defer></script>
    <script src="../../js/js-yaml.min.js?1727790691" defer></script>
    <script src="../../js/mermaid.min.js?1727790691" defer></script>
    <script>
      window.themeUseMermaid = JSON.parse("{ \"securityLevel\": \"loose\" }");
    </script>
    <script src="../../js/theme.js?1727790691" defer></script>
  </body>
</html>
