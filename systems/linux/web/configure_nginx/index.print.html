<!DOCTYPE html>
<html lang="en" dir="ltr" itemscope itemtype="http://schema.org/Article">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.125.4">
    <meta name="generator" content="Relearn 6.0.0+tip">
    <meta name="robots" content="noindex, nofollow, noarchive, noimageindex">
    <meta name="description" content="配置Nginx 名称地址 描述 免费域名申请 Vercel CDN 工信部备案查询 查找便宜服务器 随笔分类 - Nginx fly.">
    <meta name="author" content="二哥">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://erge.blog/images/s2-1.png">
    <meta name="twitter:title" content="Configure_Nginx :: Hugo Relearn Theme">
    <meta name="twitter:description" content="配置Nginx 名称地址 描述 免费域名申请 Vercel CDN 工信部备案查询 查找便宜服务器 随笔分类 - Nginx fly.">
    <meta property="og:url" content="https://erge.blog/systems/linux/web/configure_nginx/">
    <meta property="og:site_name" content="Hugo Relearn Theme">
    <meta property="og:title" content="Configure_Nginx :: Hugo Relearn Theme">
    <meta property="og:description" content="配置Nginx 名称地址 描述 免费域名申请 Vercel CDN 工信部备案查询 查找便宜服务器 随笔分类 - Nginx fly.">
    <meta property="og:locale" content="en">
    <meta property="og:type" content="article">
    <meta property="article:section" content="Systems">
    <meta property="article:published_time" content="2024-06-25T00:41:02+08:00">
    <meta property="article:modified_time" content="2024-06-25T00:41:02+08:00">
    <meta property="og:image" content="https://erge.blog/images/s2-1.png">
    <meta itemprop="name" content="Configure_Nginx :: Hugo Relearn Theme">
    <meta itemprop="description" content="配置Nginx 名称地址 描述 免费域名申请 Vercel CDN 工信部备案查询 查找便宜服务器 随笔分类 - Nginx fly.">
    <meta itemprop="datePublished" content="2024-06-25T00:41:02+08:00">
    <meta itemprop="dateModified" content="2024-06-25T00:41:02+08:00">
    <meta itemprop="wordCount" content="2709">
    <meta itemprop="image" content="https://erge.blog/images/s2-1.png">
    <title>Configure_Nginx :: Hugo Relearn Theme</title>
    <link href="../../../../images/favicon.ico?1724860321" rel="icon" type="image/x-icon" sizes="any">
    <link href="../../../../css/fontawesome-all.min.css?1724860323" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="../../../../css/fontawesome-all.min.css?1724860323" rel="stylesheet"></noscript>
    <link href="../../../../css/nucleus.css?1724860323" rel="stylesheet">
    <link href="../../../../css/auto-complete.css?1724860323" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="../../../../css/auto-complete.css?1724860323" rel="stylesheet"></noscript>
    <link href="../../../../css/perfect-scrollbar.min.css?1724860323" rel="stylesheet">
    <link href="../../../../css/fonts.css?1724860323" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="../../../../css/fonts.css?1724860323" rel="stylesheet"></noscript>
    <link href="../../../../css/theme.css?1724860323" rel="stylesheet">
    <link href="../../../../css/theme-relearn-auto.css?1724860323" rel="stylesheet" id="R-variant-style">
    <link href="../../../../css/chroma-relearn-auto.css?1724860323" rel="stylesheet" id="R-variant-chroma-style">
    <link href="../../../../css/variant.css?1724860323" rel="stylesheet">
    <link href="../../../../css/print.css?1724860323" rel="stylesheet" media="print">
    <link href="../../../../css/format-print.css?1724860323" rel="stylesheet">
    <script src="../../../../js/variant.js?1724860323"></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.relBasePath='..\/..\/..\/..';
      window.relearn.relBaseUri='..\/..\/..\/..';
      window.relearn.absBaseUri='https:\/\/erge.blog';
      window.index_js_url="../../../../index.search.js";
      // variant stuff
      window.variants && variants.init( [ 'relearn-auto', 'relearn-light', 'relearn-dark', 'relearn-bright', 'zen-auto', 'zen-light', 'zen-dark', 'retro-auto', 'neon', 'learn', 'blue', 'green', 'red', 'my-branding' ] );
      // translations
      window.T_Copy_to_clipboard = `Copy to clipboard`;
      window.T_Copied_to_clipboard = `Copied to clipboard!`;
      window.T_Copy_link_to_clipboard = `Copy link to clipboard`;
      window.T_Link_copied_to_clipboard = `Copied link to clipboard!`;
      window.T_Reset_view = `Reset view`;
      window.T_View_reset = `View reset!`;
      window.T_No_results_found = `No results found for "{0}"`;
      window.T_N_results_found = `{1} results found for "{0}"`;
    </script>Partial intended to be overwritten to add custom headers, like CSS or any other info
<style>
    
</style>


  </head>
  <body class="mobile-support print disableInlineCopyToClipboard" data-url="../../../../systems/linux/web/configure_nginx/">
    <div id="R-body" class="default-animation">
      <div id="R-body-overlay"></div>
      <nav id="R-topbar">
        <div class="topbar-wrapper">
          <div class="topbar-sidebar-divider"></div>
          <div class="topbar-area topbar-area-start" data-area="start">
            <div class="topbar-button topbar-button-sidebar" data-content-empty="show" data-width-s="show" data-width-m="show" data-width-l="show"><button class="topbar-control" onclick="toggleNav()" type="button" title="Menu (CTRL&#43;ALT&#43;n)"><i class="fa-fw fas fa-bars"></i></button>
            </div>



          </div>
          <ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype="http://schema.org/BreadcrumbList"><li
            itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><a itemprop="item" href="../../../../systems/"><span itemprop="name">Systems</span></a><meta itemprop="position" content="1">&nbsp;>&nbsp;</li><li
            itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><a itemprop="item" href="../../../../systems/linux/"><span itemprop="name">Linux</span></a><meta itemprop="position" content="2">&nbsp;>&nbsp;</li><li
            itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><a itemprop="item" href="../../../../systems/linux/web/"><span itemprop="name">Web</span></a><meta itemprop="position" content="3">&nbsp;>&nbsp;</li><li
            itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><span itemprop="name">Configure_Nginx</span><meta itemprop="position" content="4"></li>
          </ol>
          <div class="topbar-area topbar-area-end" data-area="end">


            <div class="topbar-button topbar-button-prev" data-content-empty="show" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="../../../../systems/linux/web/install_nginx_third_party_modules/" title="Install_Nginx_Third_Party_Modules (🡐)"><i class="fa-fw fas fa-chevron-left"></i></a>
            </div>

            <div class="topbar-button topbar-button-next" data-content-empty="show" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="../../../../systems/linux/work_order/" title="Work_Order (🡒)"><i class="fa-fw fas fa-chevron-right"></i></a>
            </div>



          </div>
        </div>
      </nav>
      <div id="R-main-overlay"></div>
      <main id="R-body-inner" class="highlightable default" tabindex="-1">
        <div class="flex-block-wrapper">
          <article class="default">
            <header class="headline">
            </header>

<h1 id="configure_nginx">Configure_Nginx</h1>

<h2 id="配置nginx">配置<code>Nginx</code></h2>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://www.freenom.com/zh/index.html?lang=zh" rel="external" target="_self">免费域名申请</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://vercel.com/" rel="external" target="_self"><code>Vercel CDN</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://beian.miit.gov.cn/#/Integrated/index" rel="external" target="_self">工信部备案查询</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.serverhunter.com/" rel="external" target="_self">查找便宜服务器</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.cnblogs.com/zhongyehai/category/1406152.html?page=1" rel="external" target="_self">随笔分类 - <code>Nginx</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://fly.io/" rel="external" target="_self"><code>fly.io</code>边缘服务器</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://porkbun.com/" rel="external" target="_self"><code>Porkbun</code>域名购买商</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.domcomp.com/" rel="external" target="_self"><code>Domcomp</code>域名价格对比网站</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://tld-list.com/" rel="external" target="_self"><code>TLD List</code>域名价格对比网站</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/oneinstack/oneinstack" rel="external" target="_self"><code>Oneinstack</code></a></td>
<td>服务安装脚本</td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>
<ol>
<li><code>ab</code><!-- raw HTML omitted -->压力测试工具<!-- raw HTML omitted -->，<a href="https://www.charlesproxy.com/" rel="external" target="_self"><code>Charles</code>抓包工具</a></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install httpd-tools
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ab -n <span style="color:#ae81ff">50</span> -c <span style="color:#ae81ff">20</span> http://127.0.0.1/index.html  	<span style="color:#75715e"># -n：总共发起的请求数，这里设置为50、</span>
</span></span><span style="display:flex;"><span>								<span style="color:#75715e"># -c：同时并发的请求，这里设置为20个、</span>
</span></span><span style="display:flex;"><span>								<span style="color:#75715e"># -k：是否开启长连接</span></span></span></code></pre></div><ul>
<li><code>ab</code><!-- raw HTML omitted -->探测到性能指标<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>Concurrency Level</code><!-- raw HTML omitted -->：设定的并发数<!-- raw HTML omitted --></li>
<li><code>Time taken for tests</code><!-- raw HTML omitted -->：压测总共花费的时间<!-- raw HTML omitted --></li>
<li><code>Complete requests</code><!-- raw HTML omitted -->：总请求数<!-- raw HTML omitted --></li>
<li><code>Failed requests</code><!-- raw HTML omitted -->：失败的个数<!-- raw HTML omitted --></li>
<li><code>Requests per second</code><!-- raw HTML omitted -->：每秒请求数<!-- raw HTML omitted --><code>TPS</code></li>
<li><code>Time per request</code><!-- raw HTML omitted -->：从客户端来看，一个请求需要用到的时间<!-- raw HTML omitted --></li>
<li><code>Time per request</code><!-- raw HTML omitted -->：从服务端来看，处理一个请求要花费的时间<!-- raw HTML omitted --></li>
<li><code>Transfer rate</code><!-- raw HTML omitted -->：传输的速率<!-- raw HTML omitted --></li>
</ul>
</blockquote>
</blockquote>
<ul>
<li>
<ol start="2">
<li><code>Nginx</code><!-- raw HTML omitted -->基于<!-- raw HTML omitted --><code>Lua</code><!-- raw HTML omitted -->做<!-- raw HTML omitted --><code>Waf</code><!-- raw HTML omitted -->规则过滤<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><a href="https://github.com/loveshell/ngx_lua_waf" rel="external" target="_self"><code>ngx_lua_waf</code></a></li>
</ul>
</blockquote>
<hr>
<h3 id="logrodate使用"><code>logrodate</code>使用</h3>
<blockquote>
<ul>
<li></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ man logrotate  	<span style="color:#75715e">#  查看使用详情 </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;/etc/logrotate.d/nginx<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/opt/apps/nginx/logs/*.log{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">copytruncate  	# 用于还在打开中的日志文件，把当前日志备份并截断
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">daily  	# 安日期轮转日志：daily(天)、weekly(月)、monthly(月)、yearly(年)。
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">dateext  	# 文件后缀是日期格式,也就是切割后文件是:xxx.log-20150828.gz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rotate 7  	# 指定日志文件删除之前转储的次数，0指没有备份，7指保留7个备份
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">missingok  	# 如果日志不存在则忽略该警告信息
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">compress  	# 通过gzip压缩转储以后的日志（gzip -d xxx.gz解压）
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">notifempty  	# 如果是空文件的话，不转储
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">size 100k	# 在日志大小大于 logsize（例如 100K，4M）时轮换
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">su root root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">} 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 手动调试验证：-d</span>
</span></span><span style="display:flex;"><span>$ /usr/sbin/logrotate -d /etc/logrotate.d/nginx
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 手动强制执行：-f</span>
</span></span><span style="display:flex;"><span>$ /usr/sbin/logrotate -f /etc/logrotate.d/nginx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 新增刪除7天以前log定時腳本  </span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;###nginx超過七天log刪除
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">1 0 * * * /bin/bash /opt/scripts/DEL_NGINX.sh &gt;&gt; ~/del_tom.log 2&gt;&amp;1&#34;</span> &gt;&gt; /var/spool/cron/admin</span></span></code></pre></div></blockquote>
<hr>
<h3 id="json日志格式"><code>Json</code>日志格式</h3>
<blockquote>
<table>
<thead>
<tr>
<th>变量名</th>
<th>描述</th>
<th>举例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>'&quot;@timestamp&quot;:&quot;$time_iso8601&quot;,'</code></td>
<td><code>ISO 8601</code>标准格式的当地时间</td>
<td></td>
</tr>
<tr>
<td><code>'&quot;uri&quot;:&quot;$uri&quot;,'</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>'&quot;args&quot;:&quot;$args&quot;,'</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>'&quot;host&quot;:&quot;$host&quot;,'</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>'&quot;https&quot;:&quot;$https&quot;,'</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>'&quot;scheme&quot;:&quot;$scheme&quot;,' </code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>'&quot;domain&quot;:&quot;$domain&quot;,'</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>'&quot;status&quot;:&quot;$status&quot;,'</code></td>
<td><code>HTTP</code>请求状态码</td>
<td><code>200 403 499 502 503</code></td>
</tr>
<tr>
<td><code>'&quot;request&quot;:&quot;$request&quot;,'</code></td>
<td>请求的<code>URI</code>和<code>HTTP</code>协议</td>
<td><code>&quot;GET /api/img/home/logo-aipay.png HTTP/1.1&quot;</code></td>
</tr>
<tr>
<td><code>'&quot;hostname&quot;:&quot;$hostname&quot;,'</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>'&quot;http_host&quot;:&quot;$http_host&quot;,'</code></td>
<td>访问的域名或者<code>IP</code></td>
<td><code>www.domain.com</code><!-- raw HTML omitted -->192.168.1.1</td>
</tr>
<tr>
<td><code>'&quot;time_local&quot;:&quot;$time_local&quot;,'</code></td>
<td>通用日志格式中的本地时间</td>
<td><code>18/Jul/2021:13:00:00 +0800</code></td>
</tr>
<tr>
<td><code>'&quot;ssl_cipher&quot;:&quot;$ssl_cipher&quot;,'</code></td>
<td>交换数据中的算法</td>
<td><code>RC4-SHA</code></td>
</tr>
<tr>
<td><code>'&quot;requesturl&quot;:&quot;$request_uri&quot;,'</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>'&quot;remote_addr&quot;:&quot;$remote_addr&quot;,'</code></td>
<td>客户端地址</td>
<td></td>
</tr>
<tr>
<td><code>'&quot;remote_user&quot;:&quot;$remote_user&quot;,'</code></td>
<td>客户端用户名称</td>
<td></td>
</tr>
<tr>
<td><code>'&quot;server_addr&quot;:&quot;$server_addr&quot;,'</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>'&quot;http_cookie&quot;:&quot;$http_cookie&quot;,'</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>'&quot;http_gp_xreal&quot;:&quot;$http_GP_IP&quot;,' </code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>'&quot;ssl_protocol&quot;:&quot;$ssl_protocol&quot;,'</code></td>
<td><code>SSL</code>协议版本</td>
<td><code>TLSv1</code></td>
</tr>
<tr>
<td><code>'&quot;request_body&quot;:&quot;$request_body&quot;,'</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>'&quot;request_time&quot;:&quot;$request_time&quot;,' </code></td>
<td>整个请求的总时间</td>
<td></td>
</tr>
<tr>
<td><code>'&quot;http_referer&quot;:&quot;$http_referer&quot;,' </code></td>
<td>跳转来源</td>
<td></td>
</tr>
<tr>
<td><code>'&quot;client_realip&quot;:&quot;$clientRealIp&quot;,'</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>'&quot;upstream_addr&quot;:&quot;$upstream_addr&quot;,'</code></td>
<td><code>upstream</code>代理的后端服务地址</td>
<td><code>java tomcat php</code></td>
</tr>
<tr>
<td><code>'&quot;request_length&quot;:&quot;$request_length&quot;,'</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>'&quot;upstream_status&quot;:&quot;$upstream_status&quot;,'</code></td>
<td><code>upstream</code>状态码</td>
<td><code>200 403 499 502 503</code></td>
</tr>
<tr>
<td><code>'&quot;body_bytes_sent&quot;:&quot;$body_bytes_sent&quot;,'</code></td>
<td>发送给客户的文件大小</td>
<td></td>
</tr>
<tr>
<td><code>'&quot;http_user_agent&quot;:&quot;$http_user_agent&quot;,'</code></td>
<td>用户浏览器访问类型</td>
<td></td>
</tr>
<tr>
<td><code>'&quot;http_wangsu_xreal&quot;:&quot;$http_cdn_src_IP&quot;,'</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>'&quot;http_ali_xreal&quot;:&quot;$http_Ali_CDN_Real_IP&quot;,'</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>'&quot;http_cf_xreal&quot;:&quot;$http_CF_Connecting_IP&quot;,'</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>'&quot;http_x_forwarded_for&quot;:&quot;$http_x_forwarded_for&quot;,'</code></td>
<td></td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>'&quot;upstream_response_time&quot;:&quot;$upstream_response_time&quot;,'</code></td>
<td>请求过程中，<code>upstream</code>响应时间</td>
<td>&mdash;</td>
</tr>
<tr>
<td><code>'&quot;proxy_add_x_forwarded_for&quot;:&quot;$proxy_add_x_forwarded_for&quot;,'</code></td>
<td>&mdash;</td>
<td>&mdash;</td>
</tr>
</tbody>
</table>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">log_format</span> <span style="color:#e6db74">json</span> <span style="color:#e6db74">escape=json</span>  <span style="color:#e6db74">&#39;</span>{<span style="color:#f92672">&#34;@timestamp&#34;:&#34;$time_iso8601&#34;,&#39;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;client_realip&#34;:&#34;</span>$clientRealIp&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;remote_addr&#34;:&#34;</span>$remote_addr&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;status&#34;:&#34;</span>$status&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;upstream_status&#34;:&#34;</span>$upstream_status&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;request_time&#34;:&#34;</span>$request_time&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;upstream_response_time&#34;:&#34;</span>$upstream_response_time&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;upstream_addr&#34;:&#34;</span>$upstream_addr&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;request&#34;:&#34;</span>$request&#34;,&#39;
</span></span><span style="display:flex;"><span>  	<span style="color:#e6db74">&#39;&#34;http_scheme&#34;:&#34;</span>$http_X_Forwarded_Proto&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;server_name&#34;:&#34;</span>$host&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;uri&#34;:&#34;</span>$uri&#34;,&#39;
</span></span><span style="display:flex;"><span>  	<span style="color:#e6db74">&#39;&#34;request_body&#34;:&#34;</span>$request_body&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;body_bytes_sent&#34;:&#34;</span>$body_bytes_sent&#34;,&#39;
</span></span><span style="display:flex;"><span>  	<span style="color:#e6db74">&#39;&#34;bytes_sent&#34;:&#34;</span>$body_bytes_sent&#34;, <span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;request_length&#34;:&#34;</span>$request_length&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;http_referer&#34;:&#34;</span>$http_referer&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;http_wangsu_xreal&#34;:&#34;</span>$http_cdn_src_IP&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;http_ali_xreal&#34;:&#34;</span>$http_Ali_CDN_Real_IP&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;http_cf_xreal&#34;:&#34;</span>$http_CF_Connecting_IP&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;http_gp_xreal&#34;:&#34;</span>$http_GP_IP&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;http_x_forwarded_for&#34;:&#34;</span>$proxy_add_x_forwarded_for&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;http_user_agent&#34;:&#34;</span>$http_user_agent&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;xdevice&#34;:&#34;</span>$http_x_device&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;xversion&#34;:&#34;</span>$http_x_version&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;trace-id&#34;:&#34;</span>$http_x_trace_id&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;uid&#34;:&#34;</span>$http_x_id&#34;&#39;
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;</span><span style="color:#960050;background-color:#1e0010">}</span><span style="color:#e6db74">&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#f92672">这里注意使用下划线，</span></span></span></code></pre></div><ul>
<li><code>Json</code><!-- raw HTML omitted -->方式查看日志<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ tail -n1 /var/log/nginx/gitlab.log | awk -F <span style="color:#e6db74">&#39;&#34;&#39;</span> <span style="color:#e6db74">&#39;{if($3 == &#34;x.x.x.x&#34; &amp;&amp; $6 != &#34;403&#34;) {print $0}}&#39;</span> | jq</span></span></code></pre></div></blockquote>
<hr>
<h3 id="系统排查">系统排查</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># URL解码、编码</span>
</span></span><span style="display:flex;"><span>$ yum -y install gridsite-clients
</span></span><span style="display:flex;"><span>$ tail -n10 nginx.logs | awk -F <span style="color:#e6db74">&#39;[:]&#39;</span> <span style="color:#e6db74">&#39;{print $24}&#39;</span> | xargs urlencode -d decode
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 后台加白</span>
</span></span><span style="display:flex;"><span>$ sed -Ei <span style="color:#e6db74">&#34;s@((([0-9]{1,3}\.?){4})+)@\1|{{ ip }}@&#34;</span> /usr/local/nginx/conf/vhosts/ white_list.ini
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除加白</span>
</span></span><span style="display:flex;"><span>$ sed -Ei <span style="color:#e6db74">&#34;s@((\|?){{ ip }}\|?)@\2@&#34;</span> /usr/local/nginx/conf/vhosts/ white_list.ini
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 排查系统中内存占用前 5 的进程</span>
</span></span><span style="display:flex;"><span>$ ps -eo pid,ppid,cmd,%mem,%cpu --sort<span style="color:#f92672">=</span>-%mem |head -5
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># nginx</span>
</span></span><span style="display:flex;"><span>$ netstat -ntu|awk <span style="color:#e6db74">&#39;{print $5}&#39;</span>|cut -d: -f1|wc -l  	<span style="color:#75715e"># 查看文件打开数量</span>
</span></span><span style="display:flex;"><span>$ netstat -n | awk <span style="color:#e6db74">&#39;/^tcp/ {++S[$NF]} END {for(a in S) print a, S[a]}&#39;</span>  	<span style="color:#75715e"># 查看服务器网络负载</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ tail -n100 /opt/logs/nginx/web_access.log |awk <span style="color:#e6db74">&#39;{print $1}&#39;</span> |sort -rn |uniq -c |sort -rn |head
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 命令行跨域测试 -i：允许跨域的域名，-H：访问域名</span>
</span></span><span style="display:flex;"><span>$ curl -i https://baidu.com/text.txt -H <span style="color:#e6db74">&#34;Origin: http://www.example.com&#34;</span></span></span></code></pre></div><ul>
<li>打开浏览器按<code>F12</code>然后访问跨域域名，查看是否显示有：<code>access-control-allow-origin: *</code>跨域参数</li>
</ul>
</blockquote>
<hr>
<h3 id="nginxconf配置文件"><code>nginx.conf</code>配置文件</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e"># 用户和组: user nobody nogroup;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">user</span> <span style="color:#e6db74">nobody</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># nginx进程数，auto为自动
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">worker_processes</span> <span style="color:#e6db74">auto</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">worker_cpu_affinity</span>  <span style="color:#e6db74">auto</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># nginx进程打开的最多文件描述符数目，理论值应该是最多打开文件数（ulimit -n）与 nginx 进程数相除，但是 nginx 分配请求并不是那么均匀，所以最好与 ulimit -n 的值保持一致
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">worker_rlimit_nofile</span> <span style="color:#ae81ff">51200</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">error_log</span> <span style="color:#e6db74">/usr/local/nginx/logs/web_error.log</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pid</span> <span style="color:#e6db74">/usr/local/nginx/logs/nginx.pid</span>;</span></span></code></pre></div><ul>
<li><code>events</code><!-- raw HTML omitted -->参数配置<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">events</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 使用epoll的I/O模型
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">use</span> <span style="color:#e6db74">epoll</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 每个进程允许的最多连接数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">worker_connections</span>  <span style="color:#ae81ff">2048</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">multi_accept</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>	}</span></span></code></pre></div></blockquote>
<ul>
<li><code>http</code><!-- raw HTML omitted -->参数配置<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">http</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">log_format</span> <span style="color:#e6db74">main</span> <span style="color:#e6db74">&#39;</span>$remote_addr <span style="color:#e6db74">-</span> $remote_user <span style="color:#e6db74">[</span>$time_iso8601] <span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#39;fwf[</span>$http_x_forwarded_for] <span style="color:#e6db74">tip[</span>$http_true_client_ip] <span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#39;</span>$upstream_addr $upstream_response_time $request_time <span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#39;</span>$http_host $request <span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#39;&#34;</span>$status&#34; $body_bytes_sent $request_body <span style="color:#e6db74">&#34;</span>$http_referer&#34; <span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#39;&#34;</span>$http_accept_language&#34; <span style="color:#e6db74">&#34;</span>$http_user_agent&#34; <span style="color:#e6db74">&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">access_log</span>  <span style="color:#e6db74">/usr/local/nginx/logs/web_access.log</span>  <span style="color:#e6db74">main</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 调用 mime.types 请求头
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">include</span>             <span style="color:#e6db74">mime.types</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 默认数据流模式
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">default_type</span>        <span style="color:#e6db74">application/octet-stream</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 基本配置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">include</span> <span style="color:#e6db74">inc.d/basic.ini</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 缓存配置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e"># include inc.d/cache.ini;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># fastcgi 配置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">include</span> <span style="color:#e6db74">inc.d/fastcgi.ini</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 压缩配置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">include</span> <span style="color:#e6db74">inc.d/compaction.ini</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> 	<span style="color:#75715e"># IP 限制配置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> 	<span style="color:#f92672">include</span> <span style="color:#e6db74">inc.d/ip-limits.ini</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> 	<span style="color:#75715e"># 请求头
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> 	<span style="color:#f92672">include</span> <span style="color:#e6db74">inc.d/proxy_set_header.ini</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> 	<span style="color:#75715e"># 日志配置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> 	<span style="color:#f92672">include</span> <span style="color:#e6db74">inc.d/logs.ini</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> 	<span style="color:#75715e"># 访问频率限制
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> 	<span style="color:#f92672">include</span> <span style="color:#e6db74">inc.d/limit-speed.ini</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> 	<span style="color:#75715e"># 跨域
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> 	<span style="color:#f92672">include</span> <span style="color:#e6db74">inc.d/cross-domain.ini</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> 	<span style="color:#75715e"># 反代缓存
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> 	<span style="color:#f92672">include</span> <span style="color:#e6db74">inc.d/reverse-proxy.ini</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">include</span> <span style="color:#e6db74">vhosts/*.conf</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">include</span> <span style="color:#e6db74">vhosts/*/*.conf</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->基本配置<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e"># include inc.d/basic.ini;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改lua脚本后不重启nginx配置， 对服务性能不友好，脚本编写期间使用此配置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">lua_code_cache</span> <span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生命一个名称为：shared_data，大小：1Mb内存空间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">lua_shared_dict</span> <span style="color:#e6db74">shared_data</span> <span style="color:#ae81ff">1m</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 显示json数据中文乱码问题
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">charset</span> <span style="color:#e6db74">utf-8</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 零拷贝模式
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">sendfile</span>	<span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 作用：sendfile开启的情况下，提高网络包的传输效率
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">tcp_nopush</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">tcp_nodelay</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># keepalive 超时时间 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">keepalive_timeout</span>  <span style="color:#ae81ff">90</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 一个Tcp复用中，可以并发接受的请求
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">keepalive_requests</span> <span style="color:#ae81ff">1000</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">server_names_hash_max_size</span> <span style="color:#ae81ff">1024</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># nginx关掉版本号
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">server_tokens</span> <span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">server_names_hash_bucket_size</span> <span style="color:#ae81ff">128</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">large_client_header_buffers</span> <span style="color:#ae81ff">8</span> <span style="color:#ae81ff">128k</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">client_max_body_size</span> <span style="color:#ae81ff">8m</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">client_header_buffer_size</span> <span style="color:#ae81ff">4k</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 不配置或者是off,请求头中的自定义请求头用 - 连接是支持的，不要配置 _ 来接收,如果是下划线 _ 自定义请求头会丢失
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">underscores_in_headers</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">proxy_buffer_size</span> <span style="color:#ae81ff">32k</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 读取上游服务器资源，边读边发送数据资源
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">proxy_buffering</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在内存中划分32个128K大小的内存缓冲块，缓冲数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">proxy_buffers</span> <span style="color:#ae81ff">32</span> <span style="color:#ae81ff">128k</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">proxy_connect_timeout</span> <span style="color:#ae81ff">60</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">proxy_read_timeout</span> <span style="color:#ae81ff">60</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">proxy_send_timeout</span> <span style="color:#ae81ff">5</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 读取proxy_pass数据写入到磁盘的最大值，默认1G
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">proxy_max_temp_file_size</span> <span style="color:#ae81ff">1024m</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">proxy_busy_buffers_size</span> <span style="color:#ae81ff">128k</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">proxy_temp_file_write_size</span> <span style="color:#ae81ff">128k</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">proxy_headers_hash_max_size</span> <span style="color:#ae81ff">51200</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">proxy_headers_hash_bucket_size</span> <span style="color:#ae81ff">6400</span>;</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->缓存配置<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e"># include inc.d/cache.ini;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 打开文件指定缓存，默认没启用，max指定缓存数量，建议和打开文件数一致，inactive是指经过多长时间文件没被请求后删除缓存。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">open_file_cache</span> <span style="color:#e6db74">max=102400</span> <span style="color:#e6db74">inactive=20s</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 是指多长时间检查一次缓存的有效信息。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">open_file_cache_valid</span> <span style="color:#e6db74">30s</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># open_file_cache 指令中的 inactive 参数时间内文件的最少使用次数，如果有一个文件在 inactive 时间内一次没被使用，它将被移除
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">open_file_cache_min_uses</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 指令为 FastCGI 缓存指定一个路径，目录结构等级，关键字区域存储时间和非活动删除时间。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">fastcgi_cache_path</span> <span style="color:#e6db74">/usr/local/nginx/fastcgi_cache</span> <span style="color:#e6db74">levels=1:2</span> <span style="color:#e6db74">keys_zone=TEST:10m</span> <span style="color:#e6db74">inactive=5m</span>;</span></span></code></pre></div><ul>
<li><code>fastcgi</code><!-- raw HTML omitted -->配置<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e"># include inc.d/fastcgi.ini;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fastcgi_connect_timeout</span> <span style="color:#ae81ff">300</span>;  	<span style="color:#75715e"># 指定连接到后端 FastCGI 的超时时间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">fastcgi_send_timeout</span> <span style="color:#ae81ff">300</span>;  	<span style="color:#75715e"># 向 FastCGI 传送请求的超时时间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">fastcgi_read_timeout</span> <span style="color:#ae81ff">300</span>;  	<span style="color:#75715e"># 接收 FastCGI 应答的超时时间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">fastcgi_buffer_size</span> <span style="color:#ae81ff">64k</span>;  	<span style="color:#75715e"># 指定读取FastCGI应答第一部分需用多大缓冲区
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">fastcgi_buffers</span> <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">64k</span>;  	<span style="color:#75715e"># 指定本地需用多少和多大缓冲区缓冲FastCGI的应答。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">fastcgi_busy_buffers_size</span> <span style="color:#ae81ff">128k</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fastcgi_temp_file_write_size</span> <span style="color:#ae81ff">128k</span>;  	<span style="color:#75715e"># 在写入 fastcgi_temp_path 时将用多大的数据块，默认值是 fastcgi_buffers 的两倍。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># fastcgi_cache TEST  	# 开启FastCGI缓存并且为其制定一个名称，可以有效降低CPU 负载，并且防止 502 错误
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># fastcgi_cache_valid 200 302 1h;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># fastcgi_cache_valid 301 1d;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># fastcgi_cache_valid any 1m;  	# 为指定应答代码指定缓存时间,如将200,302应答缓存一小时,301应答缓存1天.其他为1分钟。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#66d9ef">fastcgi_cache_min_uses</span> <span style="color:#ae81ff">1</span>;  	<span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#66d9ef">缓存在</span> <span style="color:#e6db74">fastcgi_cache_path指令inactive参数值时间内的最少使用次数,如果在5分钟内某文件1次也没有被使用,那么这个文件将被移除。</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->压缩配置<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e"># include inc.d/compaction.ini;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># brotli压缩算法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">brotli</span>			<span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">brotli_comp_level</span>	<span style="color:#ae81ff">6</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">brotli_buffers</span>		<span style="color:#ae81ff">16</span> <span style="color:#ae81ff">8k</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">brotli_min_length</span>	<span style="color:#ae81ff">256</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">brotli_types</span>		<span style="color:#e6db74">text/plain</span> <span style="color:#e6db74">application/javascript</span> <span style="color:#e6db74">application/x-javascript</span> <span style="color:#e6db74">text/javascript</span> <span style="color:#e6db74">text/css</span> <span style="color:#e6db74">application/xml</span> <span style="color:#e6db74">application/json</span> <span style="color:#e6db74">image/jpeg</span> <span style="color:#e6db74">image/gif</span> <span style="color:#e6db74">image/png</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">brotli_window</span>		<span style="color:#ae81ff">512k</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># gzip压缩算法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">gzip</span>	<span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">gzip_comp_level</span>  <span style="color:#ae81ff">6</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 根据操作系统选择：64位操作系统为：16 8k，32位操作系统：32 4k
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">gzip_buffers</span>     <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">8k</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">gzip_min_length</span>  <span style="color:#ae81ff">1k</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">gzip_types</span>       <span style="color:#e6db74">text/plain</span> <span style="color:#e6db74">application/javascript</span> <span style="color:#e6db74">application/x-javascript</span> <span style="color:#e6db74">text/javascript</span> <span style="color:#e6db74">text/css</span> <span style="color:#e6db74">application/xml</span> <span style="color:#e6db74">application/xml+rss</span> <span style="color:#e6db74">application/json</span> <span style="color:#e6db74">text/xml</span> <span style="color:#e6db74">image/jpeg</span> <span style="color:#e6db74">image/gif</span> <span style="color:#e6db74">image/png</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">gzip_disable</span>     <span style="color:#e6db74">&#34;msie6&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">gzip_http_version</span> <span style="color:#ae81ff">1</span><span style="color:#e6db74">.1</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">gzip_vary</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">gzip_proxied</span>     <span style="color:#e6db74">any</span> <span style="color:#e6db74">expired</span> <span style="color:#e6db74">no-cache</span> <span style="color:#e6db74">no-store</span> <span style="color:#e6db74">private</span> <span style="color:#e6db74">auth</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">gzip_disable</span> <span style="color:#e6db74">&#34;MSIE</span> <span style="color:#e6db74">[1-6]\.&#34;</span>;</span></span></code></pre></div><ul>
<li><code>IP</code><!-- raw HTML omitted -->限制配置<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e"># include inc.d/ip-limits.ini;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">map</span> $http_upgrade $connection_upgrade {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">default</span> <span style="color:#e6db74">upgrade</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&#39;&#39;</span>	<span style="color:#e6db74">close</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">map</span> $http_cdn-src-IP $ali_xreal {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&#34;&#34;</span>   $http_Ali-CDN-Real-IP;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">~^(?P&lt;firstAddr&gt;[0-9\.]+),?.*$</span> $firstAddr;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">map</span> $ali_xreal $cf_xreal {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&#34;&#34;</span>  $http_CF-Connecting-IP;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">~^(?P&lt;firstAddr&gt;[0-9\.]+),?.*$</span> $firstAddr;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">map</span> $cf_xreal  $gp_xreal {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&#34;&#34;</span> $http_GP_IP;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">~^(?P&lt;firstAddr&gt;[0-9\.]+),?.*$</span> $firstAddr;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">map</span> $gp_xreal  $xrealip {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&#34;&#34;</span> $http_x_forwarded_for ;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">~^(?P&lt;firstAddr&gt;[0-9\.]+),?.*$</span> $firstAddr;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">map</span> $xrealip  $clientRealIp {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&#34;&#34;</span> $remote_addr;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">~^(?P&lt;firstAddr&gt;[0-9\.]+),?.*$</span> $firstAddr;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span><span style="color:#75715e">#####  	GeoIP访问IP限制  #####
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># geoip_country	GeoIP/GeoIP.dat;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># geoip_city		GeoIP/GeoLiteCity.dat;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># geoip_proxy		0.0.0.0/0;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># geoip_proxy_recursive on;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># geo $remote_addr $ip_whitelist {
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#	default 0;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#	include ip.conf;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># }
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">geoip2</span> <span style="color:#e6db74">/usr/local/nginx/conf/GeoLite2-Country/GeoLite2-Country.mmdb</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">$geoip2_data_country_code</span> <span style="color:#e6db74">country</span> <span style="color:#e6db74">iso_code</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">$geoip2_data_country_name</span> <span style="color:#e6db74">country</span> <span style="color:#e6db74">iso_code</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">geoip2</span> <span style="color:#e6db74">/usr/local/nginx/conf/GeoLite2-City/GeoLite2-City.mmdb</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">$geoip2_data_city_name</span> <span style="color:#e6db74">city</span> <span style="color:#e6db74">iso_code</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 配置1: 允许所有国家访问，除了美国和日本
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">map</span> $geoip2_data_country_code $allowed_country {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">default</span> <span style="color:#e6db74">yes</span>;  	<span style="color:#75715e"># 默认配置 yes：允许所有，no：拒绝所有
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">US</span> <span style="color:#e6db74">no</span>;  	<span style="color:#75715e"># 单独配置拒绝
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">JP</span> <span style="color:#e6db74">no</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">CN</span> <span style="color:#e6db74">yes</span>;  	<span style="color:#75715e"># 单独配置允许，前提是：default no;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># geoip_country /usr/local/nginx/GeoIP/GeoIP.dat;  # Geoip所在目录
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># map $geoip_country_code $allowed_country {
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#	default yes;    # 允许
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#	CN no;      # 中国大陆区命名为no
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#66d9ef">}</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->请求头<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e"># include inc.d/proxy_set_header.ini;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">proxy_set_header</span> <span style="color:#e6db74">X-Real-IP</span> $clientRealIp;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $remote_addr;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $proxy_add_x_forwarded_for;</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->日志配置，以及配置<!-- raw HTML omitted --><code>Json</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e"># include inc.d/logs.ini;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">map</span> $upstream_response_time $upstream_response_timer {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">default</span> $upstream_response_time;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&#34;&#34;</span>        <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">log_format</span> <span style="color:#e6db74">json</span> <span style="color:#e6db74">escape=json</span>  <span style="color:#e6db74">&#39;</span>{<span style="color:#f92672">&#34;@timestamp&#34;:&#34;$time_iso8601&#34;,&#39;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;client_realip&#34;:&#34;</span>$clientRealIp&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;remote_addr&#34;:&#34;</span>$remote_addr&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;status&#34;:&#34;</span>$status&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;upstream_status&#34;:&#34;</span>$upstream_status&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;request_time&#34;:&#34;</span>$request_time&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;upstream_response_time&#34;:&#34;</span>$upstream_response_time&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;upstream_addr&#34;:&#34;</span>$upstream_addr&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;request&#34;:&#34;</span>$request&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;http_scheme&#34;:&#34;</span>$http_X_Forwarded_Proto&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;server_name&#34;:&#34;</span>$host&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;uri&#34;:&#34;</span>$uri&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;request_body&#34;:&#34;</span>$request_body&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;body_bytes_sent&#34;:&#34;</span>$body_bytes_sent&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;bytes_sent&#34;:&#34;</span>$body_bytes_sent&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;request_length&#34;:&#34;</span>$request_length&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;http_referer&#34;:&#34;</span>$http_referer&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;http_wangsu_xreal&#34;:&#34;</span>$http_cdn_src_IP&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;http_ali_xreal&#34;:&#34;</span>$http_Ali_CDN_Real_IP&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;http_cf_xreal&#34;:&#34;</span>$http_CF_Connecting_IP&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;http_gp_xreal&#34;:&#34;</span>$http_GP_IP&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;http_x_forwarded_for&#34;:&#34;</span>$proxy_add_x_forwarded_for&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;http_user_agent&#34;:&#34;</span>$http_user_agent&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;xdevice&#34;:&#34;</span>$http_x_device&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;xversion&#34;:&#34;</span>$http_x_version&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;trace-id&#34;:&#34;</span>$http_x_trace_id&#34;,&#39;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#34;uid&#34;:&#34;</span>$http_x_id&#34;&#39;
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;</span><span style="color:#960050;background-color:#1e0010">}</span><span style="color:#e6db74">&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#f92672">这里注意使用下划线，</span>		</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->访问频率限制<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e"># include inc.d/limit-speed.ini; 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 限速配置指令
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">limit_conn_log_level</span> <span style="color:#e6db74">error</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 客户端并发访问数限制，名字为ip_limit，大小为15Mb的内存空间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">limit_conn_zone</span> $binary_remote_addr <span style="color:#e6db74">zone=ip_limit:15m</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 客户端 qps 频率访问限制配置、分配一个10Mb的内存空间，同一个IP一秒钟允许5r(5次请求)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">limit_req_zone</span>  $binary_remote_addr <span style="color:#e6db74">zone=one:10m</span> <span style="color:#e6db74">rate=5r/s</span>;</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->跨域配置<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e"># include inc.d/cross-domain.ini;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">add_header</span> <span style="color:#e6db74">Access-Control-Allow-Origin</span> <span style="color:#e6db74">*</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">add_header</span> <span style="color:#e6db74">Access-Control-Allow-Methods</span> <span style="color:#e6db74">GET,POST,OPTIONS</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">add_header</span> <span style="color:#e6db74">Access-Control-Allow-Headers</span> <span style="color:#e6db74">DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization</span>;</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->反代缓存<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e"># include inc.d/reverse-proxy.ini; 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 反代缓存配置，keys_zone=af:1024m 中的：1024m是在内存中占用的空间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">proxy_temp_path</span>   <span style="color:#e6db74">/var/www/temp</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">proxy_cache_path</span> <span style="color:#e6db74">/var/www/temp/baidu</span> <span style="color:#e6db74">levels=1:2</span> <span style="color:#e6db74">keys_zone=af:1024m</span> <span style="color:#e6db74">inactive=1h</span> <span style="color:#e6db74">max_size=10g</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">proxy_cache_path</span> <span style="color:#e6db74">/var/www/temp/ali</span> <span style="color:#e6db74">levels=1:2</span> <span style="color:#e6db74">keys_zone=yunlai01:1024m</span> <span style="color:#e6db74">inactive=1h</span> <span style="color:#e6db74">max_size=10g</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">proxy_cache_path</span> <span style="color:#e6db74">/var/www/temp/jd</span>  <span style="color:#e6db74">levels=1:2</span> <span style="color:#e6db74">keys_zone=vns01:1024m</span> <span style="color:#e6db74">inactive=1h</span> <span style="color:#e6db74">max_size=10g</span>;</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted --><!-- raw HTML omitted --></li>
</ul>
</blockquote>
</blockquote>
<hr>
<h3 id="conf子配置文件"><code>conf</code>子配置文件</h3>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="http://zyan.cc/nginx_php_v5" rel="external" target="_self"><code>Nginx</code>主配置文件参考资料</a></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li><code>server</code><!-- raw HTML omitted -->参数配置<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><blockquote>
<ul>
<li><code>HSTS</code><!-- raw HTML omitted -->安全策略机制<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>Strict-Transport-Security</code>这是<code>HSTS</code>头部的名称。<code>HSTS</code>是一种<code>web</code>安全策略机制，帮助保护网站免受中间人攻击，确保用户与服务器之间的通信始终使用<code>HTTPS</code></li>
<li><code>max-age</code>指定了浏览器应当缓存该策略的有效时间，单位为秒，<code>86400</code>秒等于<code>24</code>小时</li>
<li><code>includeSubdomains</code>这个参数指示浏览器对所有子域名也应用<code>HSTS</code>策略</li>
<li><code>preload</code>参数后，应该确保网站始终支持<code>HTTPS</code>，否则会导致访问错误。</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">add_header</span> <span style="color:#e6db74">Strict-Transport-Security</span> <span style="color:#e6db74">&#34;max-age=86400</span>; <span style="color:#f92672">includeSubdomains</span>; <span style="color:#f92672">preload&#34;</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></blockquote>
<ul>
<li><code>server_name</code><!-- raw HTML omitted -->配置<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">listen</span> <span style="color:#ae81ff">80</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">listen</span> <span style="color:#ae81ff">80</span> <span style="color:#e6db74">default_server</span>;  	<span style="color:#75715e"># 如果没有其他server块匹配请求的Host头，使用这个作为默认处理
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">listen</span> <span style="color:#ae81ff">443</span> <span style="color:#e6db74">ssl</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">listen</span> <span style="color:#ae81ff">8443</span> <span style="color:#e6db74">ssl</span> <span style="color:#e6db74">proxy_protocol</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">ssl</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># .domain.com匹配所有以.domain.com结尾的请求 包括所有子域名，^baidu\d+\.com 包含任意数字
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">server_name</span> <span style="color:#e6db74">domain.com</span> <span style="color:#e6db74">.domain.com</span>$ <span style="color:#e6db74">^baidu\d+\.com</span>$;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->证书配置<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">ssl_certificate</span>      <span style="color:#e6db74">certs/domain/domain.com.crt</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">ssl_certificate_key</span>  <span style="color:#e6db74">certs/domain/domain.com.key</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># ssl_dhparam certs/domain/dhparam.pem;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">ssl_session_cache</span>    <span style="color:#e6db74">shared:SSL:10m</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">ssl_session_timeout</span>  <span style="color:#ae81ff">30m</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">ssl_protocols</span> <span style="color:#e6db74">TLSv1</span> <span style="color:#e6db74">TLSv1.1</span> <span style="color:#e6db74">TLSv1.2</span> <span style="color:#e6db74">TLSv1.3</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">ssl_ciphers</span> <span style="color:#e6db74">&#39;ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:!RC4:!MD5:!aNULL:!NULL&#39;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 优先使用服务器配置的加密套件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">ssl_prefer_server_ciphers</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">resolver</span> <span style="color:#ae81ff">8</span><span style="color:#e6db74">.8.8.8</span> <span style="color:#e6db74">valid=300</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">resolver_timeout</span> <span style="color:#e6db74">10s</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 开启 OCSP Stapling
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">ssl_stapling</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 验证 OCSP 响应
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">ssl_stapling_verify</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>} </span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->强跳证书以及主域名<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># http强跳443， 或使用 $host 字段
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">if</span> <span style="color:#e6db74">(</span> $scheme = <span style="color:#e6db74">http</span> <span style="color:#e6db74">)</span>{ 
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">return</span> <span style="color:#ae81ff">301</span> <span style="color:#e6db74">https://</span>$server_name$request_uri; 
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 强跳主域名
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">if</span> <span style="color:#e6db74">(</span> $host <span style="color:#e6db74">!=</span> <span style="color:#e6db74">&#39;domain.com&#39;</span> <span style="color:#e6db74">)</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^(.*)</span>$ <span style="color:#e6db74">https://domain.com/</span>$1 <span style="color:#e6db74">permanent</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 避免直接返回 404，而是返回应用的主入口
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">try_files</span> $uri $uri/ <span style="color:#e6db74">/index.html</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><ul>
<li><code>location</code><!-- raw HTML omitted -->配置<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>
<p><code>location</code><!-- raw HTML omitted -->匹配规则以及优先级：<!-- raw HTML omitted --><code>=</code> <strong>&gt;</strong> <code>^~</code>  <strong>&gt;</strong>  <code>~</code>  <strong>&gt;</strong>  <code>~*</code></p>
<p><!-- raw HTML omitted -->精确匹配<!-- raw HTML omitted -->和<!-- raw HTML omitted -->前缀匹配<!-- raw HTML omitted -->优先级是最高的，一旦匹配到一个就直接走此<code>location</code>，则不会再往下匹配。
<!-- raw HTML omitted -->正则匹配<!-- raw HTML omitted -->就算匹配到一个<code>location</code>，也还是会接着匹配，看时候还有比当前<code>location</code>更完整，更匹配的<code>location</code>存在，后面没有了，才匹配本身</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>正则符号</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>空</td>
<td><code>location</code>后没有参数直接跟着<strong>标准</strong><code>URI</code>，表示前缀匹配，代表跟请求中的 <code>URI</code>从头开始匹配。</td>
</tr>
<tr>
<td><code>=</code></td>
<td>用于<strong>标准</strong><code>URI</code>前，要求请求字符串与其<!-- raw HTML omitted -->精准匹配<!-- raw HTML omitted -->，成功则立即处理，<code>nginx</code>停止搜索其他匹配</td>
</tr>
<tr>
<td><code>^~</code></td>
<td>使用<!-- raw HTML omitted -->前缀匹配<!-- raw HTML omitted -->，用于<strong>标准</strong><code>URI</code>前，并要求一旦匹配到就会立即处理，不再去匹配其他的那些个正则<code>URI</code>，一般用来<!-- raw HTML omitted -->匹配目录<!-- raw HTML omitted --></td>
</tr>
<tr>
<td><code>~</code></td>
<td>表示开始<!-- raw HTML omitted -->正则匹配<!-- raw HTML omitted -->，表示<code>URI</code>包含正则表达式， <!-- raw HTML omitted -->区分大小写<!-- raw HTML omitted --></td>
</tr>
<tr>
<td><code>~*</code></td>
<td>表示正则匹配<!-- raw HTML omitted -->不区分大小写<!-- raw HTML omitted --></td>
</tr>
<tr>
<td><code>~ \~*</code></td>
<td>表示执行一个正则匹配（）</td>
</tr>
<tr>
<td>`/(xxx</td>
<td>xxx</td>
</tr>
<tr>
<td><code>@</code></td>
<td><code>@</code>定义一个命名的<code>location</code>，<code>@</code>定义的<code>locaiton</code>名字一般用在内部定向，例如<code>error_page</code>, <code>try_files</code>命令中。它的功能类似于编程中的<code>goto(转到)</code></td>
</tr>
<tr>
<td><code>/</code></td>
<td>任何没有匹配成功的，都会匹配这里处理</td>
</tr>
<tr>
<td><code>$</code></td>
<td>表示<!-- raw HTML omitted -->正则结束符<!-- raw HTML omitted -->号</td>
</tr>
</tbody>
</table>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># 这个非常重要，如果git库里有大文件，设置太小，文件push会失败，根据情况调整
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">client_max_body_size</span> <span style="color:#ae81ff">50m</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 禁用重定向处理，默认重定向：default
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">proxy_redirect</span> <span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># 以下确保 gitlab中项目的 url 是域名而不是 http://git，不可缺少
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Real-IP</span> $remote_addr;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Real-Port</span> $remote_port;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_connect_timeout</span> <span style="color:#e6db74">15s</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_read_timeout</span> <span style="color:#e6db74">600s</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_send_timeout</span> <span style="color:#e6db74">60s</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># 设置http版本为1.1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">proxy_http_version</span> <span style="color:#ae81ff">1</span><span style="color:#e6db74">.1</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># 升级协议头 websocket
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Upgrade</span> $http_upgrade;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Connection</span> <span style="color:#e6db74">&#34;upgrade&#34;</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># 升级协议头为https
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Upgrade-Insecure-Requests</span> <span style="color:#ae81ff">1</span>;   
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-Proto</span> <span style="color:#e6db74">https</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">add_header</span> <span style="color:#e6db74">Content-Security-Policy</span> <span style="color:#e6db74">upgrade-insecure-requests</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">add_header</span> <span style="color:#e6db74">Nginx-Cache</span> <span style="color:#e6db74">“</span>$upstream_cache_status”;
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># nginx 反向代理到 gitlab 容器暴露的端口
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://127.0.0.1:8080</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">index</span> <span style="color:#e6db74">index.html</span> <span style="color:#e6db74">index.htm</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 如果出现404， 可以针对某个接口配置 location
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">location</span> = <span style="color:#e6db74">/alive</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://upstream_api</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_http_version</span> <span style="color:#ae81ff">1</span><span style="color:#e6db74">.1</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Upgrade</span> $http_upgrade;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_connect_timeout</span> <span style="color:#e6db74">180s</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_read_timeout</span> <span style="color:#e6db74">180s</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_send_timeout</span> <span style="color:#e6db74">180s</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">location</span> <span style="color:#e6db74">^~</span> <span style="color:#e6db74">/v1</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_buffering</span> <span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://upstream_api</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_http_version</span> <span style="color:#ae81ff">1</span><span style="color:#e6db74">.1</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Upgrade</span> $http_upgrade;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_connect_timeout</span> <span style="color:#e6db74">180s</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_read_timeout</span> <span style="color:#e6db74">180s</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_send_timeout</span> <span style="color:#e6db74">180s</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">location</span> ~ <span style="color:#e6db74">.*\.(gif|jpg|jpeg|png|bmp|swf)$</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://127.0.0.1:8082</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_redirect</span> <span style="color:#e6db74">default</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $remote_addr;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">add_header</span> <span style="color:#e6db74">Nginx-Cache</span> <span style="color:#e6db74">&#34;</span>$upstream_cache_status&#34;;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">expires</span> <span style="color:#e6db74">30d</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">location</span> ~ <span style="color:#e6db74">.*\.(js|css)?$</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">expires</span> <span style="color:#e6db74">12h</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">location</span> ~ <span style="color:#e6db74">/\.</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">deny</span> <span style="color:#e6db74">all</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 过滤只允许GET，HEAD和POST方法请求
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">if</span> <span style="color:#e6db74">(</span>$request_method <span style="color:#e6db74">!~</span> <span style="color:#e6db74">^(GET|HEAD|POST)</span>$ <span style="color:#e6db74">)</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">return</span> <span style="color:#ae81ff">444</span>;
</span></span><span style="display:flex;"><span>	}   
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">### 阻止User-Agents,如扫描器，机器人以及滥用你服务器的垃圾邮件发送者。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">if</span> <span style="color:#e6db74">(</span>$http_user_agent ~<span style="color:#e6db74">*</span> <span style="color:#e6db74">LWP::Simple|BBBike|wget|&#34;Windows</span> <span style="color:#ae81ff">5</span><span style="color:#e6db74">.1&#34;)</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">return</span> <span style="color:#ae81ff">405</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->禁止<!-- raw HTML omitted --><code>IP</code><!-- raw HTML omitted -->访问<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><a href="https://developer.aliyun.com/article/548497" rel="external" target="_self"><code>Nginx</code>禁止<code>IP</code>访问 只允许域名访问</a></li>
<li><!-- raw HTML omitted -->方式一<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">listen</span> <span style="color:#ae81ff">80</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">server_name</span> <span style="color:#e6db74">www.domain.com</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">if</span> <span style="color:#e6db74">(</span>$host <span style="color:#e6db74">!=</span> <span style="color:#e6db74">&#39;www.domain.com&#39;)</span>{ <span style="color:#f92672">return</span> <span style="color:#ae81ff">403</span>; }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->方式二<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->添加一个<!-- raw HTML omitted --><code>server</code>，<!-- raw HTML omitted -->新加的<!-- raw HTML omitted --><code>server</code><!-- raw HTML omitted -->（注意是新增，并不是在原有的<!-- raw HTML omitted --><code>server</code><!-- raw HTML omitted -->基础上修改） <!-- raw HTML omitted --></li>
<li><code>rewrite</code><!-- raw HTML omitted -->重定向<!-- raw HTML omitted --></li>
</ul>
<table>
<thead>
<tr>
<th>开始字符</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>.</code></td>
<td>匹配除换行符以外的任意字符</td>
</tr>
<tr>
<td><code>?</code></td>
<td>重复0次或1次</td>
</tr>
<tr>
<td><code>+</code></td>
<td>重复1次或多次</td>
</tr>
<tr>
<td><code>*</code></td>
<td>最少连接数、那个机器连接数少就分发</td>
</tr>
<tr>
<td><code>\d</code></td>
<td>匹配数字</td>
</tr>
<tr>
<td><code>^</code></td>
<td>匹配字符串的开始</td>
</tr>
<tr>
<td><code>$</code></td>
<td>匹配字符串的结束</td>
</tr>
<tr>
<td><code>{n}</code></td>
<td>重复<code>n</code>此</td>
</tr>
<tr>
<td><code>{n,}</code></td>
<td>重复<code>n</code>或更多次</td>
</tr>
<tr>
<td><code>[c]</code></td>
<td>匹配单个字符<code>c</code></td>
</tr>
<tr>
<td><code>[a-z]</code>，<code>[A-Z]</code></td>
<td>匹配<code>a-z</code>小写字母的任意一个，<code>[^a-z]</code>表示取反，匹配<code>A-z</code>大写字母中任意一个，<code>[^A-Z]</code>表示取反</td>
</tr>
<tr>
<td><code>[0-9]</code></td>
<td>匹配<code>0-9</code>数字的任意一个，<code>[^0-9]</code>表示取反</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>结尾定义字符</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>last</code></td>
<td>匹配完成后，继续向下匹配新的<code>location URL</code>规则</td>
</tr>
<tr>
<td><code>break</code></td>
<td>匹配完成即停止向下匹配</td>
</tr>
<tr>
<td><code>redirect</code></td>
<td>返回302临时重定向、地址栏会显示跳转后地址</td>
</tr>
<tr>
<td><code>permanent</code></td>
<td>返回301永久重定向、地址栏会显示跳转后地址</td>
</tr>
</tbody>
</table>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">listen</span> <span style="color:#ae81ff">80</span> <span style="color:#e6db74">dufault</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">server_name</span> <span style="color:#e6db74">_</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">return</span> <span style="color:#ae81ff">403</span>;  	<span style="color:#75715e"># 直接返回一个403
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^(.*)</span> <span style="color:#e6db74">http://domain.com</span> <span style="color:#e6db74">permanent</span>;  	<span style="color:#75715e"># 或者跳转到其他域名
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 禁止IP访问 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">server</span> { 
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">listen</span> <span style="color:#ae81ff">80</span> <span style="color:#e6db74">default</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">server_name</span> <span style="color:#e6db74">_</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">server_name</span>  <span style="color:#e6db74">domain.com</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">return</span> <span style="color:#ae81ff">500</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></blockquote>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->文件下载<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 启用目录浏览
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">autoindex</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 设置为off 时，显示文件大小，易于理解的单位（如 KB、MB 等）。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#f92672">autoindex_exact_size</span> <span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 设置为on 时，显示的时间将根据服务器的本地时间来显示
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#f92672">autoindex_localtime</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">location</span> ~ {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->日志切割<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">if</span> <span style="color:#e6db74">(</span>$time_iso8601 ~ <span style="color:#e6db74">&#34;^(\d</span>{<span style="color:#f92672">4})-(\d{2})-(\d{2})&#34;)</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">set</span> $year $1;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">set</span> $month $2;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">set</span> $day $3;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">error_page</span> <span style="color:#ae81ff">404</span> <span style="color:#e6db74">http://domain.com</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">access_log</span>  <span style="color:#e6db74">/home/logs/nginx/domain.access_</span>$year-$month-$day.log  <span style="color:#e6db74">main</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">error_log</span>   <span style="color:#e6db74">/home/logs/nginx/domain.error.log</span>  <span style="color:#e6db74">info</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->配置跳转<!-- raw HTML omitted --><code>Web</code><!-- raw HTML omitted -->或<!-- raw HTML omitted --><code>H5</code></li>
</ul>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://blog.csdn.net/weixin_34128501/article/details/91370181?utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-4.vipsorttest&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-4.vipsorttest" rel="external" target="_self"><code>nginx</code>配置手机端<code>PC</code>端访问不同的项目</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://blog.csdn.net/weixin_37008947/article/details/105725236" rel="external" target="_self"><code>nginx</code>根据<code>PC</code>端还是手机端设置不同的网站根目录</a></td>
<td></td>
</tr>
</tbody>
</table>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">root</span> <span style="color:#e6db74">/var/www/web/pc</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">index</span>  <span style="color:#e6db74">index.php</span> <span style="color:#e6db74">index.html</span> <span style="color:#e6db74">index.htm</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">location</span> <span style="color:#e6db74">^~</span> <span style="color:#e6db74">/api</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^/api/(.*)</span>$ <span style="color:#e6db74">/</span>$1 <span style="color:#e6db74">break</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://swofit/</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Real-IP</span> $remote_addr;
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Real-Port</span> $remote_port;
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># 如果是手机移动端访问内容
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">if</span> <span style="color:#e6db74">(</span> $http_user_agent ~<span style="color:#e6db74">*</span> <span style="color:#e6db74">&#34;(MIDP)|(WAP)|(UP.Browser)|(Smartphone)|(Obigo)|(Mobile)|(AU.Browser)|(wxd.Mms)|(WxdB.Browser)|(CLDC)|(UP.Link)|(KM.Browser)|(UCWEB)|(SEMC-Browser)|(Mini)|(Symbian)|(Palm)|(Nokia)|(Panasonic)|(MOT-)|(SonyEricsson)|(NEC-)|(Alcatel)|(Ericsson)|(BENQ)|(BenQ)|(Amoisonic)|(Amoi-)|(Capitel)|(PHILIPS)|(SAMSUNG)|(Lenovo)|(Mitsu)|(Motorola)|(SHARP)|(WAPPER)|(LG-)|(LG/)|(EG900)|(CECT)|(Compal)|(kejian)|(Bird)|(BIRD)|(G900/V1.0)|(Arima)|(CTL)|(TDG)|(Daxian)|(DAXIAN)|(DBTEL)|(Eastcom)|(EASTCOM)|(PANTECH)|(Dopod)|(Haier)|(HAIER)|(KONKA)|(KEJIAN)|(LENOVO)|(Soutec)|(SOUTEC)|(SAGEM)|(SEC-)|(SED-)|(EMOL-)|(INNO55)|(ZTE)|(iPhone)|(ipad)|(Android)|(Windows</span> <span style="color:#e6db74">CE)|(Wget)|(Java)|(curl)|(Opera)|(htc)|(blackberry)&#34;</span> <span style="color:#e6db74">)</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">root</span> <span style="color:#e6db74">/var/www/web/mobile</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">index</span> <span style="color:#e6db74">index.html</span> <span style="color:#e6db74">index.htm</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">try_files</span> $uri $uri/ <span style="color:#e6db74">@router</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">location</span> ~ <span style="color:#e6db74">.*\.(gif|jpg|jpeg|png|bmp|swf)$</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">expires</span>      <span style="color:#e6db74">30d</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">location</span> ~ <span style="color:#e6db74">.*\.(js|css)?$</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">expires</span>      <span style="color:#e6db74">12h</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">location</span> ~ <span style="color:#e6db74">/\.</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">deny</span> <span style="color:#e6db74">all</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">if</span> <span style="color:#e6db74">(</span>$time_iso8601 ~ <span style="color:#e6db74">&#34;^(\d</span>{<span style="color:#f92672">4})-(\d{2})-(\d{2})&#34;)</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">set</span> $year $1;
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">set</span> $month $2;
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">set</span> $day $3;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">error_page</span> <span style="color:#ae81ff">404</span> <span style="color:#e6db74">http://domian.com</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">access_log</span>  <span style="color:#e6db74">/home/logs/nginx/domain.access_</span>$year-$month-$day.log  <span style="color:#e6db74">main</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">error_log</span>   <span style="color:#e6db74">/home/logs/nginx/domain.error.log</span>  <span style="color:#e6db74">info</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 或者使用下面方法、try_files用于按顺序检测文件是否存在，如果存在就返回文件内容，如果不存在，则进行配的对应规则
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">root</span> <span style="color:#e6db74">/opt/www/cms-web</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">index</span>  <span style="color:#e6db74">index.html</span> <span style="color:#e6db74">index.htm</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">try_files</span> $uri $uri/ <span style="color:#e6db74">/index.html</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">location</span> <span style="color:#e6db74">/m/</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">alias</span> <span style="color:#e6db74">/opt/www/cms-web/m/</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">index</span>  <span style="color:#e6db74">index.html</span> <span style="color:#e6db74">index.htm</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">try_files</span> $uri $uri/ <span style="color:#e6db74">/m/index.html</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></blockquote>
<ul>
<li><code>Nginx</code><!-- raw HTML omitted -->代理<!-- raw HTML omitted --><code>Gitlab</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">listen</span> <span style="color:#ae81ff">80</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">listen</span> <span style="color:#ae81ff">443</span> <span style="color:#e6db74">ssl</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">listen</span> <span style="color:#ae81ff">8081</span> <span style="color:#e6db74">ssl</span> <span style="color:#e6db74">default_server</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 此域名是提供给最终用户的访问地址
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">server_name</span> <span style="color:#e6db74">gitlab.com</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 避免直接返回 404，而是返回应用的主入口
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">try_files</span> $uri $uri/ <span style="color:#e6db74">/index.html</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 主页面不允许缓存（避免项目升级 空白页的问题）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">location</span> <span style="color:#e6db74">/index.html</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">add_header</span> <span style="color:#e6db74">Expires</span> <span style="color:#e6db74">-1</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">add_header</span> <span style="color:#e6db74">Cache-Control</span> <span style="color:#e6db74">no-cache</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># 这个非常重要，如果git库里有大文件，设置太小，文件push会失败，根据情况调整
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">client_max_body_size</span> <span style="color:#ae81ff">50m</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_redirect</span> <span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># 以下确保 gitlab中项目的 url 是域名而不是 http://git，不可缺少
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Real-IP</span> $remote_addr;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># 升级协议头 websocket
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">proxy_http_version</span> <span style="color:#ae81ff">1</span><span style="color:#e6db74">.1</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Upgrade</span> $http_upgrade;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Connection</span> <span style="color:#e6db74">&#34;upgrade&#34;</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># 升级协议头为https
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Upgrade-Insecure-Requests</span> <span style="color:#ae81ff">1</span>;   
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-Proto</span> <span style="color:#e6db74">https</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">add_header</span> <span style="color:#e6db74">Content-Security-Policy</span> <span style="color:#e6db74">upgrade-insecure-requests</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># nginx 反向代理到 gitlab 容器暴露的端口
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://127.0.0.1:8080</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">index</span> <span style="color:#e6db74">index.html</span> <span style="color:#e6db74">index.htm</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">error_page</span> <span style="color:#ae81ff">404</span> <span style="color:#e6db74">http://gitlab.com</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">access_log</span>  <span style="color:#e6db74">/usr/local/nginx/logs/gitlab.access.log</span>  <span style="color:#e6db74">main</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">error_log</span>   <span style="color:#e6db74">/usr/local/nginx/logs/gitlab.error.log</span>  <span style="color:#e6db74">info</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">}</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted --><!-- raw HTML omitted --></li>
</ul>
</blockquote>
</blockquote>
<hr>
<h3 id="nginx集群反向代理"><code>nginx</code>集群，反向代理</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->集群介绍<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>集群就是一组相互独立的计算机，利用高速相同的通信网络组成一个较大的计算机服务系统，每个集群节点都可以各自运行服务，并且能彼此通信，协同向客户提供服务。统一管理的模式。用户请求集群系统时，集群系统给用户的感受是一个单独的服务器，实际上用户请求的是一组集群服务器</li>
<li>打开谷歌、百度的页面，看到起来是好简单、也许你觉得几分钟可以制作出类似的网页，而实际上，这个页面背后是由成千上万台服务器协同工作的结果。那么多台服务器维护和管理，以及相互协调工作就是读者未来的工作职责</li>
<li>一般是指在集群中任意一个节点失效的情况下，该节点上的所有任务会自动转移到其他正常的节点上。此过程并不影响整个集群的运行</li>
<li>当集群中的一个节点系统发生故障时，运行着的集群服务会迅速做出反应，将该系统的服务分配到集群中其他正在工作的系统上运行。考虑到计算机硬件和软件的容错性，高可用性集群的主要目的是使集群的整体服务尽可能可用。如果高可用性集群中的主节点发生了故障，那么这段时间内将由备节点代替它。备节点通常是主节点的镜像。当它代替主节点时，它可以完全接管主节点（包括<code>IP</code>地址及其他资源）提供服务，因此，使集群系统环境对于用户来说是一致的，即不会影响用户的访问。高可用性集群使服务器系统的运行速度和响应速度会尽可能的快。它们经常利用在多台机器上运行的冗余节点和服务来相互跟踪。如果某个节点失败，它的替补者将在几秒钟或更短时间内接管它的职责。因此，对于用户而言，集群里的任意一台机器宕机，业务都不会受影响</li>
<li>高性能计算集群也称并行计算。通常，高性能计算集群涉及为集群开发的并行应用程序，以解决复杂的科学问题（天气预报、石油勘探、核反应模拟等）。高性能计算集群对外就好像一个超级计算机，这种超级计算机内部由数十至上万个独立服务器组成，并且在公共消息传递层上进行通信以运行并行应用程序。在老男孩的工作中实际是把任务切成蛋糕，然后下发到集群节点计算，计算后返回结果，然后继续领新任务计算，如此往复</li>
</ul>
</blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->集群的优势特点<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->高性能<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->廉价性<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->可伸缩性<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->高可用性<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->透明性<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->可管理性<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->可编程性<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->集群分类<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->负载均衡集群<!-- raw HTML omitted -->(<code>Load balancing clusters</code>)简称<code>LBC</code>或者<code>LB</code></li>
<li><!-- raw HTML omitted -->高可用性集群<!-- raw HTML omitted -->(<code>High-availavlability (HA) clusters</code>)简称<code>HAC</code></li>
<li><!-- raw HTML omitted -->高性能计算集群<!-- raw HTML omitted -->(<code>Hight-perfomance (HPC) clusters</code>)简称<code>HPC</code></li>
<li><!-- raw HTML omitted -->网格计算<!-- raw HTML omitted -->(<code>Grid computing</code>)</li>
</ul>
</blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->负载均衡集群<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>负载均衡集群为了强企业提供更为实用、性价比更高的系统架构解决方案。负载均衡集群可以将很多客户集中访问负载压力尽可能地平均分摊在计算机集群中处理。客户访问请求负载包括应用程序处理负载和网络流量负载。这样使同一组应用程序为大量用户提供服务的模式，每个节点都可以承担一定的访问求负载压力并且可以实现访问请求在各节点之间动态分配，以实现负载均衡</li>
<li>负载均衡（<code>LoadBalance</code>）集群提供了一种廉价、有效、透明的方法，来扩展网络设备和服务器的负载、带宽和吞吐量，同时加强了网络数据处理能力，提高了网络的灵活性和可用性</li>
<li>把单台计算机无法承受的大规模并发访问或数据流量分担到多台节点设备上，分别进行处理，减少用户等待响应的时间，提升用户体验</li>
<li>单个重负载的运算分担到多台节点设备上做并行处理，每个节点设备处理结束后，将结果汇总，返回给用户，系统处理能力得到大幅度提高</li>
<li><code>7×24</code>小时的服务保证，任意一个或多个有限后面节点设备宕机，不能影响业务</li>
<li>在负载均衡集群中，同组集群的所有计算机节点都应该提供相同的服务。集群负载均衡器会截获所有对该服务的入站请求。然后将这些请求尽可能地平均地分配在所有集群节点上</li>
</ul>
</blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->负载均衡集群的作用 <!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->分担用户访问请求及数据流量（负载均衡） - 保持业务连续性，即<!-- raw HTML omitted --><code>7×24</code><!-- raw HTML omitted -->小时服务（高可用性）<!-- raw HTML omitted --></li>
<li>于<code>Web</code><!-- raw HTML omitted -->业务及数据库从库等服务器的业务<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->负载均衡集群典型的开源软件包括<!-- raw HTML omitted --><code>LVS</code>、<code>Nginx</code>、<code>Haproxy</code>等</li>
<li><!-- raw HTML omitted -->高可用性集群的作用 <!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->当一台机器宕机时，另外一台机器接管宕机的机器的<!-- raw HTML omitted --><code>IP</code><!-- raw HTML omitted -->资源和服务资源，提供服务<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->常用于不易实现负载均衡的应用，比如负载均衡器，主数据库、主存储对之间<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->高可用性集群常用的开源软件包括<!-- raw HTML omitted --><code>Keepalived</code>、<code>Heartbeat</code>等</li>
</ul>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->运维中常见的集群软硬件产品<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>互联网企业常用的开源集群软件有：<code>Nginx</code>、<code>LVS</code>、<code>Haproxy</code>、<code>Keepalived</code>、<code>Heartbeat</code>。互联网企业常用的商业集群硬件有：<code>F5</code>、<code>Netscaler</code>、<code>Rad-ware</code>、<code>A10</code>等，工作模式相当于<code>Haproxy</code>的工作模式。淘宝、赶集网、新浪等公司曾使用过<code>Netscaler</code>负载均衡产品。集群硬件<code>Netscaler</code>的产品</li>
</ul>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->集群软硬件产品如何选型<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>当企业业务重要，技术力量又薄弱，并且希望出钱购买产品及获取更好的服务时，可以选择硬件负载均衡产品，如<code>F5</code>、<code>Netscaler</code>、<code>Radware</code>等，此类公司多为传统的大型非互联网企业，如银行、证券、金融业及宝马、奔驰公司等</li>
<li>对于门户网站来说，大多会并用软件及硬件产品来分担单一产品的风险，如淘宝、腾讯、新浪等。融资了的企业会购买硬件产品，如赶集等网站</li>
<li>中小型互联网企业，由于起步阶段无利润可赚或者利润很低，会希望通过使用开源免费的方案来解决问题，因此会雇佣专门的运维人员进行维护。例如：<code>51CTO</code>等</li>
</ul>
</blockquote>
<p>相比较而言，商业的负载均衡产品成本高，性能好，更稳定，缺点是不能二次开发，开源的负载均衡软件对运维人员的能力要求较高，如果运维及开发能力强，那么开源的负载均衡软件是不错的选择，目前的互联网行业更倾向于使用开源的负载均衡软件</p>
<ul>
<li><!-- raw HTML omitted -->如何选择开源集群软件产品<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>中小企业互联网公司网站在并发访问和总访问量不是很大的情况下，建议首选<code>Nginx</code>负载均衡，理由是<code>Nginx</code>负载均衡配置简单、使用方便、安全稳定、社区活跃，使用的人逐渐增多，成为流行趋势，另外一个实现负载均衡的类似产品为<code>Haproxy</code>（支持<code>L4</code>和<code>L7</code>负载，同样优秀，但社区不如<code>Nginx</code>活跃）</li>
<li>如果要考虑<code>Nginx</code>负载均衡的高可用功能，建议首选<code>Keepalived</code>软件，理由是安装和配置简单，使用方便，安全稳定，与<code>Keepalived</code>服务类似的高可用软件还有<code>Heartbeat</code>（使用比较复杂，不建议初学者使用）</li>
<li>如果是大型企业互联网公司，负载均衡产品可以使用<code>LVS</code>+<code>Keepalived</code>在前端做四层转发（一般是主备或主主，如果需要扩展可以使用<code>DNS</code>或前端使用<code>OSPF</code>），后端使用<code>Nginx</code>或者<code>Haproxy</code>做<code>7</code>层转发（可以扩展到百台），再后面是应用服务器，如果是数据库与存储的负载均衡和高可用，建议选择<code>LVS</code>+<code>Heart-beat</code>，<code>LVS</code>支持<code>TCP</code>转发且<code>DR</code>模式效率很高，<code>Heartbeat</code>可以配合<code>drbd</code>，不但可以进行<code>VIP</code>的切换，还可以支持块设备级别的数据同步（<code>drbd</code>），以及资源服务的管理</li>
</ul>
</blockquote>
</blockquote>
<ul>
<li>
<ol start="6">
<li><!-- raw HTML omitted -->反向代理与负载均衡概念<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>严格地说，<code>Nginx</code>仅仅是作为<code>Nginx Proxy</code>反向代理使用的，因为这个反向代理功能表现的效果是负载均衡集群的效果，所以本文称之为<code>Nginx</code>负载均衡。那么，反向代理和负载均衡有什么区别呢？</li>
<li>普通负载均衡软件，例如大名鼎鼎的<code>LVS</code>，其实现的功能只是对请求数据包的转发（也可能会改写数据包）、传递，其中<code>DR</code>模式明显的特征是从负载均衡下面的节点服务器来看，接收到的请求还是来自访问负载均衡器的客户端的真实用户，而反向代理就不一样了，反向代理接收访问用户的请求后，会代理用户重新发起请求代理下的节点服务器，最后把数据返回给客户端用户，在节点服务器看来，访问的节点服务器的客户端用户就是反向代理服务器了，而非真实的网站访问用户</li>
<li>一句话，<code>LVS</code>等的负载均衡是转发用户请求的数据包，而<code>Nginx</code>反向代理是接收用户的请求然后重新发起请求去请求其后面的节点。2. 实现<code>Nginx</code>负载均衡的组件说明实现<code>Nginx</code>负载均衡的组件主要有两个</li>
</ul>
<p><a href="#R-image-34b1d2e44830ddf4764d16278c7c3b05" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="http://static.zybuluo.com/WindWhisperer/37fcolxnhiou5s9t0pb0vm8l/image_1akuo4vrcpke1vb010f3rdd14gi9.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-34b1d2e44830ddf4764d16278c7c3b05"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="http://static.zybuluo.com/WindWhisperer/37fcolxnhiou5s9t0pb0vm8l/image_1akuo4vrcpke1vb010f3rdd14gi9.png"></a></p>
<p><a href="#R-image-5e5195480a4d7a15375816691e36d36b" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="http://static.zybuluo.com/WindWhisperer/xd2ms7ck0a33wxf36vwwktgs/image_1akv2ig1519723ljs261b4d1kbo9.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-5e5195480a4d7a15375816691e36d36b"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="http://static.zybuluo.com/WindWhisperer/xd2ms7ck0a33wxf36vwwktgs/image_1akv2ig1519723ljs261b4d1kbo9.png"></a></p>
<p><a href="#R-image-dc903f4f4ff380920701e9233dba5db4" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="http://static.zybuluo.com/WindWhisperer/7dalazu3amny9rg192ing2l9/image_1akv2hcu286b1piavpv9jdsunm.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-dc903f4f4ff380920701e9233dba5db4"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="http://static.zybuluo.com/WindWhisperer/7dalazu3amny9rg192ing2l9/image_1akv2hcu286b1piavpv9jdsunm.png"></a></p>
<p><a href="#R-image-72500c577b95347eab7d539380f8978d" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="http://static.zybuluo.com/WindWhisperer/c4i7xy39l9tymsjbb0fem2l1/image_1akv8kcjorbhsq917bq9h382t13.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-72500c577b95347eab7d539380f8978d"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="http://static.zybuluo.com/WindWhisperer/c4i7xy39l9tymsjbb0fem2l1/image_1akv8kcjorbhsq917bq9h382t13.png"></a></p>
<p><a href="#R-image-72f249953844b3b2e38a72c3c1ec2d82" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="http://static.zybuluo.com/WindWhisperer/f3esrb2do4bgexfvltp6l9im/%E5%8F%82%E6%95%B01.jpg" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-72f249953844b3b2e38a72c3c1ec2d82"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="http://static.zybuluo.com/WindWhisperer/f3esrb2do4bgexfvltp6l9im/%E5%8F%82%E6%95%B01.jpg"></a></p>
<p><a href="#R-image-d2dd0ab92405dc0c425e1b3e94fd235f" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="http://static.zybuluo.com/WindWhisperer/x676usyjxgo3idhklzrkqaz5/%E5%8F%82%E6%95%B02.jpg" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-d2dd0ab92405dc0c425e1b3e94fd235f"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="http://static.zybuluo.com/WindWhisperer/x676usyjxgo3idhklzrkqaz5/%E5%8F%82%E6%95%B02.jpg"></a></p>
<p><a href="#R-image-cf14a1afcbf1616a66afd09a7d6e5ab0" class="lightbox-link"><img class="border lazy lightbox noshadow figure-image" loading="lazy" src="http://static.zybuluo.com/WindWhisperer/i9cazzd6tqyik5hpa0opxjuc/image_1akvc4rs112et1noc12s3d711h49.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-cf14a1afcbf1616a66afd09a7d6e5ab0"><img class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="http://static.zybuluo.com/WindWhisperer/i9cazzd6tqyik5hpa0opxjuc/image_1akvc4rs112et1noc12s3d711h49.png"></a></p>
<ul>
<li><!-- raw HTML omitted -->实现负载均衡组件说明<!-- raw HTML omitted --></li>
</ul>
<table>
<thead>
<tr>
<th><code>Nginx http</code>功能模块</th>
<th>模块说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ngx_http_proxy_module</code></td>
<td><code>proxy</code>代理模块，用户把请求抛给节点服务器或<code>upstream</code>服务池</td>
</tr>
<tr>
<td><code>ngx_http_upstream_module</code></td>
<td>负载均衡模块，可以实现网站负载均衡功能及节点健康检查</td>
</tr>
</tbody>
</table>
<ul>
<li><code>nginx upstream</code><!-- raw HTML omitted -->模块<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>Nginx</code>的负载均衡基于<code>ngx_http_upstream_module</code>所支持的代理方式包括<code>proxy_pass</code>、<code>fastcgi_pass</code>、<code>memcached_pass</code>等</li>
<li><code>rr</code><!-- raw HTML omitted -->：轮询（性能相近，业务一样）<!-- raw HTML omitted --></li>
<li><code>wrr</code><!-- raw HTML omitted -->：权重轮询<!-- raw HTML omitted --></li>
<li><code>ip_hash;</code><!-- raw HTML omitted -->：每个请求按访问<!-- raw HTML omitted --><code>IP</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>hash</code><!-- raw HTML omitted -->结果分配、同一个<!-- raw HTML omitted --><code>IP</code><!-- raw HTML omitted -->固定访问同一个后端服务器<!-- raw HTML omitted --></li>
<li><code>hash $request_uri;</code><!-- raw HTML omitted -->：每个请求按访问<!-- raw HTML omitted --><code>IP</code>的<code>hash</code><!-- raw HTML omitted -->结果分配、同一个<!-- raw HTML omitted --><code>IP</code><!-- raw HTML omitted -->固定访问同一个后端服务器<!-- raw HTML omitted -->，<code>$cookie_jsessionid;</code><!-- raw HTML omitted -->按照后端分配<!-- raw HTML omitted --><code>JSESSIONID</code><!-- raw HTML omitted -->进行负载<!-- raw HTML omitted --></li>
<li><code>least_conn;</code><!-- raw HTML omitted -->：最少连接数、分配给连接数最少的后端服务器<!-- raw HTML omitted --></li>
<li><code>server IP:port xxx;</code><!-- raw HTML omitted -->：字段<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>down;</code><!-- raw HTML omitted -->： 当前<!-- raw HTML omitted --><code>server</code><!-- raw HTML omitted -->暂时不参与负载均衡<!-- raw HTML omitted --></li>
<li><code>backup;</code><!-- raw HTML omitted -->：预留备份服务器，只有主参与节点<!-- raw HTML omitted --><code>down</code>掉才启用</li>
<li><code>weigh=3;</code><!-- raw HTML omitted -->：加权轮询、值越大分配到访问几率越高<!-- raw HTML omitted --></li>
<li><code>check=3</code><!-- raw HTML omitted -->：开启对该服务器健康检查<!-- raw HTML omitted --></li>
<li><code>inter</code><!-- raw HTML omitted -->：设置连续两次健康检查的间隔时间，单位毫秒，默认值<!-- raw HTML omitted --><code>2000</code></li>
<li><code>rise</code><!-- raw HTML omitted -->：指定多少次连续成功健康检查后，即可认定服务器可用状态<!-- raw HTML omitted --></li>
<li><code>max_fails=3</code><!-- raw HTML omitted -->：指定多少次不成功后，即认为宕机状态，默认值<!-- raw HTML omitted --><code>1</code></li>
<li><code>fail_timeout=10 </code><!-- raw HTML omitted -->：经过<!-- raw HTML omitted --><code>max_fails</code><!-- raw HTML omitted -->失败后，在<!-- raw HTML omitted --><code>fail_timeout</code><!-- raw HTML omitted -->时间内不再去请求它，<!-- raw HTML omitted --><code>fail_timeout</code><!-- raw HTML omitted -->默认是<!-- raw HTML omitted --><code>10s</code></li>
<li><code>maxconn：</code>：</li>
</ul>
</blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 负载均衡UDP转发</span>
</span></span><span style="display:flex;"><span>stream <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    upstream dns <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 每个请求按访问IP的hash结果分配、同一个IP固定访问同一个后端服务器</span>
</span></span><span style="display:flex;"><span>        ip_hash;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 最少连接数、分配给连接数最少的后端服务器</span>
</span></span><span style="display:flex;"><span>        least_conn;
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># 当前server暂时不参与负载均衡</span>
</span></span><span style="display:flex;"><span>        server 192.168.111.99:10086 down;
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># 预留备份服务器，只有主参与节点down掉才启用</span>
</span></span><span style="display:flex;"><span>        server 192.168.111.100:10086 weigh<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> backup;
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># weigh：加权轮询、值越大分配到访问几率越高，max_fails：允许请求失败次数，fail_timeout：经过max_fails失败后，服务暂定时间、mac_conns：限制最大连接数</span>
</span></span><span style="display:flex;"><span>        server 192.168.111.100:10086 weigh<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> max_fails<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> fail_timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span> max_conns<span style="color:#f92672">=</span>128;
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># 向上游服务器保留的连接数</span>
</span></span><span style="display:flex;"><span>        keepalive 300;
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># 连接保留时间、默认60秒，</span>
</span></span><span style="display:flex;"><span>		keepalive_timeout 60;
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># 一个Tcp复用中可以并发接收的请求数</span>
</span></span><span style="display:flex;"><span>		keepalive_requests 1000;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div><div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>check interval<span style="color:#f92672">=</span><span style="color:#ae81ff">3000</span> rise<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> fall<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span> timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">1000</span> type<span style="color:#f92672">=</span>http;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># check interval=3000 rise=2 fall=5 timeout=1000 type=http;</span>
</span></span><span style="display:flex;"><span>上面配置的意思是，对static、upload、这个负载均衡条目中的所有节点，每隔3秒检测一次，请求2次正常则标记realserver状态为up，如果检测5次都失败，则标记realserver的状态为down，超时时间为1秒，检查的协议是http。</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->配置转发到<!-- raw HTML omitted --><code>Mysql</code></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->添加<!-- raw HTML omitted --><code>--with-stream</code><!-- raw HTML omitted -->模块支持<!-- raw HTML omitted --><code>TCP/UDP</code><!-- raw HTML omitted -->协议<!-- raw HTML omitted --></li>
<li><a href="https://cloud.tencent.com/developer/article/1768431" rel="external" target="_self"><code>Nginx</code>代理转发<code>Mysql</code></a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ nginx -V
</span></span><span style="display:flex;"><span>configure arguments: --prefix<span style="color:#f92672">=</span>/usr/local/nginx --with-stream</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->配置<!-- raw HTML omitted --><code>Nginx</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>conf</code><!-- raw HTML omitted -->文件中<!-- raw HTML omitted --><code>server</code><!-- raw HTML omitted -->字段<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">stream</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">upstream</span> <span style="color:#e6db74">cloudsocket</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">hash</span> $remote_addr <span style="color:#e6db74">consistent</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">server</span> 192.168.182.155:<span style="color:#ae81ff">3306</span> <span style="color:#e6db74">weight=5</span> <span style="color:#e6db74">max_fails=3</span> <span style="color:#e6db74">fail_timeout=30s</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">listen</span> <span style="color:#ae81ff">3306</span>;     <span style="color:#75715e"># 数据库服务器监听端口
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">proxy_connect_timeout</span> <span style="color:#e6db74">10s</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_timeout</span> <span style="color:#e6db74">300s</span>;      <span style="color:#75715e"># 客户端与代理之间的超时时间，如果5分钟内没操作将自动断开。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">cloudsocket</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 负载均衡UDP转发
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">stream</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">upstream</span> <span style="color:#e6db74">dns</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">ip_hash</span>;  	<span style="color:#75715e"># 每个请求按访问IP的hash结果分配、同一个IP固定访问同一个后端服务器
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">hash</span> $request_uri;  	<span style="color:#75715e"># 按照访问URL的hash结果分配请求、每个URL定向到同一个后端服务器
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">least_conn</span>;  	<span style="color:#75715e"># 最少连接数、分配给连接数最少的后端服务器
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">server</span> 192.168.111.99:<span style="color:#ae81ff">10086</span> <span style="color:#e6db74">down</span>;  	<span style="color:#75715e"># 当前server暂时不参与负载均衡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">server</span> 192.168.111.100:<span style="color:#ae81ff">10086</span> <span style="color:#e6db74">backup</span>;  	<span style="color:#75715e"># 预留备份服务器，只有主参与节点down掉才启用
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">server</span> 192.168.111.100:<span style="color:#ae81ff">10086</span> <span style="color:#e6db74">weigh=3</span> <span style="color:#e6db74">max_fails=3</span> <span style="color:#e6db74">fail_timeout=10</span> <span style="color:#e6db74">max_conns=128</span>;  	<span style="color:#75715e"># weigh：加权轮询、值越大分配到访问几率越高，max_fails：允许请求失败次数，fail_timeout：经过max_fails失败后，服务暂定时间、mac_conns：限制最大连接数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">listen</span> 192.168.111.98:<span style="color:#ae81ff">10086</span> <span style="color:#e6db74">udp</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_responses</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_timeout</span> <span style="color:#e6db74">20s</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_bind</span> $server_addr:$remote_port;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">dns</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></blockquote>
</blockquote>
</blockquote>
<hr>
<h3 id="nginx使用lua脚本"><code>Nginx</code>使用<code>Lua</code>脚本</h3>
<blockquote>
<ul>
<li><code>set_by_lua</code><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>Nginx</code><!-- raw HTML omitted -->变量<!-- raw HTML omitted --></li>
<li><code>loa_by_lua</code><!-- raw HTML omitted -->日志<!-- raw HTML omitted --></li>
<li><code>access_by_lua</code><!-- raw HTML omitted -->访问控制<!-- raw HTML omitted --></li>
<li><code>rewrite_by_lua</code><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>uri</code></li>
<li><code>boy_filter_by_lua</code><!-- raw HTML omitted -->修改响应体<!-- raw HTML omitted --></li>
<li><code>header_filter_by_lua</code><!-- raw HTML omitted -->修改响应头<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listen</span> <span style="color:#ae81ff">80</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server_name</span> <span style="color:#e6db74">lua.erge.com</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">location</span> <span style="color:#e6db74">/lua</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">default_type</span> <span style="color:#e6db74">text/html</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 直接使用lua语言方式
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">content_by_lua</span> <span style="color:#e6db74">&#39;ngx_say(&#34;&lt;p&gt;Hello</span> <span style="color:#e6db74">World!!!&lt;/p&gt;&#34;)&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 引用lua脚本方式
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">content_by_lua_file</span> <span style="color:#e6db74">conf/lua/hello.lua</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><ul>
<li><code>lua</code><!-- raw HTML omitted -->脚本<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;conf/lua/hello.lua<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ngx_say(&#34;&lt;p&gt;Hello World!!!&lt;/p&gt;&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->获取<!-- raw HTML omitted --><code>Nginx</code><!-- raw HTML omitted -->请求头信息<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;conf/lua/headers.lua<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">local headers = ngx_req.get_headers()
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ngx.say(&#34;Host : &#34;, headers[&#34;Host&#34;], &#34;&lt;br/&gt;&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ngx.say(&#34;user-agent : &#34;, headers[&#34;user-agent&#34;], &#34;&lt;br/&gt;&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ngx.say(&#34;user-agent : &#34;, headers.user_agent, &#34;&lt;br/&gt;&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">for key, values in pairs(headers)do
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   if type(values) == &#39;table&#39; then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       ngx.say(key, &#34; : &#34;, table.concat(values, &#34;,&#34;), &#34;&lt;br/&gt;&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   else
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       ngx.say(key, &#34; : &#34;, values, &#34;&lt;br/&gt;&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   end
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">end
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->获取<!-- raw HTML omitted --><code>Post</code><!-- raw HTML omitted -->请求参数<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;conf/lua/post.lua<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ngx.req.read_body()
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ngx.say(&#34;Post Args Begin&#34;, &#34;&lt;br/&gt;&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">local post_args = ngx.req.get_post_args()
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">for key,values in pairs(post_args) do
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    if type(values) == &#34;table&#34; then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ngx.say(key, &#34; : &#34;, table.concat(values, &#34;, &#34;), &#34;&lt;br/&gt;&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    else
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ngx.say(key, &#34; : &#34;, values, &#34;&lt;br/&gt;&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    end
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">end
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->获取<!-- raw HTML omitted --><code>Nginx</code><!-- raw HTML omitted -->版本<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;conf/lua/nginx_version.lua<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ngx.say(&#34;http_version : &#34;, ngx.req.http_version(), &#34;&lt;br/&gt;&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->获取请求方法<!-- raw HTML omitted --><code>GET、POST、PUT</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;conf/lua/method.lua<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ngx.say(&#34;get_method : &#34;, ngx.req.get_method(), &#34;&lt;br/&gt;&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->原始的请求内容<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;conf/lua/original.lua<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ngx.say(&#34;raw_hader : &#34;, ngx.req.raw_header(), &#34;&lt;br/&gt;&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><code>body</code><!-- raw HTML omitted -->内容体<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;conf/lua/body.lua<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ngx.say(&#34;get_body_date() : &#34;, ngx.req.get_body_data(), &#34;&lt;br/&gt;&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><code>Nginx</code><!-- raw HTML omitted -->全局内存缓存<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;conf/lua/shared.lua<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">local shared_data = ngx.shared.shared_data  	# 获取缓存
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">local key = shared_data:get(&#34;key&#34;)  	# 缓存里面取值
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if not key then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    key = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    shared_data:set(&#34;key&#34;, key)  	# 调用set 方法
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ngx.say(&#34;lazy set key &#34;, key, &#34;&lt;br/&gt;&#34;)  	# 等于什么
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">end
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">key = shared_data:incr(&#34;key&#34;, 1)  	# 自增加一
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ngx.say(&#34;key=&#34;, key, &#34;&lt;br/&gt;&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><a href="https://github.com/openresty/lua-resty-lrucache" rel="external" target="_self"><code>lua-resty-lrucache</code></a><!-- raw HTML omitted -->缓存<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;conf/vhosts/server.conf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">server {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    listen 80;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    server_name lua.erge.com;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    location /lua {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        default_type text/html;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        # 直接使用lua语言方式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        content_by_lua &#39;ngx_say(&#34;&lt;p&gt;Hello World!!!&lt;/p&gt;&#34;)&#39;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        # 引用lua脚本方式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        content_by_lua_file conf/lua/hello.lua;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        content_by_lua_block {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            require(&#34;my/cache&#34;).go()
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="过滤登录和状态码">过滤登录和状态码</h3>
<blockquote>
<ul>
<li>脚本使用<code>nslookup</code>命令获取用户<code>IP</code>地址的远程主机名，并使用<code>curl</code>命令获取远程主机的状态码。然后，它将检查远程主机的域名和状态码是否在允许的列表中。如果是，则显示<code>Access granted</code>否则显示<code>Access denied</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 定义允许登录的域名和状态码</span>
</span></span><span style="display:flex;"><span>ALLOWED_DOMAINS<span style="color:#f92672">=(</span><span style="color:#e6db74">&#34;example.com&#34;</span> <span style="color:#e6db74">&#34;example.org&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>ALLOWED_STATUS_CODES<span style="color:#f92672">=(</span><span style="color:#e6db74">&#34;200&#34;</span> <span style="color:#e6db74">&#34;301&#34;</span> <span style="color:#e6db74">&#34;302&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 获取用户IP地址</span>
</span></span><span style="display:flex;"><span>USER_IP<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo $SSH_CLIENT | awk <span style="color:#e6db74">&#39;{print $1}&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 获取用户登录时远程主机的域名和状态码</span>
</span></span><span style="display:flex;"><span>REMOTE_DOMAIN<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>nslookup $USER_IP | awk -F<span style="color:#e6db74">&#39;=&#39;</span> <span style="color:#e6db74">&#39;/name/{print $2}&#39;</span> | sed <span style="color:#e6db74">&#39;s/\.$//&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>REMOTE_STATUS_CODE<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>curl -s -o /dev/null -I -w <span style="color:#e6db74">&#34;%{http_code}&#34;</span> http://$REMOTE_DOMAIN<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 检查远程主机的域名和状态码是否被允许</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34; </span><span style="color:#e6db74">${</span>ALLOWED_DOMAINS[*]<span style="color:#e6db74">}</span><span style="color:#e6db74"> &#34;</span> <span style="color:#f92672">=</span>~ <span style="color:#e6db74">&#34; </span><span style="color:#e6db74">${</span>REMOTE_DOMAIN<span style="color:#e6db74">}</span><span style="color:#e6db74"> &#34;</span> <span style="color:#f92672">]]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34; </span><span style="color:#e6db74">${</span>ALLOWED_STATUS_CODES[*]<span style="color:#e6db74">}</span><span style="color:#e6db74"> &#34;</span> <span style="color:#f92672">=</span>~ <span style="color:#e6db74">&#34; </span><span style="color:#e6db74">${</span>REMOTE_STATUS_CODE<span style="color:#e6db74">}</span><span style="color:#e6db74"> &#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;Access granted to </span>$REMOTE_DOMAIN<span style="color:#e6db74"> with status code </span>$REMOTE_STATUS_CODE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    exit <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;Access denied to </span>$REMOTE_DOMAIN<span style="color:#e6db74"> with status code </span>$REMOTE_STATUS_CODE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span></span></span></code></pre></div></blockquote>
<ul>
<li>示例脚本，它会过滤网站后台登录的<code>IP</code>地址和状态码，将不在预定义文件列表中的IP地址发送到<code>Telegram</code>通知组。</li>
</ul>
<blockquote>
<ul>
<li>脚本会检查远程主机的状态码是否为<code>200</code>。如果是，则它将从文件中检查远程主机的IP地址是否在允许的列表中。如果是，则显示<code>Access granted</code>，否则将发送<code>Telegram</code>告警，并显示<code>Access denied</code>。请注意，您需要将<code>YOUR_TELEGRAM_API_TOKEN</code>和<code>YOUR_TELEGRAM_CHAT_ID</code>替换为您自己的<code>Telegram API Token</code>和<code>Chat ID</code>。</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 预定义允许登录的IP地址列表文件</span>
</span></span><span style="display:flex;"><span>ALLOWED_IP_LIST<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;allowed_ips.txt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 定义Telegram通知组的API Token和Chat ID</span>
</span></span><span style="display:flex;"><span>TELEGRAM_API_TOKEN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;YOUR_TELEGRAM_API_TOKEN&#34;</span>
</span></span><span style="display:flex;"><span>TELEGRAM_CHAT_ID<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;YOUR_TELEGRAM_CHAT_ID&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 获取用户IP地址</span>
</span></span><span style="display:flex;"><span>USER_IP<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo $SSH_CLIENT | awk <span style="color:#e6db74">&#39;{print $1}&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 获取用户登录时远程主机的状态码</span>
</span></span><span style="display:flex;"><span>REMOTE_STATUS_CODE<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>curl -s -o /dev/null -I -w <span style="color:#e6db74">&#34;%{http_code}&#34;</span> http://example.com/login<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 检查远程主机的状态码是否为200</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;</span>$REMOTE_STATUS_CODE<span style="color:#e6db74">&#34;</span> -eq <span style="color:#e6db74">&#34;200&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 检查远程主机的IP地址是否在允许的列表中</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> grep -Fxq <span style="color:#e6db74">&#34;</span>$USER_IP<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span>$ALLOWED_IP_LIST<span style="color:#e6db74">&#34;</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        echo <span style="color:#e6db74">&#34;Access granted to </span>$USER_IP<span style="color:#e6db74"> with status code </span>$REMOTE_STATUS_CODE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        exit <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 发送Telegram告警</span>
</span></span><span style="display:flex;"><span>        MESSAGE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Unauthorized login attempt from IP </span>$USER_IP<span style="color:#e6db74"> with status code </span>$REMOTE_STATUS_CODE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        URL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://api.telegram.org/bot</span>$TELEGRAM_API_TOKEN<span style="color:#e6db74">/sendMessage&#34;</span>
</span></span><span style="display:flex;"><span>        curl -s -X POST $URL -d chat_id<span style="color:#f92672">=</span>$TELEGRAM_CHAT_ID -d text<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$MESSAGE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        echo <span style="color:#e6db74">&#34;Access denied to </span>$USER_IP<span style="color:#e6db74"> with status code </span>$REMOTE_STATUS_CODE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;Access denied to </span>$USER_IP<span style="color:#e6db74"> with status code </span>$REMOTE_STATUS_CODE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span></span></span></code></pre></div></blockquote>
<ul>
<li>示例脚本，用于过滤网站后台登录<code>URL</code>的<code>IP</code>地址和状态码，将不在预定义文件列表中的<code>IP</code>地址发送到<code>Telegram</code>通知组。</li>
</ul>
<blockquote>
<ul>
<li>脚本会发送一个<code>HTTP</code>请求来检查网站后台登录<code>URL</code>的<code>IP</code>地址和状态码。如果状态码为<code>200</code>，则它将从<code>HTTP</code>响应中提取远程主机的IP地址，并从文件中检查它是否在允许的列表中。如果是，则显示<code>Access granted</code>，否则将发送<code>Telegram</code>告警，并显示<code>Access denied</code>。请注意，您需要将<code>YOUR_TELEGRAM_API_TOKEN</code>和<code>YOUR_TELEGRAM_CHAT_ID</code>替换为您自己的<code>Telegram API Token</code>和<code>Chat ID</code>，并根据需要修改<code>LOGIN_URL</code>和<code>REQUEST_HEADERS</code>。</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 预定义允许登录的IP地址列表文件</span>
</span></span><span style="display:flex;"><span>ALLOWED_IP_LIST<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;allowed_ips.txt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 定义需要检查的网站后台登录URL和请求头信息</span>
</span></span><span style="display:flex;"><span>LOGIN_URL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://example.com/admin/login&#34;</span>
</span></span><span style="display:flex;"><span>REQUEST_HEADERS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-H &#39;User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:90.0) Gecko/20100101 Firefox/90.0&#39; -H &#39;Accept-Language: en-US,en;q=0.5&#39;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 定义Telegram通知组的API Token和Chat ID</span>
</span></span><span style="display:flex;"><span>TELEGRAM_API_TOKEN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;YOUR_TELEGRAM_API_TOKEN&#34;</span>
</span></span><span style="display:flex;"><span>TELEGRAM_CHAT_ID<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;YOUR_TELEGRAM_CHAT_ID&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 获取用户IP地址</span>
</span></span><span style="display:flex;"><span>USER_IP<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>curl -s -o /dev/null -w <span style="color:#e6db74">&#34;%{http_code}:%{remote_ip}&#34;</span> $LOGIN_URL -H <span style="color:#e6db74">&#34;</span>$REQUEST_HEADERS<span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 获取远程主机的状态码</span>
</span></span><span style="display:flex;"><span>REMOTE_STATUS_CODE<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;</span>$USER_IP<span style="color:#e6db74">&#34;</span> | cut -d<span style="color:#e6db74">&#39;:&#39;</span> -f1<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 检查远程主机的状态码是否为200</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;</span>$REMOTE_STATUS_CODE<span style="color:#e6db74">&#34;</span> -eq <span style="color:#e6db74">&#34;200&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 获取远程主机的IP地址</span>
</span></span><span style="display:flex;"><span>    REMOTE_IP<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;</span>$USER_IP<span style="color:#e6db74">&#34;</span> | cut -d<span style="color:#e6db74">&#39;:&#39;</span> -f2<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 检查远程主机的IP地址是否在允许的列表中</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> grep -Fxq <span style="color:#e6db74">&#34;</span>$REMOTE_IP<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span>$ALLOWED_IP_LIST<span style="color:#e6db74">&#34;</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        echo <span style="color:#e6db74">&#34;Access granted to </span>$REMOTE_IP<span style="color:#e6db74"> with status code </span>$REMOTE_STATUS_CODE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        exit <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 发送Telegram告警</span>
</span></span><span style="display:flex;"><span>        MESSAGE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Unauthorized login attempt from IP </span>$REMOTE_IP<span style="color:#e6db74"> with status code </span>$REMOTE_STATUS_CODE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        URL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://api.telegram.org/bot</span>$TELEGRAM_API_TOKEN<span style="color:#e6db74">/sendMessage&#34;</span>
</span></span><span style="display:flex;"><span>        curl -s -X POST $URL -d chat_id<span style="color:#f92672">=</span>$TELEGRAM_CHAT_ID -d text<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$MESSAGE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        echo <span style="color:#e6db74">&#34;Access denied to </span>$REMOTE_IP<span style="color:#e6db74"> with status code </span>$REMOTE_STATUS_CODE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;Access denied with status code </span>$REMOTE_STATUS_CODE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span></span></span></code></pre></div></blockquote>
<ul>
<li>稍微修改的脚本，用于过滤网站后台登录日志文件中的<code>URL</code>、<code>IP</code>地址和状态码，将不在预定义文件列表中的<code>IP</code>地址发送到<code>Telegram</code>通知组：</li>
</ul>
<blockquote>
<ul>
<li>该脚本会从日志文件中过滤出登录<code>URL</code>、<code>IP</code>地址和状态码信息，并遍历这些信息。对于每个<code>IP</code>地址和状态码，它将检查状态码是否为<code>200</code>，然后检查<code>IP</code>地址是否在允许的列表中。如果是，则显示<code>Access granted</code>，否则将发送<code>Telegram</code>告警，并显示<code>Access denied</code>。请注意，您需要将<code>YOUR_TELEGRAM_API_TOKEN</code>和<code>YOUR_TELEGRAM_CHAT_ID</code>替换为您自己的<code>Telegram API Token</code>和<code>Chat ID</code>，并根据需要修改<code>ALLOWED_IP_LIST</code>和<code>LOG_FILE</code>。</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 预定义允许登录的IP地址列表文件</span>
</span></span><span style="display:flex;"><span>ALLOWED_IP_LIST<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;allowed_ips.txt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 定义需要检查的网站后台登录日志文件</span>
</span></span><span style="display:flex;"><span>LOG_FILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/var/log/nginx/access.log&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 定义Telegram通知组的API Token和Chat ID</span>
</span></span><span style="display:flex;"><span>TELEGRAM_API_TOKEN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;YOUR_TELEGRAM_API_TOKEN&#34;</span>
</span></span><span style="display:flex;"><span>TELEGRAM_CHAT_ID<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;YOUR_TELEGRAM_CHAT_ID&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用grep命令从日志文件中过滤出登录URL、IP地址和状态码</span>
</span></span><span style="display:flex;"><span>LOG_FILTER<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>grep -E <span style="color:#e6db74">&#39;\/admin\/login.*HTTP\/1\.[01]&#34; 200&#39;</span> $LOG_FILE | awk <span style="color:#e6db74">&#39;{print $1, $7, $9}&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 遍历过滤出的日志信息</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> read -r log_info; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 分别提取IP地址和状态码</span>
</span></span><span style="display:flex;"><span>    REMOTE_IP<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;</span>$log_info<span style="color:#e6db74">&#34;</span> | awk <span style="color:#e6db74">&#39;{print $1}&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>    REMOTE_STATUS_CODE<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;</span>$log_info<span style="color:#e6db74">&#34;</span> | awk <span style="color:#e6db74">&#39;{print $2}&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 检查状态码是否为200</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;</span>$REMOTE_STATUS_CODE<span style="color:#e6db74">&#34;</span> -eq <span style="color:#e6db74">&#34;200&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 检查IP地址是否在允许的列表中</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> grep -Fxq <span style="color:#e6db74">&#34;</span>$REMOTE_IP<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span>$ALLOWED_IP_LIST<span style="color:#e6db74">&#34;</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#34;Access granted to </span>$REMOTE_IP<span style="color:#e6db74"> with status code </span>$REMOTE_STATUS_CODE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 发送Telegram告警</span>
</span></span><span style="display:flex;"><span>            MESSAGE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Unauthorized login attempt from IP </span>$REMOTE_IP<span style="color:#e6db74"> with status code </span>$REMOTE_STATUS_CODE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>            URL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://api.telegram.org/bot</span>$TELEGRAM_API_TOKEN<span style="color:#e6db74">/sendMessage&#34;</span>
</span></span><span style="display:flex;"><span>            curl -s -X POST $URL -d chat_id<span style="color:#f92672">=</span>$TELEGRAM_CHAT_ID -d text<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$MESSAGE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#34;Access denied to </span>$REMOTE_IP<span style="color:#e6db74"> with status code </span>$REMOTE_STATUS_CODE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span> <span style="color:#f92672">&lt;&lt;&lt;</span> <span style="color:#e6db74">&#34;</span>$LOG_FILTER<span style="color:#e6db74">&#34;</span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

        </div>
      </main>
    </div>
    <script src="../../../../js/clipboard.min.js?1724860323" defer></script>
    <script src="../../../../js/perfect-scrollbar.min.js?1724860323" defer></script>
    <script src="../../../../js/theme.js?1724860323" defer></script>
  </body>
</html>
