<!DOCTYPE html>
<html lang="en" dir="ltr" itemscope itemtype="http://schema.org/Article">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.125.4">
    <meta name="generator" content="Relearn 6.0.0+tip">
    <meta name="robots" content="noindex, nofollow, noarchive, noimageindex">
    <meta name="description" content="">
    <meta name="author" content="二哥">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://erge.blog/images/s2-1.png">
    <meta name="twitter:title" content="Databases :: Hugo Relearn Theme">
    <meta property="og:url" content="https://erge.blog/systems/linux/databases/">
    <meta property="og:site_name" content="Hugo Relearn Theme">
    <meta property="og:title" content="Databases :: Hugo Relearn Theme">
    <meta property="og:locale" content="en">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://erge.blog/images/s2-1.png">
    <meta itemprop="name" content="Databases :: Hugo Relearn Theme">
    <meta itemprop="datePublished" content="2024-06-13T00:23:11+08:00">
    <meta itemprop="dateModified" content="2024-06-13T00:23:11+08:00">
    <meta itemprop="image" content="https://erge.blog/images/s2-1.png">
    <title>Databases :: Hugo Relearn Theme</title>
    <link href="../../../images/favicon.ico?1719333223" rel="icon" type="image/x-icon" sizes="any">
    <link href="../../../css/fontawesome-all.min.css?1719333224" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="../../../css/fontawesome-all.min.css?1719333224" rel="stylesheet"></noscript>
    <link href="../../../css/nucleus.css?1719333224" rel="stylesheet">
    <link href="../../../css/auto-complete.css?1719333224" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="../../../css/auto-complete.css?1719333224" rel="stylesheet"></noscript>
    <link href="../../../css/perfect-scrollbar.min.css?1719333224" rel="stylesheet">
    <link href="../../../css/fonts.css?1719333224" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="../../../css/fonts.css?1719333224" rel="stylesheet"></noscript>
    <link href="../../../css/theme.css?1719333224" rel="stylesheet">
    <link href="../../../css/theme-relearn-auto.css?1719333224" rel="stylesheet" id="R-variant-style">
    <link href="../../../css/chroma-relearn-auto.css?1719333224" rel="stylesheet" id="R-variant-chroma-style">
    <link href="../../../css/variant.css?1719333224" rel="stylesheet">
    <link href="../../../css/print.css?1719333224" rel="stylesheet" media="print">
    <link href="../../../css/format-print.css?1719333224" rel="stylesheet">
    <script src="../../../js/variant.js?1719333224"></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.relBasePath='..\/..\/..';
      window.relearn.relBaseUri='..\/..\/..';
      window.relearn.absBaseUri='https:\/\/erge.blog';
      window.index_js_url="../../../index.search.js";
      // variant stuff
      window.variants && variants.init( [ 'relearn-auto', 'relearn-light', 'relearn-dark', 'relearn-bright', 'zen-auto', 'zen-light', 'zen-dark', 'retro-auto', 'neon', 'learn', 'blue', 'green', 'red', 'my-branding' ] );
      // translations
      window.T_Copy_to_clipboard = `Copy to clipboard`;
      window.T_Copied_to_clipboard = `Copied to clipboard!`;
      window.T_Copy_link_to_clipboard = `Copy link to clipboard`;
      window.T_Link_copied_to_clipboard = `Copied link to clipboard!`;
      window.T_Reset_view = `Reset view`;
      window.T_View_reset = `View reset!`;
      window.T_No_results_found = `No results found for "{0}"`;
      window.T_N_results_found = `{1} results found for "{0}"`;
    </script>Partial intended to be overwritten to add custom headers, like CSS or any other info
<style>
    
</style>


  </head>
  <body class="mobile-support print disableInlineCopyToClipboard" data-url="../../../systems/linux/databases/">
    <div id="R-body" class="default-animation">
      <div id="R-body-overlay"></div>
      <nav id="R-topbar">
        <div class="topbar-wrapper">
          <div class="topbar-sidebar-divider"></div>
          <div class="topbar-area topbar-area-start" data-area="start">
            <div class="topbar-button topbar-button-sidebar" data-content-empty="show" data-width-s="show" data-width-m="show" data-width-l="show"><button class="topbar-control" onclick="toggleNav()" type="button" title="Menu (CTRL&#43;ALT&#43;n)"><i class="fa-fw fas fa-bars"></i></button>
            </div>



          </div>
          <ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype="http://schema.org/BreadcrumbList"><li
            itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><a itemprop="item" href="../../../systems/"><span itemprop="name">Systems</span></a><meta itemprop="position" content="1">&nbsp;>&nbsp;</li><li
            itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><a itemprop="item" href="../../../systems/linux/"><span itemprop="name">Linux</span></a><meta itemprop="position" content="2">&nbsp;>&nbsp;</li><li
            itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><span itemprop="name">Databases</span><meta itemprop="position" content="3"></li>
          </ol>
          <div class="topbar-area topbar-area-end" data-area="end">


            <div class="topbar-button topbar-button-prev" data-content-empty="show" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="../../../systems/linux/email/install_iredmail/" title="Install_iRedMail (🡐)"><i class="fa-fw fas fa-chevron-left"></i></a>
            </div>

            <div class="topbar-button topbar-button-next" data-content-empty="show" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="../../../systems/linux/databases/update_mysql5-7_to_mysql8/" title="Update_Mysql5 7_To_Mysql8 (🡒)"><i class="fa-fw fas fa-chevron-right"></i></a>
            </div>



          </div>
        </div>
      </nav>
      <div id="R-main-overlay"></div>
      <main id="R-body-inner" class="highlightable default" tabindex="-1">
        <div class="flex-block-wrapper">
          <article class="default">
            <header class="headline">
            </header>

<h1 id="databases">Databases</h1>


            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Databases</h1>
          <article class="default">
            <header class="headline">
            </header>

<h1 id="update_mysql5-7_to_mysql8">Update_Mysql5 7_To_Mysql8</h1>

<h2 id="mysql-57-升级到mysql-8"><code>Mysql 5.7 </code>升级到<code>Mysql 8</code></h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->下载解压<code>Mysql 8</code>安装包<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wget https://dev.mysql.com/get/Downloads/MySQL-8.0/mysql-8.0.21-linux-glibc2.12-x86_64.tar.xz -P /usr/local/src/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ tar -xvf /usr/local/src/mysql-8.0.21-linux-glibc2.12-x86_64.tar.xz -C  /usr/local/src/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ mv /usr/local/src/mysql-8.0.21-linux-glibc2.12-x86_64  /usr/local/mysql8</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->修改<code>Mysql</code>的<code>cnf</code>文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<p><!-- raw HTML omitted -->只更改工作目录，不更改 data 数据目录<!-- raw HTML omitted --></p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sed  -i <span style="color:#e6db74">&#34;s#/usr/local/mysql#/usr/local/mysql8#g&#34;</span> /etc/my.cnf
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s/sql_mode/#sql_mode/g&#39;</span> /etc/my.cnf
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;20i sql_mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION&#39;</span> /etc/my.cnf
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;20i default_authentication_plugin=mysql_native_password&#39;</span> /etc/my.cnf
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s/query_cache_size/#query_cache_size/g&#39;</span> /etc/my.cnf
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s/query_cache_limit/#query_cache_limit/g&#39;</span> /etc/my.cnf</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->备份<code>Mysql</code>数据、目录，停止现有<!-- raw HTML omitted --><code>Mysql</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /usr/local/mysql/bin/mysql -uroot -p<span style="color:#e6db74">&#39;password&#39;</span> -S /opt/data/data_16303/mysql.sock -e <span style="color:#e6db74">&#34;set global innodb_fast_shutdown=0;&#34;</span>
</span></span><span style="display:flex;"><span>$ mysql -uroot -p<span style="color:#e6db74">&#39;password&#39;</span> -S /opt/data/data_16303/mysql.sock -e <span style="color:#e6db74">&#34;shutdown;&#34;</span>
</span></span><span style="display:flex;"><span>$ cp -r /usr/local/mysql/data<span style="color:#f92672">{</span>,.bak<span style="color:#f92672">}</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->启动<!-- raw HTML omitted --><code>Mysql 8</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /usr/local/mysql8/bin/mysqld --defaults-file<span style="color:#f92672">=</span>/etc/my.cnf --user<span style="color:#f92672">=</span>mysql &amp;
</span></span><span style="display:flex;"><span>$ mv /usr/local/mysql  /usr/local/src/mysql-5.7-<span style="color:#e6db74">`</span>date +%F<span style="color:#e6db74">`</span>.bak</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->检查数据库是否升级成功<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /usr/local/mysql8/bin/mysql -uroo -p<span style="color:#e6db74">&#39;password&#39;</span> -S /tmp/mysql.sock -e <span style="color:#e6db74">&#34;select version();&#34;</span> | tail -1<span style="color:#e6db74">`</span></span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_ydb">Install_Ydb</h1>

<h2 id="部署ydb单节点数据库">部署<code>Ydb</code>单节点数据库</h2>
<blockquote>
<ol>
<li><code>Ydb</code><!-- raw HTML omitted -->使用端口<!-- raw HTML omitted --></li>
</ol>
<table>
<thead>
<tr>
<th>端口</th>
<th>协议</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>2135~2136</td>
<td><code>TCP</code></td>
<td>用于客户端-集群交互的<code>GRPC</code></td>
</tr>
<tr>
<td>19001~19002</td>
<td><code>TCP</code></td>
<td>集群内节点交互互连</td>
</tr>
<tr>
<td>8765~8766</td>
<td><code>TCP</code></td>
<td>集群监控的<code>HTTP</code>接口</td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>
<ol>
<li><a href="https://ydb.tech/" rel="external" target="_self"><code>Ydb</code></a>数据库、<a href="https://github.com/ydb-platform/ydb" rel="external" target="_self"><code>Github-Ydb</code></a></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->系统要求<!-- raw HTML omitted --><code>Ubuntu 20.04、Debian 11、Fedora34</code><!-- raw HTML omitted -->等以上版本系统<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mkdir -p /opt/<span style="color:#f92672">{</span>ydb,ydb-cli<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>$ cd /opt/ydb/
</span></span><span style="display:flex;"><span>$ curl https://binaries.ydb.tech/local_scripts/install.sh | bash</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->启动、停止<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 磁盘启动使用，磁盘最少不能低于 80G</span>
</span></span><span style="display:flex;"><span>$ ./start.sh disk
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 内存启动，内存启动服务器重启数据丢失</span>
</span></span><span style="display:flex;"><span>$ ./start.sh ram
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 停止</span>
</span></span><span style="display:flex;"><span>$ ./stop.sh</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->部署<!-- raw HTML omitted --><code>Ydb-cli</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ curl -sSL https://storage.yandexcloud.net/yandexcloud-ydb/install.sh | bash
</span></span><span style="display:flex;"><span>$ source /root/.bashrc</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>Ydb-cli</code>查询</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ydb -e grpc://localhost:2136 -d /Root/test scheme ls
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ydb -e grpc://nodeip:2136 -d /Root/testdb workload stock init
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动YDB Web页面</span>
</span></span><span style="display:flex;"><span>$ ydb -e grpc://nodeip:2136 -d /Root/testdb workload stock run add-rand-order -s <span style="color:#ae81ff">600</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ydb -e grpc://192.168.88.112:2136 -d /Root/testdb topic read orders/updates -c ilnaz --wait --format<span style="color:#f92672">=</span>newline-delimited</span></span></code></pre></div></blockquote>
<hr>
<h2 id="部署集群模式">部署集群模式</h2>
<h3 id="安装前准备">安装前准备</h3>
<blockquote>
<ol>
<li><a href="https://ydb.tech/en/docs/deploy/manual/deploy-ydb-on-premises" rel="external" target="_self">在虚拟或裸机服务器上部署<code>YDB</code>集群</a></li>
</ol>
</blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->虚拟机系统安装好后，重新添加<!-- raw HTML omitted --><code>NVMe(v)</code>类型磁盘</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->准备环境、用户<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo groupadd ydb
</span></span><span style="display:flex;"><span>$ sudo useradd ydb -g ydb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo usermod -aG disk ydb  	<span style="color:#75715e"># 为了确保YDB可以访问块磁盘来运行，您需要将进程所有者添加到disk组中</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ apt install sudo  	<span style="color:#75715e"># 使用root用户安装sudo</span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;name  ALL=(ALL:ALL) ALL&#34;</span> &gt;&gt;/etc/sudoers
</span></span><span style="display:flex;"><span>$ sudo apt install curl parted</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->在所选磁盘上创建分区<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo parted /dev/nvme0n1 mklabel gpt -s
</span></span><span style="display:flex;"><span>$ sudo parted -a optimal /dev/nvme0n1 mkpart primary 0% 100%
</span></span><span style="display:flex;"><span>$ sudo parted /dev/nvme0n1 name <span style="color:#ae81ff">1</span> ydb_disk_ssd_01
</span></span><span style="display:flex;"><span>$ sudo partx --u /dev/nvme0n1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo parted /dev/nvme0n2 mklabel gpt -s
</span></span><span style="display:flex;"><span>$ sudo parted -a optimal /dev/nvme0n2 mkpart primary 0% 100%
</span></span><span style="display:flex;"><span>$ sudo parted /dev/nvme0n2 name <span style="color:#ae81ff">1</span> ydb_disk_ssd_02
</span></span><span style="display:flex;"><span>$ sudo partx --u /dev/nvme0n2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo parted /dev/nvme0n3 mklabel gpt -s
</span></span><span style="display:flex;"><span>$ sudo parted -a optimal /dev/nvme0n3 mkpart primary 0% 100%
</span></span><span style="display:flex;"><span>$ sudo parted /dev/nvme0n3 name <span style="color:#ae81ff">1</span> ydb_disk_ssd_03
</span></span><span style="display:flex;"><span>$ sudo partx --u /dev/nvme0n3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 系统上将出现一个标有磁盘的磁盘 </span>
</span></span><span style="display:flex;"><span>$ ll /dev/disk/by-partlabel/</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->下载并解压包含<code>ydbd</code>可执行文件和<code>YDB</code>运行所需库的存档<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo chown -R ydb:ydb /opt
</span></span><span style="display:flex;"><span>$ mkdir -p /opt/<span style="color:#f92672">{</span>ydb/<span style="color:#f92672">{</span>cfg,secure,certs,log<span style="color:#f92672">}</span>,ydbd-stable-linux-amd64<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ curl -L https://binaries.ydb.tech/ydbd-stable-linux-amd64.tar.gz | tar -xz --strip-component<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> -C /opt/ydbd-stable-linux-amd64</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->将可执行文件和库复制到适当的目录<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo cp -iR /opt/ydbd-stable-linux-amd64/bin /opt/ydb/
</span></span><span style="display:flex;"><span>$ sudo cp -iR /opt/ydbd-stable-linux-amd64/lib /opt/ydb/</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->使用以下内置命令格式化磁盘<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo LD_LIBRARY_PATH<span style="color:#f92672">=</span>/opt/ydb/lib /opt/ydb/bin/ydbd admin bs disk obliterate /dev/disk/by-partlabel/ydb_disk_ssd_01
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo LD_LIBRARY_PATH<span style="color:#f92672">=</span>/opt/ydb/lib /opt/ydb/bin/ydbd admin bs disk obliterate /dev/disk/by-partlabel/ydb_disk_ssd_02
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo LD_LIBRARY_PATH<span style="color:#f92672">=</span>/opt/ydb/lib /opt/ydb/bin/ydbd admin bs disk obliterate /dev/disk/by-partlabel/ydb_disk_ssd_03</span></span></code></pre></div></blockquote>
<hr>
<h3 id="准备证书使用保护模式">准备证书使用保护模式</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->准备<code>CA</code>文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/ydb/cfg/ca.cnf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[ ca ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">default_ca = CA_default
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[ CA_default ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">default_days = 365
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">database = /opt/ydb/secure/index.txt
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">serial = /opt/ydb/secure/serial.txt
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">default_md = sha256
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">copy_extensions = copy
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">unique_subject = no
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[ req ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">prompt=no
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">distinguished_name = distinguished_name
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">x509_extensions = extensions
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[ distinguished_name ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">organizationName = YDB
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">commonName = YDB CA
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[ extensions ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">keyUsage = critical,digitalSignature,nonRepudiation,keyEncipherment,keyCertSign
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">basicConstraints = critical,CA:true,pathlen:1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[ signing_policy ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">organizationName = supplied
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">commonName = optional
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[ signing_node_req ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">keyUsage = critical,digitalSignature,keyEncipherment
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">extendedKeyUsage = serverAuth,clientAuth
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># Used to sign client certificates. 用于签署客户端证书
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[ signing_client_req ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">keyUsage = critical,digitalSignature,keyEncipherment
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">extendedKeyUsage = clientAuth
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->创建<code>CA</code>密钥<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ openssl genrsa -out /opt/ydb/certs/ca.key <span style="color:#ae81ff">2048</span></span></span></code></pre></div><ul>
<li>2.1 <!-- raw HTML omitted -->创建私有证书颁发机构<code>CA</code>证书<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ openssl req -new -x509 -config /opt/ydb/cfg/ca.cnf -key /opt/ydb/certs/ca.key -out /opt/ydb/certs/ca.crt -days <span style="color:#ae81ff">1830</span> -batch</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->创建文本数据库和<code>OpenSSL</code>证书索引文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ touch /opt/ydb/secure/index.txt
</span></span><span style="display:flex;"><span>$ echo <span style="color:#ae81ff">01</span> &gt;/opt/ydb/secure/serial.txt</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->创建<code>node.cnf</code>具有以下内容的配置文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/ydb/cfg/node.cnf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># OpenSSL node configuration file
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[ req ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">prompt = no
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">distinguished_name = distinguished_name
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">req_extensions = extensions
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[ distinguished_name ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">organizationName = YDB
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[ extensions ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">subjectAltName = DNS:&lt;node&gt;.&lt;domain&gt;  	# 节点IP或者域名
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->创建证书密钥<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ openssl genrsa -out /opt/ydb/certs/node.key <span style="color:#ae81ff">2048</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->创建证书签名请求<code>CSR</code><!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ openssl req -new -sha256 -config /opt/ydb/cfg/node.cnf -key /opt/ydb/certs/node.key -out /opt/ydb/secure/node.csr -batch</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->创建节点证书<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ openssl ca -config /opt/ydb/cfg/ca.cnf <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> -keyfile /opt/ydb/certs/ca.key <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> -cert /opt/ydb/certs/ca.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> -policy signing_policy <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> -extensions signing_node_req <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> -out /opt/ydb/certs/node.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> -outdir /opt/ydb/certs/ <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> -in /opt/ydb/secure/node.csr -batch</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->将证书和节点密钥复制到安装文件夹<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo -u ydb cp certs/ca.crt certs/node.crt certs/node.key /opt/ydb/certs/</span></span></code></pre></div></blockquote>
<hr>
<h3 id="为ydb准备集群配置文件">为<code>YDB</code>准备集群配置文件</h3>
<blockquote>
<ul>
<li><a href="https://ydb.tech/en/docs/deploy/configuration/config" rel="external" target="_self">集群配置</a></li>
</ul>
</blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->集群类型、在集群每个节点中添加<!-- raw HTML omitted --><code>/opt/ydb/cfg/config.yaml</code>保存<code>YDB</code> 配置文件</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><a href="https://github.com/ydb-platform/ydb/blob/main/ydb/deploy/yaml_config_examples/block-4-2.yaml" rel="external" target="_self"><code>block-4-2</code></a><!-- raw HTML omitted -->用于单数据中心集群<!-- raw HTML omitted --></li>
<li><a href="https://github.com/ydb-platform/ydb/blob/main/ydb/deploy/yaml_config_examples/mirror-3dc-9-nodes.yaml" rel="external" target="_self"><code>mirror-3dc</code></a><!-- raw HTML omitted -->用于由 9 个节点组成的跨数据中心集群<!-- raw HTML omitted --></li>
<li><a href="https://github.com/ydb-platform/ydb/blob/main/ydb/deploy/yaml_config_examples/mirror-3dc-3-nodes.yaml" rel="external" target="_self"><code>mirror-3dc-3nodes</code></a><!-- raw HTML omitted -->用于由 3 个节点组成的跨数据中心集群<!-- raw HTML omitted --></li>
</ul>
</blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->在<code>host_configs</code>部分中，指定每个群集节点上所有磁盘类型<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->可用磁盘种类：固态硬盘：<code>SSD</code>、<code>NVME</code>、<code>HDD</code><!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">host_configs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">drive</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/dev/disk/by-partlabel/ydb_disk_ssd_01</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">SSD  	# 可用磁盘种类：SSD、NVME、HDD</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">host_config_id</span>: <span style="color:#ae81ff">1</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->在该<code>hosts</code>部分中，指定每个节点的<code>FQDN</code>、它们的配置和在<code>data_center</code>或中的位置<code>rack</code><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->在<!-- raw HTML omitted --><code>/etc/hosts</code><!-- raw HTML omitted -->文件下做映射：<!-- raw HTML omitted --><code>IP:hostname</code><!-- raw HTML omitted -->避免不必要麻烦所有主机名必须都是小写字母<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">host</span>: <span style="color:#ae81ff">node1.ydb.tech</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">host_config_id</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">walle_location</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">body</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">data_center</span>: <span style="color:#e6db74">&#39;zone-a&#39;</span>  	<span style="color:#75715e"># 填写 hostname</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rack</span>: <span style="color:#e6db74">&#39;1&#39;</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">host</span>: <span style="color:#ae81ff">node2.ydb.tech</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">host_config_id</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">walle_location</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">body</span>: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">data_center</span>: <span style="color:#e6db74">&#39;zone-b&#39;</span>  	<span style="color:#75715e"># 填写 hostname</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rack</span>: <span style="color:#e6db74">&#39;1&#39;</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">host</span>: <span style="color:#ae81ff">node3.ydb.tech</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">host_config_id</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">walle_location</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">body</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">data_center</span>: <span style="color:#e6db74">&#39;zone-c&#39;</span>  	<span style="color:#75715e"># 填写 hostname</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rack</span>: <span style="color:#e6db74">&#39;1&#39;</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->启用用户身份验证<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->在<code>YDB</code>集群中启用认证和用户访问差异化特性，在<code>domains_config</code>部分添加以下参数<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">domains_config</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">security_config</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enforce_user_token_requirement</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">monitoring_allowed_sids</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;root&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;ADMINS&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;DATABASE-ADMINS&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">administration_allowed_sids</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;root&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;ADMINS&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;DATABASE-ADMINS&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">viewer_allowed_sids</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;root&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;ADMINS&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;DATABASE-ADMINS&#34;</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->在<code>YDB</code>配置文件中启用流量加密模式<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->在<code>interconnect_config</code>和<code>grpc_config</code>部分中，指定证书、密钥和<code>CA</code>证书的路径<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">interconnect_config</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">start_tcp</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">encryption_mode</span>: <span style="color:#ae81ff">OPTIONAL</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path_to_certificate_file</span>: <span style="color:#e6db74">&#34;/opt/ydb/certs/node.crt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path_to_private_key_file</span>: <span style="color:#e6db74">&#34;/opt/ydb/certs/node.key&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path_to_ca_file</span>: <span style="color:#e6db74">&#34;/opt/ydb/certs/ca.crt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">grpc_config</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">cert</span>: <span style="color:#e6db74">&#34;/opt/ydb/certs/node.crt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">key</span>: <span style="color:#e6db74">&#34;/opt/ydb/certs/node.key&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ca</span>: <span style="color:#e6db74">&#34;/opt/ydb/certs/ca.crt&#34;</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="6">
<li><!-- raw HTML omitted -->完整<!-- raw HTML omitted --><code>block-4-2</code>配置<!-- raw HTML omitted -->避免不必要麻烦所有主机名必须都是小写字母<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/ydb/cfg/config.yaml<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># YDB configuration options and their values
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># are described in documentaion https://ydb.tech/en/docs/deploy/configuration/config
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># static erasure is the parameter that
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># describes the fault tolerance mode of the
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># cluster. See docs for more details https://ydb.tech/en/docs/deploy/configuration/config#domains-blob
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">static_erasure: mirror-3-dc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">host_configs: # the list of available host configurations in the cluster.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- drive:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - path: /dev/disk/by-partlabel/ydb_disk_ssd_01    # path of the first disk in the host configration.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    type: NVME                                       # kind of the disk: available kinds are SSD, NVME, HDD
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - path: /dev/disk/by-partlabel/ydb_disk_ssd_02
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    type: NVME
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - path: /dev/disk/by-partlabel/ydb_disk_ssd_03
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    type: NVME
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  host_config_id: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">hosts:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- host: debian-1-88-110       # storage node DNS name
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  host_config_id: 1                 # numeric host configuration template identifier
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  walle_location:                   # this parameter describes where host is located.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    body: 1                         # string representing a host serial number.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    data_center: &#39;debian-1-88-110&#39;           # string representing the datacenter / availability zone where the host is located.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                    # if cluster is deployed using mirror-3-dc fault tolerance mode, all hosts must be distributed
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                    # across 3 datacenters.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    rack: &#39;1&#39;                       # string representing a rack identifier where the host is located.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                    # if cluster is deployed using block-4-2 erasure, all hosts should be distrubited
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                    # accross at least 8 racks.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- host: ubuntu-1-88-111
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  host_config_id: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  walle_location:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    body: 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    data_center: &#39;ubuntu-1-88-111&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    rack: &#39;2&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- host: ubuntu-2-88-112
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  host_config_id: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  walle_location:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    body: 3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    data_center: &#39;ubuntu-2-88-112&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    rack: &#39;3&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">domains_config:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # There can be only one root domain in a cluster. Domain name prefixes all scheme objects names, e.g. full name of a table table1 in database db1.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # in a cluster with domains_config.domain.name parameter set to Root would be equal to /Root/db1/table1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  domain:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - name: Root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    storage_pool_types:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - kind: nvme
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      pool_config:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        box_id: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        # fault tolerance mode name - none, block-4-2, or mirror-3-dc..
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        # See docs for more details https://ydb.tech/en/docs/deploy/configuration/config#domains-blob
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        erasure_species: mirror-3-dc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        kind: nvme
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        geometry:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          realm_level_begin: 10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          realm_level_end: 20
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          domain_level_begin: 10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          domain_level_end: 256
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        pdisk_filter:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - property:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          - type: NVME  # device type to match host_configs.drive.type
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        vdisk_kind: Default
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  state_storage:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - ring:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      node: [1, 2, 3]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      nto_select: 3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ssid: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">table_service_config:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  sql_version: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">actor_system_config:          # the configuration of the actor system which descibes how cores of the instance are distributed
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  executor:                   # accross different types of workloads in the instance.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - name: System              # system executor of the actor system. in this executor YDB launches system type of workloads, like system tablets
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                              # and reads from storage.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    threads: 2                # the number of threads allocated to system executor.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    type: BASIC
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - name: User                # user executor of the actor system. In this executor YDB launches user workloads, like datashard activities,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                              # queries and rpc calls.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    threads: 3                # the number of threads allocated to user executor.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    type: BASIC
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - name: Batch               # user executor of the actor system. In this executor YDB launches batch operations, like scan queries, table
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                              # compactions, background compactions.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    threads: 2                # the number of threads allocated to the batch executor.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    type: BASIC
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - name: IO                  # the io executor. In this executor launches sync operations and writes logs.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    threads: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    time_per_mailbox_micro_secs: 100
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    type: IO
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - name: IC                  # the interconnect executor which YDB uses for network communications accross different nodes of the cluster.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    spin_threshold: 10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    threads: 1                # the number of threads allocated to the interconnect executor.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    time_per_mailbox_micro_secs: 100
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    type: BASIC
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  scheduler:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    progress_threshold: 10000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    resolution: 256
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    spin_threshold: 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">blob_storage_config:         # configuration of static blobstorage group.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                             # YDB uses this group to store system tablets&#39; data, like SchemeShard
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  service_set:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    groups:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - erasure_species: mirror-3-dc # fault tolerance mode name for the static group
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      rings:          # in mirror-3-dc must have exactly 3 rings or availability zones
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - fail_domains:  # first record: fail domains of the static group describe where each vdisk of the static group should be located.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - vdisk_locations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          - node_id: debian-1-88-110
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            pdisk_category: NVME
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            path: /dev/disk/by-partlabel/ydb_disk_ssd_01
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - vdisk_locations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          - node_id: debian-1-88-110
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            pdisk_category: NVME
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            path: /dev/disk/by-partlabel/ydb_disk_ssd_02
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - vdisk_locations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          - node_id: debian-1-88-110
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            pdisk_category: NVME
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            path: /dev/disk/by-partlabel/ydb_disk_ssd_03
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - fail_domains: # second ring: fail domains of the static group describe where each vdisk of the static group should be located.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - vdisk_locations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          - node_id: ubuntu-1-88-111
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            pdisk_category: NVME
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            path: /dev/disk/by-partlabel/ydb_disk_ssd_01
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - vdisk_locations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          - node_id: ubuntu-1-88-111
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            pdisk_category: NVME
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            path: /dev/disk/by-partlabel/ydb_disk_ssd_02
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - vdisk_locations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          - node_id: ubuntu-1-88-111
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            pdisk_category: NVME
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            path: /dev/disk/by-partlabel/ydb_disk_ssd_03
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - fail_domains: # third ring: fail domains of the static group describe where each vdisk of the static group should be located.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - vdisk_locations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          - node_id: ubuntu-2-88-112
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            pdisk_category: NVME
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            path: /dev/disk/by-partlabel/ydb_disk_ssd_01
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - vdisk_locations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          - node_id: ubuntu-2-88-112
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            pdisk_category: NVME
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            path: /dev/disk/by-partlabel/ydb_disk_ssd_02
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - vdisk_locations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          - node_id: ubuntu-2-88-112
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            pdisk_category: NVME
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            path: /dev/disk/by-partlabel/ydb_disk_ssd_03
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">channel_profile_config:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  profile:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - channel:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - erasure_species: mirror-3-dc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      pdisk_category: 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      storage_pool_kind: nvme
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - erasure_species: mirror-3-dc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      pdisk_category: 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      storage_pool_kind: nvme
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - erasure_species: mirror-3-dc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      pdisk_category: 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      storage_pool_kind: nvme
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    profile_id: 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">interconnect_config:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    start_tcp: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    encryption_mode: OPTIONAL
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    path_to_certificate_file: &#34;/opt/ydb/certs/node.crt&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    path_to_private_key_file: &#34;/opt/ydb/certs/node.key&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    path_to_ca_file: &#34;/opt/ydb/certs/ca.crt&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">grpc_config:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    cert: &#34;/opt/ydb/certs/node.crt&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    key: &#34;/opt/ydb/certs/node.key&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ca: &#34;/opt/ydb/certs/ca.crt&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="启动数据库静态节点">启动数据库静态节点</h3>
<h4 id="手动方式启动">手动方式启动</h4>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->启动<code>/Root/testdb</code>数据库的<code>YDB</code>动态节点<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>&lt;nodeN.ydb.tech&gt;</code><!-- raw HTML omitted -->运行静态节点的服务器的<code>FQDN</code>在哪里<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->在其他服务器上运行额外的动态节点以确保数据库可用性<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo su - ydb
</span></span><span style="display:flex;"><span>$ cd /opt/ydb
</span></span><span style="display:flex;"><span>$ export LD_LIBRARY_PATH<span style="color:#f92672">=</span>/opt/ydb/lib
</span></span><span style="display:flex;"><span>/opt/ydb/bin/ydbd server --log-level <span style="color:#ae81ff">3</span> --tcp --yaml-config /opt/ydb/cfg/config.yaml --grpc-port <span style="color:#ae81ff">2135</span> --ic-port <span style="color:#ae81ff">19001</span> --mon-port <span style="color:#ae81ff">8765</span> --node static &gt;/opt/ydb/log/static-node.out 2&gt;/opt/ydb/log/static-node.err &amp;&gt;</span></span></code></pre></div></blockquote>
<hr>
<h4 id="使用systemd方式启动">使用<code>systemd</code>方式启动</h4>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->编写启动文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>/etc/systemd/system/ydbd-storage.service</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/systemd/system/ydbd-storage.service<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=YDB storage node
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network-online.target rc-local.service
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Wants=network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">StartLimitInterval=10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">StartLimitBurst=15
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=always
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">RestartSec=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=ydb  	# 根据用户修改
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">PermissionsStartOnly=true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">StandardOutput=/var/log/ydb.log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">StandardError=/var/log/ydb.log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SyslogIdentifier=ydbd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SyslogFacility=daemon
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SyslogLevel=err
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Environment=LD_LIBRARY_PATH=/opt/ydb/lib
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/ydb/bin/ydbd server --log-level 3 --syslog --tcp --yaml-config  /opt/ydb/cfg/config.yaml --grpc-port 2135 --ic-port 19001 --mon-port 8765 --node static
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LimitNOFILE=65536
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LimitCORE=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LimitMEMLOCK=3221225472
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->启动服务器、查看状态<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo systemctl start ydbd-storage
</span></span><span style="display:flex;"><span>$ sudo systemctl status ydbd-storage</span></span></code></pre></div></blockquote>
<hr>
<h3 id="初始化集群">初始化集群</h3>
<h4 id="不使用身份验证方式初始化集群">不使用身份验证方式初始化集群</h4>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->在其中一个集群节点上，运行命令<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ export LD_LIBRARY_PATH<span style="color:#f92672">=</span>/opt/ydb/lib
</span></span><span style="display:flex;"><span>/opt/ydb/bin/ydbd admin blobstorage config init --yaml-file  /opt/ydb/cfg/config.yaml
</span></span><span style="display:flex;"><span>$ echo $?</span></span></code></pre></div></blockquote>
<hr>
<h4 id="使用身份验证方式初始化集群">使用身份验证方式初始化集群</h4>
<blockquote>
<p>要在启用用户认证模式的集群中执行管理命令（包括集群初始化、数据库创建、磁盘管理等），您必须首先使用<code>YDB CLI</code>客户端<code>2.0.0</code>或更高版本获取认证令牌。<a href="https://ydb.tech/en/docs/reference/ydb-cli/install" rel="external" target="_self">您必须按照安装说明</a>将<code>YDB CLI</code>客户端安装在任何可以通过网络访问集群节点的计算机上（例如，在其中一个集群节点上）。</p>
</blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->第一次安装集群时，它只有一个<code>root</code>密码为空的帐户，因此获取令牌的命令<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->任何集群服务器都可以指定为连接服务器（<code>-e</code>或<code>--endpoint</code>参数）<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ydb -e grpc://&lt;node1.ydb.tech&gt;:2135 -d /Root --user root --no-password auth get-token --force &gt;token-file</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->如果启用了<!-- raw HTML omitted --><code>TLS</code>流量保护，请使用受保护的<code>grpcs</code>协议而不是<code>grpc</code>上面命令中的协议，并在参数中额外指定<code>CA</code>证书的路径<code>--ca-file</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ydb -e grpcs://&lt;node1.ydb.tech&gt;:2135 -d /Root --ca-file /opt/ydb/certs/ca.crt --user root --no-password auth get-token --force &gt;token-file</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->如果命令执行成功，身份验证令牌将被写入<code>token-file</code>. 只需要将此文件复制到稍后要运行集群初始化和数据库创建命令的集群节点。接下来，在此集群节点上运行命令<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ export LD_LIBRARY_PATH<span style="color:#f92672">=</span>/opt/ydb/lib
</span></span><span style="display:flex;"><span>/opt/ydb/bin/ydbd -f token-file admin blobstorage config init --yaml-file  /opt/ydb/cfg/config.yaml
</span></span><span style="display:flex;"><span>$ echo $?</span></span></code></pre></div></blockquote>
<hr>
<h3 id="创建数据库">创建数据库</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->要使用表，您需要至少创建一个数据库并运行一个进程来为该数据库提供服务（动态节点）不使用令牌<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>/Root</code><!-- raw HTML omitted -->: 根域的名称，必须与<!-- raw HTML omitted --><code>domains_config</code>. <code>domain</code>. <code>name</code><!-- raw HTML omitted -->在集群配置文件中设置<!-- raw HTML omitted --></li>
<li><code>testdb</code><!-- raw HTML omitted -->: 创建的数据库名称<!-- raw HTML omitted --></li>
<li><code>ssd:1</code><!-- raw HTML omitted -->：存储池的名称和池中块的编号。池名称通常表示数据存储设备的类型，并且必须与<!-- raw HTML omitted --><code>storage_pool_types</code>. <code>kind</code><!-- raw HTML omitted -->里面的设置<!-- raw HTML omitted --><code>domains_config</code>。<code>domain</code><!-- raw HTML omitted -->配置文件的元素<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ LD_LIBRARY_PATH<span style="color:#f92672">=</span>/opt/ydb/lib /opt/ydb/bin/ydbd admin database /Root/testdb create ssd:1</span></span></code></pre></div><ul>
<li>
<p><!-- raw HTML omitted -->使用令牌文件的数据库创建命令<!-- raw HTML omitted --></p>
<p>如果在集群中启用了用户认证模式，则必须将认证令牌传递给数据库创建命令。<a href="https://ydb.tech/en/docs/deploy/manual/deploy-ydb-on-premises#initialize-cluster" rel="external" target="_self">集群初始化</a>部分描述了获取令牌的过程</p>
</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ LD_LIBRARY_PATH<span style="color:#f92672">=</span>/opt/ydb/lib /opt/ydb/bin/ydbd -f token-file admin database /Root/testdb create ssd:1</span></span></code></pre></div></blockquote>
<hr>
<h3 id="启动数据库动态节点">启动数据库动态节点</h3>
<h4 id="手动方式启动-1">手动方式启动</h4>
<ul>
<li>
<ol>
<li>启动<code>/Root/testdb</code><!-- raw HTML omitted -->数据库的<code>YDB</code>动态节点<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>&lt;nodeN.ydb.tech&gt;</code><!-- raw HTML omitted -->运行静态节点的服务器的<code>FQDN</code>在哪里<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->在其他服务器上运行额外的动态节点以确保数据库可用性<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo su - ydb
</span></span><span style="display:flex;"><span>$ cd /opt/ydb
</span></span><span style="display:flex;"><span>$ export LD_LIBRARY_PATH<span style="color:#f92672">=</span>/opt/ydb/lib
</span></span><span style="display:flex;"><span>/opt/ydb/bin/ydbd server --grpc-port <span style="color:#ae81ff">2136</span> --ic-port <span style="color:#ae81ff">19002</span> --mon-port <span style="color:#ae81ff">8766</span> --yaml-config  /opt/ydb/cfg/config.yaml --tenant /Root/testdb --node-broker &lt;node1.ydb.tech&gt;:2135 --node-broker &lt;node2.ydb.tech&gt;:2135 --node-broker &lt;node3.ydb.tech&gt;:2135</span></span></code></pre></div></blockquote>
<hr>
<h4 id="使用systemd方式启动-1">使用<code>Systemd</code>方式启动</h4>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->编写启动文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->创建一个名为<!-- raw HTML omitted --><code>/etc/systemd/system/ydbd-testdb.service</code><!-- raw HTML omitted -->以下内容的配置文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/systemd/system/ydbd-testdb.service<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=YDB testdb dynamic node
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network-online.target rc-local.service
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Wants=network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">StartLimitInterval=10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">StartLimitBurst=15
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=always
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">RestartSec=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">User=ydb
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">PermissionsStartOnly=true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">StandardOutput=syslog
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">StandardError=syslog
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SyslogIdentifier=ydbd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SyslogFacility=daemon
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SyslogLevel=err
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Environment=LD_LIBRARY_PATH=/opt/ydb/lib
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/opt/ydb/bin/ydbd server --grpc-port 2136 --ic-port 19002 --mon-port 8766 --yaml-config  /opt/ydb/cfg/config.yaml --tenant /Root/testdb --node-broker &lt;node1.ydb.tech&gt;:2135 --node-broker &lt;node2.ydb.tech&gt;:2135 --node-broker &lt;node3.ydb.tech&gt;:2135
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LimitNOFILE=65536
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LimitCORE=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LimitMEMLOCK=32212254720
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li>启动<code>/Root/testdb</code><!-- raw HTML omitted -->数据库的<code>YDB</code>动态节点<!-- raw HTML omitted --><!-- raw HTML omitted -->在其他服务器上运行额外的动态节点以确保数据库可用性<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo systemctl start ydbd-testdb</span></span></code></pre></div></blockquote>
<hr>
<h3 id="初始帐户设置">初始帐户设置</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->在集群配置文件中启用了身份验证模式，则必须在使用<code>YDB</code>集群之前完成初始帐户设置<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>
<p><code>YDB</code>集群的初始安装会自动创建一个<code>root</code>密码为空的帐户，以及<a href="https://ydb.tech/en/docs/cluster/access" rel="external" target="_self">访问管理</a>部分中描述的一组标准用户组</p>
</li>
<li>
<p>要在创建的<code>YDB</code>集群中执行初始帐户设置，<a href="https://ydb.tech/en/docs/reference/ydb-cli/install" rel="external" target="_self">按照文档</a>中的描述安装<code>YDB CLI</code></p>
</li>
<li>
<p><code>&lt;node.ydb.tech&gt;</code>是运行支持<code>/Root/testdb</code>数据库的动态节点的服务器的<code>FQDN</code></p>
</li>
<li>
<p>在运行帐户创建和组分配命令时，<code>YDB CLI</code>客户端将请求<code>root</code>用户密码。<a href="https://ydb.tech/en/docs/reference/ydb-cli/profile/" rel="external" target="_self">您可以按照<code>YDB CLI</code>文档</a>中的说明创建连接配置文件，从而避免输入多个密码</p>
</li>
<li>
<p>如果集群中启用了<code>TLS</code>流量保护，请使用受保护的<code>grpcs</code>协议而不是<code>grpc</code>上面命令中的协议，并在参数中指定<code>CA</code>证书的路径<code>--ca-file</code>（或将其保存在连接配置文件中）</p>
</li>
<li>
<p><code>root</code><!-- raw HTML omitted -->为账户设置密码<!-- raw HTML omitted --></p>
</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ydb -e grpc://&lt;node.ydb.tech&gt;:2136 -d /Root/testdb --user root --no-password yql -s <span style="color:#e6db74">&#39;ALTER USER root PASSWORD &#34;passw0rd&#34;&#39;</span>  	<span style="color:#75715e"># 将passw0rd值替换为自己定义密码  </span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->创建其他帐户<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ydb -e grpc://&lt;node.ydb.tech&gt;:2136 -d /Root/testdb --user root yql -s <span style="color:#e6db74">&#39;CREATE USER user1 PASSWORD &#34;passw0rd&#34;&#39;</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->通过将它们包含在集成组中来设置帐户权限<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ydb -e grpc://&lt;node.ydb.tech&gt;:2136 -d /Root/testdb --user root yql -s <span style="color:#e6db74">&#39;ALTER GROUP `ADMINS` ADD USER user1&#39;</span></span></span></code></pre></div></blockquote>
<hr>
<h3 id="测试创建的数据库">测试创建的数据库</h3>
<ul>
<li>
<ol>
<li><a href="https://ydb.tech/en/docs/reference/ydb-cli/install" rel="external" target="_self">按照文档</a>中的描述安装<code>YDB CLI</code>，创建一个<code>test_table</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>&lt;node.ydb.tech&gt;</code>运行支持<code>/Root/testdb</code>数据库的动态节点的服务器的<code>FQDN</code>在哪里</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ydb -e grpc://&lt;node.ydb.tech&gt;:2136 -d /Root/testdb scripting yql --script <span style="color:#e6db74">&#39;CREATE TABLE `testdir/test_table` (id Uint64, title Utf8, PRIMARY KEY (id));&#39;</span></span></span></code></pre></div><ul>
<li>集群开启了<code>TLS</code>流量保护或用户认证方式</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ydb -e grpcs://&lt;node.ydb.tech&gt;:2136 -d /Root/testdb --ca-file ydb-ca.crt --user root scripting yql --script <span style="color:#e6db74">&#39;CREATE TABLE `testdir/test_table` (id Uint64, title Utf8, PRIMARY KEY (id));&#39;</span></span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_postgresql">Install_PostgreSQL</h1>

<h2 id="安装postgresql数据库">安装<code>PostgreSQL</code>数据库</h2>
<ul>
<li>
<ol>
<li><a href="https://www.postgresql.org/ftp/source/" rel="external" target="_self"><code>PostgreSQL</code></a>、<a href="https://download.postgresql.org/pub/" rel="external" target="_self"><code>Download-PostgreSQL</code></a>、<a href="https://ftp.postgresql.org/pub/" rel="external" target="_self"><code>FTP-PostgreSQL</code></a></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install c++ gcc-c++ readline-devel zlib-devel
</span></span><span style="display:flex;"><span>$ curl -o /usr/local/src/postgresql-15.0.tar.gz  https://ftp.postgresql.org/pub/source/v15.0/postgresql-15.0.tar.gz
</span></span><span style="display:flex;"><span>$ tar -zxvf postgresql-15.0.tar.gz 
</span></span><span style="display:flex;"><span>$ cd postgresql-15.0
</span></span><span style="display:flex;"><span>$ view INSTALL</span></span></code></pre></div><ul>
<li>安装</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ./configure --prefix<span style="color:#f92672">=</span>/usr/local/postgresql
</span></span><span style="display:flex;"><span>$ make world
</span></span><span style="display:flex;"><span>$ make install-world
</span></span><span style="display:flex;"><span>$ adduser postgres  	<span style="color:#75715e"># 创建用户</span>
</span></span><span style="display:flex;"><span>$ mkdir -p /usr/local/postgresql/data
</span></span><span style="display:flex;"><span>$ chown -R postgres. /usr/local/postgresql/data
</span></span><span style="display:flex;"><span>$ su - postgres
</span></span><span style="display:flex;"><span>$ /usr/local/postgresql/bin/initdb -D /usr/local/postgresql/data
</span></span><span style="display:flex;"><span>$ /usr/local/postgresql/bin/pg_ctl -D /usr/local/postgresql/data -l logfile start</span></span></code></pre></div><ul>
<li>配置<code>Postgresql</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ vim /usr/local/postgresql/data/postgresql.conf
</span></span><span style="display:flex;"><span>listen_addresses <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;192.168.88.0/24&#39;</span>  	<span style="color:#75715e"># 开启远程访问  </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ vim /usr/local/postgresql/data/pg_hba.conf
</span></span><span style="display:flex;"><span><span style="color:#75715e"># IPv4 local connections:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 信任远程连接,修改如下内容，信任指定服务器连接,ident修改为MD5</span>
</span></span><span style="display:flex;"><span>host    all            all      127.0.0.1/32      md5
</span></span><span style="display:flex;"><span>host    all            all      10.1.8.0/24        md5</span></span></code></pre></div><ul>
<li>使用<code>PostgreSQL</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ su - postgres  	<span style="color:#75715e"># 切换进去</span>
</span></span><span style="display:flex;"><span>$ psql  	<span style="color:#75715e"># 进入命令行模式</span>
</span></span><span style="display:flex;"><span>$ <span style="color:#ae81ff">\l</span>  	<span style="color:#75715e"># 列出数据库</span>
</span></span><span style="display:flex;"><span>$ <span style="color:#ae81ff">\d</span>u  	<span style="color:#75715e"># 列出用户</span>
</span></span><span style="display:flex;"><span>$ <span style="color:#ae81ff">\c</span> mydb  	<span style="color:#75715e"># 进入数据库</span></span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_otter">Install_Otter</h1>

<h2 id="otter数据搬运"><code>Otter</code>数据搬运</h2>
<blockquote>
<ul>
<li><a href="https://github.com/alibaba/otter" rel="external" target="_self"><code>Otter</code></a></li>
</ul>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_mysql_pxc">Install_Mysql_PXC</h1>

<h2 id="安装mysql-pxc">安装<code>Mysql-PXC</code></h2>
<blockquote>
<ul>
<li><a href="https://blog.51cto.com/sumongodb/1956086" rel="external" target="_self">企业主流<code>MySQL</code>高可用集群架构三部曲之<code>PXC</code></a></li>
<li><a href="https://www.percona.com/doc/percona-xtradb-cluster/LATEST/install/docker.html" rel="external" target="_self">在<code>Docker</code>容器中运行<code>Percona XtraDB</code>集群</a></li>
</ul>
</blockquote>
<ul>
<li>
<ol>
<li><code>docker</code><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>Mysql-PXC</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;install-mysql-pxc.sh<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sudo yum -y remove docker \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker-client \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker-client-latest \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker-common \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker-latest 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker-latest-logrotate 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker-logrotate \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker-engine  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sudo yum install -y yum-utils
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sudo yum-config-manager --add-repo \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">https://download.docker.com/linux/centos/docker-ce.repo  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sudo yum install -y docker-ce docker-ce-cli containerd.io
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sleep 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sudo systemctl start docker
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sudo systemctl enable docker
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">mkdir -p /opt/data/{data-3306.data-3307,data-3308}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker network create pxc-network  	# 创建网络
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker run -i -d -p 3306:3306 -v /etc/localtime:/etc/localtime -e MYSQL_ROOT_PASSWORD=root -e CLUSTER_NAME=cluster1 --name=node1 --privileged=true --net=pxc-network percona/percona-xtradb-cluster:5.7
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sleep 15
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker run -i -d -p 3307:3306 -v /etc/localtime:/etc/localtime -e MYSQL_ROOT_PASSWORD=root -e CLUSTER_NAME=cluster1 -e CLUSTER_JOIN=node1 --name=node2 --privileged=true --net=pxc-network percona/percona-xtradb-cluster:5.7
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sleep 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker run -i -d -p 3308:3306 -v /etc/localtime:/etc/localtime -e MYSQL_ROOT_PASSWORD=root -e CLUSTER_NAME=cluster1 -e CLUSTER_JOIN=node1 --name=node3 --privileged=true --net=pxc-network percona/percona-xtradb-cluster:5.7  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sleep 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker exec -it node1 /usr/bin/mysql -uroot -proot -e &#34;show status like &#39;wsrep%&#39;;&#34;  	# 登录数据库查看数据库状态, 修改密码
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># show status like &#39;wsrep%&#39;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>EOF</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><code>Yum</code><!-- raw HTML omitted -->安装<!-- raw HTML omitted --><code>PXC</code></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>
<p><!-- raw HTML omitted -->最少准备三台服务器，在三台服务器上同步执行命令<!-- raw HTML omitted --></p>
</li>
<li>
<p><!-- raw HTML omitted -->先卸载系统自带数据库，防火墙开放同步端口：<!-- raw HTML omitted -->4567<!-- raw HTML omitted --><!-- raw HTML omitted --></p>
</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;pxc-install.sh<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">yum -y remove mariadb* 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">yum install -y https://repo.percona.com/yum/percona-release-latest.noarch.rpm  	# 安装 PXC 的 Yum 源
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">yum install Percona-XtraDB-Cluster-57 -y  	# 安装 PXC 数据库
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">systemctl enable mysql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">systemctl start mysql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">pass=`grep &#34;temporary password&#34; /var/log/mysqld.log |awk &#39;{print $11}&#39;` 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">password=`openssl rand -base64 14`  	# 生成随即密码  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">mysql -uroot -p$pass -e &#34;alter user &#39;root&#39;@&#39;localhost&#39; identified by &#39;$password&#39;;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">mysql -uroot -p$password -e &#34; flush privileges;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->关闭所有节点数据库、并修改配置文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl stop mysql</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->修改<!-- raw HTML omitted --><code>my.cnf</code><!-- raw HTML omitted -->配置文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/etc/my.cnf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[mysqld]  	# 必须定义
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">!includedir /etc/my.cnf.d/  	# 原有不动
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">!includedir /etc/percona-xtradb-cluster.conf.d/  	# 原有不动
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">wsrep_provider=/usr/lib64/galera3/libgalera_smm.so  	# 提供程序的路径
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">wsrep_cluster_name=pxc-cluster  	# 定义的集群名称
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">wsrep_cluster_address=gcomm://192.168.2.11,192.168.2.12,192.168.2.13  # 所有的集群节点IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">wsrep_node_name=pxc1  	# 定义本机的名字
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">wsrep_node_address=192.168.2.11  	# 定义本机IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">wsrep_sst_method=xtrabackup-v2  	# 同步方式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">wsrep_sst_auth=sstuser:password  	# 提供同步密码
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">pxc_strict_mode=ENFORCING  	# 严格模式(强制执行)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">binlog_format=ROW  	# 行格式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">default_storage_engine=InnoDB  	# 默认存储引擎
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">innodb_autoinc_lock_mode=2  	# 自增锁定模式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->先启动主节点，确保主库数据同步到其他从节点<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>wsrep_cluster_size=1</code>表示集群中只有一个节点 已经连接并且状态时<code>primary</code>随时写入数据到集群，再加入其他两个节点之前，需要创建一个SST（State Snapshot Transfer）账号用于集群间通信，必须和主机<code>my.cnf</code>配置的参数一致</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl restart mysql@bootstrap.service
</span></span><span style="display:flex;"><span>$ mysql -uroot -p$password -e <span style="color:#e6db74">&#34;show status like &#39;wsrep%&#39;;&#34;</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->添加用户并且赋予权限 <!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mysql -uroot -p$password -e <span style="color:#e6db74">&#34;CREATE USER &#39;sstuser&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;password&#39;;&#34;</span>  
</span></span><span style="display:flex;"><span>$ mysql -uroot -p$password -e <span style="color:#e6db74">&#34;GRANT RELOAD, LOCK TABLES, PROCESS, REPLICATION CLIENT ON *.* TO &#39;sstuser&#39;@&#39;localhost&#39;;&#34;</span>
</span></span><span style="display:flex;"><span>$ mysql -uroot -p$password -e <span style="color:#e6db74">&#34;FLUSH PRIVILEGES;&#34;</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->在从节点依次启动<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ systemctl start mysql</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><code>PXC</code><!-- raw HTML omitted -->导出数据库<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mysqldump -uroot -p --skip_add_locks --skip-lock-tables  LY_report  &gt; /root/LY_report<span style="color:#e6db74">`</span>date +%F<span style="color:#e6db74">`</span>.sql</span></span></code></pre></div><ul>
<li><a href="http://www.dboracle.com/archivers/%E5%BC%BA%E8%A1%8C%E5%85%B3%E6%9C%BA%E4%B9%8B%E5%90%8E%EF%BC%8Cpercona-xtradb-cluster%E9%9B%86%E7%BE%A4%E6%97%A0%E6%B3%95%E5%90%AF%E5%8A%A8.html" rel="external" target="_self">强行关机之后，<code>PERCONA XTRADB CLUSTER</code>集群无法启动</a></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->查看<!-- raw HTML omitted --><code>grastate.dat</code><!-- raw HTML omitted -->文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/var/lib/mysql/grastate.dat<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># GALERA saved state
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">version: 2.1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">uuid:    8050b2ae-5de7-11ea-b72e-1b7d1643b17c
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">seqno:   975
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">safe_to_bootstrap: 0  	# 此值大的先启动、如果都是 0，找个修改成 1 即可
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div><ul>
<li>4.1.2 <!-- raw HTML omitted -->修改配置文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>vim /etc/percona-xtradb-cluster.conf.d/my.cnf  
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>client<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>socket<span style="color:#f92672">=</span>/var/lib/mysql/mysql.sock
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>mysql<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>prompt<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;\u@db2 \R:\m:\s [\d]&gt; &#34;</span>
</span></span><span style="display:flex;"><span>no-auto-rehash
</span></span><span style="display:flex;"><span>server-id<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>  	<span style="color:#75715e"># server-id每个服务器唯一</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 这里定义数据目录和日志目录</span>
</span></span><span style="display:flex;"><span>datadir<span style="color:#f92672">=</span>/var/lib/mysql
</span></span><span style="display:flex;"><span>socket<span style="color:#f92672">=</span>/var/lib/mysql/mysql.sock
</span></span><span style="display:flex;"><span>log-error<span style="color:#f92672">=</span>/var/log/mysqld.log
</span></span><span style="display:flex;"><span>pid-file<span style="color:#f92672">=</span>/var/run/mysqld/mysqld.pid
</span></span><span style="display:flex;"><span>log-bin <span style="color:#f92672">=</span> /var/lib/mysql/mybinlog
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>log_slave_updates
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>bind-address <span style="color:#f92672">=</span> 0.0.0.0  	<span style="color:#75715e"># 监听地址</span>
</span></span><span style="display:flex;"><span>port <span style="color:#f92672">=</span> <span style="color:#ae81ff">3306</span>  	<span style="color:#75715e"># 监听端口</span>
</span></span><span style="display:flex;"><span>default_storage_engine<span style="color:#f92672">=</span>InnoDB  	<span style="color:#75715e"># 默认数据库引擎</span>
</span></span><span style="display:flex;"><span>character-set-server <span style="color:#f92672">=</span> utf8mb4  	<span style="color:#75715e"># 字符集</span>
</span></span><span style="display:flex;"><span>collation-server <span style="color:#f92672">=</span> utf8mb4_general_ci  	<span style="color:#75715e"># 排序规则</span>
</span></span><span style="display:flex;"><span>max_connections <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span>  	<span style="color:#75715e"># 最大连接数</span>
</span></span><span style="display:flex;"><span>open_files_limit <span style="color:#f92672">=</span> <span style="color:#ae81ff">65535</span>  	<span style="color:#75715e"># 限制打开文件数</span>
</span></span><span style="display:flex;"><span>default-time-zone <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;+8:00&#39;</span>  	<span style="color:#75715e"># 默认时区</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设置数据库事务隔离级别</span>
</span></span><span style="display:flex;"><span>transaction_isolation <span style="color:#f92672">=</span> REPEATABLE-READ
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 配置超时时间</span>
</span></span><span style="display:flex;"><span>interactive_timeout <span style="color:#f92672">=</span> <span style="color:#ae81ff">600</span>
</span></span><span style="display:flex;"><span>wait_timeout <span style="color:#f92672">=</span> <span style="color:#ae81ff">600</span>
</span></span><span style="display:flex;"><span>connect_timeout <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>lock_wait_timeout <span style="color:#f92672">=</span> <span style="color:#ae81ff">3600</span>
</span></span><span style="display:flex;"><span>max_allowed_packet <span style="color:#f92672">=</span> 64M  	<span style="color:#75715e"># 限制数据库服务器接收数据包的大小</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 配置排序和join的buffer大小</span>
</span></span><span style="display:flex;"><span>sort_buffer_size <span style="color:#f92672">=</span> 4M
</span></span><span style="display:flex;"><span>join_buffer_size <span style="color:#f92672">=</span> 4M
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 配置binlog</span>
</span></span><span style="display:flex;"><span>binlog_format<span style="color:#f92672">=</span>ROW
</span></span><span style="display:flex;"><span>expire_logs_days<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 开启binlog校验功能</span>
</span></span><span style="display:flex;"><span>binlog_checksum <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>binlog_cache_size <span style="color:#f92672">=</span> 4M
</span></span><span style="display:flex;"><span>sync_binlog <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>  	<span style="color:#75715e"># 每1次提交变更后立刻将binlog落盘</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 配置performance_schema</span>
</span></span><span style="display:flex;"><span>performance_schema <span style="color:#f92672">=</span> on
</span></span><span style="display:flex;"><span>performance_schema_instrument <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;%memory%=on&#39;</span>
</span></span><span style="display:flex;"><span>performance_schema_instrument <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;%lock%=on&#39;</span>
</span></span><span style="display:flex;"><span>skip-external-locking <span style="color:#f92672">=</span> on
</span></span><span style="display:flex;"><span>skip-name-resolve <span style="color:#f92672">=</span> on  	<span style="color:#75715e"># 禁用域名解析</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 禁用软链接</span>
</span></span><span style="display:flex;"><span>symbolic-links<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>back_log <span style="color:#f92672">=</span> <span style="color:#ae81ff">1024</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 慢日志查询配置</span>
</span></span><span style="display:flex;"><span>slow_query_log <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>long_query_time <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>slow_query_log_file <span style="color:#f92672">=</span> /var/log/mysqld/slow.log
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 配置每个EVENT都要执行刷盘操作</span>
</span></span><span style="display:flex;"><span>sync_master_info <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>sync_relay_log_info <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>sync_relay_log <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>log_slave_updates <span style="color:#f92672">=</span> on
</span></span><span style="display:flex;"><span>relay_log_recovery <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>relay_log_purge <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>master_info_repository <span style="color:#f92672">=</span> TABLE
</span></span><span style="display:flex;"><span>relay_log_info_repository <span style="color:#f92672">=</span> TABLE
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># InnoDB引擎配置</span>
</span></span><span style="display:flex;"><span>innodb_file_per_table <span style="color:#f92672">=</span> on
</span></span><span style="display:flex;"><span>innodb_checksums <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>innodb_checksum_algorithm <span style="color:#f92672">=</span> crc32
</span></span><span style="display:flex;"><span>innodb_status_file <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>innodb_status_output <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>innodb_status_output_locks <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>innodb_stats_on_metadata <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>innodb_open_files <span style="color:#f92672">=</span> <span style="color:#ae81ff">65535</span>
</span></span><span style="display:flex;"><span>innodb_flush_method <span style="color:#f92672">=</span> O_DIRECT
</span></span><span style="display:flex;"><span>innodb_flush_sync <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>innodb_flush_neighbors <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 每个事务提交后立即刷新binlog文件</span>
</span></span><span style="display:flex;"><span>innodb_flush_log_at_trx_commit <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>innodb_monitor_enable<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;module_innodb&#34;</span>
</span></span><span style="display:flex;"><span>innodb_monitor_enable<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;module_server&#34;</span>
</span></span><span style="display:flex;"><span>innodb_monitor_enable<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;module_dml&#34;</span>
</span></span><span style="display:flex;"><span>innodb_monitor_enable<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;module_ddl&#34;</span>
</span></span><span style="display:flex;"><span>innodb_monitor_enable<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;module_trx&#34;</span>
</span></span><span style="display:flex;"><span>innodb_monitor_enable<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;module_os&#34;</span>
</span></span><span style="display:flex;"><span>innodb_monitor_enable<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;module_purge&#34;</span>
</span></span><span style="display:flex;"><span>innodb_monitor_enable<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;module_log&#34;</span>
</span></span><span style="display:flex;"><span>innodb_monitor_enable<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;module_lock&#34;</span>
</span></span><span style="display:flex;"><span>innodb_monitor_enable<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;module_buffer&#34;</span>
</span></span><span style="display:flex;"><span>innodb_monitor_enable<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;module_index&#34;</span>
</span></span><span style="display:flex;"><span>innodb_monitor_enable<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;module_ibuf_system&#34;</span>
</span></span><span style="display:flex;"><span>innodb_monitor_enable<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;module_buffer_page&#34;</span>
</span></span><span style="display:flex;"><span>innodb_monitor_enable<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;module_adaptive_hash&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># SQL mode配置，这里是默认值</span>
</span></span><span style="display:flex;"><span>sql_mode <span style="color:#f92672">=</span> ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># GTID配置</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#gtid_mode = on</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#enforce_gtid_consistency = 1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># wsrep配置</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># This changes how InnoDB autoincrement locks are managed and is a requirement for Galera</span>
</span></span><span style="display:flex;"><span>innodb_autoinc_lock_mode<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>wsrep_cluster_name<span style="color:#f92672">=</span>pxc-cluster  	<span style="color:#75715e"># Cluster name集群名称</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>wsrep_cluster_address<span style="color:#f92672">=</span>gcomm://10.14.23.78:4567,10.14.23.180:4567,10.14.23.181:4567
</span></span><span style="display:flex;"><span>wsrep_provider<span style="color:#f92672">=</span>/usr/lib64/galera3/libgalera_smm.so
</span></span><span style="display:flex;"><span><span style="color:#75715e">#If wsrep_node_name is not specified,  then system hostname will be used</span>
</span></span><span style="display:flex;"><span>wsrep_node_name <span style="color:#f92672">=</span> db2
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Slave thread to use</span>
</span></span><span style="display:flex;"><span>wsrep_slave_threads<span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># SST method</span>
</span></span><span style="display:flex;"><span>wsrep_sst_method<span style="color:#f92672">=</span>xtrabackup-v2
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Node IP address</span>
</span></span><span style="display:flex;"><span>wsrep_node_address <span style="color:#f92672">=</span> 10.14.23.180
</span></span><span style="display:flex;"><span>wsrep_sst_receive_address <span style="color:#f92672">=</span> 10.14.23.180
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Authentication for SST method</span>
</span></span><span style="display:flex;"><span>wsrep_sst_auth<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;sstuser:sstuser_password&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># pxc_strict_mode allowed values: DISABLED,PERMISSIVE,ENFORCING,MASTER</span>
</span></span><span style="display:flex;"><span>pxc_strict_mode<span style="color:#f92672">=</span>ENFORCING
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>mysqld_safe<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>pid-file <span style="color:#f92672">=</span> /var/run/mysqld/mysqld.pid
</span></span><span style="display:flex;"><span>socket   <span style="color:#f92672">=</span> /var/lib/mysql/mysql.sock
</span></span><span style="display:flex;"><span>nice     <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>EOF</span></span></code></pre></div></blockquote>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_mysql_router">Install_MySQL_Router</h1>

<h2 id="mysql-router"><code>MySQL Router</code></h2>
<blockquote>
<ul>
<li><code>MySQL Router</code>是<code>MySQL</code>官方提供的路由器和负载均衡器</li>
<li>支持基于轮询或自动检测到的服务器状态的负载均衡，可以将读写请求路由到不同的<code>MySQL</code>服务器</li>
<li><code>MySQL Router</code>提供了简单的配置和管理接口，适合<code>MySQL</code>官方产品的环境</li>
<li><a href="https://dev.mysql.com/doc/mysql-router/8.0/en/" rel="external" target="_self"><code>MySQL Router</code></a></li>
</ul>
</blockquote>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_maxscale">Install_MaxScale</h1>

<h2 id="maxscale轻量级数据库代理"><code>MaxScale轻量级</code>数据库代理</h2>
<blockquote>
<ul>
<li><code>MaxScale</code>是<code>MariaDB</code>开发的一个轻量级的数据库代理和路由器</li>
<li>支持高级的查询路由和负载均衡功能，包括读写分离、故障切换和高可用性</li>
<li><code>MaxScale</code>提供了丰富的插件和模块化架构，可以轻松扩展其功能</li>
<li><a href="https://mariadb.com/kb/en/maxscale/" rel="external" target="_self"><code>MaxScale</code></a></li>
</ul>
</blockquote>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_proxysql">Install_ProxySQL</h1>

<h2 id="proxysql代理"><code>ProxySQL</code>代理</h2>
<blockquote>
<ul>
<li><code>ProxySQL</code>是一个高性能的<code>MySQL</code>代理，支持数据库连接池、查询缓存、负载均衡和读写分离</li>
<li>它可以根据<code>SQL</code>查询类型（读或写）将请求路由到不同的<code>MySQL</code>服务器</li>
<li><code>ProxySQL</code>提供了丰富的配置选项，可以根据需求调整负载均衡策略和连接池管理</li>
<li><a href="https://proxysql.com/" rel="external" target="_self"><code>ProxySQL</code></a></li>
</ul>
</blockquote>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_manticore_search">Install_Manticore_Search</h1>

<h2 id="manticoresearch"><code>manticoresearch</code></h2>
<blockquote>
<ul>
<li>易于使用的开源快速搜索数据库.</li>
<li><a href="https://manticoresearch.com/" rel="external" target="_self"><code>Manticore Search</code></a></li>
</ul>
</blockquote>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_canal">Install_Canal</h1>

<h2 id="canal数据库增量日志解析"><code>Canal</code>数据库增量日志解析</h2>
<blockquote>
<ul>
<li><a href="https://github.com/alibaba/canal" rel="external" target="_self"><code>Canal</code></a></li>
</ul>
</blockquote>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="use_mysql">Use_Mysql</h1>

<h1 id="数据库使用">数据库使用</h1>
<h2 id="数据结构可视化">数据结构可视化</h2>
<blockquote>
<ul>
<li><a href="https://www.cs.usfca.edu/~galles/visualization/" rel="external" target="_self">数据结构可视化</a></li>
</ul>
</blockquote>
<hr>
<h2 id="数据库连接工具">数据库连接工具</h2>
<blockquote>
<table>
<thead>
<tr>
<th>名称地址</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://downloads.mysql.com/archives/workbench/" rel="external" target="_self"><code>WorkBenCh</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://downloads.mysql.com/archives/community/" rel="external" target="_self"><code>MySQL</code>产品档案</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://mirrors.cloud.tencent.com/mysql/downloads/MySQL-8.0/" rel="external" target="_self">下载<code>MySQL-8.0</code>的索引</a></td>
<td></td>
</tr>
<tr>
<td><a href="http://www.notedeep.com/page/282" rel="external" target="_self"><code>Mysql</code>深入学习笔记</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://sqlyog.softonic.cn/" rel="external" target="_self"><code>SQLyog</code>数据库客户端连接工具</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://dbeaver.io/download/" rel="external" target="_self"><code>DBeaver</code>数据库客户端连接工具</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/pifeifei/mysql-workbench-zh-cn" rel="external" target="_self"><code>Mysql WorkBenCh</code>菜单中文汉化</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.jianshu.com/p/4113cd5ef139" rel="external" target="_self"><code>Navicat Premium 15</code>安装与激活</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://learnku.com/articles/67706" rel="external" target="_self"><code>Navicat Premium 16</code>下载与安装破解教程</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/8.0/en/binary-installation.html" rel="external" target="_self">使用通用二进制文件在<code>Unix/Linux </code>安装<code>MySQL</code></a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.jianshu.com/p/523c132006aa" rel="external" target="_self"><code>Navicat Premium 15</code>永久破解激活工具及安装教程</a></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h2 id="数据库常用命令">数据库常用命令</h2>
<blockquote>
<table>
<thead>
<tr>
<th>数据库命令</th>
<th>说明</th>
<th>举例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>select</code></td>
<td>从数据库中提取数据</td>
<td>查看用户数据：<code>select user,host from mysql.user \G;</code></td>
</tr>
<tr>
<td><code>update</code></td>
<td>更新数据库中的数据</td>
<td></td>
</tr>
<tr>
<td><code>delete</code></td>
<td>从数据库中删除数据</td>
<td></td>
</tr>
<tr>
<td><code>insert into</code></td>
<td>向数据库中插入数据</td>
<td>插入数据：<code>insert into tiantian.tt1 values(1,'lisi');</code></td>
</tr>
<tr>
<td><code>create database</code></td>
<td>创建新数据库</td>
<td>创建数据库：<code>create database tiantian;</code></td>
</tr>
<tr>
<td><code>alter database</code></td>
<td>更改数据库</td>
<td></td>
</tr>
<tr>
<td><code>create table</code></td>
<td>创建表</td>
<td>创建数据表：<code>create table tiantian.tt1(id int, name varchar(50));</code></td>
</tr>
<tr>
<td><code>alter table</code></td>
<td>更改表</td>
<td></td>
</tr>
<tr>
<td><code>drop table</code></td>
<td>删除表</td>
<td></td>
</tr>
<tr>
<td><code>create index</code></td>
<td>创建索引(搜索键)</td>
<td></td>
</tr>
<tr>
<td><code>drop index</code></td>
<td>删除索引</td>
<td></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th><code>Where</code>语句中的运算符</th>
<th>说明</th>
<th>举例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>=</code></td>
<td>等于</td>
<td></td>
</tr>
<tr>
<td><code>&lt;&gt;</code></td>
<td>不等于：在<code>SQL</code>的一些版本中，改操作符被写成<code>!=</code></td>
<td></td>
</tr>
<tr>
<td><code>&gt;</code></td>
<td>大于</td>
<td></td>
</tr>
<tr>
<td><code>&lt;</code></td>
<td>小于</td>
<td></td>
</tr>
<tr>
<td><code>&gt;=</code></td>
<td>大于等于</td>
<td></td>
</tr>
<tr>
<td><code>&lt;=</code></td>
<td>小于等于</td>
<td></td>
</tr>
<tr>
<td><code>BETWEEN</code></td>
<td>在某个范围内</td>
<td></td>
</tr>
<tr>
<td><code>LIKE</code></td>
<td>搜索某种模式</td>
<td></td>
</tr>
<tr>
<td><code>IN</code></td>
<td>指定针对某个列的多个可能值</td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<h3 id="查询数据库连接数">查询数据库连接数</h3>
<blockquote>
<ul>
<li>
<!-- raw HTML omitted -->
</li>
<li><!-- raw HTML omitted -->查看当前活动线程状态<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>Threads_cached</code><!-- raw HTML omitted -->缓存的线程数量，这些线程处于睡眠状态以备复用<!-- raw HTML omitted --></li>
<li><code>Threads_connected</code><!-- raw HTML omitted -->当前打开的连接数<!-- raw HTML omitted --></li>
<li><code>Threads_created</code><!-- raw HTML omitted -->为处理连接而创建的线程数<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> status <span style="color:#66d9ef">like</span>  <span style="color:#e6db74">&#39;Threads%&#39;</span>; </span></span></code></pre></div><ul>
<li>如果<code>Threads_created</code>很大，您可能需要增加<code>thread_cache_size</code>的值。缓存失误率可以通过<code>Threads_created/Connections</code>计算</li>
</ul>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->显示用户正在运行的线程<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> full processlist;</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->查看最大链接数<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> variables <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;%max_connections%&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 临时增加连接数，配置文件增加参数：max_connections=4000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">set</span> GLOBAL max_connections<span style="color:#f92672">=</span><span style="color:#ae81ff">4000</span>;</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->查看连接的用户和<!-- raw HTML omitted --><code>IP</code><!-- raw HTML omitted -->以及超时时间<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#75715e"># 查看连接的用户和IP以及超时时间，或者使用：count(*) 统计总统连接数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> information_schema.processlist;</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->看连接的用户和每个<!-- raw HTML omitted --><code>IP</code><!-- raw HTML omitted -->的连接总数地址<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span> <span style="color:#a6e22e">substring_index</span>(host, <span style="color:#e6db74">&#39;:&#39;</span>,<span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">AS</span> host_ip,<span style="color:#f92672">`</span><span style="color:#66d9ef">user</span><span style="color:#f92672">`</span>,db,state,<span style="color:#a6e22e">count</span>(<span style="color:#f92672">*</span>) <span style="color:#66d9ef">FROM</span> information_schema.processlist <span style="color:#66d9ef">GROUP</span> <span style="color:#66d9ef">BY</span> state,host_ip,<span style="color:#f92672">`</span><span style="color:#66d9ef">user</span><span style="color:#f92672">`</span>,db;</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted --><!-- raw HTML omitted --></li>
</ul>
</blockquote>
<hr>
<h3 id="查询数据库慢语句">查询数据库慢语句</h3>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#75715e"># 查询占用超时慢语句
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> information_schema.processlist <span style="color:#66d9ef">where</span> Command <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;Sleep&#39;</span> <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> <span style="color:#66d9ef">Time</span> <span style="color:#66d9ef">desc</span> <span style="color:#960050;background-color:#1e0010">\</span>G;</span></span></code></pre></div></blockquote>
<hr>
<h3 id="三种修改数据库密码">三种修改数据库密码</h3>
<blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->第一种修改方式，<code>8.0</code>用此方法<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">alter</span> <span style="color:#66d9ef">user</span> <span style="color:#e6db74">&#39;root&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;localhost&#39;</span> <span style="color:#66d9ef">identified</span> <span style="color:#66d9ef">by</span> <span style="color:#e6db74">&#39;123&#39;</span>;
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">alter</span> <span style="color:#66d9ef">user</span> <span style="color:#e6db74">&#39;root&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;localhost&#39;</span> <span style="color:#66d9ef">identified</span> <span style="color:#66d9ef">with</span> mysql_native_password <span style="color:#66d9ef">by</span> <span style="color:#e6db74">&#39;newpassword&#39;</span>;</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->第二种修改方式<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">set</span> password <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#39;root&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;localhost&#39;</span><span style="color:#f92672">=</span><span style="color:#a6e22e">password</span>(<span style="color:#e6db74">&#39;newpassword&#39;</span>);</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->第三种修改方式<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">update</span> mysql.<span style="color:#66d9ef">user</span> <span style="color:#66d9ef">set</span> authentication_string<span style="color:#f92672">=</span><span style="color:#a6e22e">password</span>(<span style="color:#e6db74">&#39;123qwe&#39;</span>) <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">user</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;root&#39;</span> <span style="color:#66d9ef">and</span> Host <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;localhost&#39;</span>; </span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->更改密码为<!-- raw HTML omitted --><code>123456</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">update</span> destoon_member <span style="color:#66d9ef">set</span> password<span style="color:#f92672">=</span><span style="color:#960050;background-color:#1e0010">’</span><span style="color:#ae81ff">14</span>e1b600b1fd579f47433b88e8d85291<span style="color:#960050;background-color:#1e0010">′</span> <span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>username<span style="color:#f92672">=</span><span style="color:#960050;background-color:#1e0010">’</span>admin<span style="color:#960050;background-color:#1e0010">’</span>;</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->忘记数据库密码<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> cat <span style="color:#f92672">&gt;/</span>etc<span style="color:#f92672">/</span>my.cnf<span style="color:#f92672">&lt;&lt;-</span>EOF
</span></span><span style="display:flex;"><span>[mysqld]  	<span style="color:#75715e"># 在配置文件中最上面添加
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>skip<span style="color:#f92672">-</span><span style="color:#66d9ef">grant</span><span style="color:#f92672">-</span><span style="color:#66d9ef">tables</span>
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 重启mysql服务  直接使用 mysql -uroot -p 不输入密码直接回车进入 修改密码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">update</span> <span style="color:#66d9ef">user</span> <span style="color:#66d9ef">set</span> authentication_string<span style="color:#f92672">=</span><span style="color:#a6e22e">password</span>(<span style="color:#e6db74">&#39;root&#39;</span>);</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="数据库备份还原">数据库备份、还原</h3>
<h4 id="数据库备份">数据库备份</h4>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>mysqldump</code><!-- raw HTML omitted -->备份数据库<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>手动备份</li>
</ul>
<blockquote>
<ul>
<li><code>--set-gtid-purged=OFF</code><!-- raw HTML omitted -->：如果源库开启了<!-- raw HTML omitted --><code>GTID</code><!-- raw HTML omitted -->特性，使用<!-- raw HTML omitted --><code>mysqldump</code><!-- raw HTML omitted -->导出数据时，存在需要<!-- raw HTML omitted --><code>super</code><!-- raw HTML omitted -->权限执行的语句：<!-- raw HTML omitted --><code>SET @@SESSION.SQL_LOG_BIN= 0;</code>，<code>SET @@GLOBAL.GTID_PURGED=´18f9a804-343b-11e5-a21d-b083fed01601:1-2;</code></li>
<li><code>--all-databases --triggers --routines --events</code></li>
<li><code>--column-statistics=0</code><!-- raw HTML omitted -->：通过此参数禁用它，由于<!-- raw HTML omitted --><code>MySQL8</code><!-- raw HTML omitted -->中默认启用的新标志所致<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->备份用户权限<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">GRANT</span> <span style="color:#66d9ef">SELECT</span>,RELOAD,<span style="color:#66d9ef">LOCK</span> <span style="color:#66d9ef">TABLES</span>,REPLICATION CLIENT,<span style="color:#66d9ef">SHOW</span> VIEW,EVENT,<span style="color:#66d9ef">TRIGGER</span>,PROCESS <span style="color:#66d9ef">ON</span> <span style="color:#f92672">*</span>.<span style="color:#f92672">*</span> <span style="color:#66d9ef">TO</span> <span style="color:#e6db74">&#39;backup&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;localhost&#39;</span> <span style="color:#66d9ef">identified</span> <span style="color:#66d9ef">BY</span> <span style="color:#e6db74">&#39;passwoord&#39;</span>;</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->备份多个数据库<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /bin/mysql -u root -p<span style="color:#e6db74">&#39;password&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-S /opt/data/data_3303/mysql.sock  -e <span style="color:#e6db74">&#39;show databases;&#39;</span>| <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>grep -E -v <span style="color:#e6db74">&#34;sys|mysql|information_schema|performance_schema|Database&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>|grep -E <span style="color:#e6db74">&#34;.*datebases1</span>$<span style="color:#e6db74">|.*datebases2</span>$<span style="color:#e6db74">&#34;</span> | <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>xargs /bin/mysqldump -u root -p<span style="color:#e6db74">&#39;password&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-S /opt/data/data_3306/mysql.sock <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--single-transaction --no-autocommit <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--master-data<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> --skip-lock-tables --databases &gt;<span style="color:#e6db74">`</span>date +%F<span style="color:#e6db74">`</span>-datebases_name.sql</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->导出全部库<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mysqldump -uroot -p --all-databases &gt; /tmp/all_databases.sql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ /usr/local/mysql/bin/mysqldump -u root -p<span style="color:#e6db74">&#39;passowrd&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-S /opt/data/data_3306/mysql.sock <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--all-databases --lock-tables<span style="color:#f92672">=</span>false <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--routines --single_transaction --flush-logs <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--skip-lock-tables --master-data<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>| gzip &gt;/tmp/mysql-all-<span style="color:#e6db74">`</span>date +%F_%H%M%S<span style="color:#e6db74">`</span>.sql.gz </span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->导出单个库<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mysqldump -uroot -p --databases databases_name &gt; /tmp/databases_name.sql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ /bin/mysqldump -uroot -p<span style="color:#e6db74">&#39;passowrd&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--set-gtid-purged<span style="color:#f92672">=</span>OFF --single-transaction <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--master-data<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> --flush-logs <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-S /opt/data/data_3306/mysql.sock <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>database | gzip &gt;/tmp/database<span style="color:#e6db74">`</span>date +%F_%H%M%S<span style="color:#e6db74">`</span>.sql.gz</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->导出指定表<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mysqldump -uroot -p --databases databases_name tables_name &gt; /tmp/databases_name_tables_name.sql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ bin/mysql -u root -p<span style="color:#e6db74">&#39;password&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-S /opt/data/data_3306/mysql.sock <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-e <span style="color:#e6db74">&#39;select table_name from information_schema.tables where table_schema like &#34;game\-center\_ali&#34;;&#39;</span>|egrep <span style="color:#e6db74">&#34;.*record&#34;</span> | xargs /bin/mysqldump -u root -p<span style="color:#e6db74">&#39;password&#39;</span> -S /opt/data/data_16303/mysql.sock  databases_name -t --tables &gt;/tmp/tables_name.sql</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->导出表结构加<!-- raw HTML omitted --><code>-d</code><!-- raw HTML omitted -->参数<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /bin/mysqldump -d -uroot -p<span style="color:#e6db74">&#39;passowrd&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-S /opt/data/data_3306/mysql.sock database_name &gt; database_name.sql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ /bin/mysqldump -d -uroot -p<span style="color:#e6db74">&#39;passowrd&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-S /opt/data/data_3306/mysql.sock --databases database_name &gt; database_name.sql</span></span></code></pre></div></blockquote>
</blockquote>
<ul>
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>Mysql</code><!-- raw HTML omitted -->脚本备份并通知<!-- raw HTML omitted --><code>Telegram</code></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/script/Backup_Mysql.sh<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DATA=$(date +%F_%H%M%S)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## set ff=unix # 修改换行符
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 定义备份目录
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MYSQL_BACKUP_PATH=/opt/backup/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 定义Telegram 机器人ID和报警组
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">TELEGRAM_BOT_ID=&#39;Telegram BOT_ID:BOT_Key&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">TELEGRAM_GROUP_ID=&#39;GROUP_ID&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 定义连接数据库 账户密码IP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">USER_NAME=&#39;backup&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">USER_PASSWORD=&#39;pass&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DATABASES=&#39;databases name&#39;  	# 备份表用
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">USER_HOST_1=&#39;IP_1&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">USER_HOST_2=&#39;IP_2&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 过滤数据库, xargs和sed &#39;1d&#39;效果一样
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DATABASES_1=`/bin/mysql -u${USER_NAME} -p&#34;${USER_PASSWORD}&#34; -h&#34;${USER_HOST_1}&#34; -e &#39;show databases;&#39; | grep -E -v &#34;sys|mysql|information_schema|performance_schema|Database&#34; | /bin/xargs`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## DATABASES_2=`/bin/mysql -u${USER_NAME} -p&#34;${USER_PASSWORD}&#34; -h&#34;${USER_HOST_2}&#34; -e &#39;show databases;&#39; | grep -E -v &#34;sys|mysql|information_schema|performance_schema|Database&#34; | sed &#39;1d&#39;`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 检测备份目录是否存在，不存在就创建
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## /bin/test -d /opt/backup
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">function TEST_BACKUP_DIR() {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if [ ! -d ${MYSQL_BACKUP_PATH} ];then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	/bin/mkdir -p ${MYSQL_BACKUP_PATH}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 开始准备备份数据库
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">cd ${MYSQL_BACKUP_PATH}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/bin/curl -X POST &#34;https://api.telegram.org/bot${TELEGRAM_BOT_ID}/sendMessage&#34; -d &#34;chat_id=${TELEGRAM_GROUP_ID}&amp;text=开始备份：${DATABASES_1} ${DATABASES_2} 数据库&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">for i in ${DATABASES_1};do
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	/usr/local/mysql/bin/mysqldump -u${USER_NAME} -p&#34;${USER_PASSWORD}&#34; -h${USER_HOST_1} --single-transaction --no-autocommit --master-data=1 --skip-lock-tables ${i} &gt; ${MYSQL_BACKUP_PATH}${i}-`date +%F`.sql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">done
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if [ $? -eq 0 ];then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> /bin/tar -zcvf ${MYSQL_BACKUP_PATH}${i}-`date +%F`.tar.gz ${i}-`date +%F`.sql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	/bin/curl -X POST &#34;https://api.telegram.org/bot${TELEGRAM_BOT_ID}/sendMessage&#34; -d &#34;chat_id=${TELEGRAM_GROUP_ID}&amp;text=${DATABASES_1} ${DATABASES_2} 数据库备份完成&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">else
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	/bin/curl -X POST &#34;https://api.telegram.org/bot${TELEGRAM_BOT_ID}/sendMessage&#34; -d &#34;chat_id=${TELEGRAM_GROUP_ID}&amp;text=${DATABASES_1} ${DATABASES_2} 数据库备份失败&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/bin/rm -rf ${MYSQL_BACKUP_PATH}*.sql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 备份数据表
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">function BACKUP_MYSQL_TABLES() {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	cd ${MYSQL_BACKUP_PATH}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	for DATABASES in ${DATABASES_1};do
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	TABLES_1=$(/bin/mysql -u${USER_NAME} -p&#34;${USER_PASSWORD}&#34; -h&#34;${USER_HOST_1}&#34; ${DATABASES} -e &#34;show tables;&#34;|sed &#39;1d&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		for I in ${TABLES_1};do
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			/usr/local/mysql/bin/mysqldump -u${USER_NAME} -p&#34;${USER_PASSWORD}&#34; -h${USER_HOST_1} --single-transaction --no-autocommit --master-data=1 --skip-lock-tables ${I} &gt; ${MYSQL_BACKUP_PATH}${i}-`date +%F`.sql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		done
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		/bin/tar -zcvf ${MYSQL_BACKUP_PATH}${DATABASES}-`date +%F`.tar.gz *.sql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		/bin/rm -rf ${MYSQL_BACKUP_PATH}*.sql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	done	
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	if [ $? -eq 0 ];then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		/bin/curl -X POST &#34;https://api.telegram.org/bot${TELEGRAM_BOT_ID}/sendMessage&#34; -d &#34;chat_id=${TELEGRAM_GROUP_ID}&amp;text=${DATABASES_1} ${DATABASES_2} 数据库备份完成&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	else
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">		/bin/curl -X POST &#34;https://api.telegram.org/bot${TELEGRAM_BOT_ID}/sendMessage&#34; -d &#34;chat_id=${TELEGRAM_GROUP_ID}&amp;text=${DATABASES_1} ${DATABASES_2} 数据库备份失败&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/bin/find ${MYSQL_BACKUP_PATH} -name &#34;databases-*&#34; -mtime +15 -exec  rm  {} \;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h4 id="数据库还原">数据库还原</h4>
<blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->数据库还原、导入<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 第一种方式</span>
</span></span><span style="display:flex;"><span>$ /bin/mysql -u root -p<span style="color:#e6db74">&#39;passowrd&#39;</span> -S /opt/data/data_16303/mysql.sock &lt; /root/all.sql  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 第二种方式  </span>
</span></span><span style="display:flex;"><span>mysql&gt; use mysql;
</span></span><span style="display:flex;"><span>mysql&gt; source /root/databases.sql  	<span style="color:#75715e"># 当前目录绝对路径</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><code>.qp</code><!-- raw HTML omitted -->文件数据库恢复<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ xbstream -x -p <span style="color:#ae81ff">4</span> &lt; ./databases.qp -C /opt/mysql/backup</span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h4 id="使用percona备份工具">使用<code>percona</code>备份工具</h4>
<blockquote>
<ul>
<li><a href="https://segmentfault.com/a/1190000019305858" rel="external" target="_self"><code>Linux</code>运维 <code>mysql</code>数据库的备份与恢复</a></li>
<li><a href="https://cloud.tencent.com/developer/article/1119183" rel="external" target="_self"><code>innobackupex</code>备份恢复<code>+</code>增量备份与恢复</a></li>
<li><code>innobackupex</code>：更多高级管理功能和自动化备份脚本</li>
<li><code>xtrabackup</code>：需要基本的物理备份和恢复功能，并且愿意手动管理备份流程</li>
<li>安装<a href="https://www.percona.com/software/mysql-database/percona-xtrabackup" rel="external" target="_self"><code>XtraBackup</code></a></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 添加yum源</span>
</span></span><span style="display:flex;"><span>$ wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-6.repo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装依赖包</span>
</span></span><span style="display:flex;"><span>$ yum -y install perl perl-devel libaio libaio-devel perl-Time-HiRes perl-DBD-MySQL
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 下载rpm包</span>
</span></span><span style="display:flex;"><span>$ wget https://downloads.percona.com/downloads/Percona-XtraBackup-2.4/Percona-XtraBackup-2.4.27/binary/redhat/7/x86_64/percona-xtrabackup-24-2.4.27-1.el7.x86_64.rpm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装</span>
</span></span><span style="display:flex;"><span>$ yum -y install percona-xtrabackup-24-2.4.27-1.el7.x86_64.rpm</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->手动备份<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->完整以及增量备份<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 完整备份</span>
</span></span><span style="display:flex;"><span>$ innobackupex --host<span style="color:#f92672">=</span>IP --user<span style="color:#f92672">=</span>name --password<span style="color:#f92672">=</span><span style="color:#ae81ff">123456</span> --prot<span style="color:#f92672">=</span><span style="color:#ae81ff">3306</span> --no-timestamp /opt/backup/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 增量备份  基于全量备份实现增量备份，增量备份只支持Innodb</span>
</span></span><span style="display:flex;"><span>$ innobackupex --host<span style="color:#f92672">=</span>IP --user<span style="color:#f92672">=</span>root --password<span style="color:#f92672">=</span><span style="color:#ae81ff">123456</span> --prot<span style="color:#f92672">=</span><span style="color:#ae81ff">3306</span> --no-timestamp --incremental /opt/backup/ --incremental-basedir<span style="color:#f92672">=</span>/opt/backup/<span style="color:#66d9ef">$(</span>date +%F_%T<span style="color:#66d9ef">)</span></span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->数据库恢复流程<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li><code>--decompress</code><!-- raw HTML omitted -->该选项表示解压<!-- raw HTML omitted --><code>--compress</code><!-- raw HTML omitted -->选项压缩文件<!-- raw HTML omitted --></li>
<li><code>--parallel</code><!-- raw HTML omitted -->该选项表示允许多个文件同时解压。为了解压，<!-- raw HTML omitted --><code>qpress</code><!-- raw HTML omitted -->工具必须有安装并且访问这个文件的权限。这个进程将在同一个位置移除原来的压缩/加密文件<!-- raw HTML omitted --></li>
<li><code>--apply-log</code><!-- raw HTML omitted -->该选项表示同<!-- raw HTML omitted --><code>xtrabackup</code><!-- raw HTML omitted -->的<!-- raw HTML omitted --><code>--prepare</code><!-- raw HTML omitted -->参数,一般情况下,在备份完成后，数据尚且不能用于恢复操作，因为备份的数据中可能会包含尚未提交的事务或已经提交但尚未同步至数据文件中的事务。因此，此时数据 文件仍处理不一致状态<!-- raw HTML omitted --></li>
<li><code>--apply-log</code><!-- raw HTML omitted -->的作用是通过回滚未提交的事务及同步已经提交的事务至数据文件使数据文件处于一致性状态<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 1.拷贝备份到data3306(只拷贝日期文件夹下面的文件)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2.cd /opt/data3306</span>
</span></span><span style="display:flex;"><span>$ innobackupex --defaults-file<span style="color:#f92672">=</span>/opt/conf/my_3306.cnf --decompress --parallel<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span> ./
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3.删除所有.qp文件</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 4.恢复数据库(全量)</span>
</span></span><span style="display:flex;"><span>$ cd /opt/data3306
</span></span><span style="display:flex;"><span>$ innobackupex --defaults-file<span style="color:#f92672">=</span>/opt/conf/my_3306.cnf --apply-log  --use-memory<span style="color:#f92672">=</span>4G ./</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->手动恢复<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ service mysql stop
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 初始化全量备份</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ innobackupex --apply-log --redo-only /opt/backup/ --incremental-dir<span style="color:#f92672">=</span>/opt/backup/<span style="color:#66d9ef">$(</span>date +%F_%T<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 初始化整合增量备份</span>
</span></span><span style="display:flex;"><span>$ innobackupex --apply-log --redo-only /data/backup/2017-08-24_22-57-43 --incremental-dir<span style="color:#f92672">=</span>/data/backup/2017-08-24_23-10-21
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 把整合好的增量再次初始化</span>
</span></span><span style="display:flex;"><span>$ innobackupex --apply-log  /data/backup/2017-08-24_22-57-43
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 备份MySQL下data数据目录要恢复的数据库</span>
</span></span><span style="display:flex;"><span>$ mv  /usr/local/mysql/data/ceshi/  /opt/backup/<span style="color:#66d9ef">$(</span>date +%F_%T<span style="color:#66d9ef">)</span>/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 把整合后的全量备份目录下要恢复的数据库复制到MySQL下data目录</span>
</span></span><span style="display:flex;"><span>$ cp -a  /opt/backup/quanliang/ceshi /usr/local/mysql/data/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 重新赋予属组mysql权限</span>
</span></span><span style="display:flex;"><span>$ chown -R mysql.mysql   /usr/local/mysql/data/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动数据库</span>
</span></span><span style="display:flex;"><span>$ service mysql start</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>--copy</code><!-- raw HTML omitted -->参数实现备份恢复<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ service mysql stop
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 把data数据目录下数据进行备份</span>
</span></span><span style="display:flex;"><span>$ cp -a  /usr/local/mysql/data/* /opt/backup/<span style="color:#66d9ef">$(</span>date +%F_%T<span style="color:#66d9ef">)</span>/
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 把要恢复的数据备份生成</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ innobackupex  --apply-log --redo-only /opt/backup/quanliang/ceshi_danku/  	<span style="color:#75715e"># 这个是单库备份目录</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># data目录必须为空</span>
</span></span><span style="display:flex;"><span>$ innobackupex  --copy-back /opt/backup/quanliang/ceshi_danku/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 重新赋予属组权限</span>
</span></span><span style="display:flex;"><span>$ chown -R mysql.mysql /usr/local/mysql/data/
</span></span><span style="display:flex;"><span>$ service mysql start</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->使用<!-- raw HTML omitted --><code>Mysql</code><!-- raw HTML omitted -->脚本备份并通知钉钉接口<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;/opt/script/Backup_Mysql_innobackupex.sh<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## ***************************************************************#
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">##  Create: DBA
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## ***************************************************************#
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## echo `hostname -I` |sed &#39;s/ /#/g&#39; -  &gt;/tmp/ipaddr.txt
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 定义Telegram 机器人ID和报警组
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">TELEGRAM_BOT_ID=&#39;Telegram bot_id:bot_key&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">TELEGRAM_GROUP_ID=&#39;GROUP_ID&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">IP_ADDRE=$(hostname -I |awk &#39;{print $1}&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">USER_NAME=&#39;backup&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">USER_PASSWORD=&#39;IvV8BhpvHb/7EA==&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DATABASES=&#39;databases name&#39; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">backup_time=`date +&#39;%Y%m%d%m&#39;`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">backup_base=&#34;/opt/backup/dbback&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">backup_dir=&#34;$backup_base/full&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">backup_log=&#34;$backup_base/log/xtra_${backup_time}.log&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">slave_days=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 钉钉接口
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">function SendToDingding_error(){
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> #Dingding_Url=&#34;https://oapi.dingtalk.com/robot/send?access_token=d5201a579163dc6045b6da6d8dbc1cdc1d935698050971ceddb5a8956e9507ee&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> Dingding_Url=&#34;https://api.telegram.org/bot${TELEGRAM_BOT_ID}/sendMessage?chat_id=${TELEGRAM_GROUP_ID}&amp;text=%22${IP_ADDRE}mysqlbak%20failure!Please check %22&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # 发送钉钉消息
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> curl &#34;${Dingding_Url}&#34; -H &#39;Content-Type: application/json&#39; -d &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     \&#34;actionCard\&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         \&#34;title\&#34;: \&#34;$1\&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         \&#34;text\&#34;: \&#34;$2\&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         \&#34;hideAvatar\&#34;: \&#34;0\&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         \&#34;btnOrientation\&#34;: \&#34;0\&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         \&#34;btns\&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">             {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                 \&#34;title\&#34;: \&#34;$1\&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                 \&#34;actionURL\&#34;: \&#34;\&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">             }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     \&#34;msgtype\&#34;: \&#34;actionCard\&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> }&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 安装备份工具 innobackupex 或 xtrabackup
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if [ ! -x /usr/bin/innobackupex ];then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     yum -y install  http://www.percona.com/downloads/percona-release/redhat/0.1-4/percona-release-0.1-4.noarch.rpm
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     yum -y install percona-xtrabackup-24 qpress
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 开始创建目录
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if [ ! -d ${backup_dir} ];then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> mkdir -p ${backup_dir}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if [ ! -d ${backup_base}/log ];then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> mkdir -p ${backup_base}/log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">start_time=`date +&#39;%Y%m%d_%H:%M:%S&#39;`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">start_file=`date +&#39;%Y-%m-%d_%H-%M-%S&#39;`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 开始备份数据库
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo -e &#34;`date +&#39;%Y-%m-%d %H:%M:%S&#39;` 开始物理备份数据库 ${ipaddr} ...&#34; &gt;&gt; ${backup_log}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/usr/bin/innobackupex --defaults-file=/opt/conf/my_16303.cnf --user=${backup_user} --password=${backup_password} --host=&#39;localhost&#39; --socket=/opt/data/data_16303/mysql.sock --use-memory=1G --compress --compress-threads=32 --parallel=3 --slave-info ${backup_dir} 2&gt;&gt;${backup_log}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if [ $? -ne 0 ];then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> echo -e &#34;`date +&#39;%Y%m%d_%H:%M:%S&#39;` 备份数据库发生错误,具体看日志&#34; &gt;&gt; ${backup_log}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> Subject=&#34;物理备份xtra备份失败&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> Body=&#34;&#39;${ipaddr}&#39;_物理备份失败,请参考日志:${backup_log}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> SendToDingding_error $Subject $Body
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> exit 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">cd ${backup_dir}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">file_time=`date +&#39;%Y-%m-%d&#39;`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">flie_name=`ls -l | grep &#34;$file_time&#34;|tail -n 1|awk &#39;{print $9}&#39;`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">tar -zcf ${file_time}.tar.gz ${flie_name}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rm -rf ${flie_name}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## rsync -avz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if [ ! -z &#34;`tail -1 ${backup_log} | grep &#39;completed OK&#39;`&#34; ]; then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> finish_time=`date +&#39;%Y%m%d_%H:%M:%S&#39;`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> file_size=`du -sm ${backup_dir} |awk &#39;{print $1}&#39;`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> echo -e &#34;${ipaddr}数据库xtrabackup物理备份工作完成!\n 开始时间：${start_time} 结束时间：${finish_time}\n 备份目录${backup_dir}\n
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">备份文件大小${file_size} MB&#34; &gt;&gt; ${backup_log}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> # 删除以前的备份
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> echo -e &#34;`date +&#39;%Y%m%d_%H:%M:%S&#39;` 开始删除${slave_days}天以前的备份&#34; &gt;&gt; ${backup_log}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> cd ${backup_base}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> for tfile in $(/usr/bin/find ${backup_dir}  -mindepth 1 -maxdepth 1 -mtime +${slave_days})
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   do
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      cd ${backup_dir} &amp;&amp; rm -rf ${tfile} 2&gt;&gt;${backup_log}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      echo -e &#34;---- delete file :${file} -----&#34; &gt;&gt; ${backup_log}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   done
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> echo -e &#34;`date +&#39;%Y%m%d_%H%M%S&#39;` 删除${slave_days}天以前的备份-完成&#34; &gt;&gt; ${backup_log}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> find $backup_base/log  -mindepth 1 -maxdepth 1  -mtime +${slave_days} -type f |xargs  rm -f
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">else
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> echo -e &#34;`date +&#39;%Y%m%d_%H:%M:%S&#39;` 备份数据库发生错误,具体看日志&#34; &gt;&gt; ${backup_log}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> Subject=&#34;物理备份xtra备份失败&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> Body=&#34;${ipaddr}_物理备份失败,请参考日志:${backup_log}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> SendToDingding_error $Subject $Body
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">exit
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h3 id="查看导出清理binlog日志">查看、导出、清理<code>binlog</code>日志</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->查看<!-- raw HTML omitted --><code>binlog</code></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#75715e"># 指定查询 mysql-bin.000002这个文件，从pos点:624开始查起，偏移2行（即中间跳过2个），查询10条
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> binlog events <span style="color:#66d9ef">in</span> <span style="color:#e6db74">&#39;mysql-bin.000002&#39;</span> <span style="color:#66d9ef">from</span> <span style="color:#ae81ff">624</span> <span style="color:#66d9ef">limit</span> <span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">10</span><span style="color:#960050;background-color:#1e0010">\</span>G;</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->导出数据库<!-- raw HTML omitted --><code>binlog</code><!-- raw HTML omitted -->日志<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>--base64-output=</code>：<code>decode-rows</code><!-- raw HTML omitted -->将行事件解码为注释伪<!-- raw HTML omitted --><code>SQL</code><!-- raw HTML omitted -->语句<!-- raw HTML omitted --></li>
<li><code>--no-defaults</code></li>
<li><code>--database=&quot;数据库名&quot;</code>：<!-- raw HTML omitted -->仅列出此数据库的条目(仅限本地日志)<!-- raw HTML omitted --></li>
<li><code>--start-datetime=''</code>：<!-- raw HTML omitted --><!-- raw HTML omitted -->开始时间<!-- raw HTML omitted -->参数必须是本地时区的日期和时间，格式不限<code>MySQL</code>服务器接受<code>DATETIME</code>和<code>TIMESTAMP</code>类型，例如：<!-- raw HTML omitted --><code>2004-12-25 11:25:56</code></li>
<li><code>--stop-datetime=''</code>：<!-- raw HTML omitted --><!-- raw HTML omitted -->结束时间<!-- raw HTML omitted -->参数必须是本地时区的日期和时间，格式不限<code>MySQL</code>服务器接受<code>DATETIME</code>和<code>TIMESTAMP</code>类型，例如：<!-- raw HTML omitted --><code>2004-12-25 11:25:56</code></li>
<li><code>--start-position=875</code>：<!-- raw HTML omitted -->偏移量开始读取位置<!-- raw HTML omitted --></li>
<li><code>--stop-position=954</code>：<!-- raw HTML omitted -->偏移量停止读取位置<!-- raw HTML omitted --></li>
<li><code>-v</code>：<!-- raw HTML omitted -->从行事件中重建伪<code>SQL</code>语句，<code>-vv</code>添加对列数据类型的注释<!-- raw HTML omitted --></li>
<li><code>-r</code>：<!-- raw HTML omitted -->直接输出到给定的文件<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /bin/mysqlbinlog <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--base64-output<span style="color:#f92672">=</span>decode-rows <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--no-defaults --database<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;数据库名&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--start-datetime<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;2019-04-11 00:00:00&#39;</span> <span style="color:#ae81ff">\ </span> 	<span style="color:#75715e"># 开始时间</span>
</span></span><span style="display:flex;"><span>--stop-datetime<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;2019-04-11 15:00:00&#39;</span> <span style="color:#ae81ff">\ </span> 	<span style="color:#75715e"># 结束时间</span>
</span></span><span style="display:flex;"><span>-v /opt/data/mysql/mysql-bin.000007 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-r /opt/binlog<span style="color:#e6db74">`</span>date <span style="color:#e6db74">&#39;+%F&#39;</span><span style="color:#e6db74">`</span>.sql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 方法二</span>
</span></span><span style="display:flex;"><span>$ /bin/mysqlbinlog <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--no-defaults --database<span style="color:#f92672">=</span>db <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--start-datetime<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;2019-04-11 00:00:00&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--stop-datetime<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;2019-04-11 15:00:00&#39;</span> mysql-bin.000007 | more
</span></span><span style="display:flex;"><span>mysqlbinlog <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--base64-output<span style="color:#f92672">=</span>decode-rows <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--start-position<span style="color:#f92672">=</span><span style="color:#ae81ff">2966</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--stop-position<span style="color:#f92672">=</span><span style="color:#ae81ff">2966</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-v mysql-bin.000125</span></span></code></pre></div><ul>
<li>2.1 <!-- raw HTML omitted -->从<code>binlog</code>日志中得<code>DELETE</code>删除换成<code>INSERT INTO</code>插入语句<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<p><a href="https://www.cnblogs.com/yhq1314/p/13970044.html" rel="external" target="_self"><code>mysql binlg delete</code>语句解析为<code>insert</code>语句</a></p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 过滤非删除语句</span>
</span></span><span style="display:flex;"><span>$ sed -n <span style="color:#e6db74">&#39;/^###/&#39;</span>p /opt/binlog<span style="color:#e6db74">`</span>date <span style="color:#e6db74">&#39;+%F&#39;</span><span style="color:#e6db74">`</span>.sql  &gt;/opt/binlog<span style="color:#e6db74">`</span>date <span style="color:#e6db74">&#39;+%F&#39;</span><span style="color:#e6db74">`</span>.sql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 去掉#号</span>
</span></span><span style="display:flex;"><span>$ sed <span style="color:#e6db74">&#39;s/### //g&#39;</span> /opt/binlog<span style="color:#e6db74">`</span>date <span style="color:#e6db74">&#39;+%F&#39;</span><span style="color:#e6db74">`</span>.sql &gt;/opt/binlog<span style="color:#e6db74">`</span>date <span style="color:#e6db74">&#39;+%F&#39;</span><span style="color:#e6db74">`</span>.sql
</span></span><span style="display:flex;"><span>$ sed <span style="color:#e6db74">&#39;s#/\*.*\*/#,#g&#39;</span> c.txt &gt;d.txt
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 如果有富文本里面含注释语句容易出错可以更精细匹配</span>
</span></span><span style="display:flex;"><span>$ sed <span style="color:#e6db74">&#39;s#/\*.*\*/###   @#,#g&#39;</span> c.txt &gt;d.txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat /opt/binlog<span style="color:#e6db74">`</span>date <span style="color:#e6db74">&#39;+%F&#39;</span><span style="color:#e6db74">`</span>.sql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ find /path/to/binlog/directory -name <span style="color:#e6db74">&#34;binlog.*&#34;</span> -printf <span style="color:#e6db74">&#34;%T@ %p\n&#34;</span> | sort -n | cut -d<span style="color:#e6db74">&#39; &#39;</span> -f2- | xargs mysqlbinlog &gt; combined_binlog.sql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ find ./ -name <span style="color:#e6db74">&#34;mysql-bin.266*&#34;</span> -printf <span style="color:#e6db74">&#34;%T@ %p\n&#34;</span> | sort -n | cut -d<span style="color:#e6db74">&#39; &#39;</span> -f2- | xargs /usr/local/mysql/bin/mysqlbinlog -vv  --base64-output<span style="color:#f92672">=</span>DECODE-ROWS --set-charset<span style="color:#f92672">=</span>UTF8 mysql-bin.266770 --database<span style="color:#f92672">=</span>databases_name -r new_binlog.sql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#####  	解析binlog并还原成插入语句  	#####</span>
</span></span><span style="display:flex;"><span>$ /usr/local/mysql/bin/mysqlbinlog -vv --base64-output<span style="color:#f92672">=</span>DECODE-ROWS --set-charset<span style="color:#f92672">=</span>UTF8 mysql-bin.merged.9 --database<span style="color:#f92672">=</span>databases_name &gt;&gt;/mnt/new_binlog.sql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 只过滤某个数据库中的某个表中的删除语句</span>
</span></span><span style="display:flex;"><span>$ cat new_binlog.sql | awk <span style="color:#e6db74">&#39;/DELETE FROM/ &amp;&amp; (/databases_name.tables_name/ || /`databases_name`.`tables_name`/) { while(1) { print $0; getline; if($0 !~ /^###/) { break; }; }}&#39;</span> &gt; new_binlog-1.sql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 去掉：###</span>
</span></span><span style="display:flex;"><span>$ cp new_binlog-1.sql new_binlog-2.sql
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s/^### //g&#39;</span> new_binlog-2.sql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除语句替换为插入语句</span>
</span></span><span style="display:flex;"><span>$ cp new_binlog-2.sql new_binlog-3.sql
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;s/^DELETE FROM/INSERT INTO/g&#34;</span> new_binlog-3.sql 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 条件替换为值</span>
</span></span><span style="display:flex;"><span>$ cp new_binlog-3.sql new_binlog-4.sql
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;s/^WHERE/VALUES(/g&#34;</span> new_binlog-4.sql 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># @21 这里要看解析后的具体行数， </span>
</span></span><span style="display:flex;"><span>$ cp new_binlog-4.sql new_binlog-5.sql
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;/@21=.*/a );&#39;</span> new_binlog-5.sql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat new_binlog-5.sql | awk -F<span style="color:#e6db74">&#34;=|/*&#34;</span> <span style="color:#e6db74">&#39;{ if($0 ~ /^INSERT|^VALUES|^);/) { print $0; } else { printf $2&#34;,&#34;; };}&#39;</span> &gt;new_binlog-6.sql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cp  new_binlog-6.sql new_binlog-7.sql
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;s/,);</span>$<span style="color:#e6db74">/);/g&#34;</span> new_binlog-7.sql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cp new_binlog-7.sql new_binlog-8.sql
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s/,INSERT/);INSERT/g&#39;</span> new_binlog-8.sql</span></span></code></pre></div></blockquote>
</blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->清理<code>binlog</code><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>3.1 <a href="https://www.cnblogs.com/xxoome/p/9802684.html" rel="external" target="_self"><code>mysql binlog</code>日志自动清理及手动删除</a>、<a href="https://developer.aliyun.com/article/712256" rel="external" target="_self"><code>Mysql</code>清理<code>binlog</code></a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#75715e"># 清除MySQL-bin.010日志
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">PURGE</span> MASTER LOGS <span style="color:#66d9ef">TO</span> <span style="color:#e6db74">&#39;MySQL-bin.010&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 清除2008-06-22 13:00:00前binlog日志
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">PURGE</span> MASTER LOGS <span style="color:#66d9ef">BEFORE</span> <span style="color:#e6db74">&#39;2008-06-22 13:00:00&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 清除3天前binlog日志BEFORE，变量的date自变量可以为&#39;YYYY-MM-DD hh:mm:ss&#39;格式。 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">PURGE</span> MASTER LOGS <span style="color:#66d9ef">BEFORE</span> <span style="color:#a6e22e">DATE_SUB</span>( <span style="color:#a6e22e">NOW</span>( ), <span style="color:#66d9ef">INTERVAL</span> <span style="color:#ae81ff">3</span> DAY);</span></span></code></pre></div></blockquote>
<hr>
<h3 id="创建授权删除用户">创建、授权、删除用户</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->创建、授权<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>5.7.*</code><!-- raw HTML omitted -->一下创建以及授权<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">grant</span> <span style="color:#66d9ef">all</span> <span style="color:#66d9ef">on</span> <span style="color:#f92672">*</span>.<span style="color:#f92672">*</span> <span style="color:#66d9ef">to</span> root<span style="color:#f92672">@</span><span style="color:#e6db74">&#39;10.14.23.%&#39;</span> <span style="color:#66d9ef">identified</span> <span style="color:#66d9ef">by</span> <span style="color:#e6db74">&#39;123456&#39;</span>;  	<span style="color:#75715e"># 192.168.%.% 表示网段
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">grant</span> <span style="color:#66d9ef">all</span> <span style="color:#66d9ef">privileges</span> <span style="color:#66d9ef">on</span> <span style="color:#66d9ef">database</span>.<span style="color:#66d9ef">tables</span> <span style="color:#66d9ef">to</span> <span style="color:#e6db74">&#39;user&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;localhost&#39;</span> <span style="color:#66d9ef">identified</span> <span style="color:#66d9ef">by</span> <span style="color:#e6db74">&#34;password&#34;</span>;</span></span></code></pre></div><ul>
<li><code>Myslq 8.0</code><!-- raw HTML omitted -->语句执行，<code>8.0</code>版本之后创建用户和授权分开了<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#75715e"># 创建用户
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">USER</span> <span style="color:#e6db74">&#39;username&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;127.0.0.1&#39;</span> <span style="color:#66d9ef">IDENTIFIED</span> <span style="color:#66d9ef">BY</span> <span style="color:#e6db74">&#39;passowrd&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 授予权限
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">GRANT</span> <span style="color:#66d9ef">ALL</span> <span style="color:#66d9ef">ON</span> <span style="color:#f92672">*</span>.<span style="color:#f92672">*</span> <span style="color:#66d9ef">TO</span> <span style="color:#e6db74">&#39;username&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;127.0.0.1&#39;</span> <span style="color:#66d9ef">WITH</span> <span style="color:#66d9ef">GRANT</span> <span style="color:#66d9ef">OPTION</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除权限
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">REVOKE</span> <span style="color:#66d9ef">all</span> <span style="color:#66d9ef">privileges</span> <span style="color:#66d9ef">ON</span> databasename.tablename <span style="color:#66d9ef">FROM</span> <span style="color:#e6db74">&#39;username&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;host&#39;</span>; </span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->创建从库用户并授复制权限<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>MySQL<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">grant</span> replication slave, replication client <span style="color:#66d9ef">on</span> <span style="color:#f92672">*</span>.<span style="color:#f92672">*</span> <span style="color:#66d9ef">to</span> <span style="color:#e6db74">&#39;lisi&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;10.14.23.%&#39;</span> <span style="color:#66d9ef">identified</span> <span style="color:#66d9ef">by</span> <span style="color:#e6db74">&#39;123456&#39;</span>;</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->撤销用户权限<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">REVOKE</span> privilege <span style="color:#66d9ef">ON</span> databasename.tablename <span style="color:#66d9ef">FROM</span> <span style="color:#e6db74">&#39;username&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;host&#39;</span>;  </span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->删除用户、数据<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">drop</span> <span style="color:#66d9ef">user</span> <span style="color:#e6db74">&#39;username&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;host&#39;</span>;  	<span style="color:#75715e"># 如果是当前登陆用户用SET PASSWORD = PASSWORD(&#34;newpassword&#34;); 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">delete</span> <span style="color:#66d9ef">from</span> <span style="color:#960050;background-color:#1e0010">表名</span> <span style="color:#66d9ef">where</span> <span style="color:#960050;background-color:#1e0010">列名</span><span style="color:#f92672">=</span><span style="color:#960050;background-color:#1e0010">‘</span>xx<span style="color:#960050;background-color:#1e0010">’</span> <span style="color:#66d9ef">and</span> <span style="color:#960050;background-color:#1e0010">列名</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;xx&#39;</span>;  	<span style="color:#75715e"># 授权查看数据库用户（clint） 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">delete</span> <span style="color:#66d9ef">from</span> mysql.<span style="color:#66d9ef">user</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">user</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;slave&#34;</span> <span style="color:#66d9ef">and</span> host<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;10.14.23.%&#34;</span>;  </span></span></code></pre></div></blockquote>
<hr>
<h3 id="创建库表">创建库、表</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->创建库<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">database</span> db2 <span style="color:#66d9ef">character</span> <span style="color:#66d9ef">set</span> utf8 <span style="color:#66d9ef">collate</span> utf8_general_ci;</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->创建表<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><code>NOT NULL</code>：<!-- raw HTML omitted -->每一行都必须含有值（不能为空），<code>null</code>值是不允许的<!-- raw HTML omitted --></li>
<li><code>DEFAULT value</code>：<!-- raw HTML omitted -->设置默认值<!-- raw HTML omitted --></li>
<li><code>UNSIGNED</code>：<!-- raw HTML omitted -->使用无符号数值类型，<!-- raw HTML omitted --><code>0</code><!-- raw HTML omitted -->及正数<!-- raw HTML omitted --></li>
<li><code>AUTO INCREMENT</code>：<!-- raw HTML omitted -->设置<!-- raw HTML omitted --><code>MySQL</code><!-- raw HTML omitted -->字段的值在新增记录时每次自动增长<!-- raw HTML omitted --><code>1</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> databases_name.<span style="color:#a6e22e">tables_name</span>(id <span style="color:#66d9ef">int</span> <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span>, name <span style="color:#66d9ef">varchar</span>(<span style="color:#ae81ff">50</span>)<span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span>);
</span></span><span style="display:flex;"><span>Query OK, <span style="color:#ae81ff">1</span> row <span style="color:#a6e22e">affected</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)  	<span style="color:#75715e"># not null 不为空
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设置数据表中每条记录的唯一标识。 通常列的 PRIMARY KEY 设置为 ID 数值，与AUTO_INCREMENT 一起使用。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> <span style="color:#f92672">`</span>databases_name<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>tables_name<span style="color:#f92672">`</span>(name) <span style="color:#66d9ef">values</span>(<span style="color:#e6db74">&#39;lisi&#39;</span>);
</span></span><span style="display:flex;"><span>Query OK, <span style="color:#ae81ff">1</span> row <span style="color:#a6e22e">affected</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)  	<span style="color:#75715e"># 不写id
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> <span style="color:#f92672">`</span>databases_name<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>tables_name<span style="color:#f92672">`</span>(id,content,add_time) <span style="color:#66d9ef">values</span>(<span style="color:#ae81ff">4</span>,<span style="color:#e6db74">&#39;Text&#39;</span>,<span style="color:#e6db74">&#39;2023-01-11 02:52:54&#39;</span>);</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->按日期删除表<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">USE</span> example_db;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span> table_name <span style="color:#66d9ef">FROM</span> information_schema.<span style="color:#66d9ef">tables</span> <span style="color:#66d9ef">WHERE</span> table_schema <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;example_db&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span> <span style="color:#a6e22e">CONCAT</span>(<span style="color:#e6db74">&#39;DROP TABLE IF EXISTS &#39;</span>, table_name, <span style="color:#e6db74">&#39;;&#39;</span>) <span style="color:#66d9ef">AS</span> sql_statement <span style="color:#66d9ef">FROM</span> information_schema.<span style="color:#66d9ef">tables</span> <span style="color:#66d9ef">WHERE</span> table_schema <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;example_db&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span> table_name <span style="color:#66d9ef">FROM</span> information_schema.<span style="color:#66d9ef">tables</span> <span style="color:#66d9ef">WHERE</span> table_name <span style="color:#66d9ef">LIKE</span> <span style="color:#e6db74">&#39;prefix_%&#39;</span> <span style="color:#66d9ef">AND</span> table_name <span style="color:#66d9ef">BETWEEN</span> <span style="color:#e6db74">&#39;prefix_2022-02-01&#39;</span> <span style="color:#66d9ef">AND</span> <span style="color:#e6db74">&#39;prefix_2022-03-01&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span> <span style="color:#a6e22e">CONCAT</span>(<span style="color:#e6db74">&#39;DROP TABLE IF EXISTS &#39;</span>, table_name, <span style="color:#e6db74">&#39;;&#39;</span>) <span style="color:#66d9ef">AS</span> sql_statement <span style="color:#66d9ef">FROM</span> information_schema.<span style="color:#66d9ef">tables</span> <span style="color:#66d9ef">WHERE</span> table_name <span style="color:#66d9ef">LIKE</span> <span style="color:#e6db74">&#39;prefix_%&#39;</span> <span style="color:#66d9ef">AND</span> table_name <span style="color:#66d9ef">BETWEEN</span> <span style="color:#e6db74">&#39;prefix_2022-02-01&#39;</span> <span style="color:#66d9ef">AND</span> <span style="color:#e6db74">&#39;prefix_2022-03-01&#39;</span>;</span></span></code></pre></div></blockquote>
<hr>
<h3 id="查询库表容量大小">查询库、表容量大小</h3>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->查询所有库容量大小<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span> 
</span></span><span style="display:flex;"><span>table_schema <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;数据库&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sum</span>(table_rows) <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;记录数&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sum</span>(<span style="color:#a6e22e">truncate</span>(data_length<span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span>, <span style="color:#ae81ff">2</span>)) <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;数据容量(MB)&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sum</span>(<span style="color:#a6e22e">truncate</span>(index_length<span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span>, <span style="color:#ae81ff">2</span>)) <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;索引容量(MB)&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sum</span>(<span style="color:#a6e22e">truncate</span>(DATA_FREE<span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span>, <span style="color:#ae81ff">2</span>)) <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;碎片占用(MB)&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">from</span> information_schema.<span style="color:#66d9ef">tables</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">group</span> <span style="color:#66d9ef">by</span> table_schema
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> <span style="color:#a6e22e">sum</span>(data_length) <span style="color:#66d9ef">desc</span>, <span style="color:#a6e22e">sum</span>(index_length) <span style="color:#66d9ef">desc</span>;</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->查看指定库的容量大小<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>查看<code>MySQL</code>「指定库」的容量大小：<code>database_name</code>更改为要查询的库</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span> 
</span></span><span style="display:flex;"><span>table_schema <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;数据库&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sum</span>(table_rows) <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;记录数&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sum</span>(<span style="color:#a6e22e">truncate</span>(data_length<span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span>, <span style="color:#ae81ff">2</span>)) <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;数据容量(MB)&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sum</span>(<span style="color:#a6e22e">truncate</span>(index_length<span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span>, <span style="color:#ae81ff">2</span>)) <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;索引容量(MB)&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sum</span>(<span style="color:#a6e22e">truncate</span>(DATA_FREE<span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span>, <span style="color:#ae81ff">2</span>)) <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;碎片占用(MB)&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">from</span> information_schema.<span style="color:#66d9ef">tables</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span> table_schema<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;database_name&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> data_length <span style="color:#66d9ef">desc</span>, index_length <span style="color:#66d9ef">desc</span>;</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->查看指定库中所有表的容量大小<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>查看<code>MySQL</code>「指定库」中「所有表」的容量大小</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span>
</span></span><span style="display:flex;"><span>table_schema <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;数据库&#39;</span>,
</span></span><span style="display:flex;"><span>table_name <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;表名&#39;</span>,
</span></span><span style="display:flex;"><span>table_rows <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;记录数&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">truncate</span>(data_length<span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span>, <span style="color:#ae81ff">2</span>) <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;数据容量(MB)&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">truncate</span>(index_length<span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span>, <span style="color:#ae81ff">2</span>) <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;索引容量(MB)&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">truncate</span>(DATA_FREE<span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span>, <span style="color:#ae81ff">2</span>) <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;碎片占用(MB)&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">from</span> information_schema.<span style="color:#66d9ef">tables</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span> table_schema<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;database_name&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> data_length <span style="color:#66d9ef">desc</span>, index_length <span style="color:#66d9ef">desc</span>;</span></span></code></pre></div></blockquote>
<ul>
<li><!-- raw HTML omitted -->查看指定库中指定表的容量大小<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<ul>
<li>查看<code>MySQL</code>「指定库」中「指定表」的容量大小：将代码中<code>database_name</code>数据库名改为你要查询的数据库名，<code>tables_name</code>改为你要查询的表名</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span>
</span></span><span style="display:flex;"><span>table_schema <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;数据库&#39;</span>,
</span></span><span style="display:flex;"><span>table_name <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;表名&#39;</span>,
</span></span><span style="display:flex;"><span>table_rows <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;记录数&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">truncate</span>(data_length<span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span>, <span style="color:#ae81ff">2</span>) <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;数据容量(MB)&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">truncate</span>(index_length<span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span>, <span style="color:#ae81ff">2</span>) <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;索引容量(MB)&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">truncate</span>(DATA_FREE<span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span>, <span style="color:#ae81ff">2</span>) <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;碎片占用(MB)&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">from</span> information_schema.<span style="color:#66d9ef">tables</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span> table_schema<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;database_name&#39;</span><span style="color:#66d9ef">and</span> table_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;tables_name&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> data_length <span style="color:#66d9ef">desc</span>, index_length <span style="color:#66d9ef">desc</span>;</span></span></code></pre></div></blockquote>
</blockquote>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#75715e"># 查询并且进行AES解码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#a6e22e">aes_decrypt</span>(<span style="color:#a6e22e">from_base64</span>(mobile),<span style="color:#e6db74">&#39;key&#39;</span>,<span style="color:#e6db74">&#39;加密掩码&#39;</span>) <span style="color:#66d9ef">from</span> yl_users <span style="color:#66d9ef">where</span> member <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->排查<!-- raw HTML omitted --><code>Mysql</code><!-- raw HTML omitted -->占用内存原因<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 查看MySQL的Pid</span>
</span></span><span style="display:flex;"><span>$ ps -ef | grep -i mysqld
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看MySQL实时操作系统线程Pid</span>
</span></span><span style="display:flex;"><span>$ top -p <span style="color:#e6db74">&#34;Mysql Pid&#34;</span> -H
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 数据库中查看Pid 具体操作内容</span>
</span></span><span style="display:flex;"><span>Mysql&gt; SELECT THREAD_ID,name ,PROCESSLIST_ID FROM <span style="color:#e6db74">`</span>performance_schema<span style="color:#e6db74">`</span>.threads WHERE THREAD_OS_ID <span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Mysql Pid&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 根据获取到MySQL中的 Thread_id 获取SQL</span>
</span></span><span style="display:flex;"><span>mysql&gt; SELECT SQL_TEXT FROM <span style="color:#e6db74">`</span>performance_schema<span style="color:#e6db74">`</span>.events_statements_current WHERE THREAD_ID <span style="color:#f92672">=</span> Thread_id;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">###########################</span>
</span></span><span style="display:flex;"><span>mysql&gt; SELECT VARIABLE_NAME,VARIABLE_VALUE, CONCAT<span style="color:#f92672">(</span>VARIABLE_VALUE/1024/1024,<span style="color:#e6db74">&#39; MB&#39;</span><span style="color:#f92672">)</span> AS VARIABLE_VALUE_MB FROM information_schema.SESSION_VARIABLES WHERE VARIABLE_NAME IN <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;innodb_buffer_pool_size&#39;</span>,<span style="color:#e6db74">&#39;innodb_log_buffer_size&#39;</span>,<span style="color:#e6db74">&#39;innodb_additional_mem_pool_size&#39;</span>,<span style="color:#e6db74">&#39;key_buffer_size&#39;</span>,<span style="color:#e6db74">&#39;query_cache_size&#39;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql&gt; SHOW VARIABLES LIKE <span style="color:#e6db74">&#39;%show_compatibility_56%&#39;</span>;
</span></span><span style="display:flex;"><span>mysql&gt; SET GLOBAL show_compatibility_56<span style="color:#f92672">=</span>on;</span></span></code></pre></div></blockquote>
<hr>
<h3 id="其他命令">其他命令</h3>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted --><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#75715e"># MySQL-master,查看数据库偏移量
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> master status;
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> reset master;  <span style="color:#75715e"># 清理reset日志
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 从库执行，测试连接主库
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span><span style="color:#66d9ef">show</span> grants;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> mysql_secure_installation  	<span style="color:#75715e"># mysql安全配置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>Enter current password <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">root</span> (enter <span style="color:#66d9ef">for</span> none):  	<span style="color:#75715e"># 输入进入数据库密码，默认为空，按回车
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">Set</span> root password<span style="color:#f92672">?</span> [Y<span style="color:#f92672">/</span>n]  	<span style="color:#75715e"># 设置mysql数据库root用户的密码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>Remove anonymous users<span style="color:#f92672">?</span> [Y<span style="color:#f92672">/</span>n]  	<span style="color:#75715e"># 移除匿名用户Y
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>Disallow root login remotely<span style="color:#f92672">?</span> [Y<span style="color:#f92672">/</span>n]  	<span style="color:#75715e"># 不允许root用户远程登陆Y
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>Remove test <span style="color:#66d9ef">database</span> <span style="color:#66d9ef">and</span> access <span style="color:#66d9ef">to</span> it<span style="color:#f92672">?</span> [Y<span style="color:#f92672">/</span>n]  	<span style="color:#75715e"># 移除test数据库和访问Y
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>Reload privilege <span style="color:#66d9ef">tables</span> now<span style="color:#f92672">?</span> [Y<span style="color:#f92672">/</span>n]   
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 筛选数据不同值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">distinct</span> <span style="color:#960050;background-color:#1e0010">列名</span> <span style="color:#66d9ef">from</span> <span style="color:#960050;background-color:#1e0010">表名</span>;
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> <span style="color:#960050;background-color:#1e0010">表名</span> <span style="color:#66d9ef">where</span> <span style="color:#960050;background-color:#1e0010">列名</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">15</span> <span style="color:#66d9ef">and</span> (<span style="color:#960050;background-color:#1e0010">列名</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;选项&#39;</span> <span style="color:#66d9ef">or</span> <span style="color:#960050;background-color:#1e0010">列名</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;选项&#39;</span>);
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> <span style="color:#960050;background-color:#1e0010">表名</span> <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> <span style="color:#960050;background-color:#1e0010">列名、列名</span> <span style="color:#66d9ef">desc</span>(<span style="color:#960050;background-color:#1e0010">降序</span>)<span style="color:#960050;background-color:#1e0010">、</span><span style="color:#66d9ef">asc</span>(<span style="color:#960050;background-color:#1e0010">升序、默认升序</span>);
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> <span style="color:#960050;background-color:#1e0010">表名</span> <span style="color:#66d9ef">limit</span> <span style="color:#ae81ff">2</span>  	<span style="color:#75715e"># 查看前两条数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> <span style="color:#960050;background-color:#1e0010">表名</span> <span style="color:#66d9ef">where</span> <span style="color:#960050;background-color:#1e0010">列名</span> <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;首个关键字%&#39;</span>;  	<span style="color:#75715e"># %匹配所有
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> <span style="color:#960050;background-color:#1e0010">表名</span> <span style="color:#66d9ef">where</span> <span style="color:#960050;background-color:#1e0010">列名</span> <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;%xx%&#39;</span>;  	<span style="color:#75715e"># 反向查找
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> <span style="color:#960050;background-color:#1e0010">表名</span> <span style="color:#66d9ef">where</span> <span style="color:#960050;background-color:#1e0010">列名</span> <span style="color:#66d9ef">in</span> (<span style="color:#e6db74">&#39;关键字&#39;</span>,<span style="color:#960050;background-color:#1e0010">‘关键字’</span>)<span style="color:#960050;background-color:#1e0010">；</span>
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> <span style="color:#960050;background-color:#1e0010">表名</span> <span style="color:#66d9ef">where</span> <span style="color:#960050;background-color:#1e0010">列名</span> <span style="color:#66d9ef">between</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">and</span> <span style="color:#ae81ff">20</span>;  	<span style="color:#75715e"># 选取1到20之间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> <span style="color:#960050;background-color:#1e0010">表名</span> <span style="color:#66d9ef">where</span> <span style="color:#960050;background-color:#1e0010">列名</span> <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">between</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">and</span> <span style="color:#ae81ff">20</span>;  	<span style="color:#75715e"># 取反
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> <span style="color:#960050;background-color:#1e0010">表名</span> <span style="color:#66d9ef">where</span> (<span style="color:#960050;background-color:#1e0010">列名</span> <span style="color:#66d9ef">between</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">and</span> <span style="color:#ae81ff">20</span>) <span style="color:#66d9ef">and</span> <span style="color:#960050;background-color:#1e0010">列名</span> <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">in</span> (<span style="color:#e6db74">&#39;关键字&#39;</span>)<span style="color:#960050;background-color:#1e0010">；</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 更新、更改数据数据以及用户权限
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">update</span> <span style="color:#960050;background-color:#1e0010">表名</span> <span style="color:#66d9ef">set</span> <span style="color:#960050;background-color:#1e0010">列名</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;333&#39;</span>, <span style="color:#960050;background-color:#1e0010">列名</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;cn&#39;</span> <span style="color:#66d9ef">where</span> <span style="color:#960050;background-color:#1e0010">列名</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;xxx&#39;</span>;
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">update</span> <span style="color:#66d9ef">user</span> <span style="color:#66d9ef">set</span> host <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;%&#39;</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">user</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;root&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改数据库同步线程mysql
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">set</span> global sync_binlog<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>;
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">set</span> global innodb_flush_log_at_trx_commit<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改sql线程数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> STOP SLAVE SQL_THREAD;
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SET</span> GLOBAL slave_parallel_type<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;LOGICAL_CLOCK&#39;</span>;
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SET</span> GLOBAL slave_parallel_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span>;  	
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> START SLAVE SQL_THREAD;	</span></span></code></pre></div></blockquote>
<hr>
<h2 id="mysql查询锁表语句"><code>MySQL</code>查询锁表语句</h2>
<ul>
<li>
<ol>
<li><a href="https://www.cnblogs.com/better-farther-world2099/articles/14721482.html" rel="external" target="_self"><code>MySQL</code>查询锁表语句</a></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->查询是否锁表<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> OPEN <span style="color:#66d9ef">TABLES</span> <span style="color:#66d9ef">where</span> In_use <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>;</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->查看正在锁的事务<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> INFORMATION_SCHEMA.INNODB_LOCKS; </span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->查看等待锁的事务<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> INFORMATION_SCHEMA.INNODB_LOCK_WAITS;</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->查看当前的事务<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> INFORMATION_SCHEMA.INNODB_TRX;</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->查看当前锁定的事务<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> INFORMATION_SCHEMA.INNODB_LOCKS;</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->查看当前等锁的事务<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> INFORMATION_SCHEMA.INNODB_LOCK_WAITS;</span></span></code></pre></div><ul>
<li><!-- raw HTML omitted -->查询死锁详情<!-- raw HTML omitted --></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span> r.trx_id waiting_trx_id,r.trx_mysql_thread_id waiting_thread,
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">TIMESTAMPADD</span>(SECOND,r.trx_wait_started,<span style="color:#66d9ef">CURRENT_TIMESTAMP</span>) wait_time,
</span></span><span style="display:flex;"><span>r.trx_query waiting_query,
</span></span><span style="display:flex;"><span>l.lock_table waiting_table_lock,
</span></span><span style="display:flex;"><span>b.trx_id blocking_trx_id,b.trx_mysql_thread_id blocking_thread,
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SUBSTRING</span>(p.<span style="color:#f92672">`</span>HOST<span style="color:#f92672">`</span>,<span style="color:#ae81ff">1</span>,<span style="color:#a6e22e">INSTR</span>(p.<span style="color:#f92672">`</span>HOST<span style="color:#f92672">`</span>,<span style="color:#e6db74">&#39;:&#39;</span>)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) blocking_host,
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SUBSTRING</span>(p.<span style="color:#f92672">`</span>HOST<span style="color:#f92672">`</span>,<span style="color:#a6e22e">INSTR</span>(p.<span style="color:#f92672">`</span>HOST<span style="color:#f92672">`</span>,<span style="color:#e6db74">&#39;:&#39;</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>) blocking_port,
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">IF</span>(p.COMMAND <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Sleep&#39;</span>,p.<span style="color:#66d9ef">TIME</span>,<span style="color:#ae81ff">0</span>) idle_in_trx,
</span></span><span style="display:flex;"><span>b.trx_query blocking_query
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">from</span> information_schema.INNODB_LOCK_WAITS w
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">INNER</span> <span style="color:#66d9ef">JOIN</span> information_schema.INNODB_TRX b <span style="color:#66d9ef">ON</span> b.trx_id <span style="color:#f92672">=</span> w.blocking_lock_id
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">INNER</span> <span style="color:#66d9ef">JOIN</span> information_schema.INNODB_TRX r <span style="color:#66d9ef">ON</span> r.trx_id <span style="color:#f92672">=</span> w.requesting_trx_id
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">INNER</span> <span style="color:#66d9ef">JOIN</span> information_schema.INNODB_LOCKS l <span style="color:#66d9ef">ON</span> l.lock_id <span style="color:#f92672">=</span> w.requested_lock_id
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">LEFT</span> <span style="color:#66d9ef">JOIN</span> information_schema.<span style="color:#f92672">`</span>PROCESSLIST<span style="color:#f92672">`</span> p <span style="color:#66d9ef">ON</span> p.id <span style="color:#f92672">=</span> b.trx_mysql_thread_id
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> wait_time <span style="color:#66d9ef">desc</span>;</span></span></code></pre></div></blockquote>
<hr>
<h2 id="配置数据库主从复制">配置数据库主从复制</h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->主数据库配置以及授权<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 修改ID</span>
</span></span><span style="display:flex;"><span>$ server_id<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>hostname -I |awk <span style="color:#e6db74">&#34;{print </span>$1<span style="color:#e6db74">}&#34;</span>|awk -F<span style="color:#e6db74">&#34;.&#34;</span> <span style="color:#e6db74">&#34;{print </span>$4<span style="color:#e6db74">}&#34;</span><span style="color:#e6db74">`</span>  
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;s/server-id = 16303110/server-id = 16303</span>$server_id<span style="color:#e6db74">/g&#34;</span> /etc/my.cnf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 授权从库连接账户密码</span>
</span></span><span style="display:flex;"><span>mysql&gt; grant replication slave on *.* to myuser@<span style="color:#e6db74">&#39;host IP&#39;</span> identified by <span style="color:#e6db74">&#39;password&#39;</span>;
</span></span><span style="display:flex;"><span>mysql&gt; flush privileges;
</span></span><span style="display:flex;"><span>mysql&gt; reset master; <span style="color:#e6db74">&#34;</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->配置从库连接主库<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 修改ID</span>
</span></span><span style="display:flex;"><span>$ server_id<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>hostname -I |awk <span style="color:#e6db74">&#39;{print $1}&#39;</span>|awk -F<span style="color:#e6db74">&#39;.&#39;</span> <span style="color:#e6db74">&#39;{print $4}&#39;</span><span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;s/server-id = 16303110/server-id = 16303</span>$server_id<span style="color:#e6db74">/g&#34;</span> /etc/my.cnf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 配置连接主库</span>
</span></span><span style="display:flex;"><span>$ /usr/local/mysql/bin/mysql -uroot -p -S /tmp/mysql.sock <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-e <span style="color:#e6db74">&#34;CHANGE MASTER TO MASTER_HOST=&#39;127.0.0.1&#39;, \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_USER=&#39;myuser&#39;, \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_PASSWORD=&#39;password&#39;, \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_PORT=16303, \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_LOG_FILE=&#39;mysql-bin.000001&#39;, \  	# 主机show master status;中的File
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_LOG_POS=154,MASTER_CONNECT_RETRY=15;&#34;</span>  	<span style="color:#75715e"># 主机show master status;中的Position.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ /usr/local/mysql/bin/mysql -uroot -p -S /tmp/mysql.sock -e <span style="color:#e6db74">&#34;start slave;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ /usr/local/mysql/bin/mysql -uroot -p -S /tmp/mysql.sock -e <span style="color:#e6db74">&#34;show slave status\G&#34;</span></span></span></code></pre></div><ul>
<li>2.1 <!-- raw HTML omitted -->配置多源复制<!-- raw HTML omitted --></li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /usr/local/mysql/bin/mysql -uroot -p -S /tmp/mysql.sock <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-e <span style="color:#e6db74">&#34;CHANGE MASTER TO MASTER_HOST=&#39;127.0.0.1&#39;, \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_USER=&#39;myuser&#39;, \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_PASSWORD=&#39;password&#39;, \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASTER_PORT=16303, \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">master_auto_position=1  for  channel &#39;rep_master_1&#39;;&#34;</span>  	<span style="color:#75715e"># 协商、定义频道几个主机定义几次。</span></span></span></code></pre></div></blockquote>
</blockquote>
<hr>
<h2 id="数据库开启gtid流程">数据库开启<code>GTID</code>流程</h2>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 如果可以先暂停业务，查询是否还有业务连接</span>
</span></span><span style="display:flex;"><span>mysql&gt; show processlist;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 主从依次执行：主库执行好后，去从库执行 ，再执行下一个命令</span>
</span></span><span style="display:flex;"><span>mysql&gt; SET @@GLOBAL.ENFORCE_GTID_CONSISTENCY<span style="color:#f92672">=</span>WARN;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查询主从错误日志，看看是否有报错，在做下一步</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 主库执行好后，去从库执行 ，再执行下一个命令</span>
</span></span><span style="display:flex;"><span>mysql&gt; SET @@GLOBAL.ENFORCE_GTID_CONSISTENCY<span style="color:#f92672">=</span>ON;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 主库执行好后，去从库执行 ，再执行下一个命令</span>
</span></span><span style="display:flex;"><span>mysql&gt; SET @@GLOBAL.GTID_MODE<span style="color:#f92672">=</span>OFF_PERMISSIVE;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 主库执行好后，去从库执行 ，再执行下一个命令</span>
</span></span><span style="display:flex;"><span>mysql&gt; SET @@GLOBAL.GTID_MODE<span style="color:#f92672">=</span>ON_PERMISSIVE;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 从库查询：等待从库这个状态变为0</span>
</span></span><span style="display:flex;"><span>mysql&gt; show status like <span style="color:#e6db74">&#39;ONGOING_ANONYMOUS_TRANSACTION_COUNT&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 主从执行：</span>
</span></span><span style="display:flex;"><span>mysql&gt; SET @@GLOBAL.gtid_mode<span style="color:#f92672">=</span>on;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 从库执行：</span>
</span></span><span style="display:flex;"><span>mysql&gt; stop slave;
</span></span><span style="display:flex;"><span>mysql&gt; change master to master_auto_position<span style="color:#f92672">=</span>1;
</span></span><span style="display:flex;"><span>mysql&gt; start slave;</span></span></code></pre></div></blockquote>
<hr>
<h2 id="mysql开启日志审计"><code>Mysql</code>开启日志审计</h2>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 连接数据库执行语句：</span>
</span></span><span style="display:flex;"><span>mysql&gt; CREATE TABLE <span style="color:#e6db74">`</span>mysql<span style="color:#e6db74">`</span>.<span style="color:#e6db74">`</span>audit_login<span style="color:#e6db74">`</span> <span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">`</span>ID<span style="color:#e6db74">`</span> bigint NOT NULL AUTO_INCREMENT COMMENT <span style="color:#e6db74">&#39;自增ID&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">`</span>USER<span style="color:#e6db74">`</span> varchar<span style="color:#f92672">(</span>128<span style="color:#f92672">)</span>  NOT NULL COMMENT <span style="color:#e6db74">&#39;数据库中的用户&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">`</span>HOST<span style="color:#e6db74">`</span> varchar<span style="color:#f92672">(</span>64<span style="color:#f92672">)</span>  DEFAULT NULL COMMENT <span style="color:#e6db74">&#39;登录的IP&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">`</span>DB<span style="color:#e6db74">`</span> varchar<span style="color:#f92672">(</span>64<span style="color:#f92672">)</span>  DEFAULT NULL COMMENT <span style="color:#e6db74">&#39;访问的数据库&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">`</span>PROCESSLIST_ID<span style="color:#e6db74">`</span> bigint NOT NULL COMMENT <span style="color:#e6db74">&#39;用户连接&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">`</span>LOGIN_TIME<span style="color:#e6db74">`</span> datetime<span style="color:#f92672">(</span>3<span style="color:#f92672">)</span> DEFAULT CURRENT_TIMESTAMP<span style="color:#f92672">(</span>3<span style="color:#f92672">)</span> COMMENT <span style="color:#e6db74">&#39;登录时间&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">`</span>UPDATE_TIME<span style="color:#e6db74">`</span> datetime<span style="color:#f92672">(</span>3<span style="color:#f92672">)</span> DEFAULT CURRENT_TIMESTAMP<span style="color:#f92672">(</span>3<span style="color:#f92672">)</span> ON UPDATE CURRENT_TIMESTAMP<span style="color:#f92672">(</span>3<span style="color:#f92672">)</span> COMMENT <span style="color:#e6db74">&#39;记录这行数据上次被修改的时间,默认等于LOGIN_TIME&#39;</span>,
</span></span><span style="display:flex;"><span>PRIMARY KEY <span style="color:#f92672">(</span><span style="color:#e6db74">`</span>ID<span style="color:#e6db74">`</span><span style="color:#f92672">)</span>,
</span></span><span style="display:flex;"><span>KEY <span style="color:#e6db74">`</span>IDX_USER<span style="color:#e6db74">`</span> <span style="color:#f92672">(</span><span style="color:#e6db74">`</span>USER<span style="color:#e6db74">`</span><span style="color:#f92672">)</span>,
</span></span><span style="display:flex;"><span>KEY <span style="color:#e6db74">`</span>IDX_HOST<span style="color:#e6db74">`</span> <span style="color:#f92672">(</span><span style="color:#e6db74">`</span>HOST<span style="color:#e6db74">`</span><span style="color:#f92672">)</span>,
</span></span><span style="display:flex;"><span>KEY <span style="color:#e6db74">`</span>IDX_LOGIN_TIME<span style="color:#e6db74">`</span> <span style="color:#f92672">(</span><span style="color:#e6db74">`</span>LOGIN_TIME<span style="color:#e6db74">`</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span> ENGINE<span style="color:#f92672">=</span>InnoDB COMMENT <span style="color:#e6db74">&#34;用户登录审计日志表&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查询授权SQL，复制查询出来的SQL语句，执行授权</span>
</span></span><span style="display:flex;"><span>mysql&gt; <span style="color:#66d9ef">select</span> concat<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;grant select,insert on mysql.audit_login to &#39;&#34;</span>,user,<span style="color:#e6db74">&#34;&#39;@&#39;&#34;</span>,host,<span style="color:#e6db74">&#34;&#39;;&#34;</span><span style="color:#f92672">)</span> grants_sql from mysql.user where user not in <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;mysql.session&#39;</span>,<span style="color:#e6db74">&#39;mysql.sys&#39;</span><span style="color:#f92672">)</span> and Super_priv<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;N&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 执行：</span>
</span></span><span style="display:flex;"><span>mysql&gt; set global init_connect<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;insert into mysql.audit_login(USER,HOST,DB,PROCESSLIST_ID) values(current_user(),substring_index(user(),&#39;@&#39;,-1),database(),connection_id());&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 配置参数文件：</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>mysqld<span style="color:#f92672">]</span> 
</span></span><span style="display:flex;"><span>init_connect<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;insert into mysql.audit_login(USER,HOST,DB,PROCESSLIST_ID) values(current_user(),substring_index(user(),&#39;@&#39;,-1),database(),connection_id());&#34;</span>;  <span style="color:#75715e">#DBA add</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 最后执行看看有没有数据：</span>
</span></span><span style="display:flex;"><span>mysql&gt; <span style="color:#66d9ef">select</span> * from mysql.audit_login;</span></span></code></pre></div></blockquote>
<hr>
<h2 id="主从跳过复制错误">主从跳过复制错误</h2>
<blockquote>
<ul>
<li>
<ol>
<li><a href="https://blog.51cto.com/arthur376/1969935" rel="external" target="_self">主从跳过复制错误</a></li>
</ol>
</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#75715e"># 停止复制
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> slave stop;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设定跳过一个事务
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SET</span> GLOBAL SQL_SLAVE_SKIP_COUNTER <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 重新开启复制
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span>slave start
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 这样就正常了，但是，当然还是要把数据修改上去
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span><span style="color:#66d9ef">update</span> <span style="color:#66d9ef">tables</span> <span style="color:#66d9ef">set</span> <span style="color:#960050;background-color:#1e0010">。。。。。。。</span></span></span></code></pre></div></blockquote>
<hr>
<h2 id="sql优化审核平台工具"><code>SQL</code>优化、审核平台工具</h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->安装<a href="https://guide.yearning.io/install.html" rel="external" target="_self"><code>Yearning</code></a><code>SQL</code>审核工具<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><!-- raw HTML omitted -->默认账号/密码：<!-- raw HTML omitted --><code>admin/Yearning_admin</code></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install wget unzip
</span></span><span style="display:flex;"><span>$ wget -P /opt/src/ https://github.com/cookieY/Yearning/releases/download/v3.1.0/Yearning-v3.1.0-linux-amd64.zip  
</span></span><span style="display:flex;"><span>$ unzip -d /opt/yearning /opt/src/Yearning-v3.1.0-linux-amd64.zip  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;s/Port = &#34;</span>3306<span style="color:#e6db74">&#34;/Port = &#34;</span>16303<span style="color:#e6db74">&#34;/g&#34;</span> /opt/apps/yearning/conf.toml  
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;s/Password = &#39;xxxx&#39;/Password = &#39;p@ssw0rd&#39;/g&#34;</span> /opt/apps/yearning/conf.toml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ /bin/mysql -uroot <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> -S /opt/data/data_16303/mysql.sock <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> -p -e <span style="color:#e6db74">&#34;create database Yearning DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ bin/mysql -uroot <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> -S /opt/data/data_16303/mysql.sock <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> -p -e <span style="color:#e6db74">&#34;grant all on *.* to root@&#39;127.0.0.1&#39; identified by &#34;</span>p@ssw0rd<span style="color:#e6db74">&#34;;&#34;</span>  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ./Yearning install  	<span style="color:#75715e"># 先初始化</span>
</span></span><span style="display:flex;"><span>$ ./Yearning run
</span></span><span style="display:flex;"><span>$ ./Yearning run --push <span style="color:#e6db74">&#34;域名、或者IP地址&#34;</span> --port <span style="color:#e6db74">&#34;8000&#34;</span>  	<span style="color:#75715e"># 指定域名端口方式启动</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->安装美团<code>SQL</code>优化工具<a href="https://github.com/Meituan-Dianping/SQLAdvisor/blob/master/doc/QUICK_START.md" rel="external" target="_self"><code>SQL-Advisor</code></a><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><a href="https://segmentfault.com/a/1190000022883633" rel="external" target="_self"><code>MySQL-SQLAdvisor</code>的简单安装使用</a></li>
<li><a href="https://tech.meituan.com/2017/03/09/sqladvisor-pr.html" rel="external" target="_self">美团点评<code>SQL</code>优化工具<code>SQLAdvisor</code>开源</a></li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y install git wget cmake libaio-devel libffi-devel glib2 glib2-devel  
</span></span><span style="display:flex;"><span>$ yum -y install --enablerepo<span style="color:#f92672">=</span>Percona56 Percona-Server-shared-56  
</span></span><span style="display:flex;"><span>$ git clone https://github.com/Meituan-Dianping/SQLAdvisor.git /opt/src/sqladvisor  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cd /opt/src/sqladvisor
</span></span><span style="display:flex;"><span>$ cmake -DBUILD_CONFIG<span style="color:#f92672">=</span>mysql_release <span style="color:#ae81ff">\ </span>
</span></span><span style="display:flex;"><span> -DCMAKE_BUILD_TYPE<span style="color:#f92672">=</span>debug <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> -DCMAKE_INSTALL_PREFIX<span style="color:#f92672">=</span>/usr/local/sqlparser ./
</span></span><span style="display:flex;"><span>$ make <span style="color:#f92672">&amp;&amp;</span> make install
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1. DCMAKE_INSTALL_PREFIX为sqlparser库文件和头文件的安装目录，其中lib目录包含库文件libsqlparser.so，include目录包含所需的所有头文件。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2. DCMAKE_INSTALL_PREFIX值尽量不要修改，后面安装依赖这个目录。  </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cd SQLAdvisor/sqladvisor/
</span></span><span style="display:flex;"><span>$ cmake -DCMAKE_BUILD_TYPE<span style="color:#f92672">=</span>debug ./
</span></span><span style="display:flex;"><span>$ make
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在本路径下生成一个sqladvisor可执行文件，这即是我们想要</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat &gt;sql.cnf<span style="color:#e6db74">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[sqladvisor]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">username=xx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">password=xx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">host=xx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">port=xx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">dbname=xx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># sqls=sql1;sql2;sql3....
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cmd: ./sqladvisor -f sql.cnf  -v 1</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><a href="https://www.justdojava.com/2021/07/20/canal/" rel="external" target="_self">监听<code>MySQL binlog</code>实现数据变化后的实时通知</a></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><a href="https://github.com/alibaba/canal" rel="external" target="_self"><code>Github Alibaba Canal</code></a></li>
</ul>
</blockquote>
<ul>
<li>
<ol start="4">
<li><code>explain</code><!-- raw HTML omitted -->的使用<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li><a href="https://developer.aliyun.com/article/1104750#slide-12" rel="external" target="_self"><code>Mysql</code>优化高级篇</a></li>
<li><code>explain</code>+<code>sql</code>语句</li>
</ul>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">explain</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> Tables_name;</span></span></code></pre></div><blockquote>
<ul>
<li><code>id</code>：表的读取顺序</li>
<li><code>select_type</code>：数据读取操作的操作类型</li>
<li><code>possible_keys</code>：哪些索引可以使用</li>
<li><code>key</code>：哪些索引被实际使用</li>
<li><code>ref</code>：表之间的引用</li>
<li><code>rows</code>：每张表有多少行被优化器查询</li>
</ul>
</blockquote>
</blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
            <header class="headline">
            </header>

<h1 id="install_mysql">Install_Mysql</h1>

<h2 id="部署mysql-57">部署<code>Mysql 5.7</code></h2>
<blockquote>
<ul>
<li><a href="https://www.cnblogs.com/lyhabc/p/6136227.html" rel="external" target="_self">从0开始搭建<code>SQL Server AlwaysOn</code>第四篇-配置异地机房节点</a></li>
<li><a href="https://downloads.mysql.com/archives/" rel="external" target="_self"><code>Mysql</code>产品档案</a></li>
</ul>
</blockquote>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->安装扩展下载<code>Mysql</code>并解压安装包<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># Debian系统</span>
</span></span><span style="display:flex;"><span>$ sudo apt-get install build-essential cmake bison libncurses5-dev libssl-dev pkg-config g++ libaio1 libnuma1 libncurses5
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CentOS </span>
</span></span><span style="display:flex;"><span>$ yum -y remove mariadb* mariadb
</span></span><span style="display:flex;"><span>$ yum -y install numactl libaio* wget git epel-release
</span></span><span style="display:flex;"><span>$ yum -y install  https://mirrors.cloud.tencent.com/percona/release/7/RPMS/noarch/percona-release-0.1-4.noarch.rpm
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;s/gpgcheck = 1/gpgcheck = 0/g&#34;</span> /etc/yum.repos.d/percona-release.repo
</span></span><span style="display:flex;"><span>$ yum -y install percona-xtrabackup-24 qpress
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ wget -P /usr/local/src/ https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.28-linux-glibc2.12-x86_64.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ tar -zxvf /usr/local/src/mysql-5.7.28-linux-glibc2.12-x86_64.tar.gz -C /usr/local/src/
</span></span><span style="display:flex;"><span>$ cp -r /usr/local/src/mysql-5.7.28-linux-glibc2.12-x86_64 /usr/local/mysql</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->设置权限<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ groupadd mysql
</span></span><span style="display:flex;"><span>$ useradd -r -g mysql mysql
</span></span><span style="display:flex;"><span>$ cd /usr/local/
</span></span><span style="display:flex;"><span>$ chown -R mysql:mysql ./mysql</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->初始化数据库<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /usr/local/mysql/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ bin/mysqld --initialize --user<span style="color:#f92672">=</span>mysql --basedir<span style="color:#f92672">=</span>/usr/local/mysql --datadir<span style="color:#f92672">=</span>/usr/local/mysql/data
</span></span><span style="display:flex;"><span>$ bin/mysql_ssl_rsa_setup --datadir<span style="color:#f92672">=</span>/usr/local/mysql/data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ chown -R mysql:mysql /usr/local/mysql</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->修改配置文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mysqld --verbose --help  	<span style="color:#75715e"># 查看完整列表</span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;[mysqld]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">character_set_server=utf8
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">init_connect=&#39;</span>SET NAMES utf8<span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">basedir=/usr/local/mysql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">datadir=/usr/local/mysql/data  	# 数据目录最好外挂
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">socket=/tmp/mysql.sock
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 开启binlog
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">log-bin = mysql-bin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">binlog_format = ROW
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">expire_logs_days = 7
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">server-id=3306110  	# 端口加本机IP最后几位
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 不区分大小写 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">lower_case_table_names = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 不开启sql严格模式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sql_mode = &#34;STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">log-error=/usr/local/mysql/data/mysqld.log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">pid-file=/usr/local/mysql/data/mysqld.pid&#39;</span> &gt; /etc/my.cnf</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->修改启动文件配置参数并启动数据库<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mysqlconf<span style="color:#f92672">=</span>/etc/init.d/mysqld
</span></span><span style="display:flex;"><span>$ cp /usr/local/mysql/support-files/mysql.server  $mysqlconf
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;46s,basedir=,basedir=/usr/local/mysql,&#39;</span> $mysqlconf
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;47s,datadir=,datadir=/usr/local/mysql/data,&#39;</span> $mysqlconf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动数据库</span>
</span></span><span style="display:flex;"><span>$ service mysqld start
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 添加软连接</span>
</span></span><span style="display:flex;"><span>$ ln -s /usr/local/mysql/bin/mysql /usr/bin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看端口号</span>
</span></span><span style="display:flex;"><span>$ netstat -nuplt | grep :3306
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 防火墙开放端口</span>
</span></span><span style="display:flex;"><span>$ firewall-cmd --permanent --new-ipset<span style="color:#f92672">=</span>db_whitelist --type<span style="color:#f92672">=</span>hash:ip  
</span></span><span style="display:flex;"><span>$ firewall-cmd --permanent --add-rich-rule<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;rule family=&#39;ipv4&#39; source ipset=&#39;db_whitelist&#39; port port=&#39;16303&#39; protocol=&#39;tcp&#39; accept&#34;</span>  
</span></span><span style="display:flex;"><span>$ firewall-cmd --reload</span></span></code></pre></div></blockquote>
<hr>
<h2 id="安装mysql-8">安装<code>Mysql 8</code></h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->安装扩展下载<code>Mysql</code>并解压安装包<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum -y remove mariadb* mariadb
</span></span><span style="display:flex;"><span>$ yum -y install ncurses-compat-libs wget git epel-release
</span></span><span style="display:flex;"><span>$ yum -y install  https://mirrors.cloud.tencent.com/percona/release/7/RPMS/noarch/percona-release-0.1-4.noarch.rpm
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;s/gpgcheck = 1/gpgcheck = 0/g&#34;</span> /etc/yum.repos.d/percona-release.repo
</span></span><span style="display:flex;"><span>$ yum -y install percona-xtrabackup-24 qpress numactl libaio*
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ wget -P /usr/local/src/ https://dev.mysql.com/get/Downloads/MySQL-8.0/mysql-8.0.21-linux-glibc2.12-x86_64.tar.xz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ mkdir -p /usr/local/mysql <span style="color:#f92672">&amp;&amp;</span> tar -xvf /usr/local/src/mysql-8.0.21-linux-glibc2.12-x86_64.tar.xz -C /usr/local/mysql --strip-components <span style="color:#ae81ff">1</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->设置权限<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ groupadd mysql
</span></span><span style="display:flex;"><span>$ useradd -r -g mysql mysql
</span></span><span style="display:flex;"><span>$ cd /usr/local/
</span></span><span style="display:flex;"><span>$ chown -R mysql:mysql ./mysql</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->初始化数据库<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /usr/local/mysql/bin/mysqld --initialize --user<span style="color:#f92672">=</span>mysql --basedir<span style="color:#f92672">=</span>/usr/local/mysql --datadir<span style="color:#f92672">=</span>/usr/local/mysql/data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ /usr/local/mysql/bin/mysql_ssl_rsa_setup --datadir<span style="color:#f92672">=</span>/usr/local/mysql/data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ /usr/local/mysql/bin/mysqld_safe --datadir<span style="color:#f92672">=</span>/usr/local/mysql/data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ chown -R mysql:mysql /usr/local/mysql </span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->修改配置文件<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;[mysqld]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">character_set_server=utf8mb4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">init_connect=&#39;</span>SET NAMES utf8<span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">basedir=/usr/local/mysql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">datadir=/usr/local/mysql/data
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">socket=/tmp/mysql.sock
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 开启binlog
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">log-bin = mysql-bin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">binlog_format = ROW
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">expire_logs_days = 7
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">server-id=3306110  	# 端口加本机IP最后几位
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 不区分大小写 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">lower_case_table_names = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## 不开启sql严格模式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## sql_mode = &#34;STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sql_mode=&#39;</span>STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION<span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">default_authentication_plugin= mysql_native_password
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">log-error=/var/log/mysqld.log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">pid-file=/usr/local/mysql/data/mysqld.pid&#39;</span> &gt;/etc/my.cnf</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->修改启动文件配置参数并启动数据库<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mysqlconf<span style="color:#f92672">=</span>/etc/init.d/mysqld
</span></span><span style="display:flex;"><span>$ cp /usr/local/mysql/support-files/mysql.server $mysqlconf
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;46s,basedir=,basedir=/usr/local/mysql,&#39;</span> $mysqlconf
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;47s,datadir=,datadir=/usr/local/mysql/data,&#39;</span> $mysqlconf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动数据库</span>
</span></span><span style="display:flex;"><span>$ service mysqld start
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 添加软连接</span>
</span></span><span style="display:flex;"><span>$ ln -s /usr/local/mysql/bin/mysql /usr/bin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看端口号</span>
</span></span><span style="display:flex;"><span>$ netstat -nuplt | grep :3306
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 防火墙开放端口</span>
</span></span><span style="display:flex;"><span>$ firewall-cmd --permanent --new-ipset<span style="color:#f92672">=</span>db_whitelist --type<span style="color:#f92672">=</span>hash:ip  
</span></span><span style="display:flex;"><span>$ firewall-cmd --permanent --add-rich-rule<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;rule family=&#39;ipv4&#39; source ipset=&#39;db_whitelist&#39; port port=&#39;16303&#39; protocol=&#39;tcp&#39; accept&#34;</span>  
</span></span><span style="display:flex;"><span>$ firewall-cmd --reload</span></span></code></pre></div></blockquote>
<hr>
<h2 id="普通用户部署mysql-8">普通用户部署<code>Mysql 8</code></h2>
<ul>
<li>
<ol>
<li><!-- raw HTML omitted -->安装扩展<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># Linux8/Red Hat8(EL8)：这些平台默认不安装文件/lib64/libtinfo.so.5，MySQL客户端bin/mysql需要该文件来安装</span>
</span></span><span style="display:flex;"><span>$ yum -y install ncurses-compat-libs wget git epel-release
</span></span><span style="display:flex;"><span>$ yum -y install  http://www.percona.com/downloads/percona-release/redhat/0.1-4/percona-release-0.1-4.noarch.rpm  
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;s/gpgcheck = 1/gpgcheck = 0/g&#34;</span> /etc/yum.repos.d/percona-release.repo
</span></span><span style="display:flex;"><span>$ yum -y install percona-xtrabackup-24 qpress numactl libaio*
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ wget -P /usr/local/src/ https://dev.mysql.com/get/Downloads/MySQL-8.0/mysql-8.0.21-linux-glibc2.12-x86_64.tar.xz</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="2">
<li><!-- raw HTML omitted -->创建用户以及程序使用目录<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ groupadd myadmin <span style="color:#f92672">&amp;&amp;</span> useradd -g myadmin myadmin  	<span style="color:#75715e"># 创建程序运行用户  </span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;password&#34;</span>|passwd --stdin myadmin &amp;&gt;/dev/null
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ mkdir -p /opt/<span style="color:#f92672">{</span>apps,conf,src,backup,scripts,data，logs<span style="color:#f92672">}</span> /opt/data/<span style="color:#f92672">{</span>data_16303,data_16304<span style="color:#f92672">}</span> /opt/logs/mysql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$echo <span style="color:#e6db74">&#34;#####  Start/Stop Service  #####
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Cmnd_Alias MYADMIN_START_SERVICES = /etc/init.d/mysql, /etc/init.d/mysql.server, /opt/*  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">swadmin ALL=(ALL)NOPASSWD:MYADMIN_START_SERVICES &#34;</span>&gt;/etc/sudoers.d/myadmin  
</span></span><span style="display:flex;"><span>$ chmod <span style="color:#ae81ff">660</span> /etc/sudoers.d/myadmin  </span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="3">
<li><!-- raw HTML omitted -->编写配置文件，方便使用配置文件初始化数据库<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;[mysqld]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">character_set_server=utf8mb4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">init_connect=&#39;</span>SET NAMES utf8<span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">basedir=/opt/apps/mysql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">datadir=/opt/data/data_16303
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">socket=/tmp/mysql.sock
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 不区分大小写 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">lower_case_table_names = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 不开启sql严格模式
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># sql_mode = &#34;STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">log-error=/opt/logs/mysql/mysqld.log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">pid-file=/opt/data/data_16303/mysqld.pid&#39;</span> &gt; /opt/conf/mysql/mysql_master_16303.cnf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ chown -R myadmin:myadmin /opt/*</span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="4">
<li><!-- raw HTML omitted -->使用普通用户下载安装<code>Mysql 8</code><!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ su myadmin -c <span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">wget -P /opt/src/ https://dev.mysql.com/get/Downloads/MySQL-8.0/mysql-8.0.21-linux-glibc2.12-x86_64.tar.xz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">mkdir -p /opt/apps/mysql &amp;&amp; tar xvf /opt/src/mysql-8.0.21-linux-glibc2.12-x86_64.tar.xz -C /opt/apps/mysql --strip-components 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">chmod 750 /opt/apps/mysql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/opt/apps/mysql/bin/mysqld --defaults-file=/opt/conf/mysql/my.cnf --initialize-insecure --user=myadmin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sleep 8
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/opt/apps/mysql/bin/mysql_ssl_rsa_setup --defaults-file=/opt/conf/mysql/my.cnf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sleep 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/opt/apps/mysql/bin/mysqld_safe --defaults-file=/opt/conf/mysql/my.cnf --user=myadmin &amp;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sleep 8
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span></span></span></code></pre></div></blockquote>
<ul>
<li>
<ol start="5">
<li><!-- raw HTML omitted -->修改启动文件配置参数并启动数据库<!-- raw HTML omitted --></li>
</ol>
</li>
</ul>
<blockquote>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mysqlconf<span style="color:#f92672">=</span>/etc/init.d/mysqld
</span></span><span style="display:flex;"><span>$ cp /opt/apps/mysql/support-files/mysql.serverr $mysqlconf
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;46s,basedir=,basedir=/opt/apps/mysql,&#39;</span> $mysqlconf
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;47s,datadir=,datadir=/opt/data/data_16303,&#39;</span> $mysqlconf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;alias nginx=&#39;sudo /etc/init.d/nginx&#39;  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">alias tomcat=&#39;sudo /etc/init.d/tomcat&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">alias mysqld=&#39;sudo /etc/init.d/mysqld&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">alias redis=&#39;sudo /etc/init.d/redis&#39; &#34;</span>&gt;&gt;/home/myadmin/.bashrc
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动数据库</span>
</span></span><span style="display:flex;"><span>$ service mysqld start
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 添加软连接</span>
</span></span><span style="display:flex;"><span>$ ln -s /usr/local/mysql/bin/mysql /usr/bin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看端口号</span>
</span></span><span style="display:flex;"><span>$ netstat -nuplt | grep :3306
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 防火墙开放端口</span>
</span></span><span style="display:flex;"><span>$ firewall-cmd --permanent --new-ipset<span style="color:#f92672">=</span>db_whitelist --type<span style="color:#f92672">=</span>hash:ip  
</span></span><span style="display:flex;"><span>$ firewall-cmd --permanent --add-rich-rule<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;rule family=&#39;ipv4&#39; source ipset=&#39;db_whitelist&#39; port port=&#39;16303&#39; protocol=&#39;tcp&#39; accept&#34;</span>  
</span></span><span style="display:flex;"><span>$ firewall-cmd --reload</span></span></code></pre></div></blockquote>
<hr>

            <footer class="footline">
            </footer>
          </article>

          </section>
        </div>
      </main>
    </div>
    <script src="../../../js/clipboard.min.js?1719333224" defer></script>
    <script src="../../../js/perfect-scrollbar.min.js?1719333224" defer></script>
    <script src="../../../js/theme.js?1719333224" defer></script>
  </body>
</html>
